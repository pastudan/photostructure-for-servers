#!/usr/bin/env node
/* Copyright Â© 2021, PhotoStructure Inc. */
/* By using this software, you accept the terms in <https://photostructure.com/eula>. */
/* If you don't accept them, do not use this software. */
var dI=Object.create,Zp=Object.defineProperty,hI=Object.getPrototypeOf,Gb=Object.prototype.hasOwnProperty,gI=Object.getOwnPropertyNames,yI=Object.getOwnPropertyDescriptor,Kb=Object.getOwnPropertySymbols,bI=Object.prototype.propertyIsEnumerable;var y=Object.assign,wI=t=>Zp(t,"__esModule",{value:!0});var Zr=(t,e)=>{var r={};for(var i in t)Gb.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(t!=null&&Kb)for(var i of Kb(t))e.indexOf(i)<0&&bI.call(t,i)&&(r[i]=t[i]);return r},Z=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports);var xI=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of gI(e))!Gb.call(t,i)&&i!=="default"&&Zp(t,i,{get:()=>e[i],enumerable:!(r=yI(e,i))||r.enumerable});return t},P=t=>xI(wI(Zp(t!=null?dI(hI(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var Oi=Z((ipe,Sn)=>{var W_={PasetoNotSupported:"ERR_PASETO_NOT_SUPPORTED",PasetoDecryptionFailed:"ERR_PASETO_DECRYPTION_FAILED",PasetoInvalid:"ERR_PASETO_INVALID",PasetoVerificationFailed:"ERR_PASETO_VERIFICATION_FAILED",PasetoClaimInvalid:"ERR_PASETO_CLAIM_INVALID",PasetoWorkerFailure:"ERR_PASETO_WORKER_FAILURE"},Pn=class extends Error{constructor(e){super(e);this.name=this.constructor.name,this.code=W_[this.constructor.name],Error.captureStackTrace(this,this.constructor)}};Sn.exports.PasetoError=Pn;Sn.exports.PasetoNotSupported=class extends Pn{};Sn.exports.PasetoDecryptionFailed=class extends Pn{};Sn.exports.PasetoInvalid=class extends Pn{};Sn.exports.PasetoVerificationFailed=class extends Pn{};Sn.exports.PasetoClaimInvalid=class extends Pn{};Sn.exports.PasetoWorkerFailure=class extends Pn{}});var zf=Z((ope,DP)=>{DP.exports=t=>!!t&&t.constructor===Object});var Uf=Z((npe,FP)=>{var q_=zf();FP.exports=function(e){if(typeof e=="undefined")return Buffer.from("");if(Buffer.isBuffer(e))return e;if(q_(e))return Buffer.from(JSON.stringify(e),"utf8");if(typeof e!="string")throw new TypeError("options.footer must be a string, Buffer, or a plain object");return Buffer.from(e,"utf8")}});var Ag=Z((spe,LP)=>{var IP=1e3,OP=IP*60,kP=OP*60,Eg=kP*24,j_=Eg*7,H_=Eg*365.25,G_=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;LP.exports=t=>{let e=G_.exec(t);if(!e)throw new TypeError(`invalid time period format ("${t}")`);let r=parseFloat(e[1]);switch(e[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r*IP);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(r*OP);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(r*kP);case"day":case"days":case"d":return Math.round(r*Eg);case"week":case"weeks":case"w":return Math.round(r*j_);case"year":case"years":case"yr":case"yrs":case"y":return Math.round(r*H_)}}});var NP=Z((ape,RP)=>{var _P=Ag();RP.exports=({audience:t,expiresIn:e,iat:r=!0,issuer:i,jti:o,kid:n,notBefore:s,now:a=new Date,subject:m},c)=>{if(!(a instanceof Date)||!a.getTime())throw new TypeError("options.now must be a valid Date object");let p=a.getTime();if(r!==void 0){if(typeof r!="boolean")throw new TypeError("options.iat must be a boolean");r&&(c.iat=new Date(p))}if(e!==void 0){if(typeof e!="string")throw new TypeError("options.expiresIn must be a string");c.exp=new Date(p+_P(e))}if(s!==void 0){if(typeof s!="string")throw new TypeError("options.notBefore must be a string");c.nbf=new Date(p+_P(s))}if(t!==void 0){if(typeof t!="string")throw new TypeError("options.audience must be a string");c.aud=t}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.issuer must be a string");c.iss=i}if(m!==void 0){if(typeof m!="string")throw new TypeError("options.subject must be a string");c.sub=m}if(n!==void 0){if(typeof n!="string")throw new TypeError("options.kid must be a string");c.kid=n}if(o!==void 0){if(typeof o!="string")throw new TypeError("options.jti must be a string");c.jti=o}return c}});var Wf=Z((lpe,BP)=>{var K_=NP(),J_=zf(),$_=t=>JSON.parse(JSON.stringify(t));BP.exports=(t,e)=>{if(Buffer.isBuffer(t)){if(Object.keys(e).length!==0)throw new TypeError("options cannot contain claims when payload is a Buffer");return t}if(!J_(t))throw new TypeError("payload must be a Buffer or a plain object");return t=$_(t),t=K_(e,t),Buffer.from(JSON.stringify(t),"utf-8")}});var VP=Z((mpe,CP)=>{var{PasetoNotSupported:Q_}=Oi();CP.exports=t=>{if(!Number.isSafeInteger(t))throw new Q_("message is too long for Node.js to safely process");let e=~~(t/4294967295),r=t%4294967295-e,i=Buffer.allocUnsafe(8);return i.writeUInt32LE(e,4),i.writeUInt32LE(r,0),i}});var qf=Z((upe,zP)=>{var UP=VP();zP.exports=(...t)=>{let e=UP(t.length);for(let r of t){r=Buffer.from(r,"utf8");let i=UP(Buffer.byteLength(r));e=Buffer.concat([e,i,r])}return e}});var Lm=Z((cpe,Dg)=>{var Y_=t=>t.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),X_=t=>t.replace(/-/g,"+").replace(/_/g,"/"),Z_=t=>Y_(t.toString("base64")),eN=t=>Buffer.from(X_(t),"base64");Dg.exports.decode=eN;Dg.exports.encode=Z_});var Lg=Z((fpe,WP)=>{var{encode:Fg}=Lm();WP.exports=function(e,r,i){return i.length!==0?`${e}${Fg(Buffer.concat(r))}.${Fg(i)}`:`${e}${Fg(Buffer.concat(r))}`}});var HP=Z((ppe,qP)=>{var{timingSafeEqual:tN}=require("crypto"),jP=(t,e)=>{if(t.length===e)return t;let r=Buffer.alloc(e);return t.copy(r),r},rN=(t,e)=>{let r=Math.max(t.length,e.length);return tN(jP(t,r),jP(e,r))};qP.exports=rN});var Im=Z((hpe,GP)=>{var Ds=require("crypto"),iN=require("util"),{PasetoWorkerFailure:dpe}=Oi(),KP=qf(),$a;if(Ds.hkdf){let t=iN.promisify(Ds.hkdf);$a=(e,r,i,o)=>t("sha384",e,i,o,r)}else $a=(t,e,r,i)=>{let o=En.hmac("sha384",t,r),n=Buffer.from(i),s=Buffer.from(""),a=Buffer.from(""),m;for(let p=1;Buffer.byteLength(s)<e;++m){m=Buffer.from(String.fromCharCode(p));let g=Buffer.concat([a,n,m]);a=En.hmac("sha384",g,o),s=Buffer.concat([s,a])}return Buffer.from(s).slice(0,e)};var oN=Lg(),nN=HP(),En={async"aes-256-ctr-hmac-sha-384-encrypt"(t,e,r,i){let o=En.hmac("sha384",t,i);o=o.slice(0,32),e=Buffer.from(e);let n=o.slice(0,16),[s,a]=await Promise.all([$a(r,32,n,"paseto-encryption-key"),$a(r,32,n,"paseto-auth-key-for-aead")]),m=En.encrypt("aes-256-ctr",t,s,o.slice(16)),c=KP("v1.local.",o,m,e),p=En.hmac("sha384",c,a);return oN("v1.local.",[o,m,p],e)},async"aes-256-ctr-hmac-sha-384-decrypt"(t,e,r){let i=t.slice(0,32),o=t.slice(-48),n=t.slice(32,-48),s=i.slice(0,16),[a,m]=await Promise.all([$a(r,32,s,"paseto-encryption-key"),$a(r,32,s,"paseto-auth-key-for-aead")]),c=KP("v1.local.",i,n,e),p=En.hmac("sha384",c,m),g=En.decrypt("aes-256-ctr",n,a,i.slice(16));return!nN(o,p)||!g?!1:g},hmac(t,e,r){let i=Ds.createHmac(t,r);return i.update(e),i.digest()},verify(t,e,r,i){return Ds.verify(t,e,r,i)},sign(t,e,r){return Ds.sign(t,e,r)},encrypt(t,e,r,i){let o=Ds.createCipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])},decrypt(t,e,r,i){let o=Ds.createDecipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])}};GP.exports=En});var Ig=Z((gpe,JP)=>{var{sign:sN}=Im(),aN=qf(),lN=Lg();JP.exports=async function(e,r,i,o,n,s){let a=aN(e,r,i),m=await sN(o,a,n);if(m.length!==s)throw new TypeError(`invalid ${e.slice(0,-1)} signing key bit length`);return lN(e,[r,m],i)}});var QP=Z((ype,$P)=>{var{constants:{RSA_PKCS1_PSS_PADDING:mN,RSA_PSS_SALTLEN_DIGEST:uN},createPrivateKey:cN,KeyObject:fN}=require("crypto"),pN=Uf(),dN=Wf(),hN=Ig();function gN(t){if(t instanceof fN||(t=cN(t)),t.type!=="private"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public signing key must be a private RSA key");return t}$P.exports=async function(e,r,n={}){var{footer:i}=n,o=Zr(n,["footer"]);let s=dN(e,o),a=pN(i);return r=gN(r),hN("v1.public.",s,a,"sha384",{key:r,padding:mN,saltLength:uN},256)}});var jf=Z((bpe,YP)=>{var{PasetoClaimInvalid:Zt}=Oi(),XP=Ag();YP.exports=({ignoreExp:t,ignoreNbf:e,ignoreIat:r,maxTokenAge:i,subject:o,issuer:n,clockTolerance:s,audience:a,now:m=new Date},c)=>{if(!(m instanceof Date)||!m.getTime())throw new TypeError("options.now must be a valid Date object");let p=m.getTime();if("iss"in c&&typeof c.iss!="string")throw new Zt("payload.iss must be a string");if(n!==void 0){if(typeof n!="string")throw new TypeError("options.issuer must be a string");if(c.iss!==n)throw new Zt("issuer mismatch")}if("sub"in c&&typeof c.sub!="string")throw new Zt("payload.sub must be a string");if(o!==void 0){if(typeof o!="string")throw new TypeError("options.subject must be a string");if(c.sub!==o)throw new Zt("subject mismatch")}if("aud"in c&&typeof c.aud!="string")throw new Zt("payload.aud must be a string");if(a!==void 0){if(typeof a!="string")throw new TypeError("options.audience must be a string");if(c.aud!==a)throw new Zt("audience mismatch")}if(s!==void 0&&typeof s!="string")throw new TypeError("options.clockTolerance must be a string");let g=s?XP(s):0,w;if("iat"in c){if(typeof c.iat!="string")throw new Zt("payload.iat must be a string");if(w=new Date(c.iat).getTime(),!w)throw new Zt("payload.iat must be a valid ISO8601 string");if(!r&&w>p+g)throw new Zt("token issued in the future")}if("nbf"in c){if(typeof c.nbf!="string")throw new Zt("payload.nbf must be a string");let E=new Date(c.nbf).getTime();if(!E)throw new Zt("payload.nbf must be a valid ISO8601 string");if(!e&&E>p+g)throw new Zt("token is not active yet")}if("exp"in c){if(typeof c.exp!="string")throw new Zt("payload.exp must be a string");let E=new Date(c.exp).getTime();if(!E)throw new Zt("payload.exp must be a valid ISO8601 string");if(!t&&E<=p-g)throw new Zt("token is expired")}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.maxTokenAge must be a string");if(!("iat"in c))throw new Zt("missing iat claim");if(w+XP(i)<p+g)throw new Zt("maxTokenAge exceeded")}}});var Om=Z((wpe,ZP)=>{var{PasetoInvalid:yN}=Oi(),{strict:bN}=require("assert"),wN=zf();ZP.exports=t=>{try{let e=JSON.parse(t);return bN(wN(e)),e}catch(e){throw new yN("All PASETO payloads MUST be a JSON object")}}});var kg=Z((xpe,eE)=>{var{PasetoInvalid:Og,PasetoVerificationFailed:xN}=Oi(),{decode:tE}=Lm(),{verify:TN}=Im(),vN=qf();eE.exports=async function(e,r,i,o,n){if(typeof r!="string")throw new TypeError("token must be a string");if(r.substr(0,e.length)!==e)throw new Og(`token is not a ${e.slice(0,-1)} token`);let{0:s,1:a,length:m}=r.substr(e.length).split(".");if(m!==1&&m!==2)throw new Og("token value is not a PASETO formatted value");let c,p;try{p=tE(s),c=tE(a||"")}catch(oe){throw new Og("token value is not a PASETO formatted value")}let g=p.slice(0,-o),w=p.slice(-o),E=vN(e,g,c);if(!await TN(i,E,n,w))throw new xN("invalid signature");return{m:g,footer:c.length?c:void 0}}});var iE=Z((Tpe,rE)=>{var{constants:{RSA_PKCS1_PSS_PADDING:MN,RSA_PSS_SALTLEN_DIGEST:SN},createPublicKey:PN,KeyObject:EN}=require("crypto"),AN=jf(),DN=Om(),FN=kg();function LN(t){if((!(t instanceof EN)||t.type==="private")&&(t=PN(t)),t.type!=="public"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public verify key must be a public RSA key");return t}rE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=Zr(s,["complete","buffer"]);r=LN(r);let{m:a,footer:m}=await FN("v1.public.",e,"sha384",256,{key:r,padding:MN,saltLength:SN});if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let c=DN(a);return AN(n,c),i?{payload:c,footer:m,version:"v1",purpose:"public"}:c}});var Rg=Z((vpe,oE)=>{var{createSecretKey:IN,KeyObject:ON}=require("crypto");oE.exports=function(e,r){if(r instanceof ON||(r=IN(r)),r.type!=="secret"||r.symmetricKeySize!==32)throw new TypeError(`${e} secret key must be 32 bytes long symmetric key`);return r}});var _g=Z((Mpe,nE)=>{var kN=require("crypto"),{promisify:RN}=require("util"),_N=RN(kN.randomFill);nE.exports=async function(e){let r=Buffer.allocUnsafe(e);return _N(r)}});var aE=Z((Spe,sE)=>{var NN=Uf(),BN=Rg().bind(void 0,"v1.local"),CN=Wf(),VN=_g(),{"aes-256-ctr-hmac-sha-384-encrypt":zN}=Im();sE.exports=async function(e,r,s={}){var{footer:i,nonce:o}=s,n=Zr(s,["footer","nonce"]);let a=CN(e,n);r=BN(r);let m=NN(i),c=r.export();return(o&&process.env.NODE_ENV!=="test"||!o)&&(o=await VN(32)),zN(a,m,c,o)}});var cE=Z((Ppe,lE)=>{var{decode:mE}=Lm(),{"aes-256-ctr-hmac-sha-384-decrypt":UN}=Im(),{PasetoDecryptionFailed:WN,PasetoInvalid:uE}=Oi(),qN=jf(),jN=Rg().bind(void 0,"v1.local"),HN=Om(),Ng="v1.local.";lE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=Zr(s,["complete","buffer"]);if(typeof e!="string")throw new TypeError(`token must be a string, got: ${typeof e}`);if(r=jN(r),e.substr(0,Ng.length)!==Ng)throw new uE("token is not a v1.local PASETO");let{0:a,1:m="",length:c}=e.substr(Ng.length).split(".");if(c>2)throw new uE("token value is not a PASETO formatted value");let p=mE(m),g=mE(a),w=r.export(),E=await UN(g,p,w);if(!E)throw new WN("decryption failed");if(o){if(Object.keys(n).length!==0)throw new TypeError("options cannot contain claims when options.buffer is true");return i?{payload:E,footer:p.length?p:void 0,version:"v2",purpose:"local"}:E}let R=HN(E);return qN(n,R),i?{payload:R,footer:p.length?p:void 0,version:"v1",purpose:"local"}:R}});var dE=Z((Epe,fE)=>{var pE=require("crypto"),{promisify:GN}=require("util"),{PasetoNotSupported:KN}=Oi(),JN=_g(),$N=GN(pE.generateKeyPair),QN=32,YN=["rsa",{modulusLength:2048}];async function XN(t){switch(t){case"local":return pE.createSecretKey(await JN(QN));case"public":{let{privateKey:e}=await $N(...YN);return e}default:throw new KN("unsupported v1 purpose")}}fE.exports=XN});var gE=Z((Ape,hE)=>{var ZN=QP(),eB=iE(),tB=aE(),rB=cE(),iB=dE();hE.exports={sign:ZN,verify:eB,encrypt:tB,decrypt:rB,generateKey:iB}});var bE=Z((Dpe,yE)=>{var{createPrivateKey:oB,KeyObject:nB}=require("crypto"),sB=Uf(),aB=Wf(),lB=Ig();function mB(t){if(t instanceof nB||(t=oB(t)),t.type!=="private"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public signing key must be a private ed25519 key");return t}yE.exports=async function(e,r,n={}){var{footer:i}=n,o=Zr(n,["footer"]);let s=aB(e,o);r=mB(r);let a=sB(i);return lB("v2.public.",s,a,void 0,r,64)}});var xE=Z((Fpe,wE)=>{var{createPublicKey:uB,KeyObject:cB}=require("crypto"),fB=jf(),pB=Om(),dB=kg();function hB(t){if((!(t instanceof cB)||t.type==="private")&&(t=uB(t)),t.type!=="public"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public verify key must be a public ed25519 key");return t}wE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=Zr(s,["complete","buffer"]);r=hB(r);let{m:a,footer:m}=await dB("v2.public.",e,void 0,64,r);if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let c=pB(a);return fB(n,c),i?{payload:c,footer:m,version:"v2",purpose:"public"}:c}});var vE=Z((Lpe,TE)=>{var gB=require("crypto"),{promisify:yB}=require("util"),{PasetoNotSupported:bB}=Oi(),wB=yB(gB.generateKeyPair);async function xB(t){switch(t){case"public":{let{privateKey:e}=await wB("ed25519");return e}default:throw new bB("unsupported v2 purpose")}}TE.exports=xB});var SE=Z((Ipe,ME)=>{var TB=bE(),vB=xE(),MB=vE();ME.exports={sign:TB,verify:vB,generateKey:MB}});var FE=Z((Ope,PE)=>{var{PasetoInvalid:EE,PasetoNotSupported:AE}=Oi(),{decode:DE}=Lm(),SB=Om();PE.exports=(t,{parse:e=!0}={})=>{if(typeof t!="string")throw new TypeError("token must be a string");let{0:r,1:i,2:o,3:n,length:s}=t.split(".");if(s!==3&&s!==4)throw new EE("token value is not a PASETO formatted value");if(r!=="v1"&&r!=="v2")throw new AE("unsupported PASETO version");if(i!=="local"&&i!=="public")throw new AE("unsupported PASETO purpose");let a={footer:n?DE(n):void 0,payload:void 0,version:r,purpose:i};if(i==="local")return a;let m=r==="v1"?256:64,c;try{c=DE(o).slice(0,-m)}catch(p){throw new EE("token value is not a PASETO formatted value")}return e?a.payload=SB(c):a.payload=c,a}});var IE=Z((kpe,LE)=>{var PB=FE();LE.exports={decode:PB}});var kE=Z((Rpe,OE)=>{var EB=Oi(),AB=gE(),DB=SE(),{decode:FB}=IE();OE.exports={decode:FB,V1:AB,V2:DB,errors:EB}});var R0=Z(_p=>{Object.defineProperty(_p,"__esModule",{value:!0});var cV;(function(t){t[t.None=0]="None",t[t.Error=1]="Error",t[t.Debug=2]="Debug",t[t.Verbose=3]="Verbose"})(cV=_p.LogLevel||(_p.LogLevel={}))});var _0=Z(Np=>{Object.defineProperty(Np,"__esModule",{value:!0});var fV;(function(t){t.Ok="ok",t.Exited="exited",t.Crashed="crashed",t.Abnormal="abnormal"})(fV=Np.SessionStatus||(Np.SessionStatus={}))});var B0=Z(yl=>{Object.defineProperty(yl,"__esModule",{value:!0});var N0;(function(t){t.Fatal="fatal",t.Error="error",t.Warning="warning",t.Log="log",t.Info="info",t.Debug="debug",t.Critical="critical"})(N0=yl.Severity||(yl.Severity={}));(function(t){function e(r){switch(r){case"debug":return t.Debug;case"info":return t.Info;case"warn":case"warning":return t.Warning;case"error":return t.Error;case"fatal":return t.Fatal;case"critical":return t.Critical;case"log":default:return t.Log}}t.fromString=e})(N0=yl.Severity||(yl.Severity={}))});var V0=Z(bl=>{Object.defineProperty(bl,"__esModule",{value:!0});var C0;(function(t){t.Unknown="unknown",t.Skipped="skipped",t.Success="success",t.RateLimit="rate_limit",t.Invalid="invalid",t.Failed="failed"})(C0=bl.Status||(bl.Status={}));(function(t){function e(r){return r>=200&&r<300?t.Success:r===429?t.RateLimit:r>=400&&r<500?t.Invalid:r>=500?t.Failed:t.Unknown}t.fromHttpCode=e})(C0=bl.Status||(bl.Status={}))});var z0=Z(Bp=>{Object.defineProperty(Bp,"__esModule",{value:!0});var pV;(function(t){t.Explicit="explicitly_set",t.Sampler="client_sampler",t.Rate="client_rate",t.Inheritance="inheritance"})(pV=Bp.TransactionSamplingMethod||(Bp.TransactionSamplingMethod={}))});var U0=Z(Ws=>{Object.defineProperty(Ws,"__esModule",{value:!0});var dV=R0();Ws.LogLevel=dV.LogLevel;var hV=_0();Ws.SessionStatus=hV.SessionStatus;var gV=B0();Ws.Severity=gV.Severity;var yV=V0();Ws.Status=yV.Status;var bV=z0();Ws.TransactionSamplingMethod=bV.TransactionSamplingMethod});var _L=Z(Sb=>{var RL="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");Sb.encode=function(t){if(0<=t&&t<RL.length)return RL[t];throw new TypeError("Must be between 0 and 63: "+t)};Sb.decode=function(t){var e=65,r=90,i=97,o=122,n=48,s=57,a=43,m=47,c=26,p=52;return e<=t&&t<=r?t-e:i<=t&&t<=o?t-i+c:n<=t&&t<=s?t-n+p:t==a?62:t==m?63:-1}});var Ab=Z(Pb=>{var NL=_L(),Eb=5,BL=1<<Eb,CL=BL-1,VL=BL;function yz(t){return t<0?(-t<<1)+1:(t<<1)+0}function bz(t){var e=(t&1)==1,r=t>>1;return e?-r:r}Pb.encode=function(e){var r="",i,o=yz(e);do i=o&CL,o>>>=Eb,o>0&&(i|=VL),r+=NL.encode(i);while(o>0);return r};Pb.decode=function(e,r,i){var o=e.length,n=0,s=0,a,m;do{if(r>=o)throw new Error("Expected more digits in base 64 VLQ value.");if(m=NL.decode(e.charCodeAt(r++)),m===-1)throw new Error("Invalid base64 digit: "+e.charAt(r-1));a=!!(m&VL),m&=CL,n=n+(m<<s),s+=Eb}while(a);i.value=bz(n),i.rest=r}});var vl=Z(ur=>{function wz(t,e,r){if(e in t)return t[e];if(arguments.length===3)return r;throw new Error('"'+e+'" is a required argument.')}ur.getArg=wz;var zL=/^(?:([\w+\-.]+):)?\/\/(?:(\w+:\w+)@)?([\w.-]*)(?::(\d+))?(.*)$/,xz=/^data:.+\,.+$/;function du(t){var e=t.match(zL);return e?{scheme:e[1],auth:e[2],host:e[3],port:e[4],path:e[5]}:null}ur.urlParse=du;function xl(t){var e="";return t.scheme&&(e+=t.scheme+":"),e+="//",t.auth&&(e+=t.auth+"@"),t.host&&(e+=t.host),t.port&&(e+=":"+t.port),t.path&&(e+=t.path),e}ur.urlGenerate=xl;function Db(t){var e=t,r=du(t);if(r){if(!r.path)return t;e=r.path}for(var i=ur.isAbsolute(e),o=e.split(/\/+/),n,s=0,a=o.length-1;a>=0;a--)n=o[a],n==="."?o.splice(a,1):n===".."?s++:s>0&&(n===""?(o.splice(a+1,s),s=0):(o.splice(a,2),s--));return e=o.join("/"),e===""&&(e=i?"/":"."),r?(r.path=e,xl(r)):e}ur.normalize=Db;function UL(t,e){t===""&&(t="."),e===""&&(e=".");var r=du(e),i=du(t);if(i&&(t=i.path||"/"),r&&!r.scheme)return i&&(r.scheme=i.scheme),xl(r);if(r||e.match(xz))return e;if(i&&!i.host&&!i.path)return i.host=e,xl(i);var o=e.charAt(0)==="/"?e:Db(t.replace(/\/+$/,"")+"/"+e);return i?(i.path=o,xl(i)):o}ur.join=UL;ur.isAbsolute=function(t){return t.charAt(0)==="/"||zL.test(t)};function Tz(t,e){t===""&&(t="."),t=t.replace(/\/$/,"");for(var r=0;e.indexOf(t+"/")!==0;){var i=t.lastIndexOf("/");if(i<0||(t=t.slice(0,i),t.match(/^([^\/]+:\/)?\/*$/)))return e;++r}return Array(r+1).join("../")+e.substr(t.length+1)}ur.relative=Tz;var WL=function(){var t=Object.create(null);return!("__proto__"in t)}();function qL(t){return t}function vz(t){return jL(t)?"$"+t:t}ur.toSetString=WL?qL:vz;function Mz(t){return jL(t)?t.slice(1):t}ur.fromSetString=WL?qL:Mz;function jL(t){if(!t)return!1;var e=t.length;if(e<9||t.charCodeAt(e-1)!==95||t.charCodeAt(e-2)!==95||t.charCodeAt(e-3)!==111||t.charCodeAt(e-4)!==116||t.charCodeAt(e-5)!==111||t.charCodeAt(e-6)!==114||t.charCodeAt(e-7)!==112||t.charCodeAt(e-8)!==95||t.charCodeAt(e-9)!==95)return!1;for(var r=e-10;r>=0;r--)if(t.charCodeAt(r)!==36)return!1;return!0}function Sz(t,e,r){var i=Tl(t.source,e.source);return i!==0||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0||r)||(i=t.generatedColumn-e.generatedColumn,i!==0)||(i=t.generatedLine-e.generatedLine,i!==0)?i:Tl(t.name,e.name)}ur.compareByOriginalPositions=Sz;function Pz(t,e,r){var i=t.generatedLine-e.generatedLine;return i!==0||(i=t.generatedColumn-e.generatedColumn,i!==0||r)||(i=Tl(t.source,e.source),i!==0)||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0)?i:Tl(t.name,e.name)}ur.compareByGeneratedPositionsDeflated=Pz;function Tl(t,e){return t===e?0:t===null?1:e===null?-1:t>e?1:-1}function Ez(t,e){var r=t.generatedLine-e.generatedLine;return r!==0||(r=t.generatedColumn-e.generatedColumn,r!==0)||(r=Tl(t.source,e.source),r!==0)||(r=t.originalLine-e.originalLine,r!==0)||(r=t.originalColumn-e.originalColumn,r!==0)?r:Tl(t.name,e.name)}ur.compareByGeneratedPositionsInflated=Ez;function Az(t){return JSON.parse(t.replace(/^\)]}'[^\n]*\n/,""))}ur.parseSourceMapInput=Az;function Dz(t,e,r){if(e=e||"",t&&(t[t.length-1]!=="/"&&e[0]!=="/"&&(t+="/"),e=t+e),r){var i=du(r);if(!i)throw new Error("sourceMapURL could not be parsed");if(i.path){var o=i.path.lastIndexOf("/");o>=0&&(i.path=i.path.substring(0,o+1))}e=UL(xl(i),e)}return Db(e)}ur.computeSourceURL=Dz});var Ib=Z(HL=>{var Fb=vl(),Lb=Object.prototype.hasOwnProperty,Hs=typeof Map!="undefined";function qo(){this._array=[],this._set=Hs?new Map:Object.create(null)}qo.fromArray=function(e,r){for(var i=new qo,o=0,n=e.length;o<n;o++)i.add(e[o],r);return i};qo.prototype.size=function(){return Hs?this._set.size:Object.getOwnPropertyNames(this._set).length};qo.prototype.add=function(e,r){var i=Hs?e:Fb.toSetString(e),o=Hs?this.has(e):Lb.call(this._set,i),n=this._array.length;(!o||r)&&this._array.push(e),o||(Hs?this._set.set(e,n):this._set[i]=n)};qo.prototype.has=function(e){if(Hs)return this._set.has(e);var r=Fb.toSetString(e);return Lb.call(this._set,r)};qo.prototype.indexOf=function(e){if(Hs){var r=this._set.get(e);if(r>=0)return r}else{var i=Fb.toSetString(e);if(Lb.call(this._set,i))return this._set[i]}throw new Error('"'+e+'" is not in the set.')};qo.prototype.at=function(e){if(e>=0&&e<this._array.length)return this._array[e];throw new Error("No element indexed by "+e)};qo.prototype.toArray=function(){return this._array.slice()};HL.ArraySet=qo});var JL=Z(GL=>{var KL=vl();function Fz(t,e){var r=t.generatedLine,i=e.generatedLine,o=t.generatedColumn,n=e.generatedColumn;return i>r||i==r&&n>=o||KL.compareByGeneratedPositionsInflated(t,e)<=0}function Kp(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}Kp.prototype.unsortedForEach=function(e,r){this._array.forEach(e,r)};Kp.prototype.add=function(e){Fz(this._last,e)?(this._last=e,this._array.push(e)):(this._sorted=!1,this._array.push(e))};Kp.prototype.toArray=function(){return this._sorted||(this._array.sort(KL.compareByGeneratedPositionsInflated),this._sorted=!0),this._array};GL.MappingList=Kp});var Ob=Z($L=>{var hu=Ab(),Dt=vl(),Jp=Ib().ArraySet,Lz=JL().MappingList;function wi(t){t||(t={}),this._file=Dt.getArg(t,"file",null),this._sourceRoot=Dt.getArg(t,"sourceRoot",null),this._skipValidation=Dt.getArg(t,"skipValidation",!1),this._sources=new Jp,this._names=new Jp,this._mappings=new Lz,this._sourcesContents=null}wi.prototype._version=3;wi.fromSourceMap=function(e){var r=e.sourceRoot,i=new wi({file:e.file,sourceRoot:r});return e.eachMapping(function(o){var n={generated:{line:o.generatedLine,column:o.generatedColumn}};o.source!=null&&(n.source=o.source,r!=null&&(n.source=Dt.relative(r,n.source)),n.original={line:o.originalLine,column:o.originalColumn},o.name!=null&&(n.name=o.name)),i.addMapping(n)}),e.sources.forEach(function(o){var n=o;r!==null&&(n=Dt.relative(r,o)),i._sources.has(n)||i._sources.add(n);var s=e.sourceContentFor(o);s!=null&&i.setSourceContent(o,s)}),i};wi.prototype.addMapping=function(e){var r=Dt.getArg(e,"generated"),i=Dt.getArg(e,"original",null),o=Dt.getArg(e,"source",null),n=Dt.getArg(e,"name",null);this._skipValidation||this._validateMapping(r,i,o,n),o!=null&&(o=String(o),this._sources.has(o)||this._sources.add(o)),n!=null&&(n=String(n),this._names.has(n)||this._names.add(n)),this._mappings.add({generatedLine:r.line,generatedColumn:r.column,originalLine:i!=null&&i.line,originalColumn:i!=null&&i.column,source:o,name:n})};wi.prototype.setSourceContent=function(e,r){var i=e;this._sourceRoot!=null&&(i=Dt.relative(this._sourceRoot,i)),r!=null?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[Dt.toSetString(i)]=r):this._sourcesContents&&(delete this._sourcesContents[Dt.toSetString(i)],Object.keys(this._sourcesContents).length===0&&(this._sourcesContents=null))};wi.prototype.applySourceMap=function(e,r,i){var o=r;if(r==null){if(e.file==null)throw new Error(`SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map's "file" property. Both were omitted.`);o=e.file}var n=this._sourceRoot;n!=null&&(o=Dt.relative(n,o));var s=new Jp,a=new Jp;this._mappings.unsortedForEach(function(m){if(m.source===o&&m.originalLine!=null){var c=e.originalPositionFor({line:m.originalLine,column:m.originalColumn});c.source!=null&&(m.source=c.source,i!=null&&(m.source=Dt.join(i,m.source)),n!=null&&(m.source=Dt.relative(n,m.source)),m.originalLine=c.line,m.originalColumn=c.column,c.name!=null&&(m.name=c.name))}var p=m.source;p!=null&&!s.has(p)&&s.add(p);var g=m.name;g!=null&&!a.has(g)&&a.add(g)},this),this._sources=s,this._names=a,e.sources.forEach(function(m){var c=e.sourceContentFor(m);c!=null&&(i!=null&&(m=Dt.join(i,m)),n!=null&&(m=Dt.relative(n,m)),this.setSourceContent(m,c))},this)};wi.prototype._validateMapping=function(e,r,i,o){if(r&&typeof r.line!="number"&&typeof r.column!="number")throw new Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.");if(!(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0&&!r&&!i&&!o)){if(e&&"line"in e&&"column"in e&&r&&"line"in r&&"column"in r&&e.line>0&&e.column>=0&&r.line>0&&r.column>=0&&i)return;throw new Error("Invalid mapping: "+JSON.stringify({generated:e,source:i,original:r,name:o}))}};wi.prototype._serializeMappings=function(){for(var e=0,r=1,i=0,o=0,n=0,s=0,a="",m,c,p,g,w=this._mappings.toArray(),E=0,R=w.length;E<R;E++){if(c=w[E],m="",c.generatedLine!==r)for(e=0;c.generatedLine!==r;)m+=";",r++;else if(E>0){if(!Dt.compareByGeneratedPositionsInflated(c,w[E-1]))continue;m+=","}m+=hu.encode(c.generatedColumn-e),e=c.generatedColumn,c.source!=null&&(g=this._sources.indexOf(c.source),m+=hu.encode(g-s),s=g,m+=hu.encode(c.originalLine-1-o),o=c.originalLine-1,m+=hu.encode(c.originalColumn-i),i=c.originalColumn,c.name!=null&&(p=this._names.indexOf(c.name),m+=hu.encode(p-n),n=p)),a+=m}return a};wi.prototype._generateSourcesContent=function(e,r){return e.map(function(i){if(!this._sourcesContents)return null;r!=null&&(i=Dt.relative(r,i));var o=Dt.toSetString(i);return Object.prototype.hasOwnProperty.call(this._sourcesContents,o)?this._sourcesContents[o]:null},this)};wi.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return this._file!=null&&(e.file=this._file),this._sourceRoot!=null&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e};wi.prototype.toString=function(){return JSON.stringify(this.toJSON())};$L.SourceMapGenerator=wi});var QL=Z(Gs=>{Gs.GREATEST_LOWER_BOUND=1;Gs.LEAST_UPPER_BOUND=2;function kb(t,e,r,i,o,n){var s=Math.floor((e-t)/2)+t,a=o(r,i[s],!0);return a===0?s:a>0?e-s>1?kb(s,e,r,i,o,n):n==Gs.LEAST_UPPER_BOUND?e<i.length?e:-1:s:s-t>1?kb(t,s,r,i,o,n):n==Gs.LEAST_UPPER_BOUND?s:t<0?-1:t}Gs.search=function(e,r,i,o){if(r.length===0)return-1;var n=kb(-1,r.length,e,r,i,o||Gs.GREATEST_LOWER_BOUND);if(n<0)return-1;for(;n-1>=0&&i(r[n],r[n-1],!0)===0;)--n;return n}});var XL=Z(YL=>{function Rb(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}function Iz(t,e){return Math.round(t+Math.random()*(e-t))}function _b(t,e,r,i){if(r<i){var o=Iz(r,i),n=r-1;Rb(t,o,i);for(var s=t[i],a=r;a<i;a++)e(t[a],s)<=0&&(n+=1,Rb(t,n,a));Rb(t,n+1,a);var m=n+1;_b(t,e,r,m-1),_b(t,e,m+1,i)}}YL.quickSort=function(t,e){_b(t,e,0,t.length-1)}});var eI=Z($p=>{var j=vl(),Nb=QL(),Ml=Ib().ArraySet,Oz=Ab(),gu=XL().quickSort;function Xe(t,e){var r=t;return typeof t=="string"&&(r=j.parseSourceMapInput(t)),r.sections!=null?new _i(r,e):new tr(r,e)}Xe.fromSourceMap=function(t,e){return tr.fromSourceMap(t,e)};Xe.prototype._version=3;Xe.prototype.__generatedMappings=null;Object.defineProperty(Xe.prototype,"_generatedMappings",{configurable:!0,enumerable:!0,get:function(){return this.__generatedMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__generatedMappings}});Xe.prototype.__originalMappings=null;Object.defineProperty(Xe.prototype,"_originalMappings",{configurable:!0,enumerable:!0,get:function(){return this.__originalMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__originalMappings}});Xe.prototype._charIsMappingSeparator=function(e,r){var i=e.charAt(r);return i===";"||i===","};Xe.prototype._parseMappings=function(e,r){throw new Error("Subclasses must implement _parseMappings")};Xe.GENERATED_ORDER=1;Xe.ORIGINAL_ORDER=2;Xe.GREATEST_LOWER_BOUND=1;Xe.LEAST_UPPER_BOUND=2;Xe.prototype.eachMapping=function(e,r,i){var o=r||null,n=i||Xe.GENERATED_ORDER,s;switch(n){case Xe.GENERATED_ORDER:s=this._generatedMappings;break;case Xe.ORIGINAL_ORDER:s=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var a=this.sourceRoot;s.map(function(m){var c=m.source===null?null:this._sources.at(m.source);return c=j.computeSourceURL(a,c,this._sourceMapURL),{source:c,generatedLine:m.generatedLine,generatedColumn:m.generatedColumn,originalLine:m.originalLine,originalColumn:m.originalColumn,name:m.name===null?null:this._names.at(m.name)}},this).forEach(e,o)};Xe.prototype.allGeneratedPositionsFor=function(e){var r=j.getArg(e,"line"),i={source:j.getArg(e,"source"),originalLine:r,originalColumn:j.getArg(e,"column",0)};if(i.source=this._findSourceIndex(i.source),i.source<0)return[];var o=[],n=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",j.compareByOriginalPositions,Nb.LEAST_UPPER_BOUND);if(n>=0){var s=this._originalMappings[n];if(e.column===void 0)for(var a=s.originalLine;s&&s.originalLine===a;)o.push({line:j.getArg(s,"generatedLine",null),column:j.getArg(s,"generatedColumn",null),lastColumn:j.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n];else for(var m=s.originalColumn;s&&s.originalLine===r&&s.originalColumn==m;)o.push({line:j.getArg(s,"generatedLine",null),column:j.getArg(s,"generatedColumn",null),lastColumn:j.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n]}return o};$p.SourceMapConsumer=Xe;function tr(t,e){var r=t;typeof t=="string"&&(r=j.parseSourceMapInput(t));var i=j.getArg(r,"version"),o=j.getArg(r,"sources"),n=j.getArg(r,"names",[]),s=j.getArg(r,"sourceRoot",null),a=j.getArg(r,"sourcesContent",null),m=j.getArg(r,"mappings"),c=j.getArg(r,"file",null);if(i!=this._version)throw new Error("Unsupported version: "+i);s&&(s=j.normalize(s)),o=o.map(String).map(j.normalize).map(function(p){return s&&j.isAbsolute(s)&&j.isAbsolute(p)?j.relative(s,p):p}),this._names=Ml.fromArray(n.map(String),!0),this._sources=Ml.fromArray(o,!0),this._absoluteSources=this._sources.toArray().map(function(p){return j.computeSourceURL(s,p,e)}),this.sourceRoot=s,this.sourcesContent=a,this._mappings=m,this._sourceMapURL=e,this.file=c}tr.prototype=Object.create(Xe.prototype);tr.prototype.consumer=Xe;tr.prototype._findSourceIndex=function(t){var e=t;if(this.sourceRoot!=null&&(e=j.relative(this.sourceRoot,e)),this._sources.has(e))return this._sources.indexOf(e);var r;for(r=0;r<this._absoluteSources.length;++r)if(this._absoluteSources[r]==t)return r;return-1};tr.fromSourceMap=function(e,r){var i=Object.create(tr.prototype),o=i._names=Ml.fromArray(e._names.toArray(),!0),n=i._sources=Ml.fromArray(e._sources.toArray(),!0);i.sourceRoot=e._sourceRoot,i.sourcesContent=e._generateSourcesContent(i._sources.toArray(),i.sourceRoot),i.file=e._file,i._sourceMapURL=r,i._absoluteSources=i._sources.toArray().map(function(E){return j.computeSourceURL(i.sourceRoot,E,r)});for(var s=e._mappings.toArray().slice(),a=i.__generatedMappings=[],m=i.__originalMappings=[],c=0,p=s.length;c<p;c++){var g=s[c],w=new ZL;w.generatedLine=g.generatedLine,w.generatedColumn=g.generatedColumn,g.source&&(w.source=n.indexOf(g.source),w.originalLine=g.originalLine,w.originalColumn=g.originalColumn,g.name&&(w.name=o.indexOf(g.name)),m.push(w)),a.push(w)}return gu(i.__originalMappings,j.compareByOriginalPositions),i};tr.prototype._version=3;Object.defineProperty(tr.prototype,"sources",{get:function(){return this._absoluteSources.slice()}});function ZL(){this.generatedLine=0,this.generatedColumn=0,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}tr.prototype._parseMappings=function(e,r){for(var i=1,o=0,n=0,s=0,a=0,m=0,c=e.length,p=0,g={},w={},E=[],R=[],oe,z,we,Q,K;p<c;)if(e.charAt(p)===";")i++,p++,o=0;else if(e.charAt(p)===",")p++;else{for(oe=new ZL,oe.generatedLine=i,Q=p;Q<c&&!this._charIsMappingSeparator(e,Q);Q++);if(z=e.slice(p,Q),we=g[z],we)p+=z.length;else{for(we=[];p<Q;)Oz.decode(e,p,w),K=w.value,p=w.rest,we.push(K);if(we.length===2)throw new Error("Found a source, but no line and column");if(we.length===3)throw new Error("Found a source and line, but no column");g[z]=we}oe.generatedColumn=o+we[0],o=oe.generatedColumn,we.length>1&&(oe.source=a+we[1],a+=we[1],oe.originalLine=n+we[2],n=oe.originalLine,oe.originalLine+=1,oe.originalColumn=s+we[3],s=oe.originalColumn,we.length>4&&(oe.name=m+we[4],m+=we[4])),R.push(oe),typeof oe.originalLine=="number"&&E.push(oe)}gu(R,j.compareByGeneratedPositionsDeflated),this.__generatedMappings=R,gu(E,j.compareByOriginalPositions),this.__originalMappings=E};tr.prototype._findMapping=function(e,r,i,o,n,s){if(e[i]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+e[i]);if(e[o]<0)throw new TypeError("Column must be greater than or equal to 0, got "+e[o]);return Nb.search(e,r,n,s)};tr.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var r=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var i=this._generatedMappings[e+1];if(r.generatedLine===i.generatedLine){r.lastGeneratedColumn=i.generatedColumn-1;continue}}r.lastGeneratedColumn=Infinity}};tr.prototype.originalPositionFor=function(e){var r={generatedLine:j.getArg(e,"line"),generatedColumn:j.getArg(e,"column")},i=this._findMapping(r,this._generatedMappings,"generatedLine","generatedColumn",j.compareByGeneratedPositionsDeflated,j.getArg(e,"bias",Xe.GREATEST_LOWER_BOUND));if(i>=0){var o=this._generatedMappings[i];if(o.generatedLine===r.generatedLine){var n=j.getArg(o,"source",null);n!==null&&(n=this._sources.at(n),n=j.computeSourceURL(this.sourceRoot,n,this._sourceMapURL));var s=j.getArg(o,"name",null);return s!==null&&(s=this._names.at(s)),{source:n,line:j.getArg(o,"originalLine",null),column:j.getArg(o,"originalColumn",null),name:s}}}return{source:null,line:null,column:null,name:null}};tr.prototype.hasContentsOfAllSources=function(){return this.sourcesContent?this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return e==null}):!1};tr.prototype.sourceContentFor=function(e,r){if(!this.sourcesContent)return null;var i=this._findSourceIndex(e);if(i>=0)return this.sourcesContent[i];var o=e;this.sourceRoot!=null&&(o=j.relative(this.sourceRoot,o));var n;if(this.sourceRoot!=null&&(n=j.urlParse(this.sourceRoot))){var s=o.replace(/^file:\/\//,"");if(n.scheme=="file"&&this._sources.has(s))return this.sourcesContent[this._sources.indexOf(s)];if((!n.path||n.path=="/")&&this._sources.has("/"+o))return this.sourcesContent[this._sources.indexOf("/"+o)]}if(r)return null;throw new Error('"'+o+'" is not in the SourceMap.')};tr.prototype.generatedPositionFor=function(e){var r=j.getArg(e,"source");if(r=this._findSourceIndex(r),r<0)return{line:null,column:null,lastColumn:null};var i={source:r,originalLine:j.getArg(e,"line"),originalColumn:j.getArg(e,"column")},o=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",j.compareByOriginalPositions,j.getArg(e,"bias",Xe.GREATEST_LOWER_BOUND));if(o>=0){var n=this._originalMappings[o];if(n.source===i.source)return{line:j.getArg(n,"generatedLine",null),column:j.getArg(n,"generatedColumn",null),lastColumn:j.getArg(n,"lastGeneratedColumn",null)}}return{line:null,column:null,lastColumn:null}};$p.BasicSourceMapConsumer=tr;function _i(t,e){var r=t;typeof t=="string"&&(r=j.parseSourceMapInput(t));var i=j.getArg(r,"version"),o=j.getArg(r,"sections");if(i!=this._version)throw new Error("Unsupported version: "+i);this._sources=new Ml,this._names=new Ml;var n={line:-1,column:0};this._sections=o.map(function(s){if(s.url)throw new Error("Support for url field in sections not implemented.");var a=j.getArg(s,"offset"),m=j.getArg(a,"line"),c=j.getArg(a,"column");if(m<n.line||m===n.line&&c<n.column)throw new Error("Section offsets must be ordered and non-overlapping.");return n=a,{generatedOffset:{generatedLine:m+1,generatedColumn:c+1},consumer:new Xe(j.getArg(s,"map"),e)}})}_i.prototype=Object.create(Xe.prototype);_i.prototype.constructor=Xe;_i.prototype._version=3;Object.defineProperty(_i.prototype,"sources",{get:function(){for(var t=[],e=0;e<this._sections.length;e++)for(var r=0;r<this._sections[e].consumer.sources.length;r++)t.push(this._sections[e].consumer.sources[r]);return t}});_i.prototype.originalPositionFor=function(e){var r={generatedLine:j.getArg(e,"line"),generatedColumn:j.getArg(e,"column")},i=Nb.search(r,this._sections,function(n,s){var a=n.generatedLine-s.generatedOffset.generatedLine;return a||n.generatedColumn-s.generatedOffset.generatedColumn}),o=this._sections[i];return o?o.consumer.originalPositionFor({line:r.generatedLine-(o.generatedOffset.generatedLine-1),column:r.generatedColumn-(o.generatedOffset.generatedLine===r.generatedLine?o.generatedOffset.generatedColumn-1:0),bias:e.bias}):{source:null,line:null,column:null,name:null}};_i.prototype.hasContentsOfAllSources=function(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})};_i.prototype.sourceContentFor=function(e,r){for(var i=0;i<this._sections.length;i++){var o=this._sections[i],n=o.consumer.sourceContentFor(e,!0);if(n)return n}if(r)return null;throw new Error('"'+e+'" is not in the SourceMap.')};_i.prototype.generatedPositionFor=function(e){for(var r=0;r<this._sections.length;r++){var i=this._sections[r];if(i.consumer._findSourceIndex(j.getArg(e,"source"))!==-1){var o=i.consumer.generatedPositionFor(e);if(o){var n={line:o.line+(i.generatedOffset.generatedLine-1),column:o.column+(i.generatedOffset.generatedLine===o.line?i.generatedOffset.generatedColumn-1:0)};return n}}}return{line:null,column:null}};_i.prototype._parseMappings=function(e,r){this.__generatedMappings=[],this.__originalMappings=[];for(var i=0;i<this._sections.length;i++)for(var o=this._sections[i],n=o.consumer._generatedMappings,s=0;s<n.length;s++){var a=n[s],m=o.consumer._sources.at(a.source);m=j.computeSourceURL(o.consumer.sourceRoot,m,this._sourceMapURL),this._sources.add(m),m=this._sources.indexOf(m);var c=null;a.name&&(c=o.consumer._names.at(a.name),this._names.add(c),c=this._names.indexOf(c));var p={source:m,generatedLine:a.generatedLine+(o.generatedOffset.generatedLine-1),generatedColumn:a.generatedColumn+(o.generatedOffset.generatedLine===a.generatedLine?o.generatedOffset.generatedColumn-1:0),originalLine:a.originalLine,originalColumn:a.originalColumn,name:c};this.__generatedMappings.push(p),typeof p.originalLine=="number"&&this.__originalMappings.push(p)}gu(this.__generatedMappings,j.compareByGeneratedPositionsDeflated),gu(this.__originalMappings,j.compareByOriginalPositions)};$p.IndexedSourceMapConsumer=_i});var rI=Z(tI=>{var kz=Ob().SourceMapGenerator,Qp=vl(),Rz=/(\r?\n)/,_z=10,Sl="$$$isSourceNode$$$";function Xr(t,e,r,i,o){this.children=[],this.sourceContents={},this.line=t??null,this.column=e??null,this.source=r??null,this.name=o??null,this[Sl]=!0,i!=null&&this.add(i)}Xr.fromStringWithSourceMap=function(e,r,i){var o=new Xr,n=e.split(Rz),s=0,a=function(){var w=R(),E=R()||"";return w+E;function R(){return s<n.length?n[s++]:void 0}},m=1,c=0,p=null;return r.eachMapping(function(w){if(p!==null)if(m<w.generatedLine)g(p,a()),m++,c=0;else{var E=n[s]||"",R=E.substr(0,w.generatedColumn-c);n[s]=E.substr(w.generatedColumn-c),c=w.generatedColumn,g(p,R),p=w;return}for(;m<w.generatedLine;)o.add(a()),m++;if(c<w.generatedColumn){var E=n[s]||"";o.add(E.substr(0,w.generatedColumn)),n[s]=E.substr(w.generatedColumn),c=w.generatedColumn}p=w},this),s<n.length&&(p&&g(p,a()),o.add(n.splice(s).join(""))),r.sources.forEach(function(w){var E=r.sourceContentFor(w);E!=null&&(i!=null&&(w=Qp.join(i,w)),o.setSourceContent(w,E))}),o;function g(w,E){if(w===null||w.source===void 0)o.add(E);else{var R=i?Qp.join(i,w.source):w.source;o.add(new Xr(w.originalLine,w.originalColumn,R,E,w.name))}}};Xr.prototype.add=function(e){if(Array.isArray(e))e.forEach(function(r){this.add(r)},this);else if(e[Sl]||typeof e=="string")e&&this.children.push(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};Xr.prototype.prepend=function(e){if(Array.isArray(e))for(var r=e.length-1;r>=0;r--)this.prepend(e[r]);else if(e[Sl]||typeof e=="string")this.children.unshift(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};Xr.prototype.walk=function(e){for(var r,i=0,o=this.children.length;i<o;i++)r=this.children[i],r[Sl]?r.walk(e):r!==""&&e(r,{source:this.source,line:this.line,column:this.column,name:this.name})};Xr.prototype.join=function(e){var r,i,o=this.children.length;if(o>0){for(r=[],i=0;i<o-1;i++)r.push(this.children[i]),r.push(e);r.push(this.children[i]),this.children=r}return this};Xr.prototype.replaceRight=function(e,r){var i=this.children[this.children.length-1];return i[Sl]?i.replaceRight(e,r):typeof i=="string"?this.children[this.children.length-1]=i.replace(e,r):this.children.push("".replace(e,r)),this};Xr.prototype.setSourceContent=function(e,r){this.sourceContents[Qp.toSetString(e)]=r};Xr.prototype.walkSourceContents=function(e){for(var r=0,i=this.children.length;r<i;r++)this.children[r][Sl]&&this.children[r].walkSourceContents(e);for(var o=Object.keys(this.sourceContents),r=0,i=o.length;r<i;r++)e(Qp.fromSetString(o[r]),this.sourceContents[o[r]])};Xr.prototype.toString=function(){var e="";return this.walk(function(r){e+=r}),e};Xr.prototype.toStringWithSourceMap=function(e){var r={code:"",line:1,column:0},i=new kz(e),o=!1,n=null,s=null,a=null,m=null;return this.walk(function(c,p){r.code+=c,p.source!==null&&p.line!==null&&p.column!==null?((n!==p.source||s!==p.line||a!==p.column||m!==p.name)&&i.addMapping({source:p.source,original:{line:p.line,column:p.column},generated:{line:r.line,column:r.column},name:p.name}),n=p.source,s=p.line,a=p.column,m=p.name,o=!0):o&&(i.addMapping({generated:{line:r.line,column:r.column}}),n=null,o=!1);for(var g=0,w=c.length;g<w;g++)c.charCodeAt(g)===_z?(r.line++,r.column=0,g+1===w?(n=null,o=!1):o&&i.addMapping({source:p.source,original:{line:p.line,column:p.column},generated:{line:r.line,column:r.column},name:p.name})):r.column++}),this.walkSourceContents(function(c,p){i.setSourceContent(c,p)}),{code:r.code,map:i}};tI.SourceNode=Xr});var iI=Z(Yp=>{Yp.SourceMapGenerator=Ob().SourceMapGenerator;Yp.SourceMapConsumer=eI().SourceMapConsumer;Yp.SourceNode=rI().SourceNode});var nI=Z((kHe,oI)=>{var Nz=Object.prototype.toString,Bb=typeof Buffer.alloc=="function"&&typeof Buffer.allocUnsafe=="function"&&typeof Buffer.from=="function";function Bz(t){return Nz.call(t).slice(8,-1)==="ArrayBuffer"}function Cz(t,e,r){e>>>=0;var i=t.byteLength-e;if(i<0)throw new RangeError("'offset' is out of bounds");if(r===void 0)r=i;else if(r>>>=0,r>i)throw new RangeError("'length' is out of bounds");return Bb?Buffer.from(t.slice(e,e+r)):new Buffer(new Uint8Array(t.slice(e,e+r)))}function Vz(t,e){if((typeof e!="string"||e==="")&&(e="utf8"),!Buffer.isEncoding(e))throw new TypeError('"encoding" must be a valid string encoding');return Bb?Buffer.from(t,e):new Buffer(t,e)}function zz(t,e,r){if(typeof t=="number")throw new TypeError('"value" argument must not be a number');return Bz(t)?Cz(t,e,r):typeof t=="string"?Vz(t,e):Bb?Buffer.from(t):new Buffer(t)}oI.exports=zz});var pI=Z((Ks,Cb)=>{var Uz=iI().SourceMapConsumer,Vb=require("path"),uo;try{uo=require("fs"),(!uo.existsSync||!uo.readFileSync)&&(uo=null)}catch(t){}var Wz=nI();function sI(t,e){return t.require(e)}var aI=!1,lI=!1,zb=!1,yu="auto",Js={},bu={},qz=/^data:application\/json[^,]+base64,/,Vn=[],zn=[];function Ub(){return yu==="browser"?!0:yu==="node"?!1:typeof window!="undefined"&&typeof XMLHttpRequest=="function"&&!(window.require&&window.module&&window.process&&window.process.type==="renderer")}function jz(){return typeof process=="object"&&process!==null&&typeof process.on=="function"}function Xp(t){return function(e){for(var r=0;r<t.length;r++){var i=t[r](e);if(i)return i}return null}}var Wb=Xp(Vn);Vn.push(function(t){if(t=t.trim(),/^file:/.test(t)&&(t=t.replace(/file:\/\/\/(\w:)?/,function(i,o){return o?"":"/"})),t in Js)return Js[t];var e="";try{if(uo)uo.existsSync(t)&&(e=uo.readFileSync(t,"utf8"));else{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),r.readyState===4&&r.status===200&&(e=r.responseText)}}catch(i){}return Js[t]=e});function qb(t,e){if(!t)return e;var r=Vb.dirname(t),i=/^\w+:\/\/[^\/]*/.exec(r),o=i?i[0]:"",n=r.slice(o.length);return o&&/^\/\w\:/.test(n)?(o+="/",o+Vb.resolve(r.slice(o.length),e).replace(/\\/g,"/")):o+Vb.resolve(r.slice(o.length),e)}function Hz(t){var e;if(Ub())try{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),e=r.readyState===4?r.responseText:null;var i=r.getResponseHeader("SourceMap")||r.getResponseHeader("X-SourceMap");if(i)return i}catch(a){}e=Wb(t);for(var o=/(?:\/\/[@#][\s]*sourceMappingURL=([^\s'"]+)[\s]*$)|(?:\/\*[@#][\s]*sourceMappingURL=([^\s*'"]+)[\s]*(?:\*\/)[\s]*$)/mg,n,s;s=o.exec(e);)n=s;return n?n[1]:null}var jb=Xp(zn);zn.push(function(t){var e=Hz(t);if(!e)return null;var r;if(qz.test(e)){var i=e.slice(e.indexOf(",")+1);r=Wz(i,"base64").toString(),e=t}else e=qb(t,e),r=Wb(e);return r?{url:e,map:r}:null});function Hb(t){var e=bu[t.source];if(!e){var r=jb(t.source);r?(e=bu[t.source]={url:r.url,map:new Uz(r.map)},e.map.sourcesContent&&e.map.sources.forEach(function(o,n){var s=e.map.sourcesContent[n];if(s){var a=qb(e.url,o);Js[a]=s}})):e=bu[t.source]={url:null,map:null}}if(e&&e.map&&typeof e.map.originalPositionFor=="function"){var i=e.map.originalPositionFor(t);if(i.source!==null)return i.source=qb(e.url,i.source),i}return t}function mI(t){var e=/^eval at ([^(]+) \((.+):(\d+):(\d+)\)$/.exec(t);if(e){var r=Hb({source:e[2],line:+e[3],column:e[4]-1});return"eval at "+e[1]+" ("+r.source+":"+r.line+":"+(r.column+1)+")"}return e=/^eval at ([^(]+) \((.+)\)$/.exec(t),e?"eval at "+e[1]+" ("+mI(e[2])+")":t}function Gz(){var t,e="";if(this.isNative())e="native";else{t=this.getScriptNameOrSourceURL(),!t&&this.isEval()&&(e=this.getEvalOrigin(),e+=", "),t?e+=t:e+="<anonymous>";var r=this.getLineNumber();if(r!=null){e+=":"+r;var i=this.getColumnNumber();i&&(e+=":"+i)}}var o="",n=this.getFunctionName(),s=!0,a=this.isConstructor(),m=!(this.isToplevel()||a);if(m){var c=this.getTypeName();c==="[object Object]"&&(c="null");var p=this.getMethodName();n?(c&&n.indexOf(c)!=0&&(o+=c+"."),o+=n,p&&n.indexOf("."+p)!=n.length-p.length-1&&(o+=" [as "+p+"]")):o+=c+"."+(p||"<anonymous>")}else a?o+="new "+(n||"<anonymous>"):n?o+=n:(o+=e,s=!1);return s&&(o+=" ("+e+")"),o}function uI(t){var e={};return Object.getOwnPropertyNames(Object.getPrototypeOf(t)).forEach(function(r){e[r]=/^(?:is|get)/.test(r)?function(){return t[r].call(t)}:t[r]}),e.toString=Gz,e}function cI(t,e){if(e===void 0&&(e={nextPosition:null,curPosition:null}),t.isNative())return e.curPosition=null,t;var r=t.getFileName()||t.getScriptNameOrSourceURL();if(r){var i=t.getLineNumber(),o=t.getColumnNumber()-1,n=/^v(10\.1[6-9]|10\.[2-9][0-9]|10\.[0-9]{3,}|1[2-9]\d*|[2-9]\d|\d{3,}|11\.11)/,s=n.test(process.version)?0:62;i===1&&o>s&&!Ub()&&!t.isEval()&&(o-=s);var a=Hb({source:r,line:i,column:o});e.curPosition=a,t=uI(t);var m=t.getFunctionName;return t.getFunctionName=function(){return e.nextPosition==null?m():e.nextPosition.name||m()},t.getFileName=function(){return a.source},t.getLineNumber=function(){return a.line},t.getColumnNumber=function(){return a.column+1},t.getScriptNameOrSourceURL=function(){return a.source},t}var c=t.isEval()&&t.getEvalOrigin();return c&&(c=mI(c),t=uI(t),t.getEvalOrigin=function(){return c}),t}function Kz(t,e){zb&&(Js={},bu={});for(var r=t.name||"Error",i=t.message||"",o=r+": "+i,n={nextPosition:null,curPosition:null},s=[],a=e.length-1;a>=0;a--)s.push(`
    at `+cI(e[a],n)),n.nextPosition=n.curPosition;return n.curPosition=n.nextPosition=null,o+s.reverse().join("")}function fI(t){var e=/\n    at [^(]+ \((.*):(\d+):(\d+)\)/.exec(t.stack);if(e){var r=e[1],i=+e[2],o=+e[3],n=Js[r];if(!n&&uo&&uo.existsSync(r))try{n=uo.readFileSync(r,"utf8")}catch(a){n=""}if(n){var s=n.split(/(?:\r\n|\r|\n)/)[i-1];if(s)return r+":"+i+`
`+s+`
`+new Array(o).join(" ")+"^"}}return null}function Jz(t){var e=fI(t);process.stderr._handle&&process.stderr._handle.setBlocking&&process.stderr._handle.setBlocking(!0),e&&(console.error(),console.error(e)),console.error(t.stack),process.exit(1)}function $z(){var t=process.emit;process.emit=function(e){if(e==="uncaughtException"){var r=arguments[1]&&arguments[1].stack,i=this.listeners(e).length>0;if(r&&!i)return Jz(arguments[1])}return t.apply(this,arguments)}}var Qz=Vn.slice(0),Yz=zn.slice(0);Ks.wrapCallSite=cI;Ks.getErrorSource=fI;Ks.mapSourcePosition=Hb;Ks.retrieveSourceMap=jb;Ks.install=function(t){if(t=t||{},t.environment&&(yu=t.environment,["node","browser","auto"].indexOf(yu)===-1))throw new Error("environment "+yu+" was unknown. Available options are {auto, browser, node}");if(t.retrieveFile&&(t.overrideRetrieveFile&&(Vn.length=0),Vn.unshift(t.retrieveFile)),t.retrieveSourceMap&&(t.overrideRetrieveSourceMap&&(zn.length=0),zn.unshift(t.retrieveSourceMap)),t.hookRequire&&!Ub()){var e=sI(Cb,"module"),r=e.prototype._compile;r.__sourceMapSupport||(e.prototype._compile=function(n,s){return Js[s]=n,bu[s]=void 0,r.call(this,n,s)},e.prototype._compile.__sourceMapSupport=!0)}if(zb||(zb="emptyCacheBetweenOperations"in t?t.emptyCacheBetweenOperations:!1),aI||(aI=!0,Error.prepareStackTrace=Kz),!lI){var i="handleUncaughtExceptions"in t?t.handleUncaughtExceptions:!0;try{var o=sI(Cb,"worker_threads");o.isMainThread===!1&&(i=!1)}catch(n){}i&&jz()&&(lI=!0,$z())}};Ks.resetRetrieveHandlers=function(){Vn.length=0,zn.length=0,Vn=Qz.slice(0),zn=Yz.slice(0),jb=Xp(zn),Wb=Xp(Vn)}});var yM=P(require("commander")),bM=P(require("process"));var uM=P(require("process"));function Pl(t){return t!=null&&typeof t!="string"&&typeof t[Symbol.iterator]=="function"}function h(t){return t==null?"":typeof t=="string"?t:Array.isArray(t)?t.map(h).join(","):t.toString()}var TI=["number","string","boolean"];function ei(t){return TI.indexOf(typeof t)!==-1||t instanceof Date}function wu(t){return Array.isArray(t)&&t.every(ei)}var Jb=["boolean","number","bigint","symbol","string","object","function"];function Nt(t,e){if(t==null&&e==null)return 0;if(t==null)return-1;if(e==null)return 1;let r=typeof t,i=typeof e;return(r==="string"||r==="symbol")&&(i==="string"||i==="symbol")?h(t).localeCompare(h(e)):Array.isArray(t)&&Array.isArray(e)?vI(t,e):r!==i?Jb.indexOf(r)-Jb.indexOf(i):t>e?1:t<e?-1:0}function xi(t,e){return Nt(t,e)<0}function $b(t,e){return Nt(t,e)<=0}function Bi(t,e){return Nt(t,e)>=0}function $s(t,e){return Nt(t,e)>0}function vI(t,e){if(L(t)&&L(e))return 0;let r=Math.min(t.length,e.length);for(let i=0;i<r;i++){let o=Nt(t[i],e[i]);if(o!==0)return o}return Nt(t.length,e.length)}var ti;(function(t){t[t.Empty=0]="Empty",t[t.Primitive=1]="Primitive",t[t.Symbol=2]="Symbol",t[t.Object=3]="Object",t[t.Array=4]="Array",t[t.Iterable=5]="Iterable",t[t.Instance=6]="Instance",t[t.Function=7]="Function",t[t.Unknown=8]="Unknown"})(ti||(ti={}));function MI(t){return typeof t=="symbol"}function Ee(t){return typeof t=="function"}function xu(t){return SI(t)===3}function SI(t){return t==null?0:MI(t)?2:ei(t)?1:Array.isArray(t)?4:Pl(t)?5:Ee(t)?7:typeof t=="object"?t.constructor!=null&&t.constructor.name==="Object"?3:6:8}function Mr(t){return Ee(t)?t():t}function Qs(t){for(let e of t){let r=e();if(r!=null)return r}}var ed=()=>{};function f(t,e){return t==null?void 0:e(t)}function Wn(t,e,r){return t==null||e==null?void 0:r(t,e)}function Qb(t,e,r,i){return t==null||e==null||r==null?void 0:i(t,e,r)}function T(t,e){return t??Mr(e)}function ee(t,e,r){return t!=null?e(t):Mr(r)}function jo(t,e,r,i){return T(Wn(t,e,r),i)}function Ci(t){return t!=null}function Tu(t){return t!=null&&t.every(Ci)}function Yb(...t){return t.find(Ci)}function Ys(t){return t==null||h(t)==="null"?void 0:t}function v(t){if(t==null)return!0;let e=h(t);return e.length===0||e.trim().length===0}var PI=/^\s*(?:null|undefined)?\s*$/i;function Xs(t){return t==null||PI.exec(t)!=null}function M(t){return!v(t)}function td(t){if(t==null)return;let e=h(t);return e.length===0||e.trim().length===0?void 0:e}function ri(t,e){if(t==null)return Mr(e);let r=h(t).trim();return r.length>0?r:Mr(e)}function rd(t,e){return v(t)?!1:e(t)}function q(t,e){if(t===!1||t==null||t==="")return;let r=h(t);return M(r)?e(r):void 0}function Ti(t,e,r){return T(q(t,e),r)}function vu(...t){for(let e of t)if(M(e))return e}function O(t,e,r,i){return JSON.stringify(t,EI(e,i),Ys(r))}function EI(t,e){let r=[],i=[],o=e??((n,s)=>r[0]===s?"[Circular ~]":"[Circular ~."+i.slice(0,r.indexOf(s)).join(".")+"]");return function(n,s){if(r.length>0){let m=r.indexOf(this);m>=0?(r.splice(m+1),i.splice(m,Infinity,n)):(r.push(this),i.push(n)),r.indexOf(s)>=0&&(s=o.call(this,n,s))}else r.push(s);return t==null?s:t.call(this,n,s)}}function co(t,e){return O(t)===O(e)}function Xb(t){return t!=null&&(Array.isArray(t)||isFinite(t.length)&&Ee(t[Symbol.iterator])&&Ee(t.push)&&Ee(t.pop)&&Ee(t.forEach)&&Ee(t.some))}function Sr(t,e,r){if(e==null)throw new Error("null key");if(t.has(e))return t.get(e);{let i=r();return i!=null&&t.set(e,i),i}}var id;(function(R){R.isDefined=!1,R.isEmpty=!0,R.get=()=>{},R.exists=()=>!1;let o=()=>R;R.map=o,R.flatMap=o,R.filter=o,R.forEach=o,R.getOrElse=oe=>oe(),R.orElse=oe=>W(oe()),R.zip1=o,R.zip2=o,R.zip3=o})(id||(id={}));var Zb=id,El=class{constructor(e){this.a=e;this.isDefined=!0;this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new El(e(this.a))}flatMap(e){let r=e(this.a);return ew(r)?r:W(r)}filter(e){return W(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,r){return W(e).flatMap(i=>r(this.a,i))}zip2(e,r,i){return W(e).flatMap(o=>W(r).flatMap(n=>i(this.a,o,n)))}zip3(e,r,i,o){return W(e).flatMap(n=>W(r).flatMap(s=>W(i).flatMap(a=>o(this.a,n,s,a))))}};function ew(t){return t instanceof El||t===Zb}function W(t){return ew(t)?t:t!=null?new El(t):Zb}function se(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function Al(t,e){return se(t)?e(t):void 0}var Mu=t=>(e,r)=>se(e)&&se(r)&&t(e,r),Dl=Mu((t,e)=>t<e),fo=Mu((t,e)=>t<=e),Zs=Mu((t,e)=>t>e),Pr=Mu((t,e)=>t>=e);function tw(t,e){return t/(e===0?1e-8:e)}function rw(t,e,r){return t==null||e==null?!1:t===e?!0:Pr(t<e?tw(t,e):tw(e,t),r)}function Su(t,e,r){return t==null||e==null?!1:Math.abs(t-e)<r}function AI(t){if(!se(t))return;let e=Math.trunc(t);return e===0?Math.abs(e):e}function DI(t){return Ee(t.toNumber)}function iw(t,e){if(v(t))return e.defaultValue;if(se(t))return e.nton(t);if(DI(t))return e.nton(t.toNumber());try{let r=e.ston(h(t));return se(r)?e.nton(r):e.defaultValue}catch{return e.defaultValue}}function G(t,e){return iw(t,y({defaultValue:void 0,nton:r=>AI(r),ston:parseInt},e))}function ii(t,e){return iw(t,y({defaultValue:void 0,nton:r=>r,ston:parseFloat},e))}function C(t){return se(t)&&t>0}function ow(t,e){return se(t)&&se(e)&&t>e?t:void 0}function Pu(t){return se(t)&&t>=0}function ea(t,e){return W(t).flatMap(r=>G(r)).flatMap(e).get()}function od(t){let e=G(t);return C(e)?String(e):void 0}function Vi(t,e){return se(t)?e(t):void 0}function Ho(t,e,r){return Vi(t,i=>Vi(e,o=>r(i,o)))}function nd(t,e,r){return se(t)?e(t):r}function nw(t,e){return se(t)?t:Mr(e)}function ut(t){return t<0?-Math.round(-t):Math.round(t)}function Ie(t,e){if(t===0||e===0)return 0;let r=e-ut(Math.ceil(Math.log10(Math.abs(t)))),i=Math.pow(10,Math.abs(r));return r<0?ut(t/i)*i:ut(t*i)/i}function te(t,e,r){if(t>e||!se(t)||!se(e))throw new Error(`invalid clamp(${t}, ${e}, ${r})`);return se(r)?r<t?t:r>e?e:r:ut((t+e)/2)}function xe(t,e){if(!C(t))return[];let r=Math.round(t);return r<=0?[]:[...Array(r)].map((i,o)=>e(o))}function Ut(t,e,r=[]){if(t=Math.ceil(t),e=Math.floor(e),e<t)return t;if(k(r)&&r.length+10>e-t){let o=po(t,e).filter(n=>!r.includes(n));return ge(o,n=>n[Ut(0,o.length)])}let i=Math.floor(Math.random()*(e-t))+t;return r.includes(i)?Ut(t,e,r):i}var sw="0123456789abcdefghijkmnopqrstuvwxyz";function Fl(t,e=sw){let r="";for(let i=0;i<t;i++)r+=FI(e);return r}function FI(t=sw){return t[Ut(0,t.length)]}function ct(t){return typeof t=="string"}function zi(t,e){return t=h(t),e=h(e),t.startsWith(e)?t:e+t}function Wt(t,e){return t=h(t),e=h(e),t.endsWith(e)?t:t+e}function ir(t,e=80){if(t==null)return"";let r=h(t);return r.length<=e?r:r.slice(0,e-1)+"\u2026"}var ho=/\r?\n/gm;function LI(t,e,r){r==null&&(r=t.length);for(let i=r;i>=0;i--)if(t.substr(i).startsWith(e))return i;return-1}function go(t,e={maxLineLen:75,prefix:""}){if(t.includes(`
`))return Y(t.split(ho).map(i=>go(i,e)));if(t=zi(h(t),e.prefix).trim(),t.length<=e.maxLineLen)return[t];let r=LI(t," ",e.maxLineLen);if(r>e.prefix.length)return[t.slice(0,r),...go(t.slice(r+1),e)];{let i=t.indexOf(" ",e.prefix.length+1);return i>0&&i<t.length-1?[t.slice(0,i),...go(t.slice(i+1),e)]:[t]}}function Ll(t,e,r){return e===""?t:t.split(e).join(r)}function Ui(...t){return t.join(" ").replace(/\s+/g," ").trim()}function F(t){return t==null?[]:Array.isArray(t)?t:Pl(t)?Array.from(t):[t]}function k(t){return Xb(t)&&t.length>0&&t.some(e=>e!=null)}function aw(t,e){return k(t)?t:Mr(e)}function L(t){return!k(t)}function ge(t,e){return k(t)?e(t):void 0}function II(t){return ei(t)||wu(t)?t:t.valueOf()}function Y(t,e=[]){if(t==null)return e;for(let r of t)if(r!=null)if(Array.isArray(r))for(let i of r)i!=null&&e.push(i);else e.push(r);return e}function cr(t){return qn(D(t),II)}function sd(t,e){for(let r=0;r<t.length;r++)e[r]=t[r];return e.length=t.length,e}function qn(t,e){return sd(X(t,e),t)}function X(t,e){return F(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:f(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>Nt(r.cmp,i.cmp)).map(r=>r.item)}function Eu(t,e){return t!=null&&e!=null&&t.length===e.length&&t.every((r,i)=>r===e[i])}function Au(t,e){return Eu(t.slice(0,e.length),e)}function et(t,e){for(let r=0;r<t.length;)e(t[r],r,t)?r++:t.splice(r,1);return t}function yo(t,e){if(t==null)return!1;for(let r of t)if(e.valueOf()===r.valueOf())return!0;return!1}function Du(t,e){return t==null||e==null?!1:e.every(r=>yo(t,r))}function Fu(t,e,r){let i=t.map(r);for(let o of e){let n=r(o);i.includes(n)||(t.push(o),i.push(n))}return t}function D(t){if(t==null)return[];let e=F(t);return e.every(Ci)?e:e.filter(Ci)}function Go(t){let e=F(t).filter(r=>!Xs(h(r)));return ct(e[0])?e.map(r=>h(r).trim()):e}function _(t){return F(t).map(e=>h(e).trim()).filter(e=>e.length>0)}function V(t){return Er(D(t),e=>O(e))}function Er(t,e=r=>O(r)){if(L(t))return[];let r=new Map;for(let i of t)if(i!=null){let o=e(i);o!=null&&Sr(r,o,()=>i)}return[...r.values()]}function Lu(t,e){if(L(t))return[];let r=[];for(let i of t)i!=null&&r.every(o=>!e(i,o))&&r.push(i);return r}function fr(t,e){return t.reduce((r,i,o)=>r+(e(i,o)?1:0),0)}function ta(t,e){return t.reduce((r,i,o)=>r+e(i,o),0)}function Il(t,e){if(t==null||e==null)return 0;if(t===e||(typeof t=="string"&&(t=t.split("")),typeof e=="string"&&(e=e.split("")),Eu(t,e)))return t.length;let r=0;for(;t[r]===e[r];)r++;return r}function po(t,e,r=i=>i){return jn(t,e,1,r)}function jn(t,e,r=1,i=o=>o){let o=[];if(t<e)for(let n=t;n<e;n+=r)o.push(i(n));else for(let n=t;n>e;n-=r)o.push(i(n));return o}function Iu(t,e){let r=new Set(e);return t.filter(i=>!r.has(i))}function Ou(t){return t!=null?t[t.length-1]:void 0}function l(t,e){return new lw(t,e).asMemoizedThunk()}var lw=class{constructor(e,r){this.thunk=e;this.ttlMs=r;this.lastSet=0;this.listeners=[]}asMemoizedThunk(){let e=this.apply.bind(this);return e.set=this.set.bind(this),e.clear=this.clear.bind(this),e.unset=this.unset.bind(this),e.prior=this.prior.bind(this),e.refresh=this.refresh.bind(this),e.ttl=this.ttl.bind(this),e.setTTL=this.setTTL.bind(this),e.onChange=this.onChange.bind(this),e.toJSON=this.toJSON.bind(this),e.lastSetAgoMs=this.lastSetAgoMs.bind(this),e}async onSetResult(e,r){if(L(this.listeners))return;let i=await e,o=await r;if(!co(i,o))for(let n of this.listeners)n(o,i)}setResult(e){return this.lastSet=Date.now(),this.onSetResult(this.result,e),this.result=e}apply(){return(this.lastSet===0||this.ttlMs!=null&&this.lastSet+this.ttlMs<=Date.now())&&this.setResult(this.thunk()),this.result}set(e){return this.setResult(e)}unset(){this.setResult(void 0),this.lastSet=0}clear(){let e=this.result;return this.unset(),e}prior(){return this.result}refresh(){return this.setResult(this.thunk())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=e}onChange(e){this.listeners.push(e),f(this.result,e)}toJSON(){return"(Lazy)"}lastSetAgoMs(){return Date.now()-this.lastSet}};var S=1e3,A=60*S,Ft=60*A,ot=24*Ft,mw=7*ot,uw=365.25*ot,xW=l(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));function ra(t){return t instanceof Date}function cw(t,e){return new Date(T(e,new Date).getTime()-t)}function Wi(t){let e=ra(t)?t.getTime():se(t)?t:Date.now();return Math.floor(e/S)}function Hn(t){let e=String(t);return e.length>=2?e:("0"+e).slice(-2)}function fw(t){let e=ra(t)?t:new Date(t);return e.getFullYear()+Hn(e.getMonth()+1)+Hn(e.getDate())+Hn(e.getHours())+Hn(e.getMinutes())+Hn(e.getSeconds())}function ku(t){let e=ra(t)?t:new Date(t);return e.getFullYear()+"-"+Hn(e.getMonth()+1)+"-"+Hn(e.getDate())}function Ae(...t){let e=Object.freeze(t),r={};for(let a of e)r[a]=a;let i=a=>a!=null&&e.includes(a),o=a=>a==null?-1:e.indexOf(a),n=(a,m)=>i(a)?a:Mr(m),s=(a,m)=>i(a)?m(a):void 0;return y(y({},r),{values:e,length:e.length,has:i,indexOf:o,validOrElse:n,mapValid:s})}var ia=P(require("process"));function ad(t){return typeof t=="boolean"}function I(t){if(typeof t=="boolean")return t;if(t==null)return!1;if(t===1)return!0;let e=String(t).toLowerCase();return["true","1"].includes(e)}function pw(t){return I(t)?!0:oi(t)?!1:void 0}function dw(t){return I(t)?1:0}function oi(t){if(typeof t=="boolean")return!t;if(t==null)return!1;if(t===0)return!0;let e=String(t).toLowerCase();return["false","0"].includes(e)}function OI(){switch(h(ia.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return ia.argv.some(t=>t.endsWith("mocha")||t.endsWith(".spec.js"))?"test":"production"}}var Ko=(()=>{let t=OI();return ia.env.NODE_ENV=t,t})();var Pe=Ko==="test",pr=Ko==="production";function Gn(){return Pe&&I(ia.env.SINGLE_SPEC_TESTS)}var qi=Date.now();var Kn="PhotoStructure",vi=l(()=>Kn+(pr?"":`-${Ko}`));function De(t,e){return r=>`[${t}m${r}[${e}m`}var OW=De(30,39),Ru=De(31,39),_u=De(32,39),oa=De(33,39),Nu=De(34,39),Bu=De(35,39),Cu=De(36,39),kW=De(37,39),na=De(90,39),hw=De(91,39),RW=De(92,39),gw=De(93,39),yw=De(94,39),_W=De(95,39),NW=De(96,39),BW=De(97,39),bw=De(40,49),CW=De(41,49),VW=De(42,49),zW=De(43,49),UW=De(44,49),WW=De(45,49),qW=De(46,49),jW=De(47,49),HW=De(100,49),GW=De(101,49),KW=De(102,49),JW=De(103,49),$W=De(104,49),QW=De(105,49),YW=De(106,49),XW=De(107,49);var Mw=P(require("process"));function Lt(t,e){return e!=null?e(t):typeof t=="string"?console.log(t):console.dir(t,{depth:3}),t}function yt(t){return t==null||typeof t!="object"?[]:Object.keys(t).filter(e=>typeof e=="string"&&(t.propertyIsEnumerable==null||t.propertyIsEnumerable(e)===!0))}function Mt(t){return yt(t).map(e=>t[e])}function tt(t){return yt(t).map(e=>[e,t[e]])}function ft(t,e){return typeof e!="object"&&(e={}),D(t).reduce((r,[i,o])=>Lt(r,()=>{i!=null&&o!=null&&(r[i]=o)}),e)}function Mi(t){if(t==null)return;let e=tt(t).filter(([r,i])=>r!=null&&i!=null);return L(e)?void 0:ft(e)}function ld(t){if(t==null)return;let e=tt(t).filter(([r,i])=>r!=null&&M(i));return L(e)?void 0:ft(e)}function Jo(t,e,r={}){let i=D(tt(t).sort(([o],[n])=>o.localeCompare(n,void 0,{sensitivity:"base"})).map(([o,n])=>e(o,n)));return ft(i.filter(([o,n])=>o!=null&&n!=null),r)}function rt(t,...e){if(t==null)return t;if(!e.every(i=>typeof i=="string"))throw new Error("bad keys: "+O(e));if(L(e))return{};let r={};for(let i of e){let o=t[i];o!=null&&(r[i]=o)}return r}function qt(t,...e){if(t==null||e.every(i=>v(t[i])))return t;let r=tt(t).filter(([i])=>!e.includes(i));return L(r)?void 0:ft(r)}function Vu(t){return Mt(t).every(e=>e!=null)}function Jn(t){return Vu(t)?t:void 0}function ww(t){return t.filter(Vu)}function xw(t){return ft(X(tt(t),([e])=>e.toLowerCase()))}function Tw(t,e){return t==null?t:ft(tt(t).filter(([r,i])=>e(r,i)))}function zu(t,e,...r){return t!=null&&Ee(t[e])?t[e].bind(t)(...r):void 0}function vw(t,e){if(v(e))return;if(t[e]!=null)return t[e];let r=e.toLocaleLowerCase().normalize();for(let i of yt(t))if(r===i.toLocaleLowerCase().normalize()&&t[i]!=null)return t[i]}function qe(t){return vw(Mw.env,t)}function bo(t){return I(qe(t))}var Sw=P(require("util"));var kI=require("deep-eql");function nt(t,e){return kI(t,e)}function Ol(t,e){return t==null||e==null?!1:nt(t,e)}async function $n(t,e){return jo(await t,await e,nt,()=>!1)}async function md(t,e,...r){return jo(await t,await e,(i,o)=>nt(rt(i,...r),rt(o,...r)),()=>!1)}function Uu(...t){return t!=null&&t.every(M)}function Pw(t){return t==null||t.some(e=>e==null)}function Ge(t,e){if(t!=null)for(let r of D(t)){let i=e(r);if(i!=null)return i}}async function Wu(t,e){if(t!=null){let r=-1;for(let i of t){r++;try{if(i==null)continue;let o=await e(i,r);if(o!=null)return o}catch(o){}}}}function Ew(t,e){for(let r=t.length-1;r>=0;r--)if(e(t[r]))return t[r]}function Aw(t,...e){let r=t.length;return et(t,i=>e.every(o=>!nt(i,o))),r!==t.length}var Dw=t=>{if(ei(t))return t;if(Array.isArray(t))return O(t);if(Ee(t.valueOf))return t.valueOf();throw new Error("Cannot get primitive value for "+(0,Sw.inspect)(t))};function ud(t,e,r=Dw){let i=new Set(e.map(r));return t.filter(o=>i.has(r(o)))}function Fw(t,e,r=Dw){return L(t)&&L(e)?1:ud(t,e,r).length*2/(t.length+e.length)}function qu(t,e=r=>O(r)){sd(Er(t,e),t)}function wo(t,e){let r=[],i=[];return t.forEach((o,n)=>(e(o,n)?r:i).push(o)),[r,i]}function Iw(t){return Lw(t.sort())}function Lw(t){if(t==null||t.length===0)return[];let e=t[0],r=t.lastIndexOf(e);return[{t:e,count:r+1},...Lw(t.slice(r+1))]}function Ow(t,e){return t.reduce((r,i)=>r.concat(...D(e(i))),[])}function ju(t,e){return t.length>e&&t.splice(0,t.length-e),t}function kw(t,e){return t.length=Math.min(t.length,e),t}function Qn(...t){let e=Math.max(...t.map(r=>r.length));return xe(e,r=>t.map(i=>i[r]))}function Rw(...t){let e=Math.max(...t.map(i=>i.length)),r=[];return xe(e,i=>t.map(o=>r.push(o[i]))),r}function _w(t){return xe(t.length,e=>t.slice(0,e+1))}function cd(t){return Hu(t,e=>e.valueOf())}function sa(t){return t[Nw(t)]}function Nw(t){return Bw(t,e=>e.valueOf())}function Hu(t,e){return Cw(t,e,(r,i)=>xi(r,i))}function Bw(t,e){return Cw(t,e,(r,i)=>$s(r,i))}function xo(t,e){return t[Hu(t,e)]}function bt(t,e){return t[Bw(t,e)]}function Cw(t,e,r){if(L(t))return-1;let i=-1,o;for(let n=0;n<t.length;n++){let s=t[n];if(s!=null){let a=e(s);a!=null&&(o==null||r(a,o)===!0)&&(i=n,o=a)}}return i}function aa(t,e){return e<=0&&(e=1),jn(0,t.length,e,r=>t.slice(r,r+e))}async function Vw(t,e){return RI(t,e,!0)}async function RI(t,e,r=!1){let i=[];e:for(let o of t){for(let n of i)if(r){if(await fd(n,s=>e(o,s))){n.push(o);continue e}}else if(await _I(n,s=>e(o,s))){n.push(o);continue e}i.push([o])}return i}async function _I(t,e){if(t!=null){for(let r=0;r<t.length;r++)if(await e(t[r],r))return!0}return!1}async function fd(t,e){return L(t)||(await Promise.all(t.map(e))).every(r=>r)}var Zw=P(require("util"));var kl=class{constructor(e){this.maxLength=e;this._length=0;this._firstIndex=0;if(e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...xe(e,()=>null))}mapIndex(e,r){return e=Math.trunc(e)??0,e<0&&(e+=this._length),e<0||e>this._length-1?void 0:r((e+this._firstIndex+this.maxLength)%this.maxLength)}item(e){return this.mapIndex(e,r=>this.store[r])}set(e,r){return this.mapIndex(e,i=>this.store[i]=r)}get length(){return this._length}set length(e){this._length=te(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){let e=this;function*r(){for(let i=0;i<e.length;i++)yield e.mapIndex(i,o=>e.store[o])}return r()}push(...e){for(let r of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,i=>{this.store[i]=r});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(let r of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,i=>{this.store[i]=r,this._firstIndex=i});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}shiftOrFirst(){return this.length>1?this.shift():this.item(0)}every(e){for(let r=0;r<this._length;r++)if(!e(this.item(r),r))return!1;return!0}some(e){for(let r=0;r<this._length;r++)if(e(this.item(r),r))return!0;return!1}forEach(e){for(let r=0;r<this._length;r++)e(this.item(r),r)}map(e){let r=[];for(let i=0;i<this._length;i++)r.push(e(this.item(i),i));return r}reduce(e,r){let i=r;for(let o=0;o<this._length;o++)i=e(i,this.item(o),o);return i}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,r=>{this.mapIndex(this._length-1-e,i=>{let o=this.store[i];this.store[i]=this.store[r],this.store[r]=o})});return this}toA(){return[...this]}slice(e,r){return[...this].slice(e,r)}};var NI=require("he"),Rl={};function Yn(t,e){if(e<1)return"";for(Rl[t]==null&&(Rl[t]=t);e>Rl[t].length;)Rl[t]+=t;return Rl[t].substring(0,e)}function dr(t,e,r){if(r.length===0)throw new Error("leftPad() given empty pad");if(typeof t=="number"&&t<0)return"-"+dr(String(-t),e-1,r);let i=String(t);return Yn(r,e-i.length)+i}function zw(t,e,r){if(r.length===0)throw new Error("rightPad() given empty pad");let i=String(t);return i+Yn(r,e-i.length)}function jt(t){return dr(t,2,"0")}function Uw(t,e,r,i){return t.substr(0,e)+Yn(i,r)+t.substr(e+r)}function $o(t,e,r){let i=Math.min(Math.ceil(t.length/e),T(r,()=>t.length))-1;return i<=0?[t]:[...xe(i,o=>t.slice(o*e,(o+1)*e)),t.slice(i*e)]}function Si(t,e){let r=e.exec(t);if(r==null||r[1]==null)return;let i=r[0].indexOf(r[1])+r.index;return{captured:r[1],uncaptured:t.substring(0,i)+t.substring(i+r[1].length),unmatched:t.substring(0,r.index)+t.substring(r.index+r[0].length),matchedIndex:i}}function st(t,e){let r=h(t),i=h(e);return i.length>0&&r.startsWith(i)?r.slice(i.length):r}function Gu(t,e){return t=h(t),e=h(e),Ww(t,e)?t.slice(e.length):t}function hr(t,e){if(e==null)return t;let r=h(t),i=h(e);return i.length>0&&r.endsWith(i)?r.slice(0,-i.length):r}function Ku(t,e,r){return e==null?hr(t,r):(t=h(t),t.endsWith(r)&&t.startsWith(e)?t.slice(e.length,-r.length):t)}function qw(t,e=80,r=80){let i=h(t),o=i.length-(e+r);return o<=0?i:i.slice(0,e).trim()+" \u2026(+"+o+" chars)\u2026"+i.slice(-r).trim()}function Qo(t){t=h(t);let e=t.normalize().split("");return v(t)?t:e[0].toLocaleUpperCase()+e.slice(1).join("")}function pd(t,e){return t.localeCompare(e,void 0,{sensitivity:"base"})}function Ve(t,e){if(t==null||e==null)return!1;let r=h(t),i=h(e);return r.length!==i.length?!1:r===i||r.toLowerCase()===i.toLowerCase()?!0:r.localeCompare(i,void 0,{sensitivity:"base"})===0||pd(r.normalize(),i.normalize())===0}function jw(t){return Lu(t,Ve)}function dd(t){return t.sort(pd)}function Hw(t,e){return F(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:f(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>{let o=pd(r.cmp[0],i.cmp[0]);return o!==0?o:Nt(r.cmp[1],i.cmp[1])}).map(r=>r.item)}function Ww(t,e){return t==null||e==null||e.length===0||t.length===0?!1:Ve(t.substring(0,e.length),e)}function Gw(t,e){if(L(t)||v(e))return;for(let i of t)if(Ve(i,e))return{index:0,match:i};for(let i of t){let o=e.indexOf(i);if(o>=0)return{index:o,match:i}}let r=e.normalize();for(let i of t){{let n=r.indexOf(i);if(n>=0)return{index:n,match:i}}let o=i.normalize();{let n=r.indexOf(o);if(n>=0)return{index:n,match:o}}{let n=r.toLocaleLowerCase(),s=o.toLocaleLowerCase(),a=n.indexOf(s);if(a>=0)return{index:a,match:s}}}}function Ht(t,e){return L(t)||v(e)?!1:t.some(r=>Ve(e,r))}function ji(t){return h(t).replace(/\u001b\[[0-9;]+[a-z]/gi,"")}var BI=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function hd(t){return BI.reduce((e,[r,i])=>e.replace(r,i),t).normalize()}var CI=/^(['"]).+\1$/;function gd(t){return v(t)||(t=h(t).trim(),CI.exec(hd(t))!=null&&(t=t.slice(1,-1).trim())),t}function Kw(t){return t.split(/(?<=[\\/_,:=-]+)/).map(e=>NI.escape(e.normalize())).join("<wbr>")}function yd(t){return h(t).normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function Jw(t){return h(t).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")}function $w(t){let e=dd(_(t)),r=e.filter((i,o)=>!Ww(e[o+1],i));return X(r,i=>t.indexOf(i))}function Qw(...t){return t.find(C)}function bd(...t){for(let e of Y(t)){let r=ii(e);if(r!=null&&r!==0)return r}}function Yo(t,e){return ea(t,r=>r>=0?e(r):void 0)}function la(t,e){return Vi(t,r=>r>=0?e(r):void 0)}function pe(t,e){return ea(t,r=>r>0?e(r):void 0)}function Xn(t,e,r){return T(pe(t,e),r)}function St(t,e,r){return r==null||!se(r)?!1:([t,e]=[Math.min(t,e),Math.max(t,e)],Pr(r,t)&&fo(r,e))}var VI=/[+-]?[0-9\,\.]+/;function Xo(t){if(se(t))return t;if(v(t))return;let e=String(t);return f(VI.exec(e),r=>ii(e.substr(r.index)))}function Ju(t){return G(Xo(t))}function Yw(t){if(se(t))return t;let e=h(t);if(e.includes("/")){let r=e.split("/",2);return Ho(Ju(r[0]),Ju(r[1]),(i,o)=>i/o)}else return Xo(e)}function Xw(t,e){if(t===e)return 1;if(t.length!==e.length)throw new Error(`hammRatioBinaryString(${t}, ${e}): invalid lengths`);let r=0;for(let i=0;i<t.length;i++)t[i]===e[i]&&r++;return te(0,1,2*r/t.length-1)}var gr=class{constructor(e=20){this.maxSamples=e;this._n=0,this._samples=new kl(e)}static merge(e,r){if(e.n===0&&r.n===0)return new gr(Math.max(e.maxSamples,r.maxSamples));if(e.n===0)return r.clone();if(r.n===0)return e.clone();if(e.n<=e.maxSamples){let i=r.clone();return i.pushAll(e.samples),i}else if(r.n<=r.maxSamples){let i=e.clone();return i.pushAll(r.samples),i}else{let i=new gr(Math.max(e.maxSamples,r.maxSamples));i._n=e.n+r.n,i._avg=e._avg*e.n/i.n+r._avg*r.n/i.n,i._min=Math.min(e._min,r._min),i._max=Math.max(e._max,r._max),i._m=e._m*e.n/i.n+r._m*r.n/i.n,i._s=e._s*e.n/i.n+r._s*r.n/i.n;let o=Y(Qn(e.samples,r.samples));return i._samples.push(...o),i._weightedTotalAvg=_l([i._avg,...o]),i}}[Zw.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=this._min==null?e:Math.min(e,this._min),this._max=this._max==null?e:Math.max(e,this._max),this._n===1||this._m==null||this._s==null||this._avg==null||this._weightedTotalAvg==null)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{let r=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-r)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return Lt(new gr(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){return e.forEach(r=>this.push(r)),this}stats(e=2){let r=o=>f(o,n=>Ie(n,e)),i={};return this.empty||(i.sum=r(this.sum),i.mean=r(this.avg),i.sd=r(this.stdDev)),i.k=Ie(this.n,e),i}get empty(){return this._n===0}get n(){return this._n}get avg(){return this.empty?void 0:Ie(this._avg,4)}get sum(){return this._avg==null||this.empty?0:this._avg*this._n}get max(){return this._max}get min(){return this._min}get p84(){return pe(this.avg,e=>pe(this.stdDev,r=>e+r))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return f(this.variance,Math.sqrt)}get sampleMode(){return f(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;let r=new Zn;return this._samples.forEach(i=>r.incr(i)),r.topKeys(e)}get sampleStdDev(){return ge(this._samples,tx)}get sampleAvg(){return ge(this._samples,It)}get sampleSlope(){return T(ge(this._samples,ex),0)}get samples(){return[...this._samples]}p(e){if(this._samples.length===0)return 0;let r=[...this._samples].sort((o,n)=>o-n),i=Math.floor(r.length*(e/100));return r[i]}get weightedSampleAvg(){return ge(this._samples,e=>Ie(_l(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}};var Zn=class{constructor(){this.m=new Map}incr(e,r=1){let i=this.get(e)+r;return i===0?this.m.delete(e):this.m.set(e,i),this}get(e){return T(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){let e=new gr(0);for(let r of this.keys())if(se(r))e.push(r);else return;return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){let e=this.keyAvg();return X([...this.entries()],([r,i])=>[-i,nd(e,o=>Math.abs(r-o),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(r=>r[0])}get averageCounts(){return Lt(new gr(this.size),e=>[...this.m.values()].forEach(r=>e.push(r)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return cr([...this.keys()]).map(e=>e+" "+this.get(e)).join(`
`)}};function rx(t){return t instanceof Set?t:new Set(F(t))}function $u(t,e){return new Set([...t,...e])}function wd(t,e){let r=rx(e);return new Set([...t].filter(i=>r.has(i)))}function ix(t,e){let r=rx(e);return new Set([...t].filter(i=>!r.has(i)))}function Qu(t){let e;for(let r of t)r!=null&&(e==null||r<e)&&(e=r);return e}function ox(t){let e;for(let r of t)r!=null&&(e==null||r>e)&&(e=r);return e}function xd(t,e){let r=new Zn;return F(t).forEach(i=>Al(i,o=>r.incr(o))),r.topKeys(e)}function Td(t){return xd(t,1)[0]}function Zo(t){return F(t).reduce((e,r)=>se(r)?e+r:e,0)}function It(t){let e=D(F(t));return L(e)?void 0:e.reduce((r,i,o)=>o===0?i:r*o/(o+1)+i/(o+1),0)}function ex(t){let e=F(t);return f(It(e),r=>{let i=(e.length-1)/2,o=Zo(e.map((s,a)=>(s-r)*(a-i))),n=Zo(e.map(s=>(s-r)**2));return n===0?0:o/n})}function zI(t){return f(It(t),e=>It(t.map(r=>Math.pow(r-e,2))))}function tx(t){return f(zI(t),e=>Math.sqrt(e))}function _l(t){let e;for(let r of t)e=e==null?r:(e+r)/2;return e??NaN}function vd(t,e){let r=0;return t.reduce((i,o,n)=>{let s=Xn(e[n],a=>a,1);return r+=s,i+o*s},0)/r}var en=class{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return Zo([...this.store.values()].map(e=>e.length))}add(e,...r){let i=Sr(this.store,e,()=>[]);return i.push(...r),i}set(e,r){this.store.set(e,r)}delete(e,r){if(r==null)return this.store.delete(e);{let i=this.store.get(e);if(i==null)return!1;{let o=Aw(i,r);return o&&i.length===0&&this.store.delete(e),o}}}clear(){return this.store.clear(),this}keys(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield i)}return r()}values(){let e=this;function*r(){for(let[,i]of e.store.entries())i.length>0&&(yield i)}return r()}flatValues(){let e=this;function*r(){for(let[,i]of e.store.entries())if(i.length>0)for(let o of i)yield o}return r()}entriesArray(){return[...this.store.entries()].filter(([,e])=>k(e))}entries(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield[i,o])}return r()}tuples(){let e=this;function*r(){for(let[i,o]of e.store.entries())for(let n of F(o))n!=null&&(yield[i,n])}return r()}filterInPlace(e){let r=!1;for(let[i,o]of this.store.entries()){let n=o.length;et(o,s=>e(i,s)),r=r||n!==o.length}return r}};function Md(t,e){let r=new en;return t.forEach(i=>f(e(i),o=>r.add(o,i))),r}function Pi(...t){for(let e of t){let r=e();if(r!=null)return r}}function nx(t,e){for(let r of t){let i=r();if(i!=null&&(e==null||e(i)))return i}}function pt(t,e){try{return t()}catch(r){return e!=null?e(r):void 0}}function Ar(t){return t}function ma(t,e){if(e==null)return t;for(let[r,i]of tt(e))i!=null&&(t[r]=i);return t}function Yu(t,e){let r={};for(let i of yt(t)){let o=e(i,t[i]);o!=null&&(r[i]=o)}return r}function sx(t,e){return t==null?!1:yt(t).every(r=>nt(t[r],e[r]))}function To(t,e){if(e==null||t==null||v(e))return t;if(Array.isArray(t))return D(t.map(a=>To(a,e)));let r=e.indexOf("."),i=r<0?e:e.slice(0,r),o=r<0?void 0:e.slice(r+1),n=yt(t);if(n.includes(i))return To(t[i],o);let s=n.find(a=>Ve(a,i));if(s!=null)return To(t[s],o)}async function ax(t){let e=await t;return Ee(e)?e():e}function wt(t){return lx(t,!0)}function or(t){return lx(t,!1)}function lx(t,e){return new Promise(r=>{if(t<=0)r();else{let i=setTimeout(()=>r(),Math.ceil(t+.5));e&&i.unref!=null&&Ee(i.unref)&&i.unref()}})}function U(t,e=1){return setTimeout(t,Math.max(1,Math.ceil(e)))}async function Oe(t,e,r=()=>{},i=()=>{}){let o=!1,n=!1,s;return await Promise.race([ax(t).then(a=>{if(!n)return s=a,o=!0,a}),wt(e).then(()=>{o||(n=!0)})]),o?await i(s):await r(),s}var Xu=P(require("timers"));function ua(t,e,...r){return Lt((0,Xu.setTimeout)(t,Math.round(e),...r),i=>i.unref())}function Vr(t,e,...r){return Lt((0,Xu.setInterval)(t,Math.round(e),...r),i=>i.unref())}var es=l(()=>d(Bu("Endable"))),Zu=new en;Vr(()=>mx(),1*A);var UI=5*S,me=Ae("first","service","predb","db","postdb","logger");function Sd(t){return ts(me.first,t)}function ux(t){return ts(me.db,t)}function cx(t){return ts(me.logger,t)}function ts(t,e){return me.validOrElse(t,()=>{throw new Error("internal error: invalid rank "+t)}),Zu.add(t,e),e}var fx=!1;function $(){return fx}async function Ei(t,e){let r=await t;if(r==null||r.ended)return;let i=Pe&&bo("SINGLE_SPEC_TESTS")?100:Qw(e,r.endTimeoutMs,UI);return es().debug(r.name+" ending...",{timeoutMs:i}),Oe(r.end(),i,()=>es().warn(r.name+".end() timed out"),()=>es().debug(r.name+".end() completed")).catch(o=>{pt(()=>es().warn(r.name+".end() rejected: "+o))})}function mx(){Zu.filterInPlace((t,e)=>!e.ended),es().debug("vacuumEndables()",Zu.entriesArray().map(([t,e])=>[t,e.map(r=>r.name)]))}var px=l(async()=>{let t=Gn()?250:void 0;es().info("endEndables()",{isTest:Pe,isSingleSpecTests:Gn}),Pe||(fx=!0),mx();for(let e of me.values){let r=T(Zu.get(e),[]);k(r)&&(es().debug("endEndables(): ending "+e),await Promise.all(r.map(i=>Ei(i,t))))}});var Gv=P(require("os")),ka=P(require("path"));var WI=Ae("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),Pd=WI.values,d3=Ae("s480","s240","s120","s60"),dx=[60,120,240,480];var Ed=l(()=>new Intl.NumberFormat),v3=l(()=>Ll(Ed().format(1111),"1","").charAt(0)),M3=l(()=>Ll(Ed().format(1.1),"1","").charAt(0));function Ad(t){return Ed().format(t)}var Dd=1e3,Ke=Dd*1e3,vo=Ke*1e3,S3=vo*1e3,Fd=1024,Hi=Fd*1024,Ld=Hi*1024,P3=Ld*1024,qI=["B","KB","MB","GB","TB","PB"];function rs(t,e=3){if(t===0)return"0";if(!se(t))return"-";let r=Math.floor(Math.log10(t)),i=Math.floor(r/3),o=Math.pow(10,i*3),n=qI[i];return Ie(t/o,e)+" "+n}var jI=1e6;function ec(t){return Ie(t/jI,2)}var E3=Ae("tiny","small","medium","large","original");function hx(t){return t<320*240?"tiny":t<720*480?"small":t<1920*1080?"medium":"large"}function tc(t,e,r=e+"s"){return Ad(t)+" "+(t===1?e:r)}var Ta=P(require("fs")),Wl=P(require("fs-extra")),$t=P(require("path")),Jx=P(require("zlib"));async function b(t,e){let r=await t;return r==null?void 0:e(r)}async function ye(t,e){let r=[];for(let i of F(await t))if(i!=null){let o=await i;if(o!=null){let n=await e(o);n!=null&&r.push(n)}}return r}async function gx(t,e=console.dir.bind(console)){let r=await t;return await e(r),r}var Bt=class{constructor(e){this.id=e;this._state="pending";this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i})}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve(),r=>this.reject(r)),this}observeQuietly(e){return e.then(()=>this.resolve(),()=>this.resolve()),this}get pending(){return this._state==="pending"}get settled(){return!this.pending}get resolved(){return this._state==="resolved"}get rejected(){return this._state==="rejected"}get state(){return this._state}then(e,r){return this.promise.then(e,r)}};var pa=P(require("os"));var bx=P(require("events"));var yx=P(require("events")),Id=class extends yx.EventEmitter{constructor(){super(...arguments);this.events=[]}emit(e,...r){return super.emit(e,...r),this.events.push({name:e,args:r}),!0}clear(){this.events.length=0}};var _3=l(()=>new Id),HI=l(()=>{let t=new bx.EventEmitter;return t.setMaxListeners(50),t}),ve=HI();function Od(){d("EventEmitter").info("emitClearCache()"),ve.emit("clearCache")}function H(t){ve.on("clearCache",t)}function wx(t){ve.on("idle",t)}function xx(t){ve.emit("migration",t)}function Tx(){ve.emit("pause")}function rc(t){ve.on("pause",t)}function vx(){ve.emit("resume")}function ca(t){ve.on("resume",t)}function zr(t){ve.emit("fileChanged",t)}function fa(t){ve.on("fileCopied",t)}function kd(t,e){ve.emit("fileCopied",t,e)}function nr(t){ve.on("fileChanged",t)}function Mx(t){ve.on("fatal",({message:e,error:r})=>t(e,r))}function ic(t){ve.on("nonFatal",({message:e,error:r})=>t(e,r))}function Sx(t){ve.on("rpcServerChange",t)}function Px(){ve.emit("volumesChanged")}function Ex(t){ve.on("volumesChanged",t)}function Ax(){ve.emit("settingsChanged")}function Dx(t){ve.on("settingsChanged",t)}function Fx(t){ve.on("vacuuming",t)}function Lx(t){ve.on("writeRecentLogEntries",t)}U(()=>{H(()=>{Rd.unset(),_d.unset(),xt.unset(),Ix.unset(),Nd.unset(),Bd.unset(),GI.unset()})});var Rd=l(()=>((0,pa.freemem)()*2+(0,pa.totalmem)())/3),_d=l(()=>(0,pa.cpus)().length),xt=l(()=>{let t=1*vo,e=Math.max(1,Math.floor(Rd()/t)),r=u.cpuLoadPercent.valueOrDefault/100*_d();return te(1,e,Math.floor(r))}),Ix=l(()=>{let t=500*Ke,e=Math.floor(Rd()/t),r=Math.max(1,Math.floor(1.5*_d()*(u.cpuLoadPercent.valueOrDefault/100)));return te(1,r,e)}),Nd=l(()=>te(1,24,xt())),Bd=l(()=>te(1,6,Math.ceil(Ix()/Nd()))),GI=Nd;var zd=P(require("timers")),_x=P(require("util"));function ae(t){if(Xs(t))return"";let e=t instanceof Error?V(Go([h(t.name).trim(),q(t.code,r=>`code ${r.trim()}`),h(t.message).trim()])).join(": "):h(t);return ir(e,255)}function Ot(t){return t==null?"(undefined)":[ae(t),...F(Cd(t.stack))].join(`
`)}function Cd(t){return v(t)?void 0:h(t).split(`
`).slice(0,6)}function oc(t){if(v(t))throw new Error("undefined error");if(t instanceof Error)return t;if(Array.isArray(t)){let e=t[0];return e instanceof Error?(t.length>1&&(e.errors=t.slice(1)),e):new Error(t.map(r=>h(r)).filter(M).join(", "))}else{let e=ae(t),r=e.indexOf(":");if(r>2&&r<15){let i=new Error(e.slice(r+1).trim());return i.name=e.slice(0,r).trim(),i}else return new Error(e)}}function nc(t){return t instanceof Error}var Mo=Ae("pending","resolved","rejected");var de="\xB9",kt="\xB2",Nl="\xB3",So="\u2074",da="\u2075",yr="\u2076",ha="\u2077",KI=[de,kt,Nl,So,da,yr,ha];function sc(t,...e){return t+e.filter(r=>r!=null&&!t.includes(r)).join("")}var JI=/[â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g;function ac(t){return t.replace(JI,"")}function Ox(t){return t.split("").filter(e=>KI.includes(e)).join("")}function lc(t){return ae(t).includes(So)}var $I=[Nl,"0 output files created","BatchCluster has ended, cannot enqueue","called while not idle","Can't set headers after they are sent","debugger attached","debugger listening on","diskutil: interrupted","ECONNRESET","end() called before task completed","EPIPE","for help","Format error in file","https://nodejs.org/en/docs/inspector","Invalid data found when processing input","Missing expected status message","net::ERR_","onExit(exit) called end()","This socket has been ended by the other party","Unexpected error while trimming","Warning"].map(t=>t.toLowerCase());function Gt(t){if(t==null)return!0;let e=ae(t).toLowerCase(),r=$I.some(i=>e.includes(i));return $()||!lc(t)&&!Gi(t)&&r}var QI=/SQLITE_BUSY|database is locked/i;function Bl(t){return t.code==="SQLITE_BUSY"||ae(t).match(QI)!=null}function kx(t){return ae(t).match(/database .+ not open/i)!=null}function YI(t){return ae(t).match(/SQLITE_CONSTRAINT|constraint failed/i)!=null}function Vd(t){return!Gi(t)&&!ae(t).includes(kt)&&!YI(t)&&!oi(t.retriable)}function Rx(t){return!Vd(t)}function mc(t){if(lc(t))return!1;if(I(t?.doNotSend))return!0;let e=ae(t).toLowerCase();return XI.some(r=>e.includes(r))||Gt(e)}var XI=[yr,"Corrupt JPEG data","premature end of data segment","VipsJpeg"],ZI=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+de,"i");function Gi(t){return t==null?!1:I(t.fatal)?!0:ZI.exec(ae(t))!=null}var Kt=class{constructor(e){this.name=e;this.start=Date.now();this.state=Mo.pending;this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i}),this.logger=d("Deferred("+this.toString()+")")}toString(){return ct(this.name)?this.name:O(this.name)}[_x.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(r=>{this.resolve(r)}).catch(r=>{this.logger.warn("observeQuietly.reject()",r),this.resolve(void 0)}),this}observe(e){return e.then(r=>{this.maybeResolve(r)}).catch(r=>{this.maybeReject(r)}),this}setTimeout(e){return f(this.priorTimeout,zd.clearTimeout),this.priorTimeout=ua(()=>{if(this.pending){let r="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(r)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===Mo.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==Mo.pending}get resolved(){return this.state===Mo.resolved}get rejected(){return this.state===Mo.rejected}get settledMs(){return this.end==null?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=Mo.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(Gt(e)?"info":"warn",".reject()",e);let r=oc(e);return this.settle(()=>{this._error=r,this.state=Mo.rejected,this._reject(r)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(r=>e(r))}settle(e){if(this.state===Mo.pending){f(this.priorTimeout,zd.clearTimeout),e(),this.end=Date.now();let r=this.settledMs;if(this.resolved&&r>5e3){let i=r>5e3?"info":"debug";this.logger.log(i,"Completed in "+r+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}};var Jt=class{constructor(){this._pushCount=0;this.lastPushTs=0;this._arr=[];this.nextSettledLatches=[];this.serialLatencyAvg=new gr;this.applyListeners=[]}get arr(){return et(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}onApply(e){this.applyListeners.push(e)}_emitApply(e){for(let r of this.applyListeners)r(e)}push(e,r){return this._emitApply(e),this._push(e,r)}_push(e,r){this._pushCount++,this.lastPushTs=Date.now();let i=Ee(r)?r():r;return this.arr.push(new Kt(e).observeQuietly(i).finally(()=>this.emitSettled())),i}emitSettled(){for(let e of this.nextSettledLatches)e.resolve();this.nextSettledLatches.length=0}awaitNextSettled(){let e=new Bt;return this.nextSettledLatches.push(e),e}serial(e,r){let i=Date.now();return this._push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}serialByName(e,r){let i=Date.now();return this._push(e,this.awaitAllByName(e).then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}oneRunAtATime(e,r){return this.pending?this.awaitAll():this.serial(e,r)}maybeRun(e,r){return this.maybeRunConcurrent(e,r,1)}maybeRunConcurrent(e,r,i=xt()){return this.pendingCount>=i?void 0:this.push(e,r)}get pendingCount(){return fr(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return this.arr.length===0}async awaitAll(){for(let e of[...this.arr])await e.promise}async awaitAllByName(e){for(let r of[...this.arr])r.name===e&&await r.promise}async pushAll({name:e,laters:r,maxConcurrent:i=xt()}){i=te(1,xt()*2,i);let o=[];for(let n of r){for(;this.pendingCount>=i;)await this.awaitNextSettled();o.push(this.push(e,n))}return Promise.all(o)}};async function Dr({name:t,laters:e,maxConcurrent:r}){return new Jt().pushAll({name:t,laters:e,maxConcurrent:r})}async function Nx(t,e,r){let i=[];for(let o of aa(F(await t),e)){let n=[];for(let s of o)if(s!=null){let a=await s;a!=null&&n.push(a)}for(let s of F(await r(n)))s!=null&&i.push(s)}return i}function Bx(t,e){return Promise.race([t.then(()=>!0),wt(e).then(()=>!1)]).catch(()=>!1)}async function uc(t){try{return await t,!0}catch(e){return!1}}async function Cx(t){return await t!=null}async function cc(t){let e=D(t);k(e)&&await Promise.all(e)}async function Cl(t){let e=[];for(let r of F(await t)){let i=await r;if(i!=null)if(Array.isArray(i))for(let o of i){let n=await o;n!=null&&e.push(n)}else e.push(i)}return e}async function is(t){let e=D(await t);return L(e)?[]:D(await Promise.all(e))}async function os(t,e,r){if(t==null)return[];let i=D(await t);return L(i)?[]:(await Dr({name:"thenCollectParallel",laters:i.map((n,s)=>async()=>[await e(n,s),n]),maxConcurrent:r})).filter(([n,s])=>n!=null&&s!=null)}async function sr(t,e,r){return(await os(t,e,r)).map(i=>i[0])}async function tn(t,e,r){return(await os(D(t),e,r)).filter(([o])=>o).map(([,o])=>o)}async function Ud(t,e){let r=await os(t,e);return[r.filter(([i])=>I(i)).map(([,i])=>i),r.filter(([i])=>oi(i)).map(([,i])=>i)]}var _5=30*S;async function Pt(t,e=!0){if(t==null)return e;let r=await t;return r==null?e:!I(r)}async function be(t,e,r){let i=await t;if(i==null)return r();let o=await e(i);return o??r()}async function ga(t,e,r,i){let o=await t;if(o==null)return i();let n=await e;if(n==null)return i();let s=await r(o,n);return s??i()}async function ze(t,e){return T(await t,e)}async function Vx(t,e=Ar){for(let r of t){let i=await r();if(i!=null){let o=await e(i);if(o!=null)return o}}}async function zx(t,e){for(let r of t)try{let i=await r();if(i!=null)return i}catch(i){e(i)}}async function Vl(t,e){return X(await os(t,e),r=>r[0]).map(r=>r[1])}var Ux=P(require("fs")),zl=P(require("os")),Po=P(require("process"));var Ul=(0,zl.platform)(),q5=Po.default.argv.includes("--inspect")||I(Po.default.env.NODE_INSPECT),ns=!h(__filename).includes("Platform"),B=Ul==="win32"||Ul==="cygwin",Wx=B&&M(Po.default.env.PORTABLE_EXECUTABLE_DIR),he=Ul==="darwin",dt=Ul==="linux",j5=dt&&(0,zl.arch)()==="x64",Wd=(0,zl.arch)()==="arm",eO=dt&&Wd,H5=dt&&(M(Po.default.env.APPIMAGE)||M(Po.default.env.APPDIR)),G5=dt&&M(Po.default.env.SNAP_USER_DATA),ya=he||dt,tO="PS_IS_ELECTRON",rO="PS_IS_DOCKER",ni=Po.default.versions.electron!=null||I(Po.default.env[tO]);function Ue(){return dt&&(bo(rO)||bo("PS_DOCKER"))}var K5=l(()=>eO&&h(iO()).startsWith("Raspberry Pi")),iO=l(()=>{try{return dt?f((0,Ux.readFileSync)("/proc/device-tree/model"),h):void 0}catch{return}}),qx=B?"win":he?"mac":dt?"linux":Ul;var br=15*S,ss=5*A,J=35*S,Fr=7*S,jx=1*Ft,fc=S/(2*Hi);var ba=25*S;var wa=P(require("stream")),Hx=P(require("util"));async function Ki(t){t!=null&&(pt(()=>zu(t,"unref")),$()?t.end(null):await new Promise(e=>t.end(null,e)),await wt(50),pt(()=>zu(t,"destroy")))}async function Gx(t){t!=null&&(pt(()=>zu(t,"unref")),$()?t.close(ed):await new Promise(e=>t.close(e)))}function Kx(t){for(let e of[t?.stdin,t?.stdout,t?.stderr])try{e?.destroy()}catch{}}var as=(0,Hx.promisify)(wa.pipeline);function xa(t){return t.destroyed?"destroyed":`${t.remoteFamily}:${t.remoteAddress}:${t.remotePort}`}var qd=class extends wa.Transform{constructor(e){super({transform:(r,i,o)=>{this.onProgress(this.bytes+=r.length),o(r)}});this.onProgress=e;this.bytes=0}};var ql=$t.default.posix;function oO(t,e){if(v(t)||$t.default.sep===ql.sep)return t;let r=M(e)?$t.default.sep+$t.default.sep+e+$t.default.sep:"",i=t.split(ql.sep);return Ve(i[0],e)&&i.unshift(),r+i.join($t.default.sep)}function si(t){return v(t)||$t.default.sep===ql.sep||ql.sep===$t.default.sep?t:t.split($t.default.sep).join(ql.sep)}var $x=/^([A-Z]:)[\\/]?(.*)$/i;function nO(t){let e=$x.exec(t);return e!=null?e[1].toUpperCase()+"\\"+e[2]:t}function ai(...t){let e=$t.default.join(...t);return $t.default.resolve(B?nO(e):e)}function Qx(t){return Ai(oO(t))}function Yx(t){return Ai(t).ext}var sO=/(\.(?:gz|z|7z|xz|bz2))$/i;function Ai(t){let e=Si(t,sO),r=$t.default.parse(T(e?.uncaptured,t));return y(y({},r),e==null?{}:{ext:r.ext+e.captured,base:r.base+e.captured})}function va(t,e){return M(t)&&M(e)&&(t===e||t.startsWith(Wt(e,$t.default.sep)))}function rn(t){return st(t,$t.default.sep).split($t.default.sep)}function pc(t,e){return t.nativePath===e.nativePath?"":st(si(e.nativePath),Wt(si(t.nativePath),"/"))}var Xx=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function Ur(t){return ee(h(t).match(Xx),e=>e[1],()=>t).toLowerCase().normalize()}function Zx(t){return f(h(t).match(Xx),e=>Ge([e[2],e[3]],G))}function Ma(t){if(v(t))return!1;try{return Ta.default.statSync(t).isDirectory()}catch{return!1}}async function jl(t){if(!v(t))try{return await Oe(Wl.default.stat(t),br)}catch{return}}async function eT(t){return be(jl(t),e=>e.isDirectory(),()=>!1)}async function tT(t){if(v(t))return!1;try{return await jl(t)!=null}catch{return!1}}async function Sa(t,e=ba){if(v(t))return!1;try{let r=await Oe(jl(t),e);return r==null||!r.isDirectory()?!1:await Bx(Wl.default.access(t,Ta.default.constants.R_OK|(B?0:Ta.default.constants.X_OK)),e)}catch{return!1}}function jd(t){return t.startsWith("\\\\")}function rT(t){return ya&&t.startsWith("/")||B&&(jd(t)||t.match($x)!=null)}var aO=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});function iT(t){return t==null||t.isFile()&&t.size===0}async function dc(t){let e=y(y({},aO),t),r=Ai(e.nativePath);await Wl.default.mkdirp(r.dir);{let i=await jl(e.nativePath);if(!e.requireNumber&&(i==null||e.emptyIsNew&&iT(i)))return e.nativePath}for(let i=e.startIndex;i<=e.maxVersions;i++){let o=$t.default.join(r.dir,`${r.name}-${dr(i,e.leftPad,"0")}${r.ext}`),n=await jl(o);if(n==null||e.emptyIsNew&&iT(n))return o}throw new Error("There are already more than "+e.maxVersions+" of "+e.nativePath)}async function oT(t){if(t.endsWith(".gz"))return t;let e=t+".gz";return await as([Ta.default.createReadStream(t),(0,Jx.createGzip)(),Ta.default.createWriteStream(e)]),await Wl.default.unlink(t),e}var nT=P(require("os")),sT=P(require("path"));var Di=l(()=>{let t=[];B?t.push(qe("USERPROFILE")):t.push(qe("HOME"));for(let e of _(t)){let r=(0,sT.resolve)(e);if(Ma(r))return r}return(0,nT.homedir)()});function Hd(){if(Ue()&&Ma("/ps/cache"))return"/ps/cache";if(B){for(let t of _([qe("TEMP"),qe("LOCALAPPDATA")]))if(Ma(t))return ai(t,vi())}if(he){let t=ai(Di(),"Library","Caches");if(Ma(t))return ai(t,vi())}return ai(Di(),".cache",vi().toLowerCase())}var Gd=P(require("path"));var aT=P(require("fs")),lT=P(require("fs-extra")),hc=P(require("path")),mT=P(require("process"));var Pa=l(()=>{let t=[mT.env.PS_CONFIG_DIR,Ue()?"/ps/config":void 0];B&&(t.push(qe("APPDATA")),t.push((0,hc.resolve)(Di(),"AppData","Roaming"))),he&&t.push((0,hc.resolve)(Di(),"Library","Application Support")),!he&&ya&&t.push(qe("XDG_DATA_HOME"),qe("XDG_CONFIG_HOME"),(0,hc.resolve)(Di(),".config"));let e=_(t);for(let r of e)try{if((0,aT.statSync)(r).isDirectory())return r}catch{}for(let r of e)try{return(0,lT.mkdirpSync)(r),r}catch{console.error("Failed to mkdirp "+r)}throw new Error("Cannot determine appData"+de)});function uT(){return Ue()?"/ps/logs":he?(0,Gd.resolve)(Di(),"Library","Logs",Kn.toLowerCase()):lO()}function lO(){return(0,Gd.resolve)(Pa(),Kn.toLowerCase(),"logs")}var Tt="1.0.0-alpha.1",cT="1.0.0-alpha.1+20210314162034";var Kd=new Date(1615764034e3);var mO=()=>Tt.includes("-alpha"),uO=()=>Tt.includes("-beta"),fT=()=>mO()?"alpha":uO()?"beta":"latest";var Vv=P(require("path"));var Vc=P(require("batch-cluster"));async function gc(t,{timeoutMs:e,timeBetweenMs:r,acceptable:i,timeoutResult:o,unref:n}){let s=e==null?void 0:e+Date.now();for(;s==null||Date.now()<s;){let a=Date.now(),m=await t();if(m==null||(Ee(i)?!i(m):m===!1)){let c=Date.now()-a,p=T(r,()=>te(100,5e3,c*Ut(4,10)));await(oi(n)?or(p):wt(p))}else return m}return o}async function Je(t,e){return gc(t,y(y({},e),{acceptable:r=>I(r),timeoutResult:!1}))}var Ov=P(require("process"));var $e=class{constructor(e,r,i,o,n){this.name=e;this._isEnded=o;this.endTimeoutMs=n;this.onEnds=[];this._ended=!1;this.logger=d(e),this.onEnds.push(r),ts(i,this)}get ended(){return ee(this._isEnded,e=>e(),()=>!1)||this._ended}end(){if(!this._ended)return this._ended=!0,cc(this.onEnds.map(e=>e()))}};var wh=P(require("child_process")),xh=P(require("process"));async function Ea(t,e){let r;return Promise.race([t().then(i=>{if(r==null)return r=!0,i}),wt(e).then(()=>{if(r==null)throw r=!1,new Error("timeout")})])}function li(t,e){let r=C(e.timeoutMs)?()=>Ea(t,e.timeoutMs):t;if(e.maxRetries<=0)return r();let i=W(e.onRetryWaitUntil).getOrElse(()=>s=>wt((e.retryDelay??250)*T(s,1))),o=0,n=async()=>{try{return await r()}catch(s){if(await e.errorIsRetriable?.(s)===!1||o>e.maxRetries)throw s;return o++,await i(o),n()}};return n()}var pT=P(require("util"));var Jd=class{constructor(e,r){this.ttlMs=e;this.maxLength=r;this.times=[];this.a=[]}[Symbol.iterator](){this.vacuum();let e=[...this.a];function*r(){for(let i of e)yield i}return r()}push(...e){xe(e.length,()=>this.times.push(Date.now())),this.a.push(...e),this.maxLength!=null&&this.vacuum()}pushUniq(...e){e.forEach(r=>{this.includes(r)||this.push(r)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(this.a.length===0)return;if(this.maxLength!=null){let i=this.a.length-this.maxLength;this.times.splice(0,i),this.a.splice(0,i)}let e=Date.now()-this.ttlMs,r=this.times.findIndex(i=>i>e);r===-1?this.clear():r>0&&(this.times.splice(0,r),this.a.splice(0,r))}};var on=class{constructor(e){this.ttlMs=e;this._eventCount=0;this._lastEventTime=0;if(e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new Jd(e)}[pT.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){let e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return pe(this.eventDeltas.length,()=>_l(this.eventDeltas))}get msPerEvent(){return It(this.eventDeltas)}get eventsPerMs(){return la(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return la(this.eventsPerMs,e=>Ie(S*e,3))}get eventsPerMinute(){return la(this.eventsPerMs,e=>Ie(A*e,3))}};function dT(t){let e=hr(h(t).trim().toUpperCase(),":");return ee(cO[e],r=>r.description,()=>t)}var cO=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}});var fO=Date.now(),bc=l(()=>d("Error")),hT=new on(A),$d=new on(A);function gT(t,e){return e.exec(ae(t))!=null}function pO(){let t=Date.now()>fO+u.probationMs.valueOrDefault,e=Dl($d.eventsPerMinute,u.fatalErrorRatePerMinute.valueOrDefault);return bc().tap({level:"info",msg:"isFatalErrorAllowed()",result:Lr()&&t&&e,meta:{mainService:Lr(),postProbation:t,lowErrorRate:e,fatalErrorRatePerMin:$d.eventsPerMinute,errorRatePerMin:hT.eventsPerMinute,fatalErrorRatePerMinuteSetting:u.fatalErrorRatePerMinute.valueOrDefault}})}function wc(){let t={};return Error.captureStackTrace(t,wc),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)}var dO=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function hO(t){let e=ac(ji(t)),r=e;do r=e,e=dO.reduce((i,o)=>i.replace(o,""),e).trim();while(r!==e);return _(e.split(/\s+/).map(i=>{if(i.startsWith("E")){let o=dT(i);return e.toLowerCase().includes(o.toLowerCase())?"":o+":"}return i})).join(" ")}function ls(t,e=256){let r=ae(t),i=Ox(r);return ir(hO(r),e-i.length)+i}function yT(t,e){return h(t).split(/\r?\n/).map(r=>st(r,e)).map(r=>r.replace(/: ?/,"")).filter(M).join(", ")}function re(t,e,r){if(v(t)&&e==null){bc().warn("onError() with empty args",wc());return}let i=ae(t)+ae(e)+ae(r),o=Gi(e)||Gi(i)||I(r?.fatal);if(!o&&Gt(i)){bc().info("onError(): (ignorable): "+Ot(e),y({message:t},r));return}f(yc(),s=>s.writeRecentLogEntries()),hT.onEvent(),o&&$d.onEvent();let n=!o||pO()?"nonFatal":"fatal";bc().log(n==="fatal"?"error":"warn","onError(): "+Ot(e),y({event:n,message:t},T(r,{}))),$()||ve.emit(n,{message:t,error:e})}function bT(t,e){return t==null?new Error(e):(M(e)&&(t.message.toLowerCase().includes(e.toLowerCase())||(t.message+=": "+e)),t)}var hv=P(require("child_process")),tm=P(require("process"));var wT=P(require("util"));function Aa(t){return t==null?[]:Object.keys(t)}var ke=class{constructor(e,r){this.maxSize=e;this.clearEveryMs=r;this.setsSinceLastSpill=0;this.expireListeners=[];if(e<1)throw new Error("maxSize must be positive");if(e>3e4)throw new Error("maxSize is too big");this.clear(),C(r)&&(this.clearInterval=Vr(()=>{this.spill()},ut(r/2)))}spill(){if(this.priorCache!=null&&this.currentCache!=null&&k(this.expireListeners)){for(let e in this.priorCache)if(this.currentCache[e]==null){let r=this.priorCache[e];if(r!=null)for(let i of this.expireListeners)i(e,r)}}this.priorCache=this.currentCache??Object.create(null),this.currentCache=Object.create(null),this.setsSinceLastSpill=0}[wT.inspect.custom](){return y(y({},this.priorCache),this.currentCache)}end(){this.clearInterval!=null&&clearInterval(this.clearInterval)}clear(){return this.visit((e,r)=>{for(let i of this.expireListeners)i(e,r)}),this.currentCache=Object.create(null),this.priorCache=Object.create(null),this.setsSinceLastSpill=0,this}get size(){if(this.currentCache==null||this.priorCache==null)return 0;let e=0;for(let r of $u(Aa(this.priorCache),Aa(this.currentCache)))this.has(r)&&e++;return e}has(e){return this.currentCache[e]!=null||this.priorCache[e]!=null}keys(){return V([...Aa(this.priorCache),...Aa(this.currentCache)]).filter(e=>this.currentCache[e]!=null)}delete(e){let r=this.currentCache[e];if(r!=null){this.currentCache[e]=void 0;for(let o of this.expireListeners)o(e,r)}let i=this.priorCache[e];if(i!=null&&(this.priorCache[e]=void 0,r==null))for(let o of this.expireListeners)o(e,i)}visit(e){for(let r of $u(Aa(this.priorCache),Aa(this.currentCache))){let i=this.currentCache[r]??this.priorCache[r];i!=null&&e(r,i)}}deleteIf(e){for(let r of this.keys()){let i=T(this.currentCache[r],this.priorCache[r]);i!=null&&e(r,i)&&this.delete(r)}}get(e){return e=h(e),this.currentCache[e]??this.priorCache[e]}set(e,r){e=h(e),this.currentCache[e]==null&&(this.setsSinceLastSpill>=this.maxSize&&this.spill(),this.setsSinceLastSpill++),this.currentCache[e]=r}getOrSet(e,r){e=h(e);let i=this.get(e);if(i!=null)return i;let o=r();return this.set(e,o),o}on(e,r){this.expireListeners.push(r)}},Ji=class{constructor(e){this.opts=e;this.uid=0;this.cacheSyncHits=0;this.cacheAsyncHits=0;this.cacheMisses=0;this.timeouts=0;this.cache=new ke(e.maxSize,e.clearEveryMs)}get size(){return this.cache.size}stats(){return{size:this.size,cacheSyncHits:this.cacheSyncHits,cacheAsyncHits:this.cacheAsyncHits,cacheMisses:this.cacheMisses,timeouts:this.timeouts}}get(e){let r=this.cache.get(e);return r==null||r.__uid!=null?void 0:r}clear(){this.cache.clear(),this.cacheSyncHits=0,this.cacheAsyncHits=0,this.cacheMisses=0,this.timeouts=0}deleteIf(e){for(let r of this.cache.keys())e(r)&&this.cache.delete(r)}async getOrSetAsync(e,r,i=1){e=h(e);{let a=this.get(e);if(a!=null)return this.cacheSyncHits++,a}let o=this.uid++,n=Date.now(),s=this.cache.getOrSet(e,()=>({__uid:o,__start:n}));if(s.__uid===o)return this.cacheMisses++,Oe(r,this.opts.timeoutMs,()=>{this.timeouts++,this.cache.get(e)?.__uid===o&&this.cache.delete(e)},a=>{this.cache.set(e,a)});{let a=s.__start;if(a!=null){let c=a+this.opts.timeoutMs-Date.now();if(c>0){let p=gc(()=>this.get(e),{timeoutMs:c});if(p!=null)return this.cacheAsyncHits++,p}}return i>0?this.getOrSetAsync(e,r,i-1):void 0}}};var Ir=P(require("fs")),it=P(require("fs-extra")),cn=P(require("path")),YT=P(require("util")),ps=P(require("zlib"));async function Hl(t,e){return t==null||e==null?ee(t,D,()=>[]):tn(t,e)}async function xT(t,e){return t==null||e==null||await e(t)?t:void 0}var Qd=class{constructor(e,r){this.l=e;this.listener=r;this.ts=Date.now()}elapsed(e){let r=Date.now(),i=r-this.ts;this.ts=r,f(this.listener,o=>o(e,i)),i>2&&this.l.log(i>500?"warn":i>100?"info":"debug",e,{elapsedMs:i})}};async function mi(t){let e=Date.now(),r=await t();return{elapsedMs:Date.now()-e,result:r}}async function Da(t){let e=Date.now(),r=await t;return{elapsedMs:Date.now()-e,result:r}}var gO=15,Fa=class{constructor(){this.errors=new Zn;this.times=new Map}async time(e,r,i){let o=Date.now();try{let n=await r(),s=Date.now()-o;return i!=null&&i(n,s),this.push(e,s),s>2*S&&d("time("+e+")").warn("slow",{elapsed:s}),n}catch(n){throw this.errors.incr(e),i!=null&&i(n,Date.now()-o),n}}get entriesBySumDesc(){return X([...this.times.entries()],([,e])=>-e.sum)}stats(e){let r=this.entriesBySumDesc.filter(([n])=>n.startsWith(e)),i=r.reduce((n,s)=>gr.merge(s[1],n),new gr),o=r.map(([n,s])=>[n,s.stats()]);return ft([["merged",i.stats()],...o])}mkElapsed(e){return new Qd(e,(r,i)=>this.push(r,i))}push(e,r){r>gO&&Sr(this.times,e,()=>new gr).push(r)}weightedAvg(e){return W(this.times.get(e)).map(r=>r.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[r,i])=>y(y({},e),{[r]:i.n}),{})}weightedAvgs(){return Mi([...this.times.entries()].reduce((e,[r,i])=>y(y({},e),{[r]:Al(i.weightedSampleAvg,ut)}),{}))}report(){return this.entriesBySumDesc.reduce((e,[r,i])=>y(y({},e),{[r]:y({sumSec:Ie(i.sum/S,3)},qt(i.stats(),"sum"))}),{})}},TT=l(()=>Lt(new Fa,t=>new $e("PromiseTimer",()=>{let e=d("PromiseTimer");e.info(`timings:
`,t.report()),ge(t.errorCounts(),r=>e.warn(`error counts:
`,r))},me.service)));function vT(t){return TT().mkElapsed(d(t))}function Qe(t,e,r){return TT().time(t,e,r)}function Gl(t,e,r){return l(async()=>Qe(t,e),r)}var FT=P(require("crypto"));var Yd=P(require("zlib"));var MT="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function Xd(t){if(typeof t=="number"&&t<MT.length)return MT[t];let e=t.toString(16);return e.length%2==1&&(e="0"+e),Buffer.from(e,"hex").toString("base64")}function ST(t){return BigInt("0x0"+Buffer.from(t,"base64").toString("hex"))}function xc(t){return(0,Yd.gunzipSync)(Buffer.from(t,"base64")).toString("utf8")}var PT=l(()=>xc("H4sIAAAAAAAAA1WcgZarLM+Fb8ibQkWlInhA2rFX/+8nOPN+/1qnAa1jEUKydxLP0oZPGtxcB3ecg0t5cMXpo+OqflV7bYNrP4P7fofRxWEcP8M4bcPodRynYcx5GNuhT9HnHsZ7HyZXh2lSG69hOtTP6udDn6TPzzC1qI+O72mYdd3s4zCHn2E+dHxNg/dl8CUP/h2Hxa36JH3+Dct8DovfhyUs+qjd9dG9l+scVncNa9Anz/rEYb3PYdPxpv7WXsPLncMrrPp8h1dpw66/3RufQ5+izzXsHzdEjT3q2eJ5DVHjPJY8HKEOR16GpL9P4RxSHvWZhnQdQy7HcLqmzz2cGtOpa0+N6dTznpqbM5/6XMP5rwxnScPZZn2CPvfw71/Qpw3FjfrUoeT3UDTn5e2GOu9D9T9D3YI+11B176rfrf/iUO9luMZjuPR81+camubwPR/DR/f55FWfc/hoHT/VD59rGX5+foY7zMOd2/B1kz778PXr4FyaBxdKGNzLaYmPaUXsEru0IGm5dQU9TZpLTdqQvjo8T/XKgbLoF1wdda6iO5ce2jU05sPf3nxxFy/FKYvEVyoyV+mKv5zEZxzGgCqFVYfh0nXhR708SqXyhEjrMF5c0qK+bRy2S0rlJiexIgqHHynYJg2QeEtIB6atrQidC6eui5qrKXGY0cwcdS6bPp63hLR9KlKRqXHnlhLiGma3ZokjSUfp+SoNDahs2L1EUu8lTZgj5/JUJTxCI53zqUuK9E/iHOZ2jBIay/zWnM63buBnjcr/SCzOo+MFZa8b4ishPVgmKeniJ4SfpfYa38IIFmZtCZqXJejXlqCHWYIecIlSuyWlW3tDPyShS7JUcvVTkJByr/5wEkmH4dTesW+zNGbNWgWJNqwl12FtI0JbcXOvIKHRb67MEh8deqeeH72EHyViRLDv9JNbdkVCa7llT0/zsuWDLw7OFXpSPYldomqrXtrHW+OLj3ZT2D9+CIcWJSRtwhcDfwWpj7awellDe+WQhlfVk7/eWtDdjQhpzu7iKCG12FmoPWXtcBZ+z1rVnYXfWe6dRd5bDcPOekSv4UZ0MvJnMRy3xFu9rEeN3CAypxJNYqEn/YuZS5o2U2x6jsNJ+Q8XEJpnCZkPl7xE1aFviyyKbiWBbXkhos5lbcsj77dE1LmcHGKV0JQcuZrQrdqiixvfMvqjXXVITgNPPHlyxyHxDUPyMpXJaycn/9El/uca0iqlSVljSXX5DKlpoVLTuuWo+cuHliwXXSJxS1x50MLIWPFEp1u9xMtJ7JzTIE+vG0jQi/SSCX3rpSqnL+/h3KTAEv9kGqW7Jw99Bu7Ck59BfucMiUP+NpwmdIMgIy1jKmsaLq7Ttj/ZYGf2WFTN/Zk3bKzm+WRBz1wmBD2twlmCDotMgYTOXZsOm5T1bDtCz3s2bt+qLHe7OLz4Qr/27588zr8WDplljVSa4ofi/SVR6GlfliyjXt7atZVpr04qUCeZoOo1fxKrhGxi3eTAKrapYpskvth0hIxCxepVFL1G3b5G7d96yDTXQ3uhHhwmWZCKblR0rWY5qXrKildNJWJF6It/fpNo+rbwbeEnL0TTqlbsmoR+qGm1apNa1Dvpuq++veQJJKRXl1urhLTuYp9f3snNeL8gvhJ6tsufTUJTfPk2DtemObhYwSuPiBMhj3qVkCWaH65LT3k17vfRgNqY76FFPVY7NNLGZLcqG9HadA5vr4vfq4zRO4xFwpv4DO8sF/bGQL0vjfTDICX24eMv+T3m9MOcfsJL3wap6OfUrv2wyD9yZsMP8/yTtdI3f3a7HOQGx3v4Bm2Xbwzj8D00yG/W7375oS+T6MaxTZKYXyRnckM2vN+M7XPzEcBRbdGZ1Um33OZBUhEL4KLXyrl4buofURMuj3qZX8VXpq8eUaY/6G+LedTrcsHkLf/puP7Wk8qDrltEyjSPLlRzrHK5oy5akQW3OnOllod+0++OYcF5hgO3GsybBhZkjFlrPWbmUVIPLqe76XxeuYMsgnlgjU3yy3m7ZzZXXLxmRtL6bB7N0YZcZdKRDXc9c6ZeQoXtm3DWk/ltrkR6yaUgV/t2xR+7TVo0+Vq79CaDyYx/l2GXxOtvwXuTBZmAAJhpycy3LLQAgAzUFKwf2PPIYFJ3i15zO0VM65RX7pM37pkxOcIIhg9yBCAURijJeczulO8Msv0KEE0FyyYpTZsqRkowQkZhat5k0ead2tcBJdCK2RVZ+dm7KKjgRxkwScGVOUTtzTkUPfucWa85Z6GBubhFWKRgA+fy1dadG7MnNCET720+tR7yrX7STAxezisKQRd5PS+ToPOy4pIXltDLaAE4ouYBmZGaAaEPrdTiLgf+uDTbgh2y+4uP0pnFVmSxFVlsRRZbEWGRDQiymswLZ+waDdaZVF+2Tecj9nWRXiGTvNai+QxIYfAl25X5+iKbfMFSnOzTUjKoRfs3IeV3V4dLWgUxhfR9kUVfQ/rmYY3A2TVJQQVhGMNq91wzJm6VruqaErR/hW1kSiRl1iXbCdCR1q0N/y8p27be+QT2zIZ7Xl1+BXBc1viFf4TXNy2dAJGvevYtvKTtklrfLSetr4BNQlZDP29pzmb6sMkg6fwnaNW2+9C6hFkKKpQzC+9Lao1CejXJyty+3Et/Jbkjd5nNl4wK8pImvPwoG4q8kMLoL/+RpXptTqv8EvgrkptG8sqs4Cu3oDNt1d5/tWtvQCf5EMEm8JCbZM0lAU1u0ZW7gIvO+CTLv/sit7uHQ5q2B55xj1lOfM97BkahUbvtekEqrf5uc7jf5YRXjcEkHEvbLknydFEuJUoWaX701fDXoTEjAV+HXFs0qxWPRTtIIIzr82Lga1nAZlr/Ido8x9wceKxJk2MbtRaxMQOxYdOkgLvhMd1ZUvMsKbsn2LNx/nqB0a7Et5d296HlQs4B2IY10MhmZ1JXrlgMSe0yWX/Nj6QY1iGYCIZLF/ito7jTwBu7T7LRx4oeZj00Ao1ZkrFVLJUQnjT8aKwX0pvsZzKAj9G26+pyE9xz+wX8Mxk0wuT+aZYkZT2SZ5ySxZn0JoPJDECUrU72LEl7WXfIYMtke1CESTuIaRYwfOGZ5RD0i+IK9AtzKxCv6wWBgXNuBhXK4SUkkNDszOkSEM8lsJYU085c9MvK9XXnW+EOwCQs2m87mDJ0ZHmAJSMs2uMfT9Ew5KVfl2yb5BeMJ5sPVESHJTdDm8HOVOs30GSMAEvWS9KuP8GqkkDPAi4MP7KfZ/hqJk9ZlYq8dWVs0nyhUO5svhIJx9fOk4xv+kXzfBag4Fk8AFPzQx/ierY0wf35xX/hlqX9F6FSstFuQcqPSHrrS0/+NfRBhnAOAy5XfRl35CmvpNuDSYOdl0JVycS37002sLzrvg7lRouqA5NUN4eKFGaojuurw8tU3Z8zBXhoq6B9qKdA6tsJtoj0JoNJzh+AUp3W9f7UTtdoZEsFcaVj1fxvDdg6ra68c93BTnUH+SCBu4aaIxRcJE66XeW66RfQarbx5Aq8zlcRiNX07YBaERHJHQk3EsKIAFtseG1oI5IzUZahyksCcYViJHu/6IkusbHV5I7U6gst27cGVyWD5A/A1rPiQsDyWYLAWnddZ0jY7iPJed0DeTmTXCMnLYnfF0jW7F2mLZcY5C0ZhfGujB5ewhgVWQ0/C9brsWbAMyGOq8AYhaa1o+XAgzPpkdH6kSvzj/qtguNb3W5kFUz/gIuuD4il7YQhZJ6lXbpQI38bHns77NvbLbrbW5S+yyzJM76DnQl2RrweeV0NKQ/1ztjnd4tiREgvRI4V/WxEMT4BuvnRjruHT4Hq3H4VQbk91u8OyyLsLdvlgOHEpAJWAinorf2ob203idazUTVa9pPT7r8KzTodajQaAfNDAwRFCx3fwGhCFWr0oL0hOqWOwPWbjhC1AD4weiSWpIYQkPq7NHgE1AO3E/ZNjYFgV7+yTKP7ws9G7+wkjeCtl4UEde+7NVK70Bvd0xu+FyJvMnWjEIXmyhpPk1ZdKZAgMCMH2dH5YoA95jzfYHKLluUlGB7f2AJjtj2vBhUQVIfTjUKMAeBeO4pXA7wX0+MPGs8uh5i4i6w3gF6GiWcXTyPYJvjaG6D6WMzKWcOVOdmROZ1RHknEXojfRtbMd4D5efa2i1GC+nF81vje6DHv/nx3rAG4r2Fkawz2282sgRAIgAiNuzg3Loky6WIAmfDCtAYeU6PTZNOklcYbtdgCqIfmDVkQgTSGYFSDJhhfaEYYFmfNYY3tTJjDyZX5NE5hLlAUwvjK1vpdWr9LA/6oOflzbU0ZVrkaPJ6aekIuAjhbjZ3ML3wZbCJwVIyRqPla4HHa4Q8epzoVw65TafZE5WESnTQJ3fjOLhjEbT87uw3ANLuDvQi3kEbS6Idm1FwEIsyzBjHnFagk8+96c1isMusf0UomeS5ifzpZKlBpvv2ivTt/w0dHPkkvxSg04QJN2oXEI7Rc1Y1qtg+coyWMnv85+W5h0IXYpjaumiPoZqITl/GJAzck4oCGSLkxvSIQxgJC7Ucywat4gy2xBjKH3txQhDn04CbTCqnIH5iEID9N4WeFAkunEdp4S9d50U24pjUcaY1mOEY1kjHiE4VHMUarAKKMx7p1uiFgIDUVxxB+FskIWTZ5zVLoH2uMbewCv5AOZmnN5oLUGBMpzo5EQjZjIQxp7ctoTYN2YBXXJiNL0PVgUdePY9uvH0+zObftRGBv0Ow2em/0IxEt2CAOxFVn4ghiIKvRjoQy0NjJvNvJgs0SGXnriTZhTZ0MMjefNog43nLt2hSrBhEOW0ZZCRhRSFpBkRUNXZgqpOrtu9q/e2PeA+jhVFPFoURQbB1e7k3IA4oCC/Efwj+QlGoMpIqC7ERUIowDoEkTelOgIVEOvze7moOJFKBwRlGSfoTmgoDwe1xyVaMyHxjiLgPhv6IrZqXEVy7ojFhLgreITx5Egomh7m3BJEBXOlNxH5EIwEAxZgLJEIOmCdN+GPEgDhS1pS/ISGcgLByR37HpFw43BSC+C+AvsTYCgYfmgVCvmkxj0QM12ULEBVOpphEXdrYRDnDJqKbpn5obO6FmNEZyjFziE6iLBlpA8xyF3uhm/kr8rBwmVwZNuf48dEYTXu63IRz9JUxx7K5xMo/ByMqELtEEO5K5UjOHhZOCeJEm+gNyY0ynzEkO89A9CHa3qO0BhUHn4TCM+tvS2uAv2odqRIp3GAwEIQmaRphMAW4k33CtuuGhOUtB8Fh8JXbaEo2DpSzuv6rJjJNG40wQsESg265scxC+TC3KMqmpOKJ0HyIOEBtjNimiYMJfJCJkoAU6Bxlrwa/e6MrLj7K7+RI2hcjMzTjPvpP6c4l4FIwmd0oDs/HmzkRtnAXJvf4ZuXGcTPnL0entSlEq0YTgF4LUQQAfKvM6rTlwKGcwBRN3MQIS5IAsWp4tuP7tf/6dCbpnP/J3wggTR1JbIt1jJDAujqfdWLSjiwW4ySEVP13aD8XLWXA0Ey8uYiMavAwmwLp46DMNOQ/REAxEkeuWH1PTxOsFV2eZ7dJ3XAnHy32syeNQqnAhZEWOYVJjeAnSItUQSBMtGMpX1m0yrmJx9QXFtIajKJWkwc6rwV1XnoGmsVfgLA91Me6y+QBt2cLroom+0Yj10uSFkyWc1mTXG0LyNKE38BpRo03NhE5Uby7LGl3io2YN0rMRmJdt9nZ0G/uRo0jWwIvgnAXSA/OF9TBcGh0lg0Y1T8ISNCxxlWM+OhuykwVoVLW5oEWncY9aN4KFVZooVazE94j6tzNollp5c+uPwzfWW6bkINz/gsvg6i4122aRf5tBET9nzMc0S7oOYL14TNcbOE1M/J0ur9lYUCdDWkKYDubCGhgPCGS4grToJD/ADrhCwUqpweRd2Ri8mBAPJspzkTUA/dBc9rNy3lJTWV2imFcHpWqEdGkapEcgQc4G1ZPRaefMMzTtG43z7UxprfEQGoyVuEzPLrgiWPEOYdfUvUHSRXxm1ROquQGJajAzb9tPw0ecQLqkRv/EagSvaWRYLmM6uhKqwyXEEtLwkWuFC7XvVyd/NGd66B//Yw0BlHm4nZwNtGh8C3WJC836g6+zaB5N4GQkafx1B8vxldUedQkh3tSbIq60kv+DMsGiWlj57uNQIrGbkR3kFrkJnXYiYLcmyoGYtWru5bckbXH/fPnXYFAa5kZq/4J2Da7+tC+ZD8G76P4N7ofHmY045TeUSXhxIhMRLiMjDhwCT0or0Ug9STEqYI7UW/t7bNxAliOLP8OkRmfE6srLAnuKJNZowWi07EU9xY5NJcMBI4ZCGZUKGCFaLQEZjZj1r9J+sDxjbOKeB5kOU1Mo1Byy5TkwgbQkZa29LPMxERlWOxNvUBucnZcmkj2RfQlWoyB9hQZBrfxDseBDco9VqGK8utsdZRTxE6NQBvo6NoNHEKYdKEO2pPV8Sb/f133jkycB+03uAIOqFWeznAlteFq+T57nmYi0GYVK5vx7y/nz6nmXs0W7nzat/N2k6cBSTphya2U1Xs6I1eRua5P0CCSvR1OrOxr1IddgzMv0Gs5FVItMDNli2rUzLMP0cKt+Pa0xqNlRcCEmZZkXqNRMfkZEmfHpz43uya8Fy728YAW0UhsyL+I+lp/R0yy+t4cVdezBvj/9Zd/Lc61GuVIzBqb2eo6ZH2vtvEVsJykZ66LFf4hbs4gh+Z5o973778saQ++NoG0PX+O5oG3cx1r/tL/nYXL972FmRs386nj+2YtSyKAI/GvD3OSCLBqlNUVVaVlitXUiozkf3YfOOax2XY6izpYlMgM6l3trh5WdiHuI38l1EYntbYbM5SA9EqRoo7E6jB75osm4qYbRosYrKheJsfmv7By1Vw62a9miUD25o76Pe0tWKDJwiN3a61K0T5OxuIMSkCUGc/q9haXJJ/QKlYt9Sh6IfGJv/dOGp4XqtTIGY3eyVJ3lYatpdSujbcbb5MzOnjMSuMm0KzmJFVdOPojM6cnxreebxfPazf5YY5+/NWfbbyv7XOssqF9mOfOVXBz0kP0Nm5L5YdyboD7QxihXodRFOMLa6u37fGnLUYu2es3VwOIwL1sjlu6GYBGMJM41+ilE2JYn2yhmlSHmL2E47OJL9s/acGhqN8vkUImxP/vaaM83kKWROlbyNGKzDeaTg1GflMl57Llm4re0PE+UNaQGJLoNlGuMxxnlUXv3FqdNKEacbwC3sK9lXmMgCyMt4jk1DZvlPITXkrWrBe8Otz2MKM7BjqPtzwO04WpnQ790iKwLUNttlmsJRnCYfve03tr814beVve0z/n6ex72U2L70taKPRcNKladA6WbKrkbTNjTPgSH41zMDx2PPTgKK04VDtSQbAxoSdTCvcTLvmrrdW/kVYrdr7fkXK4PlU5GOmRfZXSqwXI5YKAteRLG31v/tOFp7ftW7LpkfoNcCnaOPAp1YqesL/PR22DUgwCSUZDN2kzxXm8hHH1/CqjMlrmRIeglPIKXo7W7HWOfd2obmUgohtyrZVa6HzpBdhF2IsNcezYlJ/e0/mmDZVAg/mds+l3KeIrFvs/cViKpJ/s5WHuxr09RjCB/fWLPLJcS3g7+QkudTsmGktS+AODS/kzEvrcZgrP5XtQDrn1aMipOW5wsSzAi+6/pdnETBZpCtVzLYTUPxX1v6lm0zQv4Q2woUYWnViwlWQaG+S/+n+WLBS0jNRQiOodxKS0i+0McR/thJj/DziArcxYyF24XzBcZcawQ1EbjO51xFIq+qhyY5VFo4RLWPpRE81LJwWv/yOZEsgTWUje6CaYC+0V8WHe1bDVox9kJhz8ApxAPxg/l6GQDDa6WgbHzJ3EvCoxkOMi3aMKMt1zO9EZtAqzWC8NNKxLJeIB70rPe+qd9uIn2n3aHEAYVSMR6YCmnccj6zjFDgT7B8AD5GsKvl1sCGXcyNz0vcz7HRRD0JnMjXqPWHx47ARnphKWUzliKRVTIyQQ77viztzomzCQ9uvD+E9mZMxKZMuZhWRZtNGfVTCg8rS74sRxMZyi0/mk7K3lIShN/Fi8ZzY9czRCPWhHvXg5l9RCCBXhMEZfV/GA7pV4F6gJ88pZnIQBJq97wcRC5WTQkmt1Ru3DdZ+sx88/2UJHPZ0ZvfqQUdYI/jCQByLR4YY2nFWlYwcXesi48z1f6wPx+Zd+FgNV2vCtWoS18Uu+0eGmeCIUFqsUQIgSF/IzGaXEZLYy3YoxODoKzaiUoZ6cFxeqXCpULEIXyzZZW6B3/2wm/nWwkIRGXHgHVBvs9X9mZ+wHYYR0t0CGkf5y7ZUJAZCQeegewLi0hNy2U33mm5mRycEu0LRCENABviN+QvJW1C4Iat+kdA/EOtTI0329ocN7OiOejQAB51pAMh2G6DuWPsWP6DjKFeN++V0BlwqzkOhxPS0dmx1kShESCfdWhyQSxE3keAJjCJwbSWSVnqHzrcFzGiuik5UJcT4NY6uu383cm/HYsY7IUtPTp5A7nD8P9dHx6gL191VKH2oLuHWuHabJN8XT8b0c/QRrd7mMd7pP7YKm8iv2veufvDOA88lO1d74d7gdTto7rwwO002x1Vm9fLUsio2QpES/obOBYNtHQjpRXvM7OUKBhnaqNNwGwtYBUfwlpkz6mEOvEBFLsfTnL5Qlky4f5kQJvoRIqwgE55CXm000XBnkuD1KgOssK5Py6PUmS4+ixFWEOb6hgEdsVIK8PbA6WyggrjhRAXC/LY5TRyicohcKK/XZIarBPZI1Bt2ytYfUhJuoHMDpiChR3a6JcPUhMvC0EsOJyrdC7kKK0hMQz5rU54JT77fydIU0RSKCStijFqPBKkU+xaqjRbZaLyDiXclmOIeAWgb0bcyg8GwzQvlyIBAuG3VcmZLdSIotz779Ksv8qCahVDmaloMiZf1bH74Rt6chsUGVUZBxvIOOyy1TFHm7v0XTrBKv5iQ0Y5wReekw94eEs4n4FkPMhwp0pETy0KMVi1l5o7uMJsqfZomFCiwJvVrbNFBJq7x0C6iLw1GkcBPEMivaO/+38fQWaFOun0PGAdJMMOmTNtOWX4SDWz/ZM7RiTFXcDGeGmOW55BjRIdSkvXYd8suAaYT5RBet8YUSJwm0hpEi4mviVJvwkHWe1K8KS5jwEHvscCjUGC3wKc8w2G4AP0qJWotNYXHWuBKU5nZwGCnD6ieKfHtKu2/l5UCQ/0TvZKnbkN4J13s6qeoR8iSwLf5zle09gSk340kFleFDlZCnup/N3Jvx2cg9oGwTO6QZeghnfsGiBPUieZp4ygMKLEoVyjtOB5+ZAnNsC2qZ12n66Axf7dpkxl3+6NUeHOpRL3J7O+cC5pJUTP+qdVnsUGuRX4TmUMtYeC7Eosv8YWDJODQoDs9abAnEZOXCmBZVJSpBTD+RJqyGVtQLpUq/DkW+u985LQKWHTi2IzMBqyh9zoxYsttKa3glP52shY4xNAtNJWSkEInpMtI0nZ4NSWgM+Dh3nfYk39w4ILuA+gW6lYzMzjwSbatPerWKH9S2PZCU3VI1YBc4HT71bqNmV5Kbfzt6hXQ8xw8J7yPnK7WuoLvYORkOmnk6xJbAOeYlrK97zgoiAwNi8FZ4nwSuqzUlthmJxYzl+qtiLHCz46QLF9zOSROgsjGzhaOtc7rfzdyb8dqzApvO8jtsAbmO85SH3QQQQKntYkYyZ07e08vRtV4f50sxbeJkCFYNx7LiPv+ZCdf1X7nXCNH2pxaIc69sIeeoMNSIyTlSEL4t4F0Nzi57EIiguLt4SYdSRE/Pk/axiA57dXw9YJrxmMUAA86sFi9bOTrvTKl96LxsiI6tqsVb3tXH3KKvFSQloJN6KEZrSvOOMx1wNM3GOXIBMEThKeNqgHjb0sLpyQ1IG7Tqmqv6Jj1pk1nqY/bFdVGUYMIqaDWbFemGmrls+eLSY1QQkjwdvGXqL1yaLWybtjJifSKQBiqfn/3od6xhMfVBP6iDHafGO3KFMsbiifnYOb+BWwYcVasoNWLClZirCSo/bGaJoBil8nX37oRcOqwWZ/SlLF+06bRFL+RDRs2mlJ1IfrOY7m6+iAMOtVACm3iPpMPiX25tF1aQWbW1WhVFhRnbuZ/KnQY/FTcL0MlTUUwRBZKu6DpeGT8St4wjqn/XUxOuopf4mM/0W52oUsMqbh3KbTRGlXLQ60ohNPmG0Oq4NQH4xG1v+XHkPvPTVtHr1+rmGMCat11aeeFajdliQN1i+SRhAbgvITFTLU7tXh9DzCrrulZuLKLzVH39aqR0j7Jsl/gMFWPrxYZfY2rvN1ku9VpmKysCv9fgUG71PLbp7iLJOHwhJn+R+LuIaZoMEa49tH8AsA5VEn85cLT4ltm4Yi2S8G3vqvV4NAiI8sM6AVcMKl596nl0udArXE4OyKDb5NeJM/okvWYTs6f13DoAwy69fVBTri5siSkMGlfSL5dDfxFPJn0slqGFQL/QnJ0VOmX8ZSHkH27/ZMsKsea6EkXg9LV+H7BaFCPlq3zGUyaJML8EP8/JJ+opGCBOI4+FS6AkTpN6jwgAQUA/3QAYZtWyVtN612X+1p6WDgciaf+JG0U+/vfD05FroiXUaVDu1UjslKfh12yjEhsoFHiaaM4bJqsDOW1poOEK7BBNDTMViNFehIlYmAFb11+PbQ26O2SjdkenXfnvy43kEZ0t3S85bp5KVzNdMlK6KGUglSJz2BBZZVt043h+854SbZ9Ysz2zkDOfvf3siXlQGqfdR7/tEcw7z4E+PDHLi3pZZTr+oYCuhx4dr+On/6F13Mie7S0spEwQHjKPFj397mQiPp55SfxuDqP5FCtr8g8WTes/+ovf+Oxf+errLKZ43WUb9xITwOqPFeE5LxBMGmWIbSTZTrgFuaSO59JG6W2bXUSncfmecNHTMH4vsnOF1kYHvMRzL3gq3S0+1p827V94TVS8723kyuqe3yjfqZZvvL5ul9Zt9d/Gpxu62ZSRmXhHtfhvbfrXj7B7XPDfB6Sfmwqh+e2GQMoXLKidbyXr2aDWxK2U8VL5qTqsUpA7vmxoN7czh5i8/+K2ve5GqvahmrZBRzZV6BXQ9DWIVnrejqGb9vbNboh97Qhan3HWL6Ibsn1APYQ0o5uODF6HACrGR3yAoa9ESzZiefBettBDI0xV3LKm72tiEknopKe9MgBjdbygETfjrhv+6hEgKGU8CF1Y0+kR0xH6A61boKcd2vVln+etpI9hTLaTReM/H/UYlemQAvnHaG1Tmba2SyAhhtWyr/aoo1ux7XIHlWYdJNil6Mh2PG7aIlkUOPvkviKCuhRH+QV2BGRMKDm0kFvAHiWbvzq5KxAPcmlt3x/6/s6tdamfNXRP9ATuTQM3pt1v4HwqkA6uR0gEEMIFbq7yywE+zH8YLFGLW3goko3CA6B6WMLrFm7e+8E8iHJRA6saooJF9fU1Chy5zQw5KSpCl5dBwPQ6vNIQqT53kq/3mqQSc9qXYO1my57x/gyMQFX9zr4tXtN857Y0XnLcWKq+c8T6QNPeWfjVeEGrC5FZHs3vpociHTKH4t9xe7gz8b9b3/2Z9/29+rV6O0DC5o8OLiDElkfjKaW+UaZcU2YK1J3l69CB1H9qJ7kEIXTO00P1+5fKpKnmIdfePTxcHmbdDBsAK0qjyttXERe6b0ecE3p9attKx2+89xJBPXkHoLrHJCDXLPZ5OE8yOtHSLUPLByPCAbDNzhnV/vCtB+Bg8BcUnGmJpmacrU9O7V1gJ5tD9uvLlbCA6FShiUXf/65orhBVZHZdrb7v2O9+8soDn03AOK9d8iBlRwn+EYDaAifgs78xEY6veH2evnBRNHZkrmKbjRQ6rXa0U1ImK8v6G9ol/OOBvN/fSKdd0E7m5ItoYe8Zhc4bhzYEZzorJfJmMGdaoTnJ5BADWP2+2mYsrT2iOtzwSaEgX5GURybiMlz5dXus4jRZZvkFeHH7H68eQntqsJEmzmCxx/del7kgOuqevhASP8WuZSwqIQi/mwBpunWh3T2Au96/bo/QLM8XrEkXL7HjnSaaezcR9eR0ixPzm7Qb5Ja0Fr/dD4/xlSPIrS9u6pf2lafydEDOZIntdyx1Hd4T2qu9sil/5XzPkW128Og3yo1EJUp68okt5607AnDzw//TD0yeYPAUULPc48KuXZWKJhBjYaljSwq2sbIKyiqkXNlufmDQUioCRdDdxT/qPYzLD+Wc5BUhkyY3mGGmWxyq30RbKp1nB2SqMea1p68bR4lGiJz59wqmtB33RnsyweFGjBWKpJaN05s/+BfuPLHhEdSv9Ovsesuj91V5NWm2iqXN/7KFMNlB0ha3O3Z79EpVg/9uECMrR7CW1gF2eZOyq78XKZtopQLbnauzKvQdevr4Rb0x/Fg6z9rtGkSz9FCjiGX4nATqhH1wslAxgN8ogzZ7sdUKfrL61WFyR8iYLP8oXHIyfVHcWgyyYfMC+pjtZ1XGPDVKHsciWBYpUZT8pQz2/iZziq6d/J00yzI+K0uR4D8+skf5WA76K6/0lOvs/DgRhHVGbp66UV1aCX+21OOF4sn4GuwVDjEiemGWZTQtMmR3ZHkOiqQkvCwzaLl5dYC0ssrR5m/O+pb1b7eWsKHzenYdujjaF11MRGP3b/lZ96UYvu/rbq4SJmuWkLd1ztU1mrzUKRmUg5MKdhf7k8HiR6IIuv0UgzkXPThWclc1clnJziyz/rstlGfhvajK1NBmKP0bA1hPAHzMPfPY6bvvjg7ePiTZsRLC/Wz7v8ORBeO/Ikity+ddu5qeXNpF81br3g6OfekIJv1vWDo5eoj/LV5U9CLePwWIKrbh+tznIibI8+VP7QbUkwvfZe8K8Vr8zzRsBQw3jJGBQqG5ITBne4XS52WtzlP383XoR08fImBVbhboJXFhN5qpl8RYBdPWXwGs7UOKfnugmIPR/DsL/HmTtK5t/3gPutSeXtFULIyIPVfO7Mw+8U+22l9uG84ck0m1F8nIheF2C7P8dsKWApPjn1f/BCLJM/2GKX7reD+yby3Vg7quF9Vdi/Nn+XycA/mJGnhrw1eqzeKvgz19bjJlibfmLkO7Xn/vWXN0ULOgZJgu/U41w+u/cU9k9wlz6CKg24l0jS0b3nfREs6ggFmvoSyILQkeTyzd/B7jj/w7+3zfhfw8yseJKXiZZzXAM+xFeicLSgczKbASOu/134P/3IPzvweOgtdHFCP72tuubu8mPyjKTZiIOrF2Vq6Y8921cn/LJTti0TYk8/DI1s7x/LpjHfmcKg39p13e2185kk8P/AUrqYkahTAAA").split(","));function AT(t){return ET(t.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}function ET(t){let e=t.indexOf("1");if(e===-1)return[t];{let r=t.substr(0,e),i=ET(t.substr(e+1));return Y(i.map(o=>[r+"l"+o,r+"i"+o]))}}var bO=l(()=>DT(PT())),Tc=3;function DT(t){let e=new en,r=[];for(let i of t)i.length<Tc?r.push(i):e.add(i.slice(0,Tc),i);return{trie:e,small:r}}function wO(t,e){let r=Jw(yd(t.toLowerCase().normalize())),{small:i,trie:o}=e==null?bO():DT(e);for(let n of[r.replace(/[^a-z]/gi,""),...AT(r)]){let s=i.find(a=>n.includes(a));if(s!=null)return s;for(let a=0;a<n.length-(Tc-1);a++){let m=o.get(n.substr(a,Tc));if(m!=null){let c=n.substr(a),p=m.find(g=>c.startsWith(g));if(p!=null)return p}}}}function xO(t){return wO(t)!=null}function Kl(t){let e=10,r="";do r=t();while(e-- >0&&xO(r.replace(/[^a-z]/gi,"")));return r}var LT=BigInt(0);function Zd(t,e,r=0){if(!isFinite(e)||t<=1)return[];let i=[];if(e===0)i.push(0);else for(;e>0;)i.push(e%t),e=Math.floor(e/t);for(;i.length<r;)i.push(0);return i.reverse()}var nn=class{constructor(e,r,i=Ar){this.name=e;this.numerals=r;this.decodePreparser=i;this.base=r.length}digitsToNumerals(e){return e.map(r=>this.numerals[r]).join("")}encode(e,r=0){if(!isFinite(e))return"";let i=e<0;return i&&(e=Math.abs(e),r--),(i?"-":"")+this.digitsToNumerals(Zd(this.base,e,r))}encodeBigInt(e){if(typeof e!="bigint")throw new Error("bad input");if(e===LT)return this.numerals[0];let r=[],i=BigInt(this.base),o=e;for(;o>LT;)r.push(Number(o%i)),o=o/i;return this.digitsToNumerals(r.reverse())}encodeBuffer(e){if(e==null||e.length===0)return"";let r=[0];for(let i of e)for(r.forEach((o,n)=>{i+=o<<8,r[n]=i%this.base,i=Math.floor(i/this.base)});i>0;)r.push(i%this.base),i=Math.floor(i/this.base);return this.digitsToNumerals(r.reverse())}decode(e){return f(this.decodeBigInt(e),r=>{if(r>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(r)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(e==null||v(e))return;e=Ee(this.decodePreparser)?this.decodePreparser(e):e;let r=e[0]==="-";r&&(e=e.slice(1));let i=BigInt(this.base),o=BigInt(0);for(let n of e){let s=this.numerals.indexOf(n);if(s<0)return;o=o*i+BigInt(s)}return r?BigInt(-1)*o:o}randomChars(e){return this.encodeBuffer((0,FT.randomBytes)(e+3)).slice(1,e+1)}safeRandomChars(e){return Kl(()=>this.randomChars(e))}randomUid(e=20,r=5,i="-"){return $o(this.randomChars(e),r).join(i)}safeRandomUid(e,r=5,i="-"){return Kl(()=>this.randomUid(e,r,i))}tokenEql(e,r,i){let o=this.normalizeToken(e),n=this.normalizeToken(r);return o.length>=i&&o===n}normalizeToken(e){return this.decodePreparser(e.trim()).split("").filter(r=>this.numerals.includes(r)).join("")}},YG=new nn("hex","0123456789abcdef",t=>t.toLowerCase()),sn=new nn("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),TO=new nn("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",t=>t.toLowerCase()),ms=new nn("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",t=>t.toLowerCase()),vc=new nn("TokenRadix","0123456789abcdefhjkmnpqrtuvwxy",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9")),XG=new nn("AlphaRadix","abcdefghjkmnpqrtuvwxyz"),ZG=new nn("NumericRadix","0123456789",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9"));function Mc(t,e){let r=t.toUpperCase().normalize(),i=e.toUpperCase().normalize();return Pi(()=>r===i?1:void 0,()=>v(t)!==v(e)?0:void 0,()=>t.length===1&&e.length===1?0:void 0,()=>{let o=IT(r),n=IT(i),s=vO(o,n).length;return 2*s/(o.length+n.length)})}function IT(t){return t==null||t.length===0?[]:t.slice(0,-1).split("").map((e,r)=>e+t[r+1])}function vO(t,e){let r=wd(t,e),i=[];return r.forEach(o=>{let n=Math.min(fr(t,s=>s===o),fr(e,s=>s===o));xe(n,()=>i.push(o))}),i}function OT(t){return fr(t.normalize().split(""),e=>e.toLowerCase().localeCompare(e)!==0)}function kT(t){let e=t+`
`;return B?e.replace(ho,`\r
`):e}function ui(...t){return Y(t.map(e=>h(e).split(ho)))}var WT=P(require("fs")),$l=P(require("fs-extra")),us=P(require("path"));var Ia=P(require("fs-extra")),ih=P(require("path"));var eh=P(require("crypto")),RT=P(require("fs"));var _T=192;async function Sc(t,e){let r=eh.default.createHash("sha512"),i=0,o=T(e?.msbits,_T)/8;return await ye(t,n=>new Promise((s,a)=>{let m=RT.default.createReadStream(n,{autoClose:!0});m.on("error",c=>a(c)),m.on("data",c=>{i+=c.length,e?.observer?.onProgress(i),r.update(c)}),m.on("end",()=>s())})),r.digest().slice(0,o)}function MO(t,e=_T){return eh.default.createHash("sha512").update(t).digest().slice(0,e/8)}function Wr(t,e=9,r=sn,i=224){return r.encodeBuffer(MO(t,i)).substring(0,e)}function an(t,e=24,r=ms,i=224){return Wr(t,e,r,i)}var BT=P(require("fs")),Jl=P(require("fs-extra")),CT=P(require("util")),La=P(require("zlib"));function SO({message:t,cause:e,retriable:r,ignorable:i,fatal:o,doNotSend:n}){let s=[t];q(st(ae(e),"Error: "),m=>s.push(m));let a=$w(_(s)).join(": ");return o=o||a.includes(de),r=(r||a.includes(ha))&&!a.includes(kt),n=n||!a.includes(So),i=i||a.includes(Nl),sc(ac(a),o?de:void 0,n?yr:void 0,i&&!o?Nl:void 0,!r&&!o?kt:void 0,r&&!o?ha:void 0)}var ue=class extends Error{constructor({cause:e,message:r,retriable:i=!0,ignorable:o=!1,fatal:n=!1,doNotSend:s=!1}){super(SO({message:r,cause:e,retriable:i,ignorable:o,fatal:n,doNotSend:s}));this.cause=e,e!=null&&(this.stack=e.stack),this.retriable=i,this.fatal=n}};var NT=P(require("stream"));var th=class extends NT.Writable{constructor(e){super(e);this.deferred=new Kt("WritableToBuffer");this._buf=[];this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",r=>{this.deferred.reject(r)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,r,i){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,r)),i()}};var PO=l(()=>d("zcat"));async function VT(t,e){try{return b(Pc(t,e),h)}catch(r){PO().warn("zcat failed to read "+t,r);return}}async function rh(t,e,r){if((await(0,Jl.stat)(t)).size===0)return;let o=[],n=[(0,BT.createReadStream)(t,y({autoClose:!0},r)).on("error",s=>o.push(s))];if(t.toLowerCase().endsWith(".gz")?n.push((0,La.createGunzip)().on("error",s=>o.push(s))):t.toLowerCase().endsWith(".br")&&n.push((0,La.createBrotliDecompress)().on("error",s=>o.push(s))),n.push(e),await as(n),k(o))throw new ue({message:"zReadFile("+t+") failed",cause:o[0]})}async function Pc(t,e){if((await(0,Jl.stat)(t)).size===0)return Buffer.from([]);let i=new th;return await rh(t,i,e),await i.buffer}async function zT(t){return JSON.parse((await Pc(t)).toString())}var EO=(0,CT.promisify)(La.gzip);async function UT(t,e){let r=O(e),i=await EO(r);return(0,Jl.outputFile)(t,i)}var AO="readdircache",DO=l(async()=>{let t=(0,ih.join)(u.cacheDir.valueOrDefault,AO);return await(0,Ia.mkdirp)(t),t},A);async function FO(t){return(0,ih.join)(await DO(),...$o(an(t)+".json.gz",2,3))}var oh=l(()=>d("Readdir"));function nh(t){return t!=null&&M(t.basename)&&ad(t.isFile)&&ad(t.isDirectory)}U(()=>{H(()=>Ec.prior()?.clear()),nr(t=>{t==null?Ec.prior()?.clear():Ec.prior()?.deleteIf(e=>e.startsWith(t))})});var Ec=l(()=>new Ji({maxSize:500,timeoutMs:J,clearEveryMs:A}));async function sh(t){let e=await Ec().getOrSetAsync(t,()=>LO(t));if(e==null)throw new Error("readdir() timeout for "+t);return e}async function LO(t){let e=await FO(t);try{let o=(await(0,Ia.stat)(e)).mtimeMs;if(Date.now()-o<u.readdirCacheSeconds.valueOrDefault*S){let n;if(await Je(async()=>(n=await zT(e),n!=null&&Array.isArray(n)&&n.every(nh)),{timeoutMs:J-S,timeBetweenMs:250}))return n}}catch(o){o.code!=="ENOENT"&&oh().debug("Failed to read from readdir cache",o)}let r=await Da((0,Ia.readdir)(t,{withFileTypes:!0})),i=Hw(r.result.map(o=>({basename:o.name,isFile:o.isFile(),isDirectory:o.isDirectory()})),o=>o.basename);if(r.elapsedMs>=500)try{await UT(e,i),oh().debug("Wrote readdir cache for slow directory",{nativePath:t,elapsedMs:r.elapsedMs})}catch(o){oh().debug("Failed to write to readdir cache",o)}return i}var Ql=class{constructor(e,r){this.base=e;nh(r)?(this.isFile=r.isFile,this.isDirectory=r.isDirectory):(this.isFile=r.isFile(),this.isDirectory=r.isDirectory()),r instanceof WT.Stats&&(this.size=r.size,this.mtimeMs=r.mtimeMs)}},qT=l(()=>d("DirectoryEntry")),qr=class{constructor(e,r){this.dir=e;this.dirent=r;this.nativePath=(0,us.join)(this.dir,r.base),this.ext=Ai(r.base).ext}static async for(e){let r=Ai(e);try{let i=await(0,$l.stat)(e);return new qr(r.dir,new Ql(r.base,i))}catch{return}}async join(...e){return qr.for((0,us.join)(this.nativePath,...e))}get base(){return this.dirent.base}get name(){return hr(this.base,this.ext)}get pathnames(){return this.nativePath.split(us.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}get isRoot(){return this.dir===(0,us.parse)(this.dir).dir}parent(){let e=Ai(this.dir);return e.dir===this.dir?this:new qr(e.dir,{base:e.base,isFile:!1,isDirectory:!0,mtimeMs:void 0,size:void 0})}async childNames(){try{return this.isDirectory()?(await sh(this.nativePath)).map(e=>e.basename):void 0}catch(e){qT().warn("childNames() failed to readdir("+this.nativePath+")",e);return}}async children(){try{return this.isDirectory()?(await sh(this.nativePath)).map(r=>new qr(this.nativePath,new Ql(r.basename,r))):void 0}catch(e){qT().warn("children() failed to readdir("+this.nativePath+")",e);return}}async visitDescendantFiles(e){for(let r of F(await this.children()))await(r.isFile()?e(r):r.isDirectory()?r.visitDescendantFiles(e):void 0)}async filterDescendantFiles(e){let r=[];return await this.visitDescendantFiles(async i=>{await e(i)===!0&&r.push(i)}),r}stat(){return(0,$l.stat)(this.nativePath).catch(()=>{})}async size(){return ze(this.dirent.size,()=>b(this.stat(),e=>e.size))}async mtimeMs(){return ze(this.dirent.mtimeMs,()=>b(this.stat(),e=>e.mtimeMs))}unlink_(){return(0,$l.unlink)(this.nativePath)}};var IO=64,Yl=class extends ke{constructor(){super(IO);U(()=>nr(e=>this.clearFromPath(e))),U(()=>H(()=>this.clear())),this.on("expire",(e,r)=>r?.clear())}clearFromPath(e){v(e)?this.clear():this.visit((r,i)=>{r.startsWith(e)&&i.clear()})}};var jT=P(require("stream"));var cs=class extends jT.Transform{constructor(){super({objectMode:!1,autoDestroy:!0})}async _transform(e,r,i){let o=(h(this._prior)+h(e)).split(ho),n=o.pop();this._prior=n===""?void 0:n;for(let s of o)this.push(s)||await wt(1);i()}_flush(e){this._prior!=null&&this.push(this._prior),this._prior=void 0,e()}};var Ac=P(require("timers"));function OO(t){return t!=null&&M(t.path)&&M(t.op)&&St(0,100,t.pct)}var HT="progress";function ah(t){OO(t)&&ve.emit(HT,y(y({},t),{pct:ut(te(0,100,t.pct))}))}function GT(t){ve.on(HT,t)}function Xl(t,e,r=!1){let i=r?Date.now()+e:0,o=0,n=(...s)=>{let a=Date.now();if(a>=i)return i=a+e,o++,t(...s)};return n.count=()=>o,n}var Dc=500,ln=class{constructor(e,r,i=Dc){this.context=e;this.total=r;this.throttleMs=i;this.start=Date.now();this.emit=Xl(()=>{ah(y(y({},this.context),{pct:this.pct,elapsedMs:this.elapsedMs}))},this.throttleMs,!0)}incrProgress(e){this.onProgress(e+T(this.current,0))}onProgress(e){this.current=te(0,this.total,T(e,T(this.current,0)+1)),this.emit()}get pct(){return ut(100*T(this.current,0)/this.total)}get elapsedMs(){return Date.now()-this.start}},mn=class{constructor(e,r,i,o=Dc){this.ctx=e;this.total=r;this.progress=i;this.throttleMs=o;this.start=Date.now();this.onInterval=Xl(()=>b(this.progress(),n=>this.emit(n)),this.throttleMs),this.timer=(0,Ac.setInterval)(()=>this.onInterval(),Dc)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){f(e,r=>ah(y(y({},this.ctx),{pct:100*te(0,this.total,r)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>Dc&&this.emit(this.total),this.end()}end(){f(this.timer,e=>(0,Ac.clearInterval)(e)),this.timer=void 0}};var fs=P(require("path")),$T=P(require("process"));var KT=P(require("fs")),lh=P(require("path"));function JT(t){let e=[];for(;t!==(0,lh.dirname)(t);)t=(0,lh.dirname)(t),e.push(t);return e}function kO(t){try{return(0,KT.readdirSync)(t)}catch(e){return[]}}function Fc(t,e){let r=kO(t);return e.every(i=>r.includes(i))}var mh=l(()=>(0,fs.dirname)(process.execPath)),jr;(function(c){c.Root=l(()=>{let p=["icc","migrations","public","views"],g=[];Ue()&&g.push("/ps/app"),ni&&g.push((0,fs.join)(mh(),"resources"),(0,fs.join)(mh(),"..","Resources")),g.push(..._([mh(),(0,$T.cwd)(),__dirname])),qu(g);for(let w of g){if(Fc(w,p))return w;for(let E of JT(w).slice(0,4)){if(Fc(E,p))return E;let R=(0,fs.join)(w,"node_modules","photostructure");if(Fc(R,p))return R}}throw new Error("Failed to find project root. Looked in "+g)});let e=p=>l(()=>(0,fs.join)(c.Root(),p));c.Bin=e("bin"),c.ICC=e("icc"),c.Migrations=e("migrations"),c.Public=e("public"),c.Tools=e("tools"),c.Views=e("views");async function m(p=c.Root()){return he?new RegExp(`^\\/Volumes\\/${Kn}[^\\/]*\\/${Kn}.app\\/`,"i").exec(p)!=null:!1}c.isInDMG=m})(jr||(jr={}));function un(t,e,r){let i=new QT(e,r,!0);return i.read(t),i.done}var QT=class{constructor(e,r,i=!0){this.sep=e;this.onData=r;this.filterBlanks=i;this.incompleteChunk="";this.done=new Bt}onChunk(e){if(e==null)return;let i=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=i.pop(),i.forEach(o=>{(!this.filterBlanks||M(o))&&this.onData(o)})}clear(){this.onChunk(""),M(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",r=>this.onChunk(r)),e.on("end",()=>{this.clear(),this.done.resolve()}),this}};var XT=B?"wip-":".",uh=new Yl,ci=class{constructor(e,r){this.dirent=r;this.bflog=l(()=>d("BaseFile("+this.nativePath+")"));this._childDirectoryEntries=l(()=>b(this.directoryEntry(),e=>e.children()));this.stat=l(()=>this.trap("stat",()=>it.default.stat(this.nativePath).catch(()=>{})),ci.attrTTL);this.statSync=l(()=>this.trapSync("statSync",()=>pt(()=>Ir.default.statSync(this.nativePath))),ci.attrTTL);this.shaResult=l(async()=>{let e=await this.size();if(e===0||e==null)return;let r=e>5*Hi?new ln({op:"Computing SHA of",path:this.nativePath},e):void 0,i=await mi(()=>this.trap("sha",()=>Sc([this.nativePath],{observer:r}))),o=f(i.result,n=>n.toString("base64"));return{elapsedMs:i.elapsedMs,buffer:i.result,b64:o}},ci.attrTTL);if(r!=null)this.nativePath=r.nativePath,this.dir=r.dir,this.base=r.base,this.name=r.name,this.ext=r.ext;else{this.nativePath=ai(e);let i=Ai(this.nativePath);this.dir=i.dir,this.base=i.base,this.name=i.name,this.ext=i.ext}this.posixPath=si(this.nativePath),uh.set(e,this)}toJSON(){return{nativePath:this.nativePath}}[YT.inspect.custom](){return this.toJSON()}static async withFastestAccess(e){let r=D(e),i=await Promise.all(r.map(o=>o.shaMs()));return r[cd(i)]}static forPosix(e){return e instanceof ci?e:this.for(e.split("/").join(cn.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(e instanceof ci)return e;let i=uh.get(e);if(i!=null)return i;let o=ai(e);return uh.getOrSet(o,()=>new ci(o,r))}static clear(e){zr(e)}for(e,r){return ci.for(e,r)}clear(){return this.dirent=void 0,this._childDirectoryEntries.unset(),this.stat.unset(),this.statSync.unset(),this.shaResult.unset(),this}clearThisAndParent(){return zr(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return e==null?!1:e instanceof ci?this.nativePath===e.nativePath:this.nativePath===ci.for(e).nativePath}get isUNC(){return jd(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return pc(e,this)}async directoryEntry(){return this.dirent==null&&(this.dirent=await b(this.stat(),e=>new qr(this.dir,new Ql(this.base,e)))),this.dirent}async childDirectoryEntries(e){let r=await this._childDirectoryEntries();return r==null||e==null||L(r)?r:await tn(r,e)}_directoryEntryChild(e){return this.for((0,cn.join)(this.nativePath,e.base),e)}childNames(){return b(this.childDirectoryEntries(),e=>e.map(r=>r.base))}async children(e){return(await this.childDirectoryEntries(e))?.map(r=>this._directoryEntryChild(r))}async childFiles(e){let r=[];for(let i of F(await this.childDirectoryEntries()))if(i.isFile()){let o=this._directoryEntryChild(i);(e==null||await e(o))&&r.push(o)}return r}async childDirectories(e){return b(this.childDirectoryEntries(),r=>is(r.filter(i=>i.isDirectory()).map(async i=>xT(this._directoryEntryChild(i),e))))}childrenSync(){return T(this.trapSync("childrenSync",()=>Ir.default.readdirSync(this.nativePath).map(e=>this.join(e))),[])}async hasChildren(e){let r=await this.childNames();return k(e)?Du(r,e):k(r)}async hasNoChildren(){return await this.isFile()||L(await this.childNames())}async visitDescendants(e){return b(this.children(),async r=>{for(let i of r)await i.visitDescendants(e),await e(i)})}async descendants(e){let r=[];for(let o of F(await this.childFiles()))await e(o)&&r.push(o);let i=await this.childDirectories();if(i!=null)return await Dr({name:"descendants",laters:i.map(o=>()=>b(o.descendants(e),n=>r.push(...n)))}),r}async ancestorWithChildren(e){return await this.hasChildren(e)?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}async siblings(e){let r=this.parent();return(await this.siblingDirectoryEntries(e))?.map(i=>r._directoryEntryChild(i))}async siblingDirectoryEntries(e){return this.parent().childDirectoryEntries(async r=>r.base!==this.base&&(e==null||await e(r)))}async selfAndSiblings(){return this.parent().children()}async firstExistingSelfOrAncestor(){return this.isRoot||await this.exists()?this:this.parent().firstExistingSelfOrAncestor()}get pathnames(){return this.nativePath.split(cn.sep).filter(e=>e!=null&&e!=="")}get pathnamesWithoutDrive(){return B?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(B?1:0)}get isRoot(){return this.pathnames.length===(B?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return e!=null&&(this.nativePath===e.nativePath||Au(e.pathnames,this.pathnames))}isDescendantOf(e){return e!=null&&e.isAncestorOf(this)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){let e=this.parent();return this.isRoot?[]:[...e.parents(),e]}async normalize(){return this.isUNC?this:await this.exists()||this.isRoot?this:b(this.parent().normalize(),async e=>{let r=await e.childNames();if(k(r)){for(let o of r)if(o===this.base)return e.join(o);let i=this.base.normalize();for(let o of r)if(o.normalize()===i)return e.join(o);if(he||B){for(let o of r)if(Ve(o,this.base))return e.join(o)}}})}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return L(e)||nt(["."],e)?this:rT(e[0])?this.for((0,cn.join)(...e)):this.for((0,cn.join)(this.nativePath,...e))}joinYMD(e=new Date){return Qb(e?.getFullYear(),e?.getMonth(),e?.getDate(),(r,i,o)=>this.join(h(r),jt(i+1),jt(o)))}child(...e){if(L(e))return this;let r=Y(e.map(i=>i.split(cn.sep))).filter(i=>i!=="..");return this.join(...r)}async trap(e,r,i="warn"){try{return await Qe("fs."+e,r)}catch(o){this.bflog().log(i,`trap: ${e}() failed: ${o}`);return}}async trapOr(e,r,i="warn"){try{return this.bflog().trace(`trapOr ${e}()`),await r(),!0}catch(o){return this.bflog().log(i,`trapOr: ${e}() failed: ${o}`),!1}}trapSync(e,r){try{return this.bflog().trace(`trapSync ${e}()`),r()}catch(i){this.bflog().warn(`trapSync: ${e}() failed: ${i}`);return}}async exists(){return this.dirent!=null||await Cx(this.stat())}existsSync(){return this.dirent!=null||this.statSync()!=null}async notExists(){return Pt(this.exists())}mtime(){return b(this.stat(),e=>e.mtime)}mtimeMs(){return b(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return b(this.stat(),e=>Wi(e.mtime))}async lastModifiedUtc(){return b(this.stat(),e=>e.mtime.toUTCString())}statTimes(){return b(this.stat(),e=>V([e.birthtimeMs,e.mtimeMs,e.ctimeMs].filter(r=>r!=null&&r!==0)))}maxStatMs(){return b(this.statTimes(),sa)}maxStatDate(){return b(this.maxStatMs(),e=>new Date(e))}minStatMs(){return b(this.statTimes(),Qu)}minStatDate(){return b(this.minStatMs(),e=>new Date(e))}size(){return b(this.stat(),e=>e.size)}async access(e){try{return await it.default.access(this.nativePath,e),!0}catch{return!1}}isExecutable(){return this.access(Ir.default.constants.R_OK|(B?0:Ir.default.constants.X_OK))}isReadable(){return this.access(Ir.default.constants.R_OK)}isNotReadable(){return Pt(this.isReadable())}isReadWritable(){return this.access(Ir.default.constants.R_OK|Ir.default.constants.W_OK)}isNotReadWritable(){return Pt(this.isReadWritable())}isHiddenPosix(){return this.base.startsWith(".")}async isEmpty(e=0){if(await this.isDirectory())return k(await this.childNames());{let r=await this.size();return r==null||r<=e}}isNonEmpty(e=1){return Pt(this.isEmpty(e))}async isNonEmptyFile(e=1){return await this.isFile()&&await this.isNonEmpty(e)}async modifiedGTE(e){return b(this.mtime(),r=>Wi(r)>=Wi(e))}async modifiedCloseTo(e,r){return b(this.mtimeMs(),i=>Math.abs(i-e)<=r)}async isRecent(e){let r=await this.maxStatMs();return r!=null&&r>Date.now()-e}async modifiedGT(e){if(e!=null)return b(this.mtime(),r=>Wi(r)>Wi(e))}async isDirectory(){return this.dirent!=null?this.dirent.isDirectory():be(this.stat(),e=>e.isDirectory(),()=>!1)}async isNotDirectory(){return Pt(this.isDirectory())}isDirectorySync(){return this.dirent!=null?this.dirent.isDirectory():ee(this.statSync(),e=>e.isDirectory(),()=>!1)}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile(){return this.dirent!=null?this.dirent.isFile():this.stat().then(e=>W(e).map(r=>r.isFile()).getOrElse(()=>!1))}isFileSync(){return this.dirent!=null?this.dirent.isFile():W(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>it.default.rmdir(this.nativePath),e)}async mkdirp_(){try{await it.default.mkdirp(this.nativePath)}catch(e){if(e.code!=="EEXIST")throw e}if(await Je(()=>this.clear().isDirectory(),{timeoutMs:2*S,timeBetweenMs:200})===!1)throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return await this.clear().isDirectory()||this.isRoot?this:this.trap("mkdirp",async()=>this.mkdirp_())}mkdirpSync_(){return it.default.mkdirpSync(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",()=>this.mkdirpSync_())}sha(){return b(this.shaResult(),e=>e.b64)}shaMs(){return b(this.shaResult(),e=>e.elapsedMs)}async writeStream_(e,r){return await as(D([e,f(r?.onProgress,i=>new qd(i)),it.default.createWriteStream(this.nativePath,r)])),this.clearThisAndParent()}async writeJsonMaybe(e,r={}){return this.trap("writeJsonMaybe",()=>this.writeJSON_(e,r))}async writeJSON_(e,r={}){return await this.parent().mkdirp(),await it.default.writeFile(this.nativePath,O(e,r.replacer,r.spaces),y({flag:"w"},r)),this.clearThisAndParent()}readJson(e="warn"){return this.trap("readJson",()=>li(async()=>await this.isNonEmptyFile()?it.default.readJson(this.nativePath):void 0,{maxRetries:1,onRetryWaitUntil:()=>or(e==="warn"?250:25),errorIsRetriable:r=>r.errno!==-2}),e)}readJsonSync(){return this.trapSync("readJsonSync",()=>it.default.readJsonSync(this.nativePath))}readFileSync_(){return it.default.readFileSync(this.nativePath)}readFile_(){return it.default.readFile(this.nativePath)}readFile(e="warn"){return this.trap("readFile",()=>this.readFile_(),e)}async zReadFile_(e){return Pc(this.nativePath,e)}async zcat(e){return this.trap("zcat",()=>b(this.zReadFile_(e),h))}async zCopyFile(e,r){return this.trap("zCopyFile",async()=>(await e.parent().mkdirp(),await rh(this.nativePath,Ir.default.createWriteStream(e.nativePath),r),e))}readLines(){return b(this.readFile(),e=>ui(e.toString()))}readFileSync(){return pt(()=>f(Ir.default.readFileSync(this.nativePath),h))}writeTxt_(e){return this.writeFile_(kT(e))}async writeFile_(e){return await this.parent().mkdirp(),await it.default.writeFile(this.nativePath,e),this.clearThisAndParent()}wip(e=XT){return this.sibling(e+this.base)}async unwip_(e=XT){let r=this.sibling(st(this.base,e));return this.mv_(r,{overwrite:!0})}async dest(e){let r=e.clear();return M(this.ext)&&v(r.ext)||await r.isDirectory()?r.join(this.base):r}copyFile_(e){return Qe("fs.copyFile",async()=>{let r=(await this.dest(e)).clear();if(this.nativePath===r.nativePath)return this;if(await r.parent().mkdirp()==null)return this.bflog().throw("Cannot mkdirp "+r.dir);try{return await this._copyFile(r)}catch(o){if(Rx(o))throw o;return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:r.nativePath,error:o}),await this._nativeCopyFile(r)}finally{this.clearThisAndParent()}})}async _copyFile(e){let r,i,o=e;try{let n=await ze(this.stat(),()=>this.clear().stat());if(n==null)return this.bflog().throw("Can't copy missing files"+kt);if(n.size===0)await e.touch(n.mtime,n.atime);else{if(u.verifyFileCopies.valueOrDefault&&await this.sha()==null)return this.bflog().throw("Can't copy file without SHA"+kt);i=e.wip();let s=it.default.copyFile(this.nativePath,i.nativePath);n.size>5*Hi&&(r=new mn({op:"Copying",path:this.nativePath,dest:e.nativePath},n.size,()=>i.clear().size())),await s;let a=await Je(async()=>n.size===await i.clear().size(),{timeoutMs:J});if(u.verifyFileCopies.valueOrDefault){let m=a&&await Je(()=>$n(this.sha(),i.clear().sha()),{timeoutMs:J});if(!m)return this.bflog().throw("copyFile_() failed",{sizeMatches:a,shaMatches:m})}if(!a)return this.bflog().throw("copyFile_() failed",{expectedSize:n.size,actualSize:await i.clear().size()});if(o=await i.unwip_(),o==null)return this.bflog().throw("copyFile_("+e+") failed: .unwip() was null");await it.default.utimes(o.nativePath,n.atime,n.mtime)}try{await it.default.chmod(o.nativePath,n.mode)}catch(s){this.bflog().debug(`copyFile_(${o.nativePath}) warning: couldn't chmod to ${n.mode}: ${s}`)}return this.bflog().debug(`copyFile_(${e.nativePath}): success`),kd(this.nativePath,e.nativePath),e}catch(n){throw this.bflog().warn(`copyFile_(${i?.nativePath}) failed: ${n}`),await i?.unlink(),await e.unlink(),n}finally{f(r,n=>n.end())}}async copyTimeoutMs(){return be(this.size(),e=>Math.max(J,e*fc),()=>J)}async _nativeCopyFile(e){let r;try{if(await e.parent().mkdirp()==null)return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});let i=await this.stat(),o=f(i,n=>n.size);return i==null||o==null?this.bflog().throw("Can't copy missing files"):(o>5*Hi&&(r=new mn({op:"Copying",path:this.nativePath,dest:e.nativePath},o,()=>e.clear().size())),B?await Fe.instance().execute(`Copy-Item -LiteralPath ${ds(this.nativePath)} -Destination ${ds(e.nativePath)}`,n=>n):await le("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:await this.copyTimeoutMs()}),kd(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(i){return this.bflog().throw("_nativeCopyFile("+e+"): "+i)}finally{f(r,i=>i.end())}}async touch(e=Date.now(),r){return this.trap("touch",()=>b(this.ensureFile(),()=>this.utimes(e,r)))}async utimes(e,r){let i=T(e,Date.now()),o=T(r,i);return this.trap("utimes",()=>it.default.utimes(this.nativePath,Wi(o),Wi(i)).then(()=>this.clearThisAndParent()))}async unlink(e="warn"){return this.trap("unlink",async()=>(await it.default.unlink(this.nativePath),this.clearThisAndParent()),e)}async rmrf(e="info"){return this.trap("rmrf",async()=>(this.bflog().log(e,"rmrf()"),await it.default.remove(this.nativePath),this.clearThisAndParent()))}async unlock(){return he&&await this.clear().exists()&&await le("chflags",["nouchg",this.nativePath],{timeout:J}),this}async renameWithNameSuffix_(e){return b(this.withNameSuffix(e).ensureNew_({emptyIsNew:!0}),r=>r.unlink("debug").then(()=>this.mv_(r)))}async mv_(e,r={overwrite:!1}){let i=await this.dest(e);if(this.nativePath===i.nativePath)return this.bflog().warn("mv(): no-op",new Error("internal error")),this;await i.parent().mkdirp(),this.bflog().debug("mv",i);try{await it.default.move(this.nativePath,i.nativePath,r)}catch(o){this.bflog().warn("mv() try #1 failed. Calling unlock() and waiting for source to be non-empty.",o),await Promise.all([this.unlock(),i.unlock()]),await Je(()=>this.clear().isNonEmptyFile(),{timeoutMs:7*S}),await it.default.move(this.nativePath,i.nativePath,r)}return await i.unlock(),this.clearThisAndParent(),i.clearThisAndParent()}async pipeTo(e,r){return this.trap("pipeTo("+e+")",async()=>{let i=await this.sibling(e).ensureNew_();return await as([Ir.default.createReadStream(this.nativePath),r,Ir.default.createWriteStream(i.nativePath)]),await this.unlink(),i})}async gunzip(){return this.pipeTo(hr(this.base,".gz"),(0,ps.createGunzip)())}async gzip(){return this.pipeTo(this.base+".gz",(0,ps.createGzip)())}async compressBrotli(){return this.pipeTo(this.base+".br",(0,ps.createBrotliCompress)())}ensureFile(){return this.trap("ensureFile",()=>it.default.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync_(){return it.default.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return Ur(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get baseWithoutCountWithParent(){return this.parent().base+"/"+this.baseWithoutCount}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}async ensureNewNativePath(e){return dc(y({nativePath:this.nativePath},e))}ensureNew_(e={}){return this.ensureNewNativePath(e).then(r=>this.for(r))}async renameYMDHMS_(e){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");let r=fw(await ze(this.mtime(),()=>new Date)),i=ee(e,o=>this.parent().join(o),()=>this.parent());return this.mv_(i.join(this.name+"-"+r+this.ext),{overwrite:!0})}async saveIfNewOrDelete(e){if(await this.clear().isEmpty()){await this.unlink("trace");return}let r=await this.siblingWithSameContents();if(r!=null)return await this.unlink(),r;let i=await this.sibling(e).ensureNew_();return this.mv_(i)}async chmod(e){return await it.default.chmod(this.nativePath,e),this.clear()}zreadline(){return Ir.default.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe((0,ps.createGunzip)()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)}).pipe(new cs)}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return Qe("fs.childWithSameContents",async()=>{if(await this.notExists()||!await this.isDirectory())return;let r=await e.size(),i=await this.children(),o=[];for(let s of F(i))await s.size()===r&&!e.eql(s)&&o.push(s);if(L(o))return;let n=await e.sha();for(let s of o.sort((a,m)=>Mc(a.base,m.base)).reverse())if(await s.sha()===n)return s})}async applyWip(e,r=0,i=15*S){let o=this.wip();try{if(await o.parent().mkdirp(),(await o.clear().isRecent(i)||await this.clear().isRecent(i))&&(this.bflog().info("applyWip(): recent WIP exists. Waiting for a bit to see if someone else will do my work."),await Je(()=>this.clear().isNonEmpty(r),{timeoutMs:i*2,timeBetweenMs:500}))){this.bflog().info("applyWip(): yay, someone else did my work.");return}await this.touch(),await o.unlink("trace");let n=await e(o);if(await Je(()=>o.clear().isNonEmptyFile(),{timeoutMs:S}))return await o.unwip_(),n;throw new Error("applyWip(): empty after apply for "+this)}catch(n){throw await o.unlink(),await this.unlink(),n}}async applyIfEmpty_(e,r=0){return await this.clear().isNonEmpty(r)?this.bflog().debug("applyIfEmpty(): non-empty"):(this.bflog().debug("applyIfEmpty(): empty, applying..."),await this.applyWip(e,r)),this.touch()}firstMatchingLine(e){let r=new Kt("firstMatchingLine("+this+")"),i=Ir.default.createReadStream(this.nativePath,{flags:"r"});return i.on("error",o=>{o.errno===-2||o.code==="ENOENT"?(r.maybeResolve(void 0),i.close()):r.maybeReject(o)}),i.on("close",()=>r.maybeResolve(void 0)),un(i,ho,o=>{let n=e.exec(o);n!=null&&(r.maybeResolve(n),i.close())}),r.promise}contemporary(e,r){return ga(this.statTimes(),e.statTimes(),(i,o)=>{for(let n of i)for(let s of o)if(Su(n,s,r))return!0;return!1},()=>!1)}},Me=ci;Me.attrTTL=3*A,Me.projectRoot=l(()=>{let e=jr.Root();if(e==null)throw new Error("Cannot find project path");return ci.for(e)});function Lc(t){let e=D(t).filter(([r,i])=>r!=null&&i!=null);return new Map(e)}function Zl(t,e){return Lc(D(t).map(e))}async function ZT(t,e){if(t==null)return new Map;let r=await Promise.all(D(F(t)).map(i=>e(i)));return Lc(r)}var hs=P(require("process"));function ht(t){return h(t).replace(/[-.,\\^$*+?()|[\]{}]/g,"\\$&")}function ev(t){return t.replace(/[ââ']/g,"[\u2018\u2019']").replace(/[ââââÂ«Â»ã"]/g,'[\u201C\u201D\u201E\u201D\xAB\xBB\u3003"]')}function tv(t,e){let r=[];for(let i of t)try{new RegExp(i),r.push(i)}catch{r.push(ht(i))}return new RegExp(r.join("|"),e)}var rv=class{constructor(e){this.h=e;this.text=T(e.text,h(e)),this.greedyLeft=T(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}},ch=l(()=>d("Fixed"));function Eo(t,e,r=!0){return new iv(t,e,r).entries}var iv=class{constructor(e,r,i=!0){this.warnIfMissingHeaders=i;let o=r.split(/[\r\n]{1,2}/);this.headerRow=o[0],this.rows=o.slice(1);let n=Math.max(...this.rows.map(s=>s.length));this.col2blanks=new Map(xe(n,s=>[s,fr(this.rows,a=>v(a[s]))])),this.headers=this.extractHeaders(e.map(s=>new rv(s))),this.entries=this.rows.map(s=>this.headers.map(a=>a.toEntry(s))).map(s=>ft(s)).filter(s=>Mt(s).some(M))}extractHeaders(e){let r=this.headerRow;X(e,s=>-s.text.length),e.forEach(s=>{let a=new RegExp(`\\b${ht(s.text)}\\b`,"i"),m=a.exec(r);m==null?this.warnIfMissingHeaders&&ch().warn("extractHeaders(): Failed to find header!",{re:a,headerLine:r}):(s.indexOf=m.index,r=Uw(r,m.index,s.text.length," "))});let i=e.filter(s=>s.indexOf!=null),o=X(i,s=>s.indexOf);o.forEach((s,a)=>{let m=s.indexOf,c=o[a-1],p=a===0?0:c.indexOf+c.text.length-1,[g,w]=s.greedyLeft?[p,m]:[m,p];s.leftIdx=f(this.firstBlankColumn(g,w),E=>E+1),a===0&&s.leftIdx==null&&(s.leftIdx=0),s.leftIdx==null&&ch().warn("no blank column for "+s.text+" between "+m+" and "+p)}),et(o,s=>s.leftIdx!=null),o.slice(0,-1).forEach((s,a)=>{let m=o[a+1];s.rightIdx=m.leftIdx-1});let n=F(ix(e.map(s=>s.text),o.map(s=>s.text)));return n.length>0&&ch().warn("Missing headers",{missingHeaders:n}),o}firstBlankColumn(e,r){return po(e,r).find(i=>this.col2blanks.get(i)===this.rows.length)}};var Ic=()=>"wmic",ov=()=>"fsutil";var nv=()=>"ping";var _O=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;function sv(t){let e=_O.exec(t);if(e==null)return;let r=e.slice(1,8).map(g=>G(g));if(!Tu(r))return;let[i,o,n,s,a,m,c]=r,p=G(e[8],{defaultValue:0});return new Date(Date.UTC(i,o-1,n,s,a,m,c/1e3)-p*A)}var NO=/Date\((\d+)\)/;function av(t){return W(t).flatMap(e=>NO.exec(e)).flatMap(e=>e[1]).flatMap(G).filter(e=>St(0,Date.now()+ot,e)).map(e=>new Date(e)).get()}var BO=l(()=>d("Ps"));function CO(t){return t!=null&&C(t.pid)&&t.start!=null&&M(t.cmd)}async function lv(t){return b(em([t]),e=>F(e).find(r=>r.pid===t))}async function mv(t){return L(t)||Eu([hs.default.pid],t)?F(t):b(em(t),e=>e.map(r=>r.pid))}async function em(t){let e=F(t).filter(C);if(L(e))throw new Error("Invalid pids: "+O(t));return gx(b(B?VO(e):zO(e),r=>r.filter(i=>CO(i)&&e.includes(i.pid))),r=>BO().debug("pidInfo()",{pids:e,result:r}))}function UO(t){return t.map(e=>({pid:e.Id,start:av(e.StartTime),cmd:e.ProcessName}))}var WO="Get-Process",qO="| Select-Object -Property Id,ProcessName,StartTime";function uv(t){return V([...t.filter(C),hs.default.pid]).join(",")}async function VO(t){if($()||Fe.instance().ended)return jO(t);let e=[WO,"-Id",uv(t),"-ErrorAction SilentlyContinue",qO].join(" ");return b(Fe.instance().executeJsonToA(e),r=>UO(r))}var cv={maxBuffer:1024*1024,timeout:15*S,ignoreExitCode:!0,ignoreStderr:!0},fv=["CommandLine","CreationDate","ProcessId"];async function jO(t){let e=["process"];if(k(t)){let o=V([...t.filter(C),hs.default.pid]).map(n=>`ProcessId=${n}`).join(" or ");e.push("where",o)}e.push("get",fv.join(","));let r=await je(Ic(),e,cv),i=ww(Eo(fv,r.result).map(o=>({pid:G(o.ProcessId,{defaultValue:-1}),start:sv(o.CreationDate),cmd:h(o.CommandLine)})));return i.find(o=>o.pid===hs.default.pid)||i.push({pid:hs.default.pid,start:new Date(qi),cmd:"node "+hs.default.title}),i}function HO(t){return Eo(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],t).map(e=>({pid:G(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:h(e.COMMAND)}))}async function zO(t){let e=await je("ps",["-p",uv(t),"-wwwo","pid,lstart,command"],y(y({},cv),{ignoreExitCode:!0}));return HO(e.result)}var pv=P(require("path")),dv=P(require("process"));function fi(){return ri(dv.env.PS_CONFIG_DIR,()=>(0,pv.resolve)(Pa(),vi().toLowerCase()))}var $i=l(()=>d("Pids")),GO=10*S;function gv(t,e){if(t==null||e==null)return!1;let r=f(e.start,o=>o.getTime()),i=t.startTime;return C(r)&&C(i)&&Math.abs(r-i)<GO}async function KO(t,e){return t==null||e==null||t.name!==h(e.pid)?!1:gv(await t.readJson(),e)}function yv(t,e=!1){let r=["/PID",h(G(t)),"/T"];e&&r.push("/F"),hv.default.execFile("taskkill",r)}async function JO(t,e=!1){if($()||Fe.instance().ended)return yv(t,e);try{let r=D(["Stop-Process","-Id",G(t),e?"-Force":void 0]).join(" ");await Fe.instance().execute(r,Ar)}catch(r){$i().warn("killWin(): pwsh error, using TASKKILL: "+r),yv(t,e)}}async function $O(t,e=!1){try{tm.default.kill(t,e?"SIGKILL":"SIGTERM")}catch(r){if(!String(r).includes("ESRCH"))throw r}}function Oc(t,e=!1,r=!0){if(t===tm.default.pid||t===tm.default.ppid)throw new Error("cannot self-terminate");return e&&r&&fn.instance().onKill(t),B?JO(t,e):$O(t,e)}async function kc(t){return await lv(t)!=null}var fh=class{constructor(e=Me.for(fi()).join("pids")){this.pidsDir=e;this.p=new Jt;this.recentPids=new ke(10*S);this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",async()=>{let r=T(e.everything,!1),i=T(e.force,B),o=await this.pidfiles(),n=await ZT(o,w=>b(w.readJson(),E=>[E.pid,E])),s=V(Y(F(n.values()).map(w=>[w.pid,w.ppid])));if(L(s))return $i().debug("killOldProcs(): no pidfiles"),[];let a=await em(s);if($i().debug("killOldProcs()",{pids:s,allEntries:a}),a==null){re("Pids.killOldProcs(): failed to get process information");return}let m=new Set(a.map(w=>w.pid)),c=a.filter(w=>n.has(w.pid)),p=X(D(c.map(w=>f(n.get(w.pid),E=>gv(E,w)?y(y({},E),w):void 0))),w=>w.pid).filter(w=>tm.default.pid!==w.pid),g=r?p:p.filter(w=>!m.has(w.ppid)||!m.has(w.pid)||C(w.timeoutTime)&&Date.now()>=w.timeoutTime||e.everythingBefore!=null&&w.startTime<e.everythingBefore);$i().debug("killOldProcs()",{trackedEntries:c,victims:g,pidfiles:F(n.values())});for(let w of g)$i().debug("killOldProcs(): killing",{entry:w}),Oc(w.pid,i,!1);return await this.vacuumPids(),X(g,w=>w.pid)})}async addPid(e,r,i=!1){if(e==null)throw new Error("undefined info");let o=e.pid;if(!C(o))throw new Error("undefined pid");let n=e.ppid+":"+e.pid;return i&&this.recentPids.delete(n),this.recentPids.getOrSet(n,async()=>{let s=this.pidsDir.join(e.pid+".json"),a=W(pt(()=>Ai(e.cmd).base)).filter(M).getOrElse(()=>e.cmd),m=r.getTime(),c=pe(e.maxAgeMs,g=>m+g),p=y(y({},e),{cmd:a,startTime:m,timeoutTime:c});return await s.writeJsonMaybe(p)==null?$i().throw("Failed to write to "+s,{info:e,force:i}):($i().debug("addPid() wrote "+s,p),s)})}pidfiles(){return this.pidsDir.clear().children(e=>e.ext===".json"&&G(e.name)!=null)}async onKill(e){let r=this.pidsDir.join(e+".json");return b(r.clear().readJson(),i=>this.addPid(y(y({},i),{maxAgeMs:1}),cw(A),!0).catch(o=>{$i().info("onKill(): failed to rewrite pidfile: "+o,{pid:e})}))}async vacuumPids(){let e=await this.pidfiles(),r=F(e).map(o=>G(o.name)).filter(C);if(L(r))return;let i=await em(r);if(i==null){re("Failed to get pidInfo for pids "+r);return}$i().debug("vacuumPids",{pids:r,pidfiles:F(e).map(o=>o.base),entries:i});for(let o of e){let n=i.find(s=>h(s.pid)===o.name);(n==null||!await KO(o,n))&&($i().debug("vacuumPids(): Removing old pidfile "+o.base,{psEntry:n,pidfile:await o.readFile().then(h).catch(s=>"(failed to read file: "+s+")")}),await o.unlink())}}},fn=fh;fn.instance=l(()=>new fh);function Rc(t,e){return fn.instance().addPid(t,e)}var w7=l(()=>{let t=[{everything:!1,force:!1,intervalMs:5*A},{everything:!1,force:!0,intervalMs:17*A}].map(e=>Vr(()=>fn.instance().killOldProcs(e),e.intervalMs));return new $e("ProcCleaner",()=>(t.map(clearInterval),fn.instance().killOldProcs()),me.predb)});var rm=Ae("AboveNormal","Normal","BelowNormal","Idle"),ph=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19});var gs=class{constructor(e){this.ttlMs=e;this.expireListeners=[];this.delegate=new Map;this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,r=this.ttlMs){return this.delegate.set(e,Date.now()+(r-this.ttlMs)),this}addIfMissing(e,r){let i=this.delegate.get(e);if(i==null||this.isEntryExpired(e,i))return this.add(e),r()}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(let[r,i]of this.delegate)this.isEntryExpired(r,i)||e(r,r,this)}has(e){return!this.isEntryExpired(e,this.delegate.get(e))}values(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield i)}return r()}entries(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield[i,i])}return r()}toA(){return this.vacuum(),[...this.delegate.keys()]}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}on(e,r){this.expireListeners.push(r)}isEntryExpired(e,r){return Lt(r==null||r+this.ttlMs<=Date.now(),i=>{r!=null&&i&&(this.expireListeners.forEach(o=>o(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,r)=>{this.isEntryExpired(r,e)})}};var bv=l(()=>d("Renice"));U(()=>H(()=>dh.prior()?.clear()));var dh=l(()=>new gs(A));async function _c(t){if(dh().has(t))return;dh().add(t);let e=u.processPriority.valueOrDefault;return pe(t,async()=>{try{await(B?QO(t,e):YO(t,T(ph[e],ph.BelowNormal))),bv().info("Renice pid "+t+" to "+e)}catch(r){bv().info("Failed to renice pid "+t+"",r);return}})}async function QO(t,e){return pe(t,r=>rm.mapValid(e,i=>Fe.instance().execute(`(Get-Process -Id ${t}).PriorityClass = "${e}"`,o=>o)))}async function YO(t,e=19){return je("renice",[e,"-p",t].map(h),{timeout:10*S,isIgnorableError:()=>!0,ignoreExitCode:!0,maxRetries:0})}var yh=P(require("process"));var xv=P(require("process"));var Qi=class{constructor(e){this.a=e}async _map(e,r){let i=this.a!=null?await this.a():void 0,o=hh(i)?await i.get():i;return o!=null?e(o):r()}async isDefined(){return this._map(()=>!0,()=>!1)}async isEmpty(){return this._map(()=>!1,()=>!0)}async get(){return this._map(e=>e,()=>{})}async getRequired(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}async exists(e){return this._map(e,()=>!1)}map(e){return new Qi(async()=>this._map(e,()=>{}))}flatMap(e){return new Qi(async()=>this._map(e,()=>{}))}filter(e){return new Qi(async()=>this._map(async r=>await e(r)?r:void 0,()=>{}))}catch(e){return new Qi(()=>this.get().catch(async r=>e(r)))}forEach(e){return new Qi(async()=>{let r=await this.get();return await f(r,e),r})}async getOrElse(e){return T(await this.get(),e)}orElse(e){return new Qi(async()=>{let r=await this.get(),i=r??await e();return hh(i)?i.get():i})}};function hh(t){return t instanceof Qi}function at(t){return hh(t)?t:new Qi(()=>t)}var wv;(function(r){r.and=async(...i)=>{for(let o of i)if(!I(await o()))return!1;return!0},r.or=async(...i)=>{for(let o of i)if(I(await o()))return!0;return!1}})(wv||(wv={}));async function Qt(...t){if(t!=null)for(let e of t){if(e==null)continue;let r=await e();if(r!=null)return r}}var Tv="en",Nc=l(async()=>gh(await Qt(()=>vv(),()=>B?XO():void 0,()=>he?ZO():void 0,()=>ya?ek():void 0)));function vv(t=xv.default.env){return Yb(t.LC_ALL,t.LC_MESSAGES,t.LANG,t.LANGUAGE)}var tk=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function gh(t){if(v(t)||Ve("c",t)||Ve("posix",t))return Tv;{let e=tk.exec(t);return e==null?Tv:D([e[1],e[2]]).join("-")}}function XO(){return b(Fe.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),t=>t.Name)}var Mv={timeout:10*S};function ZO(){return at(le("defaults",["read","-globalDomain","AppleLocale"],Mv)).flatMap(gh).get()}var rk=/^([a-z_]+)\s*=\s*"(.+)"$/i;function ek(){return at(le("locale",[],Mv)).flatMap(t=>t.split(`
`).map(e=>f(e.match(rk),r=>[r[1],r[2]]))).flatMap(ft).flatMap(vv).flatMap(gh).get()}function Sv(){return{LANG:"C",LC_ALL:"C"}}var ik=l(()=>new Set(Mt(u).map(t=>t.key)));function Ev(){let t=ik();return xw(Tw(yh.default.env,e=>e==="NODE_ENV"||t.has(e)))}var Av=l(()=>im().filter(t=>t.hasValue()));function ok(){Av.unset()}var Dv=l(()=>{try{return new RegExp(u.sensitiveEnvRegExp.valueOrDefault,"i")}catch(t){return console.error(`Invalid setting for "sensitiveEnvRegExp": ${t}. Using default value.`),new RegExp(u.sensitiveEnvRegExp.defaultValue,"i")}});U(()=>{u.sensitiveEnvRegExp.addListener(()=>{Dv.unset(),Fv.unset()});for(let t of im())t.addListener(ok)});var Fv=l(()=>{let t=Dv();return Yu(yh.default.env,(e,r)=>t.exec(e)!=null?void 0:r)});function nk(){return Av().reduce((t,e)=>e.maybeAddToEnv(t),y(y({NODE_ENV:Ko},Ue()?{PS_IS_DOCKER:"1"}:{}),ni?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}))}function bh(t){let e=T(t,{}),r=T(e.forceCLocale,!0);return y(y({},qt(e,"forceCLocale")),{env:sk(e.env,r),detached:!1,shell:!1})}function sk(t,e){let r=Mi(y(y(y(y(y({},Fv()),{PATH:Pv()}),e?Sv():{}),nk()),T(t,{})));return u.logStdout.deleteFromEnv(r),u.tailLogs.deleteFromEnv(r),r}var Yt=l(()=>d("ChildProcess"));function Bc(t){return rt(t,"pid","killed","connected","exitCode","signalCode")}function Lv(t,e){return Je(()=>Pt(kc(t)),{timeoutMs:e})}async function om(t,e=30*S){if(t==null)return!1;let r=t.pid;if(Yt().debug("endProcess("+r+")",{killed:t.killed,connected:t.connected}),r<=0)return Yt().warn("endProcess(): asked to end invalid pid",Bc(t)),!1;if(r===xh.default.pid)return Yt().warn("endProcess(): asked to end MY pid",Bc(t)),!1;await or(250),await Kx(t);{let i=t.kill();Yt().debug("endProcess("+r+")",{killResult:i,childGotSigterm:t.killed}),i||await Oc(r).catch(o=>{Yt().warn("endProcess(): kill("+r+",false) failed: "+o)})}if(pt(()=>t.unref()),Gn())return!0;if(await Lv(r,e))return Yt().debug("endProcess(): exitted",Bc(t)),!0;{fn.instance().onKill(r);let i=t.kill("SIGKILL");Yt().warn("endProcess("+r+") had to resort to SIGKILL",{killResult:i}),i||await Oc(r,!0).catch(o=>{Yt().warn("endProcess(): kill("+r+",true) failed: "+o)})}return Lv(r,5e3)}function ak(t,e){return t!=="renice"&&t!=="which"&&t!=="where"&&[t,...e].every(r=>!r.endsWith("web.js")&&!r.endsWith("db.js")&&!r.includes("sqlite3"))}function Iv(t,e,r,i){let o=new Date,n=!1;t.on("exit",()=>n=!0);let s=ak(e,r);return ua(async()=>{if(n)return;await Je(()=>C(t.pid),{timeoutMs:5*S});let a=t.pid;if(C(a))return s&&await _c(a),Rc({pid:a,cmd:e,maxAgeMs:i,ppid:xh.default.pid},o);Yt().info("newProc(): not writing pidfile, child_process has no pid",{cmd:e,cp:Bc(t)})},B?500:250),t}function Th(t,e,r,i){let o=bh(i);return Yt().debug("spawn()",{command:t,args:e,maxAgeMs:r,opts:o}),Iv(wh.default.spawn(t,e,o),t,e,r)}function pn(t,e,r,i){let o=bh(i);return Iv(wh.default.execFile(t,e,o),t,e,r)}async function je(t,e,r){return li(()=>lk(t,e,r),{timeoutMs:r.timeout,maxRetries:T(r.maxRetries,3),onRetryWaitUntil:i=>wt(100*i),errorIsRetriable:i=>Yt().tap({msg:"stdoutResult.errorIsRetriable()",result:gT(i,/EPERM/),meta:{error:i,cmd:t,args:e}})})}async function lk(t,e,r){let i=T(r.quiet,!1),o=T(r.ignoreStderr,!1),n=T(r.ignoreExitCode,!1),s=[];Yt().debug("stdoutResult(): execFile",{cmd:t,args:e});let a=await pn(t,e,r.timeout,qt(r,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(r.disconnect===!0)return a.disconnect(),{result:"",pid:a.pid};let m=O({cmd:t,args:e}),c=new Kt(m);setTimeout(()=>{c.pending&&Yt().warn("stdoutResult(): SLOW COMMAND",{cmd:t,args:e})},r.timeout/3).unref(),c.setTimeout(r.timeout);let p=(g,w)=>{if(Gt(w)||Ee(r.isIgnorableError)&&r.isIgnorableError(w)){Yt().debug("stdoutResult(): ignorable error for "+g,{cmd:t,args:e,opts:r,error:w});return}a.pid!=null&&om(a),i||Yt().warn("stdoutResult(): "+g,{cmd:t,args:e,opts:r,error:w}),c.pending&&c.reject(w)};try{a.on("error",g=>p("on(error)",g)),a.on("close",g=>{let w=Date.now()-c.start,E=g!==0?"warn":"debug",R=s.join("");i||Yt().log(E,"stdoutResult(): on(close)",{cmd:t,code:g,args:e,elapsedMs:w,result:qw(R,160,160)}),!n&&g!==0?c.reject(new Error("non-zero exit code: "+O({code:g,cmd:t,args:e}))):c.resolve({result:R,code:Ys(g),pid:a.pid})}),Ki(a.stdin),a.stdout?.on("data",g=>{g!=null&&s.push(g)}),a.stderr?.on("error",g=>p("stderr(error)",g)),a.stderr?.on("data",g=>o?Yt().warn("stdoutResult(): stderr(data): "+h(g)):p("stderr(data)",g))}catch(g){p("try/catch",g)}return await c.promise}function le(t,e,r){return je(t,e,r).then(i=>i.result)}var nm=class extends $e{constructor(e,r,i=me.service,o=!1){super(e,()=>this.t.end(),i,()=>this.t.ended,e==="sync-file"?J:S);this.name=e;this.t=r;r.on("childStart",n=>{this.logger.info("Started child process "+e+":"+n.pid),_c(n.pid).catch(s=>this.onError("renice failed for "+e,s)),o&&n.on("exit",()=>om(n,5*S)),Rc({pid:n.pid,ppid:Ov.default.pid,cmd:e,maxAgeMs:r.options.maxProcAgeMillis+A},new Date).catch(s=>this.onError("addPid failed for "+e,s))}),r.on("startError",n=>{this.lastStartError=n,this.onError("failed to start",n)}),r.on("taskError",(n,s)=>{this.lastTaskError=n,this.onError("failed to run "+f(s,a=>a.command),n)}),r.on("internalError",n=>{this.lastInternalError=n,this.onError("internal error",n)}),r.on("endError",n=>{this.logger.error("observeBatchCluster.endError()",n)})}onError(e,r){!this.t.ended&&!$()&&!Gt(r)?re(this.name+": "+e,r):this.logger.warn("onError() (ending or ignorable): "+e,r)}};var Cc=24;function ys(t,e=2){if(e<=0)return t;if(t!=null)return wu(t)?t:Array.isArray(t)?mk(t):ei(t)?t:nc(t)?y(y({},t),{stack:Cd(t.stack)}):xu(t)?Yu(t,(r,i)=>ys(i,e-1)):t}function mk(t,e=ys){if(t!=null)return t.length<=Cc?t.map(e):[...t.slice(0,Cc).map(e),`\u2026 (${t.length} total items)`]}var Ct=Ae("error","warn","info","debug","trace"),kv=ft(Ct.values.map((t,e)=>[t,e]));function sm(t){return kv[t]??kv.trace}var uk=l(()=>Ct.values.filter(t=>t!==Ct.trace)),ck=48,vh=l(()=>ft(uk().map(t=>[t,new kl(ck)])));function Rv(){Mt(vh()).forEach(t=>t.clear())}function _v(t){vh()[t.l]?.push(t)}function Nv(){let t=[];for(let e of Mt(vh()))t.push(...e.toA());return X(t,e=>e.ts)}function Oa(t,e){return t>=e?"error":t>=e/2?"warn":t>=e/4?"info":"debug"}var fk=/^[a-z]*/i,am=class{constructor(e,r){this.context=e;this.loggers=r;this.error=(e,r)=>{this.log("error",e,r)};this.warn=(e,r)=>{this.log("warn",e,r)};this.info=(e,r)=>{this.log("info",e,r)};this.debug=(e,r)=>{this.log("debug",e,r)};this.trace=(e,r)=>{this.log("trace",e,r)};this.filterContext=ee(fk.exec(h(this.context)),i=>i[0],()=>this.context)}addContext(e){return new am(this.context+e,this.loggers)}throw(e,r){let i=Gi(e)||r?.fatal,n=!(r?.retriable===!1)&&Vd(e),s=Gt(e)||r?.ignorable;r=r==null?void 0:ys(qt(r,"fatal","retriable","ignorable"));let a=new ue({cause:oc(e),message:_([this.context,r==null?void 0:O(r)]).join(" "),fatal:i,retriable:n,ignorable:s});throw this.log(s===!0?"warn":"error",Ot(e),r),a}tap(e){return this.log(T(e.level,"debug"),e.msg,y({result:e.result},e.meta)),e.result}log(e,r,i){if(i=ys(i),dn().enabled(e,this.context))for(let o of this.loggers())o.log(e,this.context,r,i);else e!=="trace"&&_v({ts:Date.now(),l:e,ctx:this.context,msg:r,meta:i})}async flush(){for(let e of this.loggers())await e.flush()}async end(){for(let e of this.loggers())await e.end()}};var pk=10*A,Bv="{ready}",Cv=" | ConvertTo-Json -Compress";function ds(t){let e=t.replace(/['`"ââ#]/g,r=>"`"+r).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v");return'"'+e+'"'}function dk(){return[`function prompt {"${Bv}"}`,...Ti(u.powerShellCulture.valueOrDefault,t=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${t}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${t}'`],[])].join(";")}U(()=>H(()=>Fe.instance.prior()?.clearMockResults()));var Mh=class{constructor(){this.name="PowerShell";this.logger=d("PowerShell");this.mockResults=new Map;this.bco=new nm("PowerShell",new Vc.BatchCluster({processFactory:()=>pn("powershell",u.powerShellArgs.values,pk),logger:()=>d("PowerShell"),versionCommand:dk(),pass:Bv,fail:"Error",exitCommand:"exit",maxProcs:xt()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:J,cleanupChildProcs:!1}),me.postdb),this.pwsh=this.bco.t}get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return b(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,r){this.pushMockResult(Wt(e,Cv),r)}pushMockResult(e,r){this.mockResults.set(e,r)}clearMockResults(){this.mockResults.clear()}async execute(e,r){if(this.pwsh.ended||$()){this.logger.warn("execute() failed (ended)",{cmd:e});return}if(Pe&&this.mockResults.has(e)){let i=this.mockResults.get(e);return r(i.stdout,i.stderr,i.passed)}try{this.logger.debug("execute()",{cmd:e});let i=await mi(()=>this.pwsh.enqueueTask(new Vc.Task(e,(o,n,s)=>r(f(o,a=>st(a,e)),n,s))));return this.logger.log(Oa(i.elapsedMs,7*S),"execute()",{cmd:e,elapsedMs:i.elapsedMs}),i.result}catch(i){this.logger.warn("execute() failed: "+i,{cmd:e});return}}async executeJson(e){let r=await this.execute(Wt(e,Cv),(i,o,n)=>({stdout:i,stderr:o,passed:n}));if(r==null){this.logger.warn("executeJson(): null result",{cmd:e});return}if(v(r.stdout)||M(r.stderr)||!r.passed){this.logger.warn("executeJson(): failed result",y({cmd:e},r));return}try{return JSON.parse(r.stdout)}catch(i){let o=r.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:ir(r.stdout),after:ir(o)}),JSON.parse(o)}}async executeJsonToA(e){return b(this.executeJson(e),r=>Array.isArray(r)?r:[r])}},Fe=Mh;Fe.instance=l(()=>{if(!B)throw new Error("PowerShell isn't available on this platform");return new Mh});async function hk(){return B?Fe.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}var zv=l(async()=>{if(B){let t=await hk();if(M(t))return t}return zc()}),zc=l(()=>(0,Vv.resolve)(Di(),"Pictures"));var Uv=["7artisans","Bower","Canon","Carl Zeiss","Cosina","Fuji","Fujifilm","Goerz","Hasselblad","Hirox","Hoya","Konica","Leica","Leidolf","Lensbaby","Meike","Meopta","Minolta","Neewer","Nikon","Olympus","Opteka","Panasonic","Pentacon","Pentax","Ricoh","Rodenstock","Rokinon","Ross","Samsung","Samyang","Seiko","Sigma","Silor","Soligor","Sony","Sunpak","Tamron","Tiffen","Tokina","Topcon","Venus","Voigtl\xE4nder","Wray","Yongnuo","Zhong Yi","Zuiko"];var lm=["EXIF","EXV","MIE","XMP"];var Wv=P(require("path")),Ao=P(require("process"));function Sh(t){return h(t).replace(/([A-Z])([a-z])/g,(e,r,i)=>"_"+r.toLowerCase()+i).replace(/[A-Z]+|[0-9]+/g,e=>"_"+e).replace(/^_/,"")}function gk(t){return"PS_"+Sh(t).toUpperCase()}var FQ=W(y({},Ao.env)).map(t=>pr?Object.freeze(t):t).get(),x=Ae("Paths","Logging","Networking","Processes","Tools","Updates","Desktops","Volumes","Db","HealthChecks","Filters","Previews","Reporting","Deduping","Sidecars","Sync","Tagging","Web","Subscriptions"),mm=Object.freeze([x.Db,x.HealthChecks,x.Filters,x.Previews,x.Reporting,x.Deduping,x.Sidecars,x.Sync,x.Tagging,x.Web,x.Subscriptions]),Ph=Object.freeze(x.values.filter(t=>!mm.includes(t))),Do=t=>M(t)&&t!=="undefined"?h(t).trim():void 0,Hr=class{constructor(e){this.opts=e;this._persist=!1;this.listeners=[]}hasValue(){return this._value!=null}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){let r=T(e,Ao.env);for(let i of[this.key,...F(this.opts.envAliases)]){let o=f(r[i],n=>this.opts.fromEnv(n));if(o!=null)return o}}importFromEnv(e=Ao.env){if(!this._persist)return f(this.readFromEnv(e),r=>this.setValue(r))}importFromFile(e){if(!(this.hasValue()&&!this._persist))return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){et(this.listeners,r=>r===e)}onChange(){let e=this.value;this.listeners.forEach(r=>r(e))}get name(){return this._name}_setName(e){if(this._name!=null)throw new Error("cannot set name twice");this._name=e,this._key=gk(e),this.importFromEnv()}get persist(){return this._persist}get key(){return this._key}get category(){return this.opts.category}get categoryType(){return mm.includes(this.category)?"library":"system"}get transient(){return this.opts.transient===!0}get advanced(){return ee(this.opts.advanced,e=>e(),()=>!0)}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}maybeSetValue(e){e!=null&&(this.value=e)}set valueAndEnv(e){this.value=e,this.addToEnv(Ao.env,e)}get envValueOrDefault(){return this.opts.toEnv(this.valueOrDefault)}set tmpValue(e){this._persist=!1,this.addToEnv(Ao.env,e),this.setValue(e)}set tmpValueIfUnset(e){this.isUnset()&&(this.tmpValue=e)}setValue(e){let r=this._value,i=this.opts.toEnv(e),o=this.opts.fromEnv(i);return this._value=o,nt(r,this._value)||this.onChange(),this._value}get defaultValue(){return Mr(this.opts.defaultValue)}get exampleValue(){return W(this.opts.exampleValue).flatMap(e=>e()).filter(M).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return this.value!=null?this.value:this.defaultValue}maybeAddToEnv(e,r){let i=T(e,Ao.env);return this.hasValue()&&(i[this.key]=Do(this.opts.toEnv(T(r,this.valueOrDefault)))),i}addToEnv(e,r){let i=T(e,Ao.env);return i[this.key]=Do(this.opts.toEnv(T(r,this.valueOrDefault))),i}deleteFromEnv(e){let r=T(e,Ao.env);return delete r[this.key],f(this.opts.envAliases,i=>i.forEach(o=>{delete r[o]})),r}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),d("Settings."+this.name).info(".unset()"),this}addToJSON(){return{}}toJSON(){return{key:this.key,value:this.value,defaultValue:this.opts.defaultValue}}},hn=class extends Hr{constructor(e){super(y({toEnv:Do,fromEnv:Do,defaultValue:void 0},e))}hasValue(){return M(this.value)}};function qv(t){return t==null?void 0:t.trim()}var lt=class extends Hr{constructor(e){super(y({toEnv:qv,fromEnv:qv},e))}hasValue(){return M(this.value)}};function Eh(t,e){let r=h(t).toLowerCase();return e.find(i=>i.toLowerCase()===r)}var Fo=class extends Hr{constructor(e){super(y({toEnv:i=>Eh(i,e.validValues),fromEnv:i=>Eh(i,e.validValues)},e));if(this.validValues=e.validValues,this.defaultValue!=null&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}};function yk(t){return q(h(t).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return Y(JSON.parse(e)).map(h)}catch{}for(let r of["\xA6",Wv.delimiter])if(e.includes(r))return e.split(r);return[e]})}function jv(t){return Xs(t)?void 0:ge(yk(t),um)}function bk(t){return ge(um(t),O)}function um(t){return V(Go(t))}var Ne=class extends Hr{constructor(e){super(y({defaultValue:[],fromEnv:jv,toEnv:bk},e))}push(...e){this.value=um([...this.valueOrDefault,...e])}get values(){return um(this.valueOrDefault)}set values(e){this.value=um(e)}removeValueFromEnv(e){f(this.value,r=>this.tmpValue=r.filter(i=>i!==e))}};function wk(t,e){return Hv(jv(t),e)}function Hv(t,e){if(t==null)return;let r=[];for(let i of t){let o=Eh(i,e);o!=null&&r.push(o)}return r}var Ah=class extends Hr{constructor(e){super(y({fromEnv:r=>wk(r,e.validValues),toEnv:r=>f(r,i=>O(V(i)))},e));this.validValues=e.validValues}asValidValues(e){return Hv(e,this.validValues)}addToJSON(){return{validValues:this.validValues}}},We=class extends Hr{constructor(e){super(y(y({},e),{toEnv:Do,fromEnv:G}))}};var Uc=class extends Hr{constructor(e){super(y(y({},e),{toEnv:Do,fromEnv:ii}))}},Vt=class extends Hr{constructor(e){super(y(y({},e),{toEnv:Do,fromEnv:r=>W(r).flatMap(parseInt).map(i=>te(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},bs=class extends Hr{constructor(e){super(y(y({},e),{toEnv:Do,fromEnv:r=>W(r).flatMap(parseFloat).map(i=>te(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},N=class extends Hr{constructor(e){super(y(y({},e),{toEnv:Do,fromEnv:pw}))}};var Ra=require("process"),Kv=Object.freeze(["/usr/local/sbin","/usr/local/bin","/opt/local/sbin","/opt/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),Wc=l(()=>pr),wr=()=>!Wc(),xk=Object.freeze(B?[...Ti(Ra.env.SYSTEMROOT,t=>[t,(0,ka.join)(Ra.env.SYSTEMROOT,"System32"),(0,ka.join)(Ra.env.SYSTEMROOT,"System32","webm")],()=>[]),"C:\\cygwin64\\bin"]:Kv),u={copyAssetsToLibrary:new N({category:x.Paths,description:`Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page's "May PhotoStructure organize your photos and videos?" section. Read more about this setting here: <https://photostructure.com/getting-started/automatic-library-organization/>.`,defaultValue:!0,advanced:()=>!1}),libraryPath:new hn({envAliases:["PS_LIBRARY","PS_LIBRARY_DIR"],category:x.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>wr()?"/home/test/Pictures":Ue()?"/ps/library":zc(),defaultValue:()=>Ue()&&!wr()?"/ps/library":void 0,advanced:()=>!1}),previewsDir:new lt({category:x.Paths,description:`This is the directory that PhotoStructure uses to store preview images. This defaults to the ".photostructure/previews" directory inside your PhotoStructure library. Absolute paths here are supported, but if you keep your library and previews directory separated, take care when you open your library on different computers, as this setting needs to be adjusted for those computers as well.
NOTE: "originalDirs" is recommended instead of this setting; If you get "previewsDir" wrong, your library won't work. If you get "originalsDir" wrong, you just break full-screen zoom and non-transcoded videos.`,defaultValue:()=>".photostructure/previews"}),originalsDir:new lt({category:x.Paths,description:`This is the directory that PhotoStructure uses to store original images when "copyAssetsToLibrary" is enabled. Absolute paths are supported. Relative paths are evaluated from your libraryPath. This setting defaults to ".", which is the same as your PhotoStructure library directory.
If you open your PhotoStructure library on a different computer, and that computer doesn't have access to your originals volume, full-screen zoom won't work, and non-transcoded videos will not play.
This system setting needs to be set appropriately on different computers (it won't be set automatically!)
If you have a large library and want to use an SSD, we recommend you set your libraryPath to your SSD, and use this setting to store your originals on a larger volume, rather than using the "previewsDir" setting.`,defaultValue:()=>"."}),forceOpen:new N({category:x.Paths,description:"DANGEROUS: if set, all previously-existing library locks will be removed. This should only be necessary if the prior PhotoStructure process was not shut down gracefully.",defaultValue:!1,transient:!0}),scanAllDrives:new N({category:x.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new N({category:x.Paths,description:"Deprecated, and will be removed in the next version. If set, PhotoStructure will automatically add your pictures directory to your `scanPaths` setting.",defaultValue:!1,advanced:()=>!1}),scanPaths:new Ne({category:x.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1,exampleValue:()=>wr()?["/path/one","/path/two"]:[zc()]}),cacheDir:new lt({category:x.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free. Note that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory.",exampleValue:()=>wr()?"/tmp/ps_cache_dir":Hd(),defaultValue:()=>Hd()}),neverIgnored:new Ne({category:x.Paths,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),pidfile:new hn({envAliases:["PIDFILE"],category:x.Paths,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),scanLibraryFirst:new N({category:x.Paths,description:"Should PhotoStructure scan your library before all other paths are synchronized?",defaultValue:!1}),scanLibraryLast:new N({category:x.Paths,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!0}),logLevel:new lt({envAliases:["PS_LOG","LOG"],category:x.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc').",defaultValue:()=>Wc()?"error":"info"}),logDir:new lt({category:x.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>uT(),exampleValue:()=>wr()?"/var/log/photostructure":void 0}),logCompression:new N({category:x.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>Wc()}),logElapsedMs:new N({category:x.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new N({category:x.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new hn({category:x.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new N({envAliases:["LOG_STDOUT","PS_STDOUT"],category:x.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new N({category:x.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new N({category:x.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR is set, this defaults to false. See <https://no-color.org/>.",defaultValue:()=>v(Ra.env.NO_COLOR)}),logSql:new N({category:x.Logging,description:"Log SQL queries to the default log level. *This is really chatty* and impacts performance. Normally these log messages are completely disabled.",defaultValue:()=>!1}),localhost:new lt({category:x.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). See <https://letsencrypt.org/docs/certificates-for-localhost/> and <https://photostructure.com/faq/troubleshooting/#windows-firewall-issues>.',defaultValue:()=>"127.0.0.1"}),httpPort:new We({category:x.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),trustProxy:new lt({category:x.Networking,description:`Support for PhotoStructure instances running behind a reverse proxy. See <http://expressjs.com/en/guide/behind-proxies.html>. This setting should either be "false" (don't trust any proxies), "loopback", (only trust localhost), a single subnet (like "127.0.0.0/8"), or a comma-delimited set of subnets.`,defaultValue:"false"}),exposeNetworkWithoutAuth:new N({category:x.Networking,description:`Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.
**Don't enable this unless you know what you are doing**.`,defaultValue:()=>Ue()&&!wr()}),rpcPort:new We({category:x.Networking,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),exiftoolProcsPerChild:new Vt({category:x.Processes,description:"Each PhotoStructure process spins up an ExifTool when needed. Note that the `web`, `sync`, and `sync-file` services all use exiftool, so the total number of exiftool processes can be many times larger than this value.",min:1,max:8,defaultValue:2}),sensitiveEnvRegExp:new lt({category:x.Processes,description:'PhotoStructure spawns a number of processes (including "exiftool" and "ffmpeg"), and passes through environment variables, mostly to ensure locale and TZ settings are correct. To prevent environment values that contain sensitive information, like API access tokens, from either being logged, or being accessed by external tools, all environment variables whose key matches this setting will be removed. This regex is applied case-insensitively.',defaultValue:"key|secret|pass|_user|aws_"}),bounceMinutes:new We({category:x.Processes,description:"PhotoStructure will bounce the web and sync processes periodically. Set to 0 to disable.",defaultValue:60*(wr()?5:he?2:5)}),setupTimeoutMs:new We({category:x.Processes,description:"To prevent unhealthy services running as zombies, they self-terminate if the setup processes are not complete within this amount of time. Note that only the environment variable value is used for this setting.",defaultValue:35*S}),probationMs:new We({category:x.Processes,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*A}),minTimeBetweenServiceRestartsMs:new We({category:x.Processes,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*S}),fatalErrorRatePerMinute:new We({category:x.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),minDiskFreeGb:new We({category:x.Processes,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new Vt({category:x.Processes,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new Fo({category:x.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>rm.BelowNormal,validValues:rm.values}),maxMemoryMb:new Vt({category:x.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.",defaultValue:500,min:256,max:8e3}),maxRssMemoryMb:new Vt({category:x.Processes,description:"PhotoStructure will restart services if their' resident set size consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:250,max:8e3}),maxTasksPerProcess:new Vt({category:x.Processes,description:"PhotoStructure will recycle sync-file processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>wr()?10:200,min:1,max:5e3}),pollIntervalMs:new We({category:x.Processes,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>Wc()?A:5*S}),inspect:new N({category:x.Processes,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,transient:!0,advanced:()=>!0}),ignoreUnhealthyVolumes:new N({category:x.Volumes,description:"When true, PhotoStructure ignores volumes that are not healthy (due to needing filesystem checks, or remote filesystems that are not available).",defaultValue:!0}),validateMountpoints:new N({category:x.Volumes,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist.",defaultValue:!0}),readVolumeUuidFiles:new N({category:x.Volumes,description:`When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume UUID, which can help with cross-host library portability. Set this to false if you don't want PhotoStructure to read these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),writeVolumeUuidFiles:new N({category:x.Volumes,description:`When true, PhotoStructure (tries to) write ".uuid" files into the root directory of volumes, which enables cross-host library portability. Set this to false if you don't want PhotoStructure to try to write these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),forceLocalDbReplica:new N({category:x.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:()=>Ue()&&!wr()}),dbBackupsCount:new We({category:x.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",defaultValue:20}),maxBusyDbMs:new We({category:x.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 2 minutes, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>2*A}),dbTimeoutMs:new We({category:x.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",defaultValue:()=>S}),dbBackupIntervalMinutes:new bs({category:x.Db,description:"How many minutes should elapse between backing of your library database? Note that PhotoStructure vacuums and optimizes the database before a backup is taken. You want this period to be frequent enough such that data loss isn't too painful. Note that backups can cause the webserver to be momentarily unresponsive. Default is every hour.",min:wr()?.5:1,max:60*12,defaultValue:()=>wr()?.5:30}),dbCacheSizeMb:new We({category:x.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:192}),dbBatchSelectSize:new Vt({category:x.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",defaultValue:128,min:1,max:900}),dbBatchUpsertSize:new Vt({category:x.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",defaultValue:16,min:1,max:500}),healthCheckExiftool:new N({category:x.HealthChecks,description:"When true, PhotoStructure verifies ExifTool is available and a valid version.",defaultValue:!0}),healthCheckLibraryIsWritable:new N({category:x.HealthChecks,description:"When true, PhotoStructure verifies the library directory exists, and is writable.",defaultValue:!0}),healthCheckVolumes:new N({category:x.HealthChecks,description:"When true, PhotoStructure verifies volumes as part of periodic health checks.",defaultValue:!0}),healthCheckFreeSpace:new N({category:x.HealthChecks,description:"When true, PhotoStructure verifies that the library and cache volumes have sufficient free space.",defaultValue:!0}),healthCheckDb:new N({category:x.HealthChecks,description:"When true, PhotoStructure verifies that the library database can be read from and written to.",defaultValue:!0}),enableSIMD:new N({category:x.Tools,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to false on macOS due to instability on that platform.",defaultValue:()=>!(wr()||he)}),enableVipsCache:new N({category:x.Tools,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations? This defaults to false to reduce memory consumption.",defaultValue:()=>!1}),showFileInFolderUsesThunar:new N({category:x.Tools,description:`If we're on Linux, should we use Thunar (via dbus) to "show file in folder"?`,defaultValue:!1}),showFileInFolderUsesFileUri:new N({category:x.Tools,description:"Does the showFileInFolderCommand expect a file: URI to the file? If this is false, the native path will be appended instead.",exampleValue:()=>!0,defaultValue:()=>dt}),showFileInFolderCommand:new Ne({category:x.Tools,description:`If set, the first argument will be used as a command (or path to command), and the subsequent arguments (if present) will be used as arguments. The native path to the file or the file: URI will be appended, based on the value given to the "showFileInFolderUsesFileUri" setting. If this is set to an empty array, the default tool for your platform will be used instead: "nautilus -s" on linux, "open -R" on mac, and "explorer /select" on Windows.
This is provided to support Linux desktops that don't use Gnome.`,defaultValue:[]}),dcraw_emuPath:new lt({category:x.Tools,description:'This should be the absolute, native path to the "dcraw_emu" binary on this system. If this is set to "dcraw_emu", PhotoStructure will search your $PATH. See <https://www.libraw.org/docs/Samples-LibRaw.html>.',defaultValue:"dcraw_emu"}),ffmpegPath:new lt({category:x.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc. See <https://photostructure.com/getting-started/video-support/>.',defaultValue:"ffmpeg"}),ffmpegTranscodeArgs:new Ne({category:x.Tools,description:`The following are the default arguments added to transcode requests made to ffmpeg (when ffmpeg is available). The following arguments will proceed the command: "-loglevel error -threads T -i INPUT_FILE_PATH" (where T is replaced by ~half the available CPU threads, and INPUT_FILE_PATH is the full native pathname to the source video). The following arguments will follow the arguments in this setting: "-b:v VIDEO_BITRATE_KBPS OUTPUT_FILE_PATH".
CAUTION: this is an advanced setting. Editing this may cause videos that require transcoding to not be imported, or not be viewable on all browsers and platforms. See <https://forum.photostructure.com/t/hardware-accelerated-encoding-transcoding/166> for more details.`,defaultValue:["-c:a","aac","-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high"]}),heifConvertPath:new lt({category:x.Tools,description:'This should be the absolute, native path to the "heif-convert" binary on this system. If this is set to "heif-convert", PhotoStructure will search your $PATH. See <https://photostructure.com/getting-started/heif-support/>.',defaultValue:"heif-convert"}),powerShellArgs:new Ne({category:x.Tools,description:`The following are the default arguments added to spin up PowerShell on Windows devices.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1> for all arguments that PowerShell.exe accepts.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-5.1> for a description of Bypass.
See <https://forum.photostructure.com/t/eliminate-powershell-profile-and-execution-policy-related-errors/184> for more details about why this needs to be configurable.
(Versions prior to v1.0.0 only specified "-NoLogo").`,defaultValue:["-NoLogo","-NoProfile","-ExecutionPolicy","Bypass"]}),powerShellCulture:new lt({category:x.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),toolPaths:new Ne({category:x.Tools,description:`These paths are appended to the PATH to ensure PhotoStructure can find and run external tools like ffmpeg. Use your operating system's separator to separate paths (":" for mac and linux, ";" for windows).`,defaultValue:()=>bo("SETTINGS_IO_TEST")?Kv:xk}),vlcPath:new lt({category:x.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),openAtLogin:new N({category:x.Desktops,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!ni}),updateChannel:new Fo({category:x.Desktops,description:'TL:DR; keep this on "latest." This setting only applies to PhotoStructure for Desktops, and controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds have not been thoroughly tested. Please only consider changing this if customer support asks you to, and that you have recent backups of your system.',defaultValue:()=>fT(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new N({category:x.Desktops,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new We({category:x.Desktops,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:60*24}),autoHideMenuBar:new N({category:x.Desktops,description:"If true, PhotoStructure for Desktops on Windows and Linux will auto hide the menu bar unless the Alt key is pressed.",defaultValue:!1}),email:new hn({category:x.Reporting,description:"If set, this email will be used for license subscriptions and added to error reports, so we can contact you to help debug the issue. It is not required. Setting a value here does not subscribe you to any marketing emails.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new N({category:x.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new We({category:x.Reporting,description:`Set this to zero to remove all bugs in PhotoStructure.
HUR HUR #DADJOKE
If your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.`,defaultValue:3}),minStreamCorrPct:new Vt({category:x.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),hiddenHomeTags:new Ne({category:x.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", and "Keyword").',defaultValue:()=>["Type"]}),placeholderThumbs:new N({category:x.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),cspReportOnly:new N({category:x.Web,description:"Only report CSP violations. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>.",defaultValue:()=>!1}),cspDirective:new hn({category:x.Web,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src>.",exampleValue:()=>"https://myphotos.example.com"}),readdirCacheSeconds:new We({category:x.Sync,description:"readdir() can take a long time over slow network shares and when directories are very large. This setting controls how long to cache readdir results that are slow (which take >= .5 seconds). Set to 0 to disable readdir() caching.",defaultValue:300}),verifyFileCopies:new N({category:x.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new lt({category:x.Sync,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:`If you chose to copy assets into your library, they will be copied into <originals directory>/<result of this pattern>/<original imagename>.
- See the originalsDir system setting for what your <originals directory> is (it defaults to your library root directory).
- Please encode this path with forward-slashes, even if you're on Windows.
- If you want to add a static path, escape the pathname with single quotes (like "'photos'/y/MM/dd").
- This will always be interpreted as a relative path from your PhotoStructure library.
- See <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.`,defaultValue:"y/y-MM-dd"}),transcodeVideos:new N({category:x.Sync,description:"Should videos that are not in a browser-supported format be transcoded during import? Note that this is a plus-only feature. FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),transcodeBitrateQVGA:new We({category:x.Sync,description:"What max bitrate should PhotoStructure encode QVGA (320 \xD7 240) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:800}),transcodeBitrateUHD:new We({category:x.Sync,description:"What max bitrate should PhotoStructure encode UHD (3840\u2009\xD7\u20092160) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:18e3}),doNotTranscodeMimetypes:new Ne({category:x.Sync,description:`Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "['video/quicktime','video/mp4']").`,defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),doNotTranscodeVideoCodecs:new Ne({category:x.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following video codecs. The video codec may be stored in the "VideoCodec", "CompressorID", or "CompressorName" tags.',defaultValue:()=>["avc1"]}),doNotTranscodeAudioCodecs:new Ne({category:x.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following audio codecs. The audio codec is stored in the "AudioCodec" tag.',defaultValue:()=>["mp4a","sowt"]}),statTimeoutSeconds:new Vt({category:x.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new N({category:x.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncIntervalHours:new We({category:x.Sync,description:`This value controls both how often the sync process discovers new or changed files for any given volume.
Note that this value is the duration between the last completion time and when the next sync should be scheduled.
WARNING: Setting this value to a small value will mean PhotoStructure is constantly scanning your disks, which will add wear and tear and possibly reduce the lifespan of your storage media.
Note that setting this to a zero or negative value will disable automatic scheduling of the sync process.`,defaultValue:24}),rebuild:new N({category:x.Sync,description:"When set, all files in your library will be re-imported (caution: slow!).",defaultValue:!1,transient:!0}),forceSync:new N({category:x.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),skipModelUpdates:new N({category:x.Sync,description:"When set, skip any pending library database updates.",defaultValue:!1,transient:!0}),exitWhenDone:new N({category:x.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),matchSidecarsCaseInsensitively:new N({category:x.Sidecars,description:`If set to true, PhotoStructure will look for sidecar files that match file basenames (with or without the file extension), regardless of case (for example: "IMAGE.XMP" will be a sidecar for "image.jpg").
If set to false, sidecars must match case (so only "image.jpg.xmp" and "image.xmp" will match for "image.jpg").
This defaults to false just to be conservative, but true should be fine in normal cases.`,defaultValue:!1}),defaultSidecarType:new Fo({category:x.Sidecars,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:lm}),writeMetadataToSidecarsIfImage:new N({category:x.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to images into sidecars. If set to false, PhotoStructure will overwrite original images with metadata changes.",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new N({category:x.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to videos into sidecars. If set to false, PhotoStructure will overwrite original videos with metadata changes. This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new N({category:x.Sync,description:'Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents. If this is set to false, the original file will be retained in the same directory. "image.jpg" will be stored as "image_original.jpg".',defaultValue:!1}),fuzzyDateParsing:new N({category:x.Sync,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),fuzzyYearParsing:new N({category:x.Sync,description:`When enabled, PhotoStructure will use directories starting with a number that looks year-like (four digits, 1826-the present) to infer the captured-at time, if all other date parsers have failed. Note that setting this to true "forces" the "fuzzyDateParsing" setting to be true.
To elaborate: PhotoStructure first looks for metadata with a date, then looks for an ISO-compliant YMD timestamp in the filename or path, and then, if "fuzzyDateParsing" or this setting is enabled, a YMD or YM datestamp, and then finally, if this setting is enabled, it looks for a directory that begins with a number that is between 1826-2020.`,defaultValue:!1}),minValidYear:new We({category:x.Sync,description:"If PhotoStructure encounters a year that is less than this value, it will consider it invalid and look elsewhere for dates. The default value, 1826, is the first year a photograph was captured, as per <https://en.wikipedia.org/wiki/History_of_photography>. If you have paintings or other imagery from before this time, you'll want to make this value less than the earliest image in your library.",defaultValue:1826}),useStatToInferDates:new N({category:x.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in the file "birthtime" (on Windows), or the lesser value of "mtime" and "ctime" (on macOS and Linux). Note that these values are not very reliable, as file transfers and backups frequently don't retain these values correctly.`,defaultValue:!0}),usePathsToInferDates:new N({category:x.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.`,defaultValue:!0}),useLibraryPathsToInferDates:new N({category:x.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths *for files that are in your PhotoStructure library. This defaults to false, as prior versions of PhotoStructure may have placed files into incorrect datestamped directories.`,defaultValue:!1}),maxDuplicatePathElements:new We({category:x.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),skipAssetFileUpdates:new N({category:x.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),skipAssetUpdates:new N({category:x.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new N({category:x.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>wr()?!0:(0,Gv.cpus)().length>=8}),excludeNoMediaAssetsOnRebuild:new N({category:x.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),strictDeduping:new N({category:x.Deduping,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true.',defaultValue:!1}),useImageHashes:new N({category:x.Deduping,description:"Building image hashes slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing. If you set this from false to true, and you'd previously imported new assets, you may want to rebuild your library to re-aggregate your assets.",defaultValue:!0}),includeSharpDominantColor:new N({category:x.Deduping,description:"PhotoStructure's image library, sharp, computes the dominant color using a 4096-bin 3D histogram. This doubles image hashing time, but the most-dominant color might be more accurate.",defaultValue:!1}),minExposureSettingsCoeffPct:new Vt({category:x.Deduping,description:"This is the minimum similarity coefficient between exposure setting values two images must be to be considered equivalent. Many cameras actually report different exposure setting values between JPG and RAW: values within 90% of each other should avoid false-positives.",defaultValue:()=>90,max:100,min:0}),minImageCoeffPct:new Vt({category:x.Deduping,description:"This is the minimum image hash similarity coefficient for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image similarity. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minImageGreyscaleCoeffPct:new Vt({category:x.Deduping,description:"This is the minimum image hash similarity coefficient for greyscale images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>93,max:100,min:0}),minColorCoeffPct:new Vt({category:x.Deduping,description:"This is the minimum similarity coefficient found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 50% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minMeanCoeffPct:new Vt({category:x.Deduping,description:"If the average of image and color similarity coefficients exceeds this score, the image will be considered a match.",defaultValue:()=>65,max:100,min:0}),fuzzyDateImageCoeffWeight:new bs({category:x.Deduping,description:'Image similar, by default, is somewhat lax to ensure JPG+RAW and downsampled or edited images are matched together. This is OK when dates must match, and the date is exactly correct. When dates are manually set to something "fuzzy", with perhaps only the year, month, and day, or is inferred by siblings, we need to be more discriminate with image contents to prevent incorrectly grouping photos from that day into a single asset. This value is multiplied with minImageCorrPct and minColorCorrPct to make them more stringent. For example, by default, the minImageCorrPct is 80%, and when the dates are manually set, and this weight is 1.2, the minImageCorrPct for manually-set-date files will be 90%.',defaultValue:()=>1.4,max:2,min:.5}),greyscaleColorThreshold:new Vt({category:x.Deduping,description:"When looking at each pixel in L*a*b* space, a greyscale image is expected to have a* and b* values around 0. If the absolute value of every a* and b* value is under this setting's value, the image will be considered to be greyscale. A value of 0 will force all images to be considered non-greyscale.",defaultValue:5,max:128,min:0}),modeCorrCieDiffWeight:new bs({category:x.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to the CIE94 color delta e. Smaller values apply a larger discount to color deltas.",defaultValue:()=>.6,max:2,min:0}),modeCorrIndexDiffWeight:new bs({category:x.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to difference between the color indexes. Smaller values apply a larger discount to index differences.",defaultValue:()=>.6,max:2,min:0}),gpsErrorMeters:new We({category:x.Deduping,description:`What's the maximum number of meters between GPS fixpoints that should be considered equivalent locations? Note that JPG+RAW pairs from smartphones frequently have different GPS locations due to one being recorded from a rough WiFi fix, and another from aGPS.
GPS position error is ~10-100m. Cellular position error is ~500-750m.`,defaultValue:500}),lensMakes:new Ne({category:x.Deduping,description:"Used to match lensId when Google Takeout has stripped metadata.",defaultValue:()=>Uv}),variantSortCriteria:new Ne({category:x.Previews,description:'How should PhotoStructure pick the "best" asset file variant for a given asset? You may reorder the default fields. Only "resolution", "fileSize", "mtime", "schemeIdx", "isCover", "count", and "isBrowserSupported" are understood: other field names will be ignored. Details about these fields are here: <https://photostructure.com/faq/what-do-you-mean-by-dedupe/#how-does-photostructure-pick-which-file-to-show>.',defaultValue:["resolution","mtime","schemeIdx","isCover","count","isBrowserSupported","fileSize"]}),variantSortCriteriaPower:new bs({category:x.Deduping,description:'Larger variant sort criteria, "resolution" and "fileSize", are scaled to ignore smaller (irrelevant) differences. Scalars are raised to this power to reduce them, so a value of 1 means the criterion is unchanged from the "raw" value.',defaultValue:()=>.15,max:1,min:1e-6}),jpegQuality:new Vt({category:x.Previews,description:"JPEG output quality for previews. Smaller values produce smaller images with lower quality. The default value of 85 strikes a balance that has almost no noticeable compression artifacts, yet still compresses images reasonably well. Values less than ~50-70 can produce noticeable artifacts (depending on the image).",defaultValue:()=>85,max:100,min:10}),dcrawEmuArgs:new Ne({category:x.Previews,description:`What options do you want to pass to dcraw_emu? Note that "-T -o 1 -j -Z -" will always be added (as we need TIFF, sRGB, raw pixels send to stdout). The "-h" arg will be added if the preview image needed is less than half the resolution of the original.
Run "dcraw_emu" with no arguments to get usage help.
"-q 1" sets interpolation quality to "0".
"-H 2" turns on highlight blending.
"-w" uses the camera-set white balance.
Note: changing these values can dramatically (> 10x!) increase the time it takes to render RAW images.`,defaultValue:["-q","0","-w"]}),iccProfileMappings:new Ne({category:x.Previews,description:`Maps an original image profile to a filename stored in the "icc" directory. See that directory's _info.md for more information about this settings.`,defaultValue:["Display P3:DisplayP3Compat-v2-magic.icc","Adobe RGB:AdobeCompat-v2.icc"]}),squareThumbStrategy:new Fo({category:x.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>.',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new Uc({category:x.Previews,description:`When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.
Note that if a video is shorter than this value, the frame will be captured from the middle of the video.`,defaultValue:1.5}),sharpen:new N({category:x.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new N({category:x.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new Ah({category:x.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:Iu(Pd,["uhd8k","uhd5k","qqvga"]),validValues:Pd}),embeddedPreviews:new Ne({category:x.Previews,description:`For larger source images that are greater than 15MP, what embedded image preview tags should be used when present? Using these embedded images speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["PreviewImage","PreviewTIFF","JpgFromRaw"]}),embeddedThumbnails:new Ne({category:x.Previews,description:`Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["ThumbnailImage","ThumbnailTIFF"]}),skipPreviews:new N({category:x.Previews,description:"No previews will be built. The UI will be broken if this is set.",defaultValue:!1}),requireMakeModel:new N({category:x.Filters,description:"Normally PhotoStructure requires images to have EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),minImageDimension:new We({category:x.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new We({category:x.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minVideoDurationSec:new Uc({category:x.Filters,description:"What's the minimum number of seconds for a video to be imported?",defaultValue:2}),minAssetFileSizeBytes:new We({envAliases:["PS_MIN_ASSET_SIZE_BYTES","PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:x.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*Dd}),maxAssetFileSizeBytes:new We({envAliases:["PS_MAX_ASSET_SIZE_BYTES","PS_MAX_ASSET_SIZE","PS_MAX_FILE_SIZE_BYTES"],category:x.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library).",defaultValue:.5*vo}),validateJpegImages:new N({category:x.Filters,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateRawImages:new N({category:x.Filters,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateVideos:new N({category:x.Filters,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!wr()}),validationErrorBlocklist:new Ne({category:x.Filters,description:`If any of the following patterns match a validation error found in a photo or video, the file will be considered corrupt and not be imported into your library.
Note the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message, so, for example, a value of "caution" will ignore any error message that contains the string "caution".`,defaultValue:()=>["Cannot determine format of input stream","corrupt","error","failed","invalid","not a .+ file","nothing was written into output file","partial file","Premature end of .+ file"]}),tagCamera:new N({category:x.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new N({category:x.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new N({category:x.Tagging,description:`Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you'll need to "Rebuild" your library to make the setting take effect).`,defaultValue:!0}),tagYMD:new Fo({category:x.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["y","ym","ymd",""]}),tagDateFromStat:new N({category:x.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!wr()}),tagKeywordsFromPath:new N({category:x.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new N({category:x.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new lt({category:x.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new lt({category:x.Tagging,description:`PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "Objects\u2283Tools\u2283Hammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don't want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.`,defaultValue:"/|>\u2283"}),tagFileType:new N({category:x.Tagging,envAliases:["PS_TAG_TYPE"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0}),tagWhoSynonyms:new Ne({category:x.Tagging,description:'List hierarchical tags that PhotoStructure should interpret to be face names. Digicam uses "People". This is matched case-insensitively.',defaultValue:()=>["People","Face","Faces"]}),tagJsonFaces:new N({category:x.Tagging,description:'Google Takeout provides .json sidecars that may contain the names of the people (or pets) found in the image. Should PhotoStructure import these tags under "Who"?.',defaultValue:!0}),tagFaceRegions:new N({category:x.Tagging,description:'Picasa and other software supports embedding face names within "RegionInfo" metadata. If this setting is enabled, PhotoStructure will import these tags under "Who".',defaultValue:!0}),tagWhoNames:new Ne({category:x.Tagging,description:`This is a list of tags that will be examined for strings or string arrays. All values associated to these fields will be interpreted as names. Note that "dotted notation" is supported.
Set this value to an empty array to disable scanning for person names.`,defaultValue:["People","PersonInImage","PersonInImageWDetails.PersonName","PersonInImageName"]}),tagNamesFormatter:new Fo({category:x.Tagging,description:`How should PhotoStructure format the "Who" tags for assets whose files are tagged with "people" strings?
"as-is" will tag names directly to "Who", so, "Who/Albert Einstein".
"family/given" will tag "Who/Einstein/Albert" (for regions that provide given names first). The default is "as-is," because discerning given and family names aren't reliably inferable.
See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"as-is",validValues:["as-is","family/given"]}),tagNamesDefaultFamily:new lt({category:x.Tagging,description:'If a name is missing a family name, if this value is not blank, it will be provided as a default. If this value is blank, the name tag will be Who/given. Note that this setting is only used if "tagNamesFormatter" is set to "family/given".',defaultValue:"-"}),tagNamesCapitalizedAsFamily:new N({category:x.Tagging,description:"Assume uppercased names are family names (this is common practice in geneology).",defaultValue:!0}),tagNamesOrder:new Fo({category:x.Tagging,description:`How should PhotoStructure parse people's names? Note that this setting is only used if "tagNamesFormatter" is set to "family/given". See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"western",validValues:["western","eastern"]}),tagNamesSurnamePrefixes:new Ne({category:x.Tagging,description:'List all family name prefixes to be considered part of the family name. These are matched case-insensitively. This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>["A","D\u2019","Da","De la","De las","De","Del","Della","Den","Des","Di","Du","La","Las","Le","Li","Lo","Mc","Mac","op de","ten","ter","Van \u2018t","van der","van","von der","von","z","zu"]}),tagNamesSurnames:new Ne({category:x.Tagging,description:`List all family names you expect in tags that are not single words that are found at the end of a tagged name. Hyphenated family names (like "Ocasio-Cortez") do not need to be listed here: only compound family names, and if your language doesn't separate family names with whitespace. In the latter case, either include all family names, or include all givenNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesGiven:new Ne({category:x.Tagging,description:`List all given names you expect in tags that are not single words. Hyphenated given names (like "Rose-Ann") do not need to be listed here. If your language doesn't separate family names and given names with whitespace, either include all given names, or include all familyNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesFamilySurrounds:new Ne({category:x.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added as a family name. As an example, if you use the default "()", then "Michelle LaVaughn (Robinson) Obama" will be name tagged with both "Who/Robinson/Michelle LaVaughn" and "Who/Obama/Michell LaVaugn". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["()"]}),tagNamesGivenSurrounds:new Ne({category:x.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added to the end of the given name with the surrounds retained. As an example, if you use the defaults of "[]" and double-quotes, then "Joe "Joey" Smith" will be name tagged with Who/Smith/Joe "Joey". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["[]",'""']}),tagNamesLexical:new N({category:x.Tagging,description:'Assume any name with a comma is in "lexical name order", which is always "lastname, given name(s)". If the given name is found to be "sr.", "senior", "jr.", or "junior", the name will be considered to be in western order ($givenNames $familyName, $modifier), and the $modifier will be added to the $givenNames. If this is set to false, commas are ignored.',defaultValue:!0}),excludedRootTags:new Ne({category:x.Tagging,description:"Keywords starting with the given roots will be omitted from your PhotoStructure library.",defaultValue:()=>["http:","https:"]}),tagDisplayNameFS:new lt({category:x.Tagging,description:`What should PhotoStructure call the "root" tag for browsing by filesystem paths? Note that this value is only for the UI, and will update the "_displayName" of the /fs/ tag: this value won't change the URL path from be "/tag/fs/.../". Reasonable options that have been suggested include "Folder", "Directory", "Drive", "File", "Path", "Volume", or "Computer".`,defaultValue:"Folder"}),tagAlbums:new N({category:x.Tagging,description:'Should PhotoStructure look for $tagJsonAlbumFilename (by default, "metadata.json") files in the same directory as asset files for album titles?',defaultValue:!0}),tagAlbumFilenames:new Ne({category:x.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the file that PhotoStructure should look for with album metadata? This can be JSON, XMP, MIE, or EXIF encoded.`,defaultValue:["metadata.json"]}),tagAlbumTitle:new lt({category:x.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.title"}),tagAlbumTitleHierarchies:new N({category:x.Tagging,description:'If true, album titles will be split as hierarchical keywords. If false, album titles will not be split, and all albums will be under the "Albums" root tag.',defaultValue:!1}),tagAlbumDescription:new lt({category:x.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.description"}),tagAlbumDate:new lt({category:x.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.date"}),tagAlbumsExcluded:new Ne({category:x.Tagging,description:'For "metadata.json" albums, some are automatically generated. If the title or description includes any given string, it will be ignored.',defaultValue:["Album for automatically uploaded content"]}),pickPlanOnWelcome:new N({category:x.Subscriptions,description:'If set to true, the welcome page flow will redirect to https://account.photostructure.com/plans to have you pick between "plus" and "lite". If set to false, the welcome page will continue directly to the settings page with a "lite" license. You can still upgrade to a paid plan later from the main menu or the about page, even if this is false.',defaultValue:!0}),autoRefreshLicense:new N({category:x.Subscriptions,description:`PhotoStructure uses cryptographically signed licenses to locally store your current plan subscription status. These licenses are only valid for the current subscription period, and must be refreshed when your subscription renews or converts from a free trial to a paid subscription. To minimize the hassle of license renewals, PhotoStructure can automatically renew expired licenses in the background.
If the current license has expired and this value is true, PhotoStructure will make one secure POST request to https://account.photostructure.com/ that contains several lossy one-way hashes of current system metadata. We hash all identifying metadata to only 15 characters to alleviate any privacy concerns. If your plan subscription is active, a new license will be added to your library.
Set this to false and set the "reportErrors" setting to false if you don't want PhotoStructure "phoning home" for any reason.
Note that if this is disabled, license renewals will require manual intervention: click "Upgrade" from the main menu, pick your plan, authenticate, and the license will automatically refresh.`,defaultValue:!0}),license:new hn({category:x.Subscriptions,description:`Subscription licenses are normally saved automatically into both your library and system configuration directories. This setting just provides users with an alternative way to provide a license, if it's more convenient. Any value provided to this setting will be considered in addition to existing license files when PhotoStructure is trying to find the "best" license available.`})};for(let[t,e]of tt(u))e._setName(t);function Tk(t){let e=(v(t)?"":t).split(ka.delimiter);if(B&&v(Ra.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return e.push(...u.toolPaths.valueOrDefault),V(e).filter(M).join(ka.delimiter)}var Pv=l(()=>Tk(Ra.env.PATH)),im=l(()=>{let t=Mt(u).filter(e=>!e.transient);return X(t,e=>[e.categoryType==="system"?0:1,x.indexOf(e.category),e.advanced,e.name])}),Jv=l(()=>im().filter(t=>Ph.includes(t.category))),$v=l(()=>im().filter(t=>mm.includes(t.category)));var Qv;(function(o){o.highlight=()=>!1,o.silent=!1,o.enabled=()=>!o.silent,o.defaultLevelIndex=sm("trace")})(Qv||(Qv={}));var vk=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i,Yv=class{constructor(e){this.silent=!1;this.contexts=[];this.setup(e)}setup(e){this.contexts.length=0;let r=sm(u.logLevel.defaultValue),i=M(e)?e:u.logLevel.valueOrDefault;_(i.split(",")).forEach(o=>{let n=vk.exec(o.trim());if(n==null)Pe||console.error("LogFilterImpl: Ignoring '"+o+"' from "+e);else{let s=h(n[1]).toLowerCase(),a=sm(n[2]);v(s)?r=a:this.contexts.push({prefix:s,levelIndex:a})}}),this.defaultLevelIndex=r}contextOverride(e){if(this.contexts.length===0&&v(e))return;let r=h(e).toLowerCase();return this.contexts.find(i=>r.startsWith(i.prefix))}enabled(e,r){if(this.silent)return!1;let i=sm(e);if(i<=this.defaultLevelIndex)return!0;let o=this.contextOverride(r);return o!=null&&i<=o.levelIndex}highlight(e){let r=this.contextOverride(e);return r!=null&&r.levelIndex>=this.defaultLevelIndex}},qc;function dn(){return qc==null&&(qc=new Yv,u.logLevel.addListener(()=>qc.setup())),qc}var Xv=l(()=>Ct.values[dn().defaultLevelIndex],5*S);function gn(t,e){return dn().enabled(t)?e():void 0}var ws=class{constructor(e){this.valueOf=e;this.store=[]}get length(){return this.store.length}add(e){if(e==null)return;let r=this.valueOf(e);if(r!=null){if(this.store.length===0){this.store.push(e);return}if(xi(r,this.valueOf(this.store[0]))){this.store.unshift(e);return}for(let i=this.store.length-1;i>=0;i--)if(Bi(this.valueOf(e),this.valueOf(this.store[i]))){this.store.splice(i+1,0,e);return}this.store.unshift(e)}}shiftLt(e){if(this.length===0)return[];let r=0;if(xi(this.valueOf(Ou(this.store)),e))r=this.store.length;else for(;xi(this.valueOf(this.store[r]),e);)r++;return r===0?[]:this.splice(0,r)}splice(e,r){return this.store.splice(e,r)}};var iM=P(require("process"));var eM=P(require("util"));var Zv=P(require("luxon"));var Mk=Date.now();function jc(t){let e=u.logElapsedMs.valueOrDefault?Zv.Duration.fromMillis(t-Mk).toFormat("hhhh:mm:ss.SSS"):new Date(t).toISOString();return u.logColor.valueOrDefault?u.logElapsedMs.valueOrDefault?oa(e):na(e):e}var yn=Pe?250:750;var Dh=class{constructor(e={}){this.logLevels={trace:"trace",debug:na("debug"),info:Cu("info "),error:hw("error"),warn:gw("warn ")};this.inspectOptions=y(y({},Dh.defaultInspectOptions()),e),Pe&&(this.inspectOptions.breakLength=255)}formatMeta(e){if(e==null)return;let r=ys(e);return r==null?void 0:(0,eM.inspect)(r,this.inspectOptions)}formatLogEntry(e){let r=dn().highlight(e.ctx)?oa:Nu;return _([jc(e.ts),tM(T(e.from,()=>this.inspectOptions.processName())),this.logLevels[e.l],r(e.ctx),e.msg,this.formatMeta(e.meta)]).map(i=>h(i)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:Gr(),ctx:r,msg:i,meta:o})}},Hc=Dh;Hc.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:Cc+1,processName:Gr});var rM=P(require("util"));var Fh=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e;this.paddedLogLevels=ft(Ct.values.map(e=>[e,zw(e,5," ")]))}formatLogEntry(e){return _([jc(e.ts),Gr(),this.paddedLogLevels[e.l],ji(e.ctx),ji(e.msg),f(e.meta,r=>(0,rM.inspect)(r,this.inspectOptions))]).map(r=>h(r)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:Gr(),ctx:r,msg:i,meta:o})}};var Sk=l(()=>{u.logColor.addListener(()=>cm.unset())}),cm=l(()=>(iM.env.NO_COLOR!=null&&(u.logColor.tmpValue=!1),Sk(),u.logColor.valueOrDefault?new Hc({processName:()=>""}):new Fh));function _a(t){return t?.ts}var oM=!1;function Lh(t){oM=t}var nM=new ws(_a);function Gc(...t){for(let e of t)oM?nM.add(e):console.log(cm().formatLogEntry(e))}function Ih(t=yn*2){return nM.shiftLt(Date.now()-t)}var Oh=class{log(e,r,i,o){Gc({ts:Date.now(),l:e,from:Gr(),ctx:r,msg:i,meta:o})}enabled(e,r){return dn().enabled(e,r)}async flush(){}end(){}},xs=Oh;xs.instance=l(()=>new Oh);var aM=P(require("path")),lM=P(require("timers"));function Kc(t){try{if(M(t))return JSON.parse(t)}catch{}}function sM(t,e){try{if(M(t))return e(JSON.parse(t))}catch{}}var Pk=require("fs");var Jc=class{constructor(e,r={}){this.logDir=e;this.ended=!1;this.mutex=new Jt;this._linesSinceRotate=0;this.pendingWrites=[];this._startIndex=0;this.endTimeoutMs=15*S;this.end=l(async()=>(this.ended=!0,f(this.flushInterval,lM.clearInterval),this.flushInterval=void 0,await this.flush(),this.mutex.serial("close",()=>this._closeCurrent())));this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",()=>this._flush());this.shouldRotate=()=>this._stream==null||this._linesSinceRotate>=this.opts.maxLinesPerFile;this.name="LogWriter("+e+")",this.opts=y({maxLinesPerFile:25e4,errorLogger:xs.instance(),flushEveryMs:yn,processName:Gr},r),this.flushInterval=Vr(()=>this.maybeFlush(),this.opts.flushEveryMs),cx(this)}log(e,r,i,o){if(this.ended&&e==="error")this.opts.errorLogger.log(e,r,i,o);else{let n={ts:Date.now(),l:e,ctx:r,msg:i};o!=null&&(n.meta=o),e==="error"&&(this.writeRecentLogEntries(),this.flush()),this.pendingWrites.push(O(n)+`
`)}}writeRecentLogEntries(){this.pendingWrites.push(...Nv().map(e=>O(e)+`
`)),Rv()}async flush(){await this.mutex.serial("flush",()=>this._flush())}async _flush(){let e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this._rotate();let r=this._stream;if(r==null){this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");return}let i=this.opts.maxLinesPerFile-this._linesSinceRotate,o=e.splice(0,i);this._linesSinceRotate+=o.length,r.write(o.join(""))}}errback(e){return r=>this.opts.errorLogger.log("error","Caught error from "+e,r)}async _rotate(){await this._closeCurrent(),this._currentFile=await dc({nativePath:(0,aM.join)(this.logDir,ku(new Date),ji(this.opts.processName())+".log"),emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=Pk.createWriteStream(this._currentFile).on("error",this.errback("file write stream"))}async _closeCurrent(){let e=this._stream;this._stream=void 0,this._linesSinceRotate=0;let r=this._currentFile;this._currentFile=void 0,await Ki(e),u.logCompression.valueOrDefault&&(await wt(this.opts.flushEveryMs),await f(r,oT))}};async function mM(t,e){let r=Ur(t.name);return b(VT(t.nativePath,e),i=>D(_(ui(i)).map(o=>sM(o,n=>y(y({},n),{from:r})))))}var kh=l(()=>[xs.instance()]);function yc(){return kh().find(t=>t instanceof Jc)}function fm(){let t=u.logDir.valueOrDefault,e=yc();(e==null||e.logDir!==t)&&(Ei(e),e=new Jc(t));let r=[e];(u.logStdout.valueOrDefault||u.tailLogs.valueOrDefault)&&r.push(xs.instance()),kh.set(r)}function $c(){return yc()?.writeRecentLogEntries()}function d(t){return new am(t,kh)}var Na=Ae("main","web","sync","sync-file","info","test","logcat","logtail","list","billing");function cM(t){let e=Na.indexOf(t);return e<0?Na.length+1:e}var Ek=["main","test"],Ak=["main","web","test","info"],Dk=["sync","sync-file"];function Qc(t){switch(t){case"main":case"web":return A;case"sync":case"sync-file":default:return 10*S}}var Fi="";function Xt(){if(v(Fi))throw Error("serviceName() is unset");return Fi}function Yc(t){if(!Pe&&t!==Fi&&Fi!=="")throw new Error("Cannot set service name twice");Fi=t,Gr.unset(),fm()}var Fk=l(()=>[{re:/sync-file|billing/,f:Cu},{re:/sync/,f:Nu},{re:/web/,f:_u},{re:/db/,f:Bu},{re:/main/,f:oa},{re:/info/,f:yw},{re:/test/,f:Ru}]),Gr=l(()=>_([Fi,h(uM.pid)]).join("-"));function tM(t){let e=Fk().find(r=>t.match(r.re));return e!=null?bw(e.f(t)):t}function Lr(){return Fi===Na.main}function Xc(){return Fi===Na.web}function bn(){return Ek.includes(Xt())}function pm(){return!bn()&&Fi!=="info"}function Lk(){return Fi==="sync"}function dm(){return Fi==="sync-file"}function Zc(){return Ak.includes(Xt())}function fM(){return Dk.includes(Xt())}var pM=l(()=>Lk()||Pe&&!dm());var dM=P(require("process"));var Ik=new Date().getFullYear(),Ok=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.

Copyright \xA9 2017-${Ik}, PhotoStructure Inc.

Running this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,hM={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",list:"List all paths in a Library.",logcat:"Chronologically sort and pretty-print PhotoStructure logfiles.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."};function gM(t){return t.on("--help",()=>{console.log(`
`+go(Ok,{maxLineLen:dM.stdout.columns??78,prefix:""}).join(`
`)+`
`)})}var Rh=class{constructor(e,r,i){this.serviceName=e;this.args=r;this.additionalDescription=i;this.plugins=[];Yc(e)}add(...e){return this.plugins.push(...e),this}async parse(){let e=gM(yM.program.description(hM[this.serviceName]+Ti(this.additionalDescription,i=>`

`+i,()=>"")));f(this.args,i=>{e=e.arguments(i)});for(let i of this.plugins)e=i.beforeParse(e);e.version(Tt,"--version","Output the version number (spoiler: it's "+Tt+")"),e.parse(bM.default.argv);let r=e.opts();for(let i of this.plugins)await i.afterParse(r);return e}};var wM=P(require("process"));function Ba(t){return I(wM.default.env.__is_daemon)||I(t?.daemon)||!v(t?.pidfile)}var _h={beforeParse:(t,e=!1)=>(t.option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.'),e||t.option("--info|--verbose",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.'),t.option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.').option("--color","Enable ASCII terminal colors",!0).option("--no-color","Disable ASCII terminal colors"),t),afterParse:t=>{f(t.color,o=>u.logColor.tmpValue=o);let e=I(t.warn),r=I(t.info)||I(t.verbose),i=I(t.debug);e&&(u.logLevel.tmpValue="warn"),r&&(u.logLevel.tmpValue="info"),i&&(u.logLevel.tmpValue="debug"),!Ba(t)&&(e||r||i)&&(u.logStdout.tmpValue=!0)}};var xM={beforeParse:t=>{let e=!0;return t.option("--info",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--verbose",'Verbose logging from all processes. Shortcut for "--info --tail". Caution: noisy during imports!').option("--tail","Emit log messages from both this process and all other concurrently running PhotoStructure processes on this host to stdout. This can be really helpful in seeing how PhotoStructure's processes are coordinating work. Caution: very noisy especially during imports. Sets PS_TAIL_LOGS to true. Ignored if daemonized."),_h.beforeParse(t,e),t.option("--force-open,--forceOpen","DANGEROUS: removes all previously-existing library locks. This should only be necessary if the prior PhotoStructure process was not shut down gracefully."),t},afterParse:t=>{if(_h.afterParse(t),I(t.elapsed)&&(u.logElapsedMs.tmpValue=t.elapsed),Ba(t))u.logStdout.tmpValue=!1,u.tailLogs.tmpValue=!1;else{let e=I(t.verbose);e&&u.logLevel.isUnset()&&(u.logLevel.tmpValue="info"),(I(t.tail)||e)&&(u.tailLogs.tmpValue=!0),I(t.forceOpen)&&(u.forceOpen.tmpValue=!0)}}};var RS=P(require("fs-extra"));var OS=P(require("path"));var kk=[[["360"],"GoPro 360 video (QuickTime-based)"],[["3FR"],"Hasselblad RAW (TIFF-based)"],[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["AVIF"],"AV1 Image File Format (QuickTime-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["CZI"],"Zeiss Integrated Software RAW (ZISRAW)"],[["DCP"],"DNG Camera Profile (DNG-like)"],[["DCR"],"Kodak Digital Camera RAW (TIFF-based)"],[["DNG"],"Digital Negative (TIFF-based)"],[["DV"],"Digital Video"],[["ERF"],"Epson RAW Format (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["FFF"],"Hasselblad Flexible File Format (TIFF-based)"],[["FFF"],"FLIR Systems thermal image File Format"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HDP","WDP","JXR"],"Windows HD Photo / Media Photo / JPEG XR (TIFF-based)"],[["HDR"],"Radiance RGBE High Dynamic-Range"],[["HEIC","HEIF","HIF"],"High Efficiency Image Format (QuickTime-based)"],[["IIQ"],"Phase One Intelligent Image Quality RAW (TIFF-based)"],[["INSP"],"Insta360 Picture (JPEG-based)"],[["INSV"],"Insta360 Video (QuickTime-based)"],[["J2C","J2K","JPC"],"JPEG 2000 codestream"],[["JP2","JPF","JPM","JPX"],"JPEG 2000 image [Compound/Extended]"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PEF"],"Pentax (RAW) Electronic Format (TIFF-based)"],[["PNG","JNG","MNG"],"Portable/JPEG/Multiple-image Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Kyocera Contax N Digital RAW"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["X3F"],"Sigma/Foveon RAW"],[["XMP"],"Extensible Metadata Platform sidecar file"]],Et=Ae("RawImage","Sharp","Video","Sidecar","AssetFile","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser"),Rk=l(()=>{let t=new en,e=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"];for(let s of e)t.add(s,Et.RawImage);let r=D(["GIF","JPEG","PNG","PPM","TIFF","WEBP"]);for(let s of r)t.add(s,Et.Sharp);let i=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"];for(let s of i)t.add(s,Et.Video);let o=[...r,"HEIC",...e,...i];for(let s of o)t.add(s,Et.AssetFile);for(let s of lm)t.add(s,Et.Sidecar);for(let s of[...o,...lm])t.add(s,Et.Exif);for(let s of["GIF","JPEG","MP4","PNG","WEBM","WEBP"])t.add(s,Et.SupportedByCurrentBrowser);for(let s of["GIF","JPEG","MP4","PNG"])t.add(s,Et.SupportedByOldBrowser);let n=kk.map(s=>s[0]);for(let s of t.keys()){let a=n.find(m=>m.includes(s));if(a!=null&&a.length>0){let m=t.get(s);for(let c of a)t.has(c)||t.set(c,m)}}return t});function Nh(t){return f(_k(t),e=>Rk().get(e))}var Nk=/\.?([a-z0-9]{2,4})$/i;function _k(t){return f(Nk.exec(h(t)),e=>e[1].toUpperCase())}function Ca(t,e){return ee(Nh(t),r=>r.includes(e),()=>!1)}function hm(t){return Ca(t,Et.Video)}function gm(t){return Ca(t,Et.Sidecar)}function TM(t){return Ca(t,Et.Exif)}function vM(t){return Ca(t,Et.SupportedByCurrentBrowser)}function Bh(t,e){let r=Bk(e);return r===""?t:t+"?"+r}function Bk(t){if(t==null)return"";let e=tt(t).filter(([,r])=>r!=null);return L(e)?"":e.map(r=>r.map(h).map(encodeURIComponent).join("=")).join("&")}var Yi="pslib",Lo="psfile",pi="psnet";var ef=P(require("dns"));function Li(t,e){let r=0,i=new Ji(e),o=n=>(r++,i.getOrSetAsync(O(n),async()=>t(n)));return o.clear=n=>{if(n==null)i.clear();else{let s=O(n);i.deleteIf(a=>s===a)}},o.size=()=>i.size,o.callCount=()=>r,o}var Ck=Li(async t=>{let e=B?await nv():"ping";return le(e,[B?"-n":"-c","1",t],{timeout:5*S})},{maxSize:255,timeoutMs:Fr,clearEveryMs:10*A}),Ch=new RegExp("\\b"+xe(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),zZ=Li(async t=>W(await Ck(t).catch(e=>{console.warn("failed to ping: "+e)})).filter(M).flatMap(e=>Ch.exec(h(e))).map(e=>e[0]).get(),{maxSize:255,timeoutMs:Fr,clearEveryMs:10*A});var Vk=new RegExp("^"+Ch.source+"$"),zk=Li(async t=>{let e=Vk.exec(t)==null?t:await MM(t);return h(e).toLowerCase().normalize()},{maxSize:128,timeoutMs:Fr}),Uk=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function Vh(t){return Uk.exec(t)!=null}function SM(t){let e=t.split(".").map(r=>G(r)).filter(r=>St(0,255,r));return e.length===4?e:void 0}var PM=Li(async t=>{if(!v(t)){if(SM(t)!=null)return[t];try{return await ef.promises.resolve4(t)}catch(e){tf().warn("No name found for "+t);return}}},{maxSize:256,timeoutMs:Fr,clearEveryMs:10*A}),tf=l(()=>d("nslookup"));U(()=>H(()=>MM.clear()));var MM=Li(async t=>{try{let e=await Oe(()=>Vh(t)?t.startsWith("127.")?["localhost"]:["127.0.0.1"]:SM(t)!=null?ef.promises.reverse(t):ef.promises.resolve4(t),5*S);if(e==null)return tf().info("nslookup("+t+"): timeout"),t;let r=e.find(M);return r??(tf().warn("No name found for "+t),t)}catch(e){return tf().warn("Failed to look up "+t+", using name.",e),t}},{maxSize:256,timeoutMs:Fr,clearEveryMs:10*A});async function EM(t,e){return v(t)||v(e)?!1:Ve(t,e)||Vh(t)&&Vh(e)?!0:ga(PM(t),PM(e),(r,i)=>r.some(o=>i.includes(o)),()=>!1)}var Wk=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;async function qk(){let t=await le("mount",[],{timeout:J});return D(t.split(`
`).map(e=>f(Wk.exec(e),r=>{let[i,o,n]=r.slice(1),s=n.split(",").map(a=>a.trim());return{filesystem:i,mountpoint:o,options:s}})))}var AM=l(async()=>tn(await qk(),async t=>t.options.includes("nobrowse")||t.options.includes("quarantine")||await jk(t.mountpoint)).then(t=>t.map(e=>e.filesystem)),br);async function jk(t){let e=Me.for(t),r=await be(await e.childNames(),i=>i.filter(o=>!o.startsWith(".")).map(o=>o.toLowerCase()).sort(),()=>[]);return nt(r,["applications","photostructure.app"])}function zh(t){return G(t,{defaultValue:0})*1024}var Hk=["devfs"],Gk=["udev","tmpfs","devtmpfs","shm"],Kk=he?Hk:Gk,Jk=["/boot/efi","/dev/shm"];async function Ts(t,e){let r=he?await AM():[],i=["-k","-P"];t&&i.push("-l"),M(e)&&i.push(e);let o=await le("df",i,{timeout:J,ignoreStderr:!0,ignoreExitCode:!0});return Eo(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],o).map(s=>({filesystem:s.Filesystem,size:zh(s["1024-blocks"]),used:zh(s.Used),available:zh(s.Available),mountpoint:s["Mounted on"]})).filter(s=>{let a=h(s.filesystem),m=h(s.mountpoint);return M(m)&&!Jk.includes(m)&&M(a)&&!r.includes(a)&&!Kk.includes(a)})}var vs=l(async()=>{if(!dt||Ue())return!1;try{return(await je(rf,["version"],{timeout:J,ignoreStderr:!0})).code===0}catch(t){return!1}}),rf="gio",DM=["mount","--monitor","--anonymous"],$k=l(()=>d("Gio.gioVolumes()")),Va=l(()=>Oe(async()=>{let t=await Yk(),e=(await Cl(t.map(async r=>{let i=await Ts(!1,r.nativePath).catch(n=>{$k().warn("Failed to df "+r+": "+n)}),o=f(i,n=>n[0]);return f(o,n=>n.mountpoint=r.nativePath),o}))).filter(r=>r.size>0);return Promise.all(e.map(async r=>be(Qk(r.mountpoint),i=>(r.remoteHost=i.remoteHost,r.remoteShare=i.remoteShare,r.label=i.displayName,r.remote=!0,r),()=>r)))},br,()=>d("Gio.gioVolumes").warn("timed out after "+br+"ms")),ss),Xk=d("Gio.getRemoteInfo()"),Qk=Li(async t=>{try{let e=(await le(rf,["info",t],{timeout:J})).split(/[\n\r]+/),r=q(e.find(i=>i.startsWith("uri: ")),i=>new URL(st(i,"uri: ")));return{displayName:f(e.find(i=>i.startsWith("display name: ")),i=>st(i,"display name: ")),remoteHost:f(r,i=>i.hostname),remoteShare:W(r).flatMap(i=>i.pathname).flatMap(i=>st(i,"/")).flatMap(i=>hr(i,"/")).flatMap(decodeURIComponent).filter(M).get()}}catch(e){Xk.warn("gio info failed",{mountpoint:t,err:e});return}},{maxSize:255,timeoutMs:Fr,clearEveryMs:10*A}),of=l(async()=>b(Me.for("/proc/mounts").readLines(),t=>t.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1])),ss);async function Yk(){return await vs()?Cl(await b(of(),t=>t.map(e=>Me.for(e).clear().childDirectories()))):[]}var Ms=P(require("luxon"));function Uh(t,e,r){return t!=null&&e!=null&&Math.abs(t.getTime()-e.getTime())<=r}function nf(t,e=2500){return t==null?!1:ra(t)?Uh(t,new Date,e):Math.abs(t-Date.now())<e}function Wh(t,e=5*S){return C(t)&&Date.now()-t<=e}function FM(t=new Date){return[t.getFullYear(),jt(t.getMonth()+1),jt(t.getDate()),"-",jt(t.getHours()),jt(t.getMinutes()),jt(t.getSeconds())].join("")}function qh(t=new Date){return[t.getUTCFullYear(),jt(t.getUTCMonth()+1),jt(t.getUTCDate()),"-",jt(t.getUTCHours()),jt(t.getUTCMinutes()),jt(t.getUTCSeconds())].join("")}function jh(t){return Ms.Duration.fromMillis(t).toFormat("m:s.S")}function Hh(t){return W(t).filter(M).map(e=>Ms.DateTime.fromISO(e)).filter(e=>e.isValid).map(e=>e.toMillis()).get()}function Gh(t){return f(Zk(t),e=>e*100+sf(t.millisecond))}function Zk(t){return t==null||!t.isValid?void 0:G(t.toFormat("yMMddHHmmss"))}function sf(t){return Math.floor(t/10)}function Kh(t,e){if(t==null||t<0)return;let r=t,i=()=>{let g=r%100;return r=Math.floor(r/100),g},o=10*i(),n=i(),s=i(),a=i(),m=i(),c=i();return{year:r,month:c,day:m,hour:a,minute:s,second:n,millisecond:o,zone:f(e,g=>Ms.Info.normalizeZone(g))}}function ym(t,e){return f(Kh(t,e),r=>Ms.DateTime.fromObject(r))}function bm(t,e){return f(ym(t,e),r=>r.toMillis())}function af(t){let e=new Date(t);return G([e.getFullYear(),...[e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),sf(e.getUTCMilliseconds())].map(jt)].join(""))}function Jh(t,e){return Gh(ym(t).plus(e))}function lf(t){return new $h(y({name:D([t.cmd,...t.args]).join(" "),childFactory:()=>Th(t.cmd,t.args,30*A),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},t))}var $h=class{constructor(e){this.startMs=Date.now();this._stopped=!1;this.logger=l(()=>d("WatchedChild("+D([this.name,this.pid]).join(":")+")"));this.startRate=new on(2*A);this.mutex=new Jt;this._ended=!1;this.onError=async(e,r)=>{let i=Gi(e)||Gi(r),o=new ue({message:e+f(r,ae),cause:nc(r)?r:void 0}),n=Gt(o),s={src:e,fatal:i,ignorable:n,errToS:ae(r)};if(this.logger().log(n?"warn":"error","onError()",s),this._ended||n)return;if(this.lastError=o,re(e,o),i)return this.end();if(this.opts.onError(e,r))return this.logger().warn("onError requested restart",s),this._restart()};this.name=e.name,this.opts=y({dataSep:`
`,maxErrorsPerMinute:3,endableRank:me.first,exitCommand:"",restartOnExit:!0},e),this.endTimeoutMs=Qc(this.name),ts(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}async end(){return this._ended=!0,this._stop()}get proc(){return this.cp}get pid(){return f(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return ee(this.pid,e=>kc(e),async()=>!1)}notRunning(){return Pt(this.running())}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}async _stop(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});let e=this.cp;return this.cp=void 0,e==null?!0:this.stopChild(e)}async stopChild(e){return await W(this.opts.exitCommand).filter(M).flatMap(r=>W(e).flatMap(i=>i.stdin).filter(i=>i.writable).forEach(i=>pt(()=>i.write(r+`
`))).map(Ki).get()),om(e,this.endTimeoutMs)}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:Zs(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){if(this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),this._ended||$())return!1;if(!e&&this.startRate.msSinceLastEvent<u.minTimeBetweenServiceRestartsMs.valueOrDefault){this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:u.minTimeBetweenServiceRestartsMs.valueOrDefault});return}return this.mutex.serial(`WatchedChild(${this.name}).restart`,async()=>(await this._stop(),this._stopped=!1,this._start()))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,async()=>(this._stopped=!1,this._start()))}async _restart(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,async()=>(await this._stop(),this._stopped||this._ended?!1:this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),Wh(this.startMs,u.probationMs.valueOrDefault)&&re("Can't restart "+this.name+", failure rate is too high."+de,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),this.opts.onRestart?.(),this._start())))}async _start(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended||await this.running())return!1;this.startRate.onEvent();let e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);let r="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:i,desc:o})=>{f(i,n=>n.on("error",s=>this.onError(r+o+".on(error)",s)))}),f(this.cp.stdout,i=>un(i,this.opts.dataSep,o=>{this.logger().trace("onDataChunked()",o),this.opts.onStdout(o)})),f(this.cp.stderr,i=>i.on("data",o=>{h(o).includes("Error: Cannot find module")&&re("Failed to start "+this.name+de,new Error(ir(o,256))),this.opts.onStderr?.(o)===!0&&this.onError(r+".stderr.on(data)",o)})),this.cp.on("exit",async(i,o)=>{this.logger().info("onExit",{code:i,signal:o,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?(await this._restart(),this.logger().info("onExit(): finished setting up new child "+this.pid)):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending "+this.pid),this.end())}),!0}};var Qh=P(require("timers"));function mf(t,e){e=Math.ceil(e);let r,i=[],o=(...n)=>{i=n,f(r,Qh.clearTimeout),r=ua(()=>t(...i),e)};return o.reset=()=>{f(r,Qh.clearTimeout),r=void 0},o.now=()=>{o.reset(),t()},o}var eR=d("Mountpoints.localMountpointSetup()");async function LM(){let t=await b(Ts(!1),e=>_(e.map(r=>r.mountpoint)));if(t!=null&&await vs())try{await b(Va(),e=>t.push(...e.map(r=>r.mountpoint)))}catch(e){eR.warn("Failed to fetch gio volumes",e)}return f(t,e=>e.filter(r=>!r.startsWith("/snap/")&&r!=="/dev"))}var tR=/\s([A-Z]:\\)/g,IM=async()=>at(Fe.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(t=>t.map(e=>e.Root)).filter(k).orElse(()=>rR()).map(t=>t.sort()).getRequired(),rR=async()=>{let t=(await le(await ov(),["fsinfo","drives"],{timeout:10*S})).trim(),e=[],r;for(;(r=tR.exec(t))!==null;)e.push(r[1]);return e};var iR=()=>B?IM():LM(),OM;function kM(t){OM=t,oR()}var oR=l(async()=>{bn()?U(async()=>{let t=d("Mountpoints.localMountpointSetup()");he&&(t.info("Setting up Mac diskutil activity watcher"),vt.setTTL(ss),RM()),dt&&(await vs()&&(t.info("Setting up Linux gio mount monitor"),vt.setTTL(ss),_M()),await nR()&&(t.info("Setting up Linux findmnt mount monitor"),vt.setTTL(ss),NM()))},30*S).unref():await cc([Ei(RM.clear()),Ei(_M.clear()),Ei(NM.clear())])}),vt=l(async()=>(await li(()=>Qt(OM,iR),{maxRetries:3,onRetryWaitUntil:r=>wt(r*1500)}).catch(r=>{re("mountpoints() failed",r)}))?.sort(),br);U(()=>H(()=>vt.unset()));var RM=l(()=>lf({cmd:"diskutil",args:["activity"],onStdout:mf(()=>vt.unset(),1.5*S)})),_M=l(()=>lf({cmd:rf,args:DM,onStdout:mf(()=>{Va.unset(),of.unset(),vt.unset()},1.5*S)})),nR=l(async()=>{if(!dt)return!1;try{return(await je("findmnt",["--version"],{timeout:J,ignoreStderr:!0})).code===0}catch(t){return!1}}),NM=l(()=>lf({cmd:"findmnt",args:["--poll"],onStdout:mf(()=>{of.unset(),vt.unset()},1.5*S)}));function Kr(t,e){let r=Gl("vol."+t,()=>li(e,{maxRetries:2,timeoutMs:J,errorIsRetriable:i=>Gt(i)}),jx);return vt.onChange(()=>r.unset()),U(()=>H(()=>r.unset())),r}var sR=Kr("localMountpoints",()=>b(Ts(!0),t=>t.map(e=>e.mountpoint))),BM=Kr("dfPosix",async()=>{let t=await Ts(!1);if(t!=null)return await b(sR(),e=>{t.forEach(r=>{r.remote=!e.includes(r.mountpoint)})}),await vs()&&await b(Va(),e=>t.push(...e)),t});async function CM(t,e){if(!B)throw new Error("wtf");return await b(T(e,()=>aR()),r=>{let i=Zl(r,o=>[o.mountpoint,o]);t.forEach(o=>{f(i.get(o.mountpoint),n=>{o.remote=!0,o.remoteHost=n.host,o.remoteShare=n.share,o.ok=n.ok})})}),t}var VM=["LocalName","RemoteName","Status"],lR=["NETUSE","get",VM.join(",")],zM=/^\\\\(.+?)\\(.+)$/,UM=/^[a-z]:\\?$/i;async function uR(){let t=await Fe.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return t==null?mR():D(t.filter(e=>M(e.LocalName)).map(e=>f(Yh(e.RemoteName),({host:r,share:i})=>f(UM.exec(h(e.LocalName)),o=>({mountpoint:Wt(o[0],"\\"),host:r,share:i,ok:e.Status==="OK"&&e.ConnectionState==="Connected"})))))}function Yh(t){if(!v(t))return W(t).flatMap(e=>zM.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>W(t).flatMap(e=>pt(()=>new URL(e))).filter(e=>M(e.hostname)).map(e=>({host:e.hostname,share:W(e.pathname).filter(M).getOrElse(()=>"/")}))).get()}async function mR(){let t=Ic(),e=await le(t,lR,{timeout:15*S}),r=Eo(VM,e);return D(r.map(i=>f(zM.exec(h(i.RemoteName)),o=>f(UM.exec(h(i.LocalName)),n=>({mountpoint:Wt(n[0],"\\"),host:o[1],share:o[2],ok:i.Status==="OK"})))))}var aR=Kr("netInfoWin",uR);var WM=l(()=>d("DfWin")),qM=Kr("dfWin",async()=>(await cR()).filter(e=>e.ok!==!1&&C(e.size))),fR="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free";function pR(t){return M(t.Root)&&t.Free!=null&&t.Used!=null?y({mountpoint:t.Root,label:t.Description,size:t.Used+t.Free,used:t.Used,available:t.Free,remote:M(t.DisplayRoot)},f(Yh(t.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))):void 0}var dR="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus,UniqueId",hR=/\{([-a-z0-9]{7,})\}/i;function gR(t){return WM().tap({msg:"uniqueId2uuid",result:f(hR.exec(h(t)),e=>e[1]),meta:{s:t}})}function yR(t){if(t.DriveLetter==null||t.DriveLetter==="null"||t.FileSystemLabel==="System Reserved")return;let e=t.Size!=null&&t.SizeRemaining!=null&&M(t.DriveLetter)&&(rd(t.HealthStatus,r=>Ve(r,"Healthy"))||rd(t.OperationalStatus,r=>Ve(r,"OK")));return{mountpoint:t.DriveLetter+":\\",filesystem:t.FileSystem,label:t.FileSystemLabel,uuid:gR(t.UniqueId),size:t.Size,used:t.Size-t.SizeRemaining,available:t.SizeRemaining,remote:!1,ok:e}}async function cR(){let t=await ye(Fe.instance().executeJsonToA(fR).catch(o=>(re("volumeInfoWin(): LocalAndNetCmd failed",o),[])),o=>ld(pR(o))),e=await ye(Fe.instance().executeJsonToA(dR).catch(o=>(re("_localAndNet(): LocalCmd failed",o),[])),o=>ld(yR(o))),r=V([...t,...e].filter(o=>o.ok===!1).map(o=>o.mountpoint)),i=cr(V([...t,...e].map(o=>o.mountpoint)).filter(o=>!r.includes(o)));return WM().info("volumeInfoWin()",{getPsDrive:t,getVolumes:e,mountpoints:i,unhealthy:r}),i.map(o=>y(y({},t.find(n=>o===n.mountpoint)),e.find(n=>o===n.mountpoint)))}async function jM(t){return b(bR(),e=>t.map(r=>ee(e.get(r.mountpoint),i=>y(y({},r),i),()=>r)))}var bR=Kr("mnt2uuidMac",async()=>{let e=(await le("diskutil",["info","-all"],{timeout:J})).split(/^\s*\*{8,12}\s*$/m);return Zl(e,r=>{let i=Zl(r.split(/\s*\n+\s*/),a=>{let[m,c]=a.split(":").map(p=>p.trim());return Ht(["not applicable","no file system"],c)?void 0:[m.toLowerCase(),c]}),o=i.get("mount point"),n=i.get("volume name"),s=i.get("volume uuid");return v(o)?void 0:[o,{label:n,uuid:s}]})});function uf({input:t,lowerCaseKeys:e}){let r={},i;for(let o of ui(t).filter(n=>n.match(/^\s*#/)==null)){let n=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+|#.*?)/gim;for(;(i=n.exec(o))!=null;){let[,s,a,m]=i;r[e?s.toLowerCase():s]=Ku(m,a,a)}}return r}var wR=l(()=>d("LocalVolumesPosix"));async function HM(t){return b(await xR(),e=>dd(V([...e.filter(i=>!i.ignorable).map(i=>i.mountpoint),...t.map(i=>i.mountpoint)])).map(i=>y(y({},t.find(o=>o.mountpoint===i)),e.find(o=>o.mountpoint===i))))}var xR=Kr("localVolumeInfoPosix",async()=>{let t=await le("lsblk",["-P","-b","--output","mountpoint,label,fsused,fsavail,uuid"],{timeout:J}),e=ui(t).map(i=>uf({input:i,lowerCaseKeys:!0})).filter(i=>i!=null),r=await sr(e,async i=>{let o=v(i.mountpoint)||i.mountpoint.startsWith("/snap/")||i.mountpoint==="/boot"||i.mountpoint.startsWith("/boot/")||!await eT(i.mountpoint);return Ho(G(i.fsused),G(i.fsavail),(n,s)=>y({mountpoint:i.mountpoint,label:i.label,uuid:i.uuid,ignorable:o,used:n,available:s,size:n+s},Ue()?void 0:{remote:!1}))});return wR().tap({msg:"lsblk",result:r})});var TR=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i,vR=/^([^:\s]+):(\/.+)$/;async function GM(t){return t.filter(e=>e.remote).forEach(e=>{ee(TR.exec(h(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]},()=>f(vR.exec(h(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]}))}),t}async function KM(t,e){try{return await(e.timeoutMs==null?t():Oe(t,e.timeoutMs,()=>re(e.message+": timeout",void 0,e.context)))}catch(r){re(e.message,r,e.context);return}}var JM=P(require("crypto"));function MR(){let t=(0,JM.randomBytes)(16);t[6]=t[6]&15|64;let e=t.toString("hex");return[e.slice(0,8),e.slice(8,12),e.slice(12,16),e.slice(16,20),e.slice(20)].join("-")}function cf(){return Kl(MR)}var kie=l(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/);var wm=l(()=>d("VolumeUUID")),$M=br/2,Xh=new Map;U(()=>{H(()=>Xh.clear()),vt.onChange(()=>Xh.clear())});async function QM(t){await Dr({name:"addVolumeUUIDs",laters:t.map(e=>()=>SR(e))})}async function SR(t){if(I(t.ignorable)){wm().debug("volumeUUID(): ignorable is true for "+t.mountpoint);return}if(oi(t.ok)){wm().debug("volumeUUID(): remoteOK is false for "+t.mountpoint);return}await b(Sr(Xh,t.mountpoint,()=>Ea(()=>KM(()=>PR(t),{message:"readVolumeUUID("+t.mountpoint+")"}),$M)),e=>t.uuid=e)}async function PR(t){let e=ne.for(t.mountpoint).join(".uuid");if(u.readVolumeUuidFiles.valueOrDefault){let r=await Ea(()=>at(e.readFile("debug")).map(i=>i.toString().trim()).filter(M).get(),$M);if(r!=null&&r.length>6)return wm().debug("Serving UUID from .uuid",{uuid:r,mountpoint:t.mountpoint}),r}if(t.mountpoint==="/")return t.uuid;if(u.writeVolumeUuidFiles.valueOrDefault){let r=ri(t.uuid,cf);if(await e.parent().isReadWritable())try{return await e.writeTxt_(r),wm().info("volumeUUID(): Saved new UUID for "+t.mountpoint,{uuid:r}),r}catch(i){wm().warn("volumeUUID(): Failed to save new UUID for "+t.mountpoint,i)}}return t.uuid}var xm=l(()=>d("Volumes"));async function ER(){let t=await Oe(B?qM():BM(),br,()=>re("Timed out getting local volume metadata"));if(t==null){xm().warn("df failed");return}let e=u.validateMountpoints.valueOrDefault?D(await Dr({name:"nonRpcVolumes: filter unhealthy volumes",laters:t.map(o=>async()=>{try{if(await Sa(o.mountpoint,ba/2))return o;xm().info("validateMountpoints(): "+o.mountpoint+" is not a directory")}catch(n){xm().info("validateMountpoints(): failed to stat "+o.mountpoint,n)}})})):t;e.some(o=>o.remote&&v(o.remoteHost))&&await Oe(B?CM(e):GM(e),10*S).catch(o=>{re("Failed to get remote volume info",o)});let r=T(await(B?e:he?jM(e):HM(e)),e);et(r,o=>!I(o.ignorable)),u.ignoreUnhealthyVolumes.valueOrDefault&&et(r,o=>!oi(o.ok));for(let o of r)o.remote=I(o.remote),q(o.remoteHost,n=>o.remoteHost=n.toLowerCase().normalize().trim());for(let o of r)v(o.label)&&delete o.label;xm().debug("nonRpcVolumes(): before addVolumeUUIDs",r),await QM(r);let i=X(r,o=>o.mountpoint);return xm().debug("_volumes(): final result",{sorted:i}),Object.freeze(i)}var YM;function XM(t){YM=t}var ZM=[],AR=async()=>{try{let t=await Qt(YM,ER);return ge(t,e=>{let r=e.map(i=>i.mountpoint).sort();nt(ZM,r)||(Px(),ZM=r)}),t}catch(t){re("volumes() failed",t);return}},Or=Kr("volumes",AR),koe=l(()=>B?W(qe("SystemDrive")).filter(M).orElse(()=>"C:").map(t=>Wt(t,"\\")).get():"/");async function za(t){return b(Or(),e=>Zh(e,t))}function Zh(t,e){let r=t.filter(i=>va(e,i.mountpoint));return bt(r,i=>Il(i.mountpoint,e))}var hf=P(require("path"));function ff(t,e){let r=0,i=new ke(e.maxSize,e.ttlMs),o=n=>(r++,i.getOrSet(O(n),()=>t(n)));return o.clear=n=>n==null?i.clear():i.delete(O(n)),o.size=()=>i.size,o.callCount=()=>r,o}var pf=P(require("path")),eS=P(require("punycode")),tS=P(require("util"));var ie;(function(t){t[t.Null=0]="Null",t[t.Backspace=8]="Backspace",t[t.Tab=9]="Tab",t[t.LineFeed=10]="LineFeed",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.ExclamationMark=33]="ExclamationMark",t[t.DoubleQuote=34]="DoubleQuote",t[t.Hash=35]="Hash",t[t.DollarSign=36]="DollarSign",t[t.PercentSign=37]="PercentSign",t[t.Ampersand=38]="Ampersand",t[t.SingleQuote=39]="SingleQuote",t[t.OpenParen=40]="OpenParen",t[t.CloseParen=41]="CloseParen",t[t.Asterisk=42]="Asterisk",t[t.Plus=43]="Plus",t[t.Comma=44]="Comma",t[t.Dash=45]="Dash",t[t.Period=46]="Period",t[t.Slash=47]="Slash",t[t.Digit0=48]="Digit0",t[t.Digit1=49]="Digit1",t[t.Digit2=50]="Digit2",t[t.Digit3=51]="Digit3",t[t.Digit4=52]="Digit4",t[t.Digit5=53]="Digit5",t[t.Digit6=54]="Digit6",t[t.Digit7=55]="Digit7",t[t.Digit8=56]="Digit8",t[t.Digit9=57]="Digit9",t[t.Colon=58]="Colon",t[t.Semicolon=59]="Semicolon",t[t.LessThan=60]="LessThan",t[t.Equals=61]="Equals",t[t.GreaterThan=62]="GreaterThan",t[t.QuestionMark=63]="QuestionMark",t[t.AtSign=64]="AtSign",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.OpenSquareBracket=91]="OpenSquareBracket",t[t.Backslash=92]="Backslash",t[t.CloseSquareBracket=93]="CloseSquareBracket",t[t.Caret=94]="Caret",t[t.Underline=95]="Underline",t[t.BackTick=96]="BackTick",t[t.a=97]="a",t[t.b=98]="b",t[t.c=99]="c",t[t.d=100]="d",t[t.e=101]="e",t[t.f=102]="f",t[t.g=103]="g",t[t.h=104]="h",t[t.i=105]="i",t[t.j=106]="j",t[t.k=107]="k",t[t.l=108]="l",t[t.m=109]="m",t[t.n=110]="n",t[t.o=111]="o",t[t.p=112]="p",t[t.q=113]="q",t[t.r=114]="r",t[t.s=115]="s",t[t.t=116]="t",t[t.u=117]="u",t[t.v=118]="v",t[t.w=119]="w",t[t.x=120]="x",t[t.y=121]="y",t[t.z=122]="z",t[t.OpenCurlyBrace=123]="OpenCurlyBrace",t[t.Pipe=124]="Pipe",t[t.CloseCurlyBrace=125]="CloseCurlyBrace",t[t.Tilde=126]="Tilde",t[t.U_Combining_Grave_Accent=768]="U_Combining_Grave_Accent",t[t.U_Combining_Acute_Accent=769]="U_Combining_Acute_Accent",t[t.U_Combining_Circumflex_Accent=770]="U_Combining_Circumflex_Accent",t[t.U_Combining_Tilde=771]="U_Combining_Tilde",t[t.U_Combining_Macron=772]="U_Combining_Macron",t[t.U_Combining_Overline=773]="U_Combining_Overline",t[t.U_Combining_Breve=774]="U_Combining_Breve",t[t.U_Combining_Dot_Above=775]="U_Combining_Dot_Above",t[t.U_Combining_Diaeresis=776]="U_Combining_Diaeresis",t[t.U_Combining_Hook_Above=777]="U_Combining_Hook_Above",t[t.U_Combining_Ring_Above=778]="U_Combining_Ring_Above",t[t.U_Combining_Double_Acute_Accent=779]="U_Combining_Double_Acute_Accent",t[t.U_Combining_Caron=780]="U_Combining_Caron",t[t.U_Combining_Vertical_Line_Above=781]="U_Combining_Vertical_Line_Above",t[t.U_Combining_Double_Vertical_Line_Above=782]="U_Combining_Double_Vertical_Line_Above",t[t.U_Combining_Double_Grave_Accent=783]="U_Combining_Double_Grave_Accent",t[t.U_Combining_Candrabindu=784]="U_Combining_Candrabindu",t[t.U_Combining_Inverted_Breve=785]="U_Combining_Inverted_Breve",t[t.U_Combining_Turned_Comma_Above=786]="U_Combining_Turned_Comma_Above",t[t.U_Combining_Comma_Above=787]="U_Combining_Comma_Above",t[t.U_Combining_Reversed_Comma_Above=788]="U_Combining_Reversed_Comma_Above",t[t.U_Combining_Comma_Above_Right=789]="U_Combining_Comma_Above_Right",t[t.U_Combining_Grave_Accent_Below=790]="U_Combining_Grave_Accent_Below",t[t.U_Combining_Acute_Accent_Below=791]="U_Combining_Acute_Accent_Below",t[t.U_Combining_Left_Tack_Below=792]="U_Combining_Left_Tack_Below",t[t.U_Combining_Right_Tack_Below=793]="U_Combining_Right_Tack_Below",t[t.U_Combining_Left_Angle_Above=794]="U_Combining_Left_Angle_Above",t[t.U_Combining_Horn=795]="U_Combining_Horn",t[t.U_Combining_Left_Half_Ring_Below=796]="U_Combining_Left_Half_Ring_Below",t[t.U_Combining_Up_Tack_Below=797]="U_Combining_Up_Tack_Below",t[t.U_Combining_Down_Tack_Below=798]="U_Combining_Down_Tack_Below",t[t.U_Combining_Plus_Sign_Below=799]="U_Combining_Plus_Sign_Below",t[t.U_Combining_Minus_Sign_Below=800]="U_Combining_Minus_Sign_Below",t[t.U_Combining_Palatalized_Hook_Below=801]="U_Combining_Palatalized_Hook_Below",t[t.U_Combining_Retroflex_Hook_Below=802]="U_Combining_Retroflex_Hook_Below",t[t.U_Combining_Dot_Below=803]="U_Combining_Dot_Below",t[t.U_Combining_Diaeresis_Below=804]="U_Combining_Diaeresis_Below",t[t.U_Combining_Ring_Below=805]="U_Combining_Ring_Below",t[t.U_Combining_Comma_Below=806]="U_Combining_Comma_Below",t[t.U_Combining_Cedilla=807]="U_Combining_Cedilla",t[t.U_Combining_Ogonek=808]="U_Combining_Ogonek",t[t.U_Combining_Vertical_Line_Below=809]="U_Combining_Vertical_Line_Below",t[t.U_Combining_Bridge_Below=810]="U_Combining_Bridge_Below",t[t.U_Combining_Inverted_Double_Arch_Below=811]="U_Combining_Inverted_Double_Arch_Below",t[t.U_Combining_Caron_Below=812]="U_Combining_Caron_Below",t[t.U_Combining_Circumflex_Accent_Below=813]="U_Combining_Circumflex_Accent_Below",t[t.U_Combining_Breve_Below=814]="U_Combining_Breve_Below",t[t.U_Combining_Inverted_Breve_Below=815]="U_Combining_Inverted_Breve_Below",t[t.U_Combining_Tilde_Below=816]="U_Combining_Tilde_Below",t[t.U_Combining_Macron_Below=817]="U_Combining_Macron_Below",t[t.U_Combining_Low_Line=818]="U_Combining_Low_Line",t[t.U_Combining_Double_Low_Line=819]="U_Combining_Double_Low_Line",t[t.U_Combining_Tilde_Overlay=820]="U_Combining_Tilde_Overlay",t[t.U_Combining_Short_Stroke_Overlay=821]="U_Combining_Short_Stroke_Overlay",t[t.U_Combining_Long_Stroke_Overlay=822]="U_Combining_Long_Stroke_Overlay",t[t.U_Combining_Short_Solidus_Overlay=823]="U_Combining_Short_Solidus_Overlay",t[t.U_Combining_Long_Solidus_Overlay=824]="U_Combining_Long_Solidus_Overlay",t[t.U_Combining_Right_Half_Ring_Below=825]="U_Combining_Right_Half_Ring_Below",t[t.U_Combining_Inverted_Bridge_Below=826]="U_Combining_Inverted_Bridge_Below",t[t.U_Combining_Square_Below=827]="U_Combining_Square_Below",t[t.U_Combining_Seagull_Below=828]="U_Combining_Seagull_Below",t[t.U_Combining_X_Above=829]="U_Combining_X_Above",t[t.U_Combining_Vertical_Tilde=830]="U_Combining_Vertical_Tilde",t[t.U_Combining_Double_Overline=831]="U_Combining_Double_Overline",t[t.U_Combining_Grave_Tone_Mark=832]="U_Combining_Grave_Tone_Mark",t[t.U_Combining_Acute_Tone_Mark=833]="U_Combining_Acute_Tone_Mark",t[t.U_Combining_Greek_Perispomeni=834]="U_Combining_Greek_Perispomeni",t[t.U_Combining_Greek_Koronis=835]="U_Combining_Greek_Koronis",t[t.U_Combining_Greek_Dialytika_Tonos=836]="U_Combining_Greek_Dialytika_Tonos",t[t.U_Combining_Greek_Ypogegrammeni=837]="U_Combining_Greek_Ypogegrammeni",t[t.U_Combining_Bridge_Above=838]="U_Combining_Bridge_Above",t[t.U_Combining_Equals_Sign_Below=839]="U_Combining_Equals_Sign_Below",t[t.U_Combining_Double_Vertical_Line_Below=840]="U_Combining_Double_Vertical_Line_Below",t[t.U_Combining_Left_Angle_Below=841]="U_Combining_Left_Angle_Below",t[t.U_Combining_Not_Tilde_Above=842]="U_Combining_Not_Tilde_Above",t[t.U_Combining_Homothetic_Above=843]="U_Combining_Homothetic_Above",t[t.U_Combining_Almost_Equal_To_Above=844]="U_Combining_Almost_Equal_To_Above",t[t.U_Combining_Left_Right_Arrow_Below=845]="U_Combining_Left_Right_Arrow_Below",t[t.U_Combining_Upwards_Arrow_Below=846]="U_Combining_Upwards_Arrow_Below",t[t.U_Combining_Grapheme_Joiner=847]="U_Combining_Grapheme_Joiner",t[t.U_Combining_Right_Arrowhead_Above=848]="U_Combining_Right_Arrowhead_Above",t[t.U_Combining_Left_Half_Ring_Above=849]="U_Combining_Left_Half_Ring_Above",t[t.U_Combining_Fermata=850]="U_Combining_Fermata",t[t.U_Combining_X_Below=851]="U_Combining_X_Below",t[t.U_Combining_Left_Arrowhead_Below=852]="U_Combining_Left_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_Below=853]="U_Combining_Right_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below=854]="U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below",t[t.U_Combining_Right_Half_Ring_Above=855]="U_Combining_Right_Half_Ring_Above",t[t.U_Combining_Dot_Above_Right=856]="U_Combining_Dot_Above_Right",t[t.U_Combining_Asterisk_Below=857]="U_Combining_Asterisk_Below",t[t.U_Combining_Double_Ring_Below=858]="U_Combining_Double_Ring_Below",t[t.U_Combining_Zigzag_Above=859]="U_Combining_Zigzag_Above",t[t.U_Combining_Double_Breve_Below=860]="U_Combining_Double_Breve_Below",t[t.U_Combining_Double_Breve=861]="U_Combining_Double_Breve",t[t.U_Combining_Double_Macron=862]="U_Combining_Double_Macron",t[t.U_Combining_Double_Macron_Below=863]="U_Combining_Double_Macron_Below",t[t.U_Combining_Double_Tilde=864]="U_Combining_Double_Tilde",t[t.U_Combining_Double_Inverted_Breve=865]="U_Combining_Double_Inverted_Breve",t[t.U_Combining_Double_Rightwards_Arrow_Below=866]="U_Combining_Double_Rightwards_Arrow_Below",t[t.U_Combining_Latin_Small_Letter_A=867]="U_Combining_Latin_Small_Letter_A",t[t.U_Combining_Latin_Small_Letter_E=868]="U_Combining_Latin_Small_Letter_E",t[t.U_Combining_Latin_Small_Letter_I=869]="U_Combining_Latin_Small_Letter_I",t[t.U_Combining_Latin_Small_Letter_O=870]="U_Combining_Latin_Small_Letter_O",t[t.U_Combining_Latin_Small_Letter_U=871]="U_Combining_Latin_Small_Letter_U",t[t.U_Combining_Latin_Small_Letter_C=872]="U_Combining_Latin_Small_Letter_C",t[t.U_Combining_Latin_Small_Letter_D=873]="U_Combining_Latin_Small_Letter_D",t[t.U_Combining_Latin_Small_Letter_H=874]="U_Combining_Latin_Small_Letter_H",t[t.U_Combining_Latin_Small_Letter_M=875]="U_Combining_Latin_Small_Letter_M",t[t.U_Combining_Latin_Small_Letter_R=876]="U_Combining_Latin_Small_Letter_R",t[t.U_Combining_Latin_Small_Letter_T=877]="U_Combining_Latin_Small_Letter_T",t[t.U_Combining_Latin_Small_Letter_V=878]="U_Combining_Latin_Small_Letter_V",t[t.U_Combining_Latin_Small_Letter_X=879]="U_Combining_Latin_Small_Letter_X",t[t.LINE_SEPARATOR=8232]="LINE_SEPARATOR",t[t.PARAGRAPH_SEPARATOR=8233]="PARAGRAPH_SEPARATOR",t[t.NEXT_LINE=133]="NEXT_LINE",t[t.U_CIRCUMFLEX=94]="U_CIRCUMFLEX",t[t.U_GRAVE_ACCENT=96]="U_GRAVE_ACCENT",t[t.U_DIAERESIS=168]="U_DIAERESIS",t[t.U_MACRON=175]="U_MACRON",t[t.U_ACUTE_ACCENT=180]="U_ACUTE_ACCENT",t[t.U_CEDILLA=184]="U_CEDILLA",t[t.U_MODIFIER_LETTER_LEFT_ARROWHEAD=706]="U_MODIFIER_LETTER_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_RIGHT_ARROWHEAD=707]="U_MODIFIER_LETTER_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_UP_ARROWHEAD=708]="U_MODIFIER_LETTER_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_DOWN_ARROWHEAD=709]="U_MODIFIER_LETTER_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING=722]="U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING",t[t.U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING=723]="U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING",t[t.U_MODIFIER_LETTER_UP_TACK=724]="U_MODIFIER_LETTER_UP_TACK",t[t.U_MODIFIER_LETTER_DOWN_TACK=725]="U_MODIFIER_LETTER_DOWN_TACK",t[t.U_MODIFIER_LETTER_PLUS_SIGN=726]="U_MODIFIER_LETTER_PLUS_SIGN",t[t.U_MODIFIER_LETTER_MINUS_SIGN=727]="U_MODIFIER_LETTER_MINUS_SIGN",t[t.U_BREVE=728]="U_BREVE",t[t.U_DOT_ABOVE=729]="U_DOT_ABOVE",t[t.U_RING_ABOVE=730]="U_RING_ABOVE",t[t.U_OGONEK=731]="U_OGONEK",t[t.U_SMALL_TILDE=732]="U_SMALL_TILDE",t[t.U_DOUBLE_ACUTE_ACCENT=733]="U_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_RHOTIC_HOOK=734]="U_MODIFIER_LETTER_RHOTIC_HOOK",t[t.U_MODIFIER_LETTER_CROSS_ACCENT=735]="U_MODIFIER_LETTER_CROSS_ACCENT",t[t.U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR=741]="U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_HIGH_TONE_BAR=742]="U_MODIFIER_LETTER_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_MID_TONE_BAR=743]="U_MODIFIER_LETTER_MID_TONE_BAR",t[t.U_MODIFIER_LETTER_LOW_TONE_BAR=744]="U_MODIFIER_LETTER_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR=745]="U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK=746]="U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK=747]="U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_UNASPIRATED=749]="U_MODIFIER_LETTER_UNASPIRATED",t[t.U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD=751]="U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_UP_ARROWHEAD=752]="U_MODIFIER_LETTER_LOW_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD=753]="U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD=754]="U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RING=755]="U_MODIFIER_LETTER_LOW_RING",t[t.U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT=756]="U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT=757]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT=758]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_LOW_TILDE=759]="U_MODIFIER_LETTER_LOW_TILDE",t[t.U_MODIFIER_LETTER_RAISED_COLON=760]="U_MODIFIER_LETTER_RAISED_COLON",t[t.U_MODIFIER_LETTER_BEGIN_HIGH_TONE=761]="U_MODIFIER_LETTER_BEGIN_HIGH_TONE",t[t.U_MODIFIER_LETTER_END_HIGH_TONE=762]="U_MODIFIER_LETTER_END_HIGH_TONE",t[t.U_MODIFIER_LETTER_BEGIN_LOW_TONE=763]="U_MODIFIER_LETTER_BEGIN_LOW_TONE",t[t.U_MODIFIER_LETTER_END_LOW_TONE=764]="U_MODIFIER_LETTER_END_LOW_TONE",t[t.U_MODIFIER_LETTER_SHELF=765]="U_MODIFIER_LETTER_SHELF",t[t.U_MODIFIER_LETTER_OPEN_SHELF=766]="U_MODIFIER_LETTER_OPEN_SHELF",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROW=767]="U_MODIFIER_LETTER_LOW_LEFT_ARROW",t[t.U_GREEK_LOWER_NUMERAL_SIGN=885]="U_GREEK_LOWER_NUMERAL_SIGN",t[t.U_GREEK_TONOS=900]="U_GREEK_TONOS",t[t.U_GREEK_DIALYTIKA_TONOS=901]="U_GREEK_DIALYTIKA_TONOS",t[t.U_GREEK_KORONIS=8125]="U_GREEK_KORONIS",t[t.U_GREEK_PSILI=8127]="U_GREEK_PSILI",t[t.U_GREEK_PERISPOMENI=8128]="U_GREEK_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_PERISPOMENI=8129]="U_GREEK_DIALYTIKA_AND_PERISPOMENI",t[t.U_GREEK_PSILI_AND_VARIA=8141]="U_GREEK_PSILI_AND_VARIA",t[t.U_GREEK_PSILI_AND_OXIA=8142]="U_GREEK_PSILI_AND_OXIA",t[t.U_GREEK_PSILI_AND_PERISPOMENI=8143]="U_GREEK_PSILI_AND_PERISPOMENI",t[t.U_GREEK_DASIA_AND_VARIA=8157]="U_GREEK_DASIA_AND_VARIA",t[t.U_GREEK_DASIA_AND_OXIA=8158]="U_GREEK_DASIA_AND_OXIA",t[t.U_GREEK_DASIA_AND_PERISPOMENI=8159]="U_GREEK_DASIA_AND_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_VARIA=8173]="U_GREEK_DIALYTIKA_AND_VARIA",t[t.U_GREEK_DIALYTIKA_AND_OXIA=8174]="U_GREEK_DIALYTIKA_AND_OXIA",t[t.U_GREEK_VARIA=8175]="U_GREEK_VARIA",t[t.U_GREEK_OXIA=8189]="U_GREEK_OXIA",t[t.U_GREEK_DASIA=8190]="U_GREEK_DASIA",t[t.U_OVERLINE=8254]="U_OVERLINE",t[t.UTF8_BOM=65279]="UTF8_BOM"})(ie||(ie={}));var DR=/^\w[\w\d+.-]*$/,FR=/^\//,LR=/^\/\//;function IR(t,e){if(!t.scheme&&e===!0)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${t.authority}", path: "${t.path}", query: "${t.query}", fragment: "${t.fragment}"}`);if(t.scheme&&!DR.test(t.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(t.path){if(t.authority){if(!FR.test(t.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(LR.test(t.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}}function OR(t,e){return!t&&!e?"file":t}function kR(t,e){switch(t){case"https":case"http":case"file":e?e[0]!==ar&&(e=ar+e):e=ar;break}return e}var He="",ar="/",RR=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,Be=class{static isUri(e){return e instanceof Be?!0:e==null?!1:typeof e.authority=="string"&&typeof e.fragment=="string"&&typeof e.path=="string"&&typeof e.query=="string"&&typeof e.scheme=="string"&&typeof e.fsPath=="function"&&typeof e.with=="function"&&typeof e.toString=="function"}constructor(e,r,i,o,n,s=!1){typeof e=="object"?(this.scheme=e.scheme||He,this.authority=e.authority||He,this.path=e.path||He,this.query=e.query||He,this.fragment=e.fragment||He):(this.scheme=OR(e,s),this.authority=T(r,He),this.path=kR(this.scheme,T(i,He)),this.query=T(o,He),this.fragment=T(n,He),IR(this,s))}get fsPath(){return eg(this,!1)}with(e){if(e==null)return this;let{scheme:r,authority:i,path:o,query:n,fragment:s}=e;return r===void 0?r=this.scheme:r===null&&(r=He),i===void 0?i=this.authority:i===null&&(i=He),o===void 0?o=this.path:o===null&&(o=He),n===void 0?n=this.query:n===null&&(n=He),s===void 0?s=this.fragment:s===null&&(s=He),r===this.scheme&&i===this.authority&&o===this.path&&n===this.query&&s===this.fragment?this:new Ua(r,i,o,n,s)}static parse(e,r=!1){let i=RR.exec(e);if(!i)return new Ua(He,He,He,He,He);let o=i[2]||He,n=df(i[4]||He),s=(i[5]||He).split("/").map(df).join("/"),a=o==="psfile"&&s.startsWith("//")?s.slice(1):s,m=df(i[7]||He),c=df(i[9]||He);return new Ua(o,n,a,m,c,r)}static file(e){let r=He;if(B&&(e=e.replace(/\\/g,ar)),e[0]===ar&&e[1]===ar){let i=e.indexOf(ar,2);i===-1?(r=e.substring(2),e=ar):(r=e.substring(2,i),e=e.substring(i)||ar)}return new Ua("file",r,e,He,He)}static from(e){return new Ua(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...r){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let i;return B&&e.scheme==="file"?i=Be.file(pf.win32.join(eg(e,!0),...r)).path:i=pf.posix.join(e.path,...r),e.with({path:i})}isRootPath(){return this.path==null||this.path===ar}get pathBase(){return this.isRootPath()?"":f(this.path,e=>Ew(e.split(ar),M))}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(ar))})}join(...e){return this.with({path:Wt(this.path,ar)+e.join(ar)})}toString(e=!1){return tg(this,e)}toJSON(){return this}[tS.inspect.custom](){return this.toString()}},_R=Wx?1:void 0,Ua=class extends Be{constructor(){super(...arguments);this._formatted=null;this._fsPath=null}get fsPath(){return this._fsPath==null&&(this._fsPath=eg(this,!1)),this._fsPath}toString(e=!1){return e?tg(this,!0):(this._formatted==null&&(this._formatted=tg(this,!1)),this._formatted)}toJSON(){let e={$mid:1};return this._fsPath!=null&&(e.fsPath=this._fsPath,e._sep=_R),this._formatted!=null&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),this.query&&(e.query=this.query),this.fragment&&(e.fragment=this.fragment),e}},rS={[ie.Colon]:"%3A",[ie.Slash]:"%2F",[ie.QuestionMark]:"%3F",[ie.Hash]:"%23",[ie.OpenSquareBracket]:"%5B",[ie.CloseSquareBracket]:"%5D",[ie.AtSign]:"%40",[ie.ExclamationMark]:"%21",[ie.DollarSign]:"%24",[ie.Ampersand]:"%26",[ie.SingleQuote]:"%27",[ie.OpenParen]:"%28",[ie.CloseParen]:"%29",[ie.Asterisk]:"%2A",[ie.Plus]:"%2B",[ie.Comma]:"%2C",[ie.Semicolon]:"%3B",[ie.Equals]:"%3D",[ie.Space]:"%20"};function iS(t,e){let r,i=-1;for(let o=0;o<t.length;o++){let n=t.charCodeAt(o);if(n>=ie.a&&n<=ie.z||n>=ie.A&&n<=ie.Z||n>=ie.Digit0&&n<=ie.Digit9||n===ie.Dash||n===ie.Period||n===ie.Underline||n===ie.Tilde||e&&n===ie.Slash)i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r!==void 0&&(r+=t.charAt(o));else{r===void 0&&(r=t.substr(0,o));let s=rS[n];s!==void 0?(i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r+=s):i===-1&&(i=o)}}return i!==-1&&(r+=encodeURIComponent(t.substring(i))),r!==void 0?r:t}function NR(t){let e;for(let r=0;r<t.length;r++){let i=t.charCodeAt(r);i===ie.Hash||i===ie.QuestionMark?(e===void 0&&(e=t.substr(0,r)),e+=rS[i]):e!==void 0&&(e+=t[r])}return e!==void 0?e:t}function eg(t,e){let r;return t.authority&&t.path.length>1&&t.scheme==="file"?r=`//${t.authority}${t.path}`:t.path.charCodeAt(0)===ie.Slash&&(t.path.charCodeAt(1)>=ie.A&&t.path.charCodeAt(1)<=ie.Z||t.path.charCodeAt(1)>=ie.a&&t.path.charCodeAt(1)<=ie.z)&&t.path.charCodeAt(2)===ie.Colon?e?r=t.path.substr(1):r=t.path[1].toLowerCase()+t.path.substr(2):r=t.path,B&&(r=r.replace(/\//g,"\\")),r}function tg(t,e){let r=e?NR:iS,i="",{scheme:o,query:n,fragment:s}=t,{authority:a,path:m}=t;if(o&&(i+=o,i+=":"),(a||o==="file")&&(i+=ar,i+=ar),a){let c=a.indexOf("@");if(c!==-1){let p=a.substr(0,c);a=a.substr(c+1),c=p.indexOf(":"),c===-1?i+=r(p,!1):(i+=r(p.substr(0,c),!1),i+=":",i+=r(p.substr(c+1),!1)),i+="@"}c=a.indexOf(":"),c===-1?i+=r(a,!1):(i+=r(a.substr(0,c),!1),i+=a.substr(c))}if(m){if(m.length>=3&&m.charCodeAt(0)===ie.Slash&&m.charCodeAt(2)===ie.Colon){let c=m.charCodeAt(1);c>=ie.A&&c<=ie.Z&&(m=`/${String.fromCharCode(c+32)}:${m.substr(3)}`)}else if(m.length>=2&&m.charCodeAt(1)===ie.Colon){let c=m.charCodeAt(0);c>=ie.A&&c<=ie.Z&&(m=`${String.fromCharCode(c+32)}:${m.substr(2)}`)}i+=r(m,!0)}return n&&(i+="?",i+=r(n,!1)),s&&(i+="#",i+=e?s:iS(s,!1)),i}function oS(t){try{return decodeURIComponent(t)}catch{return t.length>3?t.substr(0,3)+oS(t.substr(3)):t}}var nS=/(%[0-9A-Za-z][0-9A-Za-z])+/g;function df(t){return t.startsWith("xn--")?(0,eS.toUnicode)(t):t.match(nS)?t.replace(nS,e=>oS(e)):t}function Wa(t){return Be.isUri(t)?t:Be.parse(t)}var Tm=ff(t=>q(t,Wr),{maxSize:128,ttlMs:A});U(()=>{H(()=>rg.unset()),Or.onChange(()=>rg.unset())});var rg=l(async()=>b(Or(),t=>Lc(t.map(e=>[Tm(e.uuid),e.mountpoint]))));function sS(t,e){if(v(t)||e==null||v(e.uuid))return;let r=si(t),i=si(e.mountpoint);if(!r.normalize().startsWith(i.normalize()))return;let o=zi(r.slice(i.length),"/");return Be.from({scheme:Lo,authority:Tm(e.uuid),path:o})}function ig(t,e){return(0,hf.join)(t,...e.split("/").slice(1))}async function aS(t,e){if(t.scheme!==Lo)throw new Error("invalid URI: "+t+" (bad scheme)");if(v(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=e!=null&&e.includes(hf.sep);if(r){let o=await za(e);if(o?.uuid!=null&&Tm(o.uuid)===t.authority)return ig(e,t.path)}let i=await b(rg(),o=>o.get(t.authority));if(M(i))return ig(i,t.path);if(r)return ig(e,t.path)}var lS=P(require("path"));var fne=Be.from({scheme:Yi,path:""});function mS(t){let e=u.libraryPath.value;if(v(e)||v(t)||!t.startsWith(e))return;let r="/"+pc({nativePath:e},{nativePath:t});return Be.from({scheme:Yi,path:r})}function uS(t){if(t.scheme!==Yi)throw new Error("invalid URI: "+t+" (bad scheme)");let e=u.libraryPath.value;if(v(e))throw new Error("invalid URI: "+t+" (no library set)");return(0,lS.join)(e,...t.path.split("/"))}var Ss=P(require("path"));function cS(t,e){if(!v(t)){if(e!=null&&e.remote===!0&&M(e.remoteHost)&&M(e.remoteShare))return Be.from({scheme:pi,authority:e.remoteHost,path:Ss.posix.join("/"+e.remoteShare,st(si(t),si(e.mountpoint)))});if(t.startsWith("\\\\"))return Be.file(t).with({scheme:pi})}}async function fS(t,e){if(t.scheme!==pi)throw new Error("invalid URI: "+t+" (bad scheme)");if(v(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=t.path.split("/").slice(1),i=r[0];if(v(i))throw new Error("invalid URI: "+t+" (missing share)");if(B)return`\\\\${t.authority}\\${r.join(Ss.sep)}`;let o=r.slice(1),n=await Or();for(let s of F(n))if(!!s.remote&&Ve(s.remoteShare,i)&&await EM(t.authority,s.remoteHost))return(0,Ss.join)(s.mountpoint,...o);if(await Sa(e))return(0,Ss.join)(e,...o)}var BR=["http:","https:","file:",Lo,pi].map(t=>t+"//");function pS(t){let e=h(t).toLowerCase();return BR.some(r=>e.startsWith(r))}var CR=l(()=>d("UriNormalization"));function dS(t){try{return Be.parse(t).toString()}catch(e){return CR().warn("Failed to normalize invalid URI",{uri:t,err:e}),t}}function VR(t,e){try{if(t==null||e==null)return!1;let r=Be.parse(t),i=Be.parse(e);return r.scheme===i.scheme&&r.authority===i.authority&&r.path.normalize()===i.path.normalize()}catch{return!1}}async function gf(t,e){try{if(t==null||e==null)return!1;if(co(t,e))return!0;let r=t.toString(),i=e.toString();return VR(r,i)?!0:await ga(Ps(r),Ps(i),(o,n)=>o.normalize()===n.normalize(),()=>!1)}catch{return!1}}function yf(t){let e=Wa(t);return V([e.toString(),e.with({path:e.path.normalize("NFC")}).toString(),e.with({path:e.path.normalize("NFD")}).toString()])}var hS=l(()=>d("FileURI"));async function gS(t,e){if(t==null||v(t))return hS().throw("empty nativePath passed to nativePath2uri()",{retriable:!1});let r=l(()=>ze(e,()=>za(t)));return Qt(()=>mS(t),async()=>sS(t,await r()),async()=>cS(t,await r()),()=>Be.file(t))}function zR(t){try{return Be.isUri(t)?t:Be.parse(t,!0)}catch(e){hS().warn("bad URI",{uri:t,err:e});return}}async function Ps(t,e){if(v(t))return;let r=zR(t);if(r!=null)switch(r.scheme){case"file":return r.fsPath;case Lo:return aS(r,e);case pi:return fS(r,e);case Yi:return uS(r);default:throw new Error("unsupported URI: "+t)}}async function UR(t){let e=await Fe.instance().executeJsonToA(["Get-Item -Force -LiteralPath",ds(t.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return W(e).flatMap(r=>r[0]).flatMap(r=>r.Mode).filter(M).flatMap(r=>r.includes("h")||r.includes("s")).getOrElse(()=>!1)}async function WR(t){try{let e=await le("stat",["-f","%f",t.nativePath],{timeout:10*S}),r=G(e);return r!=null?(r&32768)>0:!1}catch(e){return!1}}function bf(t){return t.base.startsWith(".")?!0:B?UR(t):he?WR(t):!1}function bS(t,e,r){let i={};try{for(let o of t)for(let n of yt(o)){let s=o[n]();if(i[n]=T(s,!1),s===!0)return s}return!1}finally{yS(r,e,i)}}function yS(t,e,r){let i=r==null?"warn":"debug";t.log(i,e,r)}async function wS(t,e,r){let i={};try{for(let o of t)for(let n of yt(o)){let s=await o[n]();if(i[n]=s,s)return s}return!1}finally{yS(r,e,i)}}var og=class{constructor(){this.store=new Map}add(e,r){Sr(this.store,e,()=>new Set).add(r)}delete(e,r){f(this.store.get(e),i=>{i.delete(r),i.size===0&&this.store.delete(e)})}find(e){return Yo(e.findIndex((r,i)=>this.store.get(r)?.has(e[i+1])),r=>e.slice(r,r+2))}has(e){return this.find(e)!=null}};var qR=l(()=>d("NeverIgnoredPaths")),jR=l(()=>{u.neverIgnored.addListener(()=>{vm.clear(),zr(),qR().info("Settings.neverIgnored changed",u.neverIgnored.value)}),u.scanPaths.addListener(()=>{vm.clear(),zr()}),H(()=>vm.clear())}),vm=l(()=>(jR(),new Set(_([...u.scanPaths.values,...u.neverIgnored.values]))));function qa(t){return vm().has(t)||vm().has(t.toLowerCase())}function xS(t){return qa(t)?{pathIsNeverIgnored:()=>!1}:void 0}var TS=P(require("path"));var HR=/^\.?NoMedia$/i,vS="NoMedia";function MS(t){return[t,t.toLowerCase(),t.toUpperCase()]}var GR=Object.freeze([...MS("."+vS),...MS(vS)]);function SS(t){return HR.exec(t)!=null}var wf=new Ji({maxSize:1024,timeoutMs:br,clearEveryMs:A});U(()=>H(()=>wf.clear()));U(()=>nr(t=>{t==null?wf.clear():wf.deleteIf(e=>e.startsWith(t))}));var xf=l(()=>d("hasNoMedia()"));async function wn(t){return t==null?!1:qa(t.nativePath)?xf().tap({msg:t+" is never ignored",result:!1}):t instanceof Me?wn(await t.directoryEntry()):SS(t.base)?xf().tap({msg:t+" basename is NoMedia",result:!0}):rn(t.nativePath).some(SS)?xf().tap({msg:t+" parent path is NoMedia",result:!0}):await t.isDirectory()&&await wf.getOrSetAsync(t.nativePath,async()=>{for(let r of GR)if(await tT((0,TS.join)(t.nativePath,r)))return xf().tap({msg:t+" is a directory and has a noMedia child, "+r,result:!0});return!1})===!0?!0:t.isRoot?!1:b(t.parent(),wn)}function PS(t){let e=u.maxDuplicatePathElements.valueOrDefault;for(let r of new Set(t))if(fr(t,i=>i===r)>e)return!0;return!1}var Re=class{constructor(e){this.apply=e}static lift(e){return new Re(e)}static and(...e){return new Re(async r=>{for(let i of e)if(!await i.apply(r))return!1;return!0})}static or(...e){return new Re(async r=>{for(let i of e)if(await i.apply(r))return!0;return!1})}static logged(e,...r){return Ow(r,i=>tt(i).map(([o,n])=>n.asAsync().logged(e,o)))}static andLogged(e,...r){return this.and(...this.logged(e,...r))}static orLogged(e,...r){return this.or(...this.logged(e,...r))}static async andExplain(e,r){let i=[],o=[];for(let n of r)for(let[s,a]of tt(n))(await a.apply(e)?i:o).push(s);return{accepted:i,rejected:o}}asAsync(){return this}and(...e){return Re.and(this,...e)}not(){return new Re(e=>Pt(this.apply(e)))}or(e){return new Re(async r=>await this.apply(r)||await e.apply(r))}async filter(e){return Hl(e,r=>this.apply(r))}logged(e,r){return new Re(async o=>{let n=await this.apply(o);return e.log(n?"debug":"info",[na(r),n?_u("ACCEPT"):Ru("REJECT"),ir(o)].join(" ")),n})}};var KR=d("Snap"),AS=Re.lift(async t=>{if(!await ES())return!1;let r=rn(t.nativePath).indexOf("snap");return r<0?!1:F(await JR()).includes(rn[r+1])}),ES=l(async()=>{if(!dt||Ue())return!1;try{return await le("snap",["--version"],{timeout:10*S,quiet:!0,maxRetries:0}),!0}catch{return!1}}),JR=l(async()=>{if(!await ES())return[];try{return await Eo(["Name","Version"],await le("snap",["list"],{timeout:10*S})).map(t=>t.Name)}catch(t){return KR.warn("snap failed",t),[]}},30*S);var DS=class{constructor(e=Pe){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize()));this.ignorableDirectories=new Set(["#snapshot","__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Support","Applications","arangodb","cache","caches","CacheClip","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iMovie Cache","iTunes Cache","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","SteamApps","System Volume Information","System32","temp","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase()));this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/resources\/media\/face/i,/\/facetile[-_]/i,/\/.*?\.photos?library\/(?!(masters?|originals)\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i];this.systemDirs=V(_([Pa(),qe("APPDATA"),qe("SYSTEMROOT"),qe("ProgramFiles"),qe("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize()));this.ignorableSubdirs=new og;dt&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);let r=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",r),this.addIgnorableSubdirs("cygwin",r),this.addIgnorableSubdirs("cygwin64",r),this.addIgnorableSubdirs("local",r),this.addIgnorableSubdirs("Windows",["Boot","Containers","Cursors","Fonts","Help","Installer","Logs","Microsoft.NET","SoftwareDistribution","System","System32","SysWOW64","Temp"]),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...r]),this.addIgnorableSubdirs("lfs",["objects"]),this.addIgnorableSubdirs("var",["cache","crash","games","lib","local","lock","log","mail","run","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);let i=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",i),this.addIgnorableSubdirs("Perl64",i),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(qe("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("temp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),B&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,r){if(v(e))return;let i=e.toLowerCase().normalize();_(r).forEach(o=>this.ignorableSubdirs.add(i,o.toLowerCase().normalize()))}ignorablePathPredicates(e){let r=xS(e);if(r!=null)return r;let i=e.toLowerCase().normalize(),o=_(rn(i));return{hiddenPosix:()=>o.some(n=>n.startsWith(".")),systemDir:()=>this.systemDirs.some(n=>i.startsWith(n)),ignorableRoot:()=>this.ignorableRootDirectories.has(o[0]),ignorableDirectory:()=>o.some(n=>this.ignorableDirectories.has(n)),ignorablePath:()=>this.ignorableSubdirs.has(o),ignorablePattern:()=>{let n=si(e);return this.ignorableDirectoryPatterns.some(s=>s.test(n))}}}ignorablePath(e){return bS([this.ignorablePathPredicates(e)],e,d("ignorablePath()"))}},FS=l(()=>new DS);function $R(t){return y(y({},FS().ignorablePathPredicates(t)),{notExists:()=>ne.for(t).notExists()})}function Mm(t){return FS().ignorablePath(t)}function LS(t){return Mm(t.nativePath)}function QR(t){let e=t.nativePath.toLowerCase().normalize();return qa(t.nativePath)||qa(e)?{pathIsNeverIgnored:()=>!1}:y(y({},$R(t.nativePath)),{snapDirectory:async()=>dt&&await AS.apply(t),noMedia:async()=>await wn(t)===!0,hidden:()=>bf(t),seemsRecursive:()=>PS(t.pathnames),mountpoint:async()=>be(vt(),r=>r.includes(t.nativePath),()=>!1)})}async function IS(t){return wS([QR(t)],t.nativePath,d("ignorableDirectory()"))}var kS=new Yl;var ne=class extends Me{constructor(e,r){super(e,r);this.nativePath=e;this.pflog=l(()=>d("PosixFile("+this.nativePath+")"));this.uriObject=l(()=>gS(this.nativePath));this.uri=l(()=>b(this.uriObject(),h));this.fileuri=l(()=>Be.file(this.nativePath).toString());this.mountpoint=l(()=>B&&this.nativePath.startsWith("\\\\")?this.for(this.nativePath.split("\\").slice(0,4).join("\\")):b(vt(),e=>this.bestMountpoint(e.map(r=>this.for(r)))));this.etag=l(()=>b(this.stat(),e=>[e.size,e.mtime.getTime()].map(r=>sn.encode(r)).join("-")));this.isMountpoint=l(async()=>await this.isDirectory()&&await be(vt(),e=>e.includes(this.nativePath),()=>!1));this.sidecars=l(async()=>{if(this.isSidecar())return[];let e=await this.parent().childDirectoryEntries(i=>i.base!==this.base&&gm(i.ext)&&(i.name===this.name||i.name===this.base||(u.matchSidecarsCaseInsensitively.valueOrDefault?Ve(i.name,this.name)||Ve(i.name,this.base):!1)||Ur(i.name)===Ur(this.name)||(u.matchSidecarsCaseInsensitively.valueOrDefault?Ve(Ur(i.name),Ur(this.name)):!1)));if(e==null)return[];let r=e.map(i=>this.parent()._directoryEntryChild(i));return Vl(r,i=>i.maxStatMs())});this.shaWithSidecars=l(async()=>{let e=[this,...await this.sidecars()].map(i=>i.nativePath);return(await Sc(cr(e))).toString("base64")},Me.attrTTL)}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(v(e))throw new Error("unexpectedly empty path");if(e instanceof ne)return e;if(e instanceof Me)return this.for(e.nativePath,r);if(pS(e))throw new Error("use forUri");let i=kS.get(e);if(i!=null)return i;let o=ai(e);return kS.getOrSet(o,()=>new ne(o,r))}static forPosix(e){return this.for(e.replace(/\//g,OS.sep))}static forUri(e,r){return b(Ps(e,r),i=>this.for(i))}for(e,r){return ne.for(e,r)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.sidecars.unset(),this}bestMountpoint(e){return bt(e.filter(r=>va(this.nativePath,r.toString())).map(r=>ne.for(r)),r=>W(Il(this.pathnames,r.pathnames)).filter(i=>i>=r.pathnames.length).get())}async isDeleted(e){if(e=await ri(e,()=>this.uri()),this.isUNC)return this.pflog().tap({result:void 0,msg:"isDeleted(): UNC not supported"});if(await this.exists())return this.pflog().tap({result:!1,msg:"isDeleted(): file exists"});if(e==null)return this.pflog().tap({result:void 0,level:"warn",msg:"isDeleted(): missing URI"});if(e=Wa(e),e.isRootPath())return this.pflog().tap({result:void 0,msg:"isDeleted(): uri isRootPath",meta:{uri:e}});if(h(e.pathBase).normalize()!==this.base.normalize())return this.pflog().tap({level:"warn",result:void 0,msg:"isDeleted(): uri isn't correct",meta:{uri:e,expectedBase:this.base,uriBase:e.pathBase}});let r=await this.parent().isDeleted(e.parent());return r==null?this.pflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{uri:e}}):this.pflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted, which means I am deleted.",meta:{parentDeleted:r,uri:e}})}async httpHeaders(){return{ETag:await this.etag(),"Last-Modified":await this.lastModifiedUtc()}}async hide(){let e=await(B?le("attrib",["+h",this.nativePath],{timeout:10*S}).catch(r=>r):he?le("chflags",["hidden",this.nativePath],{timeout:10*S}).catch(r=>r):"");if(M(e)){this.pflog().warn("hide("+this.nativePath+") failed: "+e);return}else return this.clear()}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}async mkNoMedia_(){if(await this.isFile())throw new Error("mkNoMedia(): "+this+" is a file.");await this.mkdirp_();let e=this.join(".NoMedia");await e.isNotDirectory()&&await e.isEmpty()&&(await e.writeTxt_(["This directory's contents are excluded from PhotoStructure libraries.","","See <https://photostructure.com/nomedia/> for details."].join(`
`)),zr(this.nativePath))}async mkNoMedia(){try{return await this.mkNoMedia_(),this}catch(e){this.pflog().warn("Could not add .NoMedia file to "+this,e);return}}hasNoMedia(){return wn(this)}ignorableCheap(){return Mm(this.nativePath)}async ignorable(){return await this.isDirectory()?IS(this):LS(this)}hidden(){return bf(this)}isSidecar(){return gm(this.ext)}async sidecar(){return at(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+zi(u.defaultSidecarType.valueOrDefault,".").toLowerCase()))}async jsonSidecars(){let e=await this.siblings(r=>Ve(r.ext,".json")&&(r.name===this.name||r.name===this.base||Ur(r.name)===Ur(this.name)));return this.pflog().tap({msg:"jsonSidecars()",result:e==null?void 0:await Vl(e,r=>r.maxStatMs())})}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",async()=>{let e=await this.mtimeMs(),r=await this.sidecars(),i=await Promise.all(F(r).map(n=>n.mtimeMs())),o=[e,...i].filter(C);return ge(o,n=>Math.floor(Math.max(...n)))})}thisOrSidecareMaxMtimeSec(){return b(this.thisOrSidecareMaxMtimeMs(),e=>Wi(e))}};var YR=l(()=>{u.cacheDir.addListener(()=>Xi.unset())}),Xi=l(()=>{try{YR();let t=ne.for(u.cacheDir.valueOrDefault);return t.mkNoMedia_(),t}catch(t){throw re("Failed to set up cacheDir"+de,t),t}},A);var Es=11,xn=3;var _S=l(()=>d("StatsDbDir"));async function XR(){return be(Xi().clear().children(),t=>t.filter(e=>e.name.startsWith(ng)),()=>[])}var ng="sync-state-";async function Sm(t=!0){let e=[];e.push(["Asset version",xn]),e.push(["Asset file version",Es]),e.push(["Library path",u.libraryPath.value]);let r=Wr(O(e),10,vc),i=Xi().join(ng+r);return t&&(await(0,RS.mkdirp)(i.nativePath),await i.join("README.txt").applyIfEmpty_(o=>o.writeTxt_(`This folder holds state for library synchronization of

${u.libraryPath.value}

If you delete or modify the contents of this directory, you will need to
restart PhotoStructure. The next sync will rescan all your drives.

If you have any questions, please visit <https://photostructure.com/support/>.

`+e.map(([n,s])=>`${n}: ${s}`).join(`
`)).catch(n=>{_S().warn("Failed to write README to "+i,n)})),_S().info("Set up statsDbDir dir "+i)),i}async function ZR(t){let e=T(t,await Sm());if(!e.name.startsWith(ng))throw new Error("Refusing to remove directory "+e);await e.rmrf()}async function NS(){for(let t of await XR())await ZR(t)}var BS={beforeParse:t=>t.option("--force","Deletes prior cached directory metadata to force directory contents to be re-scanned"),afterParse:async t=>{I(t.force)&&(u.forceSync.tmpValue=!0,await NS())}};var CS={beforeParse:t=>t.option("--no-filter,--noFilter","Disables import filters. All paths will try to be imported, even if they are too small or are missing tags."),afterParse:async t=>{I(t.noFilter)&&(u.minAssetFileSizeBytes.tmpValue=0,u.requireMakeModel.tmpValue=!1,u.minImageDimension.tmpValue=0,u.minVideoDimension.tmpValue=0)}};function VS(t){return t!=null&&k(t.warn)||sg(t)}function sg(t){return t!=null&&k(t.bad)||e_(t)}function e_(t){return t!=null&&k(t.fail)}function zS(t){return V([...F(t.warn),...F(t.bad),...F(t.fail)])}function ag(t){return{ok:F(t.ok),warn:F(t.warn),bad:F(t.bad),fail:F(t.fail)}}function Tf(...t){t=D(t);function e(r){return V(D(Y(t.map(r))))}return{ok:e(r=>r.ok),warn:e(r=>r.warn),bad:e(r=>r.bad),fail:e(r=>r.fail)}}var lg=P(require("process"));function mg(){let t=(0,lg.memoryUsage)();return Zo([t.external,t.heapUsed,t.arrayBuffers])}function vf(){return Ie(mg()/Ke,2)}function ug(){return(0,lg.memoryUsage)().rss}function Mf(){return Ie(ug()/Ke,2)}var Pm=!1;function Ii(){return Pm}function cg(){Pm||(Pm=!0,Tx())}function fg(){Pm&&(Pm=!1,Od(),vx())}var nu=P(require("process"));var US=`
Hello, and thank you for using PhotoStructure!

The files in this folder support your PhotoStructure Library, including

  * a database with the filepaths to your photos and movies
  * previews and thumbnails of your photos and movies
  * content metadata about these assets, like ratings and sharing information
  * albums that both you and PhotoStructure Curators have assembled

Moving or deleting any files here will cause problems using your library.

If you have any questions, please visit <https://photostructure.com/support/>.

Sincerely,

Your Friendly Neighborhood PhotoStructure, v${Tt}`;function zt(t=u.libraryPath.value){return q(t,e=>ne.for(e).join(".photostructure"))}function Em(t=u.libraryPath.value){return q(t,e=>ne.for(e).join(u.originalsDir.valueOrDefault))}async function Sf(t){let e=zt(t);if(e==null)throw new Error("empty dataDir");if(await e.mkdirp()==null)throw new Error("Could not mkdirp "+e);await e.mkNoMedia();let r=e.join("README.txt");return await r.size()!==US.length&&await r.writeTxt_(US),e}var WS=P(require("@iarna/toml"));var Am=d("SettingsIO"),qS="settings.toml";function pg(){return ne.for(fi()).join(qS)}function Pf(t){return Ge([t,u.libraryPath.value],e=>q(e,r=>f(zt(r),i=>i.join(qS))))}async function t_(){I(u.scanMyPictures.value)&&(u.scanMyPictures.value=!1,u.scanPaths.push(await zv()))}async function ja(t=pg()){let e=await ze(jS(t),()=>[]);return await t_(),Jr.unset(),e}async function GS(){return HS(pg())}async function KS(t){return f(Pf(t),e=>HS(e))}var Jr=l(()=>r_(),Fr);U(()=>{H(()=>Jr.unset()),u.libraryPath.addListener(()=>Jr.unset())});function r_(t){let e=Pf(t);return Am.tap({msg:"_libraryHasSettings",result:T(e?.clear().existsSync(),!1),level:"info",meta:{libraryPath:t,settings:u.libraryPath.value,librarySettingsFile:e?.nativePath}})}var i_=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;async function HS(t){return b(t.firstMatchingLine(i_),e=>e[1])}var JS={maxLineLen:78,prefix:"# "};async function $S(t,e){let r=await t.clear().isNonEmpty(),i=r?await t.wip():t;await o_(i,e,t),Am.info("maybeWriteFile(): wrote settings",{dest:i,file:t,nonDefaults:e.filter(o=>o.hasValue()).map(o=>({name:o.name,value:o.value}))}),r&&(await Pt($n(Ef(i),Ef(t)))&&(Am.info("Archiving prior, different contents",{dest:i,file:t}),await t.renameYMDHMS_("old")),await i.unwip_())}var n_=l(()=>Tt);async function o_(t,e,r){let i=T(await Ef(r),{}),o=Y(["","Hello!","",`These are ${e[0].categoryType} settings for PhotoStructure.`,""," - Please shut down PhotoStructure before editing this file.",""," - PhotoStructure has TWO settings files!",""," - Most settings have reasonable defaults, which are provided after the",'   description. Remove the "#" from the beginning of the line to override',"   the default.",""," - See <https://photostructure.com/getting-started/advanced-settings/>","   for more details","","Thanks for using PhotoStructure! Visit <https://photostructure.com/support> or email <support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+n_()].map(s=>go(s,JS)));o.push("","");let n="";e.forEach(s=>{let a=`${Qo(s.categoryType)}.${s.category.toLowerCase()}`;a!==n&&(n=a,o.push("",Yn("#",78),"#","# Settings for "+a+":","#","",""));let m="# +"+Yn("-",s.name.length+4)+"+",c=tt(y(y({env:s.key},ge(s.opts.envAliases,E=>({"env aliases":E}))),s.addToJSON())).map(([E,R])=>`${E}: ${O(R)}`).join(", ");o.push(...go([m,"|  "+s.name+"  |",m,"",`${s.opts.description.replace(/\n/g,`

`)}`,`(${c})`,""].join(`
`),JS));let p=i[s.name],g={},w=s.valueToPersist(p);w!=null?(g[s.name]=w,o.push(...QS(g))):(g[s.name]=s.exampleValue,o.push(...QS(g).map(E=>"# "+E))),o.push("","")}),await t.writeTxt_(`
`+o.map(s=>s.trimRight()).join(`
`)+`

`),Ax()}function QS(t){return ui(...tt(t).map(([e,r])=>e+" = "+O(r,void 0,2)))}async function Af(t=pg()){return $S(t,Jv())}async function Df(t){return f(Pf(t),e=>jS(e))}async function YS(t){await Sf(vu(t,u.libraryPath.value));let e=Pf(t);return Am.warn("writeLibrarySettings("+e+")"),await f(e,r=>$S(r,$v())),Jr.unset(),e}async function Ef(t){return b(t.readFile(),e=>Am.tap({msg:`read(${t})`,result:WS.default.parse(hd(e.toString()))}))}async function jS(t){let e=d("SettingsIO.importFileSettings("+t.nativePath+")");try{let r=await Ef(t);if(r==null){if(await t.isNonEmpty())throw new Error("Failed to read "+t);return[]}let i=new Map(tt(u).filter(([,n])=>n instanceof Hr&&!n.transient).map(([n,s])=>[n.toLowerCase(),s])),o=D(tt(r).map(([n,s])=>{let a=i.get(h(n).toLowerCase());return a==null?e.warn("Failed to import (no setting with this name)",{key:n}):a.importFromFile(s),a}));return e.info("loaded",{tomlMap:r,imported:o.map(n=>rt(n,"name","value","persist"))}),o}catch(r){e.error("Cannot read"+Ot(r));return}}var dme=l(()=>new Set([u.logLevel,u.httpPort,u.rpcPort,u.license].map(t=>t.key)));var cD=P(require("exiftool-vendored")),fD=P(require("path"));var ZS=P(require("file-type")),eP=P(require("fs-extra")),tP=P(require("path"));var Tn=P(require("fs-extra"));async function XS(t,e=0,r){let i=-1;try{let o=await T(r,()=>b((0,Tn.stat)(t),s=>s.size-e)),n=Buffer.alloc(o);return i=await(0,Tn.open)(t,"r"),await(0,Tn.read)(i,n,0,o,e)}finally{await Yo(i,Tn.close)}}U(()=>{H(()=>Ff.prior()?.clear()),nr(t=>t==null?Ff.prior()?.clear():Ff.prior()?.delete(t))});var Ff=l(()=>new ke(512,3*A));async function Fm(t){return Ff().getOrSet(t,async()=>{let{buffer:e}=await XS(t,0,248);return at((0,ZS.fromBuffer)(e)).filter(r=>r.mime!=="image/tiff").orElse(()=>at(uc((0,eP.stat)(t))).filter(r=>r).flatMap(()=>Dm().readRaw(t,["-mimetype"])).flatMap(r=>r.MIMEType).filter(M).map(r=>({ext:s_(t),mime:r})).get()).get()})}function s_(t){return st((0,tP.extname)(t),".")}var dg=P(require("os"));async function hg(t){let e=B?"where":"which";try{let r=await je(e,[t],{timeout:J,ignoreExitCode:!0,ignoreStderr:!0});return r.code===0&&M(r.result)?r.result.trim().split(`
`)[0]?.trim():void 0}catch{return}}async function gg(t){return t!=null&&await t.exists()?t.nativePath:void 0}async function Lf(t,e){let r=f(jr.Tools(),o=>Me.for(o));if(ni&&(r==null||await r.isNotDirectory()))throw new Error("Cannot find project path for tools"+de);function i(o){return r?.join(qx+"-"+o,T(e,t),t+(B?".exe":""))}return Qt(()=>gg(i(dg.default.arch())),()=>dg.default.arch()==="x64"?gg(i("ia32")):void 0,()=>a_(t))}async function a_(t){return Qt(()=>hg(t),()=>gg(Me.for(jr.Bin())?.join(t)),()=>{throw new Error("Cannot find path for "+t)})}var rP=l(()=>Lf("dcraw_emu","libraw")),iP=l(()=>Lf("raw-identify","libraw")),yg=l(()=>Lf("jpegtran")),oP=l(()=>Lf("sqlite3"));var If=new ke(512);H(()=>If.clear());nr(t=>t==null?If.clear():If.delete(t));var nP=l(()=>d("RawInfo"));async function Of(t){return If.getOrSet(t.nativePath,async()=>{try{let e=await iP(),r=await le(e,["-s",t.nativePath],{timeout:ba});return q(r,l_)}catch(e){nP().warn("raw-identify failed",{file:t.nativePath,error:ae(e)});return}})}function l_(t){let[e,r,i,o,n]=t.split("	");return nP().tap({msg:"parseRawInfoOutput()",result:Ho(G(o),G(n),(s,a)=>({Filename:e,Make:r,Model:i,ImageSize:{width:s,height:a}})),meta:{input:t}})}var dA=P(require("os"));function m_(t,e,r=.5){return(1-r)*t+r*e}function Ha(t,e,r){let i=e.x-t.x,n=(r-t.x)/i;return m_(t.y,e.y,n)}function sP(t){return Ge(["AvgBitrate","MaxDataRate"],e=>u_(t[e]))}var c_=[{pat:"mb/s",fac:1024},{pat:"mbps",fac:1024},{pat:"kb/s",fac:1},{pat:"kbps",fac:1}];function u_(t){return f(Xo(t),e=>{let r=h(t).toLowerCase();return f(Ge(c_,i=>r.includes(i.pat)?i.fac:void 0),i=>e*i)})}function lr(t){return M(t)&&(t.startsWith("video/")||t==="application/mp4"||t==="application/ogg")}function vn(t){return f(t,e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(C))}function bg(t){return se(t)&&[0,90,180,270].includes(t)}function Ga(t){let e=f(t,r=>ut(r+Math.ceil(-r/360)*360));return bg(e)?e:void 0}function aP(t){let e=Ga(t);return e===90||e===270}function Mn(t){return f(t,e=>Pi(()=>lP(e.Orientation),()=>lP(e.CameraOrientation),()=>Ga(e.Rotation)))}var f_=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function lP(t){return f(t,e=>f_.get(e))}var Mue=new Map([[0,1],[90,6],[180,3],[270,8]]);function mP(t){return t!=null&&C(t.width)&&C(t.height)}function $r(t){return`${t.width} \xD7 ${t.height}`}function uP(t){return hx(t.width*t.height)}function wg(t){return{width:t.height,height:t.width}}function cP(t,e){return aP(e)?wg(t):t}function fP(t){return t.width/t.height<1}function kr(t){return ec(t.width*t.height)}var p_=l(()=>d("SizeInfo"));function As(t,e,r){let i=Ge([r?.ImageSize,{width:t.ImageWidth,height:t.ImageHeight}],s=>mP(s)?s:void 0);if(p_().debug("extractSizeInfo()",{filename:t.FileName,mimetype:t.MIMEType,rawInfo:r,fileDimensions:i}),i==null)return;let o=cP(i,e),n=Ie(o.width/o.height,5);return{ImageHeight:o.height,ImageWidth:o.width,aspectRatio:n,dimensions:o,rotation:e,fileDimensions:i}}var d_=A,h_=15*A,g_=10,y_={p0:{x:.8*Ke,y:4*S},p1:{x:20*Ke,y:12*S}},xg={p0:{x:11*Ke,y:12*S},p1:{x:26*Ke,y:24*S}},pP={p0:{x:7*Ke,y:45*S},p1:{x:32*Ke,y:90*S}};function Tg(t){return hm(t.ext)?Math.max(T(pe(t.durationMs,e=>e*g_),0),Ha(pP.p0,pP.p1,t.bytes)):0}function kf(t){return b(b_(t),e=>e.result)}function b_(t){return b(w_(t),x_)}function w_(t){return b(t.size(),async e=>({bytes:e,ext:t.ext,durationMs:hm(t.ext)?await b(_e(t),r=>pe(r.Duration,i=>i*S)):void 0}))}function dP(t){return Ha(xg.p0,xg.p1,te(11*Ke,100*Ke,T(t,0)))}function x_(t){let e=te(.5*Ke,64*vo,t.bytes),r=5*S,i=J,o=2*e*fc,n=w=>Ha(w.p0,w.p1,te(.5*Ke,50*Ke,e)),s=n(y_),m=Nh(t.ext)?.includes(Et.RawImage)===!0?n(xg):0,c=Tg(t),p=u.validateVideos.valueOrDefault?c:0;return{result:te(d_,h_,Math.round(r+i+o+s+m+c+p)),dbMs:r,tagMs:i,copyMs:o,thumbMs:s,rawDecodeMs:m,transcodeMs:c,validateMs:p}}var Rf=new ke(256);U(()=>H(()=>Rf.clear()));U(()=>fa((t,e)=>{Rf.getOrSet(t,()=>[]).push(e),Rf.getOrSet(e,()=>[]).push(t)}));function T_(t){return[t.toString(),...F(Rf.get(t.toString()))]}function hP(t,e,r){for(let o of T_(t)){let n=r.get(o);if(n!=null)return n}let i=e(t);return r.set(t.toString(),i),i}var _f=Ae("plus","lite");var v_=require("https");async function gP(t,e={}){return e.headers==null&&(e.headers={}),v(e.headers["user-agent"])&&(e.headers["user-agent"]=vi+" v"+Tt),new Promise((r,i)=>{let o=v_.request(t.toString(),e);o.setTimeout(T(e.timeout,J),()=>{i(new ue({message:"Timeout fetching <"+t+">",doNotSend:!0,retriable:!0}))}),o.on("response",n=>{let s=[];n.setEncoding("utf8"),n.on("data",a=>s.push(a)),n.on("end",()=>{r({ok:St(200,399,n.statusCode),headers:n.headers,body:s.join(""),statusCode:n.statusCode,statusMessage:n.statusMessage})})}).on("error",n=>{i(n)}),f(e.body,n=>o.write(n)),o.end()})}var yP=P(require("zlib"));var fce=l(()=>JSON.parse(xc("H4sIAAAAAAAAA6tWylWyUqrKyUxS0lEqADKTivJLcjJdUpPzcwuKUouLgyvzkoFSeUCptKL8XCCzDKQqsTjVzATISQRySvKDS4oy89KB3Bwgt7QkzUKpFgCQWYV5WQAAAA==")));function Zi(t){return JSON.parse((0,yP.brotliDecompressSync)(Buffer.from(t,"base64")).toString("utf8"))}var Sg=P(require("os"));var bP=P(require("fs/promises"));var M_=l(()=>d("ReadFile"));async function vg(t){try{return await(0,bP.readFile)(t)}catch(e){M_().info(".readFileMaybe("+t+")",e);return}}var Mg=class{constructor(e,r,i){this.file=e;this.mkObject=r;this.onWrite=i;this.prior=l(()=>this.file.readJson("debug"))}async read(){let e=await this.prior();return d("JsonFileStore").debug("prior "+this.file,e),e??b(this.mkObject(),r=>this.write(r))}async write(e){try{return await this.file.writeJSON_(e,{spaces:2}),await this.prior.set(Promise.resolve(e)),d("JsonFileStore").info("wrote to "+this.file,e),this.onWrite!=null&&await this.onWrite(this.file,e),e}catch(r){throw new ue({cause:r,message:"Failed to write to "+this.file})}}};function S_(){return vc.safeRandomUid(16,4)}var wP=class extends Mg{constructor(e,r){super(e.join("."+r+"-uid.json"),()=>({uid:S_(),version:Tt,type:this.type,createdAt:Date.now()}),i=>i.hide());this.rootDir=e;this.type=r;this.read_=l(()=>be(this.read(),e=>e.uid,()=>"missing!").catch(e=>{throw new ue({cause:e,fatal:!0,message:"Failed to read "+this.rootDir})}))}},Nf=l(()=>f(zt(),t=>new wP(t,"library")));U(()=>{H(()=>{Nf.unset()}),u.libraryPath.addListener(()=>Nf.unset())});var xP=P(require("os"));var P_=/^(?:[0:]+|[f:]+)$/i,TP=l(()=>V(Y(Mt((0,xP.networkInterfaces)()).map(t=>F(t).map(e=>e.mac))).filter(t=>M(t)&&P_.exec(t)==null)));var E_=l(()=>Zi("G7kAIIzUYs0Z7qRuS32pmsUk/UyD8OFBrsHUYemDqh3/zMuNBya1K0GYBazpDR8puUeR5pOPDwrAyLrH9L4GAhPQPWicizajRNayvHKU52siIpE9GddV7bjtHChhuc6wwPIkg/x4NH0P")),di=Ae("cu","lc","lm","mp","wm","li","cm","ma","vl");function vP(t){return X(V(t.filter(A_)),e=>[di.indexOf(e.split(":")[0]),e])}function MP(t){return E_()[t]}var SP=15;async function eo(t,e){try{let r=h(await e);return v(r)||r.match(/^[\s0:_\/-]*$/)!=null?void 0:t+":"+Wr(r.trim(),SP,sn)}catch(r){d("toUID").warn("failed",{pfx:t,err:r});return}}var D_=l(()=>new RegExp(`^(${di.values.join("|")}):[0-9a-zA-Z]{${SP}}$`));function A_(t){return t!=null&&D_().exec(t)!=null}var Oo=l(()=>Zi("GwkBABwHdoyzjXCwzccdzUv9+g11VQzlNQjNotPVt0S2zHa8CLMs19auq91f4APvhhMIPZZ0m49e3qooFMQq6ej4jJBRUbv5BmSQzUeTCzW5mdaimgkX4ZqrHjPAjQ8XSSsp+cYQ79EXELnYMzlJwyYHVTq/nMkq900q5+mx2ayLgl3s6O7FgGooQh++7vpBI+Qpw3dCNqYDIfr6zPvUur259BmFMDQjV/hviADXURsBk2HJBesB")),Bf=l(()=>d(Oo().n));async function F_(){return eo(di.li,await Nf()?.read_())}function L_(){return eo(di.cm,(0,Sg.cpus)()[0].model)}function I_(){return TP().map(t=>eo(di.ma,t))}async function O_(){return F(await Or()).map(t=>eo(di.vl,t.uuid))}async function k_(){let t=await le(Oo().c,["-1"],{timeout:5*S});return Bf().tap({msg:Oo().c,result:t.match(/serial.*=\s*([a-z0-9-]{12,})/i)?.[1]})}async function R_(){try{return q(await k_(),t=>eo(di.lc,t+":"+(0,Sg.cpus)()[0].model))}catch(t){Bf().info(Oo().c+" failed",t);return}}async function N_(){try{let t=await __();return eo(di.mp,t)}catch(t){Bf().info("ioreg failed",t);return}}async function __(){return(await le(Oo().i,Oo().ia,{timeout:5*S})).match(/uuid" = "([a-z0-9-]{12,})"/i)?.[1]}async function B_(){return(await Fe.instance().executeJson(Oo().w))?.MachineGuid}async function C_(){let t=await B_();return eo(di.wm,t)}var V_=l(async()=>Ue()?[]:dt?[eo(di.lm,vg(Oo().lv)),eo(di.lm,vg(Oo().le)),R_()]:he?[N_()]:B?[C_()]:[]);async function Cf(){let t=await Promise.all([F_,L_,O_,I_,V_].map(async e=>{try{return await Oe(e(),5*S)}catch(r){return Bf().warn(r)}}));return vP(V(await Cl(t)))}var Ka=class{constructor(e,r,i,o){this.s=e;this._l=r;this._sids=i;this.meta={src:o}}get l(){return this._l}get ok(){if(this._l==null)return!1;let e=ud(this._sids,this._l.uids),r=V(e.map(s=>s.split(":")[0])),i=D(r.map(s=>MP(s))),o=i.length>=this._l.mat,n=St(this._l.iat?.getTime(),this._l.exp?.getTime()+ot,Date.now());return this.meta[Le().o]=n,this.meta[Le().u]=o,this.meta[Le().m]=i,n&&o}cmpVal(){return[this.ok,-_f.indexOf(this.l?.[Le().T]),this.l?.exp?.getTime()??1,this.meta.matchedSchemes]}cmp(e){return Nt(this.cmpVal(),e.cmpVal())}};var Vf=l(()=>d("writeLicense"));async function EP(t){let e=await Pg(t,"candidate");if(e==null)return Vf().error("!ok",t);await PP(e,zt()?.join(Le().d)),await PP(e,Me.for(fi()).join(Le().d)),Ja.unset()}async function z_(t){return(await ye(t.childFiles(),async e=>Pg((await e.readFile())?.toString().trim(),e.nativePath))).filter(e=>e.ok&&e instanceof Ka)}async function PP(t,e){if(e==null)return;if((await z_(e)).some(i=>i.cmp(t)>=0)){Vf().info("saveIfBetter(): no-op for "+e);return}else{let i=e.join(Wr(t.s)+".txt");return await i.writeFile_(t.s).then(()=>(Vf().info("saveIfBetter(): wrote to "+i),i)).catch(o=>{Vf().error("saveIfBetter(): failed to save license to "+e,o)})}}var ko=l(()=>d(to().l)),to=l(()=>Zi("G9YAwIzTFfOihHWPgG6m/h0h65IqCersIGkdlq6+6ra6+PjQ8mHlRTkDg6UJJqPJEIU6WaIUNodfF2xPB7iLWJDlIN8z6xhOKyn4qqHpZlh6qCZUoQghd4BVMkz3A0IIevFn+7UO7uM+VGJb/MeZXfHngpQWZzk=")),AP=l(async()=>{let t=to().s+": ";try{if(!u[to().s].valueOrDefault)return ko().debug(t+"no-op (settings disabled)");let e=(await Ja()).filter(n=>n.l!=null&&M(n.s)),r=new Date,i=e.find(n=>n.ok&&r<n.l.exp);if(i!=null)return ko().debug(t+"no-op: ",i);let o=await Me.for(fi()).join(to().s).mkdirp_();for(let n of e){if(v(n.s)||n.l==null||r<n.l.exp)continue;let s=n.l.uids.find(a=>a.startsWith("cu:"));if(s==null){ko().debug(t+"skipping (no cu)",n);continue}await o.join(an(n.s,14)+".txt").applyIfEmpty_(async a=>{await U_(s),await a.writeJSON_({l:n.l,at:Date.now()}),ko().warn(t+"requested",n)})}}catch(e){ko().warn(t+"failed",e)}},15*A);async function U_(t){try{let e=await Cf();if(L(e))return ko().warn("no-op: empty sids");let r=O({uids:[...e,t]}),i=y(y({},to().r),{body:r}),o=await gP(to().u,i);ko().info(to().u,{req:i,response:o}),o.ok?await EP(JSON.parse(o.body)?.[to().a]):ko().warn(to().u,{req:i,response:o})}catch(e){ko().warn(to().u,e)}}var RE=P(kE());var Qa=l(()=>Zi("G9AAICwK7KZhK2gx/dEjjDHuEVVxShG2PVDGAcBqBqP3binicrOwzdRXMfMKd00dlj6bnSYcBaK1S8KWhAGGv73Zu73eMMKnXGoKt4NsAefjf3tdIWcHCM4FdbL+J+haq7GA2/ps1jHled6Oe+3j+k+BBQbgzzJmnLDvnTnXr11NbkL3X+vvWdyYILH9urnb+EV39HOm4Y5Hcrfqyt5i5iCfpGaVUqOnNfYDdeWC8wV2OWE=")),zpe=l(()=>{try{return require(Qa().c)[Qa().m](Qa().o)}catch(t){re(Qa().m+de,t)}});function _E(t){return RE.V2[Qa().w](t,Qa().o)}var Le=l(()=>Zi("GwwBABwHdkzj5qg5WDnubFuq7NaxSKjiobwK4iGSLDp98J87fqD679bWgnaVtCVBQAEFBJm7aiN4y7puJw8PPz+CHDoAhk5Fd0AhTjKYPbo8F5freFUJHhQHc2xp4qfyoqKKAmGb7IkFZwkajH7uJCR829lmguhEXw/iusqUQE4nk7LeJyad4wmdptoVln0otnUOO3UHnEyjrxtXUr7B")),NE=l(()=>d(Le().l));async function LB(t){let e=await _E(zi(h(t).trim(),Le().p)),r=Hh(e[Le().i]);if(r==null)throw new Error("bad "+Le().i+": "+e[Le().i]+" ("+t+")");let i=Hh(e[Le().r]);if(i==null)throw new Error("bad "+Le().r+": "+e[Le().r]+" ("+t+")");return e[Le().a]=e[Le().a]>=0?e[Le().a]:2,e[Le().i]=new Date(r),e[Le().r]=new Date(i),e[Le().b]=h(e.uids).split(","),e}async function Bg(t,e){try{return new Ka(t,await LB(t),await Cf(),e)}catch(r){return NE().tap({msg:Le().v,result:{s:t,ok:!1,meta:{err:r}}})}}async function Pg(t,e){if(v(t))return;let r=await Bg(t,e);return I(r?.ok)&&r instanceof Ka?r:void 0}var Ja=l(async()=>{let t=D([zt()?.join(Le().d),Me.for(fi()).join(Le().d)]),e=Y(await sr(t,o=>o.childFiles())),r=Y(await sr(e,async o=>q(F(await o.readLines()).map(n=>n.trim()).join(""),n=>Bg(n,o.nativePath))));await q(u[Le().L].value,async o=>r.push(await Bg(o,"Settings")));let i=IB(r);return U(AP),NE().tap({msg:Le().d+"()",result:i})});async function IB(t){return X(t,e=>[!e.ok,_f.indexOf(e.l?.[Le().T]),-(e.l?.exp?.getTime()??1)])}U(()=>Ja[Le().n]=()=>null);function OB(){return b(Ja(),t=>t[0]?.ok?t[0]:void 0)}async function kB(){return at(OB()).flatMap(t=>t.l?.[Le().T]).getOrElse(()=>Le().f)}async function hi(){try{return await kB()===Le().f}catch{return!0}}var RB=["image/gif","image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"];function Hf(t){return RB.includes(h(t).toLowerCase())}var _B=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);function An(t){return _B.has(h(t).toLowerCase())}var NB=/^\(?Binary data (\d+).*use -b option to extract\)?$/i,Ya=class{constructor(e){this.binaryDataBytes=e}};function BE(t){if(typeof t!="string")return;let e=t.match(NB);return e==null?void 0:new Ya(G(e[1],{defaultValue:0}))}function Gf(t,e){return Dl(t.width,e.width)&&Dl(t.height,e.height)}function CE(t,e){return fo(t.width,e.width)&&fo(t.height,e.height)}function ki(t){return b(Xa(t.nativePath),e=>({width:e.ImageWidth,height:e.ImageHeight}))}var VE=l(()=>d("HeifConvert"));U(()=>H(()=>Kf.unset()));var Kf=l(async()=>hg(u.heifConvertPath.valueOrDefault));async function BB(){let t=await Kf();return VE().tap({msg:"isHeifConvertSupported()",result:M(t),meta:{heifConvertPath:t}})}async function zE(t){if(!!await BB())return b(ro(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await je(u.heifConvertPath.valueOrDefault,["-q",String(u.jpegQuality.valueOrDefault),t.nativePath,r.nativePath],{timeout:J})}catch(i){VE().warn("heif2jpeg(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var UE=l(()=>d("sips")),WE=l(async()=>{try{return await le("command",["-v","sips"],{timeout:Fr})}catch(t){let e=Me.for("/usr/bin/sips");if(await e.isExecutable())return e.nativePath;UE().info("sips is missing from $PATH",t);return}});async function qE(t){return b(ro(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await je("sips",["-s","format","jpeg","-s","formatOptions",String(u.jpegQuality.valueOrDefault),t.nativePath,"--out",r.nativePath],{timeout:J})}catch(i){UE().warn("sips(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var CB=l(()=>d("Heif")),jE=l(async()=>{try{if(he)try{let e=await WE();if(!v(e))return{ok:!0,msg:e}}catch(e){CB().error("Failed to find the sips tool (either in PATH or /usr/bin).",e)}let t=await Kf();return{ok:M(t),msg:ri(t,u.heifConvertPath.valueOrDefault+": not installed")}}catch(t){return{ok:!1,msg:ls(t)}}});async function Jf(){return(await jE()).ok}U(()=>H(()=>jE.unset()));var VB=/^image\/hei[fc]$/i;function Fs(t){return VB.exec(h(t))!=null}async function HE(t,e,r,i=1e3){let o=await Je(()=>k(t.listeners(e)),{timeoutMs:i});return o&&t.emit(e,r),o}var KE=P(require("util"));function GE(t,e){let r=t.width/t.height,i=e.width/e.height;if(r>=i){let o=Math.min(e.width,t.width);return{width:o,height:Math.ceil(o/r)}}else{let o=Math.min(e.height,t.height);return{width:Math.ceil(e.height*r),height:o}}}var er=Ae("fit","sq");var zB=Ae("cover","contain","fill","inside","outside"),Dn;(function(o){let t=l(()=>d("Reducers.Square"));o.name=er.sq,o.fit="cover";function i(n,s){let a=CE(n,s)?y(y({},n),{fit:zB.cover}):void 0;return t().tap({msg:"reduce()",result:a,meta:{max:n,input:s}})}o.reduce=i})(Dn||(Dn={}));var Qr;(function(o){let t=l(()=>d("Reducers.Fit"));o.name=er.fit,o.fit="inside";function i(n,s){if(Gf(s,n)){t().trace(`reduce(): input ${$r(s)} is too small for ${$r(n)}`);return}return GE(s,n)}o.reduce=i})(Qr||(Qr={}));var Bhe=require("sharp"),mr=class{constructor(e,r,i,o,n=!0){this.name=e;this.maxWidth=r;this.maxHeight=i;this.reducer=o;this.rotational=n;this.megapixels=l(()=>ec(this.maxWidth*this.maxHeight));this.max={width:r,height:i},mr._Sizes.push(this)}static sq(){return this._Sizes.filter(e=>e.reducer===Dn)}static largestSq(){return bt(this.sq(),e=>e.megapixels())}static fit(){let e=u.previewResolutions.valueOrDefault;return this._Sizes.filter(r=>r.reducer===Qr&&e.includes(r.name))}static largestFit(){return bt(this.fit(),e=>e.megapixels())}[KE.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"\xD7"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&fP(e)?wg(this.max):this.max,e)}resize(e,r){return r=r.resize(y(y({},e),{fit:this.reducer.fit,withoutEnlargement:!0})),r}toJpeg({path:e,sh:r,outputSize:i}){return(kr(i)<2||u.sharpen.valueOrDefault)&&(r=r.sharpen()),r.jpeg({quality:u.jpegQuality.valueOrDefault,progressive:u.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}},Ye=mr;Ye._Sizes=[],Ye.UHD8k=new mr("uhd8k",7680,4320,Qr,!1),Ye.UHD5k=new mr("uhd5k",5120,2880,Qr,!1),Ye.UHD=new mr("uhd4k",4096,2160,Qr),Ye.QHD=new mr("qhd",3120,1440,Qr),Ye.FHD=new mr("fhd",1920,1080,Qr),Ye.HD=new mr("hd",1280,720,Qr),Ye.WVGA=new mr("wvga",720,480,Qr),Ye.QVGA=new mr("qvga",320,240,Qr),Ye.QQVGA=new mr("qqvga",160,120,Qr),Ye.S480=new mr("s480",480,480,Dn),Ye.S240=new mr("s240",240,240,Dn),Ye.S120=new mr("s120",120,120,Dn),Ye.S60=new mr("s60",60,60,Dn);var $f=d("libraw");var UB=["-T"],WB=["-Z","-"],qB=["-o","1"],jB=["-t","0","-j"];async function JE(t){let e=Date.now(),r=await ki(t);if(r==null)return $f.throw("Cannot decode RAW "+t+": no EXIF dimensions."+yr+kt);let i=Ye.largestFit().outputSize(r),o=[];i!=null&&4*kr(i)<kr(r)&&($f.debug("Large original source: using -h"),o.push("-h"));let n=await rP(),s=[...UB,...WB,...qB,...o,...jB,...u.dcrawEmuArgs.values,t.nativePath],a=5*A,m={encoding:"buffer",timeout:a,maxBuffer:250*Ke};$f.debug("dcraw_emu()",{cmd:n,args:s,opts:m});let c=await pn(n,s,a,m),p=async E=>{await HE(c.stdout,"error","Problem from "+t+": "+yT(E,t.nativePath))||$f.error("No listeners for error when reading "+t,E),c.kill("SIGINT")};c.on("error",p),c.stderr.on("data",p);let g=dP(await t.size())/7,w=new mn({path:t.nativePath,op:"Converting raw image"},g,()=>Date.now()-e);return c.on("close",()=>w.end()),c.stdout}var Cg=require("sharp"),Ls=d("SharpReadable");async function GB(t,e,r,i){let o=e?.[r];if(!(o instanceof Ya))return;let n=i.width*i.height*.1;if(o.binaryDataBytes==null||o.binaryDataBytes<n){Ls.debug("imgFromExif(): rejecting (too small) "+r,{minBytes:n,val:o});return}let s=await HB(t,r),a=await f(s,ki);return Ls.tap({msg:"imgFromExif()",meta:{src:t.baseWithGrandparent,tag:r,dim:a,minDim:i},result:a!=null&&Gf(i,a)?s:void 0})}var KB=l(()=>{Cg.simd(u.enableSIMD.valueOrDefault),Cg.cache(u.enableVipsCache.valueOrDefault),Cg.concurrency(Bd())});function Is(t,e,r=!1){return Qe(`img.sharpReadable${t.ext.toUpperCase()}`,()=>JB(t,e,r))}async function JB(t,e,r=!1){KB();let o=await _e(t,!r),n=o?.MIMEType;if(o==null||v(n))throw new Error(t+" is not supported (missing mimetype)");if(Fs(n)&&!await Jf()){Ls.warn("sharpReadable(): HEIF file, but heif support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}if(lr(n)&&!await Rm()){Ls.warn("sharpReadable(): video file, but video support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}let s=[],a=Mn(o),m=As(o,a,An(n)?await Of(t):void 0);if(m!=null){let g=T(e,{width:m.dimensions.width*.95,height:m.dimensions.height*.95});if(kr(g)>15&&(r||a==null||a===0)&&!lr(n)){let E=u.embeddedPreviews.valueOrDefault;e!=null&&kr(e)<1&&E.unshift(...u.embeddedThumbnails.values),s.push(...E.map(R=>()=>GB(t,o,R,g)))}}Fs(n)&&(he&&s.push(()=>qE(t)),s.push(()=>zE(t))),Hf(n)&&s.push(async()=>t),m!=null&&An(n)&&s.push(()=>(Ls.info("sharpReadable() -> dcraw()",{src:t.nativePath,minDim:e}),QE({src:t,desc:"dcraw",suffix:".tiff",f:()=>JE(t)}))),n.startsWith("video/")&&s.push(()=>li(()=>km(t,n),{maxRetries:1}));let c=[],p=await zx(s,g=>{Ls.warn("strategy failed for "+t+": "+g),c.push(g)});if(p==null)throw T(c[0],new Error("Cannot read "+t+" ("+n+")"));return p}function HB(t,e){let r=e.toLowerCase().endsWith("tiff")?".tiff":".jpg";return b(ro(t,e,r),i=>i.applyIfEmpty_(async o=>{try{return await $E(e,t.nativePath,o.nativePath)}catch(n){Ls.warn("Failed to extract embedded "+e+" from "+t.nativePath+": "+n);return}}))}var Yge=require("sharp"),$B=l(()=>d("ImgCache")),QB="imgcache";async function _m(){return Xi().join(QB).mkdirp_().catch(t=>{re("Failed to create imgCache directory"+de,t)})}async function ro(t,e,r){let i=await t.stat();if(i==null)throw new Error(`cachedImgFile(${t}): unreadable`);let o=await _m();if(o==null)throw new Error("imgcache dir is missing");let n=await Fm(t.nativePath);if(n==null)throw new Error("Cannot read filetype for "+t);let s=an(O({basename:t.base.toLowerCase(),mimetype:n.mime,size:i.size}));r=zi(r,".");let a=o.join(...$o(s.slice(0,24),2,3),e+r);if(await a.parent().mkdirp()==null)throw new Error("Cannot make dest dir, "+a.parent());return $B().debug("cachedImgFile("+t.baseWithGrandparent+")",{desc:e,ext:r,result:a}),a}async function QE({src:t,desc:e,suffix:r,f:i}){try{return await b(ro(t,e,r),o=>o.applyIfEmpty_(async n=>b(i(),s=>n.writeStream_(s))))}catch(o){throw new ue({cause:o,message:"readableToFile() failed"})}}var YB=B?"NUL":"/dev/null",XB=l(()=>d("jpegtran"));async function YE(t){let e=await yg();try{await je(e,["-outfile",YB,t.nativePath],{timeout:30*S,isIgnorableError:Za})}catch(r){throw new ue({cause:r,doNotSend:!0,fatal:!1,retriable:!1})}}async function XE(t,e){let r=t.wip();XB().info("rotateInPlace("+t+")",e),await ZB(t,r,e),await r.unwip_(),zr(t.nativePath)}async function ZB(t,e,r){let i=await yg();if(!bg(r))throw new Error("refusing to rotate("+t+", "+r+")");await le(i,["-copy","all","-trim","-rotate",r.toFixed(0),"-outfile",e.nativePath,t.nativePath],{timeout:A})}var e1=require("sharp"),Vg=l(()=>d("ValidFile")),Qf=l(()=>new ke(1024,A));U(()=>H(()=>Qf.prior()?.clear()));U(()=>nr(t=>W(t).forEach(e=>{Qf.prior()?.delete(e)}).orElse(()=>{Qf.prior()?.clear()})));var t1=l(()=>tv(u.validationErrorBlocklist.values,"i"));function Za(t){return Vg().tap({msg:"isIgnorableValidationError",result:t1().exec(ae(t))==null})}async function eA(t){return uc(Nm(t))}async function Nm(t){if(await hi()||!u.validateJpegImages.valueOrDefault&&!u.validateVideos.valueOrDefault){Vg().debug("no validation for "+t,{validateJpegImages:u.validateJpegImages.valueOrDefault,validateVideos:u.validateVideos.valueOrDefault});return}return hP(t,r1,Qf())}async function r1(t){let e=ne.for(t);try{let r=await Io(e);if(r==null)throw new Error("Cannot validate, no mimetype");if(lr(r))u.validateVideos.valueOrDefault&&(Vg().debug("validating "+e),await ZE(e,r));else if(r.startsWith("image/")){if(r==="image/jpeg"){if(u.validateJpegImages.valueOrDefault)return await YE(e)}else if(u.validateRawImages.valueOrDefault){let i=await Is(e);if(i==null)throw new Error("Cannot read");await e1(i.nativePath,{failOnError:!0}).tiff().toBuffer()}}else throw new Error("Unsupported mimetype, "+r)}catch(r){throw new ue({cause:r,message:"invalid file "+e,retriable:!1,doNotSend:!0,ignorable:!0})}}var tA=l(()=>d("ffmpeg")),rA=l(()=>te(1,8,ut(xt()/2))),i1=/ffmpeg version (\S+)/i,Bm=l(async()=>{try{let t=await je(u.ffmpegPath.valueOrDefault,["-version"],{timeout:J,ignoreStderr:!0,isIgnorableError:()=>!0}),e=i1.exec(t.result)?.[1];return tA().info("ffmpegVersion",{version:e,code:t.code,stdout:t.result.split(`
`,1)[0]}),t.code===0&&M(e)?e:void 0}catch(t){return}}),iA=l(()=>be(Bm(),t=>"version "+t,()=>"(not found)"));U(()=>H(()=>Bm.unset()));async function oA(){return ze(Bm.prior(),()=>Bm.refresh())}async function el(){return await Bm()!=null}async function nA(t){return await t.dest.exists()&&await t.dest.isEmpty()&&await t.dest.unlink(),je(u.ffmpegPath.valueOrDefault,D(["-loglevel","error","-i",t.src.nativePath,...la(t.startAtSec,e=>["-ss",e.toFixed(1)])??[],"-vframes","1","-f","singlejpeg","-y",t.dest.nativePath]),{timeout:A,isIgnorableError:Za})}async function sA(t){let e=W(t.videoBitrateKbps).filter(C).map(r=>Ie(r,2)).map(r=>["-b:v",r+"k","-maxrate",r+"k","-bufsize",Ie(r/2,2)+"k"]).getOrElse(()=>[]);return je(u.ffmpegPath.valueOrDefault,["-loglevel","error","-threads",h(rA()),"-i",t.src.nativePath,...u.ffmpegTranscodeArgs.values,...e,t.dest.nativePath],{timeout:t.timeoutMs,isIgnorableError:Za})}async function aA(t){return tA().tap({msg:"ffmpegValidVideo",meta:{src:t.nativePath},result:await je(u.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",h(rA()),"-i",t.nativePath,"-f","null","-"],{timeout:T(await kf(t),2*A),isIgnorableError:Za,ignoreExitCode:!0,quiet:!1})})}var lA=P(require("path"));var tl=l(()=>d("vlc"));function mA(){return be(rl().catch(()=>{}),t=>"version "+t.version,()=>"(not found)")}var o1=/VLC (?:version|media player) ([0-9.]+)/i,zg=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"],rl=l(()=>n1());U(()=>H(()=>rl.unset()));async function uA(){return ze(rl.prior(),()=>rl.refresh())}async function Ug(){return!Wd&&await be(rl(),t=>t.version!=null,()=>!1)}function cA(){return b(rl(),t=>t.version==null?void 0:t.path)}async function s1(t){return b(je(t,[...zg,"--version"],{timeout:J,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),e=>W(e.result).filter(M).map(r=>r.trim()).flatMap(r=>o1.exec(r)).flatMap(r=>r[1]).get())}function a1(t){return b(Fe.instance().execute(`(Get-Item -path ${ds(t)}).VersionInfo.FileVersion`,e=>e).catch(e=>{tl().warn("Failed to run vlcInfoWin: "+t+": "+e)}),e=>Ys(e.trim()))}async function n1(){let t=[];function e(...r){t.push(ne.for((0,lA.join)(...r)))}if((!B||u.vlcPath.hasValue())&&t.push(u.vlcPath.valueOrDefault),he){let r="/Applications/VLC.app/Contents/MacOS/VLC";q(qe("HOME"),i=>e(i+r)),e(r)}if(B){let r=["VideoLAN","VLC","vlc.exe"];q(qe("LOCALAPPDATA"),i=>{e(i,"Apps",...r)}),q(qe("ProgramFiles"),i=>{e(i,...r)}),q(qe("ProgramFiles(x86)"),i=>{e(i,...r)})}for(let r of t)try{if(r instanceof ne&&await r.clear().notExists())continue;let i=r.toString(),o=await(B?a1(i):s1(i));if(v(o)){tl().info("vlcInfo(): no VLC version found for "+r);continue}else return Lt({path:i,version:o},n=>tl().info("vlcInfo()",n))}catch(i){tl().warn("vlcInfo(): err:"+i,{path:r})}}async function fA(t){let e=await cA();if(v(e))return tl().throw("vlcFrame(): empty vlcPath",y(y({},t),{ignorable:!0}));let r=st(t.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(r))return tl().throw("vlcFrame(): Invalid destination extension"+kt,{format:r,args:t});let i=t.startAtSec??0,o=i+1,n=await je(e,D([...zg,"--avcodec-hw=none","--video-filter=scene","--scene-format="+r,"--scene-replace","--scene-ratio=500","--scene-path="+t.dest.dir,"--scene-prefix="+t.dest.name,"--start-time="+i.toFixed(1),"--stop-time="+o.toFixed(1),t.src.nativePath,"vlc://quit"]),{timeout:A,ignoreStderr:!0});if(t.dest.clear(),C(n.code))throw new Error("vlc failed: "+O(n));return n}async function pA(t){let e=await cA();if(v(e))throw new Error("vlc.transcode(): VLC is not installed, cannot transcode "+t.src);let r=D(["vcodec=h264",pe(t.videoBitrateKbps,o=>"vb="+o),pe(t.width,o=>"width="+Math.floor(o)),pe(t.height,o=>"height="+Math.floor(o)),"venc=x264{ref=2:me=hex:mixed_ref=0:chroma_qp_offset=0:b_adapt=1:direct=1:weightp=1:rc_lookahead=20}","acodec=mp4a","ab=128","channels=2","samplerate=44100","scodec=none","deinterlace"]).join(","),i=["access=file{overwrite}","mux=mp4","dst="+t.dest.base].join(",");return je(e,[...zg,"--no-repeat","--no-loop",t.src.fileuri(),`--sout=#transcode{${r}}:standard{${i}}`,"vlc://quit"],{cwd:t.dest.dir,timeout:t.timeoutMs,ignoreStderr:!0})}var iwe=l(async()=>(0,dA.totalmem)()>16*Ld&&xt()>5&&await el()?2:1);async function l1(t){return await Qt(()=>I(t?.ignoreffmpeg)&&!pr?void 0:b(oA(),e=>({ok:!0,msg:"FFmpeg "+e})),()=>I(t?.ignorevlc)?void 0:b(uA(),e=>({ok:!0,msg:"VLC "+e.version})),()=>({ok:!1,msg:"(no video tools were found)"}))}var Rm=l(async()=>(await l1()).ok);U(()=>H(()=>Rm.unset()));var m1=t=>Ie(Ha({x:320*240,y:u.transcodeBitrateQVGA.valueOrDefault},{x:3840*2160,y:u.transcodeBitrateUHD.valueOrDefault},t),2);function u1(t,e){let r=d("img/Video.dim("+t+")"),i=u.minVideoDimension.valueOrDefault,o=e.ImageWidth;if(o!=null&&!Pr(o,i))return r.throw("invalid width: "+o,{ignorable:!0});let n=e.ImageHeight;if(n!=null&&!Pr(n,i))return r.throw("invalid height: "+n,{ignorable:!0});let s=T(sP(e),u.transcodeBitrateUHD.valueOrDefault),a=pe(o,c=>pe(n,p=>te(0,s,m1(c*p)))),m={width:o,height:n,videoBitrateKbps:a};return r.debug("dim()",{src:t,result:m}),m}async function km(t,e,r){if(!lr(e))return;let i=I(r?.useVlc)?!1:I(await ze(r?.useFfmpeg,()=>el())),o=!i&&I(await ze(r?.useVlc,()=>Ug()));if(!i&&!o)return;let n=d("img/Video.extractVideoFrame("+t+")"),s=await ro(t,"frame",".jpg");n.debug("extractVideoFrame",{dest:s.nativePath,mimetype:e});let a=await t.mtimeMs();if(a==null)return n.throw("null mtime");let m=await _e(t);if(m==null)return n.throw("no tags");let c=Mn(m);n.debug("video orientation:"+c);let p=As(m,c)?.dimensions,g=await s.stat(),w=g==null?void 0:await ki(s);if(g!=null&&g.mtimeMs>a&&w!=null&&(p==null||w.height===p.height&&w.width===p.width))return n.debug("prior dest, "+s+" seems reasonable",{srcDim:p,destDim:w}),s;let E=vn(m),R=Math.min(E??0,u.videoFrameAtSec.valueOrDefault);return n.info("extracted metadata",{startAtSec:R,duration:E}),await s.applyWip(async oe=>{let z=y({src:t,dest:oe,startAtSec:R},p);await(i?nA(z):fA(z)),await hA(oe),o&&c!=null&&c!==0&&(n.info("rotating in place..."+oe,{rot:c}),await XE(oe,c))}),s}async function c1(){return u.transcodeVideos.valueOrDefault&&(await el()||await Ug())}async function f1(t){let e=d("needsTranscoding("+t+")");if(!await c1())return e.tap({msg:"videoTranscodingSupported is false",result:!1});let r=await _e(t);if(r==null)return e.tap({msg:"Cannot transcode files that exiftool can't read",result:!1});let i=r.MIMEType;if(!lr(i))return e.tap({msg:"not transcoding (unsupported mimetype)",result:!1,meta:{mimetype:i}});let o=vn(r);if(!$s(o,u.minVideoDurationSec.valueOrDefault))return e.tap({msg:"not transcoding (video duration is too short)",result:!1,meta:{duration:o}});let n=_([r.AudioFormat]),s=n.some(p=>Ht(u.doNotTranscodeAudioCodecs.values,p)),a=_([r.VideoCodec,r.CompressorID,r.CompressorName]),m=a.some(p=>Ht(u.doNotTranscodeVideoCodecs.values,p)),c=Ht(u.doNotTranscodeMimetypes.values,i);return e.tap({msg:"result",result:!(s&&m&&c),meta:{mimetype:i,isSafeMimetype:c,audioCodecs:n,isSafeAudioCodec:s,videoCodecs:a,isSafeVideoCodec:m}})}async function gA(t,e){if(await f1(t)===!1)return;let r=await t.size();if(!C(r))throw new Error("transcode(): cannot read "+t);let i=await _e(t);if(i==null)throw new Error("Cannot transcode files that exiftool can't read");return Qe("video.transcode()",async()=>{let o=T(vn(i),60),n=Tg({bytes:r,durationMs:o*S,ext:t.ext}),s=y({src:t,timeoutMs:n},u1(t,i)),a=p1(r,s.videoBitrateKbps,o),m=a/3,c=async p=>{let g=Date.now(),w=new mn({path:t.nativePath,op:"Transcoding video"},a,async()=>{let R=T(await e.clear().size(),0),oe=(Date.now()-g)/n*a;return Math.max(R,oe)});s.dest=p;let E=await w.observe(await el()?sA(s):pA(s));if(E.code!==0)throw new Error("transcode failed with code "+E.code)};return e.applyIfEmpty_(p=>c(p),m)})}function p1(t,e,r){return Math.min(t,T(r,60)*T(e,1e3))}async function ZE(t,e){let r=d("img/Video.validVideo("+t+")");if(await km(t,e)==null&&r.throw("Could not extract a video frame"),await el())return aA(t)}var JA=P(require("luxon"));var At=P(require("exiftool-vendored")),gt=P(require("luxon"));var yA=P(require("luxon"));var Wg=14,d1=l(()=>yA.DateTime.local().offset,Ft);function bA(t){return t==null||Math.abs(t)>Wg*60?!1:t===0?d1()===0:!0}var qg=P(require("exiftool-vendored"));var h1=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/,_r=class{constructor(e,r,i,o=0,n=1){this.start=e;this.middle=r;this.end=i;this.index=o;this.splits=n;this.toISOString=this.toString.bind(this);this.year=No(this.middle),this.month=_o(this.middle),this.day=Ro(this.middle)}static fromISO(e){e=h(e).trim();let r=h1.exec(e);if(r==null)return;let i=qg.ExifDateTime.fromISO(r[1]),o=qg.ExifDateTime.fromISO(r[2]),n=G(r[3]),s=G(r[4]);return this.for(i,o,n,s)}static for(e,r,i=0,o=1){if(!xr(e)||!xr(r))return;let n=io(e),s=io(r);if(n==null||s==null)return;o=te(1,1e3,G(o,{defaultValue:1})),i=te(0,o-1,G(i,{defaultValue:0}));let a=f(n.toDateTime().until(s.toDateTime()).divideEqually(o+1)[i],m=>m.end);if(a!=null)return new _r(n,io(a,T(n.zone,s.zone)),s,i,o)}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return T(this.start.zone,this.end.zone)}get hasTimes(){return Rr(this.start)&&Rr(this.end)}toString(e=!0){return`${Cm(this.start,e)}/${Cm(this.end,e)}`+(this.index===0&&this.splits===1?"":`/${this.index}/${this.splits}`)}includes(e){if(e==null)return!1;let r=io(e);return r!=null?this.interval().contains(r.toDateTime()):this.year===No(e)&&this.month===_o(e)&&this.day===Ro(e)}};function Yf(t,e=2){return t==null?"":dr(t,e,"0")}function xr(t){if(t==null||typeof t=="string"||t===0)return!1;let e=gi(t);return e==null||e===0||!wA(No(t),_o(t),Ro(t))?!1:Rr(t)?ee(g1(t),r=>r.isValid,()=>!1):!0}function Fn(t,e){return xr(t)?e(t):void 0}var xA=l(()=>u.minValidYear.valueOrDefault,Ft),jg=l(()=>new Date(Date.now()+ot).getFullYear(),Ft),TA=l(()=>new Date(Date.now()+ot).getMonth()+1,Ft);U(()=>H(()=>{xA.unset(),jg.unset(),TA.unset()}));function y1(t){return St(xA(),jg(),t)}function b1(t,e){return Bi(e,jg())&&$s(t,TA())?!1:St(1,12,t)}function w1(t,e,r){return r!=null&&gt.DateTime.fromObject({year:t,month:e,day:r}).isValid}function wA(t,e,r){return y1(t)&&(e==null||b1(e,t)&&(r==null||w1(t,e,r)))}var il=class{constructor(e,r,i){this.year=e;this.month=r;this.day=i}static for(e,r,i){return wA(e,r,i)?new il(e,r,i):void 0}static localToday(){return Hg(new Date)}toString(){return D([this.year,this.month,this.day]).map(e=>Yf(e)).join("-")}toISOString(){return this.toString()}toDateTime(){return gt.DateTime.fromObject(this)}},vA=class{constructor(e,r,i,o,n){this.monthsToMonth=e;this.re=r;this.yearIndex=i;this.monthIndex=o;this.dayIndex=n}apply(e){let r=this.re.exec(e);if(r!=null){let i=parseInt(r[this.yearIndex],10),o=this.month(r),n=this.dayIndex==null?void 0:parseInt(r[this.dayIndex],10);return il.for(i,o,n)}else return}month(e){if(this.monthIndex==null)return;let r=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(r)?this.monthsToMonth.get(r):G(r)}},Bo="((?:19|20)[0-9]{2})",MA="(1[0-2]|0[1-9])",x1="(1[0-2]|0?[1-9])",SA="([1-3][0-9]|0[1-9])",Xf="([1-3][0-9]|0?[1-9])",T1="(1[0-9]|2[0-3]|0[0-9])",PA="([0-5][0-9])",v1=PA,M1=PA,Zf="([-\\.\\,:_/ |])",ep=Zf+"?",S1="(?:(\\.[0-9]+))?",EA="(?:(Z|UTC)|(?:([+-])([01][0-9]):?([0-5][0-9])))",P1=new RegExp("\\d\\d\\s*"+EA,"i");function Gg(t){return f(P1.exec(t),e=>AA(e.slice(1)))}function AA(t,e){if(L(t))return e;let[r,i]=t.splice(0,2),[o,n]=t.splice(0,2).map(s=>G(s));return Ht(["z","utc"],r)?0:Pw([i,o,n])?e:(i==="-"?-1:1)*(o*60+n)}function Kg(t){return q(t,e=>nx([()=>At.ExifDateTime.fromEXIF(e),()=>E1(e)],r=>xr(r)))}var A1=l(()=>d("FuzzyDate"));function DA(t,e=!1){if(!v(t))for(let{desc:r,f:i}of[{desc:"DateInterval.fromISO",f:()=>_r.fromISO(t)},{desc:"parseDateTime",f:()=>Kg(t)},{desc:"DateTime.fromFormat(macOS)",f:()=>gt.DateTime.fromFormat(t,"y-M-d 'at' H.m.s")},{desc:"DateTime.fromFormat(gnome)",f:()=>gt.DateTime.fromFormat(t,"y-M-d H-m-s")},{desc:"DateTime.fromFormat(yMMdd_HHmmss)",f:()=>gt.DateTime.fromFormat(t,"yMMdd_HHmmss")},{desc:"ExifDate.fromEXIF",f:()=>At.ExifDate.fromEXIF(t)},{desc:"fuzzyDate.parseYMD",f:()=>ol().parseYMD(t)},{desc:"new Date()",f:()=>e?new Date(t):void 0}]){let o=i();if(xr(o)){let n=Gg(t);return n!=null&&(o.tzoffsetMinutes=n),A1().tap({msg:"parseDated()",result:o,meta:{s:t,desc:r,tzoffsetMinutes:n}})}}}var FA=class{constructor(e){this.locale=e;this.monthsToMonth=new Map;this.ymdPatterns=[];this.ymPatterns=[];this.yPatterns=[];this.setup()}parseYMD(e){return Ge(this.ymdPatterns,r=>r.apply(e))}addParser(e,r,i,o){let n=new vA(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),r,i,o);o!=null&&i!=null?this.ymdPatterns.push(n):u.fuzzyYearParsing.valueOrDefault&&o==null&&i!=null?this.ymPatterns.push(n):u.fuzzyYearParsing.valueOrDefault&&o==null&&i==null&&this.yPatterns.push(n)}setup(){let e=["short","long"];for(let i of V([this.locale,"en-US"]))for(let o of e){let n=new Intl.DateTimeFormat(i,{month:o});xe(12,s=>{let a=n.format(new Date(2017,s));this.monthsToMonth.set(a.toLowerCase(),s+1)})}let r="("+cr([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(Bo+Zf+x1+"\\2"+Xf,1,3,4),this.addParser(Bo+ep+MA+"\\2"+SA,1,3,4),this.addParser(Bo+ep+r+"\\2"+Xf,1,3,4),this.addParser(r+ep+Xf+",?\\2"+Bo,4,1,3),this.addParser(Xf+ep+r+",?\\2"+Bo,4,3,1),u.fuzzyDateParsing.valueOrDefault&&(this.addParser(r+Zf+Bo,3,1),this.addParser(Bo+Zf+r,1,3)),this.addParser(Bo,1)}extractDateFromPath(e){if(!u.usePathsToInferDates.valueOrDefault)return;F1.forEach(i=>{Au(e,i)&&e.splice(0,i.length)}),e=e.filter(i=>M(i)&&e[0].match(D1)==null);let r=[...e].reverse();return Pi(()=>Ge(r,i=>this.parseYMD(i)),()=>this.parseYMD(r.slice(0,4).join(" ")),()=>this.parseYMD(e.slice(0,4).join(" ")),...u.fuzzyDateParsing.valueOrDefault?[()=>Ge(this.ymPatterns,i=>Ge(r,o=>i.apply(o))),()=>Ge(this.ymPatterns,i=>i.apply(e.join(" "))),()=>Ge(this.yPatterns,i=>Ge(r.slice(1),o=>i.apply(o)))]:[])}},D1=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P_?)\d+)$/i,L1=l(()=>{u.fuzzyDateParsing.addListener(()=>ol.unset()),u.fuzzyYearParsing.addListener(()=>ol.unset()),u.usePathsToInferDates.addListener(()=>ol.unset())}),ol=l(()=>(L1(),new FA(void 0))),F1=[];function LA(t){return ol().extractDateFromPath(t)}function Jg(t){return ol().parseYMD(t)}function IA(t){return t!=null&&(t instanceof il||t instanceof At.ExifDate||t instanceof At.ExifDateTime||t instanceof Date||t instanceof _r||t instanceof gt.DateTime||Tu([t.year,t.month,t.day]))}function No(t){return f(t,e=>e instanceof Date?e.getFullYear():e.year)}function _o(t){return f(t,e=>e instanceof Date?e.getMonth()+1:e.month)}function Ro(t){return f(t,e=>e instanceof Date?e.getDate():e.day)}function I1(t){return Rr(t)?t instanceof Date?t.getHours():t.hour:void 0}function OA(t){return Rr(t)?t instanceof Date?t.getMinutes():t.minute:void 0}function kA(t){return Rr(t)?t instanceof Date?t.getSeconds():t.second:void 0}function RA(t){return Rr(t)?t instanceof Date?t.getMilliseconds():t.millisecond:void 0}function _A(t){return Rr(t)&&(C(OA(t))||C(kA(t))||C(RA(t)))}function O1(t,e=!0){if(t==null)return;if(t===0)return e?"UTC":"";let r=t<0?"-":"+",i=ut(t/15)*15,o=Math.abs(i),n=Math.floor(o/60),s=Math.floor(Math.abs(o%60));return`${e?"UTC":""}${r}${Yf(n)}:${Yf(s)}`}function Ln(t){return t instanceof At.ExifDateTime?t.hasZone&&bA(t.tzoffsetMinutes):t instanceof gt.DateTime?t.zone!=null&&t.zone.type!=="local":!1}function $g(t){return t instanceof gt.DateTime?f(t.zone,e=>e.name):t instanceof At.ExifDateTime?t.zone:void 0}function E1(t,e=k1){let r=e.exec(t);if(r==null)return;let i=[...r.slice(1)],[o,n,s,a,m,c]=i.splice(0,6).map(R=>G(R));if(o==null||n==null||s==null||!u.fuzzyDateParsing.valueOrDefault&&(a==null||m==null))return;let p=te(0,999,ii(i.shift(),{defaultValue:0})*1e3),g=AA(i),w=O1(g),E=gt.DateTime.fromObject({year:o,month:n,day:s,hour:a,minute:m,second:c,millisecond:p,zone:w});return E.isValid?io(E,w):void 0}var R1="[-:_ ]?",k1=new RegExp([Bo,MA,SA,T1,v1,M1,S1].join(R1)+EA+"?","i");function g1(t){if(t instanceof gt.DateTime)return t;if(t instanceof At.ExifDateTime)return t.toDateTime();if(t instanceof _r)return t.middle.toDateTime();if(t instanceof Date)return gt.DateTime.fromJSDate(t)}function io(t,e){if(t==null||!Rr(t))return;if(t instanceof gt.DateTime)return At.ExifDateTime.fromDateTime(t);let r=gi(t);if(r==null)return;let i=v(e)?Ln(t)?$g(t):void 0:e,o=q(i,s=>_1(r,s));if(e!=null&&o==null)return;let n=f(No(t),s=>f(_o(t),a=>f(Ro(t),m=>f(I1(t),c=>new At.ExifDateTime(s,a,m,c,T(OA(t),0),T(kA(t),0),RA(t),o,t.rawValue)))));return xr(n)?n:void 0}function NA(t){if(t==null)return;if(typeof t=="number")return new Date(t);if(t instanceof Date)return t;if(t instanceof gt.DateTime)return t.toJSDate();if(t.toDate!=null)return t.toDate();if(C(t.year)&&C(t.month)&&C(t.day))return new Date(t.year,T(t.month,1)-1,t.day,12);let e=h(t);if(M(e))return f(N1(e),NA)}function gi(t){if(!(t==null||ct(t)))return se(t)?t:t instanceof Date?t.getTime():t instanceof gt.DateTime?t.toMillis():f(NA(t),e=>e.getTime())}function Qg(t){if(!(t==null||ct(t)))return se(t)?af(t):t instanceof At.ExifDateTime||t instanceof gt.DateTime?B1(t):t instanceof Date?af(t.getTime()):f(gi(t),af)}function B1(t){return parseInt([t.year,t.month,t.day,t.hour,t.minute,t.second].map(e=>jt(e)).join("")+"00")+sf(t.millisecond??0)}function BA(t){return f(t,e=>e instanceof At.ExifDateTime?e.tzoffsetMinutes:e instanceof gt.DateTime?e.offset:void 0)}function Yg(t){return f(t,e=>e instanceof gt.DateTime||e instanceof At.ExifDateTime||e instanceof Date?0:e instanceof At.ExifDate?ot:e instanceof _r?e.intervalMs:void 0)}function Cm(t,e=!0){if(t==null)return;if(t instanceof _r)return t.toString(e);let r=se(t)?new Date(t):t;return Rr(r)?f(io(r),i=>i.toISOString({includeOffset:e})):C1(r)}function N1(t,e){return typeof t!="string"||v(t)?void 0:W(At.ExifDateTime.fromISO(t,e)).orElse(()=>At.ExifDate.fromISO(t)).orElse(()=>At.ExifTime.fromEXIF(t)).get()}function C1(t,e="-"){return D([No(t),_o(t),Ro(t)]).map(r=>Yf(r)).join(e)}function Hg(t){return f(t,e=>f(No(e),r=>new il(r,_o(e),Ro(e))))}function CA(t,e){return fo(Xg(t,e),ot)}function Xg(t,e){let[r,i]=[t,e].map(gi);return r==null||i==null?void 0:r-i}function Rr(t){return t instanceof Date||t instanceof At.ExifDateTime||t instanceof gt.DateTime}function _1(t,e){let r=gt.Info.normalizeZone(e);return r.isValid?r.offset(t):void 0}function VA(t,e){return t instanceof gt.DateTime?t.setZone(e,{keepLocalTime:!0}):io(t,e)}var Co=class{static lift(e){return new class extends Co{apply(r){return e(r)}}}and(e){return Co.lift(r=>this.apply(r)&&e.apply(r))}or(e){return Co.lift(r=>this.apply(r)||e.apply(r))}filter(e){return e.filter(r=>this.apply(r))}asAsync(){return Re.lift(e=>Promise.resolve(this.apply(e)))}},Vwe=Co.lift(Ci),zwe=Co.lift(()=>!0);function Vm(t){return Co.lift(e=>Ca(e?.ext,t))}var Gwe=Vm(Et.SupportedByCurrentBrowser),Kwe=Vm(Et.Video),tp=Vm(Et.AssetFile);var oo=l(()=>d("TagInference"));async function zA(t,e){if(M(e.Make)&&M(e.Model))return;if(v(e.Make)&&(h(e.HandlerDescription)+h(e.CompressorName)).includes("GoPro")){e.Make="GoPro";return}let r=Vo(t),i=await Zg(t);if(i==null)return;let o=D(Y(Qn(i.younger,i.older))).slice(0,50).filter(n=>Mc(Vo(n),r)>.7).slice(0,10);oo().info("inferMakeAndModel("+t+"): looking at nearby siblings",o.map(n=>n.base));for(let n of o){let s=await _e(n);if(s!=null&&Uu(s.Make,s.Model)){oo().info("inferMakeAndModel("+t+")",{sibling:n.base,Make:s.Make,Model:s.Model}),e.Make=s.Make,e.Model=s.Model;return}}}async function UA(t){return b(V1(t),({before:e,after:r,index:i,slots:o})=>{if(!CA(e.date,r.date)){oo().debug("inferCapturedAtFromSiblings(): rejecting, not same day",{file:t.nativePath,before:h(e),after:h(r)});return}return f(_r.for(e.date,r.date,i,o),n=>({date:n,src:`before:${e.src},after:${r.src}`}))})}async function WA(t,e=7){return Wu(F(t).slice(0,e),(r,i)=>b(_e(r),o=>b(rp(o),n=>y(y({},n),{index:i}))))}async function z1(t,e=7){return Wu(t.slice(0,e),(r,i)=>b(_e(r),o=>b(rp(o),n=>W(n).filter(s=>Ln(s.date)).flatMap(s=>$g(s.date)).map(s=>({zoneName:s,index:i})).get())))}U(()=>H(()=>qA.prior()?.clear()));var qA=l(()=>new ke(1024));function V1(t){return qA().getOrSet(t.nativePath,async()=>{let e=await Zg(t),r=await WA(e?.younger),i=await WA(e?.older);return r==null||i==null?void 0:{before:r,after:i,index:r.index,slots:r.index+i.index+1}})}U(()=>H(()=>jA.prior()?.clear()));var jA=l(()=>new ke(2048,A));function Vo(t){let e=ct(t)?t:t.name;return jA().getOrSet(e,()=>(f(/(?:burst)(.{8,})$/i.exec(e),r=>e=r[1]),f(/^(?:(?:dsc[0f]?|img|mov|mvi|mvimg|vid|gpfr|gopro?|gp|gf|p)(?:[-_ ])?)(\S.+)$/i.exec(e),r=>e=r[1]),e.replace(/\s*-?\s*copy( \(?\d+\)?)?\s*$/i,"").replace(/\s*\((another |\d+[a-z]{2} )?copy\)\s*$/i,"").replace(/^[-\s_0]+/,"").replace(/[\s-_][\d\s]{0,2}$/,"").replace(/_cover$/i,"").toLowerCase().normalize()))}var U1=Vm(Et.AssetFile);async function Zg(t,e=7){let r=await t.parent().childDirectoryEntries(p=>p.isFile()&&!p.name.startsWith(".")&&!gm(p.ext)&&U1.apply(p));if(r==null){oo().info("nearestSiblings(): can't readdir parent, "+t.parent());return}let i=await t.statTimes();if(L(i)){oo().info("nearestSiblings(): statTimes() missing from "+t);return}let o=X(r,p=>Vo(p)),n=o.findIndex(p=>p.base===t.base);if(n<0){oo().warn("nearestSiblings(): can't find self in siblings: "+t);return}let[s,a]=[o.slice(n-e*2,n),o.slice(n+1,n+1+e*2)],m=[],c=[];for(;k(s)&&m.length<e;){let p=ne.forDirectoryEntry(s.pop());await HA(t,p)&&m.push(p)}for(;k(a)&&c.length<e;){let p=ne.forDirectoryEntry(a.shift());await HA(t,p)&&c.push(p)}return{younger:m,older:c}}function HA(t,e,r=2*ot){let i=Xg(Jg(t.base),Jg(e.base));return i!=null&&Math.abs(i)>r?!1:t.contemporary(e,r)}async function GA(t){let e=await Zg(t),r=Rw(F(e?.younger),F(e?.older)).slice(0,10);return oo().tap({msg:"nearestSiblingTzOffset("+t+")",result:await b(z1(r),i=>i.zoneName),meta:{zipped:r}})}async function KA(t){let e=Kg(Vo(t)),r=f(e,gi);if(e==null||r==null){oo().debug("extractStatBname() bname isn't dated",{bname:Vo(t),fromName:e,fromNameMs:r});return}let i=await t.stat();if(i==null){oo().debug("extractStatBname() no stat",{fromName:e,fromNameMs:r});return}return oo().tap({msg:"extractStatBname()",result:Ge(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],o=>Math.abs(i[o]-r)<Wg?{src:o,date:e}:void 0),meta:{fromName:e,fromNameMs:r,stat:i}})}var W1=l(()=>d("CapturedAt"));function q1(t){return h(t).toLowerCase().startsWith("tags")}var nl=class{constructor(e,r,i,o,n){this.nativePath=e;this.date=r;this.src=i;this.mtime=o;this.precisionMs=n;this.toISOString=l(()=>Cm(this.date))}spread(e){let r=y(y({},this),e);return new nl(r.nativePath,r.date,r.src,r.mtime)}toLocal(){return Qg(this.date)}toOffset(){return BA(this.date)}get isFromTags(){return q1(this.src)}toPrecisionMs(){return T(this.precisionMs,()=>Yg(this.date))}toString(){return O({nativePath:this.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return Ln(this.date)}hasTime(){return Rr(this.date)}};function $A(t){let e=X(t,r=>-r.mtime.getTime());return Pi(()=>e.find(r=>r.src.startsWith("tags")),()=>e.find(r=>r.src.startsWith("bname+stat")),()=>e.find(r=>r.src.startsWith("bname")),()=>e.find(r=>r.src.startsWith("siblings")),()=>e.find(r=>r.src.startsWith("path")),()=>t[0])}async function H1(t,e,r,i){let o=await r;if(!!xr(o))return Ln(o)?o:e!=null&&e.tz!=null&&JA.Info.isValidIANAZone(e.tz)?VA(o,e.tz):i?o:j1(t,o)}async function j1(t,e){if(!xr(e))return;if(Ln(e))return e;let r=await GA(t);if(r!=null){let i=io(e,r);if(xr(i))return i}return e}function G1(t,e){return t==null||e||!u.usePathsToInferDates.valueOrDefault||!u.useLibraryPathsToInferDates.valueOrDefault&&va(t.nativePath,u.libraryPath.value)}async function QA(t,e,r){let i=await t.mtime(),o=async(n,s)=>b(s,a=>b(H1(t,e,a.date,r),m=>new nl(t.nativePath,m,_([n,a.src]).join(":"),i,a.precisionMs)));return Qt(()=>o("tags",rp(e)),()=>o("bname+stat",KA(t)),()=>r?void 0:o("siblings",UA(t)),()=>r||!u.usePathsToInferDates.valueOrDefault?void 0:o("bname",f(DA(Vo(t)),n=>({date:n,src:"",precisionMs:sa([Yg(n),S])}))),()=>G1(t,r)?void 0:o("path",f(LA(t.pathnamesWithoutDrive),n=>({src:"",date:n}))),()=>u.useStatToInferDates.valueOrDefault?o("stat",b(t.minStatDate(),n=>({src:"",date:n}))):void 0)}var YA=["SubSecDateTimeOriginal","SubSecCreateDate","SubSecTimeDigitized","SubSecMediaCreateDate","DateTimeOriginal","OriginalCreateDateTime","CreateDate","DateTimeCreated","DateCreated","DateTimeDigitized","MediaCreateDate","DateTime","SubSecTime","ModifyDate","photoTakenTime"];function XA(t,e){return Fn(t[e],r=>({src:e,date:r}))}function rp(t){if(t==null)return;let e=D(YA.map(i=>({date:t[i],src:i,ts:f(gi(t[i]),o=>Math.floor(o/1e3))}))),r=e.filter(i=>xr(i.date)&&i.ts!=null);return gn(Ct.debug,()=>{W1().debug("capturedAtFromTags()",{rawArr:e,validArr:r})}),Pi(()=>bt(r,i=>f(Qg(i.ts),o=>[-Math.floor(o/1e8),Rr(i.date)?1:0,_A(i.date)?1:0,Ln(i.date)?1:0,-YA.indexOf(i.src)])),()=>XA(t,"DateTimeUTC"),()=>XA(t,"GPSDateTime"))}var K1=d("ExposureSettings");function ZA(t){let e={focalLength:t.FocalLength,iso:bd(t.ISO,t.ISOSpeed,t.SonyISO),aperture:bd(t.FNumber,t.Fnumber,t.ApertureValue,t.SonyFNumber),shutterSpeed:vu(t.ExposureTime,t.ShutterSpeed,t.SonyExposureTime)};return K1.debug("extracted from "+t.FileName,{exposureSettings:e}),Jn(e)}function eD(t,e){let r=Math.pow(2,e),i=[];for(;t>0;)i.unshift(t%r),t=Math.floor(t/r);return i}function zm(t){t.dims.forEach(r=>r.value=te(r.min,r.max,r.value));let e=0;for(let r=0;r<t.bitDepth;r++){e*=2;let i=r%t.dims.length,o=t.dims[i],n=It([o.min,o.max]);o.value>n?(e+=1,o.min=n):o.max=n}return e}function ip(t,e){if(e.bitDepth>52||e.bitDepth<0)return;let r=J1(t);for(let i=0;i<e.bitDepth;i++){let o=i%e.dims.length,n=e.dims[o],s=It([n.min,n.max]);r.includes(e.bitDepth-i-1)?n.min=s:n.max=s}return e.dims.map(i=>It([i.min,i.max]))}function J1(t){return t.toString(2).split("").reverse().map((e,r)=>e==="1"?r:-1).filter(e=>e!==-1)}var ey=30;function tD(t){return Math.floor(t/5)*5}function ty(t){return se(t)&&t!==0&&St(-90,90,t)}function ry(t){return se(t)&&t!==0&&St(-180,180,t)}function $1(t,e){return ty(t)&&ry(e)}function rD(t,e){return Q1(t,e,30)}function Q1(t,e,r=ey){return $1(t,e)?zm({dims:[{min:-180,value:e,max:180},{min:-90,value:t,max:90}],bitDepth:tD(r)}):void 0}function Y1(t,e=ey){return f(ip(t,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:tD(e)}),r=>r.reverse())}function iD(t,e=ey){let[r,i]=Y1(t,e);return{lat:r,lon:i}}var X1=12742e3;function oD(t,e){if(!(t==null||e==null))return t===e?0:Z1(iD(t),iD(e))}function Z1(t,e){let r=t.lat*Math.PI/180,i=e.lat*Math.PI/180,o=(e.lat-t.lat)*Math.PI/180,n=(e.lon-t.lon)*Math.PI/180,s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(r)*Math.cos(i)*Math.sin(n/2)*Math.sin(n/2),a=Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return X1*a}function iy(t){return ea(t?.timestamp,e=>Fn(new Date(e*1e3),r=>r))}async function op(t){return b(t.readJson("info"),e=>Mi({Title:td(e.title),Description:td(e.description),GPSLatitude:Ge([e?.geoData?.latitude,e?.geoData?.latitude],r=>ty(r)?r:void 0),GPSLongitude:Ge([e?.geoData?.longitude,e?.geoData?.longitude],r=>ry(r)?r:void 0),GPSAltitude:Ge([e?.geoData?.altitude,e?.geoData?.altitude],r=>se(r)?r:void 0),favorited:e.favorited==null?void 0:I(e.favorited),peopleNames:ge([...F(e.people),...F(e.person)],r=>_(r.map(i=>i.name))),creationTime:iy(e.creationTime),modificationTime:iy(e.modificationTime),photoTakenTime:iy(e.photoTakenTime),imageViews:ea(e.imageViews,r=>r)}))}function oy(t,e,r=""){let i=t.replace(e,r);return i===t?t:oy(i,e,r)}var eC=["BenQ","GoPro","HTC","LG","NEC","OnePlus","Sony","TrueHDR"],tC=new Map(eC.map(t=>[t.toLowerCase(),t]));function rC(t){let e=t.trim(),r=tC.get(e.toLowerCase());return r??(e.length<4?e:e.toLowerCase().replace(/(?:^|\s|-)\S/g,i=>i.toUpperCase()))}var nD=class{constructor(){this.ignorables=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|");this.ignorableSep="[\\s\\.,_-]*";this.IgnorableMakePatterns=new RegExp(`${this.ignorableSep}(?:${this.ignorables})${this.ignorableSep}$`,"i");this.IgnorableModelPatterns=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i];this.samsungPatterns=[[/^PL150 /,"PL150"],[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-G98[01]/,"Galaxy S20"],[/^SM-G98[56]/,"Galaxy S20+"],[/^SM-G988/,"Galaxy S20 Ultra"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]];this.lgPatterns=[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]];this.onePlusPatterns=[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]];this.CommonNamesByMake={Samsung:this.samsungPatterns,LG:this.lgPatterns,OnePlus:this.onePlusPatterns}}},ny=l(()=>new nD);function Um(t){return q(t,e=>(e=gd(e),e=oy(e,ny().IgnorableMakePatterns),e=e.replace(/\s+app on Apple iDevice$/i,""),e=e.replace(/\bLGE\b/,"LG"),e=rC(e),e))}var iC=/<(.+?)[,/].+>/;function sD(t,e){if(v(t)||v(e))return;let r=gd(e);if(t==="Samsung"){let o=iC.exec(r);o!=null&&(r=o[1])}let i=f(ny().CommonNamesByMake[t],o=>o.find(([n])=>r.match(n)!=null));if(i!=null)return i[1].trim();t==="Sony"&&(r=r.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"\u03B1").replace(/7CL/i,"7c").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V").replace(/M6$/," VI").replace(/M7$/," VII").replace(/M8$/," VIII").replace(/M9$/," IX").replace(/M10$/," X").replace(/M11$/," XI")),t==="Olympus"&&(r=ee(/^(.+?\d)mark(i.+?)$/i.exec(r),o=>`${o[1]} Mark ${o[2]}`,()=>r)),t==="Canon"&&(r=r.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel"));for(let o of ny().IgnorableModelPatterns)r=oy(r,o).trim();return r=r.replace(new RegExp(`^${ht(t)}\\s+`,"i"),""),t.match(/^HP|Hewlett.Packard$/i)!=null&&r.match(/^hp\b/i)!=null&&(r=r.slice(2).trim()),r}var oC=/\b(n\/a|unknown)\b/i;function nC(t){return t.filter(e=>M(e)&&oC.exec(e)==null)}var aD=l(()=>d("LensMakeModel"));function np(t){let e=Um(t.LensMake),r=Um(t.Make),i=nC([e,t.LensMake,r,t.Make]),o=a=>(a=mD(a),i.reduce((m,c)=>Gu(m,c).trim(),a)),n=Ge([t.LensInfo,t.LensSpec,t.LensModel,t.LensID],lD),s=D([t.LensID,t.LensModel,t.LensSpec,t.LensInfo]);aD().debug("extractLensMakeModel",{lensMake:e,lensInfo:n,lensModels:s});for(let a of s){let m=lD(a)!=null;if(aD().debug("extractLensMakeModel",{lensModel:a,hasLengthAndAperture:m}),!!m){if(M(e))return{lensMake:e,lensModel:o(a),lensInfo:n};if(a.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:o(a),lensInfo:n};for(let c of _([e,r,...u.lensMakes.values]))if(a.toLowerCase().includes(c.toLowerCase()))return i.unshift(c),{lensMake:c,lensModel:o(a),lensInfo:n}}}}function lD(t){if(v(t)||h(t).toLowerCase().includes("unknown"))return;let e=sC(t.replace(/\b(AF-S|DG|Digital|DI|DX|E|ED|HSM|LM|OIS|Pro|R|XF)\b/gi,"")),r=/[\d.-]+mm/.exec(e)?.[0],i=/f\/[\d.-]+/.exec(e)?.[0];if(!(r==="0mm"||i==="f/0"))return Wn(r,i,(o,n)=>`${o} ${n}`)}function mD(t,e=3){return t.replace(/\d+\.\d+/g,r=>ee(ii(r),i=>String(Ie(i,e)),r))}function sC(t){return mD(t).replace(/(\d) - (\d)/g,(e,r,i)=>`${r}-${i}`).replace(/(\d)\s+mm\b/,(e,r)=>r+"mm").replace(/\s+f\/?(\d)/i,(e,r)=>" f/"+r)}function uD(t){let e=V(["OLYMPUS DIGITAL CAMERA",t.originalMake,t.originalModel,t.Model,t.Make,t.CameraID]).map(i=>q(i,o=>o.trim().toLowerCase().normalize())),r=(...i)=>{for(let o of i){let n=h(t[o]).trim();if(M(n)&&!e.includes(n.toLowerCase().normalize()))return n}};return Mi({title:r("XPTitle","Title","ObjectName"),description:r("XPSubject","Description","ImageDescription","Caption-Abstract")})}var no=l(()=>d("ExifTags")),aC=!1;function lC(){return u.exiftoolProcsPerChild.value??(xt()>4?3:2)}var sy=l(()=>new nm("ExifTool",new cD.ExifTool({logger:()=>d("ExifTool"),maxProcs:lC(),maxIdleMsPerProcess:5*A,maxTasksPerProcess:u.maxTasksPerProcess.valueOrDefault,cleanupChildProcs:!1}),me.service,!0).t);function Dm(){let t=sy();return t.ended?sy.refresh():t}function pD(){return f(sy.prior(),t=>t.ended?void 0:Oe(t.version(),J,()=>{throw new Error("ExifTool timed out")}))}fa((t,e)=>b(dD(t),r=>{let i=ne.for(e);return sp.getOrSetAsync(i.nativePath,()=>Promise.resolve(y(y({},r),{SourceFile:i.nativePath,FileName:i.base,Directory:i.dir})))}));function $E(t,e,r){return Dm().extractBinaryTag(t,e,r)}var sp=new Ji({maxSize:128,timeoutMs:A}),ap=new Ji({maxSize:128,timeoutMs:A});function hD(){sp.clear(),ap.clear()}U(()=>H(hD));nr(t=>{v(t)?hD():(sp.deleteIf(e=>e.startsWith(t)),ap.deleteIf(e=>e.startsWith(t)))});var gD=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];async function yD(t,e){let r=i=>b(_e(i,!1),o=>qt(o,...gD));return await $n(t.clear().sha(),e.clear().sha())||await $n(r(t),r(e))}async function yi(t){if(t==null)return;let e=ne.for(t);if(!(await e.isEmpty()||await e.isNotReadable()))return Qe("tags.readTags",async()=>b(_e(e),r=>mC(e,r)))}async function dD(t){return sp.get(String(t))}async function Io(t){if(v(t))return;let e=ne.for(t);return Qt(()=>b(ap.get(e.nativePath),r=>r.MIMEType),()=>b(dD(e),r=>r.MIMEType),()=>b(Fm(e.nativePath),r=>r.mime==="image/tiff"?void 0:r.mime),()=>TM(e.ext)?b(_e(e,!1),r=>r.MIMEType):void 0)}async function Xa(t,e){let r=ne.for(t),i=e==null||v(e.ImageHeight)?await _e(r):e;if(i==null)return;let o=T(Mn(e),()=>Mn(i)),n=An(i.MIMEType)?await Of(r).catch(a=>{no().warn("Failed to read raw info",{file:r.nativePath,err:ae(a)})}):void 0,s=As(i,o,n);if(s!=null)return s;if(lr(i.MIMEType))return b(km(r,i.MIMEType),a=>Xa(a,i))}async function hA(t){await Dm().deleteAllTags(t.nativePath),await t.sibling(t.base+"_original").unlink("trace")}async function _e(t,e=!0){let r=ne.for(t);if(!!await r.isFile())return Qe("tags.readRawTags",async()=>{let i=await bD(r.nativePath);if(i==null||!e)return i;let o=os(r.jsonSidecars(),op),n=os(r.sidecars(),a=>bD(a.nativePath)),s=y({},i);for(let[a,m]of[...await o,...await n]){let c=qt(a,...gD);k(Mt(c))?((s.sidecars??(s.sidecars=[])).push(m.base),ma(s,c),no().debug("readRawTags() sidecar had values",{sidecar:m.base,safeTags:c})):no().debug("readRawTags() sidecar was empty",{sidecar:m.base})}return s})}var ay=new Bt,ly=new Bt;B||(ay.resolve(),ly.resolve());async function bD(t){return ap.getOrSetAsync(t,async()=>{no().debug("_readRawTags("+t+") not cached, reading now.");let e=ay.pending;e?ay.resolve():await ly.promise;let r=hm((0,fD.extname)(t))?[]:void 0,i=await Qe("exiftool.read()",()=>Oe(Da(Dm().read(t,r).catch(o=>{no().info("Failed to read "+t,o)})),J));return e&&ly.resolve(),f(i,o=>(no().debug("_readRawTags("+t+") in "+o.elapsedMs+"ms"),f(o.result,n=>{for(let a of yt(n)){let m=n[a];if(typeof m=="string"){let c=BE(m);c!=null&&(n[a]=c)}}let s=_([n.Error,...T(n.errors,[]),n.Warning].map(h));return k(s)&&(n.problems=s),n.exiftoolMs=o.elapsedMs,aC&&(n.instance=cf()),n})))})}async function mC(t,e){if(e==null)return;let r=e.MIMEType,i=t.nativePath;if(v(r)){no().debug("No mimetype for "+t);return}let o=t.nativePath.startsWith(u.cacheDir.valueOrDefault)||t.pathnames.includes(".photostructure");o||await zA(t,e);let n=e;n.originalMake=e.Make,n.originalModel=e.Model,e.Make=Um(e.Make),e.Model=sD(e.Make,e.Model);let s=np(e),a=await QA(t,e,o);if(a==null){no().info("No capturedAt for "+t);return}let m=ZA(e),c=await Xa(t,e);if(c==null){no().info("No size info for "+i);return}let p=r.startsWith("video/")?vn(e):void 0,g=y(y(y(y({mimetype:r,exposureSettings:m},uD(n)),s),c),{duration:p,capturedAt:a,tz:e.tz});return no().debug("parsedTags",y(y({nativePath:i},g),{capturedAt:f(a,w=>({date:w.date,src:w.src}))})),y(y({},n),g)}function zo(t){let e=t;return e==null?void 0:C(e)?e:Zs(e.id,-20)?e.id:C(e.assetId)?e.assetId:Pu(e.tagId)?e.tagId:void 0}function wD(t,e){return jo(zo(t),zo(e),(r,i)=>r===i,()=>!1)}var AD=P(require("util"));var my=l(()=>d("AssetFileSorter")),uC=[pi,"file",Lo,Yi];function cC(t){return f(t,e=>Ho(e.width,e.height,(r,i)=>xD(r*i)))}function xD(t){return Math.round(Math.pow(t,u.variantSortCriteriaPower.valueOrDefault))}function fC(t){return Math.round(t/(2*A))}function sl(t){for(let i of V(t.map(o=>o.sha))){let o=t.filter(s=>s.sha===i),n=Math.max(...D(o.map(s=>s.mtime)));o.forEach(s=>s.mtime=n)}let e=D(t.map(i=>f(pC(i),o=>f(dC(o),n=>({f:i,crit:n,pojo:o}))))),r=X(e,({crit:i})=>i);return ge(r,i=>i.map(o=>o.f))}function pC(t){let e=cC(t),r=Be.parse(t.uri);if(v(r.scheme)||v(r.path)||t.mtime==null){my().debug("assetFileSortCriteriaPojo(): skipping",{af:t,parsedURI:r});return}let i=uC.indexOf(r.scheme);if(i===-1){my().debug("assetFileSortCriteriaPojo(): skipping",{af:t,schemeIdx:i,parsedURI:r});return}let o=Qx(r.path),n=o.base.toLowerCase().includes("cover"),s=vM(o.ext),a=T(Zx(o.name),0),m=fC(t.mtime),c=Vi(t.fileSize,xD),p={resolution:e,mtime:m,schemeIdx:i,fileSize:c,isCover:n,count:a,isBrowserSupported:s},g={};for(let w of u.variantSortCriteria.values)f(p[w],E=>g[w]=E);return g.uri=t.uri,g}function dC(t){let e=Mt(t);if(e.some(r=>r==null)){my().debug("pojoToCriteria(): skipping",{pojo:t});return}else return e}function TD(t,e,r){let o=Ye.fit().map(a=>[a.outputSize(t),a]).filter(([a])=>a!=null),n=t;function s(a,m){let c=kr(n)/kr(a),g=m===0&&(r!=="image/jpeg"||C(e))||c>3||kr(a)-kr(n)>2.5;return g&&(n=a),g}return o.filter(([a],m)=>s(a,m))}function vD(t){return t==="qhd"?"wvga":t==="uhd"?"uhd4k":t}function MD(t,e){return Du(_(t).map(vD),_(e).map(vD))}var SD=P(require("sharp"));var hC=l(()=>d("Sharp"));async function PD(t){try{let{data:e,info:r}=await t.raw().toBuffer({resolveWithObject:!0});return gC(e,r)}catch(e){return hC().info("Failed to buffer-clone sharp",e),t.clone()}}function gC(t,e){return(0,SD.default)(t,{raw:e})}var wMe=require("sharp"),yC=l(async()=>{let t=ne.for(jr.ICC()),e={};for(let r of u.iccProfileMappings.valueOrDefault){let[i,o]=r.split(":"),n=t.join(o);await n.isNonEmptyFile()?e[i]=n.nativePath:d("SharpColorspace").warn(" iccProfileMappings has an invalid ICC profile filename: "+o)}return Object.freeze(e)});async function ED(t,e){let o=(await _e(t,!1))?.ProfileDescription;if(!v(o)){let n=await yC();for(let s of yt(n))if(o.includes(s))return e.withMetadata({icc:n[s]})}return e.toColorspace("srgb")}var bC=require("sharp"),uy=class{constructor(e,r){this.ap=e;this.assetFiles=r;this.badShas=new gs(2*A);this.logger=d("AssetPreviewBuilder("+e.assetId+")")}[AD.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build_(e){return Qe("img.AssetPreviewBuilder.build()",async()=>{let r=D(await sl(await this.assetFiles));for(this.logger.info("build_(): asset file candidates:",r.map(i=>i.uri).reverse());k(r);){let i=r.pop(),o=await ne.forUri(i.uri);if(o==null)continue;let n=await o.sha();if(!(n==null||this.badShas.has(n)))try{return await this._build(o,i,e)}catch(s){this.badShas.add(n),this.logger.warn("Failed to set shown file to "+i,ae(s))}}return this.logger.throw("none of the files are valid",{ignorable:!0,retriable:!1})})}async _build(e,r,i){this.logger.info("_build("+e+")",{uri:r.uri}),I(i.validate)&&await Nm(e);let o=await e.size(),n=await e.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:o,mtime:n,best:r}),o==null||n==null)return this.logger.throw("build(): missing stat info for best file",{ignorable:!0,best:r});if(r.width==null||r.height==null||r.mimetype==null||r.sha==null)return this.logger.throw("IE build(): missing fields for best file "+e,{ignorable:!0,best:r});let s=TD(r,r.rotation,r.mimetype),a=y(y({assetFileId:r.id},rt(r,"assetId","uri","width","height","mimetype","sha","rotation")),{path:e.nativePath,mtime:n,filesize:o,fitSizes:s.map(([,Q])=>Q.name).join(",")});if(i.force!==!0&&!u.forceSync.valueOrDefault){let Q=await this.ap.readInfo.refresh();if(Q!=null){if(Q.assetId!==a.assetId)throw new Error("IE build(): Mismatched asset IDs for "+r+": "+O({priorInfo:Q,info:a}));let K=Q.fitSizes.split(","),Ze=a.fitSizes.split(",");if(Q.sha!=null&&Q.sha===a.sha&&Q.rotation===a.rotation&&MD(K,Ze)){let _t=Iu(K,Ze);if(k(_t)){this.logger.info("build(): removing previews that aren't required anymore.",{leftovers:_t});for(let rr of _t){let Ni=s.find(([,Un])=>Un.name===rr);if(Ni==null)this.logger.warn("build(): Failed to clean up: missing fit size",{fitsize:Ni,fits:s});else{let Un=this.ap.fileForWidth(Ni[1].reducer.name,Ni[0].width);this.logger.debug("build(): unlinking unwanted preview "+Un,{fitsize:Ni}),await Un.unlink("warn")}}}return this.logger.debug("build(): SHA and rotation match, and previews exist.",{info:a,priorInfo:Q}),await this.ap.writeInfo(a),a}}}let m=new ln({path:e.nativePath,op:"Building previews for"},Ye.sq().length+Ye.fit().length);if(this.logger.debug("Rebuilding all previews from "+r.uri,{assetId:r.assetId,best:r,info:a}),await this.ap.parent.mkdirp()==null)throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+r);let c=await this.ap.existingFiles(),p=await Is(e,Ye.largestFit().max);if(p==null)throw new ue({message:"AssetPreviewBuilder.build(): "+r.uri+", "+e.nativePath+", is not readable by sharp.",retriable:!1});let g=await ED(e,bC(p.nativePath));r.mimetype.startsWith("image/")&&!Fs(r.mimetype)&&r.rotation!=null&&r.rotation!==0&&(g.rotate(r.rotation),this.logger.debug("build(): rotating "+r.rotation+"\xB0")),p.name.toLowerCase().includes("thumbnail")&&pt(()=>g.trim(1));let w=[],E,R,oe=Ye.largestSq(),z=xo(s,([Q,K])=>f(oe.outputSize(Q),()=>K.megapixels()))?.[1].name,we=rt(r,"width","height");{let Q=g.clone(),K=we;for(let[Ze,_t]of s){let rr=Date.now(),Ni=K,Un=this.ap.fileForWidth(_t.reducer.name,Ze.width).wip();Q=_t.resize(Ze,Q),K=Ze,_t.name===z&&(R=Q.clone(),E=Ze),await _t.toJpeg({path:Un.nativePath,sh:Q,outputSize:Ze}),m.onProgress(),this.logger.debug("resize("+_t.name+") "+$r(Ni)+" -> "+$r(Ze)+" in "+(Date.now()-rr)+" ms"),w.push(Un)}}{R==null?(this.logger.debug("square resize(): resorting to ",{origDim:we,bestFitNameForSq:z}),R=g,E=we):this.logger.debug("square resize(): using to ",{sqDim:E,bestFitNameForSq:z});let Q=!1;for(let K of Ye.sq()){let Ze=Date.now(),_t=E,rr=K.outputSize(T(E,we));if(rr==null){this.logger.debug("skipping square output for "+K.max);continue}Q||(rr.position=u.squareThumbStrategy.valueOrDefault,Q=!0),this.logger.debug("Applying ",{outputSize:rr});let Ni=this.ap.fileForWidth(K.reducer.name,rr.width).wip();K.resize(rr,R),rr.position!=null&&(this.logger.debug("Cloning square crop to make position consistent",{outputSize:rr}),R=await PD(R)),E=rr,await K.toJpeg({path:Ni.nativePath,sh:R,outputSize:rr}),m.onProgress(),w.push(Ni),this.logger.debug("resize("+K.name+") "+$r(_t)+" -> "+$r(rr)+" in "+(Date.now()-Ze)+" ms")}}try{await Promise.all(c.map(Q=>Q.unlink())),await Promise.all(w.map(Q=>Q.unwip_())),await this.ap.writeInfo(a),this.logger.debug("Previews unwipped and info written",{info:a})}catch(Q){throw await ye(w,K=>K.unlink()),new ue({cause:Q,fatal:!1,message:"Failed to create previews from "+e})}return a}};var lp=class{constructor(e,r=""){this.query="";if(this.query=r,this.assetId=zo(e),this.assetId==null)throw new Error("internal error: null asset id "+O({id:e}))}static onNewPage(){this.pageImageCount=0}get unset(){return this.assetId==null||this.assetId<=0}assetUrl(){return this.unset?"":`/asset/${this.assetId}${this.query}`}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,r){return`/img/${this.assetId}/${e}/${r}${this.query}`}imgActualLink(e){return`/img/${D([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e,r="m"){return y(y({},this.imgAttrs("sq",dx,e)),{sizes:r==="s"?"80px":r==="m"?"160px":"320px"})}imgAttrs(e,r,i,o){if(this.unset)return{src:"/images/clear-64.png"};let n=Math.min(...r),s={width:h(n)},a=this.imgLink(e,n);lp.pageImageCount++,i=T(i,()=>lp.pageImageCount>72),i?(s.src="/images/clear-64.png",s["data-src"]=a):s.src=a,e===er.sq&&(s.height=h(n));let m=r.map(c=>DD(this.imgLink(e,c),c));return f(o,c=>m.push(DD(this.imgActualLink(),c.width))),s[(i?"data-":"")+"srcSet"]=m.join(","),s}},In=lp;In.pageImageCount=0;function DD(t,e){return t+" "+e+"w"}var wC=d("extractPreviewInfo");function Wm(t,e){let r=e.posixPathFrom(t).replace(/\//g,"").split("-"),i=G(r[0]),o=r[1],n=er.validOrElse(o,void 0),s=Ju(r[2]);if(C(i))return{file:e,assetId:i,reducer:n,width:s};wC.warn("Failed to extract preview info",{file:e,previewsRoot:t,arr:r,assetId:i,reducer:n,width:s})}async function FD(t,e){return Wn(e.assetId,e.width,(r,i)=>b(ki(e.file),o=>{let n=uP(o),s=hr(t,Yx(t));return{size:n,basename:`${s}-${n}${e.file.ext}`,title:cy(e.file,n,"image",o),description:`Download ${n}`,details:`(${$r(o)} ${e.file.ext})`,href:new In(r).imgLink(er.fit,i)}}))}function cy(t,e,r,i){return`Download ${e} ${t.ext} ${r} (${$r(i)})`}var BSe=new Fa,fy=class{constructor(e,r,i){this.previewsRoot=e;this.alp=i;this.readInfo=l(()=>this.infoJson().readJson("debug"));this.logger=d("AssetPreviews(assetId:"+zo(r)+")"),this.assetId=zo(r),this.urls=new In(r);let o=dr(this.assetId,8,"0"),n=$o(o,3);this.basename=n.pop()+"-",this.parent=e.join(...n)}existingFiles(){return ze(this.parent.childFiles(e=>e.base.startsWith(this.basename)),()=>[])}existingJpgs(){return ze(this.parent.childFiles(e=>e.base.startsWith(this.basename)&&e.ext===".jpg"),()=>[])}async previews(){let e=await this.existingFiles();return Vl(D(e.map(r=>Wm(this.previewsRoot,r))),r=>r?.file.size())}async deleteAll(){this.parent.clear();let e=await this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return await Promise.all(e.map(r=>r.unlink())),e}file(e){return this.parent.join(this.basename+e)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(e){return this.readInfo.unset(),this.infoJson().writeJsonMaybe(e,{spaces:2})}fileForWidth(e,r){return this.file(e+"-w"+r+".jpg")}filesForReducer(e){let r=this.basename+e+"-";return this.existingFiles().then(i=>i.filter(o=>o.base.startsWith(r)))}async smallestFileForReducer(e){return xo(await this.filesForReducer(e),r=>T(f(Wm(this.previewsRoot,r),i=>i.width),0))}async largestFileForReducer(e){return bt(await this.filesForReducer(e),r=>T(f(Wm(this.previewsRoot,r),i=>i.width),0))}async widths(e){let r=await this.filesForReducer(e);return cr(D(r.map(i=>f(Wm(this.previewsRoot,i),o=>o.width))))}async posterLink(){let e=await this.widths(er.fit);return this.urls.imgLink(er.fit,Math.max(...e))}async imgAttrs(e,r=!1,i=!0){if(!r&&e===er.sq)return this.urls.sqImgAttrs(i);{let o=e===er.fit?await this.readInfo():void 0;return this.urls.imgAttrs(e,await this.widths(e),i,o)}}};var py=class{constructor(e,r){this.root=e;this.alp=r;this.id2ap=new ke(512)}async build_(e){return this.apb(e.assetId,e.assetFiles).build_(e)}apb(e,r){return new uy(this.ap(e),r)}ap(e){let r=h(zo(e)),i=this.id2ap.get(r);if(i!=null&&wD(e,i.assetId))return i;{let o=new fy(this.root,e,this.alp);return se(e)||this.id2ap.set(r,o),o}}clearAssetId(e){this.id2ap.delete(h(e))}};var xC=l(()=>d("Broadcaster")),dy;(function(e){e.broadcast=async(r,i)=>(xC().warn("broadcast sent to no-op",{event:r,args:i}),!1)})(dy||(dy={}));var hy=dy;var mp=hy;function LD(t){mp=t}function ID(t){mp===hy&&(mp=t)}function qm(t,e){mp.broadcast(t,e)}var ND=P(require("net"));var _D=P(require("process"));var OD=P(require("os")),kD=P(require("process"));var TC=0,vC=l(()=>Wr((0,OD.hostname)()+String.fromCharCode(31)+kD.pid)+"-");function up(){return vC()+ms.encode(++TC)}var RD=P(require("util"));var gy=class{constructor(e,r,i,o){this.id=e;this.method=r;this.params=i;this.timer=o;this.start=Date.now();this.name="rpc.RequestResponse("+r+")#"+e,this.d=new Kt(this.name)}[RD.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),f(this.d.settledMs,r=>this.timer.push(this.method,r)))}reject(e){return this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}};var MC=(Pe?7:30)*S,SC=Pe?500:5*S,PC={requestTTL:MC,retriesPerRequest:5,delayBetweenRetries:SC,maxPendingRequests:10},EC=0,yy=class extends $e{constructor(e,r,i={}){super("rpc.Client("+e+"#"+EC+++")",()=>this.onEnd(),me.first);this.streamFactory=r;this.mkStreamRate=new on(A);this.pending=new Map;this.times=new Fa;this.changeListeners=[()=>this.mkStreamRate.onEvent()];this.stream=l(async()=>{try{if(this.flapping)return this.onError("stream() is restarting too frequently (epm: "+this.mkStreamRate.eventsPerMinute+")");let e=await this.streamFactory();return e==null?this.onError("streamFactory() returned null"):(this.changeListeners.forEach(r=>r()),e.on("end",r=>this.onFinish("on(end)",r)),e.on("close",r=>this.onFinish("on(close)",r)),e.on("error",r=>this.onError("stream error",r)),un(e,`
`,r=>this.onData(r)),e)}catch(e){return this.onError("streamFactory rejection",e)}});this.ping=l(()=>this.request("ping",{serviceName:Xt(),pid:_D.pid}),250);this.opts=y(y({},PC),i),this.stream()}onEnd(){return this.logger.info("end()",{ending:$(),timings:this.times.report(),pendingSize:this.pending.size}),this.pending.clear(),this.close()}addChangeListener(e){this.changeListeners.push(e)}get flapping(){return this.logger.tap({level:Pe?"debug":"trace",msg:"flapping()",result:this.mkStreamRate.msSinceLastEvent<this.opts.delayBetweenRetries||Zs(this.mkStreamRate.eventsPerMinute,3),meta:{msSinceLastStream:this.mkStreamRate.msSinceLastEvent,mkStreamRatePerMin:this.mkStreamRate.eventsPerMinute}})}broadcast(e,r){return this.request("broadcast",{event:e,args:r})}sendRecentLogs(){return this.request("sendRecentLogs")}async ready(){return this.ended?(this.logger.debug("ready(): false (ended)"),!1):await this.stream()!=null}async request(e,r){if(this.ended){if($())return;throw new Error("client is ending")}if(v(e))throw new Error("method cannot be blank");return this.submit(e,r)}async submit(e,r){let i=await this.stream();if(i==null)return this.onError("submit("+e+"): stream is closed");let o=up(),n=new gy(o,e,r,this.times);return n.setTimeout(this.opts.requestTTL),this.pending.set(o,n),n.d.finally(()=>this.pending.delete(o)),this.logger.log(Pe?"debug":"trace","sending request",{id:o,method:e,params:r}),i.write(O({id:o,method:e,params:r})+`
`),n.response}close(){return this.logger.info("close()",{ended:this.ended}),b(this.stream.clear(),Ki)}onData(e){if(!v(e))try{this.logger.log(Pe?"debug":"trace","onData()",{req:e});let r=JSON.parse(e);if(v(r.sid))throw new Error("response is missing server id");if(this.sid!==r.sid&&(this.sid!=null&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:r.sid}),ve.emit("rpcServerChange")),this.sid=r.sid,$()))return;if(r.id==null)if(M(r.event)){this.logger.trace("re-broadcasting event",r),ve.emit(r.event,r.args);return}else throw new Error("missing request id from response");let i=this.pending.get(r.id);this.pending.delete(r.id),i==null?this.logger.warn("unknown or stale request ID",{resp:r,pendingIds:[...this.pending.keys()]}):r.error!=null?(i.reject(r.error),this.logger.warn("Rejected",{resp:r,rr:i})):(i.resolve(r.result),this.logger.debug("Resolved",r.result))}catch(r){this.logger.warn("invalid input: "+e,r)}}async onError(e,r){return this.logger.warn(e+" onError(): "+f(r,i=>T(i.stack,i))),this.restart()}async restart(){if(this.logger.info("restart()",{ended:this.ended,flapping:this.flapping}),await this.close(),this.ended||$()){this.logger.warn("restart(): Ending. Rejecting new connection.");return}if(this.flapping){this.logger.warn("restart(): Too many recent errors, we'll try reconnecting again in a bit",{errPerMin:this.mkStreamRate.eventsPerMinute});return}let e=await this.stream();if(e!=null){let r=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+r.length+" jobs now."),r.forEach(i=>i.reject("restarting"+ha)),e}else{this.logger.warn("restart(): stream() returned null");return}}onFinish(e,r){if(this.ended)return;let i=r==null||r===!1;return this.logger.info("onFinish",{source:e,error:r,restarting:i}),i?this.restart():this.onError(e,r)}};var by=d("RpcClient");function AC(t){let e=new Bt,r=new ND.default.Socket;return r.on("error",i=>e.reject(i)),r.connect(t,"localhost",()=>{by.debug("Connected to "+t),e.resolve()}),e.then(()=>r)}var kn=l(()=>{if(bn())return;let t=u.rpcPort.valueOrDefault;by.debug("Creating new RPC client to "+t);let e=new yy("db@localhost:"+t,()=>AC(t));return e.addChangeListener(()=>On.unset()),e}),On=l(async()=>{try{if(bn())return!1;let t=await Oe(f(kn(),e=>e.ping()),S);return M(t)}catch(t){return by.warn("rpcClientReady(): ping failed",t),!1}},A);var BD=P(require("process"));var DC=require("net"),Yr=d("rpc.Server"),FC=({params:t,conn:e})=>(q(t.serviceName,r=>{v(e.serviceName)&&(e.serviceName=r)}),pe(t.pid,r=>{v(e.pid)&&(e.pid=r)}),`pong to ${e.serviceName}@${e.pid} from ${Xt()}@${BD.pid} at ${new Date}`),CD=class{constructor(e){this.socket=e}toString(){return v(this.serviceName)?xa(this.socket):`${this.serviceName}:${this.pid}`}},wy=class{constructor(e,r=!0){this.port=e;this.unref=r;this._ended=!1;this._ready=new Bt;this.connections=[];this.onPause=()=>this.broadcast("pause");this.onResume=()=>this.broadcast("resume");this.handlers=new Map;this.sid=l(()=>sn.randomChars(12));this.start=Xl(async()=>{if(!this.ended)return Yr.debug("start("+this.port+")"),this.server=DC.createServer(this.onConnect.bind(this)),this.server.on("listening",()=>{Yr.info("listening on "+this.port),this._ready.resolve()}),this.server.on("error",async e=>{Yr.warn("error, rejecting ready"),this._ready.reject(),await this.onError("createServer"+de,e)}),this.server.listen(this.port,u.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise},5e3);this.end=l(async()=>{this._ended=!0,ve.removeListener("pause",this.onPause),ve.removeListener("resume",this.onResume),await this.closeAllConnections(),await Gx(this.server)});this.name="Server:"+e,this.addHandler("ping",FC),this.addSimpleHandler("broadcast",i=>(ve.emit(i.event,i.args),this.broadcast(i.event,i.args))),rc(this.onPause),ca(this.onResume),Sd(this),LD(this)}get connectionCount(){return this.connections.length}async serialize(e){return O(y({sid:this.sid()},e))+`
`}addHandler(e,r){let i=this.handlers.get(e);i!=null&&Yr.warn("addHandler(): overwriting",{method:e,prior:i,newHandler:r}),this.handlers.set(e,r)}addSimpleHandler(e,r){this.addHandler(e,({params:i})=>r(i))}addSimpleHandlers(e){tt(e).forEach(([r,i])=>this.addSimpleHandler(r,i))}get ended(){return this._ended||$()}get ready(){return this._ready.promise}closeAllConnections(){let e=this.connections.map(r=>Ki(r.socket));return this.connections.length=0,Promise.all(e)}broadcast(e,r){return this.sendAll({event:e,args:r})}async sendAll(e,r="write"){let i=await this.serialize(e),o=[...this.connections],n=o.length;Yr.debug("sendAll()",{pojo:e,method:r});for(let s of o)try{s.socket.writableEnded?n--:s.socket[r](i,()=>n--)}catch{n--}return Je(()=>n<=0,{timeoutMs:S})}onConnect(e){Yr.info("Connection from "+xa(e)),this.unref&&e.unref();let r=new CD(e);this.connections.push(r),e.on("end",()=>{Yr.info("Closing connection from "+xa(e)),et(this.connections,i=>i.socket!==e)}),e.on("error",async i=>{Yr.warn("on error from "+xa(e)+": "+i),await this.onError("socket",i),e.end()});try{un(e,`
`,i=>this.onRequest(i,r))}catch(i){Yr.warn("Caught error from "+xa(e)+": "+i),e.end()}}async onRequest(e,r){if(Yr.debug("onRequest()",e),v(e))return;let i="missing",o="missing";try{let n=JSON.parse(e);return q(n.id,s=>i=s),q(n.method,s=>o=s),await Qe("rpc."+o,()=>this.handle(i,o,n.params,r))}catch(n){Yr.warn("invalid request",{line:e,error:n}),r.socket.write(await this.serialize({id:i,error:T(n.message,()=>h(n))}))}}async handle(e,r,i,o){let n=this.handlers.get(r);if(n==null)throw Yr.warn("bad handler request",{method:r,params:i,supported:yt(this.handlers)}),new Error("No handler for "+r);let{elapsedMs:s,result:a}=await mi(()=>n({id:e,method:r,params:i,conn:o}));Yr.log(Oa(s,S),"handle()",{method:r,conn:h(o),elapsedMs:s,id:e,params:i,result:a}),o.socket.write(await this.serialize({id:e,result:a}))}async onError(e,r){this.ended||re(e,r)}};var VD=P(require("fs-extra")),cp=P(require("os")),xy=P(require("process"));var LC=l(async()=>{if(u.forceOpen.valueOrDefault){let t=zt();t!=null&&await Ea(async()=>Promise.all(F(await zD(t)).map(e=>e.unlink())),7*S)}}),UD=Ft;function IC(t){return f(t,e=>e.join("opened-by"))}function zD(t){return IC(t)?.clear().children(r=>r.ext===".json")}async function WD(){return ee(zt(),async t=>md(fp(t),Ty(),"hostname","pid"),async()=>!1)}var Ty=l(async()=>({hostname:(0,cp.hostname)(),pid:xy.pid})),fp=Li(t=>OC(t),{maxSize:3,timeoutMs:J,clearEveryMs:Ut(7*S,J)});async function OC(t){await LC();let e=!dm(),r=d("currentLibraryLockOwner("+t+")"),i=(0,cp.hostname)(),o=await zD(t);if(L(o)){r.warn("no opened-by files found.");return}let n=await is(o.map(async K=>{let Ze=await K.readJson();if(e&&Ze==null&&await K.modifiedCloseTo(Date.now(),J)!==!0){r.warn("unlinking old empty json file: "+K),await K.unlink("debug");return}else return y({file:K},Ze)}));r.debug("read",{jsons:n});let s=Date.now()-UD,[a,m]=wo(n,K=>K.updatedAt>s);e&&k(m)&&(r.debug("Unlinking expired opened-by files:",{minUpdatedAt:s,staleJsons:m}),await Promise.all(m.map(K=>K.file?.unlink("debug"))));let[c,p]=wo(a,K=>K.hostname===i),g=c.map(K=>K.pid),w=T(await mv(g),g),[E,R]=wo(c,K=>w.includes(K.pid));e&&k(R)&&(r.debug("Unlinking zombie opened-by files:",R),await Promise.all(R.map(K=>K.file?.unlink())));let oe=[...E,...p];if(L(oe)){r.debug("No valid opened-by files.");return}let z=xo(oe,K=>K.createdAt),we=oe.filter(K=>K.systemUID===z.systemUID),Q=xo(we,K=>[cM(K.serviceName),T(K.createdAt,()=>Date.now())]);return r.tap({msg:"currentLibraryLockOwner",level:"info",result:Q})}H(()=>fp.clear());var vy=class extends $e{constructor(e){super("OpenedByIO()",()=>this.onEnd(),me.postdb);this.ldd=e;this.createdAt=Date.now();this.watchers=[];this.intervalMs=UD/4;this.file=l(()=>this.dir.join(an((0,cp.hostname)(),7)+"-"+xy.pid+".json"));this.json=l(async()=>y({serviceName:Xt(),createdAt:this.createdAt,updatedAt:Date.now()},await Ty()),this.intervalMs/2);this.write_=l(async()=>{let e=await this.json();await this.file().writeJSON_(e),fp.clear()},this.intervalMs/2);this.setup=l(async()=>{if(await this.write_(),Lr())for(let e of this.file().selfAndParents(4))try{let r=(0,VD.watch)(e.nativePath,{persistent:!1,recursive:!1},()=>this.lockOwner.refresh()).on("error",i=>(this.logger.warn("watch().on(error):",i),this.lockOwner.refresh()));this.watchers.push(r)}catch(r){this.logger.warn("Failed to set up watch",{f:e.nativePath,err:r})}});this.lockOwner=l(async()=>{if(!$())return await this.setup(),fp(this.ldd)},7*S);this.dir=e.join("opened-by"),this.timer=Vr(()=>this.write_(),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write_.unset()}refresh_(){return this.clear(),this.write_()}async onEnd(){this.watchers.forEach(e=>e.close()),this.watchers.length=0,f(this.timer,clearInterval),this.timer=void 0,await this.file().unlink()}async deleteAllLocks(e=!1){e?await this.dir.rmrf():await this.dir.visitDescendants(r=>r.eql(this.file())?void 0:r.unlink())}async isLockOwner(){return md(this.lockOwner(),Ty(),"hostname","pid")}async throwIfUnavailable(e){this.logger.debug("throwIfAvailable()",{from:e});let r=await this.lockOwner();if(this.logger.debug("throwIfAvailable()",{from:e,lockOwner:r}),r==null)return;let i=await this.json();if(this.logger.debug("throwIfAvailable()",{from:e,json:i}),r!=null&&r.hostname!==i.hostname)throw this.logger.warn("library is unavailable",{lockOwner:r,json:i}),new Error(`Library is already opened by ${r.hostname} (${r.serviceName}:${r.pid}) ${e}`+(Xc()?"":de)+yr+kt)}};var pp,al=l(()=>d("Vacuum"));function jm(t){return t==null||t.schema==="models"?I(pp):!1}var qD=async t=>{typeof t!="boolean"&&al().throw("invalid setVacuuming argument",{value:t}),al().debug("setVacuuming()",{value:t}),pp=t};Fx(qD);async function jD(){return b(kn()?.request("isVacuuming"),t=>(al().info("checkRemoteVacuuming() received RPC value",{value:t}),f(t,qD)))}async function My(t){if(!await WD()){al().info("withVacuumEvent(): no-op, I'm not the lock owner.");return}al().info("db vacuum starting...");try{return pp=!0,qm("vacuuming",!0),await t()}finally{pp=!1,qm("vacuuming",!1),al().info("db vacuum finished.")}}var kC=l(()=>d("RpcServiceHandlers")),HD=l(()=>({libraryPath:()=>u.libraryPath.value,healthChecks:()=>Os(),isVacuuming:()=>kC().tap({msg:"isVacuuming",result:jm()}),mountpoints:()=>vt(),volumes:()=>Or(),paused:()=>Ii()}));var GD=l(()=>d("RpcServer")),KD=l(async()=>{if(!await bn())return;GD().info("Setting up RPC...");let t=u.rpcPort.valueOrDefault,e=!0,r=new wy(t,e);return r.addSimpleHandlers(HD()),await r.start(),GD().info("RPC service serving port "+r.port),r});var JD={broadcast:(t,e)=>be(KD(),r=>r.broadcast(t,e),()=>b(kn(),r=>r.broadcast(t,e)))};var sF=P(require("util"));var $D=P(require("knex"));var so=(0,$D.default)({client:"sqlite3",useNullAsDefault:!0});async function dp(t,e){let r=Date.now(),i=0,o=r+u.maxBusyDbMs.valueOrDefault;for(;Date.now()<o;)try{return await t()}catch(n){if(!Bl(n)||Date.now()>=o)throw n;e?.(),await or(Ut(500,1500)*++i)}throw new Error("handleDbRetries(): timeout after "+u.maxBusyDbMs.valueOrDefault+"ms")}function hp(t,e=25){let r;for(let i=0;i<e;i++)try{return t()}catch(o){if(r=o,!Bl(o))throw o}throw r}var Hm=l(()=>d("Transactions")),RC=A,QD=10,gp=!1;async function Nr(t,e,r=!1,i=!1){if(t.db==null)throw new Error("tx(): null db");try{return r&&(gp=!0),!i&&jm(t)&&await Je(()=>!jm(t),{timeoutMs:RC})==null&&Hm().throw("Timeout while waiting for external vacuum to complete"),await li(async()=>t.inTransaction?e(t.db):dp(()=>t.db.transaction(()=>e(t.db)).deferred(),t.onRetry),{maxRetries:QD,errorIsRetriable:async o=>r||gp?!1:(Hm().warn("errorIsRetriable()",o),Bl(o)||kx(o)?(t.closeDb(),Hm().warn("Trying to reopen the db "+t.dbfile),!0):!1),timeoutMs:u.maxBusyDbMs.valueOrDefault/10,onRetryWaitUntil:o=>{let n=Ut(10,u.maxBusyDbMs.valueOrDefault/(QD-o));return Hm().warn("onRetryWaitUntil()",{retryCount:o,delayMs:n}),or(n)}})}catch(o){if(r||gp)return;throw Hm().warn("tx(): raised",o),o}finally{r&&(gp=!1)}}var _C=".sqlite3";function ks(t,e){return t.join(e,"db"+_C)}var YD,ll=()=>YD;function XD(t){YD=t}function ZD(){return f(zt(),t=>ks(t,"models"))}var Sy=new Map;function Py(t){Sy.set(t.$ctor,t)}var NC=([t,e])=>t!=null&&e!=null;function eF(t,e){if(e==null)throw new Error("json is null");if(t!=null&&M(t.$ctor)&&!Sy.has(t.$ctor)&&Py(t),e instanceof t)return e;let r=W(e.$ctor).flatMap(o=>Sy.get(o)).getOrElse(()=>t);if(e instanceof r)return e;let i=new r;return e==null?i:Uo(i,e,V([t.tableName+".",r.tableName+"."]))}function Uo(t,e,r=[]){let i=t.class();return yt(e).filter(n=>n!=="$ctor").filter(n=>e[n]!=null).map(n=>{let s=e[n];return r.forEach(a=>n=st(n,a)),yo(i.booleanFields,n)?[n,I(s)]:[n,s]}).filter(NC).forEach(([n,s])=>t[n]=s),t}function tF(t){return t===null||yo(["number","string"],typeof t)}function Ey(t){return t!=null&&Array.isArray(t)?t.every(Ey):tt(t).every(([,e])=>tF(e))}function rF(t){return Jo(t,(e,r)=>{if(!e.startsWith("$")){if(typeof r=="boolean")return[e,r?1:0];if(tF(r))return[e,r];if(IA(r))return[e,gi(r)]}})}function BC(t){return t!=null&&ct(t.sql)&&(t.bindings==null||Ey(t.bindings))}function yp(t){if(t==null)throw new Error("null sql");if(BC(t))return t;if(ct(t))return{sql:t};if(Ee(t.toSQL))return qt(t.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+O(t))}function iF(t){return t.replace(/\s*--.*?\n/g,"").split(";").map(e=>e.replace(/\s+/g," ").trim()).filter(M)}var oF=Pe?25:1e3,nF=l(()=>d("DbRequest")),Gm=class{constructor(e,r){this.db=e;this.tableName=r;this.cachedStatements=new ke(256)}qb(){return so(this.tableName)}prep(e,r,i=!1){let o=yp(r);try{let n=this.cachedStatements.getOrSet((i===!0?"pluck:":"")+o.sql,()=>{let s=e.prepare(o.sql);return i===!0?s.pluck():s});return n.database.open?{sq:o,stmt:n}:(this.cachedStatements.clear(),this.prep(e,r,i))}catch(n){return nF().throw("prep() failed",{error:n,sqlQuery:o,retriable:!1})}}async wrap({q:e,pluck:r,m:i}){try{return await Nr(this.db(),o=>{let{sq:n,stmt:s}=this.prep(o,e,r),a=s[i].bind(s);return n.bindings==null?a():a(n.bindings)})}catch(o){if(String(o.message).includes("AdvisoryLock"))throw o;nF().throw(o,y({method:i},yp(e)))}}run(e){return this.wrap({q:e,m:"run"})}async runScript(e,r=""){let i=vT("runScript()");for(let o of e){if(v(o)||o.trim().startsWith("--"))continue;await this.run({sql:o});let n=Ll(ir(o,60),r,"");i.elapsed(n)}}mapRun(e){return Nr(this.db(),r=>e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return ee(o.bindings,s=>n.run(s),()=>n.run())}))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}updateOrIgnore(e){let r=yp(e(this.qb()));return r.sql=r.sql.replace(/update /i,"UPDATE OR IGNORE "),this.wrap({q:r,m:"run"})}first(e){return this.wrap({q:e,m:"get"})}firstf(e){return this.wrap({q:e(this.qb()),m:"get"})}mapAll(e){return Nr(this.db(),r=>Y(e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return ee(o.bindings,s=>n.all(s),()=>n.all())})))}all(e){return this.wrap({q:e,m:"all"})}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}async batched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(oF),m:"all"}),k(r)&&await e.onResults(r);while(k(r)&&!$())}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}async pluckBatched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(oF),pluck:!0,m:"all"}),k(r)&&await e.onResults(r);while(k(r))}};var Ay=class{constructor(e,r){this.model=e;this.db=r;this.columnNames=l(()=>hp(()=>this.db().pragma(`table_info(${this.tableName})`).map(e=>e.name)));this.logger=d(`ModelOps(${e.tableName})`),Py(e),this.dbl=new Gm(this.db,e.tableName)}get dbOpen(){return ee(this.db(),e=>e.open,()=>!1)}get tableName(){return this.model.tableName}query(){return this.model.query()}async toDbValued(e){let r=this.model.fromJSON(e),i=rF(r);return rt(i,...await this.columnNames())}run(e){return this.dbl.run(e)}fromJSON(e){return b(e,r=>this.model.fromJSON(r))}async fromJSONs(e){return(await is(e)).map(o=>this.model.fromJSON(o))}first(e){return this.fromJSON(this.dbl.first(e))}firstf(e){return this.first(e(this.query()))}all(e=this.query()){return this.fromJSONs(this.dbl.all(e))}allf(e){return this.all(e(this.query()))}findOne(e){return this.fromJSON(this.dbl.first(e))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e,r){return this.findOneBy(y(y({},r),{id:e}))}async findByIds(e){let r=await Nr(this.db(),async()=>ye(aa(F(e).filter(C),u.dbBatchSelectSize.valueOrDefault),i=>this.dbl.all(this.query().whereIn("id",i))));return X(await this.fromJSONs(Y(r)),i=>e.indexOf(i.id))}findBy(e){return this.all(this.model.queryBy(e))}findWhereIn(e,r){return this.all(this.model.query().whereIn(e,r))}rows(e){return this.count(T(e,()=>this.model.query()))}count(e){return ze(this.dbl.pluckFirst(e.count()),()=>0)}countf(e){return this.count(e(this.query()))}async insert(e){return Nr(this.model.db(),()=>ye(e,r=>this.insertOne(r)))}async upsertOne(e){return this.modelSupportsUpsert?(await this.upsert([e]))[0]:e.id==null?this.insertOne(e):this.updateOne(e)}async insertOne(e){if(e.id!=null)throw new Error("insert called for "+O(e)+kt);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames()),o=await this.dbl.runf(s=>s.insert(i)),n=await Xn(G(o.lastInsertRowid),s=>this.findById(s),()=>{this.logger.throw("internal error: lastInsertedRowId was non-numeric",{runInfo:o})});return e instanceof this.model&&Uo(e,n),n}async updateOne(e){if(e.id==null)throw new Error("update called for "+O(e)+kt);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames());return await this.dbl.runf(o=>o.where({id:e.id}).update(i)),r}get ucn(){return this.model.uniqueColumnName}get ucnFieldNames(){return T(this.ucn,"id").split(",")}get modelSupportsUpsert(){return this.ucn!=null&&this.ucn!=="id"}get ucnConstraint(){return`(${this.ucn})`}onConflictClause(e){let r=[...this.ucn.split(","),"id","createdAt"],i=e.filter(n=>!r.includes(n)).sort().map(n=>`${n}=excluded.${n}`).join(","),o=["ON CONFLICT",this.ucnConstraint];return v(i)?o.push("DO NOTHING"):o.push("DO UPDATE SET",i),o.join(" ")}async upsertDbJson(e){let r=this.query().insert(e).toSQL(),i=new Set;for(let n of e)for(let s of yt(n))i.add(s);let o={sql:`${r.sql} ${this.onConflictClause([...i.values()])}`,bindings:r.bindings};await this.run(o)}pickModelUcn(e){return rt(e,...this.ucnFieldNames)}async reload(e){return await ye(e,async r=>b(this.findOneBy(this.pickModelUcn(r)),i=>Uo(r,i))),e}async upsert(e,r=!1){if(this.modelSupportsUpsert){let i=await this.columnNames(),o=await Nr(this.db(),async()=>Nx(F(e),u.dbBatchUpsertSize.valueOrDefault,async n=>{let s=n.map(a=>this.model.fromJSON(a));return s.forEach(a=>a.$beforeUpsert()),await this.upsertDbJson(s.map(a=>a.$toDbJSON(i))),s}));return r?o:this.reload(o)}else return Nr(this.db(),()=>ye(e,i=>this.upsertOne(i)))}async delete(e){return ge(e.filter(C),r=>this.run(this.model.query().delete().whereIn("id",r)))}async batched(e){let r=u.dbBatchSelectSize.valueOrDefault,i,o;do i=await this.allf(n=>(n=e.qb(n),o!=null&&(n=n.andWhere("id",">",o)),n.orderBy("id","asc").limit(r))),k(i)&&(o=Math.max(...i.map(n=>n.id)),await e.onResults(i));while(k(i))}};var Wo=class{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return this._logger==null&&(this._logger=d(this.tableName)),this._logger}static query(){return so(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static ops(){return this._ops==null&&(this._ops=new Ay(this,this.db)),this._ops}static get dbl(){return this.ops().dbl}static async txOp(e){return Nr(this.db(),()=>e(this.ops()))}static async tx(e,r=!1){return Nr(this.db(),()=>e(this.dbl),r)}static rows(){return this.ops().rows()}static truncate(){if(pr)throw new Error("rejecting attempt to truncate in prod");return this.dbl.run("DELETE FROM "+this.tableName)}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return h(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${T(this.id,this[this.class().uniqueColumnName])})`}logger(){return d(h(this.valueOf()))}[sF.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return eF(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}$toShallowJSON(){return this.$_toJSON(I)}$toDbJSON(e){let r=this.$_toJSON(dw,!1);return M(e)?rt(r,...e):r}toJSON(){return this.$_toJSON(I)}$_toJSON(e,r=!0){let i=this.class();return Jo(this,(o,n)=>{if(!(n==null||!ei(n)))return yo(i.booleanFields,o)?[o,e(n)]:[o,n]},r?{$ctor:i.$ctor}:{})}upsert(e){return e!=null&&Uo(this,e),this.class().ops().upsertOne(this)}$beforeUpsert(){}async reload(){return b(this.class().ops().findById(this.id),e=>Uo(this,e))}delete(){return f(this.id,e=>this.class().ops().delete([e]))}};Wo.schema="models",Wo.db=ll;var MFe=`
SELECT
  al1.name,
  al1.lockId
FROM
  AdvisoryLock AS al1
  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name
  AND al1.createdAt > al2.createdAt
WHERE
  al2.createdAt IS NULL
`.replace(/\s+/," "),Dy=class extends Wo{static vacuum(e=30*A){return this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async currentAcquiredLocks(){return this.dbl.pluckAllf(e=>e.select("name").where({acquired:1}))}static async allLocks(){return this.dbl.pluckAllf(e=>e.select("name"))}static async withLocks({lockNames:e,f:r,timeoutMs:i}){let o=Date.now(),n={},s=up();this.logger().debug("withLocks()",{lockNames:e,lockId:s});let a=n.locks=e.map(c=>({name:c,lockId:s,acquired:0,createdAt:Date.now()}));await this.tx(c=>c.runf(p=>p.insert(a)));let m=l(()=>this.logger().warn("long wait time for",e));try{let c=await Je(async()=>{let p=!0,g=await this.tx(w=>w.runf(E=>E.where({lockId:s}).update({acquired:1})),p);return g==null&&!nf(o,5*S)&&m(),g!=null},{timeoutMs:i,timeBetweenMs:Ut(5,500)});if(this.logger().info("withLocks()",{lockNames:e,acquired:c}),c){n.acquireMs=Date.now()-o;let p=await mi(async()=>r(s));n.result=p.result,n.runMs=p.elapsedMs}}finally{let c=await mi(()=>Dy.tx(p=>p.runf(g=>g.where({lockId:s}).delete())));n.releaseMs=c.elapsedMs,n.released=!0}return n}},ml=Dy;ml.tableName="AdvisoryLock",ml.uniqueColumnName="name,lockId";var Rs=(t,e)=>ml.withLocks({lockNames:t,f:e,timeoutMs:A}).then(r=>r.result),aF={withAdvisoryLocks:Rs};var Km=P(require("luxon"));function lF(t,e,r=Km.DateTime.DATETIME_MED){return Fn(t,i=>(q(e,o=>i=i.setLocale(o)),i.toLocaleString(r)))}var CC=/(\.\d\d\d)\d+/;function mF(t){if(!v(t))return W(Km.DateTime.fromISO(t.replace(CC,(e,r)=>r),{setZone:!0})).filter(e=>e.isValid).orElse(()=>f(_r.fromISO(t),e=>e.middle.toDateTime())).get()}var VC=new Map;function uF(t,e="en-US"){return Sr(VC,e,()=>new Intl.DateTimeFormat(e,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(gi(t))}function cF(t){return f(mF(t),Gh)}var zC=/^\d{1,4}-\d{2}-\d{2}$/;function fF(t){return q(t,e=>Pi(()=>f(_r.fromISO(e),r=>r.intervalMs),()=>W(e.match(zC)).flatMap(()=>Km.DateTime.fromISO(e)).filter(xr).map(()=>ot).get(),()=>W(Km.DateTime.fromISO(e)).filter(xr).map(()=>0).get()))}function pF(t){if(t==null)return;if(ct(t))return mF(t)?.toJSDate();let e=t?.timestamp,r=t?.formatted,i=Vi(e,o=>new Date(o*S));if(M(r)){let o=new Date(r);if(!Uh(i,o,S))return}return i}function dF(t,e){return t.map((r,i)=>r*e[i])}function hF(t,e){return t.map((r,i)=>{if(r.length!==e.length)throw new Error("misshaped matrix on row "+i);return Zo(r.map((o,n)=>o*e[n]))})}var UC=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]];function WC(t){return f(h(t).match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),e=>[e[1],e[2],e[3]].map(r=>parseInt(r,16)))}function gF(t){return f(WC(t),Jm)}function Jm(t){return jC(qC(t))}function HC(t){return[t[0],t[1],t[2]].map(e=>te(0,255,e))}function qC(t){let e=HC(t).map(r=>r/255).map(r=>r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92);return hF(UC,e)}var Fy={X:.95047,Y:1,Z:1.08883},GC=216/24389,KC=24389/27;function jC(t){let[e,r,i]=dF(t,[1/Fy.X,1/Fy.Y,1/Fy.Z]).map(o=>o>GC?Math.pow(o,1/3):(KC*o+16)/116);return[116*r-16,500*(e-r),200*(r-i)]}function Rn(t,e){return zm({dims:[{value:t[0],min:0,max:100},{value:t[1],min:-80,max:80},{value:t[2],min:-80,max:80}],bitDepth:e})}function bp(t,e){return ip(t,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:e})}function wp(t,e){return JC({L:t[0],a:t[1],b:t[2]},{L:e[0],a:e[1],b:e[2]})}function JC(t,e){let r=1,i=.045,o=.015,n=t.L-e.L,s=t.a-e.a,a=t.b-e.b,m=Math.sqrt(t.a*t.a+t.b*t.b),c=Math.sqrt(e.a*e.a+e.b*e.b),p=m-c,g=s*s+a*a-p*p;return g=g<0?0:Math.sqrt(g),Math.sqrt((n/r)**2+(p/(1+i*m))**2+(g/(1+o*m))**2)}function yF(t,e){return xo(t,r=>wp(r,e))}var xp=require("sharp"),_s=12,_n=7;var $C=d("ImageHash"),QC=250,ul=new ke(QC);H(()=>ul.clear());nr(t=>M(t)?ul.delete(t):ul.clear());fa((t,e)=>f(ul.get(t),r=>ul.getOrSet(e,()=>r)));var Ns=8,bF={width:96,height:96};function YC(t){return Xd(BigInt("0b0"+t.map(e=>e===1?1:0).join("")))}function XC(t){let e=[[],[],[]];for(let r=0;r<t.length;r+=3){let i=Jm([t[r],t[r+1],t[r+2]]);e[0].push(i[0]),e[1].push(i[1]),e[2].push(i[2])}return e}function ZC(t){let e=u.greyscaleColorThreshold.valueOrDefault;for(let r of t)if(Math.abs(r[1])>e||Math.abs(r[2])>e)return!1;return!0}function wF(t){return 1<2?It(t):It([It(t),Td(t)])}async function e2(t){let e=d("ImageHash("+t+")");try{let i=await Is(t,bF,!0);if(i==null){e.warn("Cannot build readable stream");return}if(await ki(t)==null){e.warn("Can't extract dimensions");return}let n=xp(i.nativePath).removeAlpha();i.isDescendantOf(await _m())&&xi(await i.size(),2*Ke)&&(n=n.trim(4)),n=n.resize(y(y({},bF),{fit:xp.fit.fill,kernel:xp.kernel.lanczos3,fastShrinkOnLoad:!0,withoutEnlargement:!0}));let{data:s,info:a}=await n.raw().toBuffer({resolveWithObject:!0}),m=jn(0,s.length,3,Q=>Jm([s[Q],s[Q+1],s[Q+2]])),c=ZC(m),p=xd(m.map(Q=>Rn(Q,_s)),_n);if(!c&&u.includeSharpDominantColor.valueOrDefault){let Q=await Qe(`img.imageHash.stats ${t.ext.toUpperCase()}`,()=>n.stats()),K=Rn(Jm([Q.dominant.r,Q.dominant.g,Q.dominant.b]),_s);p=V([K,...p]).slice(0,_n)}let g=xp(s,{raw:y(y({},a),{channels:3})}).resize({width:Ns,height:Ns}),{data:w}=await g.raw().toBuffer({resolveWithObject:!0}),E=XC(w),R=c?[wF(E[0]),0,0]:xe(3,Q=>wF(E[Q])),z=(c?[E[0]]:E).map((Q,K)=>{let Ze=R[K];return Q.map(_t=>_t>=Ze?1:0)});if(c){let Q=xe(Ns*Ns,()=>0);z.push(Q,Q)}return{meanHash:YC(Y(z)),isGreyscale:c,modes:p}}catch(r){e.warn("Failed to imageHash("+t.nativePath+")",r);return}}async function $m(t){return ul.getOrSet(t.nativePath,()=>mi(()=>Qe(`img.imageHash${t.ext.toUpperCase()}`,()=>e2(t))).then(({elapsedMs:e,result:r})=>$C.tap({level:Oa(e,4*S),msg:"imageHash()",result:r,meta:{file:t.nativePath,elapsedMs:e}})))}var xF=128,TF=8;var ce=Object.freeze({When:"When",Who:"Who",Where:"Where",What:"What",Camera:"Camera",Lens:"Lens",Albums:"Albums",Keywords:"Keywords",Type:"Type",FS:"fs"}),E0e=[ce.When,ce.Camera,ce.Lens,ce.Type,ce.FS];var vF=l(()=>d("Names"));function Ly(t){return ev(ht(t))}function t2(){return u.tagNamesSurnames.values.map(t=>new RegExp("\\b("+Ly(t)+")\\b","i"))}function r2(){return u.tagNamesGiven.values.map(t=>new RegExp("\\b("+Ly(t)+")\\b","i"))}function i2(){return ge(_(u.tagNamesSurnamePrefixes.values),t=>X(t,e=>-e.length).map(e=>new RegExp(`\\b(${Ly(e)}\\s+\\S+)`,"i")))}function o2(){let t=_(u.tagNamesGivenSurrounds.values);for(let e of t)e.length!==2&&vF().warn("Settings.tagNamesFamilySurrounds has an invalid value:",e);return t.map(e=>new RegExp(`(${ht(e.charAt(0))}\\s*[^${ht(e.charAt(0))}]+\\s*${ht(e.charAt(1))})`,"i"))}function n2(){let t=_(u.tagNamesFamilySurrounds.values);for(let e of t)e.length!==2&&vF().warn("Settings.tagNamesFamilySurrounds has an invalid value:",e);return t.map(e=>new RegExp(`${ht(e.charAt(0))}\\s*([^${ht(e.charAt(0))}]*)\\s*${ht(e.charAt(1))}`,"i"))}var s2=/(\(\s*\d+\s*-\s*(?:[\d\?]{1,4})?\s*\)?)/,a2=/(,?\s*(?:jr\.?|junior|sr.?|senior|i+\.?))$/i,l2=/\b([A-Zââ']+(?:[-A-Zââ']{2}))\b/;function m2(t){if(v(t))return;let e=t.trim(),r=f(Si(e,s2),w=>(e=w.unmatched.trim(),w.captured.replace(/\s+/g,""))),i=f(Si(e,a2),w=>(e=w.unmatched.trim(),w.captured.trim())),o=[],n=[],s=[];for(let w of r2()){let E=Si(e,w);E!=null&&(o.push(E.captured),e=E.unmatched.trim())}for(let w of o2()){let E;do E=Si(e,w),E!=null&&(n.push(E.captured),e=E.unmatched.trim());while(E!=null)}let a;function m(w){(a==null||a>w.matchedIndex)&&(a=w.matchedIndex)}if(u.tagNamesCapitalizedAsFamily.valueOrDefault){let w;do w=Si(e,l2),w!=null&&(m(w),s.push(w.captured),e=w.unmatched.trim());while(w!=null)}for(let w of n2()){let E;do E=Si(e,w),E!=null&&(m(E),s.push(E.captured),e=E.unmatched.trim());while(E!=null)}if(u.tagNamesLexical.valueOrDefault){let w=e.indexOf(",");w>=0&&(a=void 0,s.push(e.substring(0,w).trim()),o.push(e.substring(w+1).trim()),e="")}for(let w of t2()){let E=Si(e,w);E!=null&&(m(E),s.push(E.captured),e=E.unmatched.trim())}for(let w of F(i2())){let E=Si(e,w);E!=null&&(m(E),s.push(E.captured),e=E.unmatched.trim())}a!=null&&e.length>a&&ge(_(e.substr(a).split(/\s+/)),w=>{s.push(...w),e=e.substr(0,a)});let c=_(e.split(/\s+/)),p=o.length,g=s.length;if(c.length>0)if(p===0&&g>0)o.push(...c);else if(g===0&&p>0&&c.length===1)s.push(...c);else if(c.length===1)o.push(...c);else{let w=u.tagNamesOrder.valueOrDefault==="western";s.push(w?c.pop():c.shift()),o.push(...c)}return{givenNames:V(_([...o,...n])),modifier:i,lifespan:r,familyNames:V(_(s))}}function MF(t){return _(t).join(" ")}function Iy(t){if(v(t))return[];if(u.tagNamesFormatter.valueOrDefault==="family/given"){let e=m2(t);if(e==null)return[];{let r=MF([MF(e.givenNames)+Ti(e.modifier,o=>o.startsWith(",")?o:" "+o.trim(),""),e.lifespan]);return _(aw(e.familyNames,[u.tagNamesDefaultFamily.valueOrDefault])).map(o=>[ce.Who,o,r])}}else return[[ce.Who,t.trim()]]}var u2=d("WhoTagger");async function SF(t){if(await hi())return;let e=[];if(u.tagJsonFaces.valueOrDefault){let i=Y(await sr(t,o=>o.jsonSidecars()));await sr(i,async o=>{let n=await op(o);f(n?.peopleNames,s=>e.push(...s))})}u.tagFaceRegions.valueOrDefault&&await sr(t,async i=>{let o=await _e(i,!0);for(let n of F(o?.RegionInfo?.RegionList))n.Type==="Face"&&e.push(n.Name)}),k(u.tagWhoNames.values)&&await sr(t,async i=>{let o=await _e(i,!0);for(let n of u.tagWhoNames.values)e.push(...F(To(o,n)))});let r=V(Y(V(e).map(Oy)));return u2.tap({msg:"whoTagFiles()",level:"info",result:r,meta:{names:e,files:t.map(i=>i.nativePath)}})}function PF(t){return vp(Tp(t[0]))}function vp(t){return!v(t)&&Ht([ce.Who,...u.tagWhoSynonyms.values],t)}function Oy(t){if(!v(t))return Array.isArray(t)?(vp(t[0])&&t.shift(),t.length===0?void 0:t.length===1?Iy(t[0]):[[ce.Who,...t]]):Iy(t)}var ao=String.fromCharCode(31),Mp="Library",EF=[{name:ce.When,ordinal:1},{name:ce.Albums,ordinal:2},{name:ce.FS,ordinal:3},{name:ce.Who,ordinal:4},{name:ce.Camera,ordinal:5},{name:ce.Lens,ordinal:6},{name:ce.Keywords,ordinal:7},{name:ce.Type,ordinal:8}];function Tp(t){return f(t,e=>T(e.name,h(e)))}function AF(t){return t.map(Tp)}function Tr(t,e=ao){return AF(t).join(e)+(e===ao?e:"")}function DF(t){return Ou(Nn(t))}function Nn(t,e=ao){return h(t).split(e).filter(M)}function FF(t){return Tr(Nn(t))}function Sp(t){return AF(t).join(ao).toLowerCase()}function LF(t,e){let r=new Set(D(e).map(i=>Sp(i)));return D(t).filter(i=>!r.has(Sp(i)))}function c2(t,e){let r=Sp(t);return e.some(i=>r===Sp(i))}async function IF(t,e){let r=LF(e,t),i=LF(t,e),o=u.excludedRootTags.valueOrDefault;return et(r,n=>{let s=o.includes(Tp(n[0]).toLowerCase());return s&&!c2(n,i)&&(i.push(n),console.log("removing bad tag",n)),!s}),await hi()&&et(i,n=>!PF(n)),{add:r,remove:i}}var lo=l(()=>d("Migrations")),f2=new RegExp(`^(${ht(pi)}://.*?/)(.*)$`),p2=t=>W(t).filter(ct).flatMap(e=>f2.exec(e)).map(e=>e[1].toLowerCase()+e[2]).getOrElse(()=>t);function d2(t,e=_s){return eD(t,e).map(r=>bp(r,e))}function h2(t,e){return pe(t,()=>f(d2(t,6)[e],r=>Rn(r,_s)))}function g2(t){return t.endsWith(ao)?t:t+ao}function OF(t,e){L(e)&&lo().warn("mergeTags(): empty tagIds",{tagIds:e});function r(g){return t.prepare(g).run()}let i=new Map(t.prepare("SELECT id, _path FROM Tag WHERE id IN ("+e.join(",")+")").all().map(({id:g,_path:w})=>[g,w])),o=X(e.map(g=>{let w=i.get(g);return{id:g,path:w,base:DF(w)}}),g=>[g.base,g.path]);o.reverse(),lo().info("mergeTags()",{arr:o});let n=o[0],s=n.id;if(L(o)||!C(s)){lo().warn("mergeTags(): empty array, or missing winner",{arr:o,winner:n,winnerId:s});return}let a=o.slice(1);if(k(a)){let g=a.map(w=>w.id).join(",");r(`UPDATE OR IGNORE AssetTag SET tagId = ${s} WHERE tagId in (${g})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${g})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${g})`),r(`DELETE FROM AssetTag WHERE tagId in (${g})`),r(`DELETE FROM Tag WHERE id in (${g})`)}let m=t.prepare("select _path from Tag where id = :id").get({id:s})._path,c=Nn(m),p=t.prepare("SELECT id, _path FROM Tag WHERE id = :winnerId OR _path LIKE :like COLLATE NOCASE").all({winnerId:s,like:Wt(m,ao)+"%",winnerPath:m});for(let g of p){let w=Tr([...c,...Nn(Gu(g._path,m))]);g._path!==w&&(lo().info("mergeTags(): repairing tag path",{ea:g,newPath:w}),t.prepare("UPDATE OR IGNORE Tag SET _path = :path, updatedAt = :updatedAt WHERE id = :id").run({id:g.id,updatedAt:Date.now(),path:w}))}return lo().tap({msg:"mergeTags()",level:"info",result:{winner:n,losers:a},meta:{tagIds:e,winnerPath:m}})}function kF(t){let e=t.prepare(["SELECT","rtrim(_path, char(31)) as path,","count(*) AS cnt,","group_concat(id) AS ids","FROM Tag","GROUP BY path","COLLATE NOCASE","HAVING cnt > 1"].join(" ")).all();for(let r of e)r.ids=D(h(r.ids).split(",").map(i=>G(i)));return qn(e,r=>r.path).reverse(),lo().tap({msg:"dedupeTags()",result:e.map(r=>OF(t,r.ids)),meta:{rows:e}})}var ky={lowercase_psnet_hostname:t=>{t.function("lowercase_psnet_hostname",{deterministic:!0},p2),t.transaction(()=>{t.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),t.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),t.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")})()},force_stable_channel:async()=>{try{await ja();let t=u.updateChannel.value;t!=="stable"&&(u.updateChannel.value="stable",await Af(),lo().info("force_stable_channel(): reset updateChannel",{priorValue:t}))}catch(t){lo().error("force_stable_channel(): failed: "+t)}},numeric_captured_at:t=>{t.function("isoToLocal",{deterministic:!0},cF),t.function("isoToOffsetMinutes",{deterministic:!0},Gg),t.function("isoToPrecisionMs",{deterministic:!0},fF),t.transaction(()=>{t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),t.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),t.exec("DROP INDEX asset_captured_at_geohash_idx"),t.exec("DROP INDEX assetfile_exifuid_idx"),t.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")})()},spread_modes:t=>{t.function("plucklabmodeb6",{deterministic:!0},h2),t.transaction(()=>{xe(_n,e=>t.exec(`ALTER TABLE AssetFile ADD COLUMN mode${e} integer`)),t.exec("UPDATE AssetFile SET "+xe(_n,e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`).join(", "))})()},normalize_asset_file_uris:t=>{t.function("normalizeURI",{deterministic:!0},dS),t.transaction(()=>{let e=t.prepare("SELECT normalizeURI(uri) AS nuri, count(*) AS cnt, GROUP_CONCAT(id) AS ids FROM AssetFile GROUP BY nuri HAVING cnt > 1").all(),r=[];for(let i of e){let o=h(i.ids).split(","),n=t.prepare("SELECT id, shown, version, updatedAt FROM AssetFile WHERE id in ("+o.join(",")+")").all(),s=bt(n,m=>[m.shown,m.version,m.updatedAt]),a=n.filter(m=>m.id!==s.id);r.push(...a.map(m=>m.id))}for(let i of aa(r,256))t.exec("DELETE FROM AssetFile WHERE id in ("+i.join(",")+")");t.exec("UPDATE AssetFile SET uri = normalizeURI(uri)")})()},dedupe_tag_paths:t=>{t.transaction(()=>kF(t))()},suffix_tag_paths:t=>(t.function("tag_path_suffix",{deterministic:!0},g2),t.transaction(()=>{kF(t),t.exec("UPDATE Tag SET _path = tag_path_suffix(_path)")})()),normalize_tag_paths:t=>{let e=t.prepare("SELECT id, _path FROM Tag WHERE _path LIKE '%' || char(31) || char(31) || '%'").all();lo().info("normalize_tag_paths():",{badTags:e});for(let r of e){let i=FF(r._path);OF(t,D([r.id,...t.prepare("SELECT id FROM Tag WHERE _path = ?").pluck().all(i)]))}},drop_tc_tables:t=>{let e=/^(ct|taf|tag_counts)_[a-z0-9]{6}$/i,r=t.prepare("SELECT name FROM sqlite_master WHERE type='table'").pluck().all(),i=r.filter(o=>e.exec(o)!=null);lo().info("drop_tc_tables()",{tables:r,victims:i});for(let o of i)t.exec("DROP TABLE "+o)}};var y2=`
CREATE TABLE IF NOT EXISTS migrations (
  id integer NOT NULL PRIMARY KEY, 
  name varchar(255) NOT NULL, 
  migration_time integer NOT NULL 
)
`;function b2(t){return t.name.includes("_nofk")}var Ry=class{constructor(e,r,i){this.migrationsDir=e;this.db=r;this.fsMigrations=l(()=>this.migrationsDir.children(e=>e.ext===".sql"));this.migrationsInDatabase=l(()=>this.db.prepare("SELECT name from migrations").pluck().all());this.assertKnownMigrations=l(()=>{if(!ns)return;let e=this.migrationsInDatabase().filter(r=>{let[i,o,n]=[r.slice(0,4),r.slice(4,6),r.slice(6,8)].map(a=>G(a)),s=new Date(i,o-1,n);return this.logger.debug("migration filter",{migrationName:r,migrationDate:s,gitDate:Kd}),Kd.getTime()<s.getTime()});if(k(e))throw new ue({fatal:!0,doNotSend:!0,message:"PhotoStructure is not forward-compatible with newer libraries. Please upgrade to open this library",cause:new Error("Unknown migrations: "+e.join(","))})});this.logger=d("Migration("+O({schema:e.base,db:i.nativePath})+")"),r.exec(y2),this.addMigrationStmt=r.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}async apply(e){this.assertKnownMigrations();let r=await this.fsMigrations();if(r==null)throw new Error("no migration files found for "+this.migrationsDir);let i=[],o=this.migrationsInDatabase();for(let n of r)o.includes(n.name)?this.logger.debug("latest(): already applied "+n.base):(await f(e,s=>s(n)),await Oe(this.applyMigration(n),5*A,()=>{throw new ue({fatal:!0,ignorable:!1,message:"Migration "+n.name+" timed out."})}),i.push(n.base));return this.logger.info("up to latest!",{appliedMigrations:i}),i}async applyMigration(e){xx(e.name);try{let r=Date.now(),i=(await e.readLines()).filter(s=>v(s)||s.trim().startsWith("--")),o=ky[e.name.replace(/^[\d_-]+/,"")],n=Ee(o);if(L(i)&&n)throw new ue({message:"empty migration "+e.name,fatal:!0});return n?await o.bind(ky)(this.db):await this.applySqlMigration(e),this.logger.debug("applyMigration() completed",{elapsedMs:Date.now()-r,codeMigration:n,migration:e.baseWithParent}),this.db.transaction(()=>{this.addMigrationStmt.run(e.name,Date.now())})()}catch(r){return this.logger.throw("Failed to apply migration "+e.baseWithParent,Ot(r))}}async applySqlMigration(e){let r=b2(e);try{let i=h(await e.readFile());if(v(i)){this.logger.error("Empty migration: "+e);return}r&&this.db.pragma("foreign_keys = OFF");for(let o of _(i.split(";")))try{this.db.exec(o)}catch(n){throw new ue({cause:n,fatal:!0,message:`Failed to apply: ${o}`})}if(r){let o=this.db.pragma("foreign_key_check");if(k(o))throw this.logger.error("foreign_key_check failed",o),new Error("Foreign key checks failed during migration "+e.name)}}finally{r&&this.db.pragma("foreign_keys = ON")}}};var Ny=P(require("path"));var _y=P(require("fs-extra"));function Pp(t){try{return W(t).filter(M).flatMap(_y.statSync).flatMap(e=>Number(e.size)).get()}catch{return}}var w2=require("better-sqlite3");function Qm(t,e=u.dbTimeoutMs.valueOrDefault){let r;if(u.logSql.valueOrDefault){let i=d("SQLite("+t.split(Ny.sep).slice(-2).join(Ny.sep)+")"),o=Xv();r=n=>i.log(o,n.replace(/\s{2,}/g," "))}return f(Pp(t),i=>{u.dbCacheSizeMb.tmpValue=Math.max(u.dbCacheSizeMb.valueOrDefault,Math.ceil(1.1*i/Hi)),d("mkdb("+t+")").info("Dynamically setting dbCacheSize to "+u.dbCacheSizeMb.value,{dbFileSize:i})}),x2(new w2(t,{fileMustExist:!1,readonly:!1,timeout:e,verbose:r}))}function x2(t){let e=['encoding = "UTF-8"',"threads = "+te(1,4,xt()),"foreign_keys = ON","page_size = "+16*Fd,"trusted_schema = 0","cache_size = -"+u.dbCacheSizeMb.valueOrDefault*Hi/1024,"locking_mode = NORMAL","journal_mode = WAL","busy_timeout = "+u.dbTimeoutMs.valueOrDefault,"synchronous = NORMAL","auto_vacuum = NONE"];return hp(()=>{for(let r of e)t.pragma(r)}),t}var RF=["-wal","-journal"];var vIe=l(()=>d("SQLiteFiles"));function cl(t){return[t,...RF.map(e=>t.sibling(t.base+e))].filter(e=>e.clear().existsSync())}function _F(t,e,r=u.dbTimeoutMs.valueOrDefault){let i=Qm(h(t),r);try{return e(i)}finally{i.close()}}async function NF(t,e,r=u.dbTimeoutMs.valueOrDefault){let i=Qm(h(t),r);try{return await e(i)}finally{i.close()}}var JIe=require("better-sqlite3"),Bn=d("SQLite");async function BF(t,e){try{await e.parent().mkdirp_();let r=new ln({path:h(t),op:"Backing up"},100);await NF(t,i=>i.backup(h(e),{progress({totalPages:o,remainingPages:n}){return r.onProgress((o-n)/o*100),100}}),J)}catch(r){throw new ue({cause:r,fatal:!0,message:`Could not back up db ${t} -> ${e}`})}}var T2=[{integrity_check:"ok"}];function CF(t){try{let e=t.pragma("integrity_check");if(co(e,T2))return Bn.info("verifyDb("+t.name+"): OK"),!0;throw new Error(O(e))}catch(e){throw new ue({cause:e,fatal:!0,retriable:!1,message:"verifyDb("+t.name+") failed"})}}function VF(t){try{return CF(t)}catch{return!1}}function By(t){return _F(t,CF,J)}var zF=["wal_checkpoint(RESTART)","optimize"];function UF(t){Bn.warn("optimizeDb() starting...",t.name);for(let e of zF)t.pragma(e);Bn.warn("optimizeDb() finished.")}async function WF(t,e="recover",r=!0){let o=(await t.parent().join(e).mkdirpSync_()).join(t.base);Bn.info(`repairDbFile_(${t} -> ${o})`);try{let n=await oP(),s=3*Ke+await t.size()*1.25,a=10*s,m=new ln({path:h(t),op:"Repairing db"},s),c=new Bt,p=pn(n,[t.nativePath,"."+e],5*A,{encoding:"buffer",maxBuffer:a});p.stdout.on("error",E=>re("sqlite "+e+" failed for "+t,new ue({cause:E,fatal:r})));let g=pn(n,[o.nativePath],5*A,{encoding:"buffer",maxBuffer:a});g.on("exit",()=>c.resolve()),p.stdout.on("end",()=>{g.stdin.end(zF.map(E=>"PRAGMA "+E+";").join(`
`))}),p.stdout.on("data",E=>{let R=E.length;m.incrProgress(R),g.stdin.write(E)}),await c,await By(o),Bn.info(`repairDbFile_(): ${o} is valid, finishing repair.`);let w=await ye(cl(t),E=>E.renameYMDHMS_("needed-repair"));return await ye(cl(o),E=>E.mv_(t.parent())),w.find(E=>E.ext===".db"||E.ext.startsWith(".sqlite"))}catch(n){return Bn.throw("failed to recover DB via dump and restore. Please see <https://photostructure.com/faq/restore-db-from-backup/> "+de,n)}}async function qF(t){if(await t.notExists())return;let e=await t.parent().join("version-backup").mkdirp(),r=await e?.childWithSameContents(t);if(e==null||r!=null)return r;let i=e.join(FM()+"-"+t.base);return await Cy(t,i),i}async function Cy(t,e){Bn.info("coldDbBackup(): copying "+t+" to "+e);let r=cl(t).filter(i=>!i.eql(t));await t.copyFile_(e),await ye(r,i=>i.copyFile_(e)).catch(i=>Bn.warn("Failed to copy aux db files",i))}var Ym=class extends $e{constructor(e,r,i=()=>{}){super("Db("+e+")",()=>this.closeDb(),me.db);this.schema=e;this._dataDir=r;this._onMigration=i;this.endTimeoutMs=A;this.migrate=l(async()=>{let e=this.dbfile;if(this.db==null||e==null)throw new Error("Cannot migrate database: missing db");await this.maybeRepair();let r=l(async()=>(this._onMigration(),qF(e))),i=new Ry(Me.for(jr.Migrations()).join(this.schema),this.db,e);return{appliedMigrations:await i.apply(r),migration:i}});this.onRetry=l(()=>this.closeDb(),u.maxBusyDbMs.valueOrDefault/4)}get datadir(){return T(this._dataDir,zt())}get dbfile(){return ks(this.datadir,this.schema)}get open(){return this._db!=null&&this._db.open}get inTransaction(){return this.open&&this._db?.inTransaction===!0}prepare(e){return this.db.prepare(e)}pragma(e,r){return this.db.pragma(e,r)}get db(){let e=this._db==null;if(!this.open){this.logger.info("setting up new db connection to "+this.dbfile,{priorWasNull:e});try{this.dbfile.parent().mkdirpSync_(),this._db=Qm(this.dbfile.nativePath);let r=this._db.pragma("quick_check",{simple:!0});if(r!=="ok")throw new Error("Quick integrity check failed: "+r+de)}catch(r){throw new ue({cause:r,fatal:!0,message:"Failed to set up "+this.dbfile})}}return this._db}closeDb(){try{this._db?.open===!0&&(this.logger.info("closing db",this._db),this._db?.close())}catch(e){this.logger.warn("closeDb(): .close() failed",e)}this._db=void 0}async maybeRepair(){let e=!0;try{e=VF(this.db)}catch{e=!1}e||(this.logger.warn("maybeRepair(): database failed validation. Trying to restore with dump/load."),await this.repair_())}async vacuum(){await My(()=>this._vacuum())}async _vacuum(){try{await dp(()=>{UF(this.db),this.db.exec("VACUUM")},this.onRetry)}catch(e){this.logger.warn("vacuum(): vacuum failed, trying to recover by dump-load",e),await this.repair_()}}async repair_(){this.logger.warn("repair_(): Attemping restore of "+this.dbfile),this.closeDb(),await My(()=>WF(this.dbfile)),this.logger.info("repair_(): Database restoration was successful!")}};var Bs=class extends $e{constructor(e){super(e.name,()=>{f(this.timer,clearInterval),this.timer=void 0},T(e.rank,me.first),()=>ee(e._isEnded,r=>r(),()=>!1),e.endTimeoutMs);this.setup(e)}async setup(e){C(e.initialDelayMs)&&await wt(e.initialDelayMs),!this.ended&&(this.timer=Vr(e.callback,Math.round(e.intervalMs),...F(e.args)))}};var Vy=class{constructor(e,r,i,o=qh()){this.seq=e;this.set=r;this.name=i;this.stamp=o}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return this.fromBasename(e.base)}static fromBasename(e){return f(this.parseRe.exec(e),r=>new Vy(parseInt(r[2],10),parseInt(r[3],10),r[4],r[1]))}},Xm=Vy;Xm.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;var fl=class{constructor(e,r,i){this.dir=e;this.sets=r;this.seq=i;this.mods=l(()=>xe(this.sets,e=>Math.pow(2,e)).reverse())}static async for(e,r){return new fl(e,r,T(await fl.maxSeq(e),-1))}static async maxSeq(e){return ox([...F(await b(e.childNames(),r=>r.map(i=>Xm.fromBasename(i)?.seq)))])}set(e){return this.sets-this.mods().findIndex(r=>e%r==0)}next(e){let r=++this.seq;return new Xm(r,this.set(r),e)}async hanoiFiles(){let e=await this.dir.clear().childNames();return D(e?.map(r=>Xm.fromBasename(r)))}async validHanoiFiles(e){let r=await ze(e,()=>this.hanoiFiles()),i=Md(r,n=>n.set),o=[];for(let n of i.keys())f(bt(i.get(n),s=>s.seq),s=>o.push(s));return o}async staleHanoiFiles(e){let r=await ze(e,()=>this.hanoiFiles()),o=(await this.validHanoiFiles(e)).map(n=>n.seq);return r.filter(n=>!o.includes(n.seq))}async staleFiles(){return this.staleHanoiFiles().then(e=>e.map(r=>r.toFile(this.dir)))}};var Ep=P(require("process"));function Zm(){return Ep.stdout==null||Ep.stdout.destroyed||Ep.stdout.writableEnded}function zy(t,...e){Zm()||console.log(t,...e)}var JOe=1*Ft;var Uy=class extends Bs{constructor(e,r,i,o,n,s=()=>{},a=()=>{}){super({name:"DbBackup("+i+")",callback:()=>this.backup(),intervalMs:u.dbBackupIntervalMinutes.valueOrDefault*A,rank:me.predb});this.db=e;this.isLockOwner=r;this.srcDbFile=i;this.backupsDir=o;this.replaceDir=n;this.beforeBackup=s;this.onBackupFinished=a;this.endTimeoutMs=A;this.mutex=new Jt;this.hanoi=l(()=>fl.for(this.backupsDir,u.dbBackupsCount.valueOrDefault));Gn()||this.onEnds.push(async()=>{await this.mutex.serial("DbBackup.end()",async()=>{Lr()&&zy("Verifying & backing up "+e.dbfile+"..."),await this._backup(!0),Lr()&&zy("PhotoStructure library db has been backed up to "+o+".")})})}backup(){return this.mutex.maybeRun("DbBackup.backup()",()=>this._backup())}async _backup(e=this.ended){if(!await this.isLockOwner()){this.logger.info("backup(): not lock owner, no-op.");return}if(!e&&!this.db.open){this.logger.warn("backup(): db is already closed.",this.db.name);return}if(await this.srcDbFile.clear().isEmpty()){this.logger.warn("backup(): db is missing.",this.srcDbFile.nativePath);return}try{this.logger.info("backup(): beforeBackup...",{srcDb:this.srcDbFile.nativePath,backupsDir:this.backupsDir.nativePath}),await this.beforeBackup(),e&&this.db.open&&(this.logger.info("backup(): closing db before backup..."),await this.db.closeDb());let r=this.srcDbFile.parent().join("backup",this.srcDbFile.base);this.logger.info("backup(): starting backup to "+r),await BF(this.srcDbFile,r),this.logger.info("backup(): backup taken. Verifying "+r),await By(r),this.replaceDir!=null&&(this.logger.info("backup(): Copying to "+this.replaceDir),await Cy(r,this.replaceDir));let i=await cl(r),o=await this.hanoi(),s=o.next("").toFilename();this.logger.info("backup(): Rotating files to "+this.backupsDir.join(s));for(let a of i)await a.mv_(this.backupsDir.join(s+a.base),{overwrite:!0});for(let a of await o.staleFiles())this.logger.info("backup(): removing stale backup "+a),await a.unlink();this.logger.info("backup(): finished successfully"),await this.onBackupFinished()}catch(r){this.logger.throw(r,{from:"DbBackup._backup() failed",fatal:!0,srcDb:this.srcDbFile.nativePath})}}};var jF=l(async()=>{let t=Xi().join("local-db");return await t.join("README.txt").writeTxt_(`
This folder is only used when your library is on a remote filesystem.

You will corrupt your library if you remove this directory while PhotoStructure is
running.

If you have any questions, please visit <https://photostructure.com/support/>.`),t});var HF=l(async()=>new Intl.DateTimeFormat(await Nc(),{month:"short"})),GF=l(async()=>{let t=await HF();return po(0,12,e=>t.format(new Date(2016,e,1))).map(e=>hr(e,"."))});H(()=>{HF.unset(),GF.unset()});function v2(t){return 1e4-t}function M2(t){return 13-t}function KF(t){return 13-t}function S2(t){return 33-t}function P2(t){return pe(t,e=>({name:h(e),ordinal:v2(e)}))}async function Wy(t){if(!!St(1,12,t))return f((await GF())[t-1],e=>({name:String(t),displayName:e,ordinal:M2(t)}))}function E2(t){return pe(t,e=>({name:h(e),ordinal:S2(e)}))}async function qy(t){let e=h(u.tagYMD.valueOrDefault).toLowerCase();if(t==null||e===""||e==="off"||e.startsWith("disable"))return;let r=[ce.When];if(e.startsWith("y")){let i=f(No(t),P2);if(i==null)return;r.push(i)}if(e.startsWith("ym")){let i=await f(_o(t),Wy);if(i==null)return r;r.push(i)}if(e.startsWith("ymd")){let i=f(Ro(t),E2);if(i==null)return r;r.push(i)}return r}async function JF(t,e){if(u.tagYMD.valueOrDefault==="")return;let r=[...e];L(e)&&await b(yi(t),o=>r.push(o.capturedAt));let i=$A(r);if(!(i==null||i.src.startsWith("stat")&&!u.tagDateFromStat.valueOrDefault))return qy(i.date)}var jy=4,Hy=8,$F=jy**Hy;function QF(t,e,r){let[i,o,n,s,a]=A2(t),m=e,c=`(${i}*${m}*${m}+${o}*${m})%${r}`,p=`(${n}*${m}+${s})%${r}`;return`((${c})*(${p})+${a})%${r}`}var D2=[[353868013,472882027,479001599,517294153],[1012573,1230587,1355297,1572751],[756065159,812182027,899809343,989450477],[3959297,4514113,4823201,5133127],[573259391,666101999,694847533,746151647],[2275327,2770513,3073703,3511973],[173313197,182557181,203457869,222230231],[6054613,6189107,7752103,9852103]],YF=[1012573,1101689,1183811,1196089,1230587,1355297,1419641,1483733,1572751,2275327,2770513,3010349,3073703,3118691,3174823,3511973,3959297,4514113,4690451,4823201,5133127,5375327,6019889,6054613,6189107,7752103,7752103,9852103];function F2(t){return Zd(jy,t,Hy).map((r,i)=>D2[i][r])}var A2=ff(t=>{let[e,r,i,o,n,s,a,m]=F2(t%$F),c=[e/r,i/o,n/s,a/m].map(p=>Ie(p,7));return c.push(YF[t%YF.length]),c},{maxSize:128,ttlMs:A});var Gy=class{constructor(e){this.id=e}nextAssetBatch(e){let r={};return f(e,i=>r.capturedAtLt=i.getTime()),Bh(`/tag-gallery/${this.id}`,r)}};var Cs=P(require("path"));var tRe=Re.lift(t=>t.isFile()),rRe=Re.lift(t=>t.isReadable());function eu(t){return Re.lift(async e=>be(_e(e,!1),t,()=>!1))}function XF(t){return eu(e=>Uu(...t.map(r=>e[r])))}var L2=Re.lift(async t=>{let e=await Io(t);if(e==null||!e.startsWith("image/")&&!e.startsWith("video/"))return!1;let r=e.startsWith("video/")?u.minVideoDimension.valueOrDefault:u.minImageDimension.valueOrDefault;return be(Xa(t),i=>Pr(i.ImageWidth,r)&&Pr(i.ImageHeight,r),()=>!1)}),I2=Re.lift(async t=>{let e=await Io(t);if(e==null)return!1;if(!e.startsWith("video/"))return!0;let r=await _e(t,!1);return r==null?!1:Pr(vn(r),u.minVideoDurationSec.valueOrDefault)}),O2=XF(["MIMEType"]),k2=XF(["Make","Model"]),R2=eu(t=>G(t.Rating,{defaultValue:0})>=0),iRe=eu(t=>yo(["image/jpeg","image/png"],h(t.MIMEType))),_2=eu(t=>h(t.MIMEType).startsWith("image/")),N2=eu(t=>h(t.MIMEType).startsWith("video/")),B2=_2.and(k2).or(N2);async function C2(t){return!v(t)&&(Hf(t)||An(t)||lr(t)&&await Rm()||Fs(t)&&await Jf())}var V2=Re.lift(async t=>be(Io(t.nativePath),C2,()=>!1)),Ky=Re.lift(async t=>!Mm(t.nativePath)),ZF=Re.lift(async t=>Pt(wn(t))),e0=Re.lift(async t=>be(t.size(),e=>St(u.minAssetFileSizeBytes.valueOrDefault,u.maxAssetFileSizeBytes.valueOrDefault,e),()=>!1)),oRe=Re.andLogged(d("fileFilterNoStat"),{exifExtFilter:tp},{notHiddenCheap:Ky}),nRe=Re.andLogged(d("fileFilterCheap"),{exifExtFilter:tp},{notHiddenCheap:Ky},{noMediaFilter:ZF},{fileSizeFilter:e0}),Jy=l(()=>D([{exifExtFilter:tp},{fileSizeFilter:e0},{notHiddenCheap:Ky},{noMediaFilter:ZF},{hasMimeType:O2},{supportedMimeTypeFilter:V2},u.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:B2}:void 0,{notRejected:R2},{minDimensionsFilter:L2},u.minVideoDurationSec.valueOrDefault>0?{minVideoDurationFilter:I2}:void 0])),t0=l(()=>Re.andLogged(d("fileFilterExpensive"),...Jy())),sRe=Re.lift(async t=>v(t.ext)),aRe=Re.lift(async t=>t.isDirectory());function Ap({a:t,b:e,field:r,desc:i,parser:o}){let n=o(t[r]),s=o(e[r]),a=u.minExposureSettingsCoeffPct.valueOrDefault/100;return n==null||s==null||rw(n,s,a)?void 0:"Different "+i+": "+t[r]+" \u2260 "+e[r]}function r0(t,e){if(!(t==null||e==null))return Qs([()=>Ap({a:t,b:e,field:"focalLength",desc:"focal length",parser:Xo}),()=>Ap({a:t,b:e,field:"aperture",desc:"aperture",parser:Xo}),()=>Ap({a:t,b:e,field:"shutterSpeed",desc:"shutter speed",parser:Yw}),()=>Ap({a:t,b:e,field:"iso",desc:"ISO",parser:Xo})])}function $y(t,e){for(let r of e){let i=t[r];if(M(i))return r+":"+h(i).trim()}}function i0(t){return $y(t,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"])}function o0(t){{let e=$y(t,["LensSerialNumber","LensID"]);if(e!=null)return e}return f(np(t),({lensMake:e,lensModel:r})=>`${e.toLowerCase()}/${r.toLowerCase()}`)}function n0(t){return $y(t,["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"])}var s0=[{ms:uw,s:"year",p:"years"},{ms:30.4*ot,s:"month",p:"months"},{ms:mw,s:"week",p:"weeks"},{ms:ot,s:"day",p:"days"},{ms:Ft,s:"hour",p:"hours"},{ms:A,s:"minute",p:"minutes"},{ms:S,s:"second",p:"seconds"}];function tu(t,e=2,r){if(!Pu(t))return se(t)?"-"+tu(Math.abs(t),e):"";let i=s0.findIndex(s=>s.ms<=t);if(i===-1)return"";let o=t,n=D(s0.slice(i,i+e).map(s=>{if(!(s.ms>o)){let a=Math.floor(o/s.ms);return o-=a*s.ms,{i:a,s:tc(a,s.s,s.p)}}}));return L(n)?"":n.map(s=>s.s).join(", ")+ee(r,s=>" "+(n[n.length-1].i!==1?s.singular:s.plural),"")}var z2=l(()=>d("FilePathTagger"));function a0(t){let e=[];for(let r of t)try{e.push(Qy(r))}catch(i){z2().warn("Failed to parse asset file URI",{uri:r})}return e}function Qy(t){let e=Wa(t),r=e.scheme===Yi?Mp:e.authority,i=e.path.split("/").slice(0,-1);return _([ce.FS,r,...i])}var vr=class extends Wo{static touch(e){return ge(F(e).filter(C),r=>this.dbl.runf(i=>i.whereIn("id",r).update("updatedAt",Date.now())))}toID(){return"updateCount"in this&&(this.updateCount=Xn(this.updateCount,e=>e,1)),pl(this)}get createdAtDate(){return pe(this.createdAt,e=>new Date(e))}get updatedAtDate(){return pe(this.updatedAt,e=>new Date(e))}$beforeUpsert(){if(this.createdAt==null&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this){let e=this;e.updateCount=Xn(e.updateCount,r=>r+1,1)}}};function pl(t){return f(t,e=>({id:e.id,v:nw(e.updateCount,0)}))}var Yy=class extends vr{constructor(){super(...arguments);this.posixFile=l(()=>ne.forUri(this.uri,this.mountpoint))}static async recentAssetIdsByUriRoot(e,r,i=64){let o=Date.now()-r,n=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",o).andWhere("Asset.shown",1).andWhere("Asset.hidden",0);return M(e)&&(n=n.andWhere("AssetFile.uri","like",e+"%")),n=n.orderBy("AssetFile.updatedAt","desc").limit(i),this.logger().debug("recentAssetIdsByUriRoot",n.toSQL()),this.dbl.pluckAll(n)}static assetCountByMimetype(e){let r=this.query().select(so.raw("mimetype, count(*) as count")).join("Asset","Asset.id","AssetFile.assetId").where("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0);return M(e)&&(r=r.andWhere("uri","like",e+"%")),r=r.groupBy("mimetype").orderBy("mimetype"),this.dbl.all(r)}static async assetCountByMimetypeRoot(e){let r=await this.assetCountByMimetype(e);return cr(V(r.map(o=>o.mimetype.split("/")[0]))).map(o=>({mimetypeRoot:o,count:ta(r,n=>n.mimetype.startsWith(o+"/")?n.count:0)}))}static children(e,r){let i=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${ht(e)}/[^/]+$}`);return this.ops().all(ee(r,o=>o(i),()=>i))}get capturedAtDateTime(){return ym(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return lF(this.capturedAtDateTime,e)}static outdatedQuery(e){let r=this.query().where("version","<",Es).orderBy("id");return L(e)?r:r.andWhere(i=>i.whereIn("mountpoint",e).orWhereNull("mountpoint"))}static async nextOutdated(e=Ar){return this.ops().findOne(e(this.outdatedQuery(await vt())))}static async outdatedCount(e=Ar){let r=this.outdatedQuery(await vt());return this.dbl.pluckFirst(e(r.count("id")))}static async setShown(e,r){if(this.logger().info("setShown()",{assetId:e,assetFileId:r}),!C(e)||!C(r))throw new Error("setShown(): invalid IDs: "+O({assetId:e,assetFileId:r}));await this.dbl.runf(n=>n.update("shown",0).where("assetId",e));let i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),o={assetId:e,assetFileId:r,updatedAt:Date.now()};return this.dbl.run({sql:i,bindings:o})}static async findByAsset(e,r){let i=this.query().select("AssetFile.*");return f(Mi(e),o=>i.join("Asset","Asset.id","AssetFile.assetId").where(Jo(o,(n,s)=>["Asset."+n,s]))),f(Mi(r),o=>i.where(Jo(o,(n,s)=>["AssetFile."+n,s]))),this.ops().all(i)}get modes(){return D(xe(_n,e=>this["mode"+e]))}set modes(e){xe(_n,r=>this["mode"+r]=e[r])}async matchesFile(e){if(this.version==null||this.version<Es||u.forceSync.valueOrDefault)return!1;let r=await this.fileFields(e);return sx(r,this)}fileFields(e){return at(e).orElse(()=>this.posixFile()).filter(r=>r.exists()).flatMap(async r=>({uri:await r.uri(),fileSize:await r.size(),mtime:await r.thisOrSidecareMaxMtimeMs()})).filter(Vu).get()}isVersionUpToDate(){return Bi(this.version,Es)}async siblingCount(){return Yy.dbl.pluckFirstf(e=>e.count().where({assetId:this.assetId}).andWhereNot({id:this.id}))}async upsertIfNeeded(){let e=u.forceSync.valueOrDefault;if(await this.matchesFile()&&C(this.id)&&!e)return this.upsert();if(await this.isFileDeleted()){this.deleted=!0,await this.delete();return}if(!await this.notExists())return b(this.updateFromFile(),()=>this.upsert())}async maybeUpdateStats(e){return b(this.fileFields(e),r=>ma(this,r))}async updateFromFile(e){let r=Date.now(),i=this.logger().addContext(".updateFromFile()");if(i.debug("before",this),this.id!=null&&await this.matchesFile(e)){i.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");return}if(e!=null&&await this.setFile(e),e==null&&(e=await this.posixFile()),e==null||await e.notExists()){i.info("no-op, "+e+" is missing");return}if(this.mountpoint==null&&await b(e.mountpoint(),g=>this.mountpoint=g.nativePath),await this.maybeUpdateStats(e)==null){i.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});return}let o=e.sha(),n={},s=await yi(e);if(s==null){i.error("missing tags for "+e);return}if(v(s.MIMEType)){i.error("missing MIMEType for "+e);return}n.mimetype=s.MIMEType;let a=s.capturedAt,m=a.toLocal();if(m==null)return i.throw("bad CapturedAt",a);n.capturedAtLocal=m,n.capturedAtOffset=a.toOffset(),n.capturedAtPrecisionMs=a.toPrecisionMs(),n.capturedAtSrc=a.src,f(s.exposureSettings,g=>{n.focalLength=g.focalLength,n.aperture=g.aperture,n.shutterSpeed=g.shutterSpeed,n.iso=g.iso});let c=s.dimensions;if(n.width=c.width,n.height=c.height,n.rotation=s.rotation,n.make=s.Make,n.model=s.Model,n.cameraId=i0(s),n.imageId=f(n0(s),h),n.lensId=o0(s),n.geohash=rD(s.GPSLatitude,s.GPSLongitude),n.durationMs=f(s.duration,g=>Math.round(g*1e3)),n.fps=f(ii(s.VideoFrameRate),ut),n.sha=await o,n.sha==null){i.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri});return}(u.useImageHashes.valueOrDefault||u.strictDeduping.valueOrDefault)&&await b($m(e),g=>{n.meanHash=g.meanHash,n.modes=g.modes}),ma(this,n),this.version=Es;let p=Date.now()-r;return i.log(p>S?"info":"debug","after ("+p+"ms)",this),this}async updateFromShaSibling(e){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:e.sha==null||!e.isVersionUpToDate()||this.sha!=null&&e.sha!==this.sha?this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e}):(ma(this,qt(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt")),this)}async getAsset(){return this.assetId==null||this.asset!=null?this.asset:this.asset=await Se.ops().findById(this.assetId)}async exists(){return be(this.posixFile(),e=>e.exists(),()=>!1)}async notExists(){return Pt(this.exists())}async isFileDeleted(){return be(this.posixFile(),e=>e.isDeleted(this.uri),()=>!1)}async isFiltered(){return at(this.posixFile()).filter(e=>e.exists()).flatMap(e=>t0().apply(e)).map(e=>!e).getOrElse(()=>!1)}async hasNoMedia(){return be(this.posixFile(),e=>e.hasNoMedia(),()=>!1)}async setFile(e){let r=await e.uri();if(r==null)return this.logger().throw("setFile(): no URI for "+e);let i=await e.mountpoint();if(i==null)return this.logger().throw("setFile(): no mountpoint for "+e);if(this.uri!=null&&!await gf(r,this.uri))return this.logger().throw("setFile(): cannot reassign non-equivalent URI",{prior:this.uri,new:r,file:e.nativePath});if(await e.uriObject()==null)throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);return this.uri=r,this.mountpoint=i.nativePath,this.posixFile.set(Promise.resolve(e)),r}nativePath(){return b(this.posixFile(),e=>e.nativePath)}toCapturedAt(){return f(ym(this.capturedAtLocal,this.capturedAtOffset),e=>b(this.posixFile(),r=>new nl(r.nativePath,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}async downloadables(e,r){try{let i=await this.posixFile();if(i==null)return[];let o=e.ap(this.assetId),n=[];if(await i.isNonEmpty()&&n.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:cy(i,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:i.base,description:"Download original",details:`(${$r(this)} ${i.ext})`}),this.isVideo||!(I(this.shown)||this.sha===r))return n;let a=D(await Promise.all([...await o.previews()].reverse().filter(m=>m.reducer===er.fit).map(m=>FD(i.base,m))));return n.push(...Er(a,m=>m.size)),n}catch(i){return re("AssetFile.downloadables failed",i,{context:this}),[]}}async pathInfo(){try{let e=Be.parse(this.uri),r=await Ps(e,this.mountpoint);if(r==null){this.logger().warn("pathInfo(): failed to build nativePath",{uri:this.uri});return}let i=e.fsPath,o=hr(r,i).split(Cs.sep),n=o.pop(),s=i.split(Cs.sep),a=Qy(e),m=await Ce.findByPath(a);if(m==null){this.logger().warn("pathInfo(): failed to find existing Tag",{tagPath:a});return}let c=await m.toApiPathElements();this.logger().info("pathInfo()",{uri:this.uri,fsPath:i,nativePath:r,mountpointParent:o,pathAfterMountpointParent:s,mountpointName:n,tag_path:m.path,pathElements:c}),c.shift(),v(n)?c.shift():c[0].displayName=n,s.splice(0,c.length);let p={nativePath:r,nativePathPrefixWbr:Kw(o.join(Cs.sep)+Cs.sep),pathElements:c,nativePathSuffix:s.join(Cs.sep),pathSep:Cs.sep,exists:await this.exists()};return this.logger().info("pathInfo()",{result:p}),p}catch(e){this.logger().warn("pathInfo(): failed",e);return}}async toApi(e,r){return b(this.pathInfo(),async i=>Jn(y(y({assetId:this.assetId,assetFileId:this.id},i),{mimetype:this.mimetype,shown:I(this.shown),width:this.width,height:this.height,rotation:T(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:await this.downloadables(e,r),createdAtLocale:l0(this.createdAt),updatedAtLocale:l0(this.updatedAt)})))}get isVideo(){return lr(this.mimetype)}},fe=Yy;fe.tableName="AssetFile",fe.uniqueColumnName="uri",fe.booleanFields=["shown"];function l0(t){return f(t,e=>tu(Date.now()-e,1)+" ago")}var bi=class extends Wo{$pk(){return[T(this.assetId,()=>f(this.asset,e=>e.id)),T(this.tagId,()=>f(this.tag,e=>e.id))].join(":")}static addTagsToAsset(e,r){let i=od(e);if(i==null){this.logger().warn("addTagsToAsset(): got null assetId");return}let o=D(r.map(od));if(L(o)){this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:r});return}let n="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+o.map(s=>`(${i},${s})`).join(",");return this.dbl.run(n)}static removeTagsFromAsset(e,r){r=D(r);let i=this.query().whereIn("tagId",r).andWhere({assetId:e}).delete();return this.dbl.run(i)}};bi.tableName="AssetTag",bi.uniqueColumnName="assetId,tagId";function Dp(t){return{id:t.id,at:t.capturedAtLocal}}var Xy=class{constructor(e,r,i,o){this.tags=e;this.before=r;this.after=i;this.limit=o;this.logger=()=>d("TaggedAssetStream("+this.toString()+")");this.logger().info("new",this.toJSON())}vacuum(){qn(this.before,e=>[-e.capturedAtLocal,-e.id]),kw(this.before,this.limit),qn(this.after,e=>[-e.capturedAtLocal,-e.id]),ju(this.after,this.limit)}toString(){return this.tags.map(e=>e.path.join("/")).join(",")}valueOf(){return this.toString()}get length(){return F(this.before).length+F(this.after).length}leftPad(e){return[...xe(this.limit-e.length,r=>({id:-(r+1),v:0})),...e]}rightPad(e){return[...e,...xe(this.limit-e.length,r=>({id:-(r+this.limit+1),v:0}))]}toJSON(){return{tags:this.tags.map(e=>e.toString()),assetIdsAfter:this.after.map(Dp),assetIdsBefore:this.before.map(Dp)}}mergeWith(e){Fu(this.tags,e.tags,r=>r.path),Fu(this.before,e.before,r=>r.id),Fu(this.after,e.after,r=>r.id),this.logger().debug("mergeWith() complete",{tas:e.toJSON(),tags:this.tags.map(r=>r.path),beforeIds:this.before.map(Dp),afterIds:this.after.map(Dp)})}async toApi(){return this.vacuum(),this.logger().tap({msg:"toApi()",result:{tags:await ye(this.tags,e=>e.toApiTag()),assetIdsAfter:this.leftPad(this.after.map(e=>e.toID())),assetIdsBefore:this.rightPad(this.before.map(e=>e.toID()))}})}streamCoeff(e){return this.logger().tap({msg:"streamCoeff",meta:{this:this.tags.map(r=>r.path),tas:e.tags.map(r=>r.path)},result:Fw([...this.before,...this.after],[...e.before,...e.after],r=>r.id)})}};function m0(t){let e=u.minStreamCorrPct.valueOrDefault/100,r=[],i=t.filter(o=>o.length>5);for(let o of i){let n=bt(r,s=>ow(s.streamCoeff(o),e));n==null?r.push(o):n.mergeWith(o)}return r}var Rt=class extends vr{constructor(){super(...arguments);this.attrs={};this.urls=l(()=>new In(this.toID()))}static shownUnhidden(e){return T(e,()=>Rt.query()).andWhere({shown:1,hidden:0,excluded:0})}static shownCount(){return this.ops().countf(e=>e.where({shown:1,excluded:0}))}static outdatedQuery(){return this.query().where("version","<",xn).andWhere({shown:1,excluded:0})}static deletePreviews(e){return Br.instance().previews().ap(e).deleteAll()}static async delete(e){this.logger().warn("Deleting asset "+e),await bi.dbl.runf(r=>r.delete().where({assetId:e})),await fe.dbl.runf(r=>r.delete().where({assetId:e})),await Rt.dbl.runf(r=>r.delete().where({id:e})),await Rt.deletePreviews(e)}static async exclude(e){return this.logger().info("Excluding asset "+e),{dbResult:await Rt.dbl.runf(r=>r.update({excluded:1}).where({id:e})),deletedPreviews:await Rt.deletePreviews(e)}}static nextOutdated(e=Ar){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=Ar){return this.dbl.pluckFirst(e(this.outdatedQuery()).count())}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static async addTags(e,r){let i=Er(r.filter(k),o=>Tr(o));return this.logger().debug("addTags()",{assetId:e,tagPaths:r,uniqTagPaths:i}),L(i)?void 0:Rt.tx(async()=>{let n=(await ye(i,s=>Ce.findOrCreate(s))).map(s=>s.id);return bi.addTagsToAsset(e,n)})}static async removeTags(e,r){if(L(r))return;let i=await ye(r,o=>Ce.findByPath(o));return this.logger().info("removeTags()",{assetId:e,tags:i.map(o=>rt(o,"id","path")),tagPaths:r}),bi.removeTagsFromAsset(e,D(i.map(o=>o.id)))}static unshownAssetIds(){return this.dbl.pluckAll(`
        SELECT DISTINCT af1.assetId
        FROM AssetFile af1
          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 
            ON af1.assetId = af2.assetId
        WHERE af2.assetId IS NULL`)}static archive(e){return this.tx(async()=>{await Rt.ops().findById(e)!=null&&(await bi.dbl.runf(i=>i.where({assetId:e}).delete()),await fe.dbl.runf(i=>i.where({assetId:e}).delete()),await Rt.dbl.runf(i=>i.where({id:e}).delete()))})}get capturedAt(){return Kh(this.capturedAtLocal)}get capturedAtMs(){return bm(this.capturedAtLocal)}markUnshownAndUpsert(){return this.shown=!1,this.version=xn,this.upsert()}markShownAndUpsert(){return this.shown=!0,this.excluded==null&&(this.excluded=!1),this.version=xn,this.upsert()}toAssetId(){return{assetId:this.id,capturedAtLocal:this.capturedAtLocal}}renderCaption(e){return f(this.capturedAtMs,r=>"Taken "+uF(r,e))}async whenApiTag(){return at(this.capturedAt).flatMap(e=>qy(e)).flatMap(e=>Ce.findOrCreate(e)).flatMap(e=>e.toApiTag()).get()}addTagPaths(e){return Rt.addTags(this.id,e)}async findAssetFileByUri(e){return await this.getFiles(),this.files.find(r=>r.uri===e)}async addAssetFile(e){return await this.findAssetFileByUri(e.uri)==null&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}static getTags(e){return Ce.ops().all(Ce.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}async getTags(){return this.tags==null&&(this.tags=await Rt.getTags(this.id)),this.tags}static getTagPaths(e){let r=Ce.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return Ce.dbl.pluckAll(r)}async tagPaths(){return(await this.getTags()).map(r=>r.path.join("/")).sort()}async getStreams(e){if(this.streams==null){let r=await this.getTags();this.logger().info("getStreams(): fetched tags "+r,{limit:e});let i=await ye(r,o=>o.getAssetStream(this,e));this.streams=m0(D(i));for(let o of this.streams)for(let n of o.tags)await n.getAncestors()}return this.streams}async getBeforeAfterId(){let e=await Rt.dbl.all(Rt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id"));this.afterId=f(e.find(r=>r.id>this.id),pl),this.beforeId=f(e.reverse().find(r=>r.id<this.id),pl),await ze(this.beforeId,()=>this.getBeforeId()),await ze(this.afterId,()=>this.getAfterId())}async getBeforeId(){return b(Rt.dbl.first(Rt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}])),e=>this.beforeId=pl(e))}async getAfterId(){return b(Rt.dbl.first(Rt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}])),e=>this.afterId=pl(e))}async getTagPaths(){return(await this.getTags()).map(r=>r.path)}async getFiles(){if(this.files!=null)return this.files;if(this.id==null)return this.files=[];let e=await fe.ops().findBy({assetId:this.id});return this.files=X(e,r=>[!I(r.shown),-r.mtime])}async setShown(e){return fe.setShown(this.id,e)}async getShown(){if(this.files!=null){let e=this.files.find(r=>I(r.shown));if(e!=null)return e}return b(fe.ops().findOneBy({assetId:this.id,shown:1}),e=>Lt(e,r=>r.asset=this))}async getCapturedAts(){return ye(this.getFiles(),e=>e.toCapturedAt())}link(){return"/asset/"+this.id}sqAttrs(e=!0){return y(y(y({},this.urls().sqImgAttrs(e)),{title:this.renderCaption()}),this.attrs)}async getImgAttrs(e,r,i=!1){if(this.imgAttrs==null&&(this.imgAttrs=new Map),this.imgAttrs.get(r)==null){let o=e.ap(this.toID());await b(o.readInfo(),async s=>{s.mimetype.startsWith("video/")&&(this.poster=await o.posterLink())});let n=!0;this.imgAttrs.set(r,await o.imgAttrs(r,n,i))}return this.imgAttrs.get(r)}async fitAttrs(e){return y(y({},await this.getImgAttrs(e,er.fit)),this.attrs)}isVideo(){if(this.files==null)throw new Error(".video called before getFiles()");return this.files.some(e=>e.isVideo)}videoAttrs(){return y({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(this.existingFiles==null)throw new Error(".videoSources called before getExistingFiles()");let e=this.existingFiles.filter(i=>i.isVideo).map(i=>({src:this.urls().videoLink(i.id),type:i.mimetype})),r=Er(e,i=>i.type);if(r.every(i=>i.type!=="video/mp4")){let i=this.existingFiles[0];r.unshift({src:this.urls().videoLink(i.id)+".mp4",type:"video/mp4"})}return r}async getPosixFiles(){let e=await this.getFiles();return D(await Promise.all(e.map(r=>r.posixFile())))}async getExistingAssetFiles(){return this.existingFiles==null&&(this.existingFiles=await tn(await this.getFiles(),e=>be(e.posixFile(),r=>r.exists(),()=>!1))),this.existingFiles}async findOrCreateByFile(e){let r=await e.uri();if(r==null)return;let i=F(await fe.findByAsset({id:this.id},{uri:r}))[0];return T(i,async()=>{let o=new fe;return o.asset=this,o.assetId=this.id,await o.setFile(e),o})}clear(){return this.existingFiles=void 0,this.files=void 0,this.imgAttrs=void 0,this.streams=void 0,this.tags=void 0,this}async setHidden(e){return this.hidden=e,this.upsert()}},Se=Rt;Se.tableName="Asset",Se.uniqueColumnName="id",Se.booleanFields=["shown","hidden","excluded"],Se.shownAssetCounts=l(()=>Rt.dbl.pluckFirst({sql:Ui("SELECT","  COUNT(DISTINCT Asset.id)","FROM Asset","WHERE","  Asset.shown = 1","  AND Asset.excluded = 0","  AND hidden = 0")}),7*S);function u0(t){return t.orderByRaw("COALESCE(ordinal, _path) COLLATE NOCASE")}H(()=>Ce.clear());async function c0(t){let e=await t;return e!=null&&Ce.cacheTag(e),e}var Te=class extends vr{constructor(){super(...arguments);this.urls=l(()=>new Gy(this.id));this.displayPath=l(async()=>{let e=await this.getParent();return[...e==null?[]:await e?.displayPath(),this.displayName]});this.descendantIds=l(async()=>Te.dbl.pluckAll({sql:Ui("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT id ","FROM descendants","WHERE id <> :tagId"),bindings:{tagId:this.id}}),7*S);this.ancestorIds=l(async()=>this.parentId===0||this.parentId==null?[]:Te.dbl.pluckAll({sql:Ui(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT id","FROM Tag","WHERE Tag.id in ancestors","  AND Tag.id <> :tagId","ORDER BY _path DESC"].join(" ")),bindings:{tagId:this.id}}))}static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this.recentTagsByPath.clear(),this.tagById.clear()}static cacheTags(e){return e.map(r=>this.cacheTag(r))}static cacheTag(e){return e!=null&&this.recentTagsByPath.set(e._path,Promise.resolve(e)),e?.id!=null&&this.tagById.set(e.id,Promise.resolve(e)),e}static newTag(e){let r=new Te;r._path=Tr(e);let i=e[e.length-1];return i!=null&&xu(i)&&(f(i.displayName,o=>r._displayName=o),f(i.ordinal,o=>r.ordinal=o),f(i.description,o=>r.description=o),f(i.releasedAt,o=>r.releasedAt=o)),r}static findByIdOrPath(e,r){return e===0?Te.root():C(e)?this.findById(e):this.findByPath(r)}static findById(e){return e===0?Te.root():Te.tagById.getOrSet(e,()=>c0(this.ops().findById(e)))}static async findByPath(e){let r=Tr(e);return v(r)?Te.root():Te.recentTagsByPath.getOrSet(r,()=>b(this.ops().firstf(i=>i.where("_path","like",r)),i=>Te.cacheTag(i)))}static getPagedAssets(e,r){let i=new Te;return i.id=e,i.getPagedAssetIds(r)}static async findOrCreate(e){if(L(e))throw new Error("empty tagPath");let r=Tr(e,"/"),i=await this.findByPath(e);if(this.logger().debug("_findOrCreate("+r+")",{prior:i}),i!=null)return i;let o=this.newTag(e),n=o.depth<=1?void 0:await this.findOrCreate(e.slice(0,-1));f(n,a=>o.parentId=a.id);let s=await c0(this.ops().upsertOne(o));return this.logger().debug("_findOrCreate("+r+") upserted",{newTag:o,result:s,parent:n}),s}clear(){return this.parent=void 0,this.root=void 0,this.children=void 0,this.ancestors=void 0,this.assets=void 0,this.relatedAssets=void 0,this.ancestorIds.unset(),this.descendantIds.unset(),this}siblingPath(e){return Tr([...this.parentPath,e])}async changeName(e){return this.changePath(this.siblingPath(e))}maybeUpsertDisplayName(e){return v(e)||e===this._displayName?void 0:this.upsert({_displayName:e})}async changePath(e,r=!0){let i=this._path,o=await Te.findByPath(Nn(e));this.logger().info("changePath(): ",{priorPath:i,newPath:e,existingSibling:o});try{o==null?(await Te.tx(async()=>{await Te.dbl.runf(n=>n.where("_path","LIKE",i+"%").update({updatedAt:Date.now(),_path:so.raw("REPLACE(_path, ?, ?)",[i,e])}))}),this._path=e):(e=o._path,this.logger().info("changePath(): replacing with sibling",e),await bi.dbl.updateOrIgnore(n=>n.where({tagId:this.id}).update({tagId:o.id})),await bi.dbl.runf(n=>n.where({tagId:this.id}).delete()),await ye(this.getChildren(),n=>n.changePath(Tr([...o.path,n.name]),!1)),await Te.dbl.runf(n=>n.where({parentId:this.id}).update({parentId:o.id})),await this.delete())}finally{r&&Te.clear()}}get name(){let e=this.path;return e[e.length-1]}get path(){return Nn(this._path)}get displayName(){return M(this._displayName)?this._displayName:this.name}get isRoot(){return this.id===0}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}get sortBy(){return[this.ordinal==null?2**51:this.ordinal,this.path.map(e=>e.toLowerCase())]}$childrenQuery(){return u0(Te.query().where({parentId:this.id}))}$assetsQuery(){return Se.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],f(this.parent,r=>r.setAncestors(e.slice(0,-1)))}async toApiPathElements(){return ye(this.getAncestorsAndSelf(),e=>({tagPath:e.path,displayName:e.displayName}))}async toApiTag(){return{tagId:this.id,tagPath:this.path,displayPath:await this.displayPath(),description:this.description,assetCount:this.assetCount,assetFileCount:this.assetFileCount}}toStringId(){return"Tag("+this.path.join("/")+")"}async getParent(){if(!this.isRoot)return this.parentId!=null&&this.parent==null?this.parent=await Te.findById(this.parentId):this.parent}async getPagedChildren(e){if(this.id===0){let o=T(e.offset,0),n=o+T(e.limit,this.children.length);return[...this.children].slice(o,n)}let r=this.$childrenQuery();pe(e.offset,o=>{r.offset(o)}),pe(e.limit,o=>void r.limit(o));let i=await Te.ops().all(r);for(let o of i)Te.cacheTag(o);return i}async getDescendants(){return Te.ops().all({sql:Ui("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN descendants","  AND Tag.id <> :tagId"),bindings:{tagId:this.id}})}async getChildrenCount(){return this.children!=null?this.children.length:Te.dbl.pluckFirstf(e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count())}async getChildren(){return this.children=await Te.ops().all(this.$childrenQuery()),this.children.forEach(e=>{e.parent=this}),this.children}link(){return"/tag/"+this.path.map(encodeURIComponent).join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}async getAncestors(){if(this.ancestors==null){let e=_w(this.parentPath).map(o=>Tr(o)),r=await Promise.all(e.map(o=>Te.recentTagsByPath.get(o)));if(r.every(o=>o!=null))return this.ancestors=r;let i=Te.query().whereIn("_path",e).orderBy("_path");this.ancestors=await Te.ops().all(i),Te.cacheTags(this.ancestors),this.parent=T(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}async getAncestorsAndSelf(){return[...await this.getAncestors(),this]}async _getAncestors(){return this.parentId===0||this.parentId==null?[]:Te.ops().all({sql:Ui(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN ancestors","  AND Tag.id <> :tagId","ORDER BY Tag._path DESC"].join(" ")),bindings:{tagId:this.id}})}getPagedAssetIds(e){let r=this.$assetsQuery().select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal"),i="desc";return Yo(e.capturedAtLt,o=>{r=r.where("capturedAtLocal","<",o)}),Yo(e.capturedAtGt,o=>{r=r.where("capturedAtLocal",">",o),i="asc"}),Yo(e.limit,o=>{r=r.limit(o)}),r=r.orderBy("capturedAtLocal",i),Se.dbl.all(r)}getAssets(){let e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return Se.ops().all(e)}async assetCountDesc(e){let r=this.assetCount;return(r==null||e==null||e.length===r||e.length===0?"":Ad(e.length)+" of ")+tc(r,"asset")}$assetStreamQuery(e,r,i){let o=this.path[0]===ce.When?Se.shownUnhidden():this.$assetsQuery();return o=o.distinct().where("capturedAtLocal",i,e.capturedAtLocal).andWhereNot("Asset.id",e.id).limit(i==="="?r*2:r),i==="="?o.orderByRaw(`ABS(Asset.id-${e.id})`):o.orderBy([{column:"capturedAtLocal",order:i===">"?"asc":"desc"},"Asset.id"])}async getAssetStream(e,r){r=C(r)?r:TF;let[i,o,n]=await ye(["<","=",">"],s=>Se.ops().all(this.$assetStreamQuery(e,r,s)));for(let s of o)s.id<e.id?i.push(s):n.push(s);return new Xy([this],i,n.reverse(),r)}async getRelatedAssetIds(e,r=xF){let i=Math.max(256,await U2()),o=await bi.dbl.allf(n=>n.select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal").distinct().join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).andWhere("Asset.excluded",0).andWhere("Asset.hidden",0).orderByRaw(QF(e+T(this.id,0),"Asset.id",i)).limit(r));return this.logger().debug(this.path+": Found "+o.length+" related assets",o),o}get attrs(){return{href:this.link(),title:this.name}}},Ce=Te;Ce.tableName="Tag",Ce.uniqueColumnName="_path",Ce.recentTagsByPath=new ke(256),Ce.tagById=new ke(256,A),Ce.cmp=(e,r)=>Nt([T(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[T(r.ordinal,Number.MAX_SAFE_INTEGER),...r.path]),Ce.root=l(async()=>{let e=new Te;return e.id=0,e._path=ao,e.parentId=void 0,e.children=(await Te.roots()).filter(r=>!Ht(u.hiddenHomeTags.valueOrDefault,r.name)),e.ancestors=[],e.assetCount=await Se.shownAssetCounts(),e.upsert=()=>{throw new Error("upsert not supported on root")},e},7*S),Ce._upsertDefaultRoots=l(()=>Te.ops().upsert(EF.map(e=>({_path:Tr([e.name]),ordinal:e.ordinal})))),Ce.roots=l(async()=>{await Te._upsertDefaultRoots();let e=await Te.ops().all(u0(Te.query().whereNull("parentId")));return e.forEach(r=>{r.parentId=void 0,r.ancestors=[],Te.cacheTag(r)}),e});var U2=l(()=>Se.dbl.pluckFirstf(t=>t.count()),A);var W2=`'${ce.When}' || char(31)`,q2=W2+" || '%' || char(31)",f0=q2+" || '%' || char(31)",j2=f0+" || '%' || char(31)",p0=l(()=>d("DateTagNormalizer"));async function H2(){return Ce.ops().allf(t=>t.whereNotNull("ordinal").andWhereRaw("_path LIKE "+f0+" AND _path NOT LIKE "+j2).limit(200*12))}async function d0(){await Ce.tx(async()=>ye(H2(),G2))}async function G2(t){let e=await pe(t.ordinal,r=>Wy(KF(r)));e==null?p0().warn("failed to fix tag (no monthTagRef)",{t}):e.name!==t.name&&(p0().info("Fixing month name",{tagRef:e,tag:t}),await t.changeName(e.name)),await t.maybeUpsertDisplayName(e?.displayName)}var g0=P(require("os")),y0=P(require("process"));var h0=Ae("rebuildLibrary","forceRestartSync","enqueueAssetFileUpdates","enqueueAssetUpdates","applyNewTagger"),Zy=class extends vr{static incomplete(){return this.ops().allf(e=>e.whereIn("id",r=>r.table(Zy.tableName).min("id").whereNull("completedAt")))}static async getFirstPendingOp(e){return this.logger().tap({msg:"getFirstPendingOp",level:"info",result:await this.ops().firstf(r=>{let i=r.whereNull("completedAt").orderBy("createdAt","asc");return e!=null?i.andWhere(e):i}),meta:{pojo:e}})}static markOpCompleted(e){return v(e?.name)?this.logger().throw("markOpCompleted(): bad query",{query:e}):this.dbl.runf(r=>r.whereNull("completedAt").andWhere(e).update({completedAt:Date.now()}))}static async applyOnce(e,r,i=Ar){let o=await this.ops().firstf(a=>i(a.whereNotNull("completedAt").andWhere(e)));if(o!=null){this.logger().info("applyOnce(): already done",{prior:o});return}let n=await this.ops().insertOne(e),s=await r(n);return $()||await n.upsert({completedAt:Date.now()}),s}},ru=Zy;ru.tableName="Operation",ru.uniqueColumnName="id";var EBe=Ae("lastScannedDirectory","scannedDirectoryCount","completedDirectoryScan","enqueuedStaleFiles","processedImageCount","processedVideoCount"),Cn=class extends vr{};Cn.tableName="ProgressMeta",Cn.uniqueColumnName="progressId,name";var HBe=l(()=>S*(xt()<=3?3:1.5)),K2=Ui(`
SELECT
  p1.uri as uri,
  p1.lastUpdatedAt as lastUpdatedAt,
  p1.lastCompletedAt as lastCompletedAt,
  min(p2.createdAt) AS lastStartedAt
FROM
  (
    SELECT
      uri,
      max(updatedAt) AS lastUpdatedAt,
      max(completedAt) AS lastCompletedAt
    FROM
      Progress
    WHERE
      createdAt > :minCreatedAt
    GROUP BY
      uri
  ) AS p1
  JOIN Progress AS p2
    ON 
      p2.uri = p1.uri AND 
      p2.createdAt > :minCreatedAt AND
      (p2.createdAt > ifnull(p1.lastCompletedAt, 0) OR p2.completedAt = lastCompletedAt)
GROUP BY
  1,2,3
`),J2=Ui(`
SELECT
  *
FROM
  ProgressMeta
WHERE
  id IN (
    SELECT
      max(pm.id)
    FROM
      ProgressMeta pm
      JOIN Progress p ON pm.progressId = p.id
      AND p.createdAt > :minCreatedAt
    WHERE
      p.uri = :uri
      AND p.hostname = :hostname
    GROUP BY
      p.uri,
      pm.name
  )
`),Lp=class extends vr{static async vacuum(e=90*ot){await Cn.dbl.runf(r=>r.whereIn("progressId",i=>i.table("Progress").select("id").where("createdAt","<=",Date.now()-e)).delete()),await this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async minCreatedAt(){let e=await ru.getFirstPendingOp({name:h0.forceRestartSync});return Lp.logger().tap({msg:"minCreatedAt",level:"info",result:T(e?.createdAt,0),meta:{op:e}})}static async times(){let e=await this.minCreatedAt();return this.dbl.all({sql:K2,bindings:{minCreatedAt:e}})}static async saveSyncState(e){return ye(F(await e.progress()),r=>(r.state==="done"&&r.completedAt==null&&(this.logger().warn("caller saved done sync state without setting completedAt",wc()),r.completedAt=Date.now()),r.id==null?this.logger().throw(e.name+" returned an unsaved Progress",r):r.upsert()))}static async insertNew(e,r){return this.ops().insertOne({uri:e,volume:r,pid:y0.pid,hostname:(0,g0.hostname)()})}toSyncState(){return{id:this.id,uri:this.uri,volume:this.volume,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return T(q(this.dekJSON,()=>_(JSON.parse(this.dekJSON))),()=>[])}set dek(e){this.dekJSON=O(_(e))}assignFromPojo(e){return Uo(this,e)}getThisMeta(){return Cn.ops().allf(e=>e.where({progressId:this.id}).orderBy("createdAt"))}async getMeta(){return Cn.ops().all({sql:J2,bindings:{minCreatedAt:await Lp.minCreatedAt(),uri:this.uri,hostname:this.hostname}})}setMeta(e,r){return Cn.ops().upsertOne({progressId:this.id,name:e,value:r})}async getMetaAsRecord(){return ft((await this.getMeta()).map(e=>[e.name,e.value]))}},Fp=Lp;Fp.tableName="Progress";var Vs=l(()=>d("TagSql")),eb,tb=l(()=>new Gm(ll,"Tag")),Ip=l(async()=>{if(pr&&Date.now()-qi<20*S)return;await Q2();let t=await tb().pluckFirst({sql:"SELECT MAX(rowid) FROM AssetTag"});Vs().info("updateTagCounts()",{newMax:t,lastMax:eb}),t!==eb&&(eb=t,await Qe("db.updateTagCounts",()=>$2()))},7*S);function Y2(t=Fl(6)){let e=`temp.ct_${t}`,r=`temp.taf_${t}`,i=`temp.tag_counts_${t}`;return iF(`
CREATE TABLE ${e} AS
SELECT
  DISTINCT t.id AS parentId,
  kid.id AS childId
FROM
  Tag t
  JOIN Tag kid ON kid._path LIKE (t._path || '%');

CREATE INDEX ${e}_idx ON ${e.replace(/^temp\./,"")}(parentId, childId);

CREATE TABLE ${r} AS
SELECT
  DISTINCT AssetTag.tagId as tagId,
  Asset.id AS assetId,
  AssetFile.id AS assetFileId
FROM
  AssetTag
  JOIN Asset ON AssetTag.assetId = Asset.id
  JOIN AssetFile ON AssetFile.assetId = Asset.id
WHERE
  Asset.hidden = 0
  AND Asset.excluded = 0
  AND Asset.shown = 1;

CREATE INDEX ${r}_idx ON ${r.replace(/^temp\./,"")}(tagId, assetId, assetFileId);

CREATE TABLE ${i} AS
SELECT
  parentId AS tagId,
  count(DISTINCT assetId) AS ac,
  count(DISTINCT assetFileId) AS afc
FROM
  ${e}
  JOIN ${r} ON childId = tagId
GROUP BY
  1;

CREATE INDEX ${i}_idx ON ${i.replace(/^temp\./,"")}(tagId, ac, afc);

-- Update used tags:

UPDATE Tag SET 
  assetCount = NULL,
  assetFileCount = NULL;

UPDATE Tag
SET
  assetCount = ac,
  assetFileCount = afc
FROM ${i}
WHERE tagId = id;

-- Clean up:

DROP INDEX IF EXISTS ${e}_idx;
DROP INDEX IF EXISTS ${r}_idx;
DROP INDEX IF EXISTS ${i}_idx;
DROP TABLE ${e};
DROP TABLE ${r};
DROP TABLE ${i};
`)}async function $2(){tb().db()==null&&Vs().throw("updateTagCounts(): modelDb is unset",{retriable:!1});try{let t=Fl(6),e="_"+t,r=await Da(tb().runScript(Y2(t),e)),i=te(7*S,5*A,r.elapsedMs*20);Vs().info("Updated tag counts",{elapsedMs:r.elapsedMs,newTTL:i}),Ip.setTTL(i),await X2()}catch(t){Vs().warn("Failed to update tag counts",t)}}async function X2(t=Date.now()-10*A){let e=[-1];for(let r of po(0,5)){let i=await Z2(t);if(L(i)||co(e,i))return;e=i}}async function Z2(t){let e=await Ce.dbl.pluckAllf(r=>r.select("Tag.id").leftOuterJoin("AssetTag","AssetTag.tagId","Tag.id").leftOuterJoin(so.raw("Tag AS child ON child.parentId = Tag.id")).whereNull("AssetTag.assetId").andWhere(i=>i.whereNull("child.id")).andWhere(i=>i.whereNull("Tag.assetCount")).andWhere("Tag.createdAt","<",t).orderBy("Tag._path","asc"));Vs().debug("vacuumLeafTags()",{candidates:e});for(let r of e)try{await Ce.dbl.runf(i=>i.where({id:r}).delete())}catch(i){Vs().info("vacuumLeafTags(): failed to delete",{tagId:r,err:i})}return Vs().info("vacuumLeafTags() complete.",{candidates:e}),e}async function Q2(){let t=d("updateTagMountpoints()"),e=await Ce.findByPath([ce.FS]);if(e==null){t.info("No root filesystem tag");return}await e.maybeUpsertDisplayName(u.tagDisplayNameFS.valueOrDefault);let r=await Or();if(r==null){t.warn("no-op: volumes() returned null");return}for(let i of await e.getChildren()){if(i.name===Mp){i.ordinal!==1&&await i.upsert({ordinal:1});continue}let o,n=r.find(s=>M(s.uuid)&&Tm(s.uuid)===i.name);n!=null?o=ri(n.label,n.mountpoint):o=await fe.dbl.pluckFirstf(s=>s.select("mountpoint").where("uri","LIKE","psfile://"+i.name+"/%").limit(1)),o!=null?(await i.maybeUpsertDisplayName(o),t.info("updated tag",{id:i.id,path:i.path,displayName:o}),Ce.clear()):t.debug("cannot update tag: no current volume.",{id:i.id,path:i.path})}}var iu=class{constructor(e,r,i){this.dataDir=e;this.isLockOwner=r;this.localDbDir=i;this.endTimeoutMs=A;this.end=l(()=>f(this.backup.value,e=>e.end()));this.setup=l(async()=>{try{await this._setup(),this.logger.info("ModelDb reading from "+this.db.value?.dbfile)}catch(e){this.db.reject(e),this.backup.reject(e),this.logger.throw(e,{fatal:!0,from:"ModelDbJanitor.setup"})}});this.beforeBackup=async()=>{$()||!Pe&&Lr()&&await Nr(ll(),async()=>{await ml.vacuum(),await Fp.vacuum(),await Ip()})};this.onBackupFinished=async()=>{!$()};this.onMigration=l(async()=>{this.logger.info("onMigration: removing prior stats db to clear prior work queues"),await b(Sm(!1),r=>r.rmrf("info"))});this.backupAndMigrate=async()=>Lr()||await this.isLockOwner();this.name="ModelDbJanitor("+e+")",this.logger=d(this.name),this.db=new Kt(this.name+".db"),this.backup=new Kt(this.name+".backup"),this.srcDbFile=ks(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),ux(this),this.setup()}static async for(e,r,i=jF){let o=new iu(e,r,i);return await o.setup(),o}get ended(){return this.end.prior()!=null}async _setup(){if(u.forceLocalDbReplica.valueOrDefault||await b(za(this.srcDbFile.nativePath),r=>r.remote)===!0){let r=await this.localDbDir();return this.localDbReplica=ks(r,"models"),this.logger.info("Library on remote drive. Using local db replica.",{src:this.srcDbFile.nativePath,local:this.localDbReplica}),await this.backupAndMigrate()&&(this.logger.info("Setting up local model db replica...."),await this.localDbReplica.parent().rmrf("info"),await this.srcDbFile.clear().exists()&&(await this.srcDbFile.copyFile_(this.localDbReplica),await this.localDbReplica.chmod(420)),this.logger.info("Local model db replica set up at "+this.localDbReplica)),this._finishSetup(r,this.srcDbFile.parent())}else return this._finishSetup(this.dataDir)}async _finishSetup(e,r){let i=await this.backupDir.mkdirp();if(i==null)throw new Error("Failed to create models DB backup dir "+this.backupDir);let o=new Ym("models",e,this.onMigration),n=await this.backupAndMigrate();n?(await o.migrate(),this.backup.resolve(new Uy(o,this.backupAndMigrate,o.dbfile,i,r,this.beforeBackup,this.onBackupFinished))):this.backup.resolve(void 0),XD(o),this.db.resolve(o),n&&(await d0(),await Ip()),this.logger.info("Finished setup",{primaryDbDir:e,replaceDbDir:r,backupDir:i})}};var b0=l(()=>{kM(pm()?eV:void 0),XM(pm()?tV:void 0)}),eV=async()=>await On()?f(kn(),t=>t.request("mountpoints")):void 0,tV=async()=>await On()?f(kn(),t=>t.request("volumes")):void 0;var rV;function w0(t){rV=t}async function x0(t){let e=new Ym("stats",t);return pM()&&(await e.migrate(),new Bs({name:"statsDbJanitor vacuum",callback:()=>e.vacuum(),intervalMs:Pe?20*S:5*A,rank:me.service})),w0(e),e}function iV(t){return t.toDateTime().toFormat(u.assetSubdirectoryDatestampFormat.valueOrDefault).split("/")}var rb=class{constructor(e,r){this.root=e;this.copyAssets=r;this.logger=d("AssetFileRepository")}directoryForDate(e){return this.root.join(...iV(e))}async importFile(e){let r=this.copyAssets();if(this.logger.debug("importFile()",{file:e,copyAssets:r}),!r||await hi())return e;if(await e.isDescendantOf(this.root))return this.logger.debug("no-op: "+e+" already contained by "+this.root),e;this.logger.debug("importing "+e);let i=await yi(e);if(i==null)throw new Error(e.nativePath+" has no tags (so, no createdAt)");let o=f(i.capturedAt,g=>Hg(g.date));if(o==null)throw new Error(e.nativePath+" has no capturedAt");if(o.year==null||o.month==null||o.day==null)return this.logger.warn("Insufficient capturedAt precision to copy "+e+" into library.",{capturedAt:i.capturedAt}),e;let n=this.directoryForDate(o);if(await n.mkdirp()==null)throw new Error("Cannot create destination directory, "+n.nativePath+" for "+e.nativePath);let s=await n.children(),a=await e.size(),m=await Hl(s,g=>g.size().then(w=>w===a)),c=await e.sha();if(m.length>0){let g=await Hl(m,w=>w.sha().then(E=>E===c));if(g.length>0){let w=g[0];return this.logger.info(e+" matches "+w),this.handleSidecars(e,w)}}let p=await n.join(e.base).ensureNew_();return this.logger.info("Copying...",{src:e.nativePath,dest:p.nativePath}),await e.copyFile_(p),this.handleSidecars(e,p)}async handleSidecars(e,r){let i=T(await e.sidecars(),[]);for(let o of i)await this.handleSidecar(o,r);return k(i)&&zr(r.nativePath),r}async handleSidecar(e,r){for(let o of T(await r.sidecars(),[]))if(await yD(e,o)){this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:o,dest:r});return}let i=await r.parent().join(r.name+e.ext).ensureNew_({emptyIsNew:!0});return e.copyFile_(i)}};var Br=class extends $e{constructor(e){super(`Library(${e})`,()=>this.onEnd(),me.predb);this.start=Date.now();this._ready=new Bt;this.setup=l(async()=>{let e=()=>{if(this.ended||$())throw new Error};try{if(this.logger.debug("setup() started"),!Jr()){if(!Zc())throw new Error("Cannot run "+Xt()+" without a library"+de+yr);this.logger.warn("Library settings don't exist yet. Skipping setup.");return}await this.openedBy().throwIfUnavailable("(library setup)"),e(),await Sf(this.rootDir),await Df(this.rootDir.nativePath);let r=this.originalsDir();if(r==null||await r.mkdirp()==null||!await r.isReadWritable())throw new Error(`Invalid value for ${u.originalsDir.key}: ${r} must be readable and writable.`);await this.statsDbDir(),await _m(),e(),ID(JD),pm()&&await On()&&(await jD(),b0()),e(),await this.modelDb(),e(),fM()&&await this.statsDb()}catch(r){!this.ended&&!$()&&(re("Library.setup() failed"+(Xc()?"":de),r),this._ready.reject(r))}finally{this._ready.pending&&(this.logger.info("Library.setup() finished."),this._ready.resolve())}});this.openedBy=l(()=>new vy(this.dataDir));this.statsDbDir=l(()=>Sm());this.previews=l(()=>new py(this.rootDir.join(u.previewsDir.valueOrDefault),aF));this.originalsDir=l(()=>Em(this.rootDir));this.assetFileRepository=l(()=>new rb(this.originalsDir(),()=>u.copyAssetsToLibrary.valueOrDefault));this.modelDbJanitor=l(async()=>iu.for(this.dataDir,()=>this.openedBy().isLockOwner()));this.modelDb=l(async()=>(await this.modelDbJanitor()).db.promise);this.statsDb=l(async()=>x0(await this.statsDbDir()));this.statsDbFile=l(()=>this.statsDb().then(e=>e.dbfile));this.onEnd=l(async()=>{for(let{ea:e,t:r}of[{ea:this.statsDb,t:J},{ea:this.modelDbJanitor,t:A},{ea:this.openedBy,t:J}])await f(await e.clear(),i=>Ei(i,r));this.logger.info("onEnd(): finished.")});this.rootDir=ne.for(e),this.dataDir=zt(this.rootDir),this.logger.info("new()")}static libraryPathChanged(){let e=f(u.libraryPath.value,ai),r=f(this.priorInstance,i=>i.rootDir.nativePath);return e!==r}static instance(){let e=this.libraryPathChanged(),r=I(this.priorInstance?.ended),i;return(e||r)&&(i=Ei(this.priorInstance,A),this.priorInstance=void 0),this.priorInstance==null&&Jr()&&(this.priorInstance=q(u.libraryPath.value,o=>Lt(new Br(o),async n=>(await i,n.setup())))),this.priorInstance}static instanceRequired(){let e=Br.instance();if(e==null)throw new Error("Library is undefined"+de);return e}get isPendingSetup(){return this._ready.pending}get ready(){return this._ready.promise}async requiredFiles(){let e=[];return await Sa(u.cacheDir.valueOrDefault)&&e.push({desc:"Cache directory",isDir:!0,file:()=>Xi()}),this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library model DB",isDir:!1,file:()=>b(this.modelDbJanitor(),r=>r.srcDbFile)},{desc:"Library model DB (local replica)",isDir:!1,file:()=>b(this.modelDbJanitor(),r=>r.localDbReplica)}),e}};var Op=class extends vr{static ping(e="ping"){return Op.ops().upsertOne({name:e})}static async assertPing(e){let r=Date.now();try{if(Op.db()==null)throw new Error("db is undefined");let i=await this.ping(e);if(this.logger().debug("assertPing()",{heartbeat:i}),Math.abs(r-i.updatedAt)>20*S)throw new Error("Heartbeat.updatedAt wasn't updated")}catch(i){throw new ue({cause:i,message:"Failed to write to the library database"})}}},ou=Op;ou.tableName="Heartbeat",ou.uniqueColumnName="name";var oV=0;function T0(){return Date.now()<=oV}var dl=d("LibraryHealthChecks"),Os=l(()=>nV(),15*S);function ib(){M0.unset(),Os.unset()}function S0(){return ib(),Os.refresh()}U(()=>{u.libraryPath.addListener(ib),Ex(S0),Dx(S0),ic(ib)});async function nV(){if(T0())return{ok:["Library health checks are paused"]};if(!u.libraryPath.hasValue()&&!Jr())return{ok:["Library isn't set up yet"]};let t=Br.instance();if(t==null)return Jr()?{fail:["Missing library at "+u.libraryPath.value]}:{};if(t.isPendingSetup){t.ready.then(()=>Os.unset());let a=Date.now()-t.start;return a<J?{ok:["Library is setting up..."]}:a<3*A?{warn:["Library is taking a long time to set up..."]}:{fail:["Library took too long time to set up."]}}else try{await t.ready}catch(a){return{fail:["Library setup failed: "+ls(a)]}}let e=[],r=[],i=[],o=[],n=[],s=async a=>{try{return await a()}catch(m){n.push(m),dl.warn("trap(): failed to run "+a.name+": "+Ot(m)),o.push(ls(m));return}};if(await s(()=>t.openedBy().throwIfUnavailable("(library health check)")),u.healthCheckExiftool.valueOrDefault&&await s(()=>pD()),u.healthCheckLibraryIsWritable.valueOrDefault&&await s(()=>M0().catch(a=>{throw new ue({cause:a,message:"Cannot write to "+Em(),fatal:!0})})),B)try{let a=await Fe.instance().version();v(a)&&o.push("PowerShell isn't working (can't get version).")}catch(a){n.push(a),o.push(`PowerShell isn't working (${ls(a)}).`)}if(u.healthCheckFreeSpace.valueOrDefault||u.healthCheckVolumes.valueOrDefault){let a=await s(()=>Or());if(L(a))o.push("Failed to scan system volumes."+de);else if(u.healthCheckFreeSpace.valueOrDefault)for(let m of await t.requiredFiles())try{let c=await m.file();if(c==null)continue;if(c.clear(),m.isDir&&!await c.isDirectory())o.push(`${m.desc}, ${c}, is missing`+de);else if(k(a)){let p=Zh(a,c.nativePath);dl.debug("checkDir()",{dir:c.nativePath,desc:m.desc,bestVolume:p,vols:a.map(g=>g.mountpoint)}),p==null?c.isUNC?r.push(`${m.desc}, ${c}: cannot be monitored for sufficient free space. Consider using a mapped network drive instead.`):o.push(`${m.desc}, ${c}, doesn't seem to have a mountpoint (?!)`):p.available<u.minDiskFreeGb.valueOrDefault*vo&&r.push(`Only ${rs(p.available)} are available on ${p.mountpoint}.`)}}catch(c){n.push(c),o.push("Failed to check "+m.desc+": "+ls(c))}}return L(o)&&L(r)&&e.push("Library and support directories are OK"),M(nu.env.TEST_FAIL)&&o.unshift(...nu.env.TEST_FAIL.split(",")),M(nu.env.TEST_WARN)&&r.unshift(...nu.env.TEST_WARN.split(",")),u.healthCheckDb.valueOrDefault&&await s(()=>ou.assertPing()),o.map(a=>re(a+da)),Tf({ok:e,warn:r,bad:i,fail:o},v0())}var M0=l(async()=>sV(Em()),Ft);async function sV(t){if(t==null)return dl.throw("copyExampleImageToLibraryDir(): undefined rootDir");let e=F(await Me.for(jr.Public()).join("images").children()).find(o=>o.name.startsWith("splash"));if(e==null)return dl.throw("copyExampleImageToLibraryDir(): missing validation image");t=Me.for(t);let r=t.join(".tmp-"+Fl(6)),i=r.join("write-test"+e.ext);try{await e.copyFile_(i);let o=await e.sha(),n=await i.sha();if(o!==n)return dl.throw("Failed to copy sample file to library. Is "+t+" writable?",{ignorable:!0});dl.debug(`Library root directory, ${t}, is writable`)}finally{await r.rmrf("debug")}}var aV=l(()=>new $e("memoryCheck on exit",()=>{let t=d("PromiseTimer"),e=P0();t.log(VS(e)?"warn":"info","memory use on exit:",e)},me.service));function P0(){aV();let t=[],e=[],r=[];function i(o,n,s){if(!C(o))return re("memoryCheck(): invalid bytesUsed. "+O({bytesUsed:o,desc:s})+da);let a=o/Ke,m=`used by ${Xt()} (${rs(o,2)})`;a>=n?r.push(`${s} ${m} is high`):a>=n*.8?e.push(`${s} ${m} is high`):t.push(`${s} ${m} is OK`)}return i(mg(),u.maxMemoryMb.valueOrDefault,"Used memory"),i(ug(),u.maxRssMemoryMb.valueOrDefault,"RSS memory"),{ok:t,warn:e,bad:r}}function v0(){return!Pe&&!u.scanAllDrives.valueOrDefault&&L(u.scanPaths.values)?{warn:["Nothing to scan: scanAllDrives is false and scanPaths is empty."]}:{}}async function zs(){try{return Tf(await Os(),P0())}catch(t){return ag({fail:[ri(ae(t),"healthChecks failed")]})}}async function E0(){if(Ii()||$())return!0;let t=await zs();return t==null||k(t.fail)||k(t.bad)||k(t.warn)}var mt=P(require("process"));var A0=P(require("process")),lV=P(require("timers"));var ob="--exit",kVe=l(()=>d("ChildService"));var D0=P(require("fs")),nb=P(require("fs-extra")),su=P(require("path")),au=P(require("process")),hl=P(require("timers"));var sb=class extends $e{constructor(){super("LogTail",()=>this.onEnd(),me.logger);this.watchers=new Map;this.file2pos=new Map;this.lastReadFiles=new gs(5*S);this.mutex=new Jt;this.setup=l(async()=>{await ja();let e=u.logDir.valueOrDefault;Pe&&console.log("tailing "+e+"..."),await(0,nb.mkdirp)(e),this.root=await qr.for(e),await this.scan(!0)});this.ignorableFilename=su.sep+Xt()+"-"+au.pid+"-",!au.stdout.writableFinished&&(Lh(!0),this.flushTimeout=(0,hl.setInterval)(()=>this.flush(),yn/2),this.scanTimeout=(0,hl.setInterval)(()=>this.scan(),A),au.stdout.on("end",()=>this.end()),this.setup())}async flush(){this.write(Ih())}readable(e){return e.endsWith(".log")&&!e.includes(this.ignorableFilename)}watchDir(e){$()||this.ended||Sr(this.watchers,e,()=>{gn(Ct.debug,()=>console.log("LogTail(): watching "+e));try{return(0,D0.watch)(e,(r,i)=>this.watchListener(r,(0,su.join)(e,i)))}catch(r){gn(Ct.warn,()=>console.error("LogTail(): failed to read "+e,r));return}})}async scan(e=!1){if(!($()||this.ended)&&(await this.root.visitDescendantFiles(async r=>{!this.readable(r.nativePath)||(e&&await b(r.size(),i=>this.file2pos.set(r.nativePath,i)),nf(await r.mtimeMs())&&this.watchDir(r.dir))}),!($()||this.ended))){try{let r=(0,su.join)(this.root.nativePath,ku(new Date));await(0,nb.mkdirp)(r),this.watchDir(r)}catch(r){gn(Ct.warn,()=>console.error("LogTail(): Failed to create the current log dir",r))}$()||this.ended||e&&console.log("LogTail(): Tailing "+this.root+"/**/*.log...")}}async onEnd(){Lh(!1),f(this.flushTimeout,hl.clearInterval),this.flushTimeout=void 0,f(this.scanTimeout,hl.clearInterval),this.scanTimeout=void 0;for(let e of this.watchers.values())e.close();this.watchers.clear();for(let e of this.lastReadFiles)await this.watchListener("onEnd",e);try{this.write(Ih(-1))}catch{}}write(e){for(let r of e)console.log(cm().formatLogEntry(r))}async watchListener(e,r){!this.readable(r)||await this.mutex.serialByName(r,async()=>{try{let i=await qr.for(r);if(i==null){gn(Ct.warn,()=>console.error("watchListener: missing file",{event:e,filename:r}));return}let o=await i.size();if(o==null||o<=0)return;let n=T(this.file2pos.get(i.nativePath),()=>0);if(Bi(n,o))return;await b(mM(i,{start:n,end:o}),s=>Gc(...s)),this.lastReadFiles.add(i.nativePath),this.file2pos.set(i.nativePath,o)}catch(i){gn(Ct.warn,()=>console.error("Failed to read "+r+": "+Ot(i)))}})}},kp=sb;kp.instance=l(()=>Zm()?void 0:new sb);var ab=class{constructor(){this.arr=[];this.iterIdx=0}get size(){return this.arr.length}count(e){return fr(this.arr,e)}unshift(...e){this.arr.splice(this.iterIdx,0,...e)}push(...e){this.unshift(...e),this.incrIdx(e.length)}remove(e){return this.filterInPlace(r=>r!==e)}filterInPlace(e){let r=!1;return et(this.arr,(i,o,n)=>{let s=e(i,o,n);return s||(r=!0,o<this.iterIdx&&this.iterIdx--),s}),this.incrIdx(0),r}next(e=()=>!0){if(this.size===0)return{value:void 0,done:!0};for(let r=0;r<this.size;r++){let i=this.arr[this.iterIdx];if(this.incrIdx(),i!=null&&e(i))return{value:i,done:!1}}return{value:void 0,done:!0}}toA(e=()=>!0){if(L(this.arr))return[];let r=[];for(let i=0;i<this.size;i++){let o=this.arr[(this.iterIdx+i)%this.arr.length];e(o)&&r.push(o)}return r}incrIdx(e=1){this.iterIdx=this.arr.length===0?0:(this.iterIdx+e)%this.arr.length}};ca(()=>lu());wx(()=>U(lu));var mV=new Jt,F0=new Jt,lb=new ab,bze=new Bs({name:"Idle",callback:lu,intervalMs:7*S,initialDelayMs:20*S}),L0=async()=>!1;function I0(t){L0=t}async function O0(){return Ii()||$()||lb.size===0||F0.pendingCount>=xt()||await L0()}var uV=xt()>4?250:750;async function lu(){return await O0()?void 0:mV.maybeRun("runOnIdle",async()=>{if(await O0())return;let{value:t}=lb.next(e=>e.runnable);t!=null&&F0.push(t.name,async()=>t.onIdle()).finally(()=>lu),lb.size>0&&U(lu,uV)})}var eL=P(require("@sentry/node"));var mu=l(()=>d("EventStore")),k0=7;function Rp(t){return qt(t,"breadcrumbs")}var mb=class{constructor(){this.root=Me.for(fi()).join("events")}datedRoot(e=new Date){return this.root.joinYMD(e)}rmrf(){return this.root.rmrf()}msg2file(e){return this.datedRoot(new Date(e.timestamp*S)).join(Wr(e.message,8,ms)+".json")}async eventsFrom(e=new Date){return F(await this.datedRoot(e).childFiles(r=>r.ext===".json"&&!r.isHiddenPosix()))}async eventQuotaExceeded(e){let r=h(e).includes(So)||h(e.message).includes(So),i=await this.eventCount(),o=u.maxErrorsPerDay.valueOrDefault+(r?k0:0);return i>=o}async eventCount(e=new Date){return(await this.eventsFrom(e)).length}async maybeSendEvent(e){if($())return mu().error("maybeSendEvent(): REJECT: we're ending.",{event:Rp(e)}),null;try{let r=lc(e.message),i=await this.eventCount(),o=u.maxErrorsPerDay.valueOrDefault+(r?k0:0);return i>=o?(mu().error("maybeSendEvent(): REJECT: too many events sent in the last day.",{recentEventCount:i,pleaseSend:r,maxErrorsPerDay:o,event:Rp(e)}),null):await this.writeEvent(e)==null?(mu().error("maybeSendEvent(): REJECT: event was already sent in the last day.",{event:Rp(e)}),null):(mu().error("maybeSendEvent(): ACCEPT",{event:Rp(e),pleaseSend:r,recentEventCount:i,maxErrorsPerDay:o}),e)}catch(r){return mu().error("maybeSendEvent(): Failed to determine if we should squelch the event. Failing closed.",r),null}}async writeEvent(e){let r=this.msg2file(e);return b(r.ensureNew_({maxVersions:u.maxErrorsPerDay.valueOrDefault,emptyIsNew:!1}).catch(()=>{}),i=>i.writeJsonMaybe(e))}},gl=mb;gl.instance=l(()=>new mb);var Us=l(()=>bo("ENABLE_SENTRY")||pr&&ns&&u.reportErrors.valueOrDefault);u.reportErrors.addListener(()=>Us.clear());var cu=P(require("@sentry/node")),fu=P(U0()),Vp=P(require("os")),zp=P(require("process"));var ub=class{constructor(e,r){this.maxLength=e;this.toValue=r;this.sortedArray=new ws(r)}toArray(){return this.sortedArray.store}vacuum(){return this.sortedArray.length>this.maxLength&&ju(this.sortedArray.store,this.maxLength),this.toArray()}get min(){return this.sortedArray.length>=this.maxLength?this.toValue(this.sortedArray[0]):void 0}add(...e){let r=this.min;for(let i of e)if(i!=null){let o=this.toValue(i);o!=null&&($b(o,r)||this.sortedArray.add(i))}this.sortedArray.length>=2*this.maxLength&&this.vacuum()}};var W0=P(require("fs")),Cp=P(require("zlib"));var q0=2048,wV=q0/4,cb=class{constructor(e,r){this.f=e;this.lines=new ws(_a);this._hasFirstLine=!1;this._ended=!1;this._paused=!1;this._errors=!1;this.from=Ur(e.name),this.fileStream=(0,W0.createReadStream)(e.nativePath,{autoClose:!0}),this.stream=(e.ext.toLowerCase().endsWith(".gz")?this.fileStream.pipe((0,Cp.createGunzip)()):e.ext.toLowerCase().endsWith(".br")?this.fileStream.pipe((0,Cp.createBrotliDecompress)()):this.fileStream).pipe(new cs).on("error",i=>{r(i),this._errors=!0}),this.stream.on("data",this.onData.bind(this)),this.stream.on("end",()=>{this._ended=!0})}onData(e){let r=Kc(e);r!=null&&(this.lines.add(y(y({},r),{from:this.from})),this._hasFirstLine=!0),this.lines.length>q0&&!this._paused&&(this.fileStream.pause(),this._paused=!0)}toString(){return"LogReader("+this.f.nativePath+")"}hasFirstLine(){return this._hasFirstLine}hasErrors(){return this._errors}ended(){return this._ended&&this.lines.length===0}peek(){return this.lines.store[0]}shift(){let e=this.lines.store.shift();return e!=null&&this.lines.length<wV&&this._paused&&(this.fileStream.resume(),this._paused=!1),e}};function xV(t=10*A){let e=Date.now()-t;return b(qr.for(u.logDir.valueOrDefault),r=>r.filterDescendantFiles(async i=>[".log",".log.gz"].includes(i.ext)&&Bi(await i.mtimeMs(),e)))}async function j0(t=50){await $c();let e=ft(Ct.values.map(n=>[n,new ub(t,_a)])),r=Date.now()-Ft,i=d("allRecentLogEntries()");return await b(xV(),n=>Dr({name:"allRecentLogEntries()",laters:n.map(s=>async()=>{try{let a=[],m=new cb(s,c=>a.push(c));for(await Je(()=>m.hasFirstLine(),{timeoutMs:10*S});!m.ended()&&!m.hasErrors();){let c=m.shift();c==null?await or(5):c.ts>r&&e[c.l]?.add(c)}k(a)&&(i.warn("Read error(s) for "+s,a),a.some(c=>c.code==="Z_BUF_ERROR"||ae(c).includes("unexpected end of file"))&&xi(await s.mtimeMs(),Date.now()-A)&&(i.warn("Unlinking corrupt logfile "+s),await s.unlink_()))}catch(a){i.warn("Failed to read entries from "+s,a)}})})),Y(Mt(e).map(n=>n.vacuum())).sort((n,s)=>Nt(n.ts,s.ts))}var H0=P(require("child_process")),G0=P(require("fs")),mo=P(require("os"));var fb=l(()=>d("os")),K0=l(()=>[TV(),"on",(0,mo.arch)()].join(" "));function TV(){switch((0,mo.platform)()){case"linux":return vV();case"darwin":return MV();case"win32":return SV();default:return uu()}}function uu(){return(0,mo.platform)()+" "+(0,mo.release)()}function vV(){try{let t=(0,G0.readFileSync)("/etc/os-release").toString(),e=uf({input:t,lowerCaseKeys:!0});if(M(e.pretty_name))return e.pretty_name;let r=T(e.version,e.version_id);return jo(e.name,r,(i,o)=>i+" "+o,uu)}catch(t){return fb().warn("Failed to fetch /etc/os-release",t),uu()}}function J0(t){return t.split(".").slice(0,2).join(".")}var PV={"10.6":"Snow Leopard","10.7":"Lion","10.8":"Mountain Lion","10.9":"Mavericks","10.10":"Yosemite","10.11":"El Capitan","10.12":"Sierra","10.13":"High Sierra","10.14":"Mojave","10.15":"Catalina","11.1":"Big Sur"},$0=l(()=>(0,H0.execSync)("sw_vers -productVersion").toString().trim());function EV(t=$0()){return PV[J0(t)]}function MV(t=$0()){try{return Ti(EV(t),e=>`macOS ${e} (${t})`,uu)}catch(e){return fb().warn("osNameMac(): unknown release",e),uu()}}var AV={"10.0":"10","6.3":"8.1","6.2":"8","6.1":"7","6.0":"Vista","5.2":"Server 2003","5.1":"XP","5.0":"2000","4.9":"ME","4.1":"98","4.0":"95"};function SV(t=(0,mo.release)()){let e=AV[J0(t)];return e!=null?`Windows ${e} (${t})`:(fb().warn("osNameWin(): unknown release: "+t),`Windows (${t})`)}var Q0=l(()=>Iw((0,mo.cpus)().map(t=>t.model)).map(t=>`${t.count} \xD7 ${t.t}`).join(", "),A);var Up=d("Sentry"),DV=100;async function Y0(t){try{return Us()?(cu.default.init({dsn:ni?"https://0652cdd351054fe9853ff944b1f54e2c@sentry.io/289071":"https://408e2f8d62c3494d8ed663d9e488d67a@sentry.io/1828379",shutdownTimeout:Qc(t.name),release:cT,environment:Ko,maxBreadcrumbs:DV,integrations:()=>[],beforeSend:FV().beforeSend,onFatalError:e=>re("sentry.onFatalError",e)}),!0):!1}catch(e){return Up.warn("Failed to set up sentry: "+e),!1}}function X0(t,e){Us()&&(e!=null&&!mc(e)?cu.default.captureException(bT(e,t)):mc(t)||cu.default.captureMessage(t))}var FV=l(()=>new Z0),Z0=class{constructor(){this.eventStore=gl.instance();this.beforeSend=async(e,r)=>{if(!Us())return Up.warn("Sentry.beforeSend(): not sending event",e),null;if(await this.eventStore.eventQuotaExceeded(e))return Up.warn("Sentry.beforeSend(): event quota exceeded",e),null;let i=LV(e,r);if(mc(i))return Up.info("Sentry.beforeSend(): event not sendable. vetoing",{event:e,hint:r,msg:i}),null;v(e.message)&&(e.message=ir(i,256));let o=await pb(e);return this.eventStore.maybeSendEvent(o)};ic(X0),Mx(X0),new $e("EventFilter",()=>this.end(),me.first)}end(){return f(cu.default.getCurrentHub().getClient(),e=>e.close(5*S))}};function LV(t,e){return V(Go([t.message,...F(IV(t.exception?.values)),ae(e?.originalException)])).join(": ")}function IV(t){return ge(t,e=>_(e.map(OV)))}function OV(t){return ge(_([t?.type,t?.value].filter(e=>h(e).toLowerCase()!=="error")),e=>e.join(": "))}async function pb(t){let e=u.email.value;M(e)&&(t.user==null&&(t.user={}),t.user.email=e),L(t.breadcrumbs)&&(t.breadcrumbs=await db());let r=T(t.extra,{});return r.pid=zp.default.pid,r.serviceName=Xt(),r.serviceEnding=$(),r.runtimeMs=Date.now()-qi,r.version=Tt,r.os=K0(),r.isDocker=Ue(),r.nodeVersion=zp.default.versions.node,r.locale=await Nc(),r.cpus=Q0(),r.memoryUsageMb=vf(),r.memoryUsageRssMb=Mf(),r.systemMemory=rs((0,Vp.freemem)())+" / "+rs((0,Vp.totalmem)()),r.ffmpeg=await iA(),r.vlc=await mA(),r.argv=O(zp.default.argv),t.extra=r,y({timestamp:Date.now()/S},t)}async function db(){await qm("writeRecentLogEntries"),await or(yn*3);let t=await j0();return D(t.map(kV))}function kV(t){return f(RV(t.l),e=>({timestamp:t.ts/S,level:e,category:T(t.from,Gr()),message:ji(t.ctx+": "+t.msg),data:typeof t.meta=="object"?t.meta:{value:ct(t.meta)?ji(t.meta):t.meta}}))}function RV(t){switch(t){case"error":return fu.Severity.Error;case"warn":return fu.Severity.Warning;case"info":return fu.Severity.Info;case"debug":return fu.Severity.Debug;default:return}}function _V(){return"User requested recent logs at "+new Date().toISOString()+So}async function tL(){let t=_V(),e=await pb({message:t,breadcrumbs:await db()});return Us()?eL.default.captureEvent(e):await gl.instance().writeEvent(e),e}var hb=P(require("process"));function Cr(t,e=dm()){Zm()||(d("stdoutWrite").debug("()",{obj:t,ready:e}),hb.stdout.write(O(t)+`
`),e&&hb.stdout.write(NV+`
`))}var NV=O({ready:!0});function qs(t){return Cr(t)}var BV=l(()=>{Lx(()=>$c()),ca(()=>fg()),rc(()=>cg())}),gb=class{constructor(e){this.opts=e;this._exitted=!1;this._ready=new Bt;this.jobs=new Jt;this.onFatalHandlers=[];this.inputHandlers=new Map;this.setup=l(async()=>{this.logger.info("setup()");let e=()=>!this._exitted&&!$();try{q(qe("PS_FATAL_"+this.name),i=>{throw new ue({fatal:!0,message:i})}),q(qe("PS_CRASH_"+this.name),i=>{U(()=>{throw new ue({message:i})},5*S)});{let i=vi()+(this.name===Na.main?"":` ${this.name}`),o=mt.default;try{o.title=i}catch{}}if(await ja(),Jr()&&await Df(),await this.setupErrorHandling(),this.logStartup(),Lr()&&(await this.maybeUpgradeSystemSettings(),await this.maybeUpgradeLibrarySettings()),BV(),I0(E0),await this.stdinReadline(),e()){let i=Br.instance();if(i==null&&!Zc())throw new Error("Cannot start, library path is unset"+de);i!=null&&await i.ready}On();let r=!e();this.logger.debug("setup done.",{reject:r}),r?this._ready.reject():this._ready.resolve()}catch(r){console.error(Ot(r)),this._ready.reject(r),this.exit({reason:sc(this.name+" setup failed: "+ae(r),de),status:14,waitForJobs:!1})}});this.stdinReadline=l(()=>{let e=mt.default.stdin.pipe(new cs);return e.on("data",r=>this.onLine(h(r))),e});Yc(this.name=this.opts.name),fm(),u.logDir.addListener(()=>fm()),u.tailLogs.valueOrDefault&&kp.instance(),this.logger=d("Service("+this.name+")"),this.addDefaultInputHandlers(),this.jobs.push("Service.setupOrTimeout",()=>this.setupOrTimeout())}async setupOrTimeout(){{let r=await Oe(this.setup().then(()=>!0),u.setupTimeoutMs.valueOrDefault);if(I(r))return}let e=Pp(ZD()?.nativePath);if(e!=null){let r=e/10,i=r-(Date.now()-qi);i>0&&this.logger.warn("Startup is taking a while, but the database looks like it's large, so we're going to wait for another "+jh(i),{dbFileSize:e,timeoutMs:r,setupTimeoutMs:u.setupTimeoutMs.valueOrDefault});let o=await Oe(this.setup().then(()=>!0),i);if(I(o))return}return this.exit({reason:"Setup timed out after "+jh(Date.now()-qi)+`.
Please visit https://photostructure.com/troubleshooting for help.`,status:13,waitForJobs:!1})}get ready(){return this._ready.promise}get isReady(){return this._ready.resolved}get exitted(){return this._exitted}onFatal(e){this.onFatalHandlers.push(e)}logStartup(){this.logger.info("setup()",y({version:Tt,start:qi,argv:mt.default.argv,arch:mt.default.arch,platform:mt.default.platform,isDocker:Ue(),isPacked:ns,isElectron:ni,versions:mt.default.versions,settings:{logLevel:u.logLevel.valueOrDefault,httpPort:u.httpPort.valueOrDefault,rpcPort:u.rpcPort.valueOrDefault,libraryPath:u.libraryPath.valueOrDefault}},Ev()))}async maybeUpgradeSystemSettings(){Tt!==await GS()&&await Af()}async maybeUpgradeLibrarySettings(){Jr()&&Tt!==await KS()&&await YS()}async setupErrorHandling(){if(ve.on("fatal",({message:e,error:r})=>this.exit({reason:e+f(r,i=>": "+ae(i)),status:12,waitForJobs:!1})),this.setInputHandler("--send-recent-logs",()=>tL()),mt.default.on("unhandledRejection",e=>f(e,r=>re("unhandledRejection",r))),mt.default.on("uncaughtException",e=>f(e,r=>re("uncaughtException",r))),mt.default.on("SIGINT",()=>this.exit({reason:"SIGINT",status:0,waitForJobs:!1})),mt.default.on("SIGTERM",()=>this.exit({reason:"SIGTERM",status:0,waitForJobs:!1})),mt.default.on("SIGCHLD",(...e)=>this.logger.debug("Received SIGCHLD",e)),mt.default.on("disconnect",()=>this.exit({reason:"disconnect",status:0,waitForJobs:!1})),Ba()||Lr()&&Ue())this.logger.info("setupErrorHandling(): not adding stdin/stdout/stderr close handlers: we're daemonized or in docker.");else{let e=!0;mt.default.stdin.on("close",()=>this.exit({reason:"stdin.close",status:0,waitForJobs:e})),mt.default.stdin.on("error",r=>this.logger.warn("stdin.error: "+r)),mt.default.stdin.on("disconnect",()=>this.exit({reason:"stdin.disconnect",status:0,waitForJobs:e})),mt.default.stdout.on("disconnect",()=>this.exit({reason:"stdout.disconnect",status:0,waitForJobs:e})),mt.default.stdout.on("error",r=>this.logger.warn("stdout.error: "+r)),mt.default.stderr.on("disconnect",()=>this.exit({reason:"stderr.disconnect",status:0,waitForJobs:e})),mt.default.stderr.on("error",r=>this.logger.warn("stderr.error: "+r))}await Y0(this)}async exit({reason:e,status:r,waitForJobs:i}){if(this._exitted=!0,this.logger.info("exit()",{status:r,reason:e,waitForJobs:i,ending:$()}),i&&(await or(250),await Je(()=>(this.logger.info("exit(): waiting for enqueued jobs to complete...",{pendingNames:this.jobs.pendingNames()}),this.jobs.settled),{timeoutMs:void 0,timeBetweenMs:S}),this.logger.info("exit(): enqueued jobs finished.")),r!==0){await Promise.all(this.onFatalHandlers.map(n=>n(e)));let o={fatal:!0,exit:!0,status:r,pid:mt.default.pid,ppid:mt.default.ppid};o.error=e,pt(()=>Cr(o,!1))}return await px(),mt.default.exit(r)}setInputHandler(e,r){this.inputHandlers.set(e.trim().toLowerCase(),r)}addDefaultInputHandlers(){this.setInputHandler("--version",async()=>{Cr({version:Tt})}),this.setInputHandler("--status",async()=>{let e=await zs();return this.logger.debug("--status",e),Cr({healthChecks:e})}),this.setInputHandler("--quit",()=>U(()=>this.exit({reason:"--quit from stdin",status:0,waitForJobs:!0}))),this.setInputHandler(ob,()=>U(()=>this.exit({reason:ob+" from stdin",status:0,waitForJobs:!0}))),this.setInputHandler("--pause",()=>(cg(),Cr({paused:Ii()},!1))),this.setInputHandler("--resume",()=>(fg(),Cr({paused:Ii()},!1)))}onLine(e){return this.logger.debug("onLine()",{line:e,ending:this._exitted||$()}),this.jobs.serial("Service.onLine("+e+")",async()=>{if(await this.setup(),e.trim().startsWith("--")){let r=e.split(" ",1)[0],i=this.inputHandlers.get(r);i==null?(this.logger.error("onLine(): unknown command",{line:e}),console.warn("unknown command "+e)):await i(e.substr(r.length).trim())}else try{await f(this.opts.stdinReceiver,r=>r(e))}catch(r){this.logger.error("onLine(): failed to process",{line:e,error:r})}})}};function wl({assetId:t,file:e,assetFile:r}){return Y([pe(t,i=>"assetId:"+i),f(e,i=>V(["bname:"+i.nameWithoutCount.toLowerCase(),"bname:"+Vo(i)]).sort()),f(r,i=>[pe(i.capturedAtLocal,o=>"at:"+o/1e4),q(i.sha,o=>"sha:"+o)])])}var Aqe=new ke(512);function iL(t,e){return Ga(e)===0?t:new rL([...t]).rotate(e).m}var rL=class{constructor(e,r=1){this.m=e;this.ary=r;if(this.rows=Math.sqrt(e.length/r),this.rows!==Math.floor(this.rows))throw new Error(`Only square tuple matrices are supported: ${this.ary===1?"":this.ary}(${this.rows}\xD7${this.rows}) != ${e.length}`)}index(e,r){return this.ary*(r+e*this.rows)}swap(e,r){for(let i=0;i<this.ary;i++){let o=this.m[e+i];this.m[e+i]=this.m[r+i],this.m[r+i]=o}}transpose(){for(let e=0;e<this.rows;e++)for(let r=e+1;r<this.rows;r++)this.swap(this.index(e,r),this.index(r,e));return this}reverseRows(){for(let e=0;e<this.rows;e++)for(let r=0;r<this.rows/2;r++)this.swap(this.index(r,e),this.index(this.rows-1-r,e));return this}reverseCols(){for(let e=0;e<this.rows;e++)for(let r=0;r<this.rows/2;r++)this.swap(this.index(e,r),this.index(e,this.rows-1-r));return this}reverse(){let e=this.rows**2;for(let r=0;r<e/2;r++)this.swap(r,e-1-r);return this}rotate(e){switch(Ga(e)){case 0:break;case 90:this.transpose(),this.reverseCols();break;case 180:this.reverse();break;case 270:this.transpose(),this.reverseRows();break;default:throw new Error("unsupported rotate("+e+")")}return this}};var CV=l(()=>[{name:"Acid green",rgb:"#B0BF1A"},{name:"Amaranth",rgb:"#E52B50"},{name:"Amethyst",rgb:"#9966CC"},{name:"Antique brass",rgb:"#CD9575"},{name:"Antique bronze",rgb:"#665D1E"},{name:"Antique fuchsia",rgb:"#915C83"},{name:"Apple green",rgb:"#8DB600"},{name:"Apricot",rgb:"#FBCEB1"},{name:"Aqua",rgb:"#00FFFF"},{name:"Aquamarine",rgb:"#7FFFD4"},{name:"Artichoke",rgb:"#8F9779"},{name:"Ash grey",rgb:"#B2BEB5"},{name:"Asparagus",rgb:"#87A96B"},{name:"Avocado",rgb:"#568203"},{name:"Azure",rgb:"#4988F5"},{name:"Beaver",rgb:"#9F8170"},{name:"Beige",rgb:"#F6F1DE"},{name:"Bistre",rgb:"#3D2B1F"},{name:"Black coffee",rgb:"#3B2F2F"},{name:"Black olive",rgb:"#3B3C36"},{name:"Black pearl",rgb:"#041322"},{name:"Black",rgb:"#000000"},{name:"Blond",rgb:"#FAF0BE"},{name:"Blood red",rgb:"#660000"},{name:"Blue bell",rgb:"#A2A2D0"},{name:"Blue sapphire",rgb:"#126180"},{name:"Blue-green",rgb:"#0D98BA"},{name:"Blue-violet",rgb:"#7366BD"},{name:"Blue",rgb:"#1F75FE"},{name:"Brandy",rgb:"#87413F"},{name:"Brick red",rgb:"#CB4154"},{name:"Bright green",rgb:"#66FF00"},{name:"Bright lilac",rgb:"#D891EF"},{name:"Brink pink",rgb:"#FB607F"},{name:"Bronze",rgb:"#CD7F32"},{name:"Brown",rgb:"#88540B"},{name:"Bud green",rgb:"#7BB661"},{name:"Burgundy",rgb:"#800020"},{name:"Burnished brown",rgb:"#A17A74"},{name:"Burnt orange",rgb:"#CC5500"},{name:"Burnt sienna",rgb:"#E97451"},{name:"Burnt umber",rgb:"#8A3324"},{name:"Byzantium",rgb:"#702963"},{name:"Cadet blue",rgb:"#5F9EA0"},{name:"Cadet",rgb:"#536872"},{name:"Cadmium green",rgb:"#006B3C"},{name:"Cadmium red",rgb:"#E30022"},{name:"Candy pink",rgb:"#E4717A"},{name:"Cardinal",rgb:"#C41E3A"},{name:"Caribbean green",rgb:"#00CC99"},{name:"Carmine",rgb:"#960018"},{name:"Carnelian",rgb:"#B31B1B"},{name:"Cerise",rgb:"#DE3163"},{name:"Cerulean blue",rgb:"#2A52BE"},{name:"Cerulean",rgb:"#007BA7"},{name:"Champagne",rgb:"#F3E5AB"},{name:"Charcoal",rgb:"#36454F"},{name:"Chartreuse",rgb:"#DFFF00"},{name:"Chestnut",rgb:"#954535"},{name:"Chocolate",rgb:"#7B3F00"},{name:"Citrine",rgb:"#E4D00A"},{name:"Citron",rgb:"#9FA91F"},{name:"Claret",rgb:"#7F1734"},{name:"Cobalt blue",rgb:"#0047AB"},{name:"Cocoa brown",rgb:"#D2691E"},{name:"Coffee",rgb:"#6F4E37"},{name:"Cool grey",rgb:"#8C92AC"},{name:"Copper red",rgb:"#CB6D51"},{name:"Copper rose",rgb:"#996666"},{name:"Copper",rgb:"#B87333"},{name:"Coral",rgb:"#F88379"},{name:"Cornflower blue",rgb:"#6495ED"},{name:"Cosmic cobalt",rgb:"#2E2D88"},{name:"Cotton candy",rgb:"#FFBCD9"},{name:"Crimson",rgb:"#DC143C"},{name:"Cyan",rgb:"#00B7EB"},{name:"Cyclamen",rgb:"#F56FA1"},{name:"Cyprus",rgb:"#003E40"},{name:"Dark brown",rgb:"#654321"},{name:"Dark byzantium",rgb:"#5D3954"},{name:"Dark cornflower blue",rgb:"#26428B"},{name:"Dark cyan",rgb:"#008B8B"},{name:"Dark goldenrod",rgb:"#B8860B"},{name:"Dark green",rgb:"#006400"},{name:"Dark liver",rgb:"#534B4F"},{name:"Dark magenta",rgb:"#8B008B"},{name:"Dark moss green",rgb:"#4A5D23"},{name:"Dark olive green",rgb:"#556B2F"},{name:"Dark orange",rgb:"#FF8C00"},{name:"Dark orchid",rgb:"#9932CC"},{name:"Dark pastel green",rgb:"#03C03C"},{name:"Dark powder blue",rgb:"#003399"},{name:"Dark purple",rgb:"#301934"},{name:"Dark red",rgb:"#8B0000"},{name:"Dark salmon",rgb:"#E9967A"},{name:"Dark sea green",rgb:"#8FBC8F"},{name:"Dark sienna",rgb:"#3C1414"},{name:"Dark slate blue",rgb:"#483D8B"},{name:"Dark slate grey",rgb:"#2F4F4F"},{name:"Dark spring green",rgb:"#177245"},{name:"Dark turquoise",rgb:"#00CED1"},{name:"Dark violet",rgb:"#9400D3"},{name:"Deep blue",rgb:"#0066FF"},{name:"Deep chestnut",rgb:"#B94E48"},{name:"Deep saffron",rgb:"#FF9933"},{name:"Deep sky blue",rgb:"#00BFFF"},{name:"Deep space",rgb:"#000040"},{name:"Deep taupe",rgb:"#7E5E60"},{name:"Denim",rgb:"#1560BD"},{name:"Desert",rgb:"#C19A6B"},{name:"Dim grey",rgb:"#696969"},{name:"Drab",rgb:"#967117"},{name:"Earth yellow",rgb:"#E1A95F"},{name:"Ebony",rgb:"#555D50"},{name:"Ecru",rgb:"#C2B281"},{name:"Eggplant",rgb:"#614051"},{name:"Eggshell",rgb:"#F0EAD6"},{name:"Elderberry",rgb:"#171828"},{name:"Electric blue",rgb:"#7DF9FF"},{name:"Electric purple",rgb:"#BF00FF"},{name:"Emerald",rgb:"#50C878"},{name:"English green",rgb:"#1B4D3E"},{name:"English lavender",rgb:"#B48395"},{name:"English red",rgb:"#AB4B52"},{name:"Fern green",rgb:"#4F7942"},{name:"Fire opal",rgb:"#E95C4B"},{name:"Firefly",rgb:"#0E2A30"},{name:"Flame",rgb:"#E25822"},{name:"Flax",rgb:"#EEDC82"},{name:"Forest green",rgb:"#014421"},{name:"French beige",rgb:"#A67B5B"},{name:"French blue",rgb:"#0072BB"},{name:"French lilac",rgb:"#86608E"},{name:"French sky blue",rgb:"#77B5FE"},{name:"Fuchsia purple",rgb:"#CC397B"},{name:"Fuchsia",rgb:"#FF00FF"},{name:"Gold",rgb:"#E6BE8A"},{name:"Golden brown",rgb:"#996515"},{name:"Golden yellow",rgb:"#FFDF00"},{name:"Goldenrod",rgb:"#DAA520"},{name:"Glacier blue",rgb:"#C8DDE8"},{name:"grey",rgb:"#808080"},{name:"Green-blue",rgb:"#2887C8"},{name:"Green-yellow",rgb:"#ADFF2F"},{name:"Green",rgb:"#00A000"},{name:"Harvest gold",rgb:"#DA9100"},{name:"Heliotrope grey",rgb:"#AA98A9"},{name:"Heliotrope",rgb:"#DF73FF"},{name:"Hot magenta",rgb:"#FF1DCE"},{name:"Hot pink",rgb:"#FF69B4"},{name:"Imperial red",rgb:"#ED2939"},{name:"Indigo dye",rgb:"#00416A"},{name:"Indigo",rgb:"#4B0082"},{name:"Iris",rgb:"#5A4FCF"},{name:"Jade",rgb:"#00A86B"},{name:"Jasper",rgb:"#113126"},{name:"Jet",rgb:"#343434"},{name:"Jungle green",rgb:"#29AB87"},{name:"Kelly green",rgb:"#4CBB17"},{name:"Key lime",rgb:"#E8F48C"},{name:"Khaki",rgb:"#C3B091"},{name:"Lapis lazuli",rgb:"#26619C"},{name:"Laurel green",rgb:"#A9BA9D"},{name:"Lavender grey",rgb:"#C4C3D0"},{name:"Lavender",rgb:"#B57EDC"},{name:"Licorice",rgb:"#1A1110"},{name:"Light blue",rgb:"#ADD8E6"},{name:"Light coral",rgb:"#F08080"},{name:"Light grey",rgb:"#D3D3D3"},{name:"Light green",rgb:"#90EE90"},{name:"Light periwinkle",rgb:"#C5CBE1"},{name:"Light pink",rgb:"#FFB6C1"},{name:"Light salmon",rgb:"#FFA07A"},{name:"Light sea green",rgb:"#20B2AA"},{name:"Light steel blue",rgb:"#B0C4DE"},{name:"Light yellow",rgb:"#FFFFE0"},{name:"Lilac",rgb:"#C8A2C8"},{name:"Lime",rgb:"#BFFF00"},{name:"Linen",rgb:"#FAF0E6"},{name:"Magenta",rgb:"#FF0090"},{name:"Mahogany",rgb:"#C04000"},{name:"Malachite",rgb:"#0BDA51"},{name:"Mango",rgb:"#FDBE02"},{name:"Marigold",rgb:"#EAA221"},{name:"Maroon",rgb:"#800000"},{name:"Mauve taupe",rgb:"#915F6D"},{name:"Mauve",rgb:"#B783A9"},{name:"Medium aquamarine",rgb:"#66DDAA"},{name:"Medium blue",rgb:"#0000CD"},{name:"Medium orchid",rgb:"#BA55D3"},{name:"Medium purple",rgb:"#9370DB"},{name:"Medium sea green",rgb:"#3CB371"},{name:"Medium slate blue",rgb:"#7B68EE"},{name:"Medium spring green",rgb:"#00FA9A"},{name:"Medium turquoise",rgb:"#48D1CC"},{name:"Middle blue green",rgb:"#8DD9CC"},{name:"Middle blue purple",rgb:"#8B72BE"},{name:"Middle blue",rgb:"#7ED4E6"},{name:"Middle green yellow",rgb:"#ACBF60"},{name:"Middle green",rgb:"#4D8C57"},{name:"Middle purple",rgb:"#D982B5"},{name:"Middle red purple",rgb:"#A55353"},{name:"Middle red",rgb:"#E58E73"},{name:"Midnight blue",rgb:"#003366"},{name:"Midnight green",rgb:"#004953"},{name:"Moss green",rgb:"#8A9A5B"},{name:"Mossy oak",rgb:"#887848"},{name:"Mulberry",rgb:"#C54B8C"},{name:"Mustard",rgb:"#FFDB58"},{name:"Myrtle green",rgb:"#317873"},{name:"Neon blue",rgb:"#4666FF"},{name:"Nickel",rgb:"#727472"},{name:"Ocean green",rgb:"#48BF91"},{name:"Ochre",rgb:"#CC7722"},{name:"Olive green",rgb:"#B5B35C"},{name:"Olive",rgb:"#808000"},{name:"Olivine",rgb:"#9AB973"},{name:"Orange-red",rgb:"#FF5349"},{name:"Orange",rgb:"#FF7F00"},{name:"Orange",rgb:"#FFAA1D"},{name:"Orchid pink",rgb:"#F2BDCD"},{name:"Orchid",rgb:"#DA70D6"},{name:"Pale cerulean",rgb:"#9BC4E2"},{name:"Pale pink",rgb:"#FADADD"},{name:"Pale purple",rgb:"#FAE6FA"},{name:"Pale silver",rgb:"#C9C0BB"},{name:"Pansy purple",rgb:"#78184A"},{name:"Pastel pink",rgb:"#DEA5A4"},{name:"Pastel yellow",rgb:"#FFFF99"},{name:"Peach",rgb:"#FFDAB9"},{name:"Pear",rgb:"#D1E231"},{name:"Periwinkle",rgb:"#CCCCFF"},{name:"Persimmon",rgb:"#EC5800"},{name:"Pesto",rgb:"#7C7631"},{name:"Pewter blue",rgb:"#8BA8B7"},{name:"Phthalo green",rgb:"#123524"},{name:"Pink",rgb:"#D74896"},{name:"Pistachio",rgb:"#93C572"},{name:"Powder Blue",rgb:"#BEEEEF"},{name:"Plum",rgb:"#8E4585"},{name:"Prune",rgb:"#701C1C"},{name:"Prussian Blue",rgb:"#04146D"},{name:"Puce",rgb:"#CC8899"},{name:"Pumpkin",rgb:"#FF7518"},{name:"Purple navy",rgb:"#4E5180"},{name:"Purple",rgb:"#A020F0"},{name:"Raisin black",rgb:"#242124"},{name:"Raw sienna",rgb:"#D68A59"},{name:"Raw umber",rgb:"#826644"},{name:"Rebecca purple",rgb:"#663399"},{name:"Red-purple",rgb:"#E40078"},{name:"Red-violet",rgb:"#C71585"},{name:"Red",rgb:"#ED1C24"},{name:"Rosy brown",rgb:"#BC8F8F"},{name:"Royal blue dark",rgb:"#002366"},{name:"Royal purple",rgb:"#7851A9"},{name:"Rufous",rgb:"#A81C07"},{name:"Saffron",rgb:"#F4C430"},{name:"Salmon pink",rgb:"#FF91A4"},{name:"Salmon",rgb:"#FA916D"},{name:"Sandy brown",rgb:"#F4A460"},{name:"Sap green",rgb:"#507D2A"},{name:"Scarlet",rgb:"#FF2400"},{name:"Sea green",rgb:"#2E8B57"},{name:"Sepia",rgb:"#985E2B"},{name:"Sepia black",rgb:"#2B0202"},{name:"Sienna",rgb:"#882D17"},{name:"Silver",rgb:"#A8A8A8"},{name:"Sky blue",rgb:"#87CEEB"},{name:"Sky magenta",rgb:"#CF71AF"},{name:"Slate blue",rgb:"#6A5ACD"},{name:"Slate grey",rgb:"#708090"},{name:"Steel pink",rgb:"#CC33CC"},{name:"Straw",rgb:"#E4D96F"},{name:"Tan",rgb:"#D2B48C"},{name:"Tangerine",rgb:"#F28500"},{name:"Taupe grey",rgb:"#8B8589"},{name:"Taupe",rgb:"#483C32"},{name:"Tea green",rgb:"#D0F0C0"},{name:"Tea rose",rgb:"#F4C2C2"},{name:"Teal blue",rgb:"#367588"},{name:"Teal",rgb:"#008080"},{name:"Terra cotta",rgb:"#E2725B"},{name:"Thistle",rgb:"#D8BFD8"},{name:"Turquoise blue",rgb:"#00FFEF"},{name:"Turquoise green",rgb:"#A0D6B4"},{name:"Turquoise",rgb:"#40E0D0"},{name:"Turtle green",rgb:"#2A380B"},{name:"Ultra pink",rgb:"#FF6FFF"},{name:"Ultra red",rgb:"#FC6C85"},{name:"Ultramarine",rgb:"#3F00FF"},{name:"Umber",rgb:"#635147"},{name:"Umbra",rgb:"#202000"},{name:"Vermilion",rgb:"#E34234"},{name:"Violet-blue",rgb:"#324AB2"},{name:"Violet-red",rgb:"#F75394"},{name:"Violet",rgb:"#8F00FF"},{name:"Viridian",rgb:"#40826D"},{name:"Vivid burgundy",rgb:"#9F1D35"},{name:"Vivid sky blue",rgb:"#00CCFF"},{name:"Vivid blue",rgb:"#0084FF"},{name:"Vivid indigo",rgb:"#3A00E7"},{name:"Wheat",rgb:"#F5DEB3"},{name:"White",rgb:"#FFFFFF"},{name:"Wisteria",rgb:"#C9A0DC"},{name:"Yellow-green",rgb:"#9ACD32"},{name:"Yellow-orange",rgb:"#FFAE42"},{name:"Yellow",rgb:"#FFEF00"}].map(oL)),nL=18;function oL(t){let e=gF(t.rgb);return y(y({},t),{name:Qo(t.name),lab:e,labhash:Rn(e,nL)})}var VV=Rn([100,100,100],nL),Wqe=VV*(1/4);var qqe=l(()=>[{index:0,name:"yellows",rgb:"#FFDF00"},{index:1,name:"greens",rgb:"#0BDA51"},{index:2,name:"blues",rgb:"#0000ff"},{index:3,name:"reds",rgb:"#ff0000"}].map(oL));var Wp=d("ImageHashComparison");function qp(t){return f(t,e=>Ie(e,2))}var zV=2.3,UV=20;function sL(t,e){return Wp.tap({msg:"weightedAvgCorr",result:nt(t,e)?1:vd(t.map((r,i)=>{let o=yF(e,r);if(o==null)return 0;let n=e.indexOf(o),s=Math.abs(i-n)*u.modeCorrIndexDiffWeight.valueOrDefault,a=Math.round(wp(r,o))*u.modeCorrCieDiffWeight.valueOrDefault,m=1-(a+s-zV)/UV;return te(0,1,m)}),[5,4,3,2,1]),meta:{a:t,b:e}})}function WV(t,e){return It([sL(t,e),sL(e,t)])}function aL(t,e){let r=t.map(o=>o[0]),i=e.map(o=>o[0]);return nt(r,i)?1:vd(r.map((o,n)=>{let s=Hu(i,c=>Math.abs(c-o));if(s==null)return 0;let a=Math.abs(n-s),m=Math.abs(o-i[s])*.66+a*2;return te(0,1,1-(m-3)/20)}),[4,3,2,1])}function qV(t,e){return It([aL(t,e),aL(e,t)])}function lL(t){return D(D(t?.modes).map(e=>bp(e,_s)))}var jV=/A{20}=?$/;function mL(t){return t?.match(jV)!=null}var HV=[0,90,180,270];function uL(t,e,r=Ns){let i=e?1:3,o=r*r*i,s=dr(ST(t).toString(2).slice(0,o),o,"0").split("").map(g=>parseInt(g,2));if(e)return s;let[a,m,c]=xe(3,g=>s.slice(g*r*r,(g+1)*r*r));return a.map((g,w)=>g*4+m[w]*2+c[w])}function GV(t,e,r,i=Ns){if(v(t)||v(e))return{hammRatio:0,aRotation:0};if(t===e)return{hammRatio:1,aRotation:0};let o=uL(t,r,i),n=uL(e,r,i).map(m=>dr(m.toString(2),r?1:3,"0")).join(""),s=HV.map(m=>({aRotation:m,hammRatio:Xw(iL(o,m).map(c=>dr(c.toString(2),r?1:3,"0")).join(""),n)})),a=bt(s,m=>m.hammRatio);return{aRotation:a.aRotation,hammRatio:qp(a.hammRatio)}}function cL(t,e){if(t==null||e==null)return;let r=mL(t.meanHash)||mL(e.meanHash);r&&Wp.debug("imageHashCompare(): greyscale comparison mode.");let i=lL(t),o=lL(e),n=GV(t.meanHash,e.meanHash,r),s=r?qV(i,o):WV(i,o),a=It([n.hammRatio,n.hammRatio,s]),m={imageCorr:qp(n.hammRatio),aRotation:n.aRotation,colorCorr:qp(s),meanCorr:qp(a),greyscale:r,a:t,b:e};return Wp.debug("imageHashCompare()",m),Jn(m)}function yb(t){return Ie(te(0,1,t),3)}function fL(t,e=1){if(t==null)return!1;let r=yb(e*(t.greyscale?u.minImageGreyscaleCoeffPct.valueOrDefault:u.minImageCoeffPct.valueOrDefault)/100),i=yb(e*u.minColorCoeffPct.valueOrDefault/100),o=yb(e*u.minMeanCoeffPct.valueOrDefault/100),n=Pr(t.imageCorr,r),s=Pr(t.colorCorr,i),a=!t.greyscale&&Pr(t.meanCorr,o);return Wp.tap({msg:"isSimilarComparison",result:n&&s||a,meta:y({goodImageCorr:n,minImageCorr:r,goodColorCorr:s,minColorCorr:i},t)})}var pL=["focalLength","aperture","shutterSpeed","iso"];var bb=l(()=>d("AssetFileComparator")),KV=Ae("sha","mimetype","capturedAtSrc","capturedAtLocal","capturedAtPrecisionMs","make","model","cameraId","imageId","lensId","geohash",...pL,"meanHash","mode0","mode1","mode2","mode3","mode4"),Bje=KV.values;function pu(t,e,r,i=(o,n)=>[o,n]){let o=t[r],n=e[r];if(v(o)||v(n)||nt(o,n))return;let[s,a]=i(o,n);return nt(s,a)||nt(o,a)||nt(s,n)?void 0:`Different ${String(r)}: ${o} != ${n}`}function dL(t){return q(t,e=>e.toLowerCase().trim())}function hL(t,e){return[dL(t),dL(e)]}function gL(t){return t!=null&&t%1e6==0}function jp(t,e){return wb(t,e)==null}function yL(t){return h(t).replace(/^[A-Z]\w+:/,"").trim()}function wb(t,e){if(t==null)return"af1 was undefined";if(e==null)return"af2 was undefined";if(Ol(t.sha,e.sha)){bb().debug("matching SHA",{af1:t,af2:e});return}let r=Math.max(...D([t.capturedAtPrecisionMs,e.capturedAtPrecisionMs,1e3])),i=bm(t.capturedAtLocal),o=bm(e.capturedAtLocal);if(i==null)return"af1 missing capturedAtLocal";if(o==null)return"af2 missing capturedAtLocal";if(!(t.capturedAtSrc==="stat"||e.capturedAtSrc==="stat")&&!Su(i,o,r))return`Different Captured-at times: ${[t,e].map(E=>`${E.capturedAtLocal}${"\xB1"+r+"ms"}`).join(" != ")}`;let s=V(_([t.make,e.make])).map(w=>w.toLowerCase());function a(w,E){let[R,oe]=[yL(w),yL(E)];if(R.endsWith(oe)||oe.endsWith(R)){let z=R.length-oe.length,we=(z>0?R:oe).slice(0,Math.abs(z)).trim().toLowerCase();if(s.includes(we)||Ht(u.lensMakes.values,we))return bb().debug("stripTagSources: one side didn't have a Make, but they match otherwise.",{a:w,b:E,prefix:we}),z>0?[oe,oe]:[R,R]}return[R,oe]}let m=Qs([()=>pu(t,e,"make",hL),()=>pu(t,e,"model",hL),()=>pu(t,e,"cameraId",a),()=>pu(t,e,"imageId",a),()=>pu(t,e,"lensId",a),()=>r0(t,e)]);if(m!=null)return m;if(!u.strictDeduping.valueOrDefault){let w=oD(t.geohash,e.geohash),E=fo(w,u.gpsErrorMeters.valueOrDefault),R=t.capturedAtLocal%100,oe=e.capturedAtLocal%100,z=R===oe&&R>0,we=[Ol(t.cameraId,e.cameraId),Ol(t.imageId,e.imageId),Ol(t.lensId,e.lensId),E,z];if(fr(we,K=>K)>=2&&r<=S)return}let c=cL(t,e),p=gL(t.capturedAtLocal)||gL(e.capturedAtLocal)||!t.capturedAtSrc.includes("tags")||!e.capturedAtSrc.includes("tags"),g=p?u.fuzzyDateImageCoeffWeight.valueOrDefault:1;if(bb().debug("Comparing image hashes",{fuzzy:p,corrWeight:g,c,af1:t,af2:e}),!fL(c,g))return"low image correlation"+(p?" (fuzzy dates require higher correlation)":"")}var xb=class{constructor(e){this.file=e;this.newAssetFile=Gl("AssetFileFinder.newAssetFile",()=>at(new fe().updateFromFile(this.file)).getOrElse(()=>{throw new Error("Cannot update from file "+this.file)}));this.tags=Gl("AssetFileFinder.tags",()=>at(yi(this.file)).getOrElse(()=>{throw new Error(this.file+" doesn't have metadata")}));this.capturedAt=l(()=>this.tags().then(e=>e.capturedAt));this.imageHash=l(()=>u.useImageHashes.valueOrDefault||u.strictDeduping.valueOrDefault?$m(this.file):void 0);this.capturedAtLocal=l(async()=>{let e=await this.capturedAt();return this.logger.tap({msg:"capturedAtLocal",result:e?.toLocal(),meta:{capturedAt:e}})});this.mapSibling=e=>this.newAssetFileForAsset(b(e,r=>r.getAsset()));this.apply_=l(async()=>{if(v(await this.file.uri()))throw new Error("Cannot import, file URI is blank for "+this.file);if(await this.tags()==null)throw new Error("Cannot import, tags are missing");if(await this.capturedAt()==null)throw new Error("Cannot import, capturedAt is null");{let o=await this.byExistingAsset_();if(o!=null)return this.logger.info("Found existing asset for file"),o}this.logger.info("No existing asset yet. Fetching advisory locks.");let r=await this.newAssetFile(),i=wl({file:this.file,assetFile:r});return Rs(i,async()=>{let o=await this.byExistingAsset_();if(o!=null)return o;let n=new Se;if(n.capturedAtLocal=r.capturedAtLocal,await n.addAssetFile(r),await n.upsert()==null)throw new Error("Failed to insert new Asset for "+this.file);if(r.assetId=n.id,await r.upsert()==null)throw new Error("Failed to insert new AssetFile for "+this.file);return r})});this.logger=d("AssetFileFinder("+e.baseWithGrandparent+")")}async newAssetFileForAsset(e){return b(e,async r=>r.addAssetFile(await this.newAssetFile()))}async byExistingAsset_(){let e=[{name:"byUri",f:()=>this.byUri()},{name:"byEqlUri",f:()=>this.byEqlUri()},{name:"bySha",f:()=>this.newAssetFileForAsset(this.assetBySha())},{name:"validFile",f:()=>Nm(this.file)},{name:"byCapturedAtOrImageHash",f:()=>this.newAssetFileForAsset(this.assetByCapturedAtOrImageHash())}];for(let{name:r,f:i}of e)try{let o=await i();if(o==null)this.logger.debug("apply(): "+r+" is null");else return this.logger.info("apply(): "+r,{assetFileId:o.id,assetId:o.assetId}),o}catch(o){throw this.logger.debug("apply(): "+r+" rejected: "+o),o}}byUri(){return b(this.file.uri(),e=>fe.ops().findOneBy({uri:e}))}async byEqlUri(){return Qe("AssetFileFinder.byEqlUri",()=>b(this.file.uri(),e=>b(this.file.sha(),r=>b(fe.ops().findBy({sha:r}),async i=>{for(let o of i)if(await gf(o.uri,e))return o}))))}assetBySha(){return b(this.file.sha(),e=>Se.findFirstByFile(r=>r.where("AssetFile.sha",e)))}async assetByCapturedAtOrImageHash(){let e=await this.capturedAtLocal();if(e==null)return;let r=()=>fe.query().limit(256).orderByRaw(`abs(capturedAtLocal - ${e})`);return Qe("AssetFileFinder.assetByCapturedAtOrImageHash",()=>Vx([()=>fe.ops().all(r().whereBetween("capturedAtLocal",[e-200,e+200])),()=>b(this.imageHash(),i=>fe.ops().all(r().where("capturedAtPrecisionMs",">",0).andWhereBetween("capturedAtLocal",[Jh(e,-ot),Jh(e,ot)]).andWhere(o=>o.whereIn("mode0",D(i.modes.slice(0,4)))).andWhere(o=>o.whereIn("mode1",D(i.modes.slice(0,4))))))],i=>this.firstSimilar(i)))}async firstSimilar(e){let r=await this.newAssetFile(),i=await this.capturedAtLocal();if(r==null)throw new Error("Failed to update from "+this.file);let o=X(e,n=>[ee(i,s=>Math.abs(n.capturedAtLocal-s),-n.capturedAtLocal),n.id]);for(let n of o)if(n!=null){let s=wb(n,r);if(s==null)return this.logger.info("Found sibling AssetFile",n),Se.ops().findById(n.assetId);this.logger.debug("Contemporary assetFile not similar: "+s,n)}}};var bL=P(require("xml2js"));var Hp=l(()=>d("KeywordTagger")),Tb=l(()=>new RegExp(`\\s*[${ht(u.keywordDelimiters.valueOrDefault)}]\\s*`));u.keywordDelimiters.addListener(()=>Tb.clear());function Gp(t){return t==null||t instanceof Ya?[]:_(Array.isArray(t)?Y(t.map(Gp)):t.split(Tb()))}var wL=l(()=>q(u.keywordPathSeparators.valueOrDefault,t=>new RegExp(`\\s*[${ht(t)}]\\s*`)));u.keywordPathSeparators.addListener(()=>wL.clear());function xL(t){return t==null?[]:L(t.Category)?[[t._]]:Y(t.Category.map(xL).map(e=>e.map(r=>D([t._,...r]))))}var JV=/^\(?none\)?$/i;async function $V(t){if(!(v(t)||JV.exec(t)!=null))try{let e=await(0,bL.parseStringPromise)(t);return Y(F(e?.Categories?.Category).map(xL))}catch(e){Hp().warn("parseCategories() failed:",e);return}}async function QV(t){let e=[];return t!=null&&(await b($V(t.Categories),r=>e.push(...r)),Go([t.CatalogSets,t.HierarchicalSubject,t.Keywords,t.LastKeywordXMP,t.CatalogSets,t.Subject,t.TagsList,t.XPKeywords]).forEach(r=>e.push(...Array.isArray(r)?r:Gp(r)))),Hp().tap({msg:"rawTagKeywords()",result:V(e),meta:{t:t==null?void 0:rt(t,"Categories","CatalogSets","HierarchicalSubject","Keywords","LastKeywordXMP","CatalogSets","Subject","TagsList","XPKeywords")}})}var TL=l(()=>new RegExp(`[ /${ht(u.keywordDelimiters.valueOrDefault)}]`));u.keywordDelimiters.addListener(()=>TL.clear());function vL(t){return Hp().tap({msg:"extractDashDashTags()",result:ee(h(t).split("--")[1],e=>_(e.split(TL())),()=>[]),meta:{s:t}})}function YV(t){return[...vL(t.parent().posixPath),...vL(t.name)]}var XV=/\w{2,7}:\/\/\S+/gi;function ML(t){let e=[],r=[],i=[];for(let g of t)if(Array.isArray(g))i.push(g);else{let w=g.replace(XV,E=>(r.push(E),""));i.push(...w.split(Tb()))}let n=ee(wL(),g=>i.map(w=>ct(w)?w.split(g):w),i).map(g=>Array.isArray(g)&&g.length===1?g[0]:g),[s,a]=wo(n,Array.isArray),m=s.map(g=>_(g.map(w=>w.trim()))).filter(k),c=jw(Y(m));for(let g of m)e.push(g);let p=[...a,...r].map(g=>g.trim()).filter(g=>M(g)&&!Ht(c,g));for(let g of p)e.push([ce.Keywords,g]);return V(e)}function ZV(t){return Lu(X(t,e=>{let r=e.join("/");return[r.normalize().toLowerCase(),-1*OT(r)]}),(e,r)=>Ve(O(e),O(r)))}function ez(t){let[e,r]=wo(ML(t),s=>vp(s[0])),i=V(Y(e.map(s=>[s.slice(1).join(", "),s.length>2?s[2]+" "+s[1]:void 0])));et(r,s=>!Ht(i,s.join(" ")));let o=ZV(ML(r)),n=Y(i.map(Oy));return Hp().tap({msg:"processKeywords()",level:"info",result:X([...o,...n],s=>O(s)),meta:{tagKeywordsFromMetadata:u.tagKeywordsFromMetadata.valueOrDefault,whoNames:i,whoResults:n}})}async function SL(t){let e=u.tagKeywordsFromPath.valueOrDefault?Y(t.map(YV)):[],r=u.tagKeywordsFromMetadata.valueOrDefault?Y(await sr(t,i=>b(_e(i),QV))):[];return ez([...e,...r])}var tz=l(()=>d("TypeTagger"));async function PL(t){let e=Er(t.map(i=>i.parent()),i=>i.nativePath),r=Y(e.map(i=>u.tagAlbumFilenames.values.map(o=>i.join(o))));return sr(r,rz)}async function rz(t){return iz(await _e(t,!1))}function iz(t){if(t==null)return;let e=To(t,u.tagAlbumTitle.valueOrDefault),r=To(t,u.tagAlbumDescription.valueOrDefault),i=v(e)?[]:u.tagAlbumTitleHierarchies.valueOrDefault?Gp(e):[e],o=L(i)?"(blank title)":Gw(u.tagAlbumsExcluded.values,[h(e),h(r)].join(" ")),n=o==null?[ce.Albums,...i]:void 0;if(n!=null){let s={name:n[n.length-1],description:r};Fn(pF(To(t,u.tagAlbumDate.valueOrDefault)),a=>{s.releasedAt=a.getTime()}),n[n.length-1]=s}return tz().tap({msg:"albumFromFile()",result:n,meta:{title:e,desc:r,shouldExclude:o}})}function oz(t){return f(t,e=>q(e.Make,r=>q(e.Model,i=>[ce.Camera,r,i])))}function EL(t){return b(yi(t),oz)}function nz(t){return f(t,e=>q(e.lensMake,r=>q(_(u.tagFullLensModel.valueOrDefault?[e.lensModel,e.lensInfo]:[e.lensInfo,e.lensModel])[0],i=>[ce.Lens,r,i])))}function AL(t){return b(yi(t),nz)}var sz=l(()=>d("TypeTagger"));async function DL(t){let e=V(await Promise.all(t.map(Io)));return D(e.map(az))}var lz=new Map(["M2TS","JPEG","QuickTime"].map(t=>[t.toLowerCase(),t]));function az(t){let[e,r]=t.split("/");if(!(v(e)||v(r)))return sz().tap({msg:"mimetypeToTag("+t+")",result:f(mz(r,t),i=>_([ce.Type,Qo(e),...i]))})}var uz=l(()=>new Map([["image/x-adobe-dng",["Raw","DNG"]],["image/x-fuji-raf",["Raw","Fujifilm"]],["video/m2ts",["MPEG-2"]],["video/mp4",["MPEG-4"]],["video/quicktime",["QuickTime"]],["video/x-msvideo",["AVI"]]]));function mz(t,e){return Qs([()=>uz().get(e.trim().toLowerCase()),()=>f(t.match(/^x-(\w{4,})-\w{3}/),r=>["Raw",Qo(r[1])]),()=>[cz(t.replace(/^(x-)|(vnd\.)|(prs\.)/i,"").replace(/-/g," "))]])}function cz(t){return t.match(/[a-z0-9]{3,4}/i)!=null?t.toUpperCase():T(lz.get(t.trim().toLowerCase()),()=>Qo(t))}var Ri=d("AssetTagger");async function FL(t,e){if(t.clear(),await t.getShown()==null)return Ri.throw("tagAndUpsertAsset(): no shown asset file.",{asset:t});let i=await t.getExistingAssetFiles(),o=await sr(i,c=>c.posixFile()),n=(await t.getFiles()).map(c=>c.uri),s=await t.getTagPaths(),a=await t.getCapturedAts(),m=await fz(e,o,s,a,n);return Ri.info("tagAndUpsertAsset",m),f(m,async c=>(await Se.addTags(t.id,c.add),await Se.removeTags(t.id,c.remove),t.tags=void 0,c))}async function fz(t,e,r,i,o){let n=[];e.some(m=>m.nativePath===t.nativePath)||e.unshift(t),u.tagCamera.valueOrDefault&&await b(EL(t),m=>{Ri.debug("Camera tag for "+t+":",m),n.push(m)}),u.tagLens.valueOrDefault&&await b(AL(t),m=>{Ri.debug("Lens tag for "+t+":",m),n.push(m)}),await b(JF(t,i),m=>{Ri.debug("Date tag for "+t+":",m),n.push(m)}),await b(SL(e),m=>{Ri.debug("Keyword tags for "+t+":",m),n.push(...m)}),u.tagFileType.valueOrDefault&&await b(DL(e),m=>{Ri.debug("MIME type tags for "+t+":",m),n.push(...m)}),await hi()||await b(SF(e),m=>{Ri.debug("whoTagFiles for "+t+":",m),n.push(...m)}),await b(a0(o),m=>{Ri.debug("file paths for uris",{uris:o,arr:m}),n.push(...m)}),u.tagAlbums.valueOrDefault&&await b(PL(e),m=>{Ri.debug("Album tags for "+t+":",m),n.push(...m)});let s=Er(n,Tr),a=await IF(r,s);return Ri.info("tagAsset("+t+")",{priorTagPaths:r,after:s,result:a}),a}async function js(t){return Rs(wl({assetId:t}),()=>pz(t))}async function pz(t){let e=d(`UpdateAsset(${t})`),r=Br.instanceRequired();e.info("starting");let i=await Se.ops().findById(t);if(i==null){e.warn("no such asset");return}try{let o=await i.getFiles();if(L(o)){await Se.delete(t);return}let n=await i.getShown(),s=await r.previews().build_({assetId:t,assetFiles:o,force:u.forceSync.valueOrDefault});e.info("previews built",{assetPreviewInfo:s});let a=o.find(m=>m.uri===s.uri);return a==null?e.throw("invalid AssetPreviewInfo (failed to find best assetFile)",{assetPreviewInfo:s,assetFileURIs:o.map(m=>m.uri)}):((n?.id!==a.id||u.forceSync.valueOrDefault)&&await b(a.posixFile(),m=>gA(m,r.previews().ap(t).mp4())),await fe.setShown(t,s.assetFileId),await FL(i,ne.for(s.path)),i.capturedAtLocal=a.capturedAtLocal,await i.markShownAndUpsert(),{asset:i,path:await a.nativePath()})}catch(o){e.warn("Failed to update previews. Un-showing asset "+t,o),await i.markUnshownAndUpsert();return}}var vb=class{constructor(e,r){this.file=e;this.repo=r;this.srcAssetFile=()=>this.assetFileFinder.apply_();this.assetFile=l(async()=>{let e=await this.srcAssetFile();if(this.logger.debug("srcAssetFile",e),e==null)return;let r=await this.repoAssetFile();if(this.logger.debug("repoAssetFile",{repoAssetFile:r}),r==null)return this.logger.throw("got null assetFile from .assetRepoFile()",{srcAssetFile:e,repoAssetFile:r});let i=await e.getAsset();return i==null?this.logger.throw("assetFile.getAsset() was null",{repoAssetFile:r}):i.id==null?this.logger.throw("repoAssetFile asset has null id",{asset:i}):(await e.upsertIfNeeded(),r.uri!==e.uri&&(await i.addAssetFile(r),await r.updateFromShaSibling(e),await r.maybeUpdateStats(),await r.upsert()),r)});this.repoAssetFile=l(async()=>{let e=d(this.toString()+".repoAssetFile()"),r=await this.srcAssetFile();if(r==null||this.repo==null||await hi())return e.debug("no repo or null src"),r;let i=await this.repo.importFile(this.file);if(e.info("repo.importFile() returned "+i),i==null||this.file.eql(i))return e.debug("this.repo isn't copying assets, returning srcAssetFile",r),r;let o=await r.getAsset();if(o==null)return e.throw("INTERNAL ERROR, asset is null");let n=await i.uri();if(n==null)return e.throw("INTERNAL ERROR, uri is null");let s=await o.findAssetFileByUri(n);if(e.debug("by uri",{prior:s}),s!=null)return s;e.debug("Creating new assetFile");let a=new fe;return await a.setFile(i),o.addAssetFile(a)});this.logger=d(this.toString()),this.assetFileFinder=new xb(e)}toString(){return"AssetFileImporter("+this.file.nativePath+")"}newAssetFile(){return this.assetFileFinder.newAssetFile()}async apply(){return this.result!=null?this.result.promise:(this.result=new Kt("AssetFileImporter("+this.file+").apply"),this.result.observe(this._apply()).promise)}async _apply(){let e=await this.file.uri();if(e==null)return this.logger.throw("Cannot make URI"+yr+kt);let r=[];if(I(await this.file.isDeleted())?r.push("File was deleted"):await b(Re.andExplain(this.file,Jy()),m=>r.push(...m.rejected)),k(r)){let m=await fe.ops().findOneBy({uri:e});return m!=null&&(this.logger.info("Deleting prior AssetFile:",r),await m.delete(),I(m.shown)&&await js(m.assetId)),this.logger.throw("rejected: "+r.join(","),{ignorable:!0,retriable:!1})}if(await this.file.size()==null)return this.logger.throw("unreadable file",{ignorable:!0,retriable:!1});let o=await kf(this.file);if(!C(o))return this.logger.throw("syncFileTimeoutForFile() returned undefined");f(this.result,m=>m.setTimeout(o)),this.logger.info("Setting timeout to "+tu(o));let n=await this.assetFile();if(n==null)return this.logger.throw("_apply(): unexpected null assetFile");let s=await n.getAsset();if(s==null)return this.logger.throw("_apply(): unexpected null asset");let a=s.id;return a==null||n.assetId!==s.id?this.logger.throw("_apply(): unexpected assetId",{asset_id:s.id,af_assetId:n.assetId,af_id:n.id}):(await js(a),n.id==null?this.logger.throw("_apply(): unexpected missing asset file id",{file:this.file.nativePath,asset:s,af:n}):n)}};async function LL(t,e){return b(Rs(wl({assetId:t}),()=>dz(t)),async r=>((!e||u.forceSync.valueOrDefault)&&await js(t),r))}async function dz(t){let e=d(`UpdateAsset(${t})`),r=[];e.info("starting");let i=await Se.ops().findById(t);if(i==null){e.info("no such asset");return}let o=await i.getFiles(),n=[];if(await Dr({name:"updateAsset().retain",laters:o.map(z=>async()=>{await z.isFileDeleted()||await z.isFiltered()?(e.info(`AssetFile:${z.id} has been deleted or filtered: ${await z.nativePath()}`),n.push(z.id)):e.info(`AssetFile:${z.id} is not deleted or filtered: ${await z.nativePath()}`)})}),await ge(n,z=>fe.ops().delete(z)),et(o,z=>!n.includes(z.id)),L(o)){e.info("Empty asset. Deleting.",{asset:i,afs:o}),await Se.delete(t);return}if(await fd(o,z=>z.notExists())){e.info("No existing files. Skipping for now.");return}await Dr({name:"AssetFile.updateIfNeeded",laters:o.map(z=>()=>z.upsertIfNeeded())}),await hz(o);let s=await IL(o);if(s==null){e.info("No existing files. Skipping for now.");return}if(!s.isVersionUpToDate()){e.info("Best file needs update, and we already tried to update all files. Skipping this asset now.",{bestAF:s});return}let[a,m]=await Ud(o,async z=>jp(z,s)||await z.notExists());if(k(m)){let[z,we]=await Ud(m,K=>be(K.posixFile(),Ze=>eA(Ze),()=>!1));await ge(we,K=>(e.info("Asset files are invalid. Deleting.",K),fe.ops().delete(K.map(Ze=>Ze.id))));let Q=await Vw(z,jp);for(let K of Q){let Ze=await Se.ops().insertOne({capturedAtLocal:K[0].capturedAtLocal,version:0});r.push(Ze.id),await fe.dbl.runf(_t=>_t.update({assetId:Ze.id,shown:0}).whereIn("id",K.map(rr=>rr.id))),e.info("Pushed rejected asset files into new asset",{rejectAssetId:Ze.id,rejectCluster:K.map(_t=>({id:_t.id,uri:_t.uri}))})}}function c(z){return V(a.map(we=>we[z]))}let p=Qu(a.map(z=>z.capturedAtLocal-(200+T(z.capturedAtPrecisionMs,0)/10))),g=sa(a.map(z=>z.capturedAtLocal+(200+T(z.capturedAtPrecisionMs,0)/10))),w=await fe.ops().all(fe.query().limit(256).orderByRaw(`abs(AssetFile.capturedAtLocal - ${s.capturedAtLocal})`).select("AssetFile.*").join("Asset","Asset.id","AssetFile.assetId").distinct().where("AssetFile.assetId","!=",t).andWhere("Asset.version","!=",xn).andWhere(z=>z.whereIn("AssetFile.sha",c("sha")).orWhere(we=>we.whereBetween("AssetFile.capturedAtLocal",[p,g]))));e.info("asset file candidates for adoption: ",w),await Dr({name:"AssetFile.updateIfNeeded",laters:w.map(z=>()=>z.upsertIfNeeded())});let E=w.filter(z=>jp(z,s));e.info("fetched expansion",{retainAFs:a.map(z=>z.id),rejectAFs:m.map(z=>z.id),externalAssetFiles:w.length,similarAssetFiles:E.length}),r.push(...E.map(z=>z.assetId));let R=[...a,...E];for(let z of R)z.assetId=i.id,z.shown=!1;let oe=await IL(R);return oe==null?e.throw("invalid AssetPreviewInfo (failed to find best assetFile)",{assetFileURIs:R.map(z=>z.uri)}):(oe.shown=!0,e.info("assetFiles",R.map(z=>rt(z,"id","uri","shown"))),await fe.ops().upsert(R),qu(r),e.tap({msg:"updateAsset() result",level:"info",result:{asset:i,assetIdsToUpdate:r,path:await oe.nativePath()}}))}async function hz(t){let[e,r]=wo(t,i=>i.isVersionUpToDate());return ye(r,i=>f(e.find(o=>o.sha===i.sha),o=>i.updateFromShaSibling(o)))}async function IL(t){let e=d(`UpdateAsset.bestAssetFile(${t.map(i=>i.id)})`);for(let i of t)if(I(i.shown)&&await i.exists())return i;let r=await sl(t);return e.tap({msg:"best result",meta:{uris:F(r).map(i=>i.uri)},result:f(r,i=>i.pop())})}async function kL(t){let e=d(`updateAssetFile(${t})`),r=await fe.ops().findById(t);if(r==null)return{error:"not found"};let i=r.assetId,o=await r.posixFile(),n={assetFileId:t,nativePath:o?.nativePath};if(i==null)return y(y({},n),{error:"missing assetId"});if(await r.isFileDeleted())return await fe.ops().delete([r.id]),y(y({},n),{error:"file deleted",deleted:!0});if(o==null||await o.notExists())return y(y({},n),{error:"file missing"});if(await r.isFiltered())return await fe.ops().delete([r.id]),await r.siblingCount()===0?await Se.delete(i):u.excludeNoMediaAssetsOnRebuild.valueOrDefault&&await r.hasNoMedia()&&await Se.exclude(i),y(y({},n),{error:"file filtered",deleted:!0});if(await r.matchesFile())return e.info("file already matches model: "+o),y(y({},n),{noop:!0});let s=await o.uri();if(s!=null&&s!==r.uri){let a=await gz(r,s);if(a!=null)return y(y({},n),a)}return y(y({},n),await OL(r))}async function gz(t,e){let r=d(`handleAssetFileUriChange(${t.id})`),i=V([...yf(t.uri),...yf(e)]);r.warn("URI is changing. Avoiding duplicate keys.",{priorUri:t.uri,variants:i});let o=await fe.ops().allf(n=>n.whereIn("uri",i).andWhereNot({id:t.id}));if(k(o)){r.warn("Found other AssetFiles with equivalent URIs.",{afIds:o.map(m=>m.id)});let n=[t,...o],s=sl(n)?.reverse();if(L(s))return r.warn("sortAssetFiles returned undefined",{arr:n.map(m=>rt(m,"id","uri")),variants:i}),{error:"sortAssetFiles returned undefined"};let a=n.map(m=>m.id);for(let m of s)if(await m.exists()){await fe.dbl.runf(p=>p.whereIn("id",a.filter(g=>g!==m.id)).delete());let c=OL(m);return await Se.dbl.runf(p=>p.update({version:0,updatedAt:Date.now()}).whereIn("id",V(n.map(g=>g.assetId)))),c}}r.info("no-op, no duplicate URIs.")}async function OL(t){return await t.upsertIfNeeded()!=null&&await Se.touch([t.assetId]),{assetFileId:t.id}}var Mb=class extends $e{constructor(e){super("SyncFileService",()=>this.onEnd(),me.first);this.argv=e;this.isUnhealthy=l(async()=>{try{let e=await zs(),r=sg(e);return this.logger.tap({level:r?"error":"info",msg:"isUnhealthy()",result:r,meta:e})}catch(e){return await re("isUnhealthy() failed"+de,e),!0}},S);this.service=new gb({name:"sync-file",stdinReceiver:this.stdinReceiver.bind(this)}),Sx(()=>this.service.exit({reason:"rpcServerChange",status:0,waitForJobs:!1})),GT(r=>Cr(r,!1)),this.setup()}async onEnd(){ge(this.service.jobs.pendingNames(),e=>this.logger.info("Waiting for "+e)),await this.service.jobs.awaitAll()}async setup(){await this.service.ready,u.copyAssetsToLibrary.addListener(()=>{this.logger.warn("copyAssetsToLibrary changed to "+u.copyAssetsToLibrary.valueOrDefault)}),k(this.argv)&&await this.importFiles(this.argv).then(()=>this.service.exit({reason:"Processed files from argv",status:0,waitForJobs:!0}))}async stdinReceiver(e){this.logger.info("stdinReceiver",{stdin:e});for(let r of _(ui(e))){if(v(r))continue;let i=Kc(r);if(i==null){let o=Ku(r.trim(),"'","'");this.serially({name:"importFile",task:()=>this.importFile(ne.for(o)),taskId:{path:r}})}else M(i.file)?this.serially({name:"importFile",task:()=>this.importFile(ne.for(i.file)),force:i.force,taskId:{path:i.file}}):C(i.updateAssetFileId)?this.serially({name:"updateAssetFile",task:()=>this.updateAssetFile(i.updateAssetFileId),force:i.force,taskId:{updateAssetFileId:i.updateAssetFileId}}):C(i.updateAssetId)?this.serially(this.logger.tap({msg:"stdin(): updateAsset",level:"info",result:{name:"updateAsset",task:()=>this.updateAsset(i.updateAssetId,I(i.skipPreviews)),force:T(i.force,!0),taskId:{updateAssetId:i.updateAssetId,skipPreviews:i.skipPreviews}},meta:{cmd:i}})):C(i.updateAssetPreviewId)?this.serially({name:"updateAssetPreviews",task:()=>this.updateAssetPreviews(i.updateAssetPreviewId),force:i.force,taskId:{updateAssetPreviewId:i.updateAssetPreviewId}}):Cr({error:"Cannot parse",input:r})}}async serially({name:e,taskId:r,task:i,force:o}){return this.service.jobs.serial(e,async()=>{let n=Ut(100,500);if(await Je(()=>!Ii(),{timeoutMs:void 0,timeBetweenMs:n}),$()){Cr(y(y({},r),{error:"ending"}),!1);return}if(await this.isUnhealthy()){Cr(y(y({},r),{error:"unhealthy",problems:zS(await zs())}),!1);return}try{await this.maybeForce(o,i)}catch(s){Cr(y(y({},r),{error:ae(s)}),!1)}})}async maybeForce(e,r){let i=u.forceSync.value;I(e)&&(u.forceSync.tmpValue=!0);try{return await r()}finally{I(e)&&(u.forceSync.tmpValue=i)}}async updateAssetFile(e){try{let r=await kL(e);qs(y({id:e},r))}catch(r){qs({id:e,error:Ot(r)})}}async updateAsset(e,r){try{let i=await LL(e,r);qs({id:e,skipped:i==null,assetIdsToUpdate:i?.assetIdsToUpdate,nativePath:i?.path})}catch(i){qs({id:e,error:Ot(i)})}}async updateAssetPreviews(e){try{let r=await js(e);qs({id:e,skipped:r==null,nativePath:r?.path})}catch(r){qs({id:e,error:Ot(r)})}}async importFiles(e){for(let r of e)await this.importFile(ne.for(r))}async importFile(e){e.clear();let r=await this.importFileToResult(e);return Cr(y(y({},r),{memMb:vf(),rssMb:Mf()})),r}async importFileToResult(e){let r=Date.now(),i=await this._importFileToResult(e);return this.logger.info("importFile() finished in "+(Date.now()-r)+"ms",{result:i}),i}async _importFileToResult(e){try{if(await this.isUnhealthy())return{path:e.nativePath,error:"unhealthy",healthChecks:await zs()};let r=Br.instanceRequired(),o=await new vb(e,r.assetFileRepository()).apply();if(o==null)throw new Error("empty result");return{path:o.uri,assetFileId:o.id,assetId:o.assetId}}catch(r){return re("Failed to import "+e+yr,r),{path:e.nativePath,error:ae(r)}}}};try{pI().install()}catch{}async function Xz(){let t=await new Rh("sync-file","[files...]","If filenames are provided, they should be fully-qualified, and will be processed serially.\n\nUse `photostructure sync` for directory scanning and parallel file processing.").add(BS,CS,xM).parse();new Mb(t.args)}Xz();
//# sourceMappingURL=sync-file.js.map
