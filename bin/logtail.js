#!/usr/bin/env node
/* Copyright Â© 2021, PhotoStructure Inc. */
/* By using this software, you accept the terms in <https://photostructure.com/eula>. */
/* If you don't accept them, do not use this software. */
var $d=Object.create,Os=Object.defineProperty,eh=Object.getPrototypeOf,th=Object.prototype.hasOwnProperty,rh=Object.getOwnPropertyNames,nh=Object.getOwnPropertyDescriptor;var d=Object.assign,ih=t=>Os(t,"__esModule",{value:!0});var He=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports);var oh=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of rh(e))!th.call(t,n)&&n!=="default"&&Os(t,n,{get:()=>e[n],enumerable:!(r=nh(e,n))||r.enumerable});return t},g=t=>oh(ih(Os(t!=null?$d(eh(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var vd=He(kl=>{var Td="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");kl.encode=function(t){if(0<=t&&t<Td.length)return Td[t];throw new TypeError("Must be between 0 and 63: "+t)};kl.decode=function(t){var e=65,r=90,n=97,i=122,o=48,s=57,a=43,m=47,c=26,h=52;return e<=t&&t<=r?t-e:n<=t&&t<=i?t-n+c:o<=t&&t<=s?t-o+h:t==a?62:t==m?63:-1}});var Vl=He(Fl=>{var xd=vd(),Nl=5,wd=1<<Nl,Sd=wd-1,Md=wd;function qb(t){return t<0?(-t<<1)+1:(t<<1)+0}function Kb(t){var e=(t&1)==1,r=t>>1;return e?-r:r}Fl.encode=function(e){var r="",n,i=qb(e);do n=i&Sd,i>>>=Nl,i>0&&(n|=Md),r+=xd.encode(n);while(i>0);return r};Fl.decode=function(e,r,n){var i=e.length,o=0,s=0,a,m;do{if(r>=i)throw new Error("Expected more digits in base 64 VLQ value.");if(m=xd.decode(e.charCodeAt(r++)),m===-1)throw new Error("Invalid base64 digit: "+e.charAt(r-1));a=!!(m&Md),m&=Sd,o=o+(m<<s),s+=Nl}while(a);n.value=Kb(o),n.rest=r}});var Kn=He(ke=>{function Cb(t,e,r){if(e in t)return t[e];if(arguments.length===3)return r;throw new Error('"'+e+'" is a required argument.')}ke.getArg=Cb;var Pd=/^(?:([\w+\-.]+):)?\/\/(?:(\w+:\w+)@)?([\w.-]*)(?::(\d+))?(.*)$/,Hb=/^data:.+\,.+$/;function Vi(t){var e=t.match(Pd);return e?{scheme:e[1],auth:e[2],host:e[3],port:e[4],path:e[5]}:null}ke.urlParse=Vi;function Gn(t){var e="";return t.scheme&&(e+=t.scheme+":"),e+="//",t.auth&&(e+=t.auth+"@"),t.host&&(e+=t.host),t.port&&(e+=":"+t.port),t.path&&(e+=t.path),e}ke.urlGenerate=Gn;function Bl(t){var e=t,r=Vi(t);if(r){if(!r.path)return t;e=r.path}for(var n=ke.isAbsolute(e),i=e.split(/\/+/),o,s=0,a=i.length-1;a>=0;a--)o=i[a],o==="."?i.splice(a,1):o===".."?s++:s>0&&(o===""?(i.splice(a+1,s),s=0):(i.splice(a,2),s--));return e=i.join("/"),e===""&&(e=n?"/":"."),r?(r.path=e,Gn(r)):e}ke.normalize=Bl;function Ed(t,e){t===""&&(t="."),e===""&&(e=".");var r=Vi(e),n=Vi(t);if(n&&(t=n.path||"/"),r&&!r.scheme)return n&&(r.scheme=n.scheme),Gn(r);if(r||e.match(Hb))return e;if(n&&!n.host&&!n.path)return n.host=e,Gn(n);var i=e.charAt(0)==="/"?e:Bl(t.replace(/\/+$/,"")+"/"+e);return n?(n.path=i,Gn(n)):i}ke.join=Ed;ke.isAbsolute=function(t){return t.charAt(0)==="/"||Pd.test(t)};function Jb(t,e){t===""&&(t="."),t=t.replace(/\/$/,"");for(var r=0;e.indexOf(t+"/")!==0;){var n=t.lastIndexOf("/");if(n<0||(t=t.slice(0,n),t.match(/^([^\/]+:\/)?\/*$/)))return e;++r}return Array(r+1).join("../")+e.substr(t.length+1)}ke.relative=Jb;var _d=function(){var t=Object.create(null);return!("__proto__"in t)}();function Ld(t){return t}function Yb(t){return Ad(t)?"$"+t:t}ke.toSetString=_d?Ld:Yb;function Xb(t){return Ad(t)?t.slice(1):t}ke.fromSetString=_d?Ld:Xb;function Ad(t){if(!t)return!1;var e=t.length;if(e<9||t.charCodeAt(e-1)!==95||t.charCodeAt(e-2)!==95||t.charCodeAt(e-3)!==111||t.charCodeAt(e-4)!==116||t.charCodeAt(e-5)!==111||t.charCodeAt(e-6)!==114||t.charCodeAt(e-7)!==112||t.charCodeAt(e-8)!==95||t.charCodeAt(e-9)!==95)return!1;for(var r=e-10;r>=0;r--)if(t.charCodeAt(r)!==36)return!1;return!0}function Zb(t,e,r){var n=qn(t.source,e.source);return n!==0||(n=t.originalLine-e.originalLine,n!==0)||(n=t.originalColumn-e.originalColumn,n!==0||r)||(n=t.generatedColumn-e.generatedColumn,n!==0)||(n=t.generatedLine-e.generatedLine,n!==0)?n:qn(t.name,e.name)}ke.compareByOriginalPositions=Zb;function Qb(t,e,r){var n=t.generatedLine-e.generatedLine;return n!==0||(n=t.generatedColumn-e.generatedColumn,n!==0||r)||(n=qn(t.source,e.source),n!==0)||(n=t.originalLine-e.originalLine,n!==0)||(n=t.originalColumn-e.originalColumn,n!==0)?n:qn(t.name,e.name)}ke.compareByGeneratedPositionsDeflated=Qb;function qn(t,e){return t===e?0:t===null?1:e===null?-1:t>e?1:-1}function $b(t,e){var r=t.generatedLine-e.generatedLine;return r!==0||(r=t.generatedColumn-e.generatedColumn,r!==0)||(r=qn(t.source,e.source),r!==0)||(r=t.originalLine-e.originalLine,r!==0)||(r=t.originalColumn-e.originalColumn,r!==0)?r:qn(t.name,e.name)}ke.compareByGeneratedPositionsInflated=$b;function eT(t){return JSON.parse(t.replace(/^\)]}'[^\n]*\n/,""))}ke.parseSourceMapInput=eT;function tT(t,e,r){if(e=e||"",t&&(t[t.length-1]!=="/"&&e[0]!=="/"&&(t+="/"),e=t+e),r){var n=Vi(r);if(!n)throw new Error("sourceMapURL could not be parsed");if(n.path){var i=n.path.lastIndexOf("/");i>=0&&(n.path=n.path.substring(0,i+1))}e=Ed(Gn(n),e)}return Bl(e)}ke.computeSourceURL=tT});var Wl=He(Od=>{var Ul=Kn(),zl=Object.prototype.hasOwnProperty,Yr=typeof Map!="undefined";function er(){this._array=[],this._set=Yr?new Map:Object.create(null)}er.fromArray=function(e,r){for(var n=new er,i=0,o=e.length;i<o;i++)n.add(e[i],r);return n};er.prototype.size=function(){return Yr?this._set.size:Object.getOwnPropertyNames(this._set).length};er.prototype.add=function(e,r){var n=Yr?e:Ul.toSetString(e),i=Yr?this.has(e):zl.call(this._set,n),o=this._array.length;(!i||r)&&this._array.push(e),i||(Yr?this._set.set(e,o):this._set[n]=o)};er.prototype.has=function(e){if(Yr)return this._set.has(e);var r=Ul.toSetString(e);return zl.call(this._set,r)};er.prototype.indexOf=function(e){if(Yr){var r=this._set.get(e);if(r>=0)return r}else{var n=Ul.toSetString(e);if(zl.call(this._set,n))return this._set[n]}throw new Error('"'+e+'" is not in the set.')};er.prototype.at=function(e){if(e>=0&&e<this._array.length)return this._array[e];throw new Error("No element indexed by "+e)};er.prototype.toArray=function(){return this._array.slice()};Od.ArraySet=er});var Dd=He(Rd=>{var Id=Kn();function rT(t,e){var r=t.generatedLine,n=e.generatedLine,i=t.generatedColumn,o=e.generatedColumn;return n>r||n==r&&o>=i||Id.compareByGeneratedPositionsInflated(t,e)<=0}function Ms(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}Ms.prototype.unsortedForEach=function(e,r){this._array.forEach(e,r)};Ms.prototype.add=function(e){rT(this._last,e)?(this._last=e,this._array.push(e)):(this._sorted=!1,this._array.push(e))};Ms.prototype.toArray=function(){return this._sorted||(this._array.sort(Id.compareByGeneratedPositionsInflated),this._sorted=!0),this._array};Rd.MappingList=Ms});var jl=He(kd=>{var Bi=Vl(),de=Kn(),Ps=Wl().ArraySet,nT=Dd().MappingList;function ct(t){t||(t={}),this._file=de.getArg(t,"file",null),this._sourceRoot=de.getArg(t,"sourceRoot",null),this._skipValidation=de.getArg(t,"skipValidation",!1),this._sources=new Ps,this._names=new Ps,this._mappings=new nT,this._sourcesContents=null}ct.prototype._version=3;ct.fromSourceMap=function(e){var r=e.sourceRoot,n=new ct({file:e.file,sourceRoot:r});return e.eachMapping(function(i){var o={generated:{line:i.generatedLine,column:i.generatedColumn}};i.source!=null&&(o.source=i.source,r!=null&&(o.source=de.relative(r,o.source)),o.original={line:i.originalLine,column:i.originalColumn},i.name!=null&&(o.name=i.name)),n.addMapping(o)}),e.sources.forEach(function(i){var o=i;r!==null&&(o=de.relative(r,i)),n._sources.has(o)||n._sources.add(o);var s=e.sourceContentFor(i);s!=null&&n.setSourceContent(i,s)}),n};ct.prototype.addMapping=function(e){var r=de.getArg(e,"generated"),n=de.getArg(e,"original",null),i=de.getArg(e,"source",null),o=de.getArg(e,"name",null);this._skipValidation||this._validateMapping(r,n,i,o),i!=null&&(i=String(i),this._sources.has(i)||this._sources.add(i)),o!=null&&(o=String(o),this._names.has(o)||this._names.add(o)),this._mappings.add({generatedLine:r.line,generatedColumn:r.column,originalLine:n!=null&&n.line,originalColumn:n!=null&&n.column,source:i,name:o})};ct.prototype.setSourceContent=function(e,r){var n=e;this._sourceRoot!=null&&(n=de.relative(this._sourceRoot,n)),r!=null?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[de.toSetString(n)]=r):this._sourcesContents&&(delete this._sourcesContents[de.toSetString(n)],Object.keys(this._sourcesContents).length===0&&(this._sourcesContents=null))};ct.prototype.applySourceMap=function(e,r,n){var i=r;if(r==null){if(e.file==null)throw new Error(`SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map's "file" property. Both were omitted.`);i=e.file}var o=this._sourceRoot;o!=null&&(i=de.relative(o,i));var s=new Ps,a=new Ps;this._mappings.unsortedForEach(function(m){if(m.source===i&&m.originalLine!=null){var c=e.originalPositionFor({line:m.originalLine,column:m.originalColumn});c.source!=null&&(m.source=c.source,n!=null&&(m.source=de.join(n,m.source)),o!=null&&(m.source=de.relative(o,m.source)),m.originalLine=c.line,m.originalColumn=c.column,c.name!=null&&(m.name=c.name))}var h=m.source;h!=null&&!s.has(h)&&s.add(h);var E=m.name;E!=null&&!a.has(E)&&a.add(E)},this),this._sources=s,this._names=a,e.sources.forEach(function(m){var c=e.sourceContentFor(m);c!=null&&(n!=null&&(m=de.join(n,m)),o!=null&&(m=de.relative(o,m)),this.setSourceContent(m,c))},this)};ct.prototype._validateMapping=function(e,r,n,i){if(r&&typeof r.line!="number"&&typeof r.column!="number")throw new Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.");if(!(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0&&!r&&!n&&!i)){if(e&&"line"in e&&"column"in e&&r&&"line"in r&&"column"in r&&e.line>0&&e.column>=0&&r.line>0&&r.column>=0&&n)return;throw new Error("Invalid mapping: "+JSON.stringify({generated:e,source:n,original:r,name:i}))}};ct.prototype._serializeMappings=function(){for(var e=0,r=1,n=0,i=0,o=0,s=0,a="",m,c,h,E,b=this._mappings.toArray(),k=0,U=b.length;k<U;k++){if(c=b[k],m="",c.generatedLine!==r)for(e=0;c.generatedLine!==r;)m+=";",r++;else if(k>0){if(!de.compareByGeneratedPositionsInflated(c,b[k-1]))continue;m+=","}m+=Bi.encode(c.generatedColumn-e),e=c.generatedColumn,c.source!=null&&(E=this._sources.indexOf(c.source),m+=Bi.encode(E-s),s=E,m+=Bi.encode(c.originalLine-1-i),i=c.originalLine-1,m+=Bi.encode(c.originalColumn-n),n=c.originalColumn,c.name!=null&&(h=this._names.indexOf(c.name),m+=Bi.encode(h-o),o=h)),a+=m}return a};ct.prototype._generateSourcesContent=function(e,r){return e.map(function(n){if(!this._sourcesContents)return null;r!=null&&(n=de.relative(r,n));var i=de.toSetString(n);return Object.prototype.hasOwnProperty.call(this._sourcesContents,i)?this._sourcesContents[i]:null},this)};ct.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return this._file!=null&&(e.file=this._file),this._sourceRoot!=null&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e};ct.prototype.toString=function(){return JSON.stringify(this.toJSON())};kd.SourceMapGenerator=ct});var Fd=He(Xr=>{Xr.GREATEST_LOWER_BOUND=1;Xr.LEAST_UPPER_BOUND=2;function Gl(t,e,r,n,i,o){var s=Math.floor((e-t)/2)+t,a=i(r,n[s],!0);return a===0?s:a>0?e-s>1?Gl(s,e,r,n,i,o):o==Xr.LEAST_UPPER_BOUND?e<n.length?e:-1:s:s-t>1?Gl(t,s,r,n,i,o):o==Xr.LEAST_UPPER_BOUND?s:t<0?-1:t}Xr.search=function(e,r,n,i){if(r.length===0)return-1;var o=Gl(-1,r.length,e,r,n,i||Xr.GREATEST_LOWER_BOUND);if(o<0)return-1;for(;o-1>=0&&n(r[o],r[o-1],!0)===0;)--o;return o}});var Vd=He(Nd=>{function ql(t,e,r){var n=t[e];t[e]=t[r],t[r]=n}function iT(t,e){return Math.round(t+Math.random()*(e-t))}function Kl(t,e,r,n){if(r<n){var i=iT(r,n),o=r-1;ql(t,i,n);for(var s=t[n],a=r;a<n;a++)e(t[a],s)<=0&&(o+=1,ql(t,o,a));ql(t,o+1,a);var m=o+1;Kl(t,e,r,m-1),Kl(t,e,m+1,n)}}Nd.quickSort=function(t,e){Kl(t,e,0,t.length-1)}});var Ud=He(Es=>{var L=Kn(),Cl=Fd(),Cn=Wl().ArraySet,oT=Vl(),Ui=Vd().quickSort;function ne(t,e){var r=t;return typeof t=="string"&&(r=L.parseSourceMapInput(t)),r.sections!=null?new vt(r,e):new Le(r,e)}ne.fromSourceMap=function(t,e){return Le.fromSourceMap(t,e)};ne.prototype._version=3;ne.prototype.__generatedMappings=null;Object.defineProperty(ne.prototype,"_generatedMappings",{configurable:!0,enumerable:!0,get:function(){return this.__generatedMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__generatedMappings}});ne.prototype.__originalMappings=null;Object.defineProperty(ne.prototype,"_originalMappings",{configurable:!0,enumerable:!0,get:function(){return this.__originalMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__originalMappings}});ne.prototype._charIsMappingSeparator=function(e,r){var n=e.charAt(r);return n===";"||n===","};ne.prototype._parseMappings=function(e,r){throw new Error("Subclasses must implement _parseMappings")};ne.GENERATED_ORDER=1;ne.ORIGINAL_ORDER=2;ne.GREATEST_LOWER_BOUND=1;ne.LEAST_UPPER_BOUND=2;ne.prototype.eachMapping=function(e,r,n){var i=r||null,o=n||ne.GENERATED_ORDER,s;switch(o){case ne.GENERATED_ORDER:s=this._generatedMappings;break;case ne.ORIGINAL_ORDER:s=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var a=this.sourceRoot;s.map(function(m){var c=m.source===null?null:this._sources.at(m.source);return c=L.computeSourceURL(a,c,this._sourceMapURL),{source:c,generatedLine:m.generatedLine,generatedColumn:m.generatedColumn,originalLine:m.originalLine,originalColumn:m.originalColumn,name:m.name===null?null:this._names.at(m.name)}},this).forEach(e,i)};ne.prototype.allGeneratedPositionsFor=function(e){var r=L.getArg(e,"line"),n={source:L.getArg(e,"source"),originalLine:r,originalColumn:L.getArg(e,"column",0)};if(n.source=this._findSourceIndex(n.source),n.source<0)return[];var i=[],o=this._findMapping(n,this._originalMappings,"originalLine","originalColumn",L.compareByOriginalPositions,Cl.LEAST_UPPER_BOUND);if(o>=0){var s=this._originalMappings[o];if(e.column===void 0)for(var a=s.originalLine;s&&s.originalLine===a;)i.push({line:L.getArg(s,"generatedLine",null),column:L.getArg(s,"generatedColumn",null),lastColumn:L.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++o];else for(var m=s.originalColumn;s&&s.originalLine===r&&s.originalColumn==m;)i.push({line:L.getArg(s,"generatedLine",null),column:L.getArg(s,"generatedColumn",null),lastColumn:L.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++o]}return i};Es.SourceMapConsumer=ne;function Le(t,e){var r=t;typeof t=="string"&&(r=L.parseSourceMapInput(t));var n=L.getArg(r,"version"),i=L.getArg(r,"sources"),o=L.getArg(r,"names",[]),s=L.getArg(r,"sourceRoot",null),a=L.getArg(r,"sourcesContent",null),m=L.getArg(r,"mappings"),c=L.getArg(r,"file",null);if(n!=this._version)throw new Error("Unsupported version: "+n);s&&(s=L.normalize(s)),i=i.map(String).map(L.normalize).map(function(h){return s&&L.isAbsolute(s)&&L.isAbsolute(h)?L.relative(s,h):h}),this._names=Cn.fromArray(o.map(String),!0),this._sources=Cn.fromArray(i,!0),this._absoluteSources=this._sources.toArray().map(function(h){return L.computeSourceURL(s,h,e)}),this.sourceRoot=s,this.sourcesContent=a,this._mappings=m,this._sourceMapURL=e,this.file=c}Le.prototype=Object.create(ne.prototype);Le.prototype.consumer=ne;Le.prototype._findSourceIndex=function(t){var e=t;if(this.sourceRoot!=null&&(e=L.relative(this.sourceRoot,e)),this._sources.has(e))return this._sources.indexOf(e);var r;for(r=0;r<this._absoluteSources.length;++r)if(this._absoluteSources[r]==t)return r;return-1};Le.fromSourceMap=function(e,r){var n=Object.create(Le.prototype),i=n._names=Cn.fromArray(e._names.toArray(),!0),o=n._sources=Cn.fromArray(e._sources.toArray(),!0);n.sourceRoot=e._sourceRoot,n.sourcesContent=e._generateSourcesContent(n._sources.toArray(),n.sourceRoot),n.file=e._file,n._sourceMapURL=r,n._absoluteSources=n._sources.toArray().map(function(k){return L.computeSourceURL(n.sourceRoot,k,r)});for(var s=e._mappings.toArray().slice(),a=n.__generatedMappings=[],m=n.__originalMappings=[],c=0,h=s.length;c<h;c++){var E=s[c],b=new Bd;b.generatedLine=E.generatedLine,b.generatedColumn=E.generatedColumn,E.source&&(b.source=o.indexOf(E.source),b.originalLine=E.originalLine,b.originalColumn=E.originalColumn,E.name&&(b.name=i.indexOf(E.name)),m.push(b)),a.push(b)}return Ui(n.__originalMappings,L.compareByOriginalPositions),n};Le.prototype._version=3;Object.defineProperty(Le.prototype,"sources",{get:function(){return this._absoluteSources.slice()}});function Bd(){this.generatedLine=0,this.generatedColumn=0,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}Le.prototype._parseMappings=function(e,r){for(var n=1,i=0,o=0,s=0,a=0,m=0,c=e.length,h=0,E={},b={},k=[],U=[],ve,Gi,Ae,$r,ru;h<c;)if(e.charAt(h)===";")n++,h++,i=0;else if(e.charAt(h)===",")h++;else{for(ve=new Bd,ve.generatedLine=n,$r=h;$r<c&&!this._charIsMappingSeparator(e,$r);$r++);if(Gi=e.slice(h,$r),Ae=E[Gi],Ae)h+=Gi.length;else{for(Ae=[];h<$r;)oT.decode(e,h,b),ru=b.value,h=b.rest,Ae.push(ru);if(Ae.length===2)throw new Error("Found a source, but no line and column");if(Ae.length===3)throw new Error("Found a source and line, but no column");E[Gi]=Ae}ve.generatedColumn=i+Ae[0],i=ve.generatedColumn,Ae.length>1&&(ve.source=a+Ae[1],a+=Ae[1],ve.originalLine=o+Ae[2],o=ve.originalLine,ve.originalLine+=1,ve.originalColumn=s+Ae[3],s=ve.originalColumn,Ae.length>4&&(ve.name=m+Ae[4],m+=Ae[4])),U.push(ve),typeof ve.originalLine=="number"&&k.push(ve)}Ui(U,L.compareByGeneratedPositionsDeflated),this.__generatedMappings=U,Ui(k,L.compareByOriginalPositions),this.__originalMappings=k};Le.prototype._findMapping=function(e,r,n,i,o,s){if(e[n]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+e[n]);if(e[i]<0)throw new TypeError("Column must be greater than or equal to 0, got "+e[i]);return Cl.search(e,r,o,s)};Le.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var r=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var n=this._generatedMappings[e+1];if(r.generatedLine===n.generatedLine){r.lastGeneratedColumn=n.generatedColumn-1;continue}}r.lastGeneratedColumn=Infinity}};Le.prototype.originalPositionFor=function(e){var r={generatedLine:L.getArg(e,"line"),generatedColumn:L.getArg(e,"column")},n=this._findMapping(r,this._generatedMappings,"generatedLine","generatedColumn",L.compareByGeneratedPositionsDeflated,L.getArg(e,"bias",ne.GREATEST_LOWER_BOUND));if(n>=0){var i=this._generatedMappings[n];if(i.generatedLine===r.generatedLine){var o=L.getArg(i,"source",null);o!==null&&(o=this._sources.at(o),o=L.computeSourceURL(this.sourceRoot,o,this._sourceMapURL));var s=L.getArg(i,"name",null);return s!==null&&(s=this._names.at(s)),{source:o,line:L.getArg(i,"originalLine",null),column:L.getArg(i,"originalColumn",null),name:s}}}return{source:null,line:null,column:null,name:null}};Le.prototype.hasContentsOfAllSources=function(){return this.sourcesContent?this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return e==null}):!1};Le.prototype.sourceContentFor=function(e,r){if(!this.sourcesContent)return null;var n=this._findSourceIndex(e);if(n>=0)return this.sourcesContent[n];var i=e;this.sourceRoot!=null&&(i=L.relative(this.sourceRoot,i));var o;if(this.sourceRoot!=null&&(o=L.urlParse(this.sourceRoot))){var s=i.replace(/^file:\/\//,"");if(o.scheme=="file"&&this._sources.has(s))return this.sourcesContent[this._sources.indexOf(s)];if((!o.path||o.path=="/")&&this._sources.has("/"+i))return this.sourcesContent[this._sources.indexOf("/"+i)]}if(r)return null;throw new Error('"'+i+'" is not in the SourceMap.')};Le.prototype.generatedPositionFor=function(e){var r=L.getArg(e,"source");if(r=this._findSourceIndex(r),r<0)return{line:null,column:null,lastColumn:null};var n={source:r,originalLine:L.getArg(e,"line"),originalColumn:L.getArg(e,"column")},i=this._findMapping(n,this._originalMappings,"originalLine","originalColumn",L.compareByOriginalPositions,L.getArg(e,"bias",ne.GREATEST_LOWER_BOUND));if(i>=0){var o=this._originalMappings[i];if(o.source===n.source)return{line:L.getArg(o,"generatedLine",null),column:L.getArg(o,"generatedColumn",null),lastColumn:L.getArg(o,"lastGeneratedColumn",null)}}return{line:null,column:null,lastColumn:null}};Es.BasicSourceMapConsumer=Le;function vt(t,e){var r=t;typeof t=="string"&&(r=L.parseSourceMapInput(t));var n=L.getArg(r,"version"),i=L.getArg(r,"sections");if(n!=this._version)throw new Error("Unsupported version: "+n);this._sources=new Cn,this._names=new Cn;var o={line:-1,column:0};this._sections=i.map(function(s){if(s.url)throw new Error("Support for url field in sections not implemented.");var a=L.getArg(s,"offset"),m=L.getArg(a,"line"),c=L.getArg(a,"column");if(m<o.line||m===o.line&&c<o.column)throw new Error("Section offsets must be ordered and non-overlapping.");return o=a,{generatedOffset:{generatedLine:m+1,generatedColumn:c+1},consumer:new ne(L.getArg(s,"map"),e)}})}vt.prototype=Object.create(ne.prototype);vt.prototype.constructor=ne;vt.prototype._version=3;Object.defineProperty(vt.prototype,"sources",{get:function(){for(var t=[],e=0;e<this._sections.length;e++)for(var r=0;r<this._sections[e].consumer.sources.length;r++)t.push(this._sections[e].consumer.sources[r]);return t}});vt.prototype.originalPositionFor=function(e){var r={generatedLine:L.getArg(e,"line"),generatedColumn:L.getArg(e,"column")},n=Cl.search(r,this._sections,function(o,s){var a=o.generatedLine-s.generatedOffset.generatedLine;return a||o.generatedColumn-s.generatedOffset.generatedColumn}),i=this._sections[n];return i?i.consumer.originalPositionFor({line:r.generatedLine-(i.generatedOffset.generatedLine-1),column:r.generatedColumn-(i.generatedOffset.generatedLine===r.generatedLine?i.generatedOffset.generatedColumn-1:0),bias:e.bias}):{source:null,line:null,column:null,name:null}};vt.prototype.hasContentsOfAllSources=function(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})};vt.prototype.sourceContentFor=function(e,r){for(var n=0;n<this._sections.length;n++){var i=this._sections[n],o=i.consumer.sourceContentFor(e,!0);if(o)return o}if(r)return null;throw new Error('"'+e+'" is not in the SourceMap.')};vt.prototype.generatedPositionFor=function(e){for(var r=0;r<this._sections.length;r++){var n=this._sections[r];if(n.consumer._findSourceIndex(L.getArg(e,"source"))!==-1){var i=n.consumer.generatedPositionFor(e);if(i){var o={line:i.line+(n.generatedOffset.generatedLine-1),column:i.column+(n.generatedOffset.generatedLine===i.line?n.generatedOffset.generatedColumn-1:0)};return o}}}return{line:null,column:null}};vt.prototype._parseMappings=function(e,r){this.__generatedMappings=[],this.__originalMappings=[];for(var n=0;n<this._sections.length;n++)for(var i=this._sections[n],o=i.consumer._generatedMappings,s=0;s<o.length;s++){var a=o[s],m=i.consumer._sources.at(a.source);m=L.computeSourceURL(i.consumer.sourceRoot,m,this._sourceMapURL),this._sources.add(m),m=this._sources.indexOf(m);var c=null;a.name&&(c=i.consumer._names.at(a.name),this._names.add(c),c=this._names.indexOf(c));var h={source:m,generatedLine:a.generatedLine+(i.generatedOffset.generatedLine-1),generatedColumn:a.generatedColumn+(i.generatedOffset.generatedLine===a.generatedLine?i.generatedOffset.generatedColumn-1:0),originalLine:a.originalLine,originalColumn:a.originalColumn,name:c};this.__generatedMappings.push(h),typeof h.originalLine=="number"&&this.__originalMappings.push(h)}Ui(this.__generatedMappings,L.compareByGeneratedPositionsDeflated),Ui(this.__originalMappings,L.compareByOriginalPositions)};Es.IndexedSourceMapConsumer=vt});var Wd=He(zd=>{var sT=jl().SourceMapGenerator,_s=Kn(),aT=/(\r?\n)/,lT=10,Hn="$$$isSourceNode$$$";function tt(t,e,r,n,i){this.children=[],this.sourceContents={},this.line=t??null,this.column=e??null,this.source=r??null,this.name=i??null,this[Hn]=!0,n!=null&&this.add(n)}tt.fromStringWithSourceMap=function(e,r,n){var i=new tt,o=e.split(aT),s=0,a=function(){var b=U(),k=U()||"";return b+k;function U(){return s<o.length?o[s++]:void 0}},m=1,c=0,h=null;return r.eachMapping(function(b){if(h!==null)if(m<b.generatedLine)E(h,a()),m++,c=0;else{var k=o[s]||"",U=k.substr(0,b.generatedColumn-c);o[s]=k.substr(b.generatedColumn-c),c=b.generatedColumn,E(h,U),h=b;return}for(;m<b.generatedLine;)i.add(a()),m++;if(c<b.generatedColumn){var k=o[s]||"";i.add(k.substr(0,b.generatedColumn)),o[s]=k.substr(b.generatedColumn),c=b.generatedColumn}h=b},this),s<o.length&&(h&&E(h,a()),i.add(o.splice(s).join(""))),r.sources.forEach(function(b){var k=r.sourceContentFor(b);k!=null&&(n!=null&&(b=_s.join(n,b)),i.setSourceContent(b,k))}),i;function E(b,k){if(b===null||b.source===void 0)i.add(k);else{var U=n?_s.join(n,b.source):b.source;i.add(new tt(b.originalLine,b.originalColumn,U,k,b.name))}}};tt.prototype.add=function(e){if(Array.isArray(e))e.forEach(function(r){this.add(r)},this);else if(e[Hn]||typeof e=="string")e&&this.children.push(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};tt.prototype.prepend=function(e){if(Array.isArray(e))for(var r=e.length-1;r>=0;r--)this.prepend(e[r]);else if(e[Hn]||typeof e=="string")this.children.unshift(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};tt.prototype.walk=function(e){for(var r,n=0,i=this.children.length;n<i;n++)r=this.children[n],r[Hn]?r.walk(e):r!==""&&e(r,{source:this.source,line:this.line,column:this.column,name:this.name})};tt.prototype.join=function(e){var r,n,i=this.children.length;if(i>0){for(r=[],n=0;n<i-1;n++)r.push(this.children[n]),r.push(e);r.push(this.children[n]),this.children=r}return this};tt.prototype.replaceRight=function(e,r){var n=this.children[this.children.length-1];return n[Hn]?n.replaceRight(e,r):typeof n=="string"?this.children[this.children.length-1]=n.replace(e,r):this.children.push("".replace(e,r)),this};tt.prototype.setSourceContent=function(e,r){this.sourceContents[_s.toSetString(e)]=r};tt.prototype.walkSourceContents=function(e){for(var r=0,n=this.children.length;r<n;r++)this.children[r][Hn]&&this.children[r].walkSourceContents(e);for(var i=Object.keys(this.sourceContents),r=0,n=i.length;r<n;r++)e(_s.fromSetString(i[r]),this.sourceContents[i[r]])};tt.prototype.toString=function(){var e="";return this.walk(function(r){e+=r}),e};tt.prototype.toStringWithSourceMap=function(e){var r={code:"",line:1,column:0},n=new sT(e),i=!1,o=null,s=null,a=null,m=null;return this.walk(function(c,h){r.code+=c,h.source!==null&&h.line!==null&&h.column!==null?((o!==h.source||s!==h.line||a!==h.column||m!==h.name)&&n.addMapping({source:h.source,original:{line:h.line,column:h.column},generated:{line:r.line,column:r.column},name:h.name}),o=h.source,s=h.line,a=h.column,m=h.name,i=!0):i&&(n.addMapping({generated:{line:r.line,column:r.column}}),o=null,i=!1);for(var E=0,b=c.length;E<b;E++)c.charCodeAt(E)===lT?(r.line++,r.column=0,E+1===b?(o=null,i=!1):i&&n.addMapping({source:h.source,original:{line:h.line,column:h.column},generated:{line:r.line,column:r.column},name:h.name})):r.column++}),this.walkSourceContents(function(c,h){n.setSourceContent(c,h)}),{code:r.code,map:n}};zd.SourceNode=tt});var jd=He(Ls=>{Ls.SourceMapGenerator=jl().SourceMapGenerator;Ls.SourceMapConsumer=Ud().SourceMapConsumer;Ls.SourceNode=Wd().SourceNode});var qd=He((T5,Gd)=>{var uT=Object.prototype.toString,Hl=typeof Buffer.alloc=="function"&&typeof Buffer.allocUnsafe=="function"&&typeof Buffer.from=="function";function mT(t){return uT.call(t).slice(8,-1)==="ArrayBuffer"}function cT(t,e,r){e>>>=0;var n=t.byteLength-e;if(n<0)throw new RangeError("'offset' is out of bounds");if(r===void 0)r=n;else if(r>>>=0,r>n)throw new RangeError("'length' is out of bounds");return Hl?Buffer.from(t.slice(e,e+r)):new Buffer(new Uint8Array(t.slice(e,e+r)))}function fT(t,e){if((typeof e!="string"||e==="")&&(e="utf8"),!Buffer.isEncoding(e))throw new TypeError('"encoding" must be a valid string encoding');return Hl?Buffer.from(t,e):new Buffer(t,e)}function pT(t,e,r){if(typeof t=="number")throw new TypeError('"value" argument must not be a number');return mT(t)?cT(t,e,r):typeof t=="string"?fT(t,e):Hl?Buffer.from(t):new Buffer(t)}Gd.exports=pT});var Qd=He((Zr,Jl)=>{var dT=jd().SourceMapConsumer,Yl=require("path"),kt;try{kt=require("fs"),(!kt.existsSync||!kt.readFileSync)&&(kt=null)}catch(t){}var hT=qd();function Kd(t,e){return t.require(e)}var Cd=!1,Hd=!1,Xl=!1,zi="auto",Qr={},Wi={},gT=/^data:application\/json[^,]+base64,/,Tr=[],vr=[];function Zl(){return zi==="browser"?!0:zi==="node"?!1:typeof window!="undefined"&&typeof XMLHttpRequest=="function"&&!(window.require&&window.module&&window.process&&window.process.type==="renderer")}function yT(){return typeof process=="object"&&process!==null&&typeof process.on=="function"}function As(t){return function(e){for(var r=0;r<t.length;r++){var n=t[r](e);if(n)return n}return null}}var Ql=As(Tr);Tr.push(function(t){if(t=t.trim(),/^file:/.test(t)&&(t=t.replace(/file:\/\/\/(\w:)?/,function(n,i){return i?"":"/"})),t in Qr)return Qr[t];var e="";try{if(kt)kt.existsSync(t)&&(e=kt.readFileSync(t,"utf8"));else{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),r.readyState===4&&r.status===200&&(e=r.responseText)}}catch(n){}return Qr[t]=e});function $l(t,e){if(!t)return e;var r=Yl.dirname(t),n=/^\w+:\/\/[^\/]*/.exec(r),i=n?n[0]:"",o=r.slice(i.length);return i&&/^\/\w\:/.test(o)?(i+="/",i+Yl.resolve(r.slice(i.length),e).replace(/\\/g,"/")):i+Yl.resolve(r.slice(i.length),e)}function bT(t){var e;if(Zl())try{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),e=r.readyState===4?r.responseText:null;var n=r.getResponseHeader("SourceMap")||r.getResponseHeader("X-SourceMap");if(n)return n}catch(a){}e=Ql(t);for(var i=/(?:\/\/[@#][\s]*sourceMappingURL=([^\s'"]+)[\s]*$)|(?:\/\*[@#][\s]*sourceMappingURL=([^\s*'"]+)[\s]*(?:\*\/)[\s]*$)/mg,o,s;s=i.exec(e);)o=s;return o?o[1]:null}var eu=As(vr);vr.push(function(t){var e=bT(t);if(!e)return null;var r;if(gT.test(e)){var n=e.slice(e.indexOf(",")+1);r=hT(n,"base64").toString(),e=t}else e=$l(t,e),r=Ql(e);return r?{url:e,map:r}:null});function tu(t){var e=Wi[t.source];if(!e){var r=eu(t.source);r?(e=Wi[t.source]={url:r.url,map:new dT(r.map)},e.map.sourcesContent&&e.map.sources.forEach(function(i,o){var s=e.map.sourcesContent[o];if(s){var a=$l(e.url,i);Qr[a]=s}})):e=Wi[t.source]={url:null,map:null}}if(e&&e.map&&typeof e.map.originalPositionFor=="function"){var n=e.map.originalPositionFor(t);if(n.source!==null)return n.source=$l(e.url,n.source),n}return t}function Jd(t){var e=/^eval at ([^(]+) \((.+):(\d+):(\d+)\)$/.exec(t);if(e){var r=tu({source:e[2],line:+e[3],column:e[4]-1});return"eval at "+e[1]+" ("+r.source+":"+r.line+":"+(r.column+1)+")"}return e=/^eval at ([^(]+) \((.+)\)$/.exec(t),e?"eval at "+e[1]+" ("+Jd(e[2])+")":t}function TT(){var t,e="";if(this.isNative())e="native";else{t=this.getScriptNameOrSourceURL(),!t&&this.isEval()&&(e=this.getEvalOrigin(),e+=", "),t?e+=t:e+="<anonymous>";var r=this.getLineNumber();if(r!=null){e+=":"+r;var n=this.getColumnNumber();n&&(e+=":"+n)}}var i="",o=this.getFunctionName(),s=!0,a=this.isConstructor(),m=!(this.isToplevel()||a);if(m){var c=this.getTypeName();c==="[object Object]"&&(c="null");var h=this.getMethodName();o?(c&&o.indexOf(c)!=0&&(i+=c+"."),i+=o,h&&o.indexOf("."+h)!=o.length-h.length-1&&(i+=" [as "+h+"]")):i+=c+"."+(h||"<anonymous>")}else a?i+="new "+(o||"<anonymous>"):o?i+=o:(i+=e,s=!1);return s&&(i+=" ("+e+")"),i}function Yd(t){var e={};return Object.getOwnPropertyNames(Object.getPrototypeOf(t)).forEach(function(r){e[r]=/^(?:is|get)/.test(r)?function(){return t[r].call(t)}:t[r]}),e.toString=TT,e}function Xd(t,e){if(e===void 0&&(e={nextPosition:null,curPosition:null}),t.isNative())return e.curPosition=null,t;var r=t.getFileName()||t.getScriptNameOrSourceURL();if(r){var n=t.getLineNumber(),i=t.getColumnNumber()-1,o=/^v(10\.1[6-9]|10\.[2-9][0-9]|10\.[0-9]{3,}|1[2-9]\d*|[2-9]\d|\d{3,}|11\.11)/,s=o.test(process.version)?0:62;n===1&&i>s&&!Zl()&&!t.isEval()&&(i-=s);var a=tu({source:r,line:n,column:i});e.curPosition=a,t=Yd(t);var m=t.getFunctionName;return t.getFunctionName=function(){return e.nextPosition==null?m():e.nextPosition.name||m()},t.getFileName=function(){return a.source},t.getLineNumber=function(){return a.line},t.getColumnNumber=function(){return a.column+1},t.getScriptNameOrSourceURL=function(){return a.source},t}var c=t.isEval()&&t.getEvalOrigin();return c&&(c=Jd(c),t=Yd(t),t.getEvalOrigin=function(){return c}),t}function vT(t,e){Xl&&(Qr={},Wi={});for(var r=t.name||"Error",n=t.message||"",i=r+": "+n,o={nextPosition:null,curPosition:null},s=[],a=e.length-1;a>=0;a--)s.push(`
    at `+Xd(e[a],o)),o.nextPosition=o.curPosition;return o.curPosition=o.nextPosition=null,i+s.reverse().join("")}function Zd(t){var e=/\n    at [^(]+ \((.*):(\d+):(\d+)\)/.exec(t.stack);if(e){var r=e[1],n=+e[2],i=+e[3],o=Qr[r];if(!o&&kt&&kt.existsSync(r))try{o=kt.readFileSync(r,"utf8")}catch(a){o=""}if(o){var s=o.split(/(?:\r\n|\r|\n)/)[n-1];if(s)return r+":"+n+`
`+s+`
`+new Array(i).join(" ")+"^"}}return null}function xT(t){var e=Zd(t);process.stderr._handle&&process.stderr._handle.setBlocking&&process.stderr._handle.setBlocking(!0),e&&(console.error(),console.error(e)),console.error(t.stack),process.exit(1)}function wT(){var t=process.emit;process.emit=function(e){if(e==="uncaughtException"){var r=arguments[1]&&arguments[1].stack,n=this.listeners(e).length>0;if(r&&!n)return xT(arguments[1])}return t.apply(this,arguments)}}var ST=Tr.slice(0),MT=vr.slice(0);Zr.wrapCallSite=Xd;Zr.getErrorSource=Zd;Zr.mapSourcePosition=tu;Zr.retrieveSourceMap=eu;Zr.install=function(t){if(t=t||{},t.environment&&(zi=t.environment,["node","browser","auto"].indexOf(zi)===-1))throw new Error("environment "+zi+" was unknown. Available options are {auto, browser, node}");if(t.retrieveFile&&(t.overrideRetrieveFile&&(Tr.length=0),Tr.unshift(t.retrieveFile)),t.retrieveSourceMap&&(t.overrideRetrieveSourceMap&&(vr.length=0),vr.unshift(t.retrieveSourceMap)),t.hookRequire&&!Zl()){var e=Kd(Jl,"module"),r=e.prototype._compile;r.__sourceMapSupport||(e.prototype._compile=function(o,s){return Qr[s]=o,Wi[s]=void 0,r.call(this,o,s)},e.prototype._compile.__sourceMapSupport=!0)}if(Xl||(Xl="emptyCacheBetweenOperations"in t?t.emptyCacheBetweenOperations:!1),Cd||(Cd=!0,Error.prepareStackTrace=vT),!Hd){var n="handleUncaughtExceptions"in t?t.handleUncaughtExceptions:!0;try{var i=Kd(Jl,"worker_threads");i.isMainThread===!1&&(n=!1)}catch(o){}n&&yT()&&(Hd=!0,wT())}};Zr.resetRetrieveHandlers=function(){Tr.length=0,vr.length=0,Tr=ST.slice(0),vr=MT.slice(0),eu=As(vr),Ql=As(Tr)}});var ji=g(require("process"));var md=g(require("fs")),Rl=g(require("fs-extra")),Fi=g(require("path")),Ni=g(require("process")),jn=g(require("timers"));function Jn(t){return t!=null&&typeof t!="string"&&typeof t[Symbol.iterator]=="function"}function f(t){return t==null?"":typeof t=="string"?t:Array.isArray(t)?t.map(f).join(","):t.toString()}var sh=["number","string","boolean"];function Ft(t){return sh.indexOf(typeof t)!==-1||t instanceof Date}function qi(t){return Array.isArray(t)&&t.every(Ft)}var nu=["boolean","number","bigint","symbol","string","object","function"];function xt(t,e){if(t==null&&e==null)return 0;if(t==null)return-1;if(e==null)return 1;let r=typeof t,n=typeof e;return(r==="string"||r==="symbol")&&(n==="string"||n==="symbol")?f(t).localeCompare(f(e)):Array.isArray(t)&&Array.isArray(e)?ah(t,e):r!==n?nu.indexOf(r)-nu.indexOf(n):t>e?1:t<e?-1:0}function xr(t,e){return xt(t,e)<0}function Ki(t,e){return xt(t,e)>=0}function iu(t,e){return xt(t,e)>0}function ah(t,e){if(N(t)&&N(e))return 0;let r=Math.min(t.length,e.length);for(let n=0;n<r;n++){let i=xt(t[n],e[n]);if(i!==0)return i}return xt(t.length,e.length)}var rt;(function(t){t[t.Empty=0]="Empty",t[t.Primitive=1]="Primitive",t[t.Symbol=2]="Symbol",t[t.Object=3]="Object",t[t.Array=4]="Array",t[t.Iterable=5]="Iterable",t[t.Instance=6]="Instance",t[t.Function=7]="Function",t[t.Unknown=8]="Unknown"})(rt||(rt={}));function lh(t){return typeof t=="symbol"}function Y(t){return typeof t=="function"}function ou(t){return uh(t)===3}function uh(t){return t==null?0:lh(t)?2:Ft(t)?1:Array.isArray(t)?4:Jn(t)?5:Y(t)?7:typeof t=="object"?t.constructor!=null&&t.constructor.name==="Object"?3:6:8}function nt(t){return Y(t)?t():t}function p(t,e){return t==null?void 0:e(t)}function mh(t,e,r){return t==null||e==null?void 0:r(t,e)}function su(t,e,r,n){return t==null||e==null||r==null?void 0:n(t,e,r)}function v(t,e){return t??nt(e)}function re(t,e,r){return t!=null?e(t):nt(r)}function au(t,e,r,n){return v(mh(t,e,r),n)}function tr(t){return t!=null}function lu(t){return t!=null&&t.every(tr)}function uu(...t){return t.find(tr)}function Ci(t){return t==null||f(t)==="null"?void 0:t}function M(t){if(t==null)return!0;let e=f(t);return e.length===0||e.trim().length===0}var ch=/^\s*(?:null|undefined)?\s*$/i;function en(t){return t==null||ch.exec(t)!=null}function x(t){return!M(t)}function tn(t,e){if(t==null)return nt(e);let r=f(t).trim();return r.length>0?r:nt(e)}function Rs(t,e){return M(t)?!1:e(t)}function he(t,e){if(t===!1||t==null||t==="")return;let r=f(t);return x(r)?e(r):void 0}function wr(t,e,r){return v(he(t,e),r)}function F(t,e,r,n){return JSON.stringify(t,fh(e,n),Ci(r))}function fh(t,e){let r=[],n=[],i=e??((o,s)=>r[0]===s?"[Circular ~]":"[Circular ~."+n.slice(0,r.indexOf(s)).join(".")+"]");return function(o,s){if(r.length>0){let m=r.indexOf(this);m>=0?(r.splice(m+1),n.splice(m,Infinity,o)):(r.push(this),n.push(o)),r.indexOf(s)>=0&&(s=i.call(this,o,s))}else r.push(s);return t==null?s:t.call(this,o,s)}}function Hi(t,e){return F(t)===F(e)}function mu(t){return t!=null&&(Array.isArray(t)||isFinite(t.length)&&Y(t[Symbol.iterator])&&Y(t.push)&&Y(t.pop)&&Y(t.forEach)&&Y(t.some))}function it(t,e,r){if(e==null)throw new Error("null key");if(t.has(e))return t.get(e);{let n=r();return n!=null&&t.set(e,n),n}}var Is;(function(U){U.isDefined=!1,U.isEmpty=!0,U.get=()=>{},U.exists=()=>!1;let i=()=>U;U.map=i,U.flatMap=i,U.filter=i,U.forEach=i,U.getOrElse=ve=>ve(),U.orElse=ve=>I(ve()),U.zip1=i,U.zip2=i,U.zip3=i})(Is||(Is={}));var cu=Is,Yn=class{constructor(e){this.a=e;this.isDefined=!0;this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new Yn(e(this.a))}flatMap(e){let r=e(this.a);return fu(r)?r:I(r)}filter(e){return I(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,r){return I(e).flatMap(n=>r(this.a,n))}zip2(e,r,n){return I(e).flatMap(i=>I(r).flatMap(o=>n(this.a,i,o)))}zip3(e,r,n,i){return I(e).flatMap(o=>I(r).flatMap(s=>I(n).flatMap(a=>i(this.a,o,s,a))))}};function fu(t){return t instanceof Yn||t===cu}function I(t){return fu(t)?t:t!=null?new Yn(t):cu}function le(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function Ds(t,e){return le(t)?e(t):void 0}var Ji=t=>(e,r)=>le(e)&&le(r)&&t(e,r),pu=Ji((t,e)=>t<e),du=Ji((t,e)=>t<=e),hu=Ji((t,e)=>t>e),gu=Ji((t,e)=>t>=e);function yu(t,e,r){return t==null||e==null?!1:Math.abs(t-e)<r}function ph(t){if(!le(t))return;let e=Math.trunc(t);return e===0?Math.abs(e):e}function dh(t){return Y(t.toNumber)}function bu(t,e){if(M(t))return e.defaultValue;if(le(t))return e.nton(t);if(dh(t))return e.nton(t.toNumber());try{let r=e.ston(f(t));return le(r)?e.nton(r):e.defaultValue}catch{return e.defaultValue}}function j(t,e){return bu(t,d({defaultValue:void 0,nton:r=>ph(r),ston:parseInt},e))}function Yi(t,e){return bu(t,d({defaultValue:void 0,nton:r=>r,ston:parseFloat},e))}function G(t){return le(t)&&t>0}function ks(t,e){return I(t).flatMap(r=>j(r)).flatMap(e).get()}function Xi(t,e){return le(t)?e(t):void 0}function Fs(t,e,r){return Xi(t,n=>Xi(e,i=>r(n,i)))}function Ns(t,e,r){return le(t)?e(t):r}function Je(t){return t<0?-Math.round(-t):Math.round(t)}function ft(t,e){if(t===0||e===0)return 0;let r=e-Je(Math.ceil(Math.log10(Math.abs(t)))),n=Math.pow(10,Math.abs(r));return r<0?Je(t/n)*n:Je(t*n)/n}function ue(t,e,r){if(t>e||!le(t)||!le(e))throw new Error(`invalid clamp(${t}, ${e}, ${r})`);return le(r)?r<t?t:r>e?e:r:Je((t+e)/2)}function Fe(t,e){if(!G(t))return[];let r=Math.round(t);return r<=0?[]:[...Array(r)].map((n,i)=>e(i))}function Xn(t,e,r=[]){if(t=Math.ceil(t),e=Math.floor(e),e<t)return t;if(Q(r)&&r.length+10>e-t){let i=Zi(t,e).filter(o=>!r.includes(o));return Pe(i,o=>o[Xn(0,i.length)])}let n=Math.floor(Math.random()*(e-t))+t;return r.includes(n)?Xn(t,e,r):n}function Zn(t){return typeof t=="string"}function rn(t,e){return t=f(t),e=f(e),t.startsWith(e)?t:e+t}function We(t,e){return t=f(t),e=f(e),t.endsWith(e)?t:t+e}function pt(t,e=80){if(t==null)return"";let r=f(t);return r.length<=e?r:r.slice(0,e-1)+"\u2026"}var Nt=/\r?\n/gm;function hh(t,e,r){r==null&&(r=t.length);for(let n=r;n>=0;n--)if(t.substr(n).startsWith(e))return n;return-1}function Sr(t,e={maxLineLen:75,prefix:""}){if(t.includes(`
`))return xe(t.split(Nt).map(n=>Sr(n,e)));if(t=rn(f(t),e.prefix).trim(),t.length<=e.maxLineLen)return[t];let r=hh(t," ",e.maxLineLen);if(r>e.prefix.length)return[t.slice(0,r),...Sr(t.slice(r+1),e)];{let n=t.indexOf(" ",e.prefix.length+1);return n>0&&n<t.length-1?[t.slice(0,n),...Sr(t.slice(n+1),e)]:[t]}}function Vs(t,e,r){return e===""?t:t.split(e).join(r)}function O(t){return t==null?[]:Array.isArray(t)?t:Jn(t)?Array.from(t):[t]}function Q(t){return mu(t)&&t.length>0&&t.some(e=>e!=null)}function N(t){return!Q(t)}function Pe(t,e){return Q(t)?e(t):void 0}function gh(t){return Ft(t)||qi(t)?t:t.valueOf()}function xe(t,e=[]){if(t==null)return e;for(let r of t)if(r!=null)if(Array.isArray(r))for(let n of r)n!=null&&e.push(n);else e.push(r);return e}function rr(t){return Tu(D(t),gh)}function Bs(t,e){for(let r=0;r<t.length;r++)e[r]=t[r];return e.length=t.length,e}function Tu(t,e){return Bs($(t,e),t)}function $(t,e){return O(t).filter(r=>r!=null).map((r,n)=>({item:r,cmp:p(e(r,n),i=>[i,n])})).filter(r=>r.cmp!=null).sort((r,n)=>xt(r.cmp,n.cmp)).map(r=>r.item)}function Us(t,e){return t!=null&&e!=null&&t.length===e.length&&t.every((r,n)=>r===e[n])}function vu(t,e){return Us(t.slice(0,e.length),e)}function Ye(t,e){for(let r=0;r<t.length;)e(t[r],r,t)?r++:t.splice(r,1);return t}function yh(t,e){if(t==null)return!1;for(let r of t)if(e.valueOf()===r.valueOf())return!0;return!1}function xu(t,e){return t==null||e==null?!1:e.every(r=>yh(t,r))}function D(t){if(t==null)return[];let e=O(t);return e.every(tr)?e:e.filter(tr)}function Qi(t){let e=O(t).filter(r=>!en(f(r)));return Zn(e[0])?e.map(r=>f(r).trim()):e}function V(t){return O(t).map(e=>f(e).trim()).filter(e=>e.length>0)}function X(t){return zs(D(t),e=>F(e))}function zs(t,e=r=>F(r)){if(N(t))return[];let r=new Map;for(let n of t)if(n!=null){let i=e(n);i!=null&&it(r,i,()=>n)}return[...r.values()]}function wt(t,e){return t.reduce((r,n,i)=>r+(e(n,i)?1:0),0)}function Qn(t,e){if(t==null||e==null)return 0;if(t===e||(typeof t=="string"&&(t=t.split("")),typeof e=="string"&&(e=e.split("")),Us(t,e)))return t.length;let r=0;for(;t[r]===e[r];)r++;return r}function Zi(t,e,r=n=>n){return Ws(t,e,1,r)}function Ws(t,e,r=1,n=i=>i){let i=[];if(t<e)for(let o=t;o<e;o+=r)i.push(n(o));else for(let o=t;o>e;o-=r)i.push(n(o));return i}function wu(t,e){let r=new Set(e);return t.filter(n=>!r.has(n))}function Su(t){return t!=null?t[t.length-1]:void 0}function u(t,e){return new Mu(t,e).asMemoizedThunk()}var Mu=class{constructor(e,r){this.thunk=e;this.ttlMs=r;this.lastSet=0;this.listeners=[]}asMemoizedThunk(){let e=this.apply.bind(this);return e.set=this.set.bind(this),e.clear=this.clear.bind(this),e.unset=this.unset.bind(this),e.prior=this.prior.bind(this),e.refresh=this.refresh.bind(this),e.ttl=this.ttl.bind(this),e.setTTL=this.setTTL.bind(this),e.onChange=this.onChange.bind(this),e.toJSON=this.toJSON.bind(this),e.lastSetAgoMs=this.lastSetAgoMs.bind(this),e}async onSetResult(e,r){if(N(this.listeners))return;let n=await e,i=await r;if(!Hi(n,i))for(let o of this.listeners)o(i,n)}setResult(e){return this.lastSet=Date.now(),this.onSetResult(this.result,e),this.result=e}apply(){return(this.lastSet===0||this.ttlMs!=null&&this.lastSet+this.ttlMs<=Date.now())&&this.setResult(this.thunk()),this.result}set(e){return this.setResult(e)}unset(){this.setResult(void 0),this.lastSet=0}clear(){let e=this.result;return this.unset(),e}prior(){return this.result}refresh(){return this.setResult(this.thunk())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=e}onChange(e){this.listeners.push(e),p(this.result,e)}toJSON(){return"(Lazy)"}lastSetAgoMs(){return Date.now()-this.lastSet}};var w=1e3,A=60*w,js=60*A,$i=24*js,Jv=7*$i,Yv=365.25*$i,Xv=u(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));function nn(t){return t instanceof Date}function Pu(t,e){return new Date(v(e,new Date).getTime()-t)}function St(t){let e=nn(t)?t.getTime():le(t)?t:Date.now();return Math.floor(e/w)}function Mr(t){let e=String(t);return e.length>=2?e:("0"+e).slice(-2)}function Eu(t){let e=nn(t)?t:new Date(t);return e.getFullYear()+Mr(e.getMonth()+1)+Mr(e.getDate())+Mr(e.getHours())+Mr(e.getMinutes())+Mr(e.getSeconds())}function eo(t){let e=nn(t)?t:new Date(t);return e.getFullYear()+"-"+Mr(e.getMonth()+1)+"-"+Mr(e.getDate())}function we(t){if(en(t))return"";let e=t instanceof Error?X(Qi([f(t.name).trim(),he(t.code,r=>`code ${r.trim()}`),f(t.message).trim()])).join(": "):f(t);return pt(e,255)}function Vt(t){return t==null?"(undefined)":[we(t),...O(Gs(t.stack))].join(`
`)}function Gs(t){return M(t)?void 0:f(t).split(`
`).slice(0,6)}function to(t){if(M(t))throw new Error("undefined error");if(t instanceof Error)return t;if(Array.isArray(t)){let e=t[0];return e instanceof Error?(t.length>1&&(e.errors=t.slice(1)),e):new Error(t.map(r=>f(r)).filter(x).join(", "))}else{let e=we(t),r=e.indexOf(":");if(r>2&&r<15){let n=new Error(e.slice(r+1).trim());return n.name=e.slice(0,r).trim(),n}else return new Error(e)}}function ro(t){return t instanceof Error}async function T(t,e){let r=await t;return r==null?void 0:e(r)}async function $n(t,e){let r=[];for(let n of O(await t))if(n!=null){let i=await n;if(i!=null){let o=await e(i);o!=null&&r.push(o)}}return r}async function _u(t,e=console.dir.bind(console)){let r=await t;return await e(r),r}function ge(...t){let e=Object.freeze(t),r={};for(let a of e)r[a]=a;let n=a=>a!=null&&e.includes(a),i=a=>a==null?-1:e.indexOf(a),o=(a,m)=>n(a)?a:nt(m),s=(a,m)=>n(a)?m(a):void 0;return d(d({},r),{values:e,length:e.length,has:n,indexOf:i,validOrElse:o,mapValid:s})}function z(t,e){return r=>`[${t}m${r}[${e}m`}var ux=z(30,39),no=z(31,39),io=z(32,39),on=z(33,39),oo=z(34,39),so=z(35,39),ao=z(36,39),mx=z(37,39),sn=z(90,39),Lu=z(91,39),cx=z(92,39),Au=z(93,39),Ou=z(94,39),fx=z(95,39),px=z(96,39),dx=z(97,39),Ru=z(40,49),hx=z(41,49),gx=z(42,49),yx=z(43,49),bx=z(44,49),Tx=z(45,49),vx=z(46,49),xx=z(47,49),wx=z(100,49),Sx=z(101,49),Mx=z(102,49),Px=z(103,49),Ex=z(104,49),_x=z(105,49),Lx=z(106,49),Ax=z(107,49);var Fu=g(require("process"));function Xe(t,e){return e!=null?e(t):typeof t=="string"?console.log(t):console.dir(t,{depth:3}),t}function nr(t){return t==null||typeof t!="object"?[]:Object.keys(t).filter(e=>typeof e=="string"&&(t.propertyIsEnumerable==null||t.propertyIsEnumerable(e)===!0))}function dt(t){return nr(t).map(e=>t[e])}function Ze(t){return nr(t).map(e=>[e,t[e]])}function Ne(t,e){return typeof e!="object"&&(e={}),D(t).reduce((r,[n,i])=>Xe(r,()=>{n!=null&&i!=null&&(r[n]=i)}),e)}function lo(t){if(t==null)return;let e=Ze(t).filter(([r,n])=>r!=null&&n!=null);return N(e)?void 0:Ne(e)}function qs(t){if(t==null)return;let e=Ze(t).filter(([r,n])=>r!=null&&x(n));return N(e)?void 0:Ne(e)}function ei(t,...e){if(t==null)return t;if(!e.every(n=>typeof n=="string"))throw new Error("bad keys: "+F(e));if(N(e))return{};let r={};for(let n of e){let i=t[n];i!=null&&(r[n]=i)}return r}function ir(t,...e){if(t==null||e.every(n=>M(t[n])))return t;let r=Ze(t).filter(([n])=>!e.includes(n));return N(r)?void 0:Ne(r)}function bh(t){return dt(t).every(e=>e!=null)}function Iu(t){return t.filter(bh)}function Ks(t,e,...r){return t!=null&&Y(t[e])?t[e].bind(t)(...r):void 0}function Du(t,e){if(M(e))return;if(t[e]!=null)return t[e];let r=e.toLocaleLowerCase().normalize();for(let n of nr(t))if(r===n.toLocaleLowerCase().normalize()&&t[n]!=null)return t[n]}function Cs(t){return typeof t=="boolean"}function B(t){if(typeof t=="boolean")return t;if(t==null)return!1;if(t===1)return!0;let e=String(t).toLowerCase();return["true","1"].includes(e)}function ku(t){return B(t)?!0:Mt(t)?!1:void 0}function Mt(t){if(typeof t=="boolean")return!t;if(t==null)return!1;if(t===0)return!0;let e=String(t).toLowerCase();return["false","0"].includes(e)}function ye(t){return Du(Fu.env,t)}function Pr(t){return B(ye(t))}var Vu=g(require("process"));var an=g(require("process"));function Th(){switch(f(an.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return an.argv.some(t=>t.endsWith("mocha")||t.endsWith(".spec.js"))?"test":"production"}}var ln=(()=>{let t=Th();return an.env.NODE_ENV=t,t})();var pe=ln==="test",un=ln==="production";function ti(){return pe&&B(an.env.SINGLE_SPEC_TESTS)}var Nu=Date.now();var Er="PhotoStructure",_r=u(()=>Er+(un?"":`-${ln}`));var vh=ge("main","web","sync","sync-file","info","test","logcat","logtail","list","billing");var xh=["main","test"];function Uu(t){switch(t){case"main":case"web":return A;case"sync":case"sync-file":default:return 10*w}}var Bt="";function Hs(){if(M(Bt))throw Error("serviceName() is unset");return Bt}function zu(t){if(!pe&&t!==Bt&&Bt!=="")throw new Error("Cannot set service name twice");Bt=t,ht.unset(),Bu()}var wh=u(()=>[{re:/sync-file|billing/,f:ao},{re:/sync/,f:oo},{re:/web/,f:io},{re:/db/,f:so},{re:/main/,f:on},{re:/info/,f:Ou},{re:/test/,f:no}]),ht=u(()=>V([Bt,f(Vu.pid)]).join("-"));function Wu(t){let e=wh().find(r=>t.match(r.re));return e!=null?Ru(e.f(t)):t}function Js(){return Bt===vh.main}function ju(){return xh.includes(Hs())}function Sh(){return Bt==="sync"}function Mh(){return Bt==="sync-file"}var ow=u(()=>Sh()||pe&&!Mh());var Af=g(require("os")),In=g(require("path"));var Ph=ge("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),Ys=Ph.values,uw=ge("s480","s240","s120","s60");var Gu=u(()=>new Intl.NumberFormat),yw=u(()=>Vs(Gu().format(1111),"1","").charAt(0)),bw=u(()=>Vs(Gu().format(1.1),"1","").charAt(0));var Xs=1e3,Zs=Xs*1e3,ri=Zs*1e3,Tw=ri*1e3,Eh=1024,Lr=Eh*1024,_h=Lr*1024,vw=_h*1024;var xw=ge("tiny","small","medium","large","original");var Mn=g(require("fs")),mi=g(require("fs-extra")),at=g(require("path")),Nm=g(require("zlib"));var Ah=g(require("util"));var Lh=require("deep-eql");function ot(t,e){return Lh(t,e)}async function Qs(t,e){return au(await t,await e,ot,()=>!1)}function uo(t,e){if(t!=null)for(let r of D(t)){let n=e(r);if(n!=null)return n}}function qu(t,e){for(let r=t.length-1;r>=0;r--)if(e(t[r]))return t[r]}function Ku(t,...e){let r=t.length;return Ye(t,n=>e.every(i=>!ot(n,i))),r!==t.length}function Cu(t,e=r=>F(r)){Bs(zs(t,e),t)}function Hu(t,e){return t.reduce((r,n)=>r.concat(...D(e(n))),[])}function $s(...t){let e=Math.max(...t.map(r=>r.length));return Fe(e,r=>t.map(n=>n[r]))}function Ju(t){return Oh(t,e=>e.valueOf())}function Yu(t){return t[Rh(t)]}function Rh(t){return Xu(t,e=>e.valueOf())}function Oh(t,e){return Zu(t,e,(r,n)=>xr(r,n))}function Xu(t,e){return Zu(t,e,(r,n)=>iu(r,n))}function mn(t,e){return t[Xu(t,e)]}function Zu(t,e,r){if(N(t))return-1;let n=-1,i;for(let o=0;o<t.length;o++){let s=t[o];if(s!=null){let a=e(s);a!=null&&(i==null||r(a,i)===!0)&&(n=o,i=a)}}return n}function be(t){return Qu(t,!0)}function cn(t){return Qu(t,!1)}function Qu(t,e){return new Promise(r=>{if(t<=0)r();else{let n=setTimeout(()=>r(),Math.ceil(t+.5));e&&n.unref!=null&&Y(n.unref)&&n.unref()}})}function q(t,e=1){return setTimeout(t,Math.max(1,Math.ceil(e)))}var eS=require("he"),ni={};function mo(t,e){if(e<1)return"";for(ni[t]==null&&(ni[t]=t);e>ni[t].length;)ni[t]+=t;return ni[t].substring(0,e)}function fn(t,e,r){if(r.length===0)throw new Error("leftPad() given empty pad");if(typeof t=="number"&&t<0)return"-"+fn(String(-t),e-1,r);let n=String(t);return mo(r,e-n.length)+n}function $u(t,e,r){if(r.length===0)throw new Error("rightPad() given empty pad");let n=String(t);return n+mo(r,e-n.length)}function co(t){return fn(t,2,"0")}function em(t,e,r,n){return t.substr(0,e)+mo(n,r)+t.substr(e+r)}function fo(t,e,r){let n=Math.min(Math.ceil(t.length/e),v(r,()=>t.length))-1;return n<=0?[t]:[...Fe(n,i=>t.slice(i*e,(i+1)*e)),t.slice(n*e)]}function tm(t,e){let r=e.exec(t);if(r==null||r[1]==null)return;let n=r[0].indexOf(r[1])+r.index;return{captured:r[1],uncaptured:t.substring(0,n)+t.substring(n+r[1].length),unmatched:t.substring(0,r.index)+t.substring(r.index+r[0].length),matchedIndex:n}}function Oe(t,e){let r=f(t),n=f(e);return n.length>0&&r.startsWith(n)?r.slice(n.length):r}function or(t,e){if(e==null)return t;let r=f(t),n=f(e);return n.length>0&&r.endsWith(n)?r.slice(0,-n.length):r}function rm(t,e,r){return e==null?or(t,r):(t=f(t),t.endsWith(r)&&t.startsWith(e)?t.slice(e.length,-r.length):t)}function nm(t,e=80,r=80){let n=f(t),i=n.length-(e+r);return i<=0?n:n.slice(0,e).trim()+" \u2026(+"+i+" chars)\u2026"+n.slice(-r).trim()}function ea(t,e){return t.localeCompare(e,void 0,{sensitivity:"base"})}function se(t,e){if(t==null||e==null)return!1;let r=f(t),n=f(e);return r.length!==n.length?!1:r===n||r.toLowerCase()===n.toLowerCase()?!0:r.localeCompare(n,void 0,{sensitivity:"base"})===0||ea(r.normalize(),n.normalize())===0}function ta(t){return t.sort(ea)}function im(t,e){return O(t).filter(r=>r!=null).map((r,n)=>({item:r,cmp:p(e(r,n),i=>[i,n])})).filter(r=>r.cmp!=null).sort((r,n)=>{let i=ea(r.cmp[0],n.cmp[0]);return i!==0?i:xt(r.cmp[1],n.cmp[1])}).map(r=>r.item)}function Ih(t,e){return t==null||e==null||e.length===0||t.length===0?!1:se(t.substring(0,e.length),e)}function om(t,e){return N(t)||M(e)?!1:t.some(r=>se(e,r))}function pn(t){return f(t).replace(/\u001b\[[0-9;]+[a-z]/gi,"")}var Dh=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function sm(t){return Dh.reduce((e,[r,n])=>e.replace(r,n),t).normalize()}function ra(t){return f(t).normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function am(t){return f(t).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")}function lm(t){let e=ta(V(t)),r=e.filter((n,i)=>!Ih(e[i+1],n));return $(r,n=>t.indexOf(n))}function um(...t){for(let e of t){let r=e();if(r!=null)return r}}function Ee(t,e){try{return t()}catch(r){return e!=null?e(r):void 0}}function ii(t){return t}function po(t,e){let r={};for(let n of nr(t)){let i=e(n,t[n]);i!=null&&(r[n]=i)}return r}var oi=class{constructor(e){this.id=e;this._state="pending";this.promise=new Promise((r,n)=>{this._resolve=r,this._reject=n})}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve(),r=>this.reject(r)),this}observeQuietly(e){return e.then(()=>this.resolve(),()=>this.resolve()),this}get pending(){return this._state==="pending"}get settled(){return!this.pending}get resolved(){return this._state==="resolved"}get rejected(){return this._state==="rejected"}get state(){return this._state}then(e,r){return this.promise.then(e,r)}};var ym=g(require("util"));var si=class{constructor(e){this.maxLength=e;this._length=0;this._firstIndex=0;if(e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...Fe(e,()=>null))}mapIndex(e,r){return e=Math.trunc(e)??0,e<0&&(e+=this._length),e<0||e>this._length-1?void 0:r((e+this._firstIndex+this.maxLength)%this.maxLength)}item(e){return this.mapIndex(e,r=>this.store[r])}set(e,r){return this.mapIndex(e,n=>this.store[n]=r)}get length(){return this._length}set length(e){this._length=ue(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){let e=this;function*r(){for(let n=0;n<e.length;n++)yield e.mapIndex(n,i=>e.store[i])}return r()}push(...e){for(let r of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,n=>{this.store[n]=r});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(let r of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,n=>{this.store[n]=r,this._firstIndex=n});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}shiftOrFirst(){return this.length>1?this.shift():this.item(0)}every(e){for(let r=0;r<this._length;r++)if(!e(this.item(r),r))return!1;return!0}some(e){for(let r=0;r<this._length;r++)if(e(this.item(r),r))return!0;return!1}forEach(e){for(let r=0;r<this._length;r++)e(this.item(r),r)}map(e){let r=[];for(let n=0;n<this._length;n++)r.push(e(this.item(n),n));return r}reduce(e,r){let n=r;for(let i=0;i<this._length;i++)n=e(n,this.item(i),i);return n}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,r=>{this.mapIndex(this._length-1-e,n=>{let i=this.store[n];this.store[n]=this.store[r],this.store[r]=i})});return this}toA(){return[...this]}slice(e,r){return[...this].slice(e,r)}};var dn=class{constructor(){this.m=new Map}incr(e,r=1){let n=this.get(e)+r;return n===0?this.m.delete(e):this.m.set(e,n),this}get(e){return v(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){let e=new je(0);for(let r of this.keys())if(le(r))e.push(r);else return;return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){let e=this.keyAvg();return $([...this.entries()],([r,n])=>[-n,Ns(e,i=>Math.abs(r-i),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(r=>r[0])}get averageCounts(){return Xe(new je(this.size),e=>[...this.m.values()].forEach(r=>e.push(r)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return rr([...this.keys()]).map(e=>e+" "+this.get(e)).join(`
`)}};function mm(...t){return t.find(G)}function cm(t,e){return ks(t,r=>r>=0?e(r):void 0)}function ho(t,e){return Xi(t,r=>r>=0?e(r):void 0)}function Pt(t,e){return ks(t,r=>r>0?e(r):void 0)}function hn(t,e,r){return r==null||!le(r)?!1:([t,e]=[Math.min(t,e),Math.max(t,e)],gu(r,t)&&du(r,e))}function fm(t){return t instanceof Set?t:new Set(O(t))}function go(t,e){return new Set([...t,...e])}function na(t,e){let r=fm(e);return new Set([...t].filter(n=>r.has(n)))}function pm(t,e){let r=fm(e);return new Set([...t].filter(n=>!r.has(n)))}function dm(t){let e;for(let r of t)r!=null&&(e==null||r<e)&&(e=r);return e}function yo(t){return O(t).reduce((e,r)=>le(r)?e+r:e,0)}function Ar(t){let e=D(O(t));return N(e)?void 0:e.reduce((r,n,i)=>i===0?n:r*i/(i+1)+n/(i+1),0)}function hm(t){let e=O(t);return p(Ar(e),r=>{let n=(e.length-1)/2,i=yo(e.map((s,a)=>(s-r)*(a-n))),o=yo(e.map(s=>(s-r)**2));return o===0?0:i/o})}function kh(t){return p(Ar(t),e=>Ar(t.map(r=>Math.pow(r-e,2))))}function gm(t){return p(kh(t),e=>Math.sqrt(e))}function ai(t){let e;for(let r of t)e=e==null?r:(e+r)/2;return e??NaN}var je=class{constructor(e=20){this.maxSamples=e;this._n=0,this._samples=new si(e)}static merge(e,r){if(e.n===0&&r.n===0)return new je(Math.max(e.maxSamples,r.maxSamples));if(e.n===0)return r.clone();if(r.n===0)return e.clone();if(e.n<=e.maxSamples){let n=r.clone();return n.pushAll(e.samples),n}else if(r.n<=r.maxSamples){let n=e.clone();return n.pushAll(r.samples),n}else{let n=new je(Math.max(e.maxSamples,r.maxSamples));n._n=e.n+r.n,n._avg=e._avg*e.n/n.n+r._avg*r.n/n.n,n._min=Math.min(e._min,r._min),n._max=Math.max(e._max,r._max),n._m=e._m*e.n/n.n+r._m*r.n/n.n,n._s=e._s*e.n/n.n+r._s*r.n/n.n;let i=xe($s(e.samples,r.samples));return n._samples.push(...i),n._weightedTotalAvg=ai([n._avg,...i]),n}}[ym.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=this._min==null?e:Math.min(e,this._min),this._max=this._max==null?e:Math.max(e,this._max),this._n===1||this._m==null||this._s==null||this._avg==null||this._weightedTotalAvg==null)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{let r=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-r)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return Xe(new je(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){return e.forEach(r=>this.push(r)),this}stats(e=2){let r=i=>p(i,o=>ft(o,e)),n={};return this.empty||(n.sum=r(this.sum),n.mean=r(this.avg),n.sd=r(this.stdDev)),n.k=ft(this.n,e),n}get empty(){return this._n===0}get n(){return this._n}get avg(){return this.empty?void 0:ft(this._avg,4)}get sum(){return this._avg==null||this.empty?0:this._avg*this._n}get max(){return this._max}get min(){return this._min}get p84(){return Pt(this.avg,e=>Pt(this.stdDev,r=>e+r))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return p(this.variance,Math.sqrt)}get sampleMode(){return p(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;let r=new dn;return this._samples.forEach(n=>r.incr(n)),r.topKeys(e)}get sampleStdDev(){return Pe(this._samples,gm)}get sampleAvg(){return Pe(this._samples,Ar)}get sampleSlope(){return v(Pe(this._samples,hm),0)}get samples(){return[...this._samples]}p(e){if(this._samples.length===0)return 0;let r=[...this._samples].sort((i,o)=>i-o),n=Math.floor(r.length*(e/100));return r[n]}get weightedSampleAvg(){return Pe(this._samples,e=>ft(ai(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}};var yn=g(require("os"));var Tm=g(require("events"));var bm=g(require("events")),ia=class extends bm.EventEmitter{constructor(){super(...arguments);this.events=[]}emit(e,...r){return super.emit(e,...r),this.events.push({name:e,args:r}),!0}clear(){this.events.length=0}};var nM=u(()=>new ia),Fh=u(()=>{let t=new Tm.EventEmitter;return t.setMaxListeners(50),t}),Ut=Fh();function ee(t){Ut.on("clearCache",t)}function sr(t){Ut.emit("fileChanged",t)}function oa(t,e){Ut.emit("fileCopied",t,e)}function gn(t){Ut.on("fileChanged",t)}function vm(){Ut.emit("volumesChanged")}q(()=>{ee(()=>{sa.unset(),aa.unset(),ar.unset(),xm.unset(),la.unset(),Nh.unset(),Vh.unset()})});var sa=u(()=>((0,yn.freemem)()*2+(0,yn.totalmem)())/3),aa=u(()=>(0,yn.cpus)().length),ar=u(()=>{let t=1*ri,e=Math.max(1,Math.floor(sa()/t)),r=y.cpuLoadPercent.valueOrDefault/100*aa();return ue(1,e,Math.floor(r))}),xm=u(()=>{let t=500*Zs,e=Math.floor(sa()/t),r=Math.max(1,Math.floor(1.5*aa()*(y.cpuLoadPercent.valueOrDefault/100)));return ue(1,r,e)}),la=u(()=>ue(1,24,ar())),Nh=u(()=>ue(1,6,Math.ceil(xm()/la()))),Vh=la;var pa=g(require("timers")),Pm=g(require("util"));var zt=ge("pending","resolved","rejected");var Wt="\xB9",Or="\xB2",bo="\xB3",ua="\u2074";var wm="\u2076",ma="\u2077";function Sm(t,...e){return t+e.filter(r=>r!=null&&!t.includes(r)).join("")}var Bh=/[â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g;function ca(t){return t.replace(Bh,"")}function Uh(t){return we(t).includes(ua)}var zh=[bo,"0 output files created","BatchCluster has ended, cannot enqueue","called while not idle","Can't set headers after they are sent","debugger attached","debugger listening on","diskutil: interrupted","ECONNRESET","end() called before task completed","EPIPE","for help","Format error in file","https://nodejs.org/en/docs/inspector","Invalid data found when processing input","Missing expected status message","net::ERR_","onExit(exit) called end()","This socket has been ended by the other party","Unexpected error while trimming","Warning"].map(t=>t.toLowerCase());function Ve(t){if(t==null)return!0;let e=we(t).toLowerCase(),r=zh.some(n=>e.includes(n));return me()||!Uh(t)&&!Et(t)&&r}function Wh(t){return we(t).match(/SQLITE_CONSTRAINT|constraint failed/i)!=null}function fa(t){return!Et(t)&&!we(t).includes(Or)&&!Wh(t)&&!Mt(t.retriable)}function Mm(t){return!fa(t)}var jh=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+Wt,"i");function Et(t){return t==null?!1:B(t.fatal)?!0:jh.exec(we(t))!=null}var To=g(require("timers"));function bn(t,e,...r){return Xe((0,To.setTimeout)(t,Math.round(e),...r),n=>n.unref())}function lr(t,e,...r){return Xe((0,To.setInterval)(t,Math.round(e),...r),n=>n.unref())}var jt=class{constructor(e){this.name=e;this.start=Date.now();this.state=zt.pending;this.promise=new Promise((r,n)=>{this._resolve=r,this._reject=n}),this.logger=P("Deferred("+this.toString()+")")}toString(){return Zn(this.name)?this.name:F(this.name)}[Pm.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(r=>{this.resolve(r)}).catch(r=>{this.logger.warn("observeQuietly.reject()",r),this.resolve(void 0)}),this}observe(e){return e.then(r=>{this.maybeResolve(r)}).catch(r=>{this.maybeReject(r)}),this}setTimeout(e){return p(this.priorTimeout,pa.clearTimeout),this.priorTimeout=bn(()=>{if(this.pending){let r="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(r)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===zt.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==zt.pending}get resolved(){return this.state===zt.resolved}get rejected(){return this.state===zt.rejected}get settledMs(){return this.end==null?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=zt.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(Ve(e)?"info":"warn",".reject()",e);let r=to(e);return this.settle(()=>{this._error=r,this.state=zt.rejected,this._reject(r)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(r=>e(r))}settle(e){if(this.state===zt.pending){p(this.priorTimeout,pa.clearTimeout),e(),this.end=Date.now();let r=this.settledMs;if(this.resolved&&r>5e3){let n=r>5e3?"info":"debug";this.logger.log(n,"Completed in "+r+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}};var _t=class{constructor(){this._pushCount=0;this.lastPushTs=0;this._arr=[];this.nextSettledLatches=[];this.serialLatencyAvg=new je;this.applyListeners=[]}get arr(){return Ye(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}onApply(e){this.applyListeners.push(e)}_emitApply(e){for(let r of this.applyListeners)r(e)}push(e,r){return this._emitApply(e),this._push(e,r)}_push(e,r){this._pushCount++,this.lastPushTs=Date.now();let n=Y(r)?r():r;return this.arr.push(new jt(e).observeQuietly(n).finally(()=>this.emitSettled())),n}emitSettled(){for(let e of this.nextSettledLatches)e.resolve();this.nextSettledLatches.length=0}awaitNextSettled(){let e=new oi;return this.nextSettledLatches.push(e),e}serial(e,r){let n=Date.now();return this._push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-n),this._emitApply(e),r())))}serialByName(e,r){let n=Date.now();return this._push(e,this.awaitAllByName(e).then(()=>(this.serialLatencyAvg.push(Date.now()-n),this._emitApply(e),r())))}oneRunAtATime(e,r){return this.pending?this.awaitAll():this.serial(e,r)}maybeRun(e,r){return this.maybeRunConcurrent(e,r,1)}maybeRunConcurrent(e,r,n=ar()){return this.pendingCount>=n?void 0:this.push(e,r)}get pendingCount(){return wt(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return this.arr.length===0}async awaitAll(){for(let e of[...this.arr])await e.promise}async awaitAllByName(e){for(let r of[...this.arr])r.name===e&&await r.promise}async pushAll({name:e,laters:r,maxConcurrent:n=ar()}){n=ue(1,ar()*2,n);let i=[];for(let o of r){for(;this.pendingCount>=n;)await this.awaitNextSettled();i.push(this.push(e,o))}return Promise.all(i)}};async function ur({name:t,laters:e,maxConcurrent:r}){return new _t().pushAll({name:t,laters:e,maxConcurrent:r})}async function Em(t){let e=await t;return Y(e)?e():e}async function Se(t,e,r=()=>{},n=()=>{}){let i=!1,o=!1,s;return await Promise.race([Em(t).then(a=>{if(!o)return s=a,i=!0,a}),be(e).then(()=>{i||(o=!0)})]),i?await n(s):await r(),s}function _m(t,e){return Promise.race([t.then(()=>!0),be(e).then(()=>!1)]).catch(()=>!1)}async function Lm(t){return await t!=null}async function vo(t){let e=D(t);Q(e)&&await Promise.all(e)}async function da(t){let e=[];for(let r of O(await t)){let n=await r;if(n!=null)if(Array.isArray(n))for(let i of n){let o=await i;o!=null&&e.push(o)}else e.push(n)}return e}async function ha(t){let e=D(await t);return N(e)?[]:D(await Promise.all(e))}async function ga(t,e,r){if(t==null)return[];let n=D(await t);return N(n)?[]:(await ur({name:"thenCollectParallel",laters:n.map((o,s)=>async()=>[await e(o,s),o]),maxConcurrent:r})).filter(([o,s])=>o!=null&&s!=null)}async function Am(t,e,r){return(await ga(t,e,r)).map(n=>n[0])}async function Tn(t,e,r){return(await ga(D(t),e,r)).filter(([i])=>i).map(([,i])=>i)}var oP=30*w;async function Ge(t,e=!0){if(t==null)return e;let r=await t;return r==null?e:!B(r)}async function Qe(t,e,r){let n=await t;if(n==null)return r();let i=await e(n);return i??r()}async function li(t,e,r,n){let i=await t;if(i==null)return n();let o=await e;if(o==null)return n();let s=await r(i,o);return s??n()}async function Lt(t,e){return v(await t,e)}async function ya(t,e){return $(await ga(t,e),r=>r[0]).map(r=>r[1])}var Om=g(require("fs")),ui=g(require("os")),Gt=g(require("process"));var xo=(0,ui.platform)(),pP=Gt.default.argv.includes("--inspect")||B(Gt.default.env.NODE_INSPECT),dP=!f(__filename).includes("Platform"),_=xo==="win32"||xo==="cygwin",Rm=_&&x(Gt.default.env.PORTABLE_EXECUTABLE_DIR),K=xo==="darwin",Te=xo==="linux",hP=Te&&(0,ui.arch)()==="x64",Gh=(0,ui.arch)()==="arm",qh=Te&&Gh,gP=Te&&(x(Gt.default.env.APPIMAGE)||x(Gt.default.env.APPDIR)),yP=Te&&x(Gt.default.env.SNAP_USER_DATA),vn=K||Te,Kh="PS_IS_ELECTRON",Ch="PS_IS_DOCKER",xn=Gt.default.versions.electron!=null||B(Gt.default.env[Kh]);function ce(){return Te&&(Pr(Ch)||Pr("PS_DOCKER"))}var bP=u(()=>qh&&f(Hh()).startsWith("Raspberry Pi")),Hh=u(()=>{try{return Te?p((0,Om.readFileSync)("/proc/device-tree/model"),f):void 0}catch{return}});var Be=15*w,Rr=5*A,H=35*w,st=7*w,Im=1*js,Dm=w/(2*Lr);var wo=25*w;var wn=g(require("stream")),km=g(require("util"));async function Sn(t){t!=null&&(Ee(()=>Ks(t,"unref")),me()?t.end(null):await new Promise(e=>t.end(null,e)),await be(50),Ee(()=>Ks(t,"destroy")))}function Fm(t){for(let e of[t?.stdin,t?.stdout,t?.stderr])try{e?.destroy()}catch{}}var Ir=(0,km.promisify)(wn.pipeline);var ba=class extends wn.Transform{constructor(e){super({transform:(r,n,i)=>{this.onProgress(this.bytes+=r.length),i(r)}});this.onProgress=e;this.bytes=0}};var Ta=at.default.posix;function lt(t){return M(t)||at.default.sep===Ta.sep||Ta.sep===at.default.sep?t:t.split(at.default.sep).join(Ta.sep)}var Vm=/^([A-Z]:)[\\/]?(.*)$/i;function Yh(t){let e=Vm.exec(t);return e!=null?e[1].toUpperCase()+"\\"+e[2]:t}function At(...t){let e=at.default.join(...t);return at.default.resolve(_?Yh(e):e)}var Xh=/(\.(?:gz|z|7z|xz|bz2))$/i;function qt(t){let e=tm(t,Xh),r=at.default.parse(v(e?.uncaptured,t));return d(d({},r),e==null?{}:{ext:r.ext+e.captured,base:r.base+e.captured})}function So(t,e){return x(t)&&x(e)&&(t===e||t.startsWith(We(e,at.default.sep)))}function Dr(t){return Oe(t,at.default.sep).split(at.default.sep)}function Mo(t,e){return t.nativePath===e.nativePath?"":Oe(lt(e.nativePath),We(lt(t.nativePath),"/"))}var Zh=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function gt(t){return re(f(t).match(Zh),e=>e[1],()=>t).toLowerCase().normalize()}function Pn(t){if(M(t))return!1;try{return Mn.default.statSync(t).isDirectory()}catch{return!1}}async function ci(t){if(!M(t))try{return await Se(mi.default.stat(t),Be)}catch{return}}async function Bm(t){return Qe(ci(t),e=>e.isDirectory(),()=>!1)}async function Um(t){if(M(t))return!1;try{return await ci(t)!=null}catch{return!1}}async function Po(t,e=wo){if(M(t))return!1;try{let r=await Se(ci(t),e);return r==null||!r.isDirectory()?!1:await _m(mi.default.access(t,Mn.default.constants.R_OK|(_?0:Mn.default.constants.X_OK)),e)}catch{return!1}}function va(t){return t.startsWith("\\\\")}function zm(t){return vn&&t.startsWith("/")||_&&(va(t)||t.match(Vm)!=null)}var Qh=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});function Wm(t){return t==null||t.isFile()&&t.size===0}async function Eo(t){let e=d(d({},Qh),t),r=qt(e.nativePath);await mi.default.mkdirp(r.dir);{let n=await ci(e.nativePath);if(!e.requireNumber&&(n==null||e.emptyIsNew&&Wm(n)))return e.nativePath}for(let n=e.startIndex;n<=e.maxVersions;n++){let i=at.default.join(r.dir,`${r.name}-${fn(n,e.leftPad,"0")}${r.ext}`),o=await ci(i);if(o==null||e.emptyIsNew&&Wm(o))return i}throw new Error("There are already more than "+e.maxVersions+" of "+e.nativePath)}async function jm(t){if(t.endsWith(".gz"))return t;let e=t+".gz";return await Ir([Mn.default.createReadStream(t),(0,Nm.createGzip)(),Mn.default.createWriteStream(e)]),await mi.default.unlink(t),e}var Gm=g(require("os")),qm=g(require("path"));var yt=u(()=>{let t=[];_?t.push(ye("USERPROFILE")):t.push(ye("HOME"));for(let e of V(t)){let r=(0,qm.resolve)(e);if(Pn(r))return r}return(0,Gm.homedir)()});function xa(){if(ce()&&Pn("/ps/cache"))return"/ps/cache";if(_){for(let t of V([ye("TEMP"),ye("LOCALAPPDATA")]))if(Pn(t))return At(t,_r())}if(K){let t=At(yt(),"Library","Caches");if(Pn(t))return At(t,_r())}return At(yt(),".cache",_r().toLowerCase())}var wa=g(require("path"));var Km=g(require("fs")),Cm=g(require("fs-extra")),_o=g(require("path")),Hm=g(require("process"));var En=u(()=>{let t=[Hm.env.PS_CONFIG_DIR,ce()?"/ps/config":void 0];_&&(t.push(ye("APPDATA")),t.push((0,_o.resolve)(yt(),"AppData","Roaming"))),K&&t.push((0,_o.resolve)(yt(),"Library","Application Support")),!K&&vn&&t.push(ye("XDG_DATA_HOME"),ye("XDG_CONFIG_HOME"),(0,_o.resolve)(yt(),".config"));let e=V(t);for(let r of e)try{if((0,Km.statSync)(r).isDirectory())return r}catch{}for(let r of e)try{return(0,Cm.mkdirpSync)(r),r}catch{console.error("Failed to mkdirp "+r)}throw new Error("Cannot determine appData"+Wt)});function Jm(){return ce()?"/ps/logs":K?(0,wa.resolve)(yt(),"Library","Logs",Er.toLowerCase()):$h()}function $h(){return(0,wa.resolve)(En(),Er.toLowerCase(),"logs")}var Ot="1.0.0-alpha.1";var bE=new Date(1615764034e3);var eg=()=>Ot.includes("-alpha"),tg=()=>Ot.includes("-beta"),Ym=()=>eg()?"alpha":tg()?"beta":"latest";var wf=g(require("path"));var $o=g(require("batch-cluster"));async function Lo(t,{timeoutMs:e,timeBetweenMs:r,acceptable:n,timeoutResult:i,unref:o}){let s=e==null?void 0:e+Date.now();for(;s==null||Date.now()<s;){let a=Date.now(),m=await t();if(m==null||(Y(n)?!n(m):m===!1)){let c=Date.now()-a,h=v(r,()=>ue(100,5e3,c*Xn(4,10)));await(Mt(o)?cn(h):be(h))}else return m}return i}async function ut(t,e){return Lo(t,d(d({},e),{acceptable:r=>B(r),timeoutResult:!1}))}var df=g(require("process"));var Kt=class{constructor(e,r,n,i,o){this.name=e;this._isEnded=i;this.endTimeoutMs=o;this.onEnds=[];this._ended=!1;this.logger=P(e),this.onEnds.push(r),fi(n,this)}get ended(){return re(this._isEnded,e=>e(),()=>!1)||this._ended}end(){if(!this._ended)return this._ended=!0,vo(this.onEnds.map(e=>e()))}};var Xa=g(require("child_process")),Za=g(require("process"));async function Ao(t,e){let r;return Promise.race([t().then(n=>{if(r==null)return r=!0,n}),be(e).then(()=>{if(r==null)throw r=!1,new Error("timeout")})])}function mr(t,e){let r=G(e.timeoutMs)?()=>Ao(t,e.timeoutMs):t;if(e.maxRetries<=0)return r();let n=I(e.onRetryWaitUntil).getOrElse(()=>s=>be((e.retryDelay??250)*v(s,1))),i=0,o=async()=>{try{return await r()}catch(s){if(await e.errorIsRetriable?.(s)===!1||i>e.maxRetries)throw s;return i++,await n(i),o()}};return o()}var Xm=g(require("util"));var Sa=class{constructor(e,r){this.ttlMs=e;this.maxLength=r;this.times=[];this.a=[]}[Symbol.iterator](){this.vacuum();let e=[...this.a];function*r(){for(let n of e)yield n}return r()}push(...e){Fe(e.length,()=>this.times.push(Date.now())),this.a.push(...e),this.maxLength!=null&&this.vacuum()}pushUniq(...e){e.forEach(r=>{this.includes(r)||this.push(r)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(this.a.length===0)return;if(this.maxLength!=null){let n=this.a.length-this.maxLength;this.times.splice(0,n),this.a.splice(0,n)}let e=Date.now()-this.ttlMs,r=this.times.findIndex(n=>n>e);r===-1?this.clear():r>0&&(this.times.splice(0,r),this.a.splice(0,r))}};var _n=class{constructor(e){this.ttlMs=e;this._eventCount=0;this._lastEventTime=0;if(e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new Sa(e)}[Xm.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){let e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return Pt(this.eventDeltas.length,()=>ai(this.eventDeltas))}get msPerEvent(){return Ar(this.eventDeltas)}get eventsPerMs(){return ho(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return ho(this.eventsPerMs,e=>ft(w*e,3))}get eventsPerMinute(){return ho(this.eventsPerMs,e=>ft(A*e,3))}};var $E=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}});var rg=Date.now(),Oo=u(()=>P("Error")),Zm=new _n(A),Pa=new _n(A);function Qm(t,e){return e.exec(we(t))!=null}function ng(){let t=Date.now()>rg+y.probationMs.valueOrDefault,e=pu(Pa.eventsPerMinute,y.fatalErrorRatePerMinute.valueOrDefault);return Oo().tap({level:"info",msg:"isFatalErrorAllowed()",result:Js()&&t&&e,meta:{mainService:Js(),postProbation:t,lowErrorRate:e,fatalErrorRatePerMin:Pa.eventsPerMinute,errorRatePerMin:Zm.eventsPerMinute,fatalErrorRatePerMinuteSetting:y.fatalErrorRatePerMinute.valueOrDefault}})}function $m(){let t={};return Error.captureStackTrace(t,$m),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)}function fe(t,e,r){if(M(t)&&e==null){Oo().warn("onError() with empty args",$m());return}let n=we(t)+we(e)+we(r),i=Et(e)||Et(n)||B(r?.fatal);if(!i&&Ve(n)){Oo().info("onError(): (ignorable): "+Vt(e),d({message:t},r));return}p(Ma(),s=>s.writeRecentLogEntries()),Zm.onEvent(),i&&Pa.onEvent();let o=!i||ng()?"nonFatal":"fatal";Oo().log(o==="fatal"?"error":"warn","onError(): "+Vt(e),d({event:o,message:t},v(r,{}))),me()||Ut.emit(o,{message:t,error:e})}var Yc=g(require("child_process")),xi=g(require("process"));var ec=g(require("util"));function Ln(t){return t==null?[]:Object.keys(t)}var cr=class{constructor(e,r){this.maxSize=e;this.clearEveryMs=r;this.setsSinceLastSpill=0;this.expireListeners=[];if(e<1)throw new Error("maxSize must be positive");if(e>3e4)throw new Error("maxSize is too big");this.clear(),G(r)&&(this.clearInterval=lr(()=>{this.spill()},Je(r/2)))}spill(){if(this.priorCache!=null&&this.currentCache!=null&&Q(this.expireListeners)){for(let e in this.priorCache)if(this.currentCache[e]==null){let r=this.priorCache[e];if(r!=null)for(let n of this.expireListeners)n(e,r)}}this.priorCache=this.currentCache??Object.create(null),this.currentCache=Object.create(null),this.setsSinceLastSpill=0}[ec.inspect.custom](){return d(d({},this.priorCache),this.currentCache)}end(){this.clearInterval!=null&&clearInterval(this.clearInterval)}clear(){return this.visit((e,r)=>{for(let n of this.expireListeners)n(e,r)}),this.currentCache=Object.create(null),this.priorCache=Object.create(null),this.setsSinceLastSpill=0,this}get size(){if(this.currentCache==null||this.priorCache==null)return 0;let e=0;for(let r of go(Ln(this.priorCache),Ln(this.currentCache)))this.has(r)&&e++;return e}has(e){return this.currentCache[e]!=null||this.priorCache[e]!=null}keys(){return X([...Ln(this.priorCache),...Ln(this.currentCache)]).filter(e=>this.currentCache[e]!=null)}delete(e){let r=this.currentCache[e];if(r!=null){this.currentCache[e]=void 0;for(let i of this.expireListeners)i(e,r)}let n=this.priorCache[e];if(n!=null&&(this.priorCache[e]=void 0,r==null))for(let i of this.expireListeners)i(e,n)}visit(e){for(let r of go(Ln(this.priorCache),Ln(this.currentCache))){let n=this.currentCache[r]??this.priorCache[r];n!=null&&e(r,n)}}deleteIf(e){for(let r of this.keys()){let n=v(this.currentCache[r],this.priorCache[r]);n!=null&&e(r,n)&&this.delete(r)}}get(e){return e=f(e),this.currentCache[e]??this.priorCache[e]}set(e,r){e=f(e),this.currentCache[e]==null&&(this.setsSinceLastSpill>=this.maxSize&&this.spill(),this.setsSinceLastSpill++),this.currentCache[e]=r}getOrSet(e,r){e=f(e);let n=this.get(e);if(n!=null)return n;let i=r();return this.set(e,i),i}on(e,r){this.expireListeners.push(r)}},kr=class{constructor(e){this.opts=e;this.uid=0;this.cacheSyncHits=0;this.cacheAsyncHits=0;this.cacheMisses=0;this.timeouts=0;this.cache=new cr(e.maxSize,e.clearEveryMs)}get size(){return this.cache.size}stats(){return{size:this.size,cacheSyncHits:this.cacheSyncHits,cacheAsyncHits:this.cacheAsyncHits,cacheMisses:this.cacheMisses,timeouts:this.timeouts}}get(e){let r=this.cache.get(e);return r==null||r.__uid!=null?void 0:r}clear(){this.cache.clear(),this.cacheSyncHits=0,this.cacheAsyncHits=0,this.cacheMisses=0,this.timeouts=0}deleteIf(e){for(let r of this.cache.keys())e(r)&&this.cache.delete(r)}async getOrSetAsync(e,r,n=1){e=f(e);{let a=this.get(e);if(a!=null)return this.cacheSyncHits++,a}let i=this.uid++,o=Date.now(),s=this.cache.getOrSet(e,()=>({__uid:i,__start:o}));if(s.__uid===i)return this.cacheMisses++,Se(r,this.opts.timeoutMs,()=>{this.timeouts++,this.cache.get(e)?.__uid===i&&this.cache.delete(e)},a=>{this.cache.set(e,a)});{let a=s.__start;if(a!=null){let c=a+this.opts.timeoutMs-Date.now();if(c>0){let h=Lo(()=>this.get(e),{timeoutMs:c});if(h!=null)return this.cacheAsyncHits++,h}}return n>0?this.getOrSetAsync(e,r,n-1):void 0}}};var qe=g(require("fs")),ie=g(require("fs-extra")),pr=g(require("path")),Dc=g(require("util")),Ur=g(require("zlib"));async function tc(t,e){return t==null||e==null?re(t,D,()=>[]):Tn(t,e)}async function rc(t,e){return t==null||e==null||await e(t)?t:void 0}var Ea=class{constructor(e,r){this.l=e;this.listener=r;this.ts=Date.now()}elapsed(e){let r=Date.now(),n=r-this.ts;this.ts=r,p(this.listener,i=>i(e,n)),n>2&&this.l.log(n>500?"warn":n>100?"info":"debug",e,{elapsedMs:n})}};async function Ro(t){let e=Date.now(),r=await t();return{elapsedMs:Date.now()-e,result:r}}async function nc(t){let e=Date.now(),r=await t;return{elapsedMs:Date.now()-e,result:r}}var ig=15,ic=class{constructor(){this.errors=new dn;this.times=new Map}async time(e,r,n){let i=Date.now();try{let o=await r(),s=Date.now()-i;return n!=null&&n(o,s),this.push(e,s),s>2*w&&P("time("+e+")").warn("slow",{elapsed:s}),o}catch(o){throw this.errors.incr(e),n!=null&&n(o,Date.now()-i),o}}get entriesBySumDesc(){return $([...this.times.entries()],([,e])=>-e.sum)}stats(e){let r=this.entriesBySumDesc.filter(([o])=>o.startsWith(e)),n=r.reduce((o,s)=>je.merge(s[1],o),new je),i=r.map(([o,s])=>[o,s.stats()]);return Ne([["merged",n.stats()],...i])}mkElapsed(e){return new Ea(e,(r,n)=>this.push(r,n))}push(e,r){r>ig&&it(this.times,e,()=>new je).push(r)}weightedAvg(e){return I(this.times.get(e)).map(r=>r.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[r,n])=>d(d({},e),{[r]:n.n}),{})}weightedAvgs(){return lo([...this.times.entries()].reduce((e,[r,n])=>d(d({},e),{[r]:Ds(n.weightedSampleAvg,Je)}),{}))}report(){return this.entriesBySumDesc.reduce((e,[r,n])=>d(d({},e),{[r]:d({sumSec:ft(n.sum/w,3)},ir(n.stats(),"sum"))}),{})}},og=u(()=>Xe(new ic,t=>new Kt("PromiseTimer",()=>{let e=P("PromiseTimer");e.info(`timings:
`,t.report()),Pe(t.errorCounts(),r=>e.warn(`error counts:
`,r))},Ue.service)));function pi(t,e,r){return og().time(t,e,r)}function oc(t,e,r){return u(async()=>pi(t,e),r)}var cc=g(require("crypto"));var _a=g(require("zlib"));function sc(t){return(0,_a.gunzipSync)(Buffer.from(t,"base64")).toString("utf8")}var ac=u(()=>sc("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").split(","));function uc(t){return lc(t.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}function lc(t){let e=t.indexOf("1");if(e===-1)return[t];{let r=t.substr(0,e),n=lc(t.substr(e+1));return xe(n.map(i=>[r+"l"+i,r+"i"+i]))}}var Fr=class{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return yo([...this.store.values()].map(e=>e.length))}add(e,...r){let n=it(this.store,e,()=>[]);return n.push(...r),n}set(e,r){this.store.set(e,r)}delete(e,r){if(r==null)return this.store.delete(e);{let n=this.store.get(e);if(n==null)return!1;{let i=Ku(n,r);return i&&n.length===0&&this.store.delete(e),i}}}clear(){return this.store.clear(),this}keys(){let e=this;function*r(){for(let[n,i]of e.store.entries())i.length>0&&(yield n)}return r()}values(){let e=this;function*r(){for(let[,n]of e.store.entries())n.length>0&&(yield n)}return r()}flatValues(){let e=this;function*r(){for(let[,n]of e.store.entries())if(n.length>0)for(let i of n)yield i}return r()}entriesArray(){return[...this.store.entries()].filter(([,e])=>Q(e))}entries(){let e=this;function*r(){for(let[n,i]of e.store.entries())i.length>0&&(yield[n,i])}return r()}tuples(){let e=this;function*r(){for(let[n,i]of e.store.entries())for(let o of O(i))o!=null&&(yield[n,o])}return r()}filterInPlace(e){let r=!1;for(let[n,i]of this.store.entries()){let o=i.length;Ye(i,s=>e(n,s)),r=r||o!==i.length}return r}};var sg=u(()=>mc(ac())),Io=3;function mc(t){let e=new Fr,r=[];for(let n of t)n.length<Io?r.push(n):e.add(n.slice(0,Io),n);return{trie:e,small:r}}function ag(t,e){let r=am(ra(t.toLowerCase().normalize())),{small:n,trie:i}=e==null?sg():mc(e);for(let o of[r.replace(/[^a-z]/gi,""),...uc(r)]){let s=n.find(a=>o.includes(a));if(s!=null)return s;for(let a=0;a<o.length-(Io-1);a++){let m=i.get(o.substr(a,Io));if(m!=null){let c=o.substr(a),h=m.find(E=>c.startsWith(E));if(h!=null)return h}}}}function lg(t){return ag(t)!=null}function di(t){let e=10,r="";do r=t();while(e-- >0&&lg(r.replace(/[^a-z]/gi,"")));return r}var fc=BigInt(0);function ug(t,e,r=0){if(!isFinite(e)||t<=1)return[];let n=[];if(e===0)n.push(0);else for(;e>0;)n.push(e%t),e=Math.floor(e/t);for(;n.length<r;)n.push(0);return n.reverse()}var fr=class{constructor(e,r,n=ii){this.name=e;this.numerals=r;this.decodePreparser=n;this.base=r.length}digitsToNumerals(e){return e.map(r=>this.numerals[r]).join("")}encode(e,r=0){if(!isFinite(e))return"";let n=e<0;return n&&(e=Math.abs(e),r--),(n?"-":"")+this.digitsToNumerals(ug(this.base,e,r))}encodeBigInt(e){if(typeof e!="bigint")throw new Error("bad input");if(e===fc)return this.numerals[0];let r=[],n=BigInt(this.base),i=e;for(;i>fc;)r.push(Number(i%n)),i=i/n;return this.digitsToNumerals(r.reverse())}encodeBuffer(e){if(e==null||e.length===0)return"";let r=[0];for(let n of e)for(r.forEach((i,o)=>{n+=i<<8,r[o]=n%this.base,n=Math.floor(n/this.base)});n>0;)r.push(n%this.base),n=Math.floor(n/this.base);return this.digitsToNumerals(r.reverse())}decode(e){return p(this.decodeBigInt(e),r=>{if(r>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(r)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(e==null||M(e))return;e=Y(this.decodePreparser)?this.decodePreparser(e):e;let r=e[0]==="-";r&&(e=e.slice(1));let n=BigInt(this.base),i=BigInt(0);for(let o of e){let s=this.numerals.indexOf(o);if(s<0)return;i=i*n+BigInt(s)}return r?BigInt(-1)*i:i}randomChars(e){return this.encodeBuffer((0,cc.randomBytes)(e+3)).slice(1,e+1)}safeRandomChars(e){return di(()=>this.randomChars(e))}randomUid(e=20,r=5,n="-"){return fo(this.randomChars(e),r).join(n)}safeRandomUid(e,r=5,n="-"){return di(()=>this.randomUid(e,r,n))}tokenEql(e,r,n){let i=this.normalizeToken(e),o=this.normalizeToken(r);return i.length>=n&&i===o}normalizeToken(e){return this.decodePreparser(e.trim()).split("").filter(r=>this.numerals.includes(r)).join("")}},k_=new fr("hex","0123456789abcdef",t=>t.toLowerCase()),Do=new fr("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),mg=new fr("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",t=>t.toLowerCase()),pc=new fr("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",t=>t.toLowerCase()),F_=new fr("TokenRadix","0123456789abcdefhjkmnpqrtuvwxy",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9")),N_=new fr("AlphaRadix","abcdefghjkmnpqrtuvwxyz"),V_=new fr("NumericRadix","0123456789",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9"));function hc(t,e){let r=t.toUpperCase().normalize(),n=e.toUpperCase().normalize();return um(()=>r===n?1:void 0,()=>M(t)!==M(e)?0:void 0,()=>t.length===1&&e.length===1?0:void 0,()=>{let i=dc(r),o=dc(n),s=cg(i,o).length;return 2*s/(i.length+o.length)})}function dc(t){return t==null||t.length===0?[]:t.slice(0,-1).split("").map((e,r)=>e+t[r+1])}function cg(t,e){let r=na(t,e),n=[];return r.forEach(i=>{let o=Math.min(wt(t,s=>s===i),wt(e,s=>s===i));Fe(o,()=>n.push(i))}),n}function gc(t){let e=t+`
`;return _?e.replace(Nt,`\r
`):e}function Ct(...t){return xe(t.map(e=>f(e).split(Nt)))}var Ec=g(require("fs")),gi=g(require("fs-extra")),Vr=g(require("path"));var On=g(require("fs-extra")),Ia=g(require("path"));var La=g(require("crypto")),yc=g(require("fs"));var bc=192;async function ko(t,e){let r=La.default.createHash("sha512"),n=0,i=v(e?.msbits,bc)/8;return await $n(t,o=>new Promise((s,a)=>{let m=yc.default.createReadStream(o,{autoClose:!0});m.on("error",c=>a(c)),m.on("data",c=>{n+=c.length,e?.observer?.onProgress(n),r.update(c)}),m.on("end",()=>s())})),r.digest().slice(0,i)}function fg(t,e=bc){return La.default.createHash("sha512").update(t).digest().slice(0,e/8)}function Aa(t,e=9,r=Do,n=224){return r.encodeBuffer(fg(t,n)).substring(0,e)}function Tc(t,e=24,r=pc,n=224){return Aa(t,e,r,n)}var xc=g(require("fs")),hi=g(require("fs-extra")),wc=g(require("util")),An=g(require("zlib"));function pg({message:t,cause:e,retriable:r,ignorable:n,fatal:i,doNotSend:o}){let s=[t];he(Oe(we(e),"Error: "),m=>s.push(m));let a=lm(V(s)).join(": ");return i=i||a.includes(Wt),r=(r||a.includes(ma))&&!a.includes(Or),o=o||!a.includes(ua),n=n||a.includes(bo),Sm(ca(a),i?Wt:void 0,o?wm:void 0,n&&!i?bo:void 0,!r&&!i?Or:void 0,r&&!i?ma:void 0)}var Nr=class extends Error{constructor({cause:e,message:r,retriable:n=!0,ignorable:i=!1,fatal:o=!1,doNotSend:s=!1}){super(pg({message:r,cause:e,retriable:n,ignorable:i,fatal:o,doNotSend:s}));this.cause=e,e!=null&&(this.stack=e.stack),this.retriable=n,this.fatal=o}};var vc=g(require("stream"));var Oa=class extends vc.Writable{constructor(e){super(e);this.deferred=new jt("WritableToBuffer");this._buf=[];this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",r=>{this.deferred.reject(r)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,r,n){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,r)),n()}};var dg=u(()=>P("zcat"));async function Sc(t,e){try{return T(Fo(t,e),f)}catch(r){dg().warn("zcat failed to read "+t,r);return}}async function Ra(t,e,r){if((await(0,hi.stat)(t)).size===0)return;let i=[],o=[(0,xc.createReadStream)(t,d({autoClose:!0},r)).on("error",s=>i.push(s))];if(t.toLowerCase().endsWith(".gz")?o.push((0,An.createGunzip)().on("error",s=>i.push(s))):t.toLowerCase().endsWith(".br")&&o.push((0,An.createBrotliDecompress)().on("error",s=>i.push(s))),o.push(e),await Ir(o),Q(i))throw new Nr({message:"zReadFile("+t+") failed",cause:i[0]})}async function Fo(t,e){if((await(0,hi.stat)(t)).size===0)return Buffer.from([]);let n=new Oa;return await Ra(t,n,e),await n.buffer}async function Mc(t){return JSON.parse((await Fo(t)).toString())}var hg=(0,wc.promisify)(An.gzip);async function Pc(t,e){let r=F(e),n=await hg(r);return(0,hi.outputFile)(t,n)}var gg="readdircache",yg=u(async()=>{let t=(0,Ia.join)(y.cacheDir.valueOrDefault,gg);return await(0,On.mkdirp)(t),t},A);async function bg(t){return(0,Ia.join)(await yg(),...fo(Tc(t)+".json.gz",2,3))}var Da=u(()=>P("Readdir"));function ka(t){return t!=null&&x(t.basename)&&Cs(t.isFile)&&Cs(t.isDirectory)}q(()=>{ee(()=>No.prior()?.clear()),gn(t=>{t==null?No.prior()?.clear():No.prior()?.deleteIf(e=>e.startsWith(t))})});var No=u(()=>new kr({maxSize:500,timeoutMs:H,clearEveryMs:A}));async function Fa(t){let e=await No().getOrSetAsync(t,()=>Tg(t));if(e==null)throw new Error("readdir() timeout for "+t);return e}async function Tg(t){let e=await bg(t);try{let i=(await(0,On.stat)(e)).mtimeMs;if(Date.now()-i<y.readdirCacheSeconds.valueOrDefault*w){let o;if(await ut(async()=>(o=await Mc(e),o!=null&&Array.isArray(o)&&o.every(ka)),{timeoutMs:H-w,timeBetweenMs:250}))return o}}catch(i){i.code!=="ENOENT"&&Da().debug("Failed to read from readdir cache",i)}let r=await nc((0,On.readdir)(t,{withFileTypes:!0})),n=im(r.result.map(i=>({basename:i.name,isFile:i.isFile(),isDirectory:i.isDirectory()})),i=>i.basename);if(r.elapsedMs>=500)try{await Pc(e,n),Da().debug("Wrote readdir cache for slow directory",{nativePath:t,elapsedMs:r.elapsedMs})}catch(i){Da().debug("Failed to write to readdir cache",i)}return n}var yi=class{constructor(e,r){this.base=e;ka(r)?(this.isFile=r.isFile,this.isDirectory=r.isDirectory):(this.isFile=r.isFile(),this.isDirectory=r.isDirectory()),r instanceof Ec.Stats&&(this.size=r.size,this.mtimeMs=r.mtimeMs)}},_c=u(()=>P("DirectoryEntry")),bt=class{constructor(e,r){this.dir=e;this.dirent=r;this.nativePath=(0,Vr.join)(this.dir,r.base),this.ext=qt(r.base).ext}static async for(e){let r=qt(e);try{let n=await(0,gi.stat)(e);return new bt(r.dir,new yi(r.base,n))}catch{return}}async join(...e){return bt.for((0,Vr.join)(this.nativePath,...e))}get base(){return this.dirent.base}get name(){return or(this.base,this.ext)}get pathnames(){return this.nativePath.split(Vr.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}get isRoot(){return this.dir===(0,Vr.parse)(this.dir).dir}parent(){let e=qt(this.dir);return e.dir===this.dir?this:new bt(e.dir,{base:e.base,isFile:!1,isDirectory:!0,mtimeMs:void 0,size:void 0})}async childNames(){try{return this.isDirectory()?(await Fa(this.nativePath)).map(e=>e.basename):void 0}catch(e){_c().warn("childNames() failed to readdir("+this.nativePath+")",e);return}}async children(){try{return this.isDirectory()?(await Fa(this.nativePath)).map(r=>new bt(this.nativePath,new yi(r.basename,r))):void 0}catch(e){_c().warn("children() failed to readdir("+this.nativePath+")",e);return}}async visitDescendantFiles(e){for(let r of O(await this.children()))await(r.isFile()?e(r):r.isDirectory()?r.visitDescendantFiles(e):void 0)}async filterDescendantFiles(e){let r=[];return await this.visitDescendantFiles(async n=>{await e(n)===!0&&r.push(n)}),r}stat(){return(0,gi.stat)(this.nativePath).catch(()=>{})}async size(){return Lt(this.dirent.size,()=>T(this.stat(),e=>e.size))}async mtimeMs(){return Lt(this.dirent.mtimeMs,()=>T(this.stat(),e=>e.mtimeMs))}unlink_(){return(0,gi.unlink)(this.nativePath)}};var vg=64,bi=class extends cr{constructor(){super(vg);q(()=>gn(e=>this.clearFromPath(e))),q(()=>ee(()=>this.clear())),this.on("expire",(e,r)=>r?.clear())}clearFromPath(e){M(e)?this.clear():this.visit((r,n)=>{r.startsWith(e)&&n.clear()})}};var Lc=g(require("stream"));var Na=class extends Lc.Transform{constructor(){super({objectMode:!1,autoDestroy:!0})}async _transform(e,r,n){let i=(f(this._prior)+f(e)).split(Nt),o=i.pop();this._prior=o===""?void 0:o;for(let s of i)this.push(s)||await be(1);n()}_flush(e){this._prior!=null&&this.push(this._prior),this._prior=void 0,e()}};var Vo=g(require("timers"));function xg(t){return t!=null&&x(t.path)&&x(t.op)&&hn(0,100,t.pct)}var wg="progress";function Va(t){xg(t)&&Ut.emit(wg,d(d({},t),{pct:Je(ue(0,100,t.pct))}))}function Ba(t,e,r=!1){let n=r?Date.now()+e:0,i=0,o=(...s)=>{let a=Date.now();if(a>=n)return n=a+e,i++,t(...s)};return o.count=()=>i,o}var Bo=500,Ua=class{constructor(e,r,n=Bo){this.context=e;this.total=r;this.throttleMs=n;this.start=Date.now();this.emit=Ba(()=>{Va(d(d({},this.context),{pct:this.pct,elapsedMs:this.elapsedMs}))},this.throttleMs,!0)}incrProgress(e){this.onProgress(e+v(this.current,0))}onProgress(e){this.current=ue(0,this.total,v(e,v(this.current,0)+1)),this.emit()}get pct(){return Je(100*v(this.current,0)/this.total)}get elapsedMs(){return Date.now()-this.start}},Uo=class{constructor(e,r,n,i=Bo){this.ctx=e;this.total=r;this.progress=n;this.throttleMs=i;this.start=Date.now();this.onInterval=Ba(()=>T(this.progress(),o=>this.emit(o)),this.throttleMs),this.timer=(0,Vo.setInterval)(()=>this.onInterval(),Bo)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){p(e,r=>Va(d(d({},this.ctx),{pct:100*ue(0,this.total,r)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>Bo&&this.emit(this.total),this.end()}end(){p(this.timer,e=>(0,Vo.clearInterval)(e)),this.timer=void 0}};var Br=g(require("path")),Rc=g(require("process"));var Ac=g(require("fs")),za=g(require("path"));function Oc(t){let e=[];for(;t!==(0,za.dirname)(t);)t=(0,za.dirname)(t),e.push(t);return e}function Sg(t){try{return(0,Ac.readdirSync)(t)}catch(e){return[]}}function zo(t,e){let r=Sg(t);return e.every(n=>r.includes(n))}var Wa=u(()=>(0,Br.dirname)(process.execPath)),Wo;(function(c){c.Root=u(()=>{let h=["icc","migrations","public","views"],E=[];ce()&&E.push("/ps/app"),xn&&E.push((0,Br.join)(Wa(),"resources"),(0,Br.join)(Wa(),"..","Resources")),E.push(...V([Wa(),(0,Rc.cwd)(),__dirname])),Cu(E);for(let b of E){if(zo(b,h))return b;for(let k of Oc(b).slice(0,4)){if(zo(k,h))return k;let U=(0,Br.join)(b,"node_modules","photostructure");if(zo(U,h))return U}}throw new Error("Failed to find project root. Looked in "+E)});let e=h=>u(()=>(0,Br.join)(c.Root(),h));c.Bin=e("bin"),c.ICC=e("icc"),c.Migrations=e("migrations"),c.Public=e("public"),c.Tools=e("tools"),c.Views=e("views");async function m(h=c.Root()){return K?new RegExp(`^\\/Volumes\\/${Er}[^\\/]*\\/${Er}.app\\/`,"i").exec(h)!=null:!1}c.isInDMG=m})(Wo||(Wo={}));function jo(t,e,r){let n=new Ic(e,r,!0);return n.read(t),n.done}var Ic=class{constructor(e,r,n=!0){this.sep=e;this.onData=r;this.filterBlanks=n;this.incompleteChunk="";this.done=new oi}onChunk(e){if(e==null)return;let n=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=n.pop(),n.forEach(i=>{(!this.filterBlanks||x(i))&&this.onData(i)})}clear(){this.onChunk(""),x(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",r=>this.onChunk(r)),e.on("end",()=>{this.clear(),this.done.resolve()}),this}};var kc=_?"wip-":".",ja=new bi,mt=class{constructor(e,r){this.dirent=r;this.bflog=u(()=>P("BaseFile("+this.nativePath+")"));this._childDirectoryEntries=u(()=>T(this.directoryEntry(),e=>e.children()));this.stat=u(()=>this.trap("stat",()=>ie.default.stat(this.nativePath).catch(()=>{})),mt.attrTTL);this.statSync=u(()=>this.trapSync("statSync",()=>Ee(()=>qe.default.statSync(this.nativePath))),mt.attrTTL);this.shaResult=u(async()=>{let e=await this.size();if(e===0||e==null)return;let r=e>5*Lr?new Ua({op:"Computing SHA of",path:this.nativePath},e):void 0,n=await Ro(()=>this.trap("sha",()=>ko([this.nativePath],{observer:r}))),i=p(n.result,o=>o.toString("base64"));return{elapsedMs:n.elapsedMs,buffer:n.result,b64:i}},mt.attrTTL);if(r!=null)this.nativePath=r.nativePath,this.dir=r.dir,this.base=r.base,this.name=r.name,this.ext=r.ext;else{this.nativePath=At(e);let n=qt(this.nativePath);this.dir=n.dir,this.base=n.base,this.name=n.name,this.ext=n.ext}this.posixPath=lt(this.nativePath),ja.set(e,this)}toJSON(){return{nativePath:this.nativePath}}[Dc.inspect.custom](){return this.toJSON()}static async withFastestAccess(e){let r=D(e),n=await Promise.all(r.map(i=>i.shaMs()));return r[Ju(n)]}static forPosix(e){return e instanceof mt?e:this.for(e.split("/").join(pr.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(e instanceof mt)return e;let n=ja.get(e);if(n!=null)return n;let i=At(e);return ja.getOrSet(i,()=>new mt(i,r))}static clear(e){sr(e)}for(e,r){return mt.for(e,r)}clear(){return this.dirent=void 0,this._childDirectoryEntries.unset(),this.stat.unset(),this.statSync.unset(),this.shaResult.unset(),this}clearThisAndParent(){return sr(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return e==null?!1:e instanceof mt?this.nativePath===e.nativePath:this.nativePath===mt.for(e).nativePath}get isUNC(){return va(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return Mo(e,this)}async directoryEntry(){return this.dirent==null&&(this.dirent=await T(this.stat(),e=>new bt(this.dir,new yi(this.base,e)))),this.dirent}async childDirectoryEntries(e){let r=await this._childDirectoryEntries();return r==null||e==null||N(r)?r:await Tn(r,e)}_directoryEntryChild(e){return this.for((0,pr.join)(this.nativePath,e.base),e)}childNames(){return T(this.childDirectoryEntries(),e=>e.map(r=>r.base))}async children(e){return(await this.childDirectoryEntries(e))?.map(r=>this._directoryEntryChild(r))}async childFiles(e){let r=[];for(let n of O(await this.childDirectoryEntries()))if(n.isFile()){let i=this._directoryEntryChild(n);(e==null||await e(i))&&r.push(i)}return r}async childDirectories(e){return T(this.childDirectoryEntries(),r=>ha(r.filter(n=>n.isDirectory()).map(async n=>rc(this._directoryEntryChild(n),e))))}childrenSync(){return v(this.trapSync("childrenSync",()=>qe.default.readdirSync(this.nativePath).map(e=>this.join(e))),[])}async hasChildren(e){let r=await this.childNames();return Q(e)?xu(r,e):Q(r)}async hasNoChildren(){return await this.isFile()||N(await this.childNames())}async visitDescendants(e){return T(this.children(),async r=>{for(let n of r)await n.visitDescendants(e),await e(n)})}async descendants(e){let r=[];for(let i of O(await this.childFiles()))await e(i)&&r.push(i);let n=await this.childDirectories();if(n!=null)return await ur({name:"descendants",laters:n.map(i=>()=>T(i.descendants(e),o=>r.push(...o)))}),r}async ancestorWithChildren(e){return await this.hasChildren(e)?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}async siblings(e){let r=this.parent();return(await this.siblingDirectoryEntries(e))?.map(n=>r._directoryEntryChild(n))}async siblingDirectoryEntries(e){return this.parent().childDirectoryEntries(async r=>r.base!==this.base&&(e==null||await e(r)))}async selfAndSiblings(){return this.parent().children()}async firstExistingSelfOrAncestor(){return this.isRoot||await this.exists()?this:this.parent().firstExistingSelfOrAncestor()}get pathnames(){return this.nativePath.split(pr.sep).filter(e=>e!=null&&e!=="")}get pathnamesWithoutDrive(){return _?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(_?1:0)}get isRoot(){return this.pathnames.length===(_?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return e!=null&&(this.nativePath===e.nativePath||vu(e.pathnames,this.pathnames))}isDescendantOf(e){return e!=null&&e.isAncestorOf(this)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){let e=this.parent();return this.isRoot?[]:[...e.parents(),e]}async normalize(){return this.isUNC?this:await this.exists()||this.isRoot?this:T(this.parent().normalize(),async e=>{let r=await e.childNames();if(Q(r)){for(let i of r)if(i===this.base)return e.join(i);let n=this.base.normalize();for(let i of r)if(i.normalize()===n)return e.join(i);if(K||_){for(let i of r)if(se(i,this.base))return e.join(i)}}})}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return N(e)||ot(["."],e)?this:zm(e[0])?this.for((0,pr.join)(...e)):this.for((0,pr.join)(this.nativePath,...e))}joinYMD(e=new Date){return su(e?.getFullYear(),e?.getMonth(),e?.getDate(),(r,n,i)=>this.join(f(r),co(n+1),co(i)))}child(...e){if(N(e))return this;let r=xe(e.map(n=>n.split(pr.sep))).filter(n=>n!=="..");return this.join(...r)}async trap(e,r,n="warn"){try{return await pi("fs."+e,r)}catch(i){this.bflog().log(n,`trap: ${e}() failed: ${i}`);return}}async trapOr(e,r,n="warn"){try{return this.bflog().trace(`trapOr ${e}()`),await r(),!0}catch(i){return this.bflog().log(n,`trapOr: ${e}() failed: ${i}`),!1}}trapSync(e,r){try{return this.bflog().trace(`trapSync ${e}()`),r()}catch(n){this.bflog().warn(`trapSync: ${e}() failed: ${n}`);return}}async exists(){return this.dirent!=null||await Lm(this.stat())}existsSync(){return this.dirent!=null||this.statSync()!=null}async notExists(){return Ge(this.exists())}mtime(){return T(this.stat(),e=>e.mtime)}mtimeMs(){return T(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return T(this.stat(),e=>St(e.mtime))}async lastModifiedUtc(){return T(this.stat(),e=>e.mtime.toUTCString())}statTimes(){return T(this.stat(),e=>X([e.birthtimeMs,e.mtimeMs,e.ctimeMs].filter(r=>r!=null&&r!==0)))}maxStatMs(){return T(this.statTimes(),Yu)}maxStatDate(){return T(this.maxStatMs(),e=>new Date(e))}minStatMs(){return T(this.statTimes(),dm)}minStatDate(){return T(this.minStatMs(),e=>new Date(e))}size(){return T(this.stat(),e=>e.size)}async access(e){try{return await ie.default.access(this.nativePath,e),!0}catch{return!1}}isExecutable(){return this.access(qe.default.constants.R_OK|(_?0:qe.default.constants.X_OK))}isReadable(){return this.access(qe.default.constants.R_OK)}isNotReadable(){return Ge(this.isReadable())}isReadWritable(){return this.access(qe.default.constants.R_OK|qe.default.constants.W_OK)}isNotReadWritable(){return Ge(this.isReadWritable())}isHiddenPosix(){return this.base.startsWith(".")}async isEmpty(e=0){if(await this.isDirectory())return Q(await this.childNames());{let r=await this.size();return r==null||r<=e}}isNonEmpty(e=1){return Ge(this.isEmpty(e))}async isNonEmptyFile(e=1){return await this.isFile()&&await this.isNonEmpty(e)}async modifiedGTE(e){return T(this.mtime(),r=>St(r)>=St(e))}async modifiedCloseTo(e,r){return T(this.mtimeMs(),n=>Math.abs(n-e)<=r)}async isRecent(e){let r=await this.maxStatMs();return r!=null&&r>Date.now()-e}async modifiedGT(e){if(e!=null)return T(this.mtime(),r=>St(r)>St(e))}async isDirectory(){return this.dirent!=null?this.dirent.isDirectory():Qe(this.stat(),e=>e.isDirectory(),()=>!1)}async isNotDirectory(){return Ge(this.isDirectory())}isDirectorySync(){return this.dirent!=null?this.dirent.isDirectory():re(this.statSync(),e=>e.isDirectory(),()=>!1)}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile(){return this.dirent!=null?this.dirent.isFile():this.stat().then(e=>I(e).map(r=>r.isFile()).getOrElse(()=>!1))}isFileSync(){return this.dirent!=null?this.dirent.isFile():I(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>ie.default.rmdir(this.nativePath),e)}async mkdirp_(){try{await ie.default.mkdirp(this.nativePath)}catch(e){if(e.code!=="EEXIST")throw e}if(await ut(()=>this.clear().isDirectory(),{timeoutMs:2*w,timeBetweenMs:200})===!1)throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return await this.clear().isDirectory()||this.isRoot?this:this.trap("mkdirp",async()=>this.mkdirp_())}mkdirpSync_(){return ie.default.mkdirpSync(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",()=>this.mkdirpSync_())}sha(){return T(this.shaResult(),e=>e.b64)}shaMs(){return T(this.shaResult(),e=>e.elapsedMs)}async writeStream_(e,r){return await Ir(D([e,p(r?.onProgress,n=>new ba(n)),ie.default.createWriteStream(this.nativePath,r)])),this.clearThisAndParent()}async writeJsonMaybe(e,r={}){return this.trap("writeJsonMaybe",()=>this.writeJSON_(e,r))}async writeJSON_(e,r={}){return await this.parent().mkdirp(),await ie.default.writeFile(this.nativePath,F(e,r.replacer,r.spaces),d({flag:"w"},r)),this.clearThisAndParent()}readJson(e="warn"){return this.trap("readJson",()=>mr(async()=>await this.isNonEmptyFile()?ie.default.readJson(this.nativePath):void 0,{maxRetries:1,onRetryWaitUntil:()=>cn(e==="warn"?250:25),errorIsRetriable:r=>r.errno!==-2}),e)}readJsonSync(){return this.trapSync("readJsonSync",()=>ie.default.readJsonSync(this.nativePath))}readFileSync_(){return ie.default.readFileSync(this.nativePath)}readFile_(){return ie.default.readFile(this.nativePath)}readFile(e="warn"){return this.trap("readFile",()=>this.readFile_(),e)}async zReadFile_(e){return Fo(this.nativePath,e)}async zcat(e){return this.trap("zcat",()=>T(this.zReadFile_(e),f))}async zCopyFile(e,r){return this.trap("zCopyFile",async()=>(await e.parent().mkdirp(),await Ra(this.nativePath,qe.default.createWriteStream(e.nativePath),r),e))}readLines(){return T(this.readFile(),e=>Ct(e.toString()))}readFileSync(){return Ee(()=>p(qe.default.readFileSync(this.nativePath),f))}writeTxt_(e){return this.writeFile_(gc(e))}async writeFile_(e){return await this.parent().mkdirp(),await ie.default.writeFile(this.nativePath,e),this.clearThisAndParent()}wip(e=kc){return this.sibling(e+this.base)}async unwip_(e=kc){let r=this.sibling(Oe(this.base,e));return this.mv_(r,{overwrite:!0})}async dest(e){let r=e.clear();return x(this.ext)&&M(r.ext)||await r.isDirectory()?r.join(this.base):r}copyFile_(e){return pi("fs.copyFile",async()=>{let r=(await this.dest(e)).clear();if(this.nativePath===r.nativePath)return this;if(await r.parent().mkdirp()==null)return this.bflog().throw("Cannot mkdirp "+r.dir);try{return await this._copyFile(r)}catch(i){if(Mm(i))throw i;return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:r.nativePath,error:i}),await this._nativeCopyFile(r)}finally{this.clearThisAndParent()}})}async _copyFile(e){let r,n,i=e;try{let o=await Lt(this.stat(),()=>this.clear().stat());if(o==null)return this.bflog().throw("Can't copy missing files"+Or);if(o.size===0)await e.touch(o.mtime,o.atime);else{if(y.verifyFileCopies.valueOrDefault&&await this.sha()==null)return this.bflog().throw("Can't copy file without SHA"+Or);n=e.wip();let s=ie.default.copyFile(this.nativePath,n.nativePath);o.size>5*Lr&&(r=new Uo({op:"Copying",path:this.nativePath,dest:e.nativePath},o.size,()=>n.clear().size())),await s;let a=await ut(async()=>o.size===await n.clear().size(),{timeoutMs:H});if(y.verifyFileCopies.valueOrDefault){let m=a&&await ut(()=>Qs(this.sha(),n.clear().sha()),{timeoutMs:H});if(!m)return this.bflog().throw("copyFile_() failed",{sizeMatches:a,shaMatches:m})}if(!a)return this.bflog().throw("copyFile_() failed",{expectedSize:o.size,actualSize:await n.clear().size()});if(i=await n.unwip_(),i==null)return this.bflog().throw("copyFile_("+e+") failed: .unwip() was null");await ie.default.utimes(i.nativePath,o.atime,o.mtime)}try{await ie.default.chmod(i.nativePath,o.mode)}catch(s){this.bflog().debug(`copyFile_(${i.nativePath}) warning: couldn't chmod to ${o.mode}: ${s}`)}return this.bflog().debug(`copyFile_(${e.nativePath}): success`),oa(this.nativePath,e.nativePath),e}catch(o){throw this.bflog().warn(`copyFile_(${n?.nativePath}) failed: ${o}`),await n?.unlink(),await e.unlink(),o}finally{p(r,o=>o.end())}}async copyTimeoutMs(){return Qe(this.size(),e=>Math.max(H,e*Dm),()=>H)}async _nativeCopyFile(e){let r;try{if(await e.parent().mkdirp()==null)return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});let n=await this.stat(),i=p(n,o=>o.size);return n==null||i==null?this.bflog().throw("Can't copy missing files"):(i>5*Lr&&(r=new Uo({op:"Copying",path:this.nativePath,dest:e.nativePath},i,()=>e.clear().size())),_?await te.instance().execute(`Copy-Item -LiteralPath ${Ti(this.nativePath)} -Destination ${Ti(e.nativePath)}`,o=>o):await W("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:await this.copyTimeoutMs()}),oa(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(n){return this.bflog().throw("_nativeCopyFile("+e+"): "+n)}finally{p(r,n=>n.end())}}async touch(e=Date.now(),r){return this.trap("touch",()=>T(this.ensureFile(),()=>this.utimes(e,r)))}async utimes(e,r){let n=v(e,Date.now()),i=v(r,n);return this.trap("utimes",()=>ie.default.utimes(this.nativePath,St(i),St(n)).then(()=>this.clearThisAndParent()))}async unlink(e="warn"){return this.trap("unlink",async()=>(await ie.default.unlink(this.nativePath),this.clearThisAndParent()),e)}async rmrf(e="info"){return this.trap("rmrf",async()=>(this.bflog().log(e,"rmrf()"),await ie.default.remove(this.nativePath),this.clearThisAndParent()))}async unlock(){return K&&await this.clear().exists()&&await W("chflags",["nouchg",this.nativePath],{timeout:H}),this}async renameWithNameSuffix_(e){return T(this.withNameSuffix(e).ensureNew_({emptyIsNew:!0}),r=>r.unlink("debug").then(()=>this.mv_(r)))}async mv_(e,r={overwrite:!1}){let n=await this.dest(e);if(this.nativePath===n.nativePath)return this.bflog().warn("mv(): no-op",new Error("internal error")),this;await n.parent().mkdirp(),this.bflog().debug("mv",n);try{await ie.default.move(this.nativePath,n.nativePath,r)}catch(i){this.bflog().warn("mv() try #1 failed. Calling unlock() and waiting for source to be non-empty.",i),await Promise.all([this.unlock(),n.unlock()]),await ut(()=>this.clear().isNonEmptyFile(),{timeoutMs:7*w}),await ie.default.move(this.nativePath,n.nativePath,r)}return await n.unlock(),this.clearThisAndParent(),n.clearThisAndParent()}async pipeTo(e,r){return this.trap("pipeTo("+e+")",async()=>{let n=await this.sibling(e).ensureNew_();return await Ir([qe.default.createReadStream(this.nativePath),r,qe.default.createWriteStream(n.nativePath)]),await this.unlink(),n})}async gunzip(){return this.pipeTo(or(this.base,".gz"),(0,Ur.createGunzip)())}async gzip(){return this.pipeTo(this.base+".gz",(0,Ur.createGzip)())}async compressBrotli(){return this.pipeTo(this.base+".br",(0,Ur.createBrotliCompress)())}ensureFile(){return this.trap("ensureFile",()=>ie.default.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync_(){return ie.default.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return gt(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get baseWithoutCountWithParent(){return this.parent().base+"/"+this.baseWithoutCount}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}async ensureNewNativePath(e){return Eo(d({nativePath:this.nativePath},e))}ensureNew_(e={}){return this.ensureNewNativePath(e).then(r=>this.for(r))}async renameYMDHMS_(e){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");let r=Eu(await Lt(this.mtime(),()=>new Date)),n=re(e,i=>this.parent().join(i),()=>this.parent());return this.mv_(n.join(this.name+"-"+r+this.ext),{overwrite:!0})}async saveIfNewOrDelete(e){if(await this.clear().isEmpty()){await this.unlink("trace");return}let r=await this.siblingWithSameContents();if(r!=null)return await this.unlink(),r;let n=await this.sibling(e).ensureNew_();return this.mv_(n)}async chmod(e){return await ie.default.chmod(this.nativePath,e),this.clear()}zreadline(){return qe.default.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe((0,Ur.createGunzip)()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)}).pipe(new Na)}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return pi("fs.childWithSameContents",async()=>{if(await this.notExists()||!await this.isDirectory())return;let r=await e.size(),n=await this.children(),i=[];for(let s of O(n))await s.size()===r&&!e.eql(s)&&i.push(s);if(N(i))return;let o=await e.sha();for(let s of i.sort((a,m)=>hc(a.base,m.base)).reverse())if(await s.sha()===o)return s})}async applyWip(e,r=0,n=15*w){let i=this.wip();try{if(await i.parent().mkdirp(),(await i.clear().isRecent(n)||await this.clear().isRecent(n))&&(this.bflog().info("applyWip(): recent WIP exists. Waiting for a bit to see if someone else will do my work."),await ut(()=>this.clear().isNonEmpty(r),{timeoutMs:n*2,timeBetweenMs:500}))){this.bflog().info("applyWip(): yay, someone else did my work.");return}await this.touch(),await i.unlink("trace");let o=await e(i);if(await ut(()=>i.clear().isNonEmptyFile(),{timeoutMs:w}))return await i.unwip_(),o;throw new Error("applyWip(): empty after apply for "+this)}catch(o){throw await i.unlink(),await this.unlink(),o}}async applyIfEmpty_(e,r=0){return await this.clear().isNonEmpty(r)?this.bflog().debug("applyIfEmpty(): non-empty"):(this.bflog().debug("applyIfEmpty(): empty, applying..."),await this.applyWip(e,r)),this.touch()}firstMatchingLine(e){let r=new jt("firstMatchingLine("+this+")"),n=qe.default.createReadStream(this.nativePath,{flags:"r"});return n.on("error",i=>{i.errno===-2||i.code==="ENOENT"?(r.maybeResolve(void 0),n.close()):r.maybeReject(i)}),n.on("close",()=>r.maybeResolve(void 0)),jo(n,Nt,i=>{let o=e.exec(i);o!=null&&(r.maybeResolve(o),n.close())}),r.promise}contemporary(e,r){return li(this.statTimes(),e.statTimes(),(n,i)=>{for(let o of n)for(let s of i)if(yu(o,s,r))return!0;return!1},()=>!1)}},Re=mt;Re.attrTTL=3*A,Re.projectRoot=u(()=>{let e=Wo.Root();if(e==null)throw new Error("Cannot find project path");return mt.for(e)});function Go(t){let e=D(t).filter(([r,n])=>r!=null&&n!=null);return new Map(e)}function vi(t,e){return Go(D(t).map(e))}async function Fc(t,e){if(t==null)return new Map;let r=await Promise.all(D(O(t)).map(n=>e(n)));return Go(r)}var Rn=g(require("process"));function Nc(t){return f(t).replace(/[-.,\\^$*+?()|[\]{}]/g,"\\$&")}var Vc=class{constructor(e){this.h=e;this.text=v(e.text,f(e)),this.greedyLeft=v(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}},Ga=u(()=>P("Fixed"));function Ht(t,e,r=!0){return new Bc(t,e,r).entries}var Bc=class{constructor(e,r,n=!0){this.warnIfMissingHeaders=n;let i=r.split(/[\r\n]{1,2}/);this.headerRow=i[0],this.rows=i.slice(1);let o=Math.max(...this.rows.map(s=>s.length));this.col2blanks=new Map(Fe(o,s=>[s,wt(this.rows,a=>M(a[s]))])),this.headers=this.extractHeaders(e.map(s=>new Vc(s))),this.entries=this.rows.map(s=>this.headers.map(a=>a.toEntry(s))).map(s=>Ne(s)).filter(s=>dt(s).some(x))}extractHeaders(e){let r=this.headerRow;$(e,s=>-s.text.length),e.forEach(s=>{let a=new RegExp(`\\b${Nc(s.text)}\\b`,"i"),m=a.exec(r);m==null?this.warnIfMissingHeaders&&Ga().warn("extractHeaders(): Failed to find header!",{re:a,headerLine:r}):(s.indexOf=m.index,r=em(r,m.index,s.text.length," "))});let n=e.filter(s=>s.indexOf!=null),i=$(n,s=>s.indexOf);i.forEach((s,a)=>{let m=s.indexOf,c=i[a-1],h=a===0?0:c.indexOf+c.text.length-1,[E,b]=s.greedyLeft?[h,m]:[m,h];s.leftIdx=p(this.firstBlankColumn(E,b),k=>k+1),a===0&&s.leftIdx==null&&(s.leftIdx=0),s.leftIdx==null&&Ga().warn("no blank column for "+s.text+" between "+m+" and "+h)}),Ye(i,s=>s.leftIdx!=null),i.slice(0,-1).forEach((s,a)=>{let m=i[a+1];s.rightIdx=m.leftIdx-1});let o=O(pm(e.map(s=>s.text),i.map(s=>s.text)));return o.length>0&&Ga().warn("Missing headers",{missingHeaders:o}),i}firstBlankColumn(e,r){return Zi(e,r).find(n=>this.col2blanks.get(n)===this.rows.length)}};var qo=()=>"wmic",Uc=()=>"fsutil";var zc=()=>"ping";var Mg=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;function Wc(t){let e=Mg.exec(t);if(e==null)return;let r=e.slice(1,8).map(E=>j(E));if(!lu(r))return;let[n,i,o,s,a,m,c]=r,h=j(e[8],{defaultValue:0});return new Date(Date.UTC(n,i-1,o,s,a,m,c/1e3)-h*A)}var Pg=/Date\((\d+)\)/;function jc(t){return I(t).flatMap(e=>Pg.exec(e)).flatMap(e=>e[1]).flatMap(j).filter(e=>hn(0,Date.now()+$i,e)).map(e=>new Date(e)).get()}var Eg=u(()=>P("Ps"));function _g(t){return t!=null&&G(t.pid)&&t.start!=null&&x(t.cmd)}async function Gc(t){return T(Ko([t]),e=>O(e).find(r=>r.pid===t))}async function Ko(t){let e=O(t).filter(G);if(N(e))throw new Error("Invalid pids: "+F(t));return _u(T(_?Lg(e):Ag(e),r=>r.filter(n=>_g(n)&&e.includes(n.pid))),r=>Eg().debug("pidInfo()",{pids:e,result:r}))}function Og(t){return t.map(e=>({pid:e.Id,start:jc(e.StartTime),cmd:e.ProcessName}))}var Rg="Get-Process",Ig="| Select-Object -Property Id,ProcessName,StartTime";function qc(t){return X([...t.filter(G),Rn.default.pid]).join(",")}async function Lg(t){if(me()||te.instance().ended)return Dg(t);let e=[Rg,"-Id",qc(t),"-ErrorAction SilentlyContinue",Ig].join(" ");return T(te.instance().executeJsonToA(e),r=>Og(r))}var Kc={maxBuffer:1024*1024,timeout:15*w,ignoreExitCode:!0,ignoreStderr:!0},Cc=["CommandLine","CreationDate","ProcessId"];async function Dg(t){let e=["process"];if(Q(t)){let i=X([...t.filter(G),Rn.default.pid]).map(o=>`ProcessId=${o}`).join(" or ");e.push("where",i)}e.push("get",Cc.join(","));let r=await Rt(qo(),e,Kc),n=Iu(Ht(Cc,r.result).map(i=>({pid:j(i.ProcessId,{defaultValue:-1}),start:Wc(i.CreationDate),cmd:f(i.CommandLine)})));return n.find(i=>i.pid===Rn.default.pid)||n.push({pid:Rn.default.pid,start:new Date(Nu),cmd:"node "+Rn.default.title}),n}function kg(t){return Ht(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],t).map(e=>({pid:j(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:f(e.COMMAND)}))}async function Ag(t){let e=await Rt("ps",["-p",qc(t),"-wwwo","pid,lstart,command"],d(d({},Kc),{ignoreExitCode:!0}));return kg(e.result)}var Hc=g(require("path")),Jc=g(require("process"));function Co(){return tn(Jc.env.PS_CONFIG_DIR,()=>(0,Hc.resolve)(En(),_r().toLowerCase()))}var It=u(()=>P("Pids")),Fg=10*w;function Xc(t,e){if(t==null||e==null)return!1;let r=p(e.start,i=>i.getTime()),n=t.startTime;return G(r)&&G(n)&&Math.abs(r-n)<Fg}async function Ng(t,e){return t==null||e==null||t.name!==f(e.pid)?!1:Xc(await t.readJson(),e)}function Zc(t,e=!1){let r=["/PID",f(j(t)),"/T"];e&&r.push("/F"),Yc.default.execFile("taskkill",r)}async function Vg(t,e=!1){if(me()||te.instance().ended)return Zc(t,e);try{let r=D(["Stop-Process","-Id",j(t),e?"-Force":void 0]).join(" ");await te.instance().execute(r,ii)}catch(r){It().warn("killWin(): pwsh error, using TASKKILL: "+r),Zc(t,e)}}async function Bg(t,e=!1){try{xi.default.kill(t,e?"SIGKILL":"SIGTERM")}catch(r){if(!String(r).includes("ESRCH"))throw r}}function Ho(t,e=!1,r=!0){if(t===xi.default.pid||t===xi.default.ppid)throw new Error("cannot self-terminate");return e&&r&&dr.instance().onKill(t),_?Vg(t,e):Bg(t,e)}async function Jo(t){return await Gc(t)!=null}var qa=class{constructor(e=Re.for(Co()).join("pids")){this.pidsDir=e;this.p=new _t;this.recentPids=new cr(10*w);this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",async()=>{let r=v(e.everything,!1),n=v(e.force,_),i=await this.pidfiles(),o=await Fc(i,b=>T(b.readJson(),k=>[k.pid,k])),s=X(xe(O(o.values()).map(b=>[b.pid,b.ppid])));if(N(s))return It().debug("killOldProcs(): no pidfiles"),[];let a=await Ko(s);if(It().debug("killOldProcs()",{pids:s,allEntries:a}),a==null){fe("Pids.killOldProcs(): failed to get process information");return}let m=new Set(a.map(b=>b.pid)),c=a.filter(b=>o.has(b.pid)),h=$(D(c.map(b=>p(o.get(b.pid),k=>Xc(k,b)?d(d({},k),b):void 0))),b=>b.pid).filter(b=>xi.default.pid!==b.pid),E=r?h:h.filter(b=>!m.has(b.ppid)||!m.has(b.pid)||G(b.timeoutTime)&&Date.now()>=b.timeoutTime||e.everythingBefore!=null&&b.startTime<e.everythingBefore);It().debug("killOldProcs()",{trackedEntries:c,victims:E,pidfiles:O(o.values())});for(let b of E)It().debug("killOldProcs(): killing",{entry:b}),Ho(b.pid,n,!1);return await this.vacuumPids(),$(E,b=>b.pid)})}async addPid(e,r,n=!1){if(e==null)throw new Error("undefined info");let i=e.pid;if(!G(i))throw new Error("undefined pid");let o=e.ppid+":"+e.pid;return n&&this.recentPids.delete(o),this.recentPids.getOrSet(o,async()=>{let s=this.pidsDir.join(e.pid+".json"),a=I(Ee(()=>qt(e.cmd).base)).filter(x).getOrElse(()=>e.cmd),m=r.getTime(),c=Pt(e.maxAgeMs,E=>m+E),h=d(d({},e),{cmd:a,startTime:m,timeoutTime:c});return await s.writeJsonMaybe(h)==null?It().throw("Failed to write to "+s,{info:e,force:n}):(It().debug("addPid() wrote "+s,h),s)})}pidfiles(){return this.pidsDir.clear().children(e=>e.ext===".json"&&j(e.name)!=null)}async onKill(e){let r=this.pidsDir.join(e+".json");return T(r.clear().readJson(),n=>this.addPid(d(d({},n),{maxAgeMs:1}),Pu(A),!0).catch(i=>{It().info("onKill(): failed to rewrite pidfile: "+i,{pid:e})}))}async vacuumPids(){let e=await this.pidfiles(),r=O(e).map(i=>j(i.name)).filter(G);if(N(r))return;let n=await Ko(r);if(n==null){fe("Failed to get pidInfo for pids "+r);return}It().debug("vacuumPids",{pids:r,pidfiles:O(e).map(i=>i.base),entries:n});for(let i of e){let o=n.find(s=>f(s.pid)===i.name);(o==null||!await Ng(i,o))&&(It().debug("vacuumPids(): Removing old pidfile "+i.base,{psEntry:o,pidfile:await i.readFile().then(f).catch(s=>"(failed to read file: "+s+")")}),await i.unlink())}}},dr=qa;dr.instance=u(()=>new qa);function Yo(t,e){return dr.instance().addPid(t,e)}var iI=u(()=>{let t=[{everything:!1,force:!1,intervalMs:5*A},{everything:!1,force:!0,intervalMs:17*A}].map(e=>lr(()=>dr.instance().killOldProcs(e),e.intervalMs));return new Kt("ProcCleaner",()=>(t.map(clearInterval),dr.instance().killOldProcs()),Ue.predb)});var wi=ge("AboveNormal","Normal","BelowNormal","Idle"),Ka=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19});var Si=class{constructor(e){this.ttlMs=e;this.expireListeners=[];this.delegate=new Map;this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,r=this.ttlMs){return this.delegate.set(e,Date.now()+(r-this.ttlMs)),this}addIfMissing(e,r){let n=this.delegate.get(e);if(n==null||this.isEntryExpired(e,n))return this.add(e),r()}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(let[r,n]of this.delegate)this.isEntryExpired(r,n)||e(r,r,this)}has(e){return!this.isEntryExpired(e,this.delegate.get(e))}values(){let e=this;function*r(){for(let[n,i]of e.delegate.entries())e.isEntryExpired(n,i)||(yield n)}return r()}entries(){let e=this;function*r(){for(let[n,i]of e.delegate.entries())e.isEntryExpired(n,i)||(yield[n,n])}return r()}toA(){return this.vacuum(),[...this.delegate.keys()]}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}on(e,r){this.expireListeners.push(r)}isEntryExpired(e,r){return Xe(r==null||r+this.ttlMs<=Date.now(),n=>{r!=null&&n&&(this.expireListeners.forEach(i=>i(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,r)=>{this.isEntryExpired(r,e)})}};var Qc=u(()=>P("Renice"));q(()=>ee(()=>Ca.prior()?.clear()));var Ca=u(()=>new Si(A));async function Xo(t){if(Ca().has(t))return;Ca().add(t);let e=y.processPriority.valueOrDefault;return Pt(t,async()=>{try{await(_?Ug(t,e):zg(t,v(Ka[e],Ka.BelowNormal))),Qc().info("Renice pid "+t+" to "+e)}catch(r){Qc().info("Failed to renice pid "+t+"",r);return}})}async function Ug(t,e){return Pt(t,r=>wi.mapValid(e,n=>te.instance().execute(`(Get-Process -Id ${t}).PriorityClass = "${e}"`,i=>i)))}async function zg(t,e=19){return Rt("renice",[e,"-p",t].map(f),{timeout:10*w,isIgnorableError:()=>!0,ignoreExitCode:!0,maxRetries:0})}var sf=g(require("process"));var ef=g(require("process"));var Dt=class{constructor(e){this.a=e}async _map(e,r){let n=this.a!=null?await this.a():void 0,i=Ha(n)?await n.get():n;return i!=null?e(i):r()}async isDefined(){return this._map(()=>!0,()=>!1)}async isEmpty(){return this._map(()=>!1,()=>!0)}async get(){return this._map(e=>e,()=>{})}async getRequired(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}async exists(e){return this._map(e,()=>!1)}map(e){return new Dt(async()=>this._map(e,()=>{}))}flatMap(e){return new Dt(async()=>this._map(e,()=>{}))}filter(e){return new Dt(async()=>this._map(async r=>await e(r)?r:void 0,()=>{}))}catch(e){return new Dt(()=>this.get().catch(async r=>e(r)))}forEach(e){return new Dt(async()=>{let r=await this.get();return await p(r,e),r})}async getOrElse(e){return v(await this.get(),e)}orElse(e){return new Dt(async()=>{let r=await this.get(),n=r??await e();return Ha(n)?n.get():n})}};function Ha(t){return t instanceof Dt}function Jt(t){return Ha(t)?t:new Dt(()=>t)}var $c;(function(r){r.and=async(...n)=>{for(let i of n)if(!B(await i()))return!1;return!0},r.or=async(...n)=>{for(let i of n)if(B(await i()))return!0;return!1}})($c||($c={}));async function hr(...t){if(t!=null)for(let e of t){if(e==null)continue;let r=await e();if(r!=null)return r}}var tf="en",qI=u(async()=>Ja(await hr(()=>rf(),()=>_?Wg():void 0,()=>K?jg():void 0,()=>vn?Gg():void 0)));function rf(t=ef.default.env){return uu(t.LC_ALL,t.LC_MESSAGES,t.LANG,t.LANGUAGE)}var qg=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function Ja(t){if(M(t)||se("c",t)||se("posix",t))return tf;{let e=qg.exec(t);return e==null?tf:D([e[1],e[2]]).join("-")}}function Wg(){return T(te.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),t=>t.Name)}var nf={timeout:10*w};function jg(){return Jt(W("defaults",["read","-globalDomain","AppleLocale"],nf)).flatMap(Ja).get()}var Kg=/^([a-z_]+)\s*=\s*"(.+)"$/i;function Gg(){return Jt(W("locale",[],nf)).flatMap(t=>t.split(`
`).map(e=>p(e.match(Kg),r=>[r[1],r[2]]))).flatMap(Ne).flatMap(rf).flatMap(Ja).get()}function of(){return{LANG:"C",LC_ALL:"C"}}var iD=u(()=>new Set(dt(y).map(t=>t.key)));var lf=u(()=>Mi().filter(t=>t.hasValue()));function Cg(){lf.unset()}var uf=u(()=>{try{return new RegExp(y.sensitiveEnvRegExp.valueOrDefault,"i")}catch(t){return console.error(`Invalid setting for "sensitiveEnvRegExp": ${t}. Using default value.`),new RegExp(y.sensitiveEnvRegExp.defaultValue,"i")}});q(()=>{y.sensitiveEnvRegExp.addListener(()=>{uf.unset(),mf.unset()});for(let t of Mi())t.addListener(Cg)});var mf=u(()=>{let t=uf();return po(sf.default.env,(e,r)=>t.exec(e)!=null?void 0:r)});function Hg(){return lf().reduce((t,e)=>e.maybeAddToEnv(t),d(d({NODE_ENV:ln},ce()?{PS_IS_DOCKER:"1"}:{}),xn?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}))}function Ya(t){let e=v(t,{}),r=v(e.forceCLocale,!0);return d(d({},ir(e,"forceCLocale")),{env:Jg(e.env,r),detached:!1,shell:!1})}function Jg(t,e){let r=lo(d(d(d(d(d({},mf()),{PATH:af()}),e?of():{}),Hg()),v(t,{})));return y.logStdout.deleteFromEnv(r),y.tailLogs.deleteFromEnv(r),r}var _e=u(()=>P("ChildProcess"));function Zo(t){return ei(t,"pid","killed","connected","exitCode","signalCode")}function cf(t,e){return ut(()=>Ge(Jo(t)),{timeoutMs:e})}async function Pi(t,e=30*w){if(t==null)return!1;let r=t.pid;if(_e().debug("endProcess("+r+")",{killed:t.killed,connected:t.connected}),r<=0)return _e().warn("endProcess(): asked to end invalid pid",Zo(t)),!1;if(r===Za.default.pid)return _e().warn("endProcess(): asked to end MY pid",Zo(t)),!1;await cn(250),await Fm(t);{let n=t.kill();_e().debug("endProcess("+r+")",{killResult:n,childGotSigterm:t.killed}),n||await Ho(r).catch(i=>{_e().warn("endProcess(): kill("+r+",false) failed: "+i)})}if(Ee(()=>t.unref()),ti())return!0;if(await cf(r,e))return _e().debug("endProcess(): exitted",Zo(t)),!0;{dr.instance().onKill(r);let n=t.kill("SIGKILL");_e().warn("endProcess("+r+") had to resort to SIGKILL",{killResult:n}),n||await Ho(r,!0).catch(i=>{_e().warn("endProcess(): kill("+r+",true) failed: "+i)})}return cf(r,5e3)}function Yg(t,e){return t!=="renice"&&t!=="which"&&t!=="where"&&[t,...e].every(r=>!r.endsWith("web.js")&&!r.endsWith("db.js")&&!r.includes("sqlite3"))}function ff(t,e,r,n){let i=new Date,o=!1;t.on("exit",()=>o=!0);let s=Yg(e,r);return bn(async()=>{if(o)return;await ut(()=>G(t.pid),{timeoutMs:5*w});let a=t.pid;if(G(a))return s&&await Xo(a),Yo({pid:a,cmd:e,maxAgeMs:n,ppid:Za.default.pid},i);_e().info("newProc(): not writing pidfile, child_process has no pid",{cmd:e,cp:Zo(t)})},_?500:250),t}function pf(t,e,r,n){let i=Ya(n);return _e().debug("spawn()",{command:t,args:e,maxAgeMs:r,opts:i}),ff(Xa.default.spawn(t,e,i),t,e,r)}function Qa(t,e,r,n){let i=Ya(n);return ff(Xa.default.execFile(t,e,i),t,e,r)}async function Rt(t,e,r){return mr(()=>Xg(t,e,r),{timeoutMs:r.timeout,maxRetries:v(r.maxRetries,3),onRetryWaitUntil:n=>be(100*n),errorIsRetriable:n=>_e().tap({msg:"stdoutResult.errorIsRetriable()",result:Qm(n,/EPERM/),meta:{error:n,cmd:t,args:e}})})}async function Xg(t,e,r){let n=v(r.quiet,!1),i=v(r.ignoreStderr,!1),o=v(r.ignoreExitCode,!1),s=[];_e().debug("stdoutResult(): execFile",{cmd:t,args:e});let a=await Qa(t,e,r.timeout,ir(r,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(r.disconnect===!0)return a.disconnect(),{result:"",pid:a.pid};let m=F({cmd:t,args:e}),c=new jt(m);setTimeout(()=>{c.pending&&_e().warn("stdoutResult(): SLOW COMMAND",{cmd:t,args:e})},r.timeout/3).unref(),c.setTimeout(r.timeout);let h=(E,b)=>{if(Ve(b)||Y(r.isIgnorableError)&&r.isIgnorableError(b)){_e().debug("stdoutResult(): ignorable error for "+E,{cmd:t,args:e,opts:r,error:b});return}a.pid!=null&&Pi(a),n||_e().warn("stdoutResult(): "+E,{cmd:t,args:e,opts:r,error:b}),c.pending&&c.reject(b)};try{a.on("error",E=>h("on(error)",E)),a.on("close",E=>{let b=Date.now()-c.start,k=E!==0?"warn":"debug",U=s.join("");n||_e().log(k,"stdoutResult(): on(close)",{cmd:t,code:E,args:e,elapsedMs:b,result:nm(U,160,160)}),!o&&E!==0?c.reject(new Error("non-zero exit code: "+F({code:E,cmd:t,args:e}))):c.resolve({result:U,code:Ci(E),pid:a.pid})}),Sn(a.stdin),a.stdout?.on("data",E=>{E!=null&&s.push(E)}),a.stderr?.on("error",E=>h("stderr(error)",E)),a.stderr?.on("data",E=>i?_e().warn("stdoutResult(): stderr(data): "+f(E)):h("stderr(data)",E))}catch(E){h("try/catch",E)}return await c.promise}function W(t,e,r){return Rt(t,e,r).then(n=>n.result)}var $a=class extends Kt{constructor(e,r,n=Ue.service,i=!1){super(e,()=>this.t.end(),n,()=>this.t.ended,e==="sync-file"?H:w);this.name=e;this.t=r;r.on("childStart",o=>{this.logger.info("Started child process "+e+":"+o.pid),Xo(o.pid).catch(s=>this.onError("renice failed for "+e,s)),i&&o.on("exit",()=>Pi(o,5*w)),Yo({pid:o.pid,ppid:df.default.pid,cmd:e,maxAgeMs:r.options.maxProcAgeMillis+A},new Date).catch(s=>this.onError("addPid failed for "+e,s))}),r.on("startError",o=>{this.lastStartError=o,this.onError("failed to start",o)}),r.on("taskError",(o,s)=>{this.lastTaskError=o,this.onError("failed to run "+p(s,a=>a.command),o)}),r.on("internalError",o=>{this.lastInternalError=o,this.onError("internal error",o)}),r.on("endError",o=>{this.logger.error("observeBatchCluster.endError()",o)})}onError(e,r){!this.t.ended&&!me()&&!Ve(r)?fe(this.name+": "+e,r):this.logger.warn("onError() (ending or ignorable): "+e,r)}};var Qo=24;function zr(t,e=2){if(e<=0)return t;if(t!=null)return qi(t)?t:Array.isArray(t)?Zg(t):Ft(t)?t:ro(t)?d(d({},t),{stack:Gs(t.stack)}):ou(t)?po(t,(r,n)=>zr(n,e-1)):t}function Zg(t,e=zr){if(t!=null)return t.length<=Qo?t.map(e):[...t.slice(0,Qo).map(e),`\u2026 (${t.length} total items)`]}var Ke=ge("error","warn","info","debug","trace"),hf=Ne(Ke.values.map((t,e)=>[t,e]));function Ei(t){return hf[t]??hf.trace}var Qg=u(()=>Ke.values.filter(t=>t!==Ke.trace)),$g=48,el=u(()=>Ne(Qg().map(t=>[t,new si($g)])));function gf(){dt(el()).forEach(t=>t.clear())}function yf(t){el()[t.l]?.push(t)}function bf(){let t=[];for(let e of dt(el()))t.push(...e.toA());return $(t,e=>e.ts)}function Tf(t,e){return t>=e?"error":t>=e/2?"warn":t>=e/4?"info":"debug"}var ey=/^[a-z]*/i,_i=class{constructor(e,r){this.context=e;this.loggers=r;this.error=(e,r)=>{this.log("error",e,r)};this.warn=(e,r)=>{this.log("warn",e,r)};this.info=(e,r)=>{this.log("info",e,r)};this.debug=(e,r)=>{this.log("debug",e,r)};this.trace=(e,r)=>{this.log("trace",e,r)};this.filterContext=re(ey.exec(f(this.context)),n=>n[0],()=>this.context)}addContext(e){return new _i(this.context+e,this.loggers)}throw(e,r){let n=Et(e)||r?.fatal,o=!(r?.retriable===!1)&&fa(e),s=Ve(e)||r?.ignorable;r=r==null?void 0:zr(ir(r,"fatal","retriable","ignorable"));let a=new Nr({cause:to(e),message:V([this.context,r==null?void 0:F(r)]).join(" "),fatal:n,retriable:o,ignorable:s});throw this.log(s===!0?"warn":"error",Vt(e),r),a}tap(e){return this.log(v(e.level,"debug"),e.msg,d({result:e.result},e.meta)),e.result}log(e,r,n){if(n=zr(n),gr().enabled(e,this.context))for(let i of this.loggers())i.log(e,this.context,r,n);else e!=="trace"&&yf({ts:Date.now(),l:e,ctx:this.context,msg:r,meta:n})}async flush(){for(let e of this.loggers())await e.flush()}async end(){for(let e of this.loggers())await e.end()}};var ty=10*A,vf="{ready}",xf=" | ConvertTo-Json -Compress";function Ti(t){let e=t.replace(/['`"ââ#]/g,r=>"`"+r).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v");return'"'+e+'"'}function ry(){return[`function prompt {"${vf}"}`,...wr(y.powerShellCulture.valueOrDefault,t=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${t}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${t}'`],[])].join(";")}q(()=>ee(()=>te.instance.prior()?.clearMockResults()));var tl=class{constructor(){this.name="PowerShell";this.logger=P("PowerShell");this.mockResults=new Map;this.bco=new $a("PowerShell",new $o.BatchCluster({processFactory:()=>Qa("powershell",y.powerShellArgs.values,ty),logger:()=>P("PowerShell"),versionCommand:ry(),pass:vf,fail:"Error",exitCommand:"exit",maxProcs:ar()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:H,cleanupChildProcs:!1}),Ue.postdb),this.pwsh=this.bco.t}get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return T(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,r){this.pushMockResult(We(e,xf),r)}pushMockResult(e,r){this.mockResults.set(e,r)}clearMockResults(){this.mockResults.clear()}async execute(e,r){if(this.pwsh.ended||me()){this.logger.warn("execute() failed (ended)",{cmd:e});return}if(pe&&this.mockResults.has(e)){let n=this.mockResults.get(e);return r(n.stdout,n.stderr,n.passed)}try{this.logger.debug("execute()",{cmd:e});let n=await Ro(()=>this.pwsh.enqueueTask(new $o.Task(e,(i,o,s)=>r(p(i,a=>Oe(a,e)),o,s))));return this.logger.log(Tf(n.elapsedMs,7*w),"execute()",{cmd:e,elapsedMs:n.elapsedMs}),n.result}catch(n){this.logger.warn("execute() failed: "+n,{cmd:e});return}}async executeJson(e){let r=await this.execute(We(e,xf),(n,i,o)=>({stdout:n,stderr:i,passed:o}));if(r==null){this.logger.warn("executeJson(): null result",{cmd:e});return}if(M(r.stdout)||x(r.stderr)||!r.passed){this.logger.warn("executeJson(): failed result",d({cmd:e},r));return}try{return JSON.parse(r.stdout)}catch(n){let i=r.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:pt(r.stdout),after:pt(i)}),JSON.parse(i)}}async executeJsonToA(e){return T(this.executeJson(e),r=>Array.isArray(r)?r:[r])}},te=tl;te.instance=u(()=>{if(!_)throw new Error("PowerShell isn't available on this platform");return new tl});async function ny(){return _?te.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}var Sf=u(async()=>{if(_){let t=await ny();if(x(t))return t}return es()}),es=u(()=>(0,wf.resolve)(yt(),"Pictures"));var Mf=["7artisans","Bower","Canon","Carl Zeiss","Cosina","Fuji","Fujifilm","Goerz","Hasselblad","Hirox","Hoya","Konica","Leica","Leidolf","Lensbaby","Meike","Meopta","Minolta","Neewer","Nikon","Olympus","Opteka","Panasonic","Pentacon","Pentax","Ricoh","Rodenstock","Rokinon","Ross","Samsung","Samyang","Seiko","Sigma","Silor","Soligor","Sony","Sunpak","Tamron","Tiffen","Tokina","Topcon","Venus","Voigtl\xE4nder","Wray","Yongnuo","Zhong Yi","Zuiko"];var Li=["EXIF","EXV","MIE","XMP"];var Pf=g(require("path")),Yt=g(require("process"));function rl(t){return f(t).replace(/([A-Z])([a-z])/g,(e,r,n)=>"_"+r.toLowerCase()+n).replace(/[A-Z]+|[0-9]+/g,e=>"_"+e).replace(/^_/,"")}function iy(t){return"PS_"+rl(t).toUpperCase()}var bF=I(d({},Yt.env)).map(t=>un?Object.freeze(t):t).get(),l=ge("Paths","Logging","Networking","Processes","Tools","Updates","Desktops","Volumes","Db","HealthChecks","Filters","Previews","Reporting","Deduping","Sidecars","Sync","Tagging","Web","Subscriptions"),Ai=Object.freeze([l.Db,l.HealthChecks,l.Filters,l.Previews,l.Reporting,l.Deduping,l.Sidecars,l.Sync,l.Tagging,l.Web,l.Subscriptions]),nl=Object.freeze(l.values.filter(t=>!Ai.includes(t))),Xt=t=>x(t)&&t!=="undefined"?f(t).trim():void 0,$e=class{constructor(e){this.opts=e;this._persist=!1;this.listeners=[]}hasValue(){return this._value!=null}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){let r=v(e,Yt.env);for(let n of[this.key,...O(this.opts.envAliases)]){let i=p(r[n],o=>this.opts.fromEnv(o));if(i!=null)return i}}importFromEnv(e=Yt.env){if(!this._persist)return p(this.readFromEnv(e),r=>this.setValue(r))}importFromFile(e){if(!(this.hasValue()&&!this._persist))return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){Ye(this.listeners,r=>r===e)}onChange(){let e=this.value;this.listeners.forEach(r=>r(e))}get name(){return this._name}_setName(e){if(this._name!=null)throw new Error("cannot set name twice");this._name=e,this._key=iy(e),this.importFromEnv()}get persist(){return this._persist}get key(){return this._key}get category(){return this.opts.category}get categoryType(){return Ai.includes(this.category)?"library":"system"}get transient(){return this.opts.transient===!0}get advanced(){return re(this.opts.advanced,e=>e(),()=>!0)}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}maybeSetValue(e){e!=null&&(this.value=e)}set valueAndEnv(e){this.value=e,this.addToEnv(Yt.env,e)}get envValueOrDefault(){return this.opts.toEnv(this.valueOrDefault)}set tmpValue(e){this._persist=!1,this.addToEnv(Yt.env,e),this.setValue(e)}set tmpValueIfUnset(e){this.isUnset()&&(this.tmpValue=e)}setValue(e){let r=this._value,n=this.opts.toEnv(e),i=this.opts.fromEnv(n);return this._value=i,ot(r,this._value)||this.onChange(),this._value}get defaultValue(){return nt(this.opts.defaultValue)}get exampleValue(){return I(this.opts.exampleValue).flatMap(e=>e()).filter(x).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return this.value!=null?this.value:this.defaultValue}maybeAddToEnv(e,r){let n=v(e,Yt.env);return this.hasValue()&&(n[this.key]=Xt(this.opts.toEnv(v(r,this.valueOrDefault)))),n}addToEnv(e,r){let n=v(e,Yt.env);return n[this.key]=Xt(this.opts.toEnv(v(r,this.valueOrDefault))),n}deleteFromEnv(e){let r=v(e,Yt.env);return delete r[this.key],p(this.opts.envAliases,n=>n.forEach(i=>{delete r[i]})),r}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),P("Settings."+this.name).info(".unset()"),this}addToJSON(){return{}}toJSON(){return{key:this.key,value:this.value,defaultValue:this.opts.defaultValue}}},yr=class extends $e{constructor(e){super(d({toEnv:Xt,fromEnv:Xt,defaultValue:void 0},e))}hasValue(){return x(this.value)}};function Ef(t){return t==null?void 0:t.trim()}var oe=class extends $e{constructor(e){super(d({toEnv:Ef,fromEnv:Ef},e))}hasValue(){return x(this.value)}};function il(t,e){let r=f(t).toLowerCase();return e.find(n=>n.toLowerCase()===r)}var Zt=class extends $e{constructor(e){super(d({toEnv:n=>il(n,e.validValues),fromEnv:n=>il(n,e.validValues)},e));if(this.validValues=e.validValues,this.defaultValue!=null&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}};function oy(t){return he(f(t).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return xe(JSON.parse(e)).map(f)}catch{}for(let r of["\xA6",Pf.delimiter])if(e.includes(r))return e.split(r);return[e]})}function _f(t){return en(t)?void 0:Pe(oy(t),Oi)}function sy(t){return Pe(Oi(t),F)}function Oi(t){return X(Qi(t))}var C=class extends $e{constructor(e){super(d({defaultValue:[],fromEnv:_f,toEnv:sy},e))}push(...e){this.value=Oi([...this.valueOrDefault,...e])}get values(){return Oi(this.valueOrDefault)}set values(e){this.value=Oi(e)}removeValueFromEnv(e){p(this.value,r=>this.tmpValue=r.filter(n=>n!==e))}};function ay(t,e){return Lf(_f(t),e)}function Lf(t,e){if(t==null)return;let r=[];for(let n of t){let i=il(n,e);i!=null&&r.push(i)}return r}var ol=class extends $e{constructor(e){super(d({fromEnv:r=>ay(r,e.validValues),toEnv:r=>p(r,n=>F(X(n)))},e));this.validValues=e.validValues}asValidValues(e){return Lf(e,this.validValues)}addToJSON(){return{validValues:this.validValues}}},J=class extends $e{constructor(e){super(d(d({},e),{toEnv:Xt,fromEnv:j}))}};var ts=class extends $e{constructor(e){super(d(d({},e),{toEnv:Xt,fromEnv:Yi}))}},Me=class extends $e{constructor(e){super(d(d({},e),{toEnv:Xt,fromEnv:r=>I(r).flatMap(parseInt).map(n=>ue(e.min,e.max,n)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},Wr=class extends $e{constructor(e){super(d(d({},e),{toEnv:Xt,fromEnv:r=>I(r).flatMap(parseFloat).map(n=>ue(e.min,e.max,n)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},S=class extends $e{constructor(e){super(d(d({},e),{toEnv:Xt,fromEnv:ku}))}};var Dn=require("process"),Of=Object.freeze(["/usr/local/sbin","/usr/local/bin","/opt/local/sbin","/opt/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),rs=u(()=>un),ze=()=>!rs(),ly=Object.freeze(_?[...wr(Dn.env.SYSTEMROOT,t=>[t,(0,In.join)(Dn.env.SYSTEMROOT,"System32"),(0,In.join)(Dn.env.SYSTEMROOT,"System32","webm")],()=>[]),"C:\\cygwin64\\bin"]:Of),y={copyAssetsToLibrary:new S({category:l.Paths,description:`Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page's "May PhotoStructure organize your photos and videos?" section. Read more about this setting here: <https://photostructure.com/getting-started/automatic-library-organization/>.`,defaultValue:!0,advanced:()=>!1}),libraryPath:new yr({envAliases:["PS_LIBRARY","PS_LIBRARY_DIR"],category:l.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>ze()?"/home/test/Pictures":ce()?"/ps/library":es(),defaultValue:()=>ce()&&!ze()?"/ps/library":void 0,advanced:()=>!1}),previewsDir:new oe({category:l.Paths,description:`This is the directory that PhotoStructure uses to store preview images. This defaults to the ".photostructure/previews" directory inside your PhotoStructure library. Absolute paths here are supported, but if you keep your library and previews directory separated, take care when you open your library on different computers, as this setting needs to be adjusted for those computers as well.
NOTE: "originalDirs" is recommended instead of this setting; If you get "previewsDir" wrong, your library won't work. If you get "originalsDir" wrong, you just break full-screen zoom and non-transcoded videos.`,defaultValue:()=>".photostructure/previews"}),originalsDir:new oe({category:l.Paths,description:`This is the directory that PhotoStructure uses to store original images when "copyAssetsToLibrary" is enabled. Absolute paths are supported. Relative paths are evaluated from your libraryPath. This setting defaults to ".", which is the same as your PhotoStructure library directory.
If you open your PhotoStructure library on a different computer, and that computer doesn't have access to your originals volume, full-screen zoom won't work, and non-transcoded videos will not play.
This system setting needs to be set appropriately on different computers (it won't be set automatically!)
If you have a large library and want to use an SSD, we recommend you set your libraryPath to your SSD, and use this setting to store your originals on a larger volume, rather than using the "previewsDir" setting.`,defaultValue:()=>"."}),forceOpen:new S({category:l.Paths,description:"DANGEROUS: if set, all previously-existing library locks will be removed. This should only be necessary if the prior PhotoStructure process was not shut down gracefully.",defaultValue:!1,transient:!0}),scanAllDrives:new S({category:l.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new S({category:l.Paths,description:"Deprecated, and will be removed in the next version. If set, PhotoStructure will automatically add your pictures directory to your `scanPaths` setting.",defaultValue:!1,advanced:()=>!1}),scanPaths:new C({category:l.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1,exampleValue:()=>ze()?["/path/one","/path/two"]:[es()]}),cacheDir:new oe({category:l.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free. Note that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory.",exampleValue:()=>ze()?"/tmp/ps_cache_dir":xa(),defaultValue:()=>xa()}),neverIgnored:new C({category:l.Paths,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),pidfile:new yr({envAliases:["PIDFILE"],category:l.Paths,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),scanLibraryFirst:new S({category:l.Paths,description:"Should PhotoStructure scan your library before all other paths are synchronized?",defaultValue:!1}),scanLibraryLast:new S({category:l.Paths,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!0}),logLevel:new oe({envAliases:["PS_LOG","LOG"],category:l.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc').",defaultValue:()=>rs()?"error":"info"}),logDir:new oe({category:l.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>Jm(),exampleValue:()=>ze()?"/var/log/photostructure":void 0}),logCompression:new S({category:l.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>rs()}),logElapsedMs:new S({category:l.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new S({category:l.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new yr({category:l.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new S({envAliases:["LOG_STDOUT","PS_STDOUT"],category:l.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new S({category:l.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new S({category:l.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR is set, this defaults to false. See <https://no-color.org/>.",defaultValue:()=>M(Dn.env.NO_COLOR)}),logSql:new S({category:l.Logging,description:"Log SQL queries to the default log level. *This is really chatty* and impacts performance. Normally these log messages are completely disabled.",defaultValue:()=>!1}),localhost:new oe({category:l.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). See <https://letsencrypt.org/docs/certificates-for-localhost/> and <https://photostructure.com/faq/troubleshooting/#windows-firewall-issues>.',defaultValue:()=>"127.0.0.1"}),httpPort:new J({category:l.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),trustProxy:new oe({category:l.Networking,description:`Support for PhotoStructure instances running behind a reverse proxy. See <http://expressjs.com/en/guide/behind-proxies.html>. This setting should either be "false" (don't trust any proxies), "loopback", (only trust localhost), a single subnet (like "127.0.0.0/8"), or a comma-delimited set of subnets.`,defaultValue:"false"}),exposeNetworkWithoutAuth:new S({category:l.Networking,description:`Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.
**Don't enable this unless you know what you are doing**.`,defaultValue:()=>ce()&&!ze()}),rpcPort:new J({category:l.Networking,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),exiftoolProcsPerChild:new Me({category:l.Processes,description:"Each PhotoStructure process spins up an ExifTool when needed. Note that the `web`, `sync`, and `sync-file` services all use exiftool, so the total number of exiftool processes can be many times larger than this value.",min:1,max:8,defaultValue:2}),sensitiveEnvRegExp:new oe({category:l.Processes,description:'PhotoStructure spawns a number of processes (including "exiftool" and "ffmpeg"), and passes through environment variables, mostly to ensure locale and TZ settings are correct. To prevent environment values that contain sensitive information, like API access tokens, from either being logged, or being accessed by external tools, all environment variables whose key matches this setting will be removed. This regex is applied case-insensitively.',defaultValue:"key|secret|pass|_user|aws_"}),bounceMinutes:new J({category:l.Processes,description:"PhotoStructure will bounce the web and sync processes periodically. Set to 0 to disable.",defaultValue:60*(ze()?5:K?2:5)}),setupTimeoutMs:new J({category:l.Processes,description:"To prevent unhealthy services running as zombies, they self-terminate if the setup processes are not complete within this amount of time. Note that only the environment variable value is used for this setting.",defaultValue:35*w}),probationMs:new J({category:l.Processes,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*A}),minTimeBetweenServiceRestartsMs:new J({category:l.Processes,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*w}),fatalErrorRatePerMinute:new J({category:l.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),minDiskFreeGb:new J({category:l.Processes,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new Me({category:l.Processes,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new Zt({category:l.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>wi.BelowNormal,validValues:wi.values}),maxMemoryMb:new Me({category:l.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.",defaultValue:500,min:256,max:8e3}),maxRssMemoryMb:new Me({category:l.Processes,description:"PhotoStructure will restart services if their' resident set size consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:250,max:8e3}),maxTasksPerProcess:new Me({category:l.Processes,description:"PhotoStructure will recycle sync-file processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>ze()?10:200,min:1,max:5e3}),pollIntervalMs:new J({category:l.Processes,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>rs()?A:5*w}),inspect:new S({category:l.Processes,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,transient:!0,advanced:()=>!0}),ignoreUnhealthyVolumes:new S({category:l.Volumes,description:"When true, PhotoStructure ignores volumes that are not healthy (due to needing filesystem checks, or remote filesystems that are not available).",defaultValue:!0}),validateMountpoints:new S({category:l.Volumes,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist.",defaultValue:!0}),readVolumeUuidFiles:new S({category:l.Volumes,description:`When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume UUID, which can help with cross-host library portability. Set this to false if you don't want PhotoStructure to read these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),writeVolumeUuidFiles:new S({category:l.Volumes,description:`When true, PhotoStructure (tries to) write ".uuid" files into the root directory of volumes, which enables cross-host library portability. Set this to false if you don't want PhotoStructure to try to write these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),forceLocalDbReplica:new S({category:l.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:()=>ce()&&!ze()}),dbBackupsCount:new J({category:l.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",defaultValue:20}),maxBusyDbMs:new J({category:l.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 2 minutes, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>2*A}),dbTimeoutMs:new J({category:l.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",defaultValue:()=>w}),dbBackupIntervalMinutes:new Wr({category:l.Db,description:"How many minutes should elapse between backing of your library database? Note that PhotoStructure vacuums and optimizes the database before a backup is taken. You want this period to be frequent enough such that data loss isn't too painful. Note that backups can cause the webserver to be momentarily unresponsive. Default is every hour.",min:ze()?.5:1,max:60*12,defaultValue:()=>ze()?.5:30}),dbCacheSizeMb:new J({category:l.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:192}),dbBatchSelectSize:new Me({category:l.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",defaultValue:128,min:1,max:900}),dbBatchUpsertSize:new Me({category:l.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",defaultValue:16,min:1,max:500}),healthCheckExiftool:new S({category:l.HealthChecks,description:"When true, PhotoStructure verifies ExifTool is available and a valid version.",defaultValue:!0}),healthCheckLibraryIsWritable:new S({category:l.HealthChecks,description:"When true, PhotoStructure verifies the library directory exists, and is writable.",defaultValue:!0}),healthCheckVolumes:new S({category:l.HealthChecks,description:"When true, PhotoStructure verifies volumes as part of periodic health checks.",defaultValue:!0}),healthCheckFreeSpace:new S({category:l.HealthChecks,description:"When true, PhotoStructure verifies that the library and cache volumes have sufficient free space.",defaultValue:!0}),healthCheckDb:new S({category:l.HealthChecks,description:"When true, PhotoStructure verifies that the library database can be read from and written to.",defaultValue:!0}),enableSIMD:new S({category:l.Tools,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to false on macOS due to instability on that platform.",defaultValue:()=>!(ze()||K)}),enableVipsCache:new S({category:l.Tools,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations? This defaults to false to reduce memory consumption.",defaultValue:()=>!1}),showFileInFolderUsesThunar:new S({category:l.Tools,description:`If we're on Linux, should we use Thunar (via dbus) to "show file in folder"?`,defaultValue:!1}),showFileInFolderUsesFileUri:new S({category:l.Tools,description:"Does the showFileInFolderCommand expect a file: URI to the file? If this is false, the native path will be appended instead.",exampleValue:()=>!0,defaultValue:()=>Te}),showFileInFolderCommand:new C({category:l.Tools,description:`If set, the first argument will be used as a command (or path to command), and the subsequent arguments (if present) will be used as arguments. The native path to the file or the file: URI will be appended, based on the value given to the "showFileInFolderUsesFileUri" setting. If this is set to an empty array, the default tool for your platform will be used instead: "nautilus -s" on linux, "open -R" on mac, and "explorer /select" on Windows.
This is provided to support Linux desktops that don't use Gnome.`,defaultValue:[]}),dcraw_emuPath:new oe({category:l.Tools,description:'This should be the absolute, native path to the "dcraw_emu" binary on this system. If this is set to "dcraw_emu", PhotoStructure will search your $PATH. See <https://www.libraw.org/docs/Samples-LibRaw.html>.',defaultValue:"dcraw_emu"}),ffmpegPath:new oe({category:l.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc. See <https://photostructure.com/getting-started/video-support/>.',defaultValue:"ffmpeg"}),ffmpegTranscodeArgs:new C({category:l.Tools,description:`The following are the default arguments added to transcode requests made to ffmpeg (when ffmpeg is available). The following arguments will proceed the command: "-loglevel error -threads T -i INPUT_FILE_PATH" (where T is replaced by ~half the available CPU threads, and INPUT_FILE_PATH is the full native pathname to the source video). The following arguments will follow the arguments in this setting: "-b:v VIDEO_BITRATE_KBPS OUTPUT_FILE_PATH".
CAUTION: this is an advanced setting. Editing this may cause videos that require transcoding to not be imported, or not be viewable on all browsers and platforms. See <https://forum.photostructure.com/t/hardware-accelerated-encoding-transcoding/166> for more details.`,defaultValue:["-c:a","aac","-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high"]}),heifConvertPath:new oe({category:l.Tools,description:'This should be the absolute, native path to the "heif-convert" binary on this system. If this is set to "heif-convert", PhotoStructure will search your $PATH. See <https://photostructure.com/getting-started/heif-support/>.',defaultValue:"heif-convert"}),powerShellArgs:new C({category:l.Tools,description:`The following are the default arguments added to spin up PowerShell on Windows devices.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1> for all arguments that PowerShell.exe accepts.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-5.1> for a description of Bypass.
See <https://forum.photostructure.com/t/eliminate-powershell-profile-and-execution-policy-related-errors/184> for more details about why this needs to be configurable.
(Versions prior to v1.0.0 only specified "-NoLogo").`,defaultValue:["-NoLogo","-NoProfile","-ExecutionPolicy","Bypass"]}),powerShellCulture:new oe({category:l.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),toolPaths:new C({category:l.Tools,description:`These paths are appended to the PATH to ensure PhotoStructure can find and run external tools like ffmpeg. Use your operating system's separator to separate paths (":" for mac and linux, ";" for windows).`,defaultValue:()=>Pr("SETTINGS_IO_TEST")?Of:ly}),vlcPath:new oe({category:l.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),openAtLogin:new S({category:l.Desktops,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!xn}),updateChannel:new Zt({category:l.Desktops,description:'TL:DR; keep this on "latest." This setting only applies to PhotoStructure for Desktops, and controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds have not been thoroughly tested. Please only consider changing this if customer support asks you to, and that you have recent backups of your system.',defaultValue:()=>Ym(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new S({category:l.Desktops,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new J({category:l.Desktops,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:60*24}),autoHideMenuBar:new S({category:l.Desktops,description:"If true, PhotoStructure for Desktops on Windows and Linux will auto hide the menu bar unless the Alt key is pressed.",defaultValue:!1}),email:new yr({category:l.Reporting,description:"If set, this email will be used for license subscriptions and added to error reports, so we can contact you to help debug the issue. It is not required. Setting a value here does not subscribe you to any marketing emails.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new S({category:l.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new J({category:l.Reporting,description:`Set this to zero to remove all bugs in PhotoStructure.
HUR HUR #DADJOKE
If your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.`,defaultValue:3}),minStreamCorrPct:new Me({category:l.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),hiddenHomeTags:new C({category:l.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", and "Keyword").',defaultValue:()=>["Type"]}),placeholderThumbs:new S({category:l.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),cspReportOnly:new S({category:l.Web,description:"Only report CSP violations. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>.",defaultValue:()=>!1}),cspDirective:new yr({category:l.Web,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src>.",exampleValue:()=>"https://myphotos.example.com"}),readdirCacheSeconds:new J({category:l.Sync,description:"readdir() can take a long time over slow network shares and when directories are very large. This setting controls how long to cache readdir results that are slow (which take >= .5 seconds). Set to 0 to disable readdir() caching.",defaultValue:300}),verifyFileCopies:new S({category:l.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new oe({category:l.Sync,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:`If you chose to copy assets into your library, they will be copied into <originals directory>/<result of this pattern>/<original imagename>.
- See the originalsDir system setting for what your <originals directory> is (it defaults to your library root directory).
- Please encode this path with forward-slashes, even if you're on Windows.
- If you want to add a static path, escape the pathname with single quotes (like "'photos'/y/MM/dd").
- This will always be interpreted as a relative path from your PhotoStructure library.
- See <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.`,defaultValue:"y/y-MM-dd"}),transcodeVideos:new S({category:l.Sync,description:"Should videos that are not in a browser-supported format be transcoded during import? Note that this is a plus-only feature. FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),transcodeBitrateQVGA:new J({category:l.Sync,description:"What max bitrate should PhotoStructure encode QVGA (320 \xD7 240) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:800}),transcodeBitrateUHD:new J({category:l.Sync,description:"What max bitrate should PhotoStructure encode UHD (3840\u2009\xD7\u20092160) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:18e3}),doNotTranscodeMimetypes:new C({category:l.Sync,description:`Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "['video/quicktime','video/mp4']").`,defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),doNotTranscodeVideoCodecs:new C({category:l.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following video codecs. The video codec may be stored in the "VideoCodec", "CompressorID", or "CompressorName" tags.',defaultValue:()=>["avc1"]}),doNotTranscodeAudioCodecs:new C({category:l.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following audio codecs. The audio codec is stored in the "AudioCodec" tag.',defaultValue:()=>["mp4a","sowt"]}),statTimeoutSeconds:new Me({category:l.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new S({category:l.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncIntervalHours:new J({category:l.Sync,description:`This value controls both how often the sync process discovers new or changed files for any given volume.
Note that this value is the duration between the last completion time and when the next sync should be scheduled.
WARNING: Setting this value to a small value will mean PhotoStructure is constantly scanning your disks, which will add wear and tear and possibly reduce the lifespan of your storage media.
Note that setting this to a zero or negative value will disable automatic scheduling of the sync process.`,defaultValue:24}),rebuild:new S({category:l.Sync,description:"When set, all files in your library will be re-imported (caution: slow!).",defaultValue:!1,transient:!0}),forceSync:new S({category:l.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),skipModelUpdates:new S({category:l.Sync,description:"When set, skip any pending library database updates.",defaultValue:!1,transient:!0}),exitWhenDone:new S({category:l.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),matchSidecarsCaseInsensitively:new S({category:l.Sidecars,description:`If set to true, PhotoStructure will look for sidecar files that match file basenames (with or without the file extension), regardless of case (for example: "IMAGE.XMP" will be a sidecar for "image.jpg").
If set to false, sidecars must match case (so only "image.jpg.xmp" and "image.xmp" will match for "image.jpg").
This defaults to false just to be conservative, but true should be fine in normal cases.`,defaultValue:!1}),defaultSidecarType:new Zt({category:l.Sidecars,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:Li}),writeMetadataToSidecarsIfImage:new S({category:l.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to images into sidecars. If set to false, PhotoStructure will overwrite original images with metadata changes.",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new S({category:l.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to videos into sidecars. If set to false, PhotoStructure will overwrite original videos with metadata changes. This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new S({category:l.Sync,description:'Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents. If this is set to false, the original file will be retained in the same directory. "image.jpg" will be stored as "image_original.jpg".',defaultValue:!1}),fuzzyDateParsing:new S({category:l.Sync,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),fuzzyYearParsing:new S({category:l.Sync,description:`When enabled, PhotoStructure will use directories starting with a number that looks year-like (four digits, 1826-the present) to infer the captured-at time, if all other date parsers have failed. Note that setting this to true "forces" the "fuzzyDateParsing" setting to be true.
To elaborate: PhotoStructure first looks for metadata with a date, then looks for an ISO-compliant YMD timestamp in the filename or path, and then, if "fuzzyDateParsing" or this setting is enabled, a YMD or YM datestamp, and then finally, if this setting is enabled, it looks for a directory that begins with a number that is between 1826-2020.`,defaultValue:!1}),minValidYear:new J({category:l.Sync,description:"If PhotoStructure encounters a year that is less than this value, it will consider it invalid and look elsewhere for dates. The default value, 1826, is the first year a photograph was captured, as per <https://en.wikipedia.org/wiki/History_of_photography>. If you have paintings or other imagery from before this time, you'll want to make this value less than the earliest image in your library.",defaultValue:1826}),useStatToInferDates:new S({category:l.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in the file "birthtime" (on Windows), or the lesser value of "mtime" and "ctime" (on macOS and Linux). Note that these values are not very reliable, as file transfers and backups frequently don't retain these values correctly.`,defaultValue:!0}),usePathsToInferDates:new S({category:l.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.`,defaultValue:!0}),useLibraryPathsToInferDates:new S({category:l.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths *for files that are in your PhotoStructure library. This defaults to false, as prior versions of PhotoStructure may have placed files into incorrect datestamped directories.`,defaultValue:!1}),maxDuplicatePathElements:new J({category:l.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),skipAssetFileUpdates:new S({category:l.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),skipAssetUpdates:new S({category:l.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new S({category:l.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>ze()?!0:(0,Af.cpus)().length>=8}),excludeNoMediaAssetsOnRebuild:new S({category:l.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),strictDeduping:new S({category:l.Deduping,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true.',defaultValue:!1}),useImageHashes:new S({category:l.Deduping,description:"Building image hashes slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing. If you set this from false to true, and you'd previously imported new assets, you may want to rebuild your library to re-aggregate your assets.",defaultValue:!0}),includeSharpDominantColor:new S({category:l.Deduping,description:"PhotoStructure's image library, sharp, computes the dominant color using a 4096-bin 3D histogram. This doubles image hashing time, but the most-dominant color might be more accurate.",defaultValue:!1}),minExposureSettingsCoeffPct:new Me({category:l.Deduping,description:"This is the minimum similarity coefficient between exposure setting values two images must be to be considered equivalent. Many cameras actually report different exposure setting values between JPG and RAW: values within 90% of each other should avoid false-positives.",defaultValue:()=>90,max:100,min:0}),minImageCoeffPct:new Me({category:l.Deduping,description:"This is the minimum image hash similarity coefficient for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image similarity. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minImageGreyscaleCoeffPct:new Me({category:l.Deduping,description:"This is the minimum image hash similarity coefficient for greyscale images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>93,max:100,min:0}),minColorCoeffPct:new Me({category:l.Deduping,description:"This is the minimum similarity coefficient found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 50% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minMeanCoeffPct:new Me({category:l.Deduping,description:"If the average of image and color similarity coefficients exceeds this score, the image will be considered a match.",defaultValue:()=>65,max:100,min:0}),fuzzyDateImageCoeffWeight:new Wr({category:l.Deduping,description:'Image similar, by default, is somewhat lax to ensure JPG+RAW and downsampled or edited images are matched together. This is OK when dates must match, and the date is exactly correct. When dates are manually set to something "fuzzy", with perhaps only the year, month, and day, or is inferred by siblings, we need to be more discriminate with image contents to prevent incorrectly grouping photos from that day into a single asset. This value is multiplied with minImageCorrPct and minColorCorrPct to make them more stringent. For example, by default, the minImageCorrPct is 80%, and when the dates are manually set, and this weight is 1.2, the minImageCorrPct for manually-set-date files will be 90%.',defaultValue:()=>1.4,max:2,min:.5}),greyscaleColorThreshold:new Me({category:l.Deduping,description:"When looking at each pixel in L*a*b* space, a greyscale image is expected to have a* and b* values around 0. If the absolute value of every a* and b* value is under this setting's value, the image will be considered to be greyscale. A value of 0 will force all images to be considered non-greyscale.",defaultValue:5,max:128,min:0}),modeCorrCieDiffWeight:new Wr({category:l.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to the CIE94 color delta e. Smaller values apply a larger discount to color deltas.",defaultValue:()=>.6,max:2,min:0}),modeCorrIndexDiffWeight:new Wr({category:l.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to difference between the color indexes. Smaller values apply a larger discount to index differences.",defaultValue:()=>.6,max:2,min:0}),gpsErrorMeters:new J({category:l.Deduping,description:`What's the maximum number of meters between GPS fixpoints that should be considered equivalent locations? Note that JPG+RAW pairs from smartphones frequently have different GPS locations due to one being recorded from a rough WiFi fix, and another from aGPS.
GPS position error is ~10-100m. Cellular position error is ~500-750m.`,defaultValue:500}),lensMakes:new C({category:l.Deduping,description:"Used to match lensId when Google Takeout has stripped metadata.",defaultValue:()=>Mf}),variantSortCriteria:new C({category:l.Previews,description:'How should PhotoStructure pick the "best" asset file variant for a given asset? You may reorder the default fields. Only "resolution", "fileSize", "mtime", "schemeIdx", "isCover", "count", and "isBrowserSupported" are understood: other field names will be ignored. Details about these fields are here: <https://photostructure.com/faq/what-do-you-mean-by-dedupe/#how-does-photostructure-pick-which-file-to-show>.',defaultValue:["resolution","mtime","schemeIdx","isCover","count","isBrowserSupported","fileSize"]}),variantSortCriteriaPower:new Wr({category:l.Deduping,description:'Larger variant sort criteria, "resolution" and "fileSize", are scaled to ignore smaller (irrelevant) differences. Scalars are raised to this power to reduce them, so a value of 1 means the criterion is unchanged from the "raw" value.',defaultValue:()=>.15,max:1,min:1e-6}),jpegQuality:new Me({category:l.Previews,description:"JPEG output quality for previews. Smaller values produce smaller images with lower quality. The default value of 85 strikes a balance that has almost no noticeable compression artifacts, yet still compresses images reasonably well. Values less than ~50-70 can produce noticeable artifacts (depending on the image).",defaultValue:()=>85,max:100,min:10}),dcrawEmuArgs:new C({category:l.Previews,description:`What options do you want to pass to dcraw_emu? Note that "-T -o 1 -j -Z -" will always be added (as we need TIFF, sRGB, raw pixels send to stdout). The "-h" arg will be added if the preview image needed is less than half the resolution of the original.
Run "dcraw_emu" with no arguments to get usage help.
"-q 1" sets interpolation quality to "0".
"-H 2" turns on highlight blending.
"-w" uses the camera-set white balance.
Note: changing these values can dramatically (> 10x!) increase the time it takes to render RAW images.`,defaultValue:["-q","0","-w"]}),iccProfileMappings:new C({category:l.Previews,description:`Maps an original image profile to a filename stored in the "icc" directory. See that directory's _info.md for more information about this settings.`,defaultValue:["Display P3:DisplayP3Compat-v2-magic.icc","Adobe RGB:AdobeCompat-v2.icc"]}),squareThumbStrategy:new Zt({category:l.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>.',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new ts({category:l.Previews,description:`When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.
Note that if a video is shorter than this value, the frame will be captured from the middle of the video.`,defaultValue:1.5}),sharpen:new S({category:l.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new S({category:l.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new ol({category:l.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:wu(Ys,["uhd8k","uhd5k","qqvga"]),validValues:Ys}),embeddedPreviews:new C({category:l.Previews,description:`For larger source images that are greater than 15MP, what embedded image preview tags should be used when present? Using these embedded images speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["PreviewImage","PreviewTIFF","JpgFromRaw"]}),embeddedThumbnails:new C({category:l.Previews,description:`Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["ThumbnailImage","ThumbnailTIFF"]}),skipPreviews:new S({category:l.Previews,description:"No previews will be built. The UI will be broken if this is set.",defaultValue:!1}),requireMakeModel:new S({category:l.Filters,description:"Normally PhotoStructure requires images to have EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),minImageDimension:new J({category:l.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new J({category:l.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minVideoDurationSec:new ts({category:l.Filters,description:"What's the minimum number of seconds for a video to be imported?",defaultValue:2}),minAssetFileSizeBytes:new J({envAliases:["PS_MIN_ASSET_SIZE_BYTES","PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:l.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*Xs}),maxAssetFileSizeBytes:new J({envAliases:["PS_MAX_ASSET_SIZE_BYTES","PS_MAX_ASSET_SIZE","PS_MAX_FILE_SIZE_BYTES"],category:l.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library).",defaultValue:.5*ri}),validateJpegImages:new S({category:l.Filters,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateRawImages:new S({category:l.Filters,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateVideos:new S({category:l.Filters,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!ze()}),validationErrorBlocklist:new C({category:l.Filters,description:`If any of the following patterns match a validation error found in a photo or video, the file will be considered corrupt and not be imported into your library.
Note the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message, so, for example, a value of "caution" will ignore any error message that contains the string "caution".`,defaultValue:()=>["Cannot determine format of input stream","corrupt","error","failed","invalid","not a .+ file","nothing was written into output file","partial file","Premature end of .+ file"]}),tagCamera:new S({category:l.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new S({category:l.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new S({category:l.Tagging,description:`Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you'll need to "Rebuild" your library to make the setting take effect).`,defaultValue:!0}),tagYMD:new Zt({category:l.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["y","ym","ymd",""]}),tagDateFromStat:new S({category:l.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!ze()}),tagKeywordsFromPath:new S({category:l.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new S({category:l.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new oe({category:l.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new oe({category:l.Tagging,description:`PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "Objects\u2283Tools\u2283Hammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don't want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.`,defaultValue:"/|>\u2283"}),tagFileType:new S({category:l.Tagging,envAliases:["PS_TAG_TYPE"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0}),tagWhoSynonyms:new C({category:l.Tagging,description:'List hierarchical tags that PhotoStructure should interpret to be face names. Digicam uses "People". This is matched case-insensitively.',defaultValue:()=>["People","Face","Faces"]}),tagJsonFaces:new S({category:l.Tagging,description:'Google Takeout provides .json sidecars that may contain the names of the people (or pets) found in the image. Should PhotoStructure import these tags under "Who"?.',defaultValue:!0}),tagFaceRegions:new S({category:l.Tagging,description:'Picasa and other software supports embedding face names within "RegionInfo" metadata. If this setting is enabled, PhotoStructure will import these tags under "Who".',defaultValue:!0}),tagWhoNames:new C({category:l.Tagging,description:`This is a list of tags that will be examined for strings or string arrays. All values associated to these fields will be interpreted as names. Note that "dotted notation" is supported.
Set this value to an empty array to disable scanning for person names.`,defaultValue:["People","PersonInImage","PersonInImageWDetails.PersonName","PersonInImageName"]}),tagNamesFormatter:new Zt({category:l.Tagging,description:`How should PhotoStructure format the "Who" tags for assets whose files are tagged with "people" strings?
"as-is" will tag names directly to "Who", so, "Who/Albert Einstein".
"family/given" will tag "Who/Einstein/Albert" (for regions that provide given names first). The default is "as-is," because discerning given and family names aren't reliably inferable.
See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"as-is",validValues:["as-is","family/given"]}),tagNamesDefaultFamily:new oe({category:l.Tagging,description:'If a name is missing a family name, if this value is not blank, it will be provided as a default. If this value is blank, the name tag will be Who/given. Note that this setting is only used if "tagNamesFormatter" is set to "family/given".',defaultValue:"-"}),tagNamesCapitalizedAsFamily:new S({category:l.Tagging,description:"Assume uppercased names are family names (this is common practice in geneology).",defaultValue:!0}),tagNamesOrder:new Zt({category:l.Tagging,description:`How should PhotoStructure parse people's names? Note that this setting is only used if "tagNamesFormatter" is set to "family/given". See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"western",validValues:["western","eastern"]}),tagNamesSurnamePrefixes:new C({category:l.Tagging,description:'List all family name prefixes to be considered part of the family name. These are matched case-insensitively. This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>["A","D\u2019","Da","De la","De las","De","Del","Della","Den","Des","Di","Du","La","Las","Le","Li","Lo","Mc","Mac","op de","ten","ter","Van \u2018t","van der","van","von der","von","z","zu"]}),tagNamesSurnames:new C({category:l.Tagging,description:`List all family names you expect in tags that are not single words that are found at the end of a tagged name. Hyphenated family names (like "Ocasio-Cortez") do not need to be listed here: only compound family names, and if your language doesn't separate family names with whitespace. In the latter case, either include all family names, or include all givenNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesGiven:new C({category:l.Tagging,description:`List all given names you expect in tags that are not single words. Hyphenated given names (like "Rose-Ann") do not need to be listed here. If your language doesn't separate family names and given names with whitespace, either include all given names, or include all familyNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesFamilySurrounds:new C({category:l.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added as a family name. As an example, if you use the default "()", then "Michelle LaVaughn (Robinson) Obama" will be name tagged with both "Who/Robinson/Michelle LaVaughn" and "Who/Obama/Michell LaVaugn". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["()"]}),tagNamesGivenSurrounds:new C({category:l.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added to the end of the given name with the surrounds retained. As an example, if you use the defaults of "[]" and double-quotes, then "Joe "Joey" Smith" will be name tagged with Who/Smith/Joe "Joey". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["[]",'""']}),tagNamesLexical:new S({category:l.Tagging,description:'Assume any name with a comma is in "lexical name order", which is always "lastname, given name(s)". If the given name is found to be "sr.", "senior", "jr.", or "junior", the name will be considered to be in western order ($givenNames $familyName, $modifier), and the $modifier will be added to the $givenNames. If this is set to false, commas are ignored.',defaultValue:!0}),excludedRootTags:new C({category:l.Tagging,description:"Keywords starting with the given roots will be omitted from your PhotoStructure library.",defaultValue:()=>["http:","https:"]}),tagDisplayNameFS:new oe({category:l.Tagging,description:`What should PhotoStructure call the "root" tag for browsing by filesystem paths? Note that this value is only for the UI, and will update the "_displayName" of the /fs/ tag: this value won't change the URL path from be "/tag/fs/.../". Reasonable options that have been suggested include "Folder", "Directory", "Drive", "File", "Path", "Volume", or "Computer".`,defaultValue:"Folder"}),tagAlbums:new S({category:l.Tagging,description:'Should PhotoStructure look for $tagJsonAlbumFilename (by default, "metadata.json") files in the same directory as asset files for album titles?',defaultValue:!0}),tagAlbumFilenames:new C({category:l.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the file that PhotoStructure should look for with album metadata? This can be JSON, XMP, MIE, or EXIF encoded.`,defaultValue:["metadata.json"]}),tagAlbumTitle:new oe({category:l.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.title"}),tagAlbumTitleHierarchies:new S({category:l.Tagging,description:'If true, album titles will be split as hierarchical keywords. If false, album titles will not be split, and all albums will be under the "Albums" root tag.',defaultValue:!1}),tagAlbumDescription:new oe({category:l.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.description"}),tagAlbumDate:new oe({category:l.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.date"}),tagAlbumsExcluded:new C({category:l.Tagging,description:'For "metadata.json" albums, some are automatically generated. If the title or description includes any given string, it will be ignored.',defaultValue:["Album for automatically uploaded content"]}),pickPlanOnWelcome:new S({category:l.Subscriptions,description:'If set to true, the welcome page flow will redirect to https://account.photostructure.com/plans to have you pick between "plus" and "lite". If set to false, the welcome page will continue directly to the settings page with a "lite" license. You can still upgrade to a paid plan later from the main menu or the about page, even if this is false.',defaultValue:!0}),autoRefreshLicense:new S({category:l.Subscriptions,description:`PhotoStructure uses cryptographically signed licenses to locally store your current plan subscription status. These licenses are only valid for the current subscription period, and must be refreshed when your subscription renews or converts from a free trial to a paid subscription. To minimize the hassle of license renewals, PhotoStructure can automatically renew expired licenses in the background.
If the current license has expired and this value is true, PhotoStructure will make one secure POST request to https://account.photostructure.com/ that contains several lossy one-way hashes of current system metadata. We hash all identifying metadata to only 15 characters to alleviate any privacy concerns. If your plan subscription is active, a new license will be added to your library.
Set this to false and set the "reportErrors" setting to false if you don't want PhotoStructure "phoning home" for any reason.
Note that if this is disabled, license renewals will require manual intervention: click "Upgrade" from the main menu, pick your plan, authenticate, and the license will automatically refresh.`,defaultValue:!0}),license:new yr({category:l.Subscriptions,description:`Subscription licenses are normally saved automatically into both your library and system configuration directories. This setting just provides users with an alternative way to provide a license, if it's more convenient. Any value provided to this setting will be considered in addition to existing license files when PhotoStructure is trying to find the "best" license available.`})};for(let[t,e]of Ze(y))e._setName(t);function uy(t){let e=(M(t)?"":t).split(In.delimiter);if(_&&M(Dn.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return e.push(...y.toolPaths.valueOrDefault),X(e).filter(x).join(In.delimiter)}var af=u(()=>uy(Dn.env.PATH)),Mi=u(()=>{let t=dt(y).filter(e=>!e.transient);return $(t,e=>[e.categoryType==="system"?0:1,l.indexOf(e.category),e.advanced,e.name])}),my=u(()=>Mi().filter(t=>nl.includes(t.category))),cy=u(()=>Mi().filter(t=>Ai.includes(t.category)));var Rf;(function(i){i.highlight=()=>!1,i.silent=!1,i.enabled=()=>!i.silent,i.defaultLevelIndex=Ei("trace")})(Rf||(Rf={}));var fy=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i,If=class{constructor(e){this.silent=!1;this.contexts=[];this.setup(e)}setup(e){this.contexts.length=0;let r=Ei(y.logLevel.defaultValue),n=x(e)?e:y.logLevel.valueOrDefault;V(n.split(",")).forEach(i=>{let o=fy.exec(i.trim());if(o==null)pe||console.error("LogFilterImpl: Ignoring '"+i+"' from "+e);else{let s=f(o[1]).toLowerCase(),a=Ei(o[2]);M(s)?r=a:this.contexts.push({prefix:s,levelIndex:a})}}),this.defaultLevelIndex=r}contextOverride(e){if(this.contexts.length===0&&M(e))return;let r=f(e).toLowerCase();return this.contexts.find(n=>r.startsWith(n.prefix))}enabled(e,r){if(this.silent)return!1;let n=Ei(e);if(n<=this.defaultLevelIndex)return!0;let i=this.contextOverride(r);return i!=null&&n<=i.levelIndex}highlight(e){let r=this.contextOverride(e);return r!=null&&r.levelIndex>=this.defaultLevelIndex}},ns;function gr(){return ns==null&&(ns=new If,y.logLevel.addListener(()=>ns.setup())),ns}var JF=u(()=>Ke.values[gr().defaultLevelIndex],5*w);function kn(t,e){return gr().enabled(t)?e():void 0}var sl=class{constructor(e){this.valueOf=e;this.store=[]}get length(){return this.store.length}add(e){if(e==null)return;let r=this.valueOf(e);if(r!=null){if(this.store.length===0){this.store.push(e);return}if(xr(r,this.valueOf(this.store[0]))){this.store.unshift(e);return}for(let n=this.store.length-1;n>=0;n--)if(Ki(this.valueOf(e),this.valueOf(this.store[n]))){this.store.splice(n+1,0,e);return}this.store.unshift(e)}}shiftLt(e){if(this.length===0)return[];let r=0;if(xr(this.valueOf(Su(this.store)),e))r=this.store.length;else for(;xr(this.valueOf(this.store[r]),e);)r++;return r===0?[]:this.splice(0,r)}splice(e,r){return this.store.splice(e,r)}};var Nf=g(require("process"));var kf=g(require("util"));var Df=g(require("luxon"));var py=Date.now();function is(t){let e=y.logElapsedMs.valueOrDefault?Df.Duration.fromMillis(t-py).toFormat("hhhh:mm:ss.SSS"):new Date(t).toISOString();return y.logColor.valueOrDefault?y.logElapsedMs.valueOrDefault?on(e):sn(e):e}var Fn=pe?250:750;var al=class{constructor(e={}){this.logLevels={trace:"trace",debug:sn("debug"),info:ao("info "),error:Lu("error"),warn:Au("warn ")};this.inspectOptions=d(d({},al.defaultInspectOptions()),e),pe&&(this.inspectOptions.breakLength=255)}formatMeta(e){if(e==null)return;let r=zr(e);return r==null?void 0:(0,kf.inspect)(r,this.inspectOptions)}formatLogEntry(e){let r=gr().highlight(e.ctx)?on:oo;return V([is(e.ts),Wu(v(e.from,()=>this.inspectOptions.processName())),this.logLevels[e.l],r(e.ctx),e.msg,this.formatMeta(e.meta)]).map(n=>f(n)).join(" ")}format(e,r,n,i){return this.formatLogEntry({ts:Date.now(),l:e,from:ht(),ctx:r,msg:n,meta:i})}},os=al;os.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:Qo+1,processName:ht});var Ff=g(require("util"));var ll=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e;this.paddedLogLevels=Ne(Ke.values.map(e=>[e,$u(e,5," ")]))}formatLogEntry(e){return V([is(e.ts),ht(),this.paddedLogLevels[e.l],pn(e.ctx),pn(e.msg),p(e.meta,r=>(0,Ff.inspect)(r,this.inspectOptions))]).map(r=>f(r)).join(" ")}format(e,r,n,i){return this.formatLogEntry({ts:Date.now(),l:e,from:ht(),ctx:r,msg:n,meta:i})}};var dy=u(()=>{y.logColor.addListener(()=>Ri.unset())}),Ri=u(()=>(Nf.env.NO_COLOR!=null&&(y.logColor.tmpValue=!1),dy(),y.logColor.valueOrDefault?new os({processName:()=>""}):new ll));function Vf(t){return t?.ts}var Bf=!1;function ul(t){Bf=t}var Uf=new sl(Vf);function ss(...t){for(let e of t)Bf?Uf.add(e):console.log(Ri().formatLogEntry(e))}function ml(t=Fn*2){return Uf.shiftLt(Date.now()-t)}var cl=class{log(e,r,n,i){ss({ts:Date.now(),l:e,from:ht(),ctx:r,msg:n,meta:i})}enabled(e,r){return gr().enabled(e,r)}async flush(){}end(){}},jr=cl;jr.instance=u(()=>new cl);var Wf=g(require("path")),jf=g(require("timers"));function zf(t,e){try{if(x(t))return e(JSON.parse(t))}catch{}}var hy=require("fs");var as=class{constructor(e,r={}){this.logDir=e;this.ended=!1;this.mutex=new _t;this._linesSinceRotate=0;this.pendingWrites=[];this._startIndex=0;this.endTimeoutMs=15*w;this.end=u(async()=>(this.ended=!0,p(this.flushInterval,jf.clearInterval),this.flushInterval=void 0,await this.flush(),this.mutex.serial("close",()=>this._closeCurrent())));this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",()=>this._flush());this.shouldRotate=()=>this._stream==null||this._linesSinceRotate>=this.opts.maxLinesPerFile;this.name="LogWriter("+e+")",this.opts=d({maxLinesPerFile:25e4,errorLogger:jr.instance(),flushEveryMs:Fn,processName:ht},r),this.flushInterval=lr(()=>this.maybeFlush(),this.opts.flushEveryMs),Gf(this)}log(e,r,n,i){if(this.ended&&e==="error")this.opts.errorLogger.log(e,r,n,i);else{let o={ts:Date.now(),l:e,ctx:r,msg:n};i!=null&&(o.meta=i),e==="error"&&(this.writeRecentLogEntries(),this.flush()),this.pendingWrites.push(F(o)+`
`)}}writeRecentLogEntries(){this.pendingWrites.push(...bf().map(e=>F(e)+`
`)),gf()}async flush(){await this.mutex.serial("flush",()=>this._flush())}async _flush(){let e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this._rotate();let r=this._stream;if(r==null){this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");return}let n=this.opts.maxLinesPerFile-this._linesSinceRotate,i=e.splice(0,n);this._linesSinceRotate+=i.length,r.write(i.join(""))}}errback(e){return r=>this.opts.errorLogger.log("error","Caught error from "+e,r)}async _rotate(){await this._closeCurrent(),this._currentFile=await Eo({nativePath:(0,Wf.join)(this.logDir,eo(new Date),pn(this.opts.processName())+".log"),emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=hy.createWriteStream(this._currentFile).on("error",this.errback("file write stream"))}async _closeCurrent(){let e=this._stream;this._stream=void 0,this._linesSinceRotate=0;let r=this._currentFile;this._currentFile=void 0,await Sn(e),y.logCompression.valueOrDefault&&(await be(this.opts.flushEveryMs),await p(r,jm))}};async function qf(t,e){let r=gt(t.name);return T(Sc(t.nativePath,e),n=>D(V(Ct(n)).map(i=>zf(i,o=>d(d({},o),{from:r})))))}var fl=u(()=>[jr.instance()]);function Ma(){return fl().find(t=>t instanceof as)}function Bu(){let t=y.logDir.valueOrDefault,e=Ma();(e==null||e.logDir!==t)&&(Gr(e),e=new as(t));let r=[e];(y.logStdout.valueOrDefault||y.tailLogs.valueOrDefault)&&r.push(jr.instance()),fl.set(r)}function P(t){return new _i(t,fl)}var qr=u(()=>P(so("Endable"))),ls=new Fr;lr(()=>Kf(),1*A);var gy=5*w,Ue=ge("first","service","predb","db","postdb","logger");function Gf(t){return fi(Ue.logger,t)}function fi(t,e){return Ue.validOrElse(t,()=>{throw new Error("internal error: invalid rank "+t)}),ls.add(t,e),e}var Cf=!1;function me(){return Cf}async function Gr(t,e){let r=await t;if(r==null||r.ended)return;let n=pe&&Pr("SINGLE_SPEC_TESTS")?100:mm(e,r.endTimeoutMs,gy);return qr().debug(r.name+" ending...",{timeoutMs:n}),Se(r.end(),n,()=>qr().warn(r.name+".end() timed out"),()=>qr().debug(r.name+".end() completed")).catch(i=>{Ee(()=>qr().warn(r.name+".end() rejected: "+i))})}function Kf(){ls.filterInPlace((t,e)=>!e.ended),qr().debug("vacuumEndables()",ls.entriesArray().map(([t,e])=>[t,e.map(r=>r.name)]))}var V1=u(async()=>{let t=ti()?250:void 0;qr().info("endEndables()",{isTest:pe,isSingleSpecTests:ti}),pe||(Cf=!0),Kf();for(let e of Ue.values){let r=v(ls.get(e),[]);Q(r)&&(qr().debug("endEndables(): ending "+e),await Promise.all(r.map(n=>Gr(n,t))))}});var pl=g(require("luxon"));function yy(t,e,r){return t!=null&&e!=null&&Math.abs(t.getTime()-e.getTime())<=r}function Hf(t,e=2500){return t==null?!1:nn(t)?yy(t,new Date,e):Math.abs(t-Date.now())<e}function Jf(t,e=5*w){return G(t)&&Date.now()-t<=e}var od=g(require("@iarna/toml"));var rd=g(require("path"));var by=[[["360"],"GoPro 360 video (QuickTime-based)"],[["3FR"],"Hasselblad RAW (TIFF-based)"],[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["AVIF"],"AV1 Image File Format (QuickTime-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["CZI"],"Zeiss Integrated Software RAW (ZISRAW)"],[["DCP"],"DNG Camera Profile (DNG-like)"],[["DCR"],"Kodak Digital Camera RAW (TIFF-based)"],[["DNG"],"Digital Negative (TIFF-based)"],[["DV"],"Digital Video"],[["ERF"],"Epson RAW Format (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["FFF"],"Hasselblad Flexible File Format (TIFF-based)"],[["FFF"],"FLIR Systems thermal image File Format"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HDP","WDP","JXR"],"Windows HD Photo / Media Photo / JPEG XR (TIFF-based)"],[["HDR"],"Radiance RGBE High Dynamic-Range"],[["HEIC","HEIF","HIF"],"High Efficiency Image Format (QuickTime-based)"],[["IIQ"],"Phase One Intelligent Image Quality RAW (TIFF-based)"],[["INSP"],"Insta360 Picture (JPEG-based)"],[["INSV"],"Insta360 Video (QuickTime-based)"],[["J2C","J2K","JPC"],"JPEG 2000 codestream"],[["JP2","JPF","JPM","JPX"],"JPEG 2000 image [Compound/Extended]"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PEF"],"Pentax (RAW) Electronic Format (TIFF-based)"],[["PNG","JNG","MNG"],"Portable/JPEG/Multiple-image Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Kyocera Contax N Digital RAW"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["X3F"],"Sigma/Foveon RAW"],[["XMP"],"Extensible Metadata Platform sidecar file"]],Qt=ge("RawImage","Sharp","Video","Sidecar","AssetFile","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser"),Ty=u(()=>{let t=new Fr,e=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"];for(let s of e)t.add(s,Qt.RawImage);let r=D(["GIF","JPEG","PNG","PPM","TIFF","WEBP"]);for(let s of r)t.add(s,Qt.Sharp);let n=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"];for(let s of n)t.add(s,Qt.Video);let i=[...r,"HEIC",...e,...n];for(let s of i)t.add(s,Qt.AssetFile);for(let s of Li)t.add(s,Qt.Sidecar);for(let s of[...i,...Li])t.add(s,Qt.Exif);for(let s of["GIF","JPEG","MP4","PNG","WEBM","WEBP"])t.add(s,Qt.SupportedByCurrentBrowser);for(let s of["GIF","JPEG","MP4","PNG"])t.add(s,Qt.SupportedByOldBrowser);let o=by.map(s=>s[0]);for(let s of t.keys()){let a=o.find(m=>m.includes(s));if(a!=null&&a.length>0){let m=t.get(s);for(let c of a)t.has(c)||t.set(c,m)}}return t});function xy(t){return p(vy(t),e=>Ty().get(e))}var wy=/\.?([a-z0-9]{2,4})$/i;function vy(t){return p(wy.exec(f(t)),e=>e[1].toUpperCase())}function Sy(t,e){return re(xy(t),r=>r.includes(e),()=>!1)}function dl(t){return Sy(t,Qt.Sidecar)}var Nn="pslib",Kr="psfile",br="psnet";var us=g(require("dns"));function $t(t,e){let r=0,n=new kr(e),i=o=>(r++,n.getOrSetAsync(F(o),async()=>t(o)));return i.clear=o=>{if(o==null)n.clear();else{let s=F(o);n.deleteIf(a=>s===a)}},i.size=()=>n.size,i.callCount=()=>r,i}var My=$t(async t=>{let e=_?await zc():"ping";return W(e,[_?"-n":"-c","1",t],{timeout:5*w})},{maxSize:255,timeoutMs:st,clearEveryMs:10*A}),hl=new RegExp("\\b"+Fe(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),xV=$t(async t=>I(await My(t).catch(e=>{console.warn("failed to ping: "+e)})).filter(x).flatMap(e=>hl.exec(f(e))).map(e=>e[0]).get(),{maxSize:255,timeoutMs:st,clearEveryMs:10*A});var Py=new RegExp("^"+hl.source+"$"),Ey=$t(async t=>{let e=Py.exec(t)==null?t:await Yf(t);return f(e).toLowerCase().normalize()},{maxSize:128,timeoutMs:st}),_y=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function gl(t){return _y.exec(t)!=null}function Xf(t){let e=t.split(".").map(r=>j(r)).filter(r=>hn(0,255,r));return e.length===4?e:void 0}var Zf=$t(async t=>{if(!M(t)){if(Xf(t)!=null)return[t];try{return await us.promises.resolve4(t)}catch(e){ms().warn("No name found for "+t);return}}},{maxSize:256,timeoutMs:st,clearEveryMs:10*A}),ms=u(()=>P("nslookup"));q(()=>ee(()=>Yf.clear()));var Yf=$t(async t=>{try{let e=await Se(()=>gl(t)?t.startsWith("127.")?["localhost"]:["127.0.0.1"]:Xf(t)!=null?us.promises.reverse(t):us.promises.resolve4(t),5*w);if(e==null)return ms().info("nslookup("+t+"): timeout"),t;let r=e.find(x);return r??(ms().warn("No name found for "+t),t)}catch(e){return ms().warn("Failed to look up "+t+", using name.",e),t}},{maxSize:256,timeoutMs:st,clearEveryMs:10*A});async function Qf(t,e){return M(t)||M(e)?!1:se(t,e)||gl(t)&&gl(e)?!0:li(Zf(t),Zf(e),(r,n)=>r.some(i=>n.includes(i)),()=>!1)}var Ly=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;async function Ay(){let t=await W("mount",[],{timeout:H});return D(t.split(`
`).map(e=>p(Ly.exec(e),r=>{let[n,i,o]=r.slice(1),s=o.split(",").map(a=>a.trim());return{filesystem:n,mountpoint:i,options:s}})))}var $f=u(async()=>Tn(await Ay(),async t=>t.options.includes("nobrowse")||t.options.includes("quarantine")||await Oy(t.mountpoint)).then(t=>t.map(e=>e.filesystem)),Be);async function Oy(t){let e=Re.for(t),r=await Qe(await e.childNames(),n=>n.filter(i=>!i.startsWith(".")).map(i=>i.toLowerCase()).sort(),()=>[]);return ot(r,["applications","photostructure.app"])}function yl(t){return j(t,{defaultValue:0})*1024}var Ry=["devfs"],Iy=["udev","tmpfs","devtmpfs","shm"],Dy=K?Ry:Iy,ky=["/boot/efi","/dev/shm"];async function Cr(t,e){let r=K?await $f():[],n=["-k","-P"];t&&n.push("-l"),x(e)&&n.push(e);let i=await W("df",n,{timeout:H,ignoreStderr:!0,ignoreExitCode:!0});return Ht(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],i).map(s=>({filesystem:s.Filesystem,size:yl(s["1024-blocks"]),used:yl(s.Used),available:yl(s.Available),mountpoint:s["Mounted on"]})).filter(s=>{let a=f(s.filesystem),m=f(s.mountpoint);return x(m)&&!ky.includes(m)&&x(a)&&!r.includes(a)&&!Dy.includes(a)})}var Hr=u(async()=>{if(!Te||ce())return!1;try{return(await Rt(cs,["version"],{timeout:H,ignoreStderr:!0})).code===0}catch(t){return!1}}),cs="gio",ep=["mount","--monitor","--anonymous"],Fy=u(()=>P("Gio.gioVolumes()")),Vn=u(()=>Se(async()=>{let t=await Vy(),e=(await da(t.map(async r=>{let n=await Cr(!1,r.nativePath).catch(o=>{Fy().warn("Failed to df "+r+": "+o)}),i=p(n,o=>o[0]);return p(i,o=>o.mountpoint=r.nativePath),i}))).filter(r=>r.size>0);return Promise.all(e.map(async r=>Qe(Ny(r.mountpoint),n=>(r.remoteHost=n.remoteHost,r.remoteShare=n.remoteShare,r.label=n.displayName,r.remote=!0,r),()=>r)))},Be,()=>P("Gio.gioVolumes").warn("timed out after "+Be+"ms")),Rr),By=P("Gio.getRemoteInfo()"),Ny=$t(async t=>{try{let e=(await W(cs,["info",t],{timeout:H})).split(/[\n\r]+/),r=he(e.find(n=>n.startsWith("uri: ")),n=>new URL(Oe(n,"uri: ")));return{displayName:p(e.find(n=>n.startsWith("display name: ")),n=>Oe(n,"display name: ")),remoteHost:p(r,n=>n.hostname),remoteShare:I(r).flatMap(n=>n.pathname).flatMap(n=>Oe(n,"/")).flatMap(n=>or(n,"/")).flatMap(decodeURIComponent).filter(x).get()}}catch(e){By.warn("gio info failed",{mountpoint:t,err:e});return}},{maxSize:255,timeoutMs:st,clearEveryMs:10*A}),fs=u(async()=>T(Re.for("/proc/mounts").readLines(),t=>t.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1])),Rr);async function Vy(){return await Hr()?da(await T(fs(),t=>t.map(e=>Re.for(e).clear().childDirectories()))):[]}function ps(t){return new tp(d({name:D([t.cmd,...t.args]).join(" "),childFactory:()=>pf(t.cmd,t.args,30*A),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},t))}var tp=class{constructor(e){this.startMs=Date.now();this._stopped=!1;this.logger=u(()=>P("WatchedChild("+D([this.name,this.pid]).join(":")+")"));this.startRate=new _n(2*A);this.mutex=new _t;this._ended=!1;this.onError=async(e,r)=>{let n=Et(e)||Et(r),i=new Nr({message:e+p(r,we),cause:ro(r)?r:void 0}),o=Ve(i),s={src:e,fatal:n,ignorable:o,errToS:we(r)};if(this.logger().log(o?"warn":"error","onError()",s),this._ended||o)return;if(this.lastError=i,fe(e,i),n)return this.end();if(this.opts.onError(e,r))return this.logger().warn("onError requested restart",s),this._restart()};this.name=e.name,this.opts=d({dataSep:`
`,maxErrorsPerMinute:3,endableRank:Ue.first,exitCommand:"",restartOnExit:!0},e),this.endTimeoutMs=Uu(this.name),fi(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}async end(){return this._ended=!0,this._stop()}get proc(){return this.cp}get pid(){return p(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return re(this.pid,e=>Jo(e),async()=>!1)}notRunning(){return Ge(this.running())}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}async _stop(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});let e=this.cp;return this.cp=void 0,e==null?!0:this.stopChild(e)}async stopChild(e){return await I(this.opts.exitCommand).filter(x).flatMap(r=>I(e).flatMap(n=>n.stdin).filter(n=>n.writable).forEach(n=>Ee(()=>n.write(r+`
`))).map(Sn).get()),Pi(e,this.endTimeoutMs)}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:hu(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){if(this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),this._ended||me())return!1;if(!e&&this.startRate.msSinceLastEvent<y.minTimeBetweenServiceRestartsMs.valueOrDefault){this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:y.minTimeBetweenServiceRestartsMs.valueOrDefault});return}return this.mutex.serial(`WatchedChild(${this.name}).restart`,async()=>(await this._stop(),this._stopped=!1,this._start()))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,async()=>(this._stopped=!1,this._start()))}async _restart(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,async()=>(await this._stop(),this._stopped||this._ended?!1:this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),Jf(this.startMs,y.probationMs.valueOrDefault)&&fe("Can't restart "+this.name+", failure rate is too high."+Wt,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),this.opts.onRestart?.(),this._start())))}async _start(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended||await this.running())return!1;this.startRate.onEvent();let e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);let r="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:n,desc:i})=>{p(n,o=>o.on("error",s=>this.onError(r+i+".on(error)",s)))}),p(this.cp.stdout,n=>jo(n,this.opts.dataSep,i=>{this.logger().trace("onDataChunked()",i),this.opts.onStdout(i)})),p(this.cp.stderr,n=>n.on("data",i=>{f(i).includes("Error: Cannot find module")&&fe("Failed to start "+this.name+Wt,new Error(pt(i,256))),this.opts.onStderr?.(i)===!0&&this.onError(r+".stderr.on(data)",i)})),this.cp.on("exit",async(n,i)=>{this.logger().info("onExit",{code:n,signal:i,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?(await this._restart(),this.logger().info("onExit(): finished setting up new child "+this.pid)):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending "+this.pid),this.end())}),!0}};var bl=g(require("timers"));function ds(t,e){e=Math.ceil(e);let r,n=[],i=(...o)=>{n=o,p(r,bl.clearTimeout),r=bn(()=>t(...n),e)};return i.reset=()=>{p(r,bl.clearTimeout),r=void 0},i.now=()=>{i.reset(),t()},i}var Uy=P("Mountpoints.localMountpointSetup()");async function rp(){let t=await T(Cr(!1),e=>V(e.map(r=>r.mountpoint)));if(t!=null&&await Hr())try{await T(Vn(),e=>t.push(...e.map(r=>r.mountpoint)))}catch(e){Uy.warn("Failed to fetch gio volumes",e)}return p(t,e=>e.filter(r=>!r.startsWith("/snap/")&&r!=="/dev"))}var zy=/\s([A-Z]:\\)/g,np=async()=>Jt(te.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(t=>t.map(e=>e.Root)).filter(Q).orElse(()=>Wy()).map(t=>t.sort()).getRequired(),Wy=async()=>{let t=(await W(await Uc(),["fsinfo","drives"],{timeout:10*w})).trim(),e=[],r;for(;(r=zy.exec(t))!==null;)e.push(r[1]);return e};var jy=()=>_?np():rp(),Gy;var RU=u(async()=>{ju()?q(async()=>{let t=P("Mountpoints.localMountpointSetup()");K&&(t.info("Setting up Mac diskutil activity watcher"),Ie.setTTL(Rr),ip()),Te&&(await Hr()&&(t.info("Setting up Linux gio mount monitor"),Ie.setTTL(Rr),op()),await qy()&&(t.info("Setting up Linux findmnt mount monitor"),Ie.setTTL(Rr),sp()))},30*w).unref():await vo([Gr(ip.clear()),Gr(op.clear()),Gr(sp.clear())])}),Ie=u(async()=>(await mr(()=>hr(Gy,jy),{maxRetries:3,onRetryWaitUntil:r=>be(r*1500)}).catch(r=>{fe("mountpoints() failed",r)}))?.sort(),Be);q(()=>ee(()=>Ie.unset()));var ip=u(()=>ps({cmd:"diskutil",args:["activity"],onStdout:ds(()=>Ie.unset(),1.5*w)})),op=u(()=>ps({cmd:cs,args:ep,onStdout:ds(()=>{Vn.unset(),fs.unset(),Ie.unset()},1.5*w)})),qy=u(async()=>{if(!Te)return!1;try{return(await Rt("findmnt",["--version"],{timeout:H,ignoreStderr:!0})).code===0}catch(t){return!1}}),sp=u(()=>ps({cmd:"findmnt",args:["--poll"],onStdout:ds(()=>{fs.unset(),Ie.unset()},1.5*w)}));function et(t,e){let r=oc("vol."+t,()=>mr(e,{maxRetries:2,timeoutMs:H,errorIsRetriable:n=>Ve(n)}),Im);return Ie.onChange(()=>r.unset()),q(()=>ee(()=>r.unset())),r}var Ky=et("localMountpoints",()=>T(Cr(!0),t=>t.map(e=>e.mountpoint))),ap=et("dfPosix",async()=>{let t=await Cr(!1);if(t!=null)return await T(Ky(),e=>{t.forEach(r=>{r.remote=!e.includes(r.mountpoint)})}),await Hr()&&await T(Vn(),e=>t.push(...e)),t});async function lp(t,e){if(!_)throw new Error("wtf");return await T(v(e,()=>Cy()),r=>{let n=vi(r,i=>[i.mountpoint,i]);t.forEach(i=>{p(n.get(i.mountpoint),o=>{i.remote=!0,i.remoteHost=o.host,i.remoteShare=o.share,i.ok=o.ok})})}),t}var up=["LocalName","RemoteName","Status"],Hy=["NETUSE","get",up.join(",")],mp=/^\\\\(.+?)\\(.+)$/,cp=/^[a-z]:\\?$/i;async function Yy(){let t=await te.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return t==null?Jy():D(t.filter(e=>x(e.LocalName)).map(e=>p(Tl(e.RemoteName),({host:r,share:n})=>p(cp.exec(f(e.LocalName)),i=>({mountpoint:We(i[0],"\\"),host:r,share:n,ok:e.Status==="OK"&&e.ConnectionState==="Connected"})))))}function Tl(t){if(!M(t))return I(t).flatMap(e=>mp.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>I(t).flatMap(e=>Ee(()=>new URL(e))).filter(e=>x(e.hostname)).map(e=>({host:e.hostname,share:I(e.pathname).filter(x).getOrElse(()=>"/")}))).get()}async function Jy(){let t=qo(),e=await W(t,Hy,{timeout:15*w}),r=Ht(up,e);return D(r.map(n=>p(mp.exec(f(n.RemoteName)),i=>p(cp.exec(f(n.LocalName)),o=>({mountpoint:We(o[0],"\\"),host:i[1],share:i[2],ok:n.Status==="OK"})))))}var Cy=et("netInfoWin",Yy);var fp=u(()=>P("DfWin")),pp=et("dfWin",async()=>(await Xy()).filter(e=>e.ok!==!1&&G(e.size))),Zy="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free";function Qy(t){return x(t.Root)&&t.Free!=null&&t.Used!=null?d({mountpoint:t.Root,label:t.Description,size:t.Used+t.Free,used:t.Used,available:t.Free,remote:x(t.DisplayRoot)},p(Tl(t.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))):void 0}var $y="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus,UniqueId",eb=/\{([-a-z0-9]{7,})\}/i;function tb(t){return fp().tap({msg:"uniqueId2uuid",result:p(eb.exec(f(t)),e=>e[1]),meta:{s:t}})}function rb(t){if(t.DriveLetter==null||t.DriveLetter==="null"||t.FileSystemLabel==="System Reserved")return;let e=t.Size!=null&&t.SizeRemaining!=null&&x(t.DriveLetter)&&(Rs(t.HealthStatus,r=>se(r,"Healthy"))||Rs(t.OperationalStatus,r=>se(r,"OK")));return{mountpoint:t.DriveLetter+":\\",filesystem:t.FileSystem,label:t.FileSystemLabel,uuid:tb(t.UniqueId),size:t.Size,used:t.Size-t.SizeRemaining,available:t.SizeRemaining,remote:!1,ok:e}}async function Xy(){let t=await $n(te.instance().executeJsonToA(Zy).catch(i=>(fe("volumeInfoWin(): LocalAndNetCmd failed",i),[])),i=>qs(Qy(i))),e=await $n(te.instance().executeJsonToA($y).catch(i=>(fe("_localAndNet(): LocalCmd failed",i),[])),i=>qs(rb(i))),r=X([...t,...e].filter(i=>i.ok===!1).map(i=>i.mountpoint)),n=rr(X([...t,...e].map(i=>i.mountpoint)).filter(i=>!r.includes(i)));return fp().info("volumeInfoWin()",{getPsDrive:t,getVolumes:e,mountpoints:n,unhealthy:r}),n.map(i=>d(d({},t.find(o=>i===o.mountpoint)),e.find(o=>i===o.mountpoint)))}async function dp(t){return T(nb(),e=>t.map(r=>re(e.get(r.mountpoint),n=>d(d({},r),n),()=>r)))}var nb=et("mnt2uuidMac",async()=>{let e=(await W("diskutil",["info","-all"],{timeout:H})).split(/^\s*\*{8,12}\s*$/m);return vi(e,r=>{let n=vi(r.split(/\s*\n+\s*/),a=>{let[m,c]=a.split(":").map(h=>h.trim());return om(["not applicable","no file system"],c)?void 0:[m.toLowerCase(),c]}),i=n.get("mount point"),o=n.get("volume name"),s=n.get("volume uuid");return M(i)?void 0:[i,{label:o,uuid:s}]})});function hp({input:t,lowerCaseKeys:e}){let r={},n;for(let i of Ct(t).filter(o=>o.match(/^\s*#/)==null)){let o=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+|#.*?)/gim;for(;(n=o.exec(i))!=null;){let[,s,a,m]=n;r[e?s.toLowerCase():s]=rm(m,a,a)}}return r}var ib=u(()=>P("LocalVolumesPosix"));async function gp(t){return T(await ob(),e=>ta(X([...e.filter(n=>!n.ignorable).map(n=>n.mountpoint),...t.map(n=>n.mountpoint)])).map(n=>d(d({},t.find(i=>i.mountpoint===n)),e.find(i=>i.mountpoint===n))))}var ob=et("localVolumeInfoPosix",async()=>{let t=await W("lsblk",["-P","-b","--output","mountpoint,label,fsused,fsavail,uuid"],{timeout:H}),e=Ct(t).map(n=>hp({input:n,lowerCaseKeys:!0})).filter(n=>n!=null),r=await Am(e,async n=>{let i=M(n.mountpoint)||n.mountpoint.startsWith("/snap/")||n.mountpoint==="/boot"||n.mountpoint.startsWith("/boot/")||!await Bm(n.mountpoint);return Fs(j(n.fsused),j(n.fsavail),(o,s)=>d({mountpoint:n.mountpoint,label:n.label,uuid:n.uuid,ignorable:i,used:o,available:s,size:o+s},ce()?void 0:{remote:!1}))});return ib().tap({msg:"lsblk",result:r})});var sb=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i,ab=/^([^:\s]+):(\/.+)$/;async function yp(t){return t.filter(e=>e.remote).forEach(e=>{re(sb.exec(f(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]},()=>p(ab.exec(f(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]}))}),t}async function bp(t,e){try{return await(e.timeoutMs==null?t():Se(t,e.timeoutMs,()=>fe(e.message+": timeout",void 0,e.context)))}catch(r){fe(e.message,r,e.context);return}}var Tp=g(require("crypto"));function lb(){let t=(0,Tp.randomBytes)(16);t[6]=t[6]&15|64;let e=t.toString("hex");return[e.slice(0,8),e.slice(8,12),e.slice(12,16),e.slice(16,20),e.slice(20)].join("-")}function vp(){return di(lb)}var sz=u(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/);var Ii=u(()=>P("VolumeUUID")),xp=Be/2,vl=new Map;q(()=>{ee(()=>vl.clear()),Ie.onChange(()=>vl.clear())});async function wp(t){await ur({name:"addVolumeUUIDs",laters:t.map(e=>()=>ub(e))})}async function ub(t){if(B(t.ignorable)){Ii().debug("volumeUUID(): ignorable is true for "+t.mountpoint);return}if(Mt(t.ok)){Ii().debug("volumeUUID(): remoteOK is false for "+t.mountpoint);return}await T(it(vl,t.mountpoint,()=>Ao(()=>bp(()=>mb(t),{message:"readVolumeUUID("+t.mountpoint+")"}),xp)),e=>t.uuid=e)}async function mb(t){let e=Ce.for(t.mountpoint).join(".uuid");if(y.readVolumeUuidFiles.valueOrDefault){let r=await Ao(()=>Jt(e.readFile("debug")).map(n=>n.toString().trim()).filter(x).get(),xp);if(r!=null&&r.length>6)return Ii().debug("Serving UUID from .uuid",{uuid:r,mountpoint:t.mountpoint}),r}if(t.mountpoint==="/")return t.uuid;if(y.writeVolumeUuidFiles.valueOrDefault){let r=tn(t.uuid,vp);if(await e.parent().isReadWritable())try{return await e.writeTxt_(r),Ii().info("volumeUUID(): Saved new UUID for "+t.mountpoint,{uuid:r}),r}catch(n){Ii().warn("volumeUUID(): Failed to save new UUID for "+t.mountpoint,n)}}return t.uuid}var Di=u(()=>P("Volumes"));async function cb(){let t=await Se(_?pp():ap(),Be,()=>fe("Timed out getting local volume metadata"));if(t==null){Di().warn("df failed");return}let e=y.validateMountpoints.valueOrDefault?D(await ur({name:"nonRpcVolumes: filter unhealthy volumes",laters:t.map(i=>async()=>{try{if(await Po(i.mountpoint,wo/2))return i;Di().info("validateMountpoints(): "+i.mountpoint+" is not a directory")}catch(o){Di().info("validateMountpoints(): failed to stat "+i.mountpoint,o)}})})):t;e.some(i=>i.remote&&M(i.remoteHost))&&await Se(_?lp(e):yp(e),10*w).catch(i=>{fe("Failed to get remote volume info",i)});let r=v(await(_?e:K?dp(e):gp(e)),e);Ye(r,i=>!B(i.ignorable)),y.ignoreUnhealthyVolumes.valueOrDefault&&Ye(r,i=>!Mt(i.ok));for(let i of r)i.remote=B(i.remote),he(i.remoteHost,o=>i.remoteHost=o.toLowerCase().normalize().trim());for(let i of r)M(i.label)&&delete i.label;Di().debug("nonRpcVolumes(): before addVolumeUUIDs",r),await wp(r);let n=$(r,i=>i.mountpoint);return Di().debug("_volumes(): final result",{sorted:n}),Object.freeze(n)}var fb;var Sp=[],pb=async()=>{try{let t=await hr(fb,cb);return Pe(t,e=>{let r=e.map(n=>n.mountpoint).sort();ot(Sp,r)||(vm(),Sp=r)}),t}catch(t){fe("volumes() failed",t);return}},Bn=et("volumes",pb),sW=u(()=>_?I(ye("SystemDrive")).filter(x).orElse(()=>"C:").map(t=>We(t,"\\")).get():"/");async function hs(t){return T(Bn(),e=>db(e,t))}function db(t,e){let r=t.filter(n=>So(e,n.mountpoint));return mn(r,n=>Qn(n.mountpoint,e))}var bs=g(require("path"));function Mp(t,e){let r=0,n=new cr(e.maxSize,e.ttlMs),i=o=>(r++,n.getOrSet(F(o),()=>t(o)));return i.clear=o=>o==null?n.clear():n.delete(F(o)),i.size=()=>n.size,i.callCount=()=>r,i}var gs=g(require("path")),Pp=g(require("punycode")),Ep=g(require("util"));var R;(function(t){t[t.Null=0]="Null",t[t.Backspace=8]="Backspace",t[t.Tab=9]="Tab",t[t.LineFeed=10]="LineFeed",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.ExclamationMark=33]="ExclamationMark",t[t.DoubleQuote=34]="DoubleQuote",t[t.Hash=35]="Hash",t[t.DollarSign=36]="DollarSign",t[t.PercentSign=37]="PercentSign",t[t.Ampersand=38]="Ampersand",t[t.SingleQuote=39]="SingleQuote",t[t.OpenParen=40]="OpenParen",t[t.CloseParen=41]="CloseParen",t[t.Asterisk=42]="Asterisk",t[t.Plus=43]="Plus",t[t.Comma=44]="Comma",t[t.Dash=45]="Dash",t[t.Period=46]="Period",t[t.Slash=47]="Slash",t[t.Digit0=48]="Digit0",t[t.Digit1=49]="Digit1",t[t.Digit2=50]="Digit2",t[t.Digit3=51]="Digit3",t[t.Digit4=52]="Digit4",t[t.Digit5=53]="Digit5",t[t.Digit6=54]="Digit6",t[t.Digit7=55]="Digit7",t[t.Digit8=56]="Digit8",t[t.Digit9=57]="Digit9",t[t.Colon=58]="Colon",t[t.Semicolon=59]="Semicolon",t[t.LessThan=60]="LessThan",t[t.Equals=61]="Equals",t[t.GreaterThan=62]="GreaterThan",t[t.QuestionMark=63]="QuestionMark",t[t.AtSign=64]="AtSign",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.OpenSquareBracket=91]="OpenSquareBracket",t[t.Backslash=92]="Backslash",t[t.CloseSquareBracket=93]="CloseSquareBracket",t[t.Caret=94]="Caret",t[t.Underline=95]="Underline",t[t.BackTick=96]="BackTick",t[t.a=97]="a",t[t.b=98]="b",t[t.c=99]="c",t[t.d=100]="d",t[t.e=101]="e",t[t.f=102]="f",t[t.g=103]="g",t[t.h=104]="h",t[t.i=105]="i",t[t.j=106]="j",t[t.k=107]="k",t[t.l=108]="l",t[t.m=109]="m",t[t.n=110]="n",t[t.o=111]="o",t[t.p=112]="p",t[t.q=113]="q",t[t.r=114]="r",t[t.s=115]="s",t[t.t=116]="t",t[t.u=117]="u",t[t.v=118]="v",t[t.w=119]="w",t[t.x=120]="x",t[t.y=121]="y",t[t.z=122]="z",t[t.OpenCurlyBrace=123]="OpenCurlyBrace",t[t.Pipe=124]="Pipe",t[t.CloseCurlyBrace=125]="CloseCurlyBrace",t[t.Tilde=126]="Tilde",t[t.U_Combining_Grave_Accent=768]="U_Combining_Grave_Accent",t[t.U_Combining_Acute_Accent=769]="U_Combining_Acute_Accent",t[t.U_Combining_Circumflex_Accent=770]="U_Combining_Circumflex_Accent",t[t.U_Combining_Tilde=771]="U_Combining_Tilde",t[t.U_Combining_Macron=772]="U_Combining_Macron",t[t.U_Combining_Overline=773]="U_Combining_Overline",t[t.U_Combining_Breve=774]="U_Combining_Breve",t[t.U_Combining_Dot_Above=775]="U_Combining_Dot_Above",t[t.U_Combining_Diaeresis=776]="U_Combining_Diaeresis",t[t.U_Combining_Hook_Above=777]="U_Combining_Hook_Above",t[t.U_Combining_Ring_Above=778]="U_Combining_Ring_Above",t[t.U_Combining_Double_Acute_Accent=779]="U_Combining_Double_Acute_Accent",t[t.U_Combining_Caron=780]="U_Combining_Caron",t[t.U_Combining_Vertical_Line_Above=781]="U_Combining_Vertical_Line_Above",t[t.U_Combining_Double_Vertical_Line_Above=782]="U_Combining_Double_Vertical_Line_Above",t[t.U_Combining_Double_Grave_Accent=783]="U_Combining_Double_Grave_Accent",t[t.U_Combining_Candrabindu=784]="U_Combining_Candrabindu",t[t.U_Combining_Inverted_Breve=785]="U_Combining_Inverted_Breve",t[t.U_Combining_Turned_Comma_Above=786]="U_Combining_Turned_Comma_Above",t[t.U_Combining_Comma_Above=787]="U_Combining_Comma_Above",t[t.U_Combining_Reversed_Comma_Above=788]="U_Combining_Reversed_Comma_Above",t[t.U_Combining_Comma_Above_Right=789]="U_Combining_Comma_Above_Right",t[t.U_Combining_Grave_Accent_Below=790]="U_Combining_Grave_Accent_Below",t[t.U_Combining_Acute_Accent_Below=791]="U_Combining_Acute_Accent_Below",t[t.U_Combining_Left_Tack_Below=792]="U_Combining_Left_Tack_Below",t[t.U_Combining_Right_Tack_Below=793]="U_Combining_Right_Tack_Below",t[t.U_Combining_Left_Angle_Above=794]="U_Combining_Left_Angle_Above",t[t.U_Combining_Horn=795]="U_Combining_Horn",t[t.U_Combining_Left_Half_Ring_Below=796]="U_Combining_Left_Half_Ring_Below",t[t.U_Combining_Up_Tack_Below=797]="U_Combining_Up_Tack_Below",t[t.U_Combining_Down_Tack_Below=798]="U_Combining_Down_Tack_Below",t[t.U_Combining_Plus_Sign_Below=799]="U_Combining_Plus_Sign_Below",t[t.U_Combining_Minus_Sign_Below=800]="U_Combining_Minus_Sign_Below",t[t.U_Combining_Palatalized_Hook_Below=801]="U_Combining_Palatalized_Hook_Below",t[t.U_Combining_Retroflex_Hook_Below=802]="U_Combining_Retroflex_Hook_Below",t[t.U_Combining_Dot_Below=803]="U_Combining_Dot_Below",t[t.U_Combining_Diaeresis_Below=804]="U_Combining_Diaeresis_Below",t[t.U_Combining_Ring_Below=805]="U_Combining_Ring_Below",t[t.U_Combining_Comma_Below=806]="U_Combining_Comma_Below",t[t.U_Combining_Cedilla=807]="U_Combining_Cedilla",t[t.U_Combining_Ogonek=808]="U_Combining_Ogonek",t[t.U_Combining_Vertical_Line_Below=809]="U_Combining_Vertical_Line_Below",t[t.U_Combining_Bridge_Below=810]="U_Combining_Bridge_Below",t[t.U_Combining_Inverted_Double_Arch_Below=811]="U_Combining_Inverted_Double_Arch_Below",t[t.U_Combining_Caron_Below=812]="U_Combining_Caron_Below",t[t.U_Combining_Circumflex_Accent_Below=813]="U_Combining_Circumflex_Accent_Below",t[t.U_Combining_Breve_Below=814]="U_Combining_Breve_Below",t[t.U_Combining_Inverted_Breve_Below=815]="U_Combining_Inverted_Breve_Below",t[t.U_Combining_Tilde_Below=816]="U_Combining_Tilde_Below",t[t.U_Combining_Macron_Below=817]="U_Combining_Macron_Below",t[t.U_Combining_Low_Line=818]="U_Combining_Low_Line",t[t.U_Combining_Double_Low_Line=819]="U_Combining_Double_Low_Line",t[t.U_Combining_Tilde_Overlay=820]="U_Combining_Tilde_Overlay",t[t.U_Combining_Short_Stroke_Overlay=821]="U_Combining_Short_Stroke_Overlay",t[t.U_Combining_Long_Stroke_Overlay=822]="U_Combining_Long_Stroke_Overlay",t[t.U_Combining_Short_Solidus_Overlay=823]="U_Combining_Short_Solidus_Overlay",t[t.U_Combining_Long_Solidus_Overlay=824]="U_Combining_Long_Solidus_Overlay",t[t.U_Combining_Right_Half_Ring_Below=825]="U_Combining_Right_Half_Ring_Below",t[t.U_Combining_Inverted_Bridge_Below=826]="U_Combining_Inverted_Bridge_Below",t[t.U_Combining_Square_Below=827]="U_Combining_Square_Below",t[t.U_Combining_Seagull_Below=828]="U_Combining_Seagull_Below",t[t.U_Combining_X_Above=829]="U_Combining_X_Above",t[t.U_Combining_Vertical_Tilde=830]="U_Combining_Vertical_Tilde",t[t.U_Combining_Double_Overline=831]="U_Combining_Double_Overline",t[t.U_Combining_Grave_Tone_Mark=832]="U_Combining_Grave_Tone_Mark",t[t.U_Combining_Acute_Tone_Mark=833]="U_Combining_Acute_Tone_Mark",t[t.U_Combining_Greek_Perispomeni=834]="U_Combining_Greek_Perispomeni",t[t.U_Combining_Greek_Koronis=835]="U_Combining_Greek_Koronis",t[t.U_Combining_Greek_Dialytika_Tonos=836]="U_Combining_Greek_Dialytika_Tonos",t[t.U_Combining_Greek_Ypogegrammeni=837]="U_Combining_Greek_Ypogegrammeni",t[t.U_Combining_Bridge_Above=838]="U_Combining_Bridge_Above",t[t.U_Combining_Equals_Sign_Below=839]="U_Combining_Equals_Sign_Below",t[t.U_Combining_Double_Vertical_Line_Below=840]="U_Combining_Double_Vertical_Line_Below",t[t.U_Combining_Left_Angle_Below=841]="U_Combining_Left_Angle_Below",t[t.U_Combining_Not_Tilde_Above=842]="U_Combining_Not_Tilde_Above",t[t.U_Combining_Homothetic_Above=843]="U_Combining_Homothetic_Above",t[t.U_Combining_Almost_Equal_To_Above=844]="U_Combining_Almost_Equal_To_Above",t[t.U_Combining_Left_Right_Arrow_Below=845]="U_Combining_Left_Right_Arrow_Below",t[t.U_Combining_Upwards_Arrow_Below=846]="U_Combining_Upwards_Arrow_Below",t[t.U_Combining_Grapheme_Joiner=847]="U_Combining_Grapheme_Joiner",t[t.U_Combining_Right_Arrowhead_Above=848]="U_Combining_Right_Arrowhead_Above",t[t.U_Combining_Left_Half_Ring_Above=849]="U_Combining_Left_Half_Ring_Above",t[t.U_Combining_Fermata=850]="U_Combining_Fermata",t[t.U_Combining_X_Below=851]="U_Combining_X_Below",t[t.U_Combining_Left_Arrowhead_Below=852]="U_Combining_Left_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_Below=853]="U_Combining_Right_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below=854]="U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below",t[t.U_Combining_Right_Half_Ring_Above=855]="U_Combining_Right_Half_Ring_Above",t[t.U_Combining_Dot_Above_Right=856]="U_Combining_Dot_Above_Right",t[t.U_Combining_Asterisk_Below=857]="U_Combining_Asterisk_Below",t[t.U_Combining_Double_Ring_Below=858]="U_Combining_Double_Ring_Below",t[t.U_Combining_Zigzag_Above=859]="U_Combining_Zigzag_Above",t[t.U_Combining_Double_Breve_Below=860]="U_Combining_Double_Breve_Below",t[t.U_Combining_Double_Breve=861]="U_Combining_Double_Breve",t[t.U_Combining_Double_Macron=862]="U_Combining_Double_Macron",t[t.U_Combining_Double_Macron_Below=863]="U_Combining_Double_Macron_Below",t[t.U_Combining_Double_Tilde=864]="U_Combining_Double_Tilde",t[t.U_Combining_Double_Inverted_Breve=865]="U_Combining_Double_Inverted_Breve",t[t.U_Combining_Double_Rightwards_Arrow_Below=866]="U_Combining_Double_Rightwards_Arrow_Below",t[t.U_Combining_Latin_Small_Letter_A=867]="U_Combining_Latin_Small_Letter_A",t[t.U_Combining_Latin_Small_Letter_E=868]="U_Combining_Latin_Small_Letter_E",t[t.U_Combining_Latin_Small_Letter_I=869]="U_Combining_Latin_Small_Letter_I",t[t.U_Combining_Latin_Small_Letter_O=870]="U_Combining_Latin_Small_Letter_O",t[t.U_Combining_Latin_Small_Letter_U=871]="U_Combining_Latin_Small_Letter_U",t[t.U_Combining_Latin_Small_Letter_C=872]="U_Combining_Latin_Small_Letter_C",t[t.U_Combining_Latin_Small_Letter_D=873]="U_Combining_Latin_Small_Letter_D",t[t.U_Combining_Latin_Small_Letter_H=874]="U_Combining_Latin_Small_Letter_H",t[t.U_Combining_Latin_Small_Letter_M=875]="U_Combining_Latin_Small_Letter_M",t[t.U_Combining_Latin_Small_Letter_R=876]="U_Combining_Latin_Small_Letter_R",t[t.U_Combining_Latin_Small_Letter_T=877]="U_Combining_Latin_Small_Letter_T",t[t.U_Combining_Latin_Small_Letter_V=878]="U_Combining_Latin_Small_Letter_V",t[t.U_Combining_Latin_Small_Letter_X=879]="U_Combining_Latin_Small_Letter_X",t[t.LINE_SEPARATOR=8232]="LINE_SEPARATOR",t[t.PARAGRAPH_SEPARATOR=8233]="PARAGRAPH_SEPARATOR",t[t.NEXT_LINE=133]="NEXT_LINE",t[t.U_CIRCUMFLEX=94]="U_CIRCUMFLEX",t[t.U_GRAVE_ACCENT=96]="U_GRAVE_ACCENT",t[t.U_DIAERESIS=168]="U_DIAERESIS",t[t.U_MACRON=175]="U_MACRON",t[t.U_ACUTE_ACCENT=180]="U_ACUTE_ACCENT",t[t.U_CEDILLA=184]="U_CEDILLA",t[t.U_MODIFIER_LETTER_LEFT_ARROWHEAD=706]="U_MODIFIER_LETTER_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_RIGHT_ARROWHEAD=707]="U_MODIFIER_LETTER_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_UP_ARROWHEAD=708]="U_MODIFIER_LETTER_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_DOWN_ARROWHEAD=709]="U_MODIFIER_LETTER_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING=722]="U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING",t[t.U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING=723]="U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING",t[t.U_MODIFIER_LETTER_UP_TACK=724]="U_MODIFIER_LETTER_UP_TACK",t[t.U_MODIFIER_LETTER_DOWN_TACK=725]="U_MODIFIER_LETTER_DOWN_TACK",t[t.U_MODIFIER_LETTER_PLUS_SIGN=726]="U_MODIFIER_LETTER_PLUS_SIGN",t[t.U_MODIFIER_LETTER_MINUS_SIGN=727]="U_MODIFIER_LETTER_MINUS_SIGN",t[t.U_BREVE=728]="U_BREVE",t[t.U_DOT_ABOVE=729]="U_DOT_ABOVE",t[t.U_RING_ABOVE=730]="U_RING_ABOVE",t[t.U_OGONEK=731]="U_OGONEK",t[t.U_SMALL_TILDE=732]="U_SMALL_TILDE",t[t.U_DOUBLE_ACUTE_ACCENT=733]="U_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_RHOTIC_HOOK=734]="U_MODIFIER_LETTER_RHOTIC_HOOK",t[t.U_MODIFIER_LETTER_CROSS_ACCENT=735]="U_MODIFIER_LETTER_CROSS_ACCENT",t[t.U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR=741]="U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_HIGH_TONE_BAR=742]="U_MODIFIER_LETTER_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_MID_TONE_BAR=743]="U_MODIFIER_LETTER_MID_TONE_BAR",t[t.U_MODIFIER_LETTER_LOW_TONE_BAR=744]="U_MODIFIER_LETTER_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR=745]="U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK=746]="U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK=747]="U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_UNASPIRATED=749]="U_MODIFIER_LETTER_UNASPIRATED",t[t.U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD=751]="U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_UP_ARROWHEAD=752]="U_MODIFIER_LETTER_LOW_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD=753]="U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD=754]="U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RING=755]="U_MODIFIER_LETTER_LOW_RING",t[t.U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT=756]="U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT=757]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT=758]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_LOW_TILDE=759]="U_MODIFIER_LETTER_LOW_TILDE",t[t.U_MODIFIER_LETTER_RAISED_COLON=760]="U_MODIFIER_LETTER_RAISED_COLON",t[t.U_MODIFIER_LETTER_BEGIN_HIGH_TONE=761]="U_MODIFIER_LETTER_BEGIN_HIGH_TONE",t[t.U_MODIFIER_LETTER_END_HIGH_TONE=762]="U_MODIFIER_LETTER_END_HIGH_TONE",t[t.U_MODIFIER_LETTER_BEGIN_LOW_TONE=763]="U_MODIFIER_LETTER_BEGIN_LOW_TONE",t[t.U_MODIFIER_LETTER_END_LOW_TONE=764]="U_MODIFIER_LETTER_END_LOW_TONE",t[t.U_MODIFIER_LETTER_SHELF=765]="U_MODIFIER_LETTER_SHELF",t[t.U_MODIFIER_LETTER_OPEN_SHELF=766]="U_MODIFIER_LETTER_OPEN_SHELF",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROW=767]="U_MODIFIER_LETTER_LOW_LEFT_ARROW",t[t.U_GREEK_LOWER_NUMERAL_SIGN=885]="U_GREEK_LOWER_NUMERAL_SIGN",t[t.U_GREEK_TONOS=900]="U_GREEK_TONOS",t[t.U_GREEK_DIALYTIKA_TONOS=901]="U_GREEK_DIALYTIKA_TONOS",t[t.U_GREEK_KORONIS=8125]="U_GREEK_KORONIS",t[t.U_GREEK_PSILI=8127]="U_GREEK_PSILI",t[t.U_GREEK_PERISPOMENI=8128]="U_GREEK_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_PERISPOMENI=8129]="U_GREEK_DIALYTIKA_AND_PERISPOMENI",t[t.U_GREEK_PSILI_AND_VARIA=8141]="U_GREEK_PSILI_AND_VARIA",t[t.U_GREEK_PSILI_AND_OXIA=8142]="U_GREEK_PSILI_AND_OXIA",t[t.U_GREEK_PSILI_AND_PERISPOMENI=8143]="U_GREEK_PSILI_AND_PERISPOMENI",t[t.U_GREEK_DASIA_AND_VARIA=8157]="U_GREEK_DASIA_AND_VARIA",t[t.U_GREEK_DASIA_AND_OXIA=8158]="U_GREEK_DASIA_AND_OXIA",t[t.U_GREEK_DASIA_AND_PERISPOMENI=8159]="U_GREEK_DASIA_AND_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_VARIA=8173]="U_GREEK_DIALYTIKA_AND_VARIA",t[t.U_GREEK_DIALYTIKA_AND_OXIA=8174]="U_GREEK_DIALYTIKA_AND_OXIA",t[t.U_GREEK_VARIA=8175]="U_GREEK_VARIA",t[t.U_GREEK_OXIA=8189]="U_GREEK_OXIA",t[t.U_GREEK_DASIA=8190]="U_GREEK_DASIA",t[t.U_OVERLINE=8254]="U_OVERLINE",t[t.UTF8_BOM=65279]="UTF8_BOM"})(R||(R={}));var hb=/^\w[\w\d+.-]*$/,gb=/^\//,yb=/^\/\//;function bb(t,e){if(!t.scheme&&e===!0)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${t.authority}", path: "${t.path}", query: "${t.query}", fragment: "${t.fragment}"}`);if(t.scheme&&!hb.test(t.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(t.path){if(t.authority){if(!gb.test(t.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(yb.test(t.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}}function Tb(t,e){return!t&&!e?"file":t}function vb(t,e){switch(t){case"https":case"http":case"file":e?e[0]!==De&&(e=De+e):e=De;break}return e}var Z="",De="/",xb=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,ae=class{static isUri(e){return e instanceof ae?!0:e==null?!1:typeof e.authority=="string"&&typeof e.fragment=="string"&&typeof e.path=="string"&&typeof e.query=="string"&&typeof e.scheme=="string"&&typeof e.fsPath=="function"&&typeof e.with=="function"&&typeof e.toString=="function"}constructor(e,r,n,i,o,s=!1){typeof e=="object"?(this.scheme=e.scheme||Z,this.authority=e.authority||Z,this.path=e.path||Z,this.query=e.query||Z,this.fragment=e.fragment||Z):(this.scheme=Tb(e,s),this.authority=v(r,Z),this.path=vb(this.scheme,v(n,Z)),this.query=v(i,Z),this.fragment=v(o,Z),bb(this,s))}get fsPath(){return xl(this,!1)}with(e){if(e==null)return this;let{scheme:r,authority:n,path:i,query:o,fragment:s}=e;return r===void 0?r=this.scheme:r===null&&(r=Z),n===void 0?n=this.authority:n===null&&(n=Z),i===void 0?i=this.path:i===null&&(i=Z),o===void 0?o=this.query:o===null&&(o=Z),s===void 0?s=this.fragment:s===null&&(s=Z),r===this.scheme&&n===this.authority&&i===this.path&&o===this.query&&s===this.fragment?this:new Un(r,n,i,o,s)}static parse(e,r=!1){let n=xb.exec(e);if(!n)return new Un(Z,Z,Z,Z,Z);let i=n[2]||Z,o=ys(n[4]||Z),s=(n[5]||Z).split("/").map(ys).join("/"),a=i==="psfile"&&s.startsWith("//")?s.slice(1):s,m=ys(n[7]||Z),c=ys(n[9]||Z);return new Un(i,o,a,m,c,r)}static file(e){let r=Z;if(_&&(e=e.replace(/\\/g,De)),e[0]===De&&e[1]===De){let n=e.indexOf(De,2);n===-1?(r=e.substring(2),e=De):(r=e.substring(2,n),e=e.substring(n)||De)}return new Un("file",r,e,Z,Z)}static from(e){return new Un(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...r){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let n;return _&&e.scheme==="file"?n=ae.file(gs.win32.join(xl(e,!0),...r)).path:n=gs.posix.join(e.path,...r),e.with({path:n})}isRootPath(){return this.path==null||this.path===De}get pathBase(){return this.isRootPath()?"":p(this.path,e=>qu(e.split(De),x))}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(De))})}join(...e){return this.with({path:We(this.path,De)+e.join(De)})}toString(e=!1){return wl(this,e)}toJSON(){return this}[Ep.inspect.custom](){return this.toString()}},wb=Rm?1:void 0,Un=class extends ae{constructor(){super(...arguments);this._formatted=null;this._fsPath=null}get fsPath(){return this._fsPath==null&&(this._fsPath=xl(this,!1)),this._fsPath}toString(e=!1){return e?wl(this,!0):(this._formatted==null&&(this._formatted=wl(this,!1)),this._formatted)}toJSON(){let e={$mid:1};return this._fsPath!=null&&(e.fsPath=this._fsPath,e._sep=wb),this._formatted!=null&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),this.query&&(e.query=this.query),this.fragment&&(e.fragment=this.fragment),e}},_p={[R.Colon]:"%3A",[R.Slash]:"%2F",[R.QuestionMark]:"%3F",[R.Hash]:"%23",[R.OpenSquareBracket]:"%5B",[R.CloseSquareBracket]:"%5D",[R.AtSign]:"%40",[R.ExclamationMark]:"%21",[R.DollarSign]:"%24",[R.Ampersand]:"%26",[R.SingleQuote]:"%27",[R.OpenParen]:"%28",[R.CloseParen]:"%29",[R.Asterisk]:"%2A",[R.Plus]:"%2B",[R.Comma]:"%2C",[R.Semicolon]:"%3B",[R.Equals]:"%3D",[R.Space]:"%20"};function Lp(t,e){let r,n=-1;for(let i=0;i<t.length;i++){let o=t.charCodeAt(i);if(o>=R.a&&o<=R.z||o>=R.A&&o<=R.Z||o>=R.Digit0&&o<=R.Digit9||o===R.Dash||o===R.Period||o===R.Underline||o===R.Tilde||e&&o===R.Slash)n!==-1&&(r+=encodeURIComponent(t.substring(n,i)),n=-1),r!==void 0&&(r+=t.charAt(i));else{r===void 0&&(r=t.substr(0,i));let s=_p[o];s!==void 0?(n!==-1&&(r+=encodeURIComponent(t.substring(n,i)),n=-1),r+=s):n===-1&&(n=i)}}return n!==-1&&(r+=encodeURIComponent(t.substring(n))),r!==void 0?r:t}function Sb(t){let e;for(let r=0;r<t.length;r++){let n=t.charCodeAt(r);n===R.Hash||n===R.QuestionMark?(e===void 0&&(e=t.substr(0,r)),e+=_p[n]):e!==void 0&&(e+=t[r])}return e!==void 0?e:t}function xl(t,e){let r;return t.authority&&t.path.length>1&&t.scheme==="file"?r=`//${t.authority}${t.path}`:t.path.charCodeAt(0)===R.Slash&&(t.path.charCodeAt(1)>=R.A&&t.path.charCodeAt(1)<=R.Z||t.path.charCodeAt(1)>=R.a&&t.path.charCodeAt(1)<=R.z)&&t.path.charCodeAt(2)===R.Colon?e?r=t.path.substr(1):r=t.path[1].toLowerCase()+t.path.substr(2):r=t.path,_&&(r=r.replace(/\//g,"\\")),r}function wl(t,e){let r=e?Sb:Lp,n="",{scheme:i,query:o,fragment:s}=t,{authority:a,path:m}=t;if(i&&(n+=i,n+=":"),(a||i==="file")&&(n+=De,n+=De),a){let c=a.indexOf("@");if(c!==-1){let h=a.substr(0,c);a=a.substr(c+1),c=h.indexOf(":"),c===-1?n+=r(h,!1):(n+=r(h.substr(0,c),!1),n+=":",n+=r(h.substr(c+1),!1)),n+="@"}c=a.indexOf(":"),c===-1?n+=r(a,!1):(n+=r(a.substr(0,c),!1),n+=a.substr(c))}if(m){if(m.length>=3&&m.charCodeAt(0)===R.Slash&&m.charCodeAt(2)===R.Colon){let c=m.charCodeAt(1);c>=R.A&&c<=R.Z&&(m=`/${String.fromCharCode(c+32)}:${m.substr(3)}`)}else if(m.length>=2&&m.charCodeAt(1)===R.Colon){let c=m.charCodeAt(0);c>=R.A&&c<=R.Z&&(m=`${String.fromCharCode(c+32)}:${m.substr(2)}`)}n+=r(m,!0)}return o&&(n+="?",n+=r(o,!1)),s&&(n+="#",n+=e?s:Lp(s,!1)),n}function Ap(t){try{return decodeURIComponent(t)}catch{return t.length>3?t.substr(0,3)+Ap(t.substr(3)):t}}var Op=/(%[0-9A-Za-z][0-9A-Za-z])+/g;function ys(t){return t.startsWith("xn--")?(0,Pp.toUnicode)(t):t.match(Op)?t.replace(Op,e=>Ap(e)):t}function Sl(t){return ae.isUri(t)?t:ae.parse(t)}var Ml=Mp(t=>he(t,Aa),{maxSize:128,ttlMs:A});q(()=>{ee(()=>Pl.unset()),Bn.onChange(()=>Pl.unset())});var Pl=u(async()=>T(Bn(),t=>Go(t.map(e=>[Ml(e.uuid),e.mountpoint]))));function Rp(t,e){if(M(t)||e==null||M(e.uuid))return;let r=lt(t),n=lt(e.mountpoint);if(!r.normalize().startsWith(n.normalize()))return;let i=rn(r.slice(n.length),"/");return ae.from({scheme:Kr,authority:Ml(e.uuid),path:i})}function El(t,e){return(0,bs.join)(t,...e.split("/").slice(1))}async function Ip(t,e){if(t.scheme!==Kr)throw new Error("invalid URI: "+t+" (bad scheme)");if(M(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=e!=null&&e.includes(bs.sep);if(r){let i=await hs(e);if(i?.uuid!=null&&Ml(i.uuid)===t.authority)return El(e,t.path)}let n=await T(Pl(),i=>i.get(t.authority));if(x(n))return El(n,t.path);if(r)return El(e,t.path)}var Dp=g(require("path"));var UW=ae.from({scheme:Nn,path:""});function kp(t){let e=y.libraryPath.value;if(M(e)||M(t)||!t.startsWith(e))return;let r="/"+Mo({nativePath:e},{nativePath:t});return ae.from({scheme:Nn,path:r})}function Fp(t){if(t.scheme!==Nn)throw new Error("invalid URI: "+t+" (bad scheme)");let e=y.libraryPath.value;if(M(e))throw new Error("invalid URI: "+t+" (no library set)");return(0,Dp.join)(e,...t.path.split("/"))}var Jr=g(require("path"));function Np(t,e){if(!M(t)){if(e!=null&&e.remote===!0&&x(e.remoteHost)&&x(e.remoteShare))return ae.from({scheme:br,authority:e.remoteHost,path:Jr.posix.join("/"+e.remoteShare,Oe(lt(t),lt(e.mountpoint)))});if(t.startsWith("\\\\"))return ae.file(t).with({scheme:br})}}async function Vp(t,e){if(t.scheme!==br)throw new Error("invalid URI: "+t+" (bad scheme)");if(M(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=t.path.split("/").slice(1),n=r[0];if(M(n))throw new Error("invalid URI: "+t+" (missing share)");if(_)return`\\\\${t.authority}\\${r.join(Jr.sep)}`;let i=r.slice(1),o=await Bn();for(let s of O(o))if(!!s.remote&&se(s.remoteShare,n)&&await Qf(t.authority,s.remoteHost))return(0,Jr.join)(s.mountpoint,...i);if(await Po(e))return(0,Jr.join)(e,...i)}var Mb=["http:","https:","file:",Kr,br].map(t=>t+"//");function Bp(t){let e=f(t).toLowerCase();return Mb.some(r=>e.startsWith(r))}var s3=u(()=>P("UriNormalization"));var Up=u(()=>P("FileURI"));async function zp(t,e){if(t==null||M(t))return Up().throw("empty nativePath passed to nativePath2uri()",{retriable:!1});let r=u(()=>Lt(e,()=>hs(t)));return hr(()=>kp(t),async()=>Rp(t,await r()),async()=>Np(t,await r()),()=>ae.file(t))}function Pb(t){try{return ae.isUri(t)?t:ae.parse(t,!0)}catch(e){Up().warn("bad URI",{uri:t,err:e});return}}async function _l(t,e){if(M(t))return;let r=Pb(t);if(r!=null)switch(r.scheme){case"file":return r.fsPath;case Kr:return Ip(r,e);case br:return Vp(r,e);case Nn:return Fp(r);default:throw new Error("unsupported URI: "+t)}}async function Eb(t){let e=await te.instance().executeJsonToA(["Get-Item -Force -LiteralPath",Ti(t.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return I(e).flatMap(r=>r[0]).flatMap(r=>r.Mode).filter(x).flatMap(r=>r.includes("h")||r.includes("s")).getOrElse(()=>!1)}async function _b(t){try{let e=await W("stat",["-f","%f",t.nativePath],{timeout:10*w}),r=j(e);return r!=null?(r&32768)>0:!1}catch(e){return!1}}function Ts(t){return t.base.startsWith(".")?!0:_?Eb(t):K?_b(t):!1}function jp(t,e,r){let n={};try{for(let i of t)for(let o of nr(i)){let s=i[o]();if(n[o]=v(s,!1),s===!0)return s}return!1}finally{Wp(r,e,n)}}function Wp(t,e,r){let n=r==null?"warn":"debug";t.log(n,e,r)}async function Gp(t,e,r){let n={};try{for(let i of t)for(let o of nr(i)){let s=await i[o]();if(n[o]=s,s)return s}return!1}finally{Wp(r,e,n)}}var Ll=class{constructor(){this.store=new Map}add(e,r){it(this.store,e,()=>new Set).add(r)}delete(e,r){p(this.store.get(e),n=>{n.delete(r),n.size===0&&this.store.delete(e)})}find(e){return cm(e.findIndex((r,n)=>this.store.get(r)?.has(e[n+1])),r=>e.slice(r,r+2))}has(e){return this.find(e)!=null}};var Lb=u(()=>P("NeverIgnoredPaths")),Ab=u(()=>{y.neverIgnored.addListener(()=>{ki.clear(),sr(),Lb().info("Settings.neverIgnored changed",y.neverIgnored.value)}),y.scanPaths.addListener(()=>{ki.clear(),sr()}),ee(()=>ki.clear())}),ki=u(()=>(Ab(),new Set(V([...y.scanPaths.values,...y.neverIgnored.values]))));function zn(t){return ki().has(t)||ki().has(t.toLowerCase())}function qp(t){return zn(t)?{pathIsNeverIgnored:()=>!1}:void 0}var Kp=g(require("path"));var Ob=/^\.?NoMedia$/i,Cp="NoMedia";function Hp(t){return[t,t.toLowerCase(),t.toUpperCase()]}var Rb=Object.freeze([...Hp("."+Cp),...Hp(Cp)]);function Jp(t){return Ob.exec(t)!=null}var vs=new kr({maxSize:1024,timeoutMs:Be,clearEveryMs:A});q(()=>ee(()=>vs.clear()));q(()=>gn(t=>{t==null?vs.clear():vs.deleteIf(e=>e.startsWith(t))}));var xs=u(()=>P("hasNoMedia()"));async function Wn(t){return t==null?!1:zn(t.nativePath)?xs().tap({msg:t+" is never ignored",result:!1}):t instanceof Re?Wn(await t.directoryEntry()):Jp(t.base)?xs().tap({msg:t+" basename is NoMedia",result:!0}):Dr(t.nativePath).some(Jp)?xs().tap({msg:t+" parent path is NoMedia",result:!0}):await t.isDirectory()&&await vs.getOrSetAsync(t.nativePath,async()=>{for(let r of Rb)if(await Um((0,Kp.join)(t.nativePath,r)))return xs().tap({msg:t+" is a directory and has a noMedia child, "+r,result:!0});return!1})===!0?!0:t.isRoot?!1:T(t.parent(),Wn)}function Yp(t){let e=y.maxDuplicatePathElements.valueOrDefault;for(let r of new Set(t))if(wt(t,n=>n===r)>e)return!0;return!1}var Tt=class{constructor(e){this.apply=e}static lift(e){return new Tt(e)}static and(...e){return new Tt(async r=>{for(let n of e)if(!await n.apply(r))return!1;return!0})}static or(...e){return new Tt(async r=>{for(let n of e)if(await n.apply(r))return!0;return!1})}static logged(e,...r){return Hu(r,n=>Ze(n).map(([i,o])=>o.asAsync().logged(e,i)))}static andLogged(e,...r){return this.and(...this.logged(e,...r))}static orLogged(e,...r){return this.or(...this.logged(e,...r))}static async andExplain(e,r){let n=[],i=[];for(let o of r)for(let[s,a]of Ze(o))(await a.apply(e)?n:i).push(s);return{accepted:n,rejected:i}}asAsync(){return this}and(...e){return Tt.and(this,...e)}not(){return new Tt(e=>Ge(this.apply(e)))}or(e){return new Tt(async r=>await this.apply(r)||await e.apply(r))}async filter(e){return tc(e,r=>this.apply(r))}logged(e,r){return new Tt(async i=>{let o=await this.apply(i);return e.log(o?"debug":"info",[sn(r),o?io("ACCEPT"):no("REJECT"),pt(i)].join(" ")),o})}};var Ib=P("Snap"),Zp=Tt.lift(async t=>{if(!await Xp())return!1;let r=Dr(t.nativePath).indexOf("snap");return r<0?!1:O(await Db()).includes(Dr[r+1])}),Xp=u(async()=>{if(!Te||ce())return!1;try{return await W("snap",["--version"],{timeout:10*w,quiet:!0,maxRetries:0}),!0}catch{return!1}}),Db=u(async()=>{if(!await Xp())return[];try{return await Ht(["Name","Version"],await W("snap",["list"],{timeout:10*w})).map(t=>t.Name)}catch(t){return Ib.warn("snap failed",t),[]}},30*w);var Qp=class{constructor(e=pe){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize()));this.ignorableDirectories=new Set(["#snapshot","__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Support","Applications","arangodb","cache","caches","CacheClip","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iMovie Cache","iTunes Cache","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","SteamApps","System Volume Information","System32","temp","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase()));this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/resources\/media\/face/i,/\/facetile[-_]/i,/\/.*?\.photos?library\/(?!(masters?|originals)\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i];this.systemDirs=X(V([En(),ye("APPDATA"),ye("SYSTEMROOT"),ye("ProgramFiles"),ye("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize()));this.ignorableSubdirs=new Ll;Te&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);let r=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",r),this.addIgnorableSubdirs("cygwin",r),this.addIgnorableSubdirs("cygwin64",r),this.addIgnorableSubdirs("local",r),this.addIgnorableSubdirs("Windows",["Boot","Containers","Cursors","Fonts","Help","Installer","Logs","Microsoft.NET","SoftwareDistribution","System","System32","SysWOW64","Temp"]),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...r]),this.addIgnorableSubdirs("lfs",["objects"]),this.addIgnorableSubdirs("var",["cache","crash","games","lib","local","lock","log","mail","run","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);let n=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",n),this.addIgnorableSubdirs("Perl64",n),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(ye("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("temp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),_&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,r){if(M(e))return;let n=e.toLowerCase().normalize();V(r).forEach(i=>this.ignorableSubdirs.add(n,i.toLowerCase().normalize()))}ignorablePathPredicates(e){let r=qp(e);if(r!=null)return r;let n=e.toLowerCase().normalize(),i=V(Dr(n));return{hiddenPosix:()=>i.some(o=>o.startsWith(".")),systemDir:()=>this.systemDirs.some(o=>n.startsWith(o)),ignorableRoot:()=>this.ignorableRootDirectories.has(i[0]),ignorableDirectory:()=>i.some(o=>this.ignorableDirectories.has(o)),ignorablePath:()=>this.ignorableSubdirs.has(i),ignorablePattern:()=>{let o=lt(e);return this.ignorableDirectoryPatterns.some(s=>s.test(o))}}}ignorablePath(e){return jp([this.ignorablePathPredicates(e)],e,P("ignorablePath()"))}},$p=u(()=>new Qp);function kb(t){return d(d({},$p().ignorablePathPredicates(t)),{notExists:()=>Ce.for(t).notExists()})}function Al(t){return $p().ignorablePath(t)}function ed(t){return Al(t.nativePath)}function Fb(t){let e=t.nativePath.toLowerCase().normalize();return zn(t.nativePath)||zn(e)?{pathIsNeverIgnored:()=>!1}:d(d({},kb(t.nativePath)),{snapDirectory:async()=>Te&&await Zp.apply(t),noMedia:async()=>await Wn(t)===!0,hidden:()=>Ts(t),seemsRecursive:()=>Yp(t.pathnames),mountpoint:async()=>Qe(Ie(),r=>r.includes(t.nativePath),()=>!1)})}async function td(t){return Gp([Fb(t)],t.nativePath,P("ignorableDirectory()"))}var nd=new bi;var Ce=class extends Re{constructor(e,r){super(e,r);this.nativePath=e;this.pflog=u(()=>P("PosixFile("+this.nativePath+")"));this.uriObject=u(()=>zp(this.nativePath));this.uri=u(()=>T(this.uriObject(),f));this.fileuri=u(()=>ae.file(this.nativePath).toString());this.mountpoint=u(()=>_&&this.nativePath.startsWith("\\\\")?this.for(this.nativePath.split("\\").slice(0,4).join("\\")):T(Ie(),e=>this.bestMountpoint(e.map(r=>this.for(r)))));this.etag=u(()=>T(this.stat(),e=>[e.size,e.mtime.getTime()].map(r=>Do.encode(r)).join("-")));this.isMountpoint=u(async()=>await this.isDirectory()&&await Qe(Ie(),e=>e.includes(this.nativePath),()=>!1));this.sidecars=u(async()=>{if(this.isSidecar())return[];let e=await this.parent().childDirectoryEntries(n=>n.base!==this.base&&dl(n.ext)&&(n.name===this.name||n.name===this.base||(y.matchSidecarsCaseInsensitively.valueOrDefault?se(n.name,this.name)||se(n.name,this.base):!1)||gt(n.name)===gt(this.name)||(y.matchSidecarsCaseInsensitively.valueOrDefault?se(gt(n.name),gt(this.name)):!1)));if(e==null)return[];let r=e.map(n=>this.parent()._directoryEntryChild(n));return ya(r,n=>n.maxStatMs())});this.shaWithSidecars=u(async()=>{let e=[this,...await this.sidecars()].map(n=>n.nativePath);return(await ko(rr(e))).toString("base64")},Re.attrTTL)}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(M(e))throw new Error("unexpectedly empty path");if(e instanceof Ce)return e;if(e instanceof Re)return this.for(e.nativePath,r);if(Bp(e))throw new Error("use forUri");let n=nd.get(e);if(n!=null)return n;let i=At(e);return nd.getOrSet(i,()=>new Ce(i,r))}static forPosix(e){return this.for(e.replace(/\//g,rd.sep))}static forUri(e,r){return T(_l(e,r),n=>this.for(n))}for(e,r){return Ce.for(e,r)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.sidecars.unset(),this}bestMountpoint(e){return mn(e.filter(r=>So(this.nativePath,r.toString())).map(r=>Ce.for(r)),r=>I(Qn(this.pathnames,r.pathnames)).filter(n=>n>=r.pathnames.length).get())}async isDeleted(e){if(e=await tn(e,()=>this.uri()),this.isUNC)return this.pflog().tap({result:void 0,msg:"isDeleted(): UNC not supported"});if(await this.exists())return this.pflog().tap({result:!1,msg:"isDeleted(): file exists"});if(e==null)return this.pflog().tap({result:void 0,level:"warn",msg:"isDeleted(): missing URI"});if(e=Sl(e),e.isRootPath())return this.pflog().tap({result:void 0,msg:"isDeleted(): uri isRootPath",meta:{uri:e}});if(f(e.pathBase).normalize()!==this.base.normalize())return this.pflog().tap({level:"warn",result:void 0,msg:"isDeleted(): uri isn't correct",meta:{uri:e,expectedBase:this.base,uriBase:e.pathBase}});let r=await this.parent().isDeleted(e.parent());return r==null?this.pflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{uri:e}}):this.pflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted, which means I am deleted.",meta:{parentDeleted:r,uri:e}})}async httpHeaders(){return{ETag:await this.etag(),"Last-Modified":await this.lastModifiedUtc()}}async hide(){let e=await(_?W("attrib",["+h",this.nativePath],{timeout:10*w}).catch(r=>r):K?W("chflags",["hidden",this.nativePath],{timeout:10*w}).catch(r=>r):"");if(x(e)){this.pflog().warn("hide("+this.nativePath+") failed: "+e);return}else return this.clear()}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}async mkNoMedia_(){if(await this.isFile())throw new Error("mkNoMedia(): "+this+" is a file.");await this.mkdirp_();let e=this.join(".NoMedia");await e.isNotDirectory()&&await e.isEmpty()&&(await e.writeTxt_(["This directory's contents are excluded from PhotoStructure libraries.","","See <https://photostructure.com/nomedia/> for details."].join(`
`)),sr(this.nativePath))}async mkNoMedia(){try{return await this.mkNoMedia_(),this}catch(e){this.pflog().warn("Could not add .NoMedia file to "+this,e);return}}hasNoMedia(){return Wn(this)}ignorableCheap(){return Al(this.nativePath)}async ignorable(){return await this.isDirectory()?td(this):ed(this)}hidden(){return Ts(this)}isSidecar(){return dl(this.ext)}async sidecar(){return Jt(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+rn(y.defaultSidecarType.valueOrDefault,".").toLowerCase()))}async jsonSidecars(){let e=await this.siblings(r=>se(r.ext,".json")&&(r.name===this.name||r.name===this.base||gt(r.name)===gt(this.name)));return this.pflog().tap({msg:"jsonSidecars()",result:e==null?void 0:await ya(e,r=>r.maxStatMs())})}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",async()=>{let e=await this.mtimeMs(),r=await this.sidecars(),n=await Promise.all(O(r).map(o=>o.mtimeMs())),i=[e,...n].filter(G);return Pe(i,o=>Math.floor(Math.max(...o)))})}thisOrSidecareMaxMtimeSec(){return T(this.thisOrSidecareMaxMtimeMs(),e=>St(e))}};var kG=`
Hello, and thank you for using PhotoStructure!

The files in this folder support your PhotoStructure Library, including

  * a database with the filepaths to your photos and movies
  * previews and thumbnails of your photos and movies
  * content metadata about these assets, like ratings and sharing information
  * albums that both you and PhotoStructure Curators have assembled

Moving or deleting any files here will cause problems using your library.

If you have any questions, please visit <https://photostructure.com/support/>.

Sincerely,

Your Friendly Neighborhood PhotoStructure, v${Ot}`;function id(t=y.libraryPath.value){return he(t,e=>Ce.for(e).join(".photostructure"))}var sd=P("SettingsIO"),ad="settings.toml";function Nb(){return Ce.for(Co()).join(ad)}function Vb(t){return uo([t,y.libraryPath.value],e=>he(e,r=>p(id(r),n=>n.join(ad))))}async function Bb(){B(y.scanMyPictures.value)&&(y.scanMyPictures.value=!1,y.scanPaths.push(await Sf()))}async function ld(t=Nb()){let e=await Lt(Ub(t),()=>[]);return await Bb(),Ol.unset(),e}var Ol=u(()=>zb(),st);q(()=>{ee(()=>Ol.unset()),y.libraryPath.addListener(()=>Ol.unset())});function zb(t){let e=Vb(t);return sd.tap({msg:"_libraryHasSettings",result:v(e?.clear().existsSync(),!1),level:"info",meta:{libraryPath:t,settings:y.libraryPath.value,librarySettingsFile:e?.nativePath}})}var hq=u(()=>Ot);async function Wb(t){return T(t.readFile(),e=>sd.tap({msg:`read(${t})`,result:od.default.parse(sm(e.toString()))}))}async function Ub(t){let e=P("SettingsIO.importFileSettings("+t.nativePath+")");try{let r=await Wb(t);if(r==null){if(await t.isNonEmpty())throw new Error("Failed to read "+t);return[]}let n=new Map(Ze(y).filter(([,o])=>o instanceof $e&&!o.transient).map(([o,s])=>[o.toLowerCase(),s])),i=D(Ze(r).map(([o,s])=>{let a=n.get(f(o).toLowerCase());return a==null?e.warn("Failed to import (no setting with this name)",{key:o}):a.importFromFile(s),a}));return e.info("loaded",{tomlMap:r,imported:i.map(o=>ei(o,"name","value","persist"))}),i}catch(r){e.error("Cannot read"+Vt(r));return}}var gq=u(()=>new Set([y.logLevel,y.httpPort,y.rpcPort,y.license].map(t=>t.key)));var ws=g(require("process"));function ud(){return ws.stdout==null||ws.stdout.destroyed||ws.stdout.writableEnded}var Il=class extends Kt{constructor(){super("LogTail",()=>this.onEnd(),Ue.logger);this.watchers=new Map;this.file2pos=new Map;this.lastReadFiles=new Si(5*w);this.mutex=new _t;this.setup=u(async()=>{await ld();let e=y.logDir.valueOrDefault;pe&&console.log("tailing "+e+"..."),await(0,Rl.mkdirp)(e),this.root=await bt.for(e),await this.scan(!0)});this.ignorableFilename=Fi.sep+Hs()+"-"+Ni.pid+"-",!Ni.stdout.writableFinished&&(ul(!0),this.flushTimeout=(0,jn.setInterval)(()=>this.flush(),Fn/2),this.scanTimeout=(0,jn.setInterval)(()=>this.scan(),A),Ni.stdout.on("end",()=>this.end()),this.setup())}async flush(){this.write(ml())}readable(e){return e.endsWith(".log")&&!e.includes(this.ignorableFilename)}watchDir(e){me()||this.ended||it(this.watchers,e,()=>{kn(Ke.debug,()=>console.log("LogTail(): watching "+e));try{return(0,md.watch)(e,(r,n)=>this.watchListener(r,(0,Fi.join)(e,n)))}catch(r){kn(Ke.warn,()=>console.error("LogTail(): failed to read "+e,r));return}})}async scan(e=!1){if(!(me()||this.ended)&&(await this.root.visitDescendantFiles(async r=>{!this.readable(r.nativePath)||(e&&await T(r.size(),n=>this.file2pos.set(r.nativePath,n)),Hf(await r.mtimeMs())&&this.watchDir(r.dir))}),!(me()||this.ended))){try{let r=(0,Fi.join)(this.root.nativePath,eo(new Date));await(0,Rl.mkdirp)(r),this.watchDir(r)}catch(r){kn(Ke.warn,()=>console.error("LogTail(): Failed to create the current log dir",r))}me()||this.ended||e&&console.log("LogTail(): Tailing "+this.root+"/**/*.log...")}}async onEnd(){ul(!1),p(this.flushTimeout,jn.clearInterval),this.flushTimeout=void 0,p(this.scanTimeout,jn.clearInterval),this.scanTimeout=void 0;for(let e of this.watchers.values())e.close();this.watchers.clear();for(let e of this.lastReadFiles)await this.watchListener("onEnd",e);try{this.write(ml(-1))}catch{}}write(e){for(let r of e)console.log(Ri().formatLogEntry(r))}async watchListener(e,r){!this.readable(r)||await this.mutex.serialByName(r,async()=>{try{let n=await bt.for(r);if(n==null){kn(Ke.warn,()=>console.error("watchListener: missing file",{event:e,filename:r}));return}let i=await n.size();if(i==null||i<=0)return;let o=v(this.file2pos.get(n.nativePath),()=>0);if(Ki(o,i))return;await T(qf(n,{start:o,end:i}),s=>ss(...s)),this.lastReadFiles.add(n.nativePath),this.file2pos.set(n.nativePath,i)}catch(n){kn(Ke.warn,()=>console.error("Failed to read "+r+": "+Vt(n)))}})}},Ss=Il;Ss.instance=u(()=>ud()?void 0:new Il);var dd=g(require("commander")),hd=g(require("process"));var cd=g(require("process"));var jb=new Date().getFullYear(),Gb=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.

Copyright \xA9 2017-${jb}, PhotoStructure Inc.

Running this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,fd={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",list:"List all paths in a Library.",logcat:"Chronologically sort and pretty-print PhotoStructure logfiles.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."};function pd(t){return t.on("--help",()=>{console.log(`
`+Sr(Gb,{maxLineLen:cd.stdout.columns??78,prefix:""}).join(`
`)+`
`)})}var Dl=class{constructor(e,r,n){this.serviceName=e;this.args=r;this.additionalDescription=n;this.plugins=[];zu(e)}add(...e){return this.plugins.push(...e),this}async parse(){let e=pd(dd.program.description(fd[this.serviceName]+wr(this.additionalDescription,n=>`

`+n,()=>"")));p(this.args,n=>{e=e.arguments(n)});for(let n of this.plugins)e=n.beforeParse(e);e.version(Ot,"--version","Output the version number (spoiler: it's "+Ot+")"),e.parse(hd.default.argv);let r=e.opts();for(let n of this.plugins)await n.afterParse(r);return e}};var gd=g(require("process"));function yd(t){return B(gd.default.env.__is_daemon)||B(t?.daemon)||!M(t?.pidfile)}var bd={beforeParse:(t,e=!1)=>(t.option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.'),e||t.option("--info|--verbose",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.'),t.option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.').option("--color","Enable ASCII terminal colors",!0).option("--no-color","Disable ASCII terminal colors"),t),afterParse:t=>{p(t.color,i=>y.logColor.tmpValue=i);let e=B(t.warn),r=B(t.info)||B(t.verbose),n=B(t.debug);e&&(y.logLevel.tmpValue="warn"),r&&(y.logLevel.tmpValue="info"),n&&(y.logLevel.tmpValue="debug"),!yd(t)&&(e||r||n)&&(y.logStdout.tmpValue=!0)}};try{Qd().install()}catch{}async function PT(){await new Dl("logtail").add(bd).parse(),ji.default.on("SIGINT",()=>ji.default.exit(0)),ji.default.on("SIGTERM",()=>ji.default.exit(0)),Ss.instance()}PT();
//# sourceMappingURL=logtail.js.map
