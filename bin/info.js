#!/usr/bin/env node
/* Copyright Â© 2021, PhotoStructure Inc. */
/* By using this software, you accept the terms in <https://photostructure.com/eula>. */
/* If you don't accept them, do not use this software. */
var gF=Object.create,$f=Object.defineProperty,yF=Object.getPrototypeOf,Sy=Object.prototype.hasOwnProperty,bF=Object.getOwnPropertyNames,xF=Object.getOwnPropertyDescriptor,Py=Object.getOwnPropertySymbols,wF=Object.prototype.propertyIsEnumerable;var w=Object.assign,TF=t=>$f(t,"__esModule",{value:!0});var Cr=(t,e)=>{var r={};for(var i in t)Sy.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(t!=null&&Py)for(var i of Py(t))e.indexOf(i)<0&&wF.call(t,i)&&(r[i]=t[i]);return r},te=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports);var MF=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of bF(e))!Sy.call(t,i)&&i!=="default"&&$f(t,i,{get:()=>e[i],enumerable:!(r=xF(e,i))||r.enumerable});return t},S=t=>MF(TF($f(t!=null?gF(yF(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var xi=te((rue,hn)=>{var Uk={PasetoNotSupported:"ERR_PASETO_NOT_SUPPORTED",PasetoDecryptionFailed:"ERR_PASETO_DECRYPTION_FAILED",PasetoInvalid:"ERR_PASETO_INVALID",PasetoVerificationFailed:"ERR_PASETO_VERIFICATION_FAILED",PasetoClaimInvalid:"ERR_PASETO_CLAIM_INVALID",PasetoWorkerFailure:"ERR_PASETO_WORKER_FAILURE"},gn=class extends Error{constructor(e){super(e);this.name=this.constructor.name,this.code=Uk[this.constructor.name],Error.captureStackTrace(this,this.constructor)}};hn.exports.PasetoError=gn;hn.exports.PasetoNotSupported=class extends gn{};hn.exports.PasetoDecryptionFailed=class extends gn{};hn.exports.PasetoInvalid=class extends gn{};hn.exports.PasetoVerificationFailed=class extends gn{};hn.exports.PasetoClaimInvalid=class extends gn{};hn.exports.PasetoWorkerFailure=class extends gn{}});var Oc=te((iue,iS)=>{iS.exports=t=>!!t&&t.constructor===Object});var kc=te((oue,oS)=>{var qk=Oc();oS.exports=function(e){if(typeof e=="undefined")return Buffer.from("");if(Buffer.isBuffer(e))return e;if(qk(e))return Buffer.from(JSON.stringify(e),"utf8");if(typeof e!="string")throw new TypeError("options.footer must be a string, Buffer, or a plain object");return Buffer.from(e,"utf8")}});var ph=te((nue,nS)=>{var sS=1e3,aS=sS*60,lS=aS*60,fh=lS*24,Wk=fh*7,jk=fh*365.25,Hk=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;nS.exports=t=>{let e=Hk.exec(t);if(!e)throw new TypeError(`invalid time period format ("${t}")`);let r=parseFloat(e[1]);switch(e[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r*sS);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(r*aS);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(r*lS);case"day":case"days":case"d":return Math.round(r*fh);case"week":case"weeks":case"w":return Math.round(r*Wk);case"year":case"years":case"yr":case"yrs":case"y":return Math.round(r*jk)}}});var cS=te((sue,mS)=>{var uS=ph();mS.exports=({audience:t,expiresIn:e,iat:r=!0,issuer:i,jti:o,kid:n,notBefore:s,now:a=new Date,subject:m},c)=>{if(!(a instanceof Date)||!a.getTime())throw new TypeError("options.now must be a valid Date object");let p=a.getTime();if(r!==void 0){if(typeof r!="boolean")throw new TypeError("options.iat must be a boolean");r&&(c.iat=new Date(p))}if(e!==void 0){if(typeof e!="string")throw new TypeError("options.expiresIn must be a string");c.exp=new Date(p+uS(e))}if(s!==void 0){if(typeof s!="string")throw new TypeError("options.notBefore must be a string");c.nbf=new Date(p+uS(s))}if(t!==void 0){if(typeof t!="string")throw new TypeError("options.audience must be a string");c.aud=t}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.issuer must be a string");c.iss=i}if(m!==void 0){if(typeof m!="string")throw new TypeError("options.subject must be a string");c.sub=m}if(n!==void 0){if(typeof n!="string")throw new TypeError("options.kid must be a string");c.kid=n}if(o!==void 0){if(typeof o!="string")throw new TypeError("options.jti must be a string");c.jti=o}return c}});var Rc=te((aue,fS)=>{var Gk=cS(),Kk=Oc(),Jk=t=>JSON.parse(JSON.stringify(t));fS.exports=(t,e)=>{if(Buffer.isBuffer(t)){if(Object.keys(e).length!==0)throw new TypeError("options cannot contain claims when payload is a Buffer");return t}if(!Kk(t))throw new TypeError("payload must be a Buffer or a plain object");return t=Jk(t),t=Gk(e,t),Buffer.from(JSON.stringify(t),"utf-8")}});var dS=te((lue,pS)=>{var{PasetoNotSupported:$k}=xi();pS.exports=t=>{if(!Number.isSafeInteger(t))throw new $k("message is too long for Node.js to safely process");let e=~~(t/4294967295),r=t%4294967295-e,i=Buffer.allocUnsafe(8);return i.writeUInt32LE(e,4),i.writeUInt32LE(r,0),i}});var _c=te((mue,hS)=>{var gS=dS();hS.exports=(...t)=>{let e=gS(t.length);for(let r of t){r=Buffer.from(r,"utf8");let i=gS(Buffer.byteLength(r));e=Buffer.concat([e,i,r])}return e}});var im=te((uue,dh)=>{var Qk=t=>t.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),Yk=t=>t.replace(/-/g,"+").replace(/_/g,"/"),Xk=t=>Qk(t.toString("base64")),Zk=t=>Buffer.from(Yk(t),"base64");dh.exports.decode=Zk;dh.exports.encode=Xk});var gh=te((cue,yS)=>{var{encode:hh}=im();yS.exports=function(e,r,i){return i.length!==0?`${e}${hh(Buffer.concat(r))}.${hh(i)}`:`${e}${hh(Buffer.concat(r))}`}});var wS=te((fue,bS)=>{var{timingSafeEqual:eR}=require("crypto"),xS=(t,e)=>{if(t.length===e)return t;let r=Buffer.alloc(e);return t.copy(r),r},tR=(t,e)=>{let r=Math.max(t.length,e.length);return eR(xS(t,r),xS(e,r))};bS.exports=tR});var om=te((due,TS)=>{var ds=require("crypto"),rR=require("util"),{PasetoWorkerFailure:pue}=xi(),MS=_c(),Ea;if(ds.hkdf){let t=rR.promisify(ds.hkdf);Ea=(e,r,i,o)=>t("sha384",e,i,o,r)}else Ea=(t,e,r,i)=>{let o=yn.hmac("sha384",t,r),n=Buffer.from(i),s=Buffer.from(""),a=Buffer.from(""),m;for(let p=1;Buffer.byteLength(s)<e;++m){m=Buffer.from(String.fromCharCode(p));let d=Buffer.concat([a,n,m]);a=yn.hmac("sha384",d,o),s=Buffer.concat([s,a])}return Buffer.from(s).slice(0,e)};var iR=gh(),oR=wS(),yn={async"aes-256-ctr-hmac-sha-384-encrypt"(t,e,r,i){let o=yn.hmac("sha384",t,i);o=o.slice(0,32),e=Buffer.from(e);let n=o.slice(0,16),[s,a]=await Promise.all([Ea(r,32,n,"paseto-encryption-key"),Ea(r,32,n,"paseto-auth-key-for-aead")]),m=yn.encrypt("aes-256-ctr",t,s,o.slice(16)),c=MS("v1.local.",o,m,e),p=yn.hmac("sha384",c,a);return iR("v1.local.",[o,m,p],e)},async"aes-256-ctr-hmac-sha-384-decrypt"(t,e,r){let i=t.slice(0,32),o=t.slice(-48),n=t.slice(32,-48),s=i.slice(0,16),[a,m]=await Promise.all([Ea(r,32,s,"paseto-encryption-key"),Ea(r,32,s,"paseto-auth-key-for-aead")]),c=MS("v1.local.",i,n,e),p=yn.hmac("sha384",c,m),d=yn.decrypt("aes-256-ctr",n,a,i.slice(16));return!oR(o,p)||!d?!1:d},hmac(t,e,r){let i=ds.createHmac(t,r);return i.update(e),i.digest()},verify(t,e,r,i){return ds.verify(t,e,r,i)},sign(t,e,r){return ds.sign(t,e,r)},encrypt(t,e,r,i){let o=ds.createCipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])},decrypt(t,e,r,i){let o=ds.createDecipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])}};TS.exports=yn});var yh=te((hue,vS)=>{var{sign:nR}=om(),sR=_c(),aR=gh();vS.exports=async function(e,r,i,o,n,s){let a=sR(e,r,i),m=await nR(o,a,n);if(m.length!==s)throw new TypeError(`invalid ${e.slice(0,-1)} signing key bit length`);return aR(e,[r,m],i)}});var PS=te((gue,SS)=>{var{constants:{RSA_PKCS1_PSS_PADDING:lR,RSA_PSS_SALTLEN_DIGEST:mR},createPrivateKey:uR,KeyObject:cR}=require("crypto"),fR=kc(),pR=Rc(),dR=yh();function hR(t){if(t instanceof cR||(t=uR(t)),t.type!=="private"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public signing key must be a private RSA key");return t}SS.exports=async function(e,r,n={}){var{footer:i}=n,o=Cr(n,["footer"]);let s=pR(e,o),a=fR(i);return r=hR(r),dR("v1.public.",s,a,"sha384",{key:r,padding:lR,saltLength:mR},256)}});var Nc=te((yue,ES)=>{var{PasetoClaimInvalid:Ut}=xi(),DS=ph();ES.exports=({ignoreExp:t,ignoreNbf:e,ignoreIat:r,maxTokenAge:i,subject:o,issuer:n,clockTolerance:s,audience:a,now:m=new Date},c)=>{if(!(m instanceof Date)||!m.getTime())throw new TypeError("options.now must be a valid Date object");let p=m.getTime();if("iss"in c&&typeof c.iss!="string")throw new Ut("payload.iss must be a string");if(n!==void 0){if(typeof n!="string")throw new TypeError("options.issuer must be a string");if(c.iss!==n)throw new Ut("issuer mismatch")}if("sub"in c&&typeof c.sub!="string")throw new Ut("payload.sub must be a string");if(o!==void 0){if(typeof o!="string")throw new TypeError("options.subject must be a string");if(c.sub!==o)throw new Ut("subject mismatch")}if("aud"in c&&typeof c.aud!="string")throw new Ut("payload.aud must be a string");if(a!==void 0){if(typeof a!="string")throw new TypeError("options.audience must be a string");if(c.aud!==a)throw new Ut("audience mismatch")}if(s!==void 0&&typeof s!="string")throw new TypeError("options.clockTolerance must be a string");let d=s?DS(s):0,y;if("iat"in c){if(typeof c.iat!="string")throw new Ut("payload.iat must be a string");if(y=new Date(c.iat).getTime(),!y)throw new Ut("payload.iat must be a valid ISO8601 string");if(!r&&y>p+d)throw new Ut("token issued in the future")}if("nbf"in c){if(typeof c.nbf!="string")throw new Ut("payload.nbf must be a string");let P=new Date(c.nbf).getTime();if(!P)throw new Ut("payload.nbf must be a valid ISO8601 string");if(!e&&P>p+d)throw new Ut("token is not active yet")}if("exp"in c){if(typeof c.exp!="string")throw new Ut("payload.exp must be a string");let P=new Date(c.exp).getTime();if(!P)throw new Ut("payload.exp must be a valid ISO8601 string");if(!t&&P<=p-d)throw new Ut("token is expired")}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.maxTokenAge must be a string");if(!("iat"in c))throw new Ut("missing iat claim");if(y+DS(i)<p+d)throw new Ut("maxTokenAge exceeded")}}});var nm=te((bue,AS)=>{var{PasetoInvalid:gR}=xi(),{strict:yR}=require("assert"),bR=Oc();AS.exports=t=>{try{let e=JSON.parse(t);return yR(bR(e)),e}catch(e){throw new gR("All PASETO payloads MUST be a JSON object")}}});var xh=te((xue,FS)=>{var{PasetoInvalid:bh,PasetoVerificationFailed:xR}=xi(),{decode:LS}=im(),{verify:wR}=om(),TR=_c();FS.exports=async function(e,r,i,o,n){if(typeof r!="string")throw new TypeError("token must be a string");if(r.substr(0,e.length)!==e)throw new bh(`token is not a ${e.slice(0,-1)} token`);let{0:s,1:a,length:m}=r.substr(e.length).split(".");if(m!==1&&m!==2)throw new bh("token value is not a PASETO formatted value");let c,p;try{p=LS(s),c=LS(a||"")}catch(ie){throw new bh("token value is not a PASETO formatted value")}let d=p.slice(0,-o),y=p.slice(-o),P=TR(e,d,c);if(!await wR(i,P,n,y))throw new xR("invalid signature");return{m:d,footer:c.length?c:void 0}}});var OS=te((wue,IS)=>{var{constants:{RSA_PKCS1_PSS_PADDING:MR,RSA_PSS_SALTLEN_DIGEST:vR},createPublicKey:SR,KeyObject:PR}=require("crypto"),ER=Nc(),DR=nm(),AR=xh();function FR(t){if((!(t instanceof PR)||t.type==="private")&&(t=SR(t)),t.type!=="public"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public verify key must be a public RSA key");return t}IS.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=Cr(s,["complete","buffer"]);r=FR(r);let{m:a,footer:m}=await AR("v1.public.",e,"sha384",256,{key:r,padding:MR,saltLength:vR});if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let c=DR(a);return ER(n,c),i?{payload:c,footer:m,version:"v1",purpose:"public"}:c}});var wh=te((Tue,kS)=>{var{createSecretKey:LR,KeyObject:IR}=require("crypto");kS.exports=function(e,r){if(r instanceof IR||(r=LR(r)),r.type!=="secret"||r.symmetricKeySize!==32)throw new TypeError(`${e} secret key must be 32 bytes long symmetric key`);return r}});var Th=te((Mue,RS)=>{var OR=require("crypto"),{promisify:kR}=require("util"),RR=kR(OR.randomFill);RS.exports=async function(e){let r=Buffer.allocUnsafe(e);return RR(r)}});var NS=te((vue,_S)=>{var _R=kc(),NR=wh().bind(void 0,"v1.local"),BR=Rc(),CR=Th(),{"aes-256-ctr-hmac-sha-384-encrypt":VR}=om();_S.exports=async function(e,r,s={}){var{footer:i,nonce:o}=s,n=Cr(s,["footer","nonce"]);let a=BR(e,n);r=NR(r);let m=_R(i),c=r.export();return(o&&process.env.NODE_ENV!=="test"||!o)&&(o=await CR(32)),VR(a,m,c,o)}});var zS=te((Sue,BS)=>{var{decode:CS}=im(),{"aes-256-ctr-hmac-sha-384-decrypt":zR}=om(),{PasetoDecryptionFailed:UR,PasetoInvalid:VS}=xi(),qR=Nc(),WR=wh().bind(void 0,"v1.local"),jR=nm(),Mh="v1.local.";BS.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=Cr(s,["complete","buffer"]);if(typeof e!="string")throw new TypeError(`token must be a string, got: ${typeof e}`);if(r=WR(r),e.substr(0,Mh.length)!==Mh)throw new VS("token is not a v1.local PASETO");let{0:a,1:m="",length:c}=e.substr(Mh.length).split(".");if(c>2)throw new VS("token value is not a PASETO formatted value");let p=CS(m),d=CS(a),y=r.export(),P=await zR(d,p,y);if(!P)throw new UR("decryption failed");if(o){if(Object.keys(n).length!==0)throw new TypeError("options cannot contain claims when options.buffer is true");return i?{payload:P,footer:p.length?p:void 0,version:"v2",purpose:"local"}:P}let _=jR(P);return qR(n,_),i?{payload:_,footer:p.length?p:void 0,version:"v1",purpose:"local"}:_}});var WS=te((Pue,US)=>{var qS=require("crypto"),{promisify:HR}=require("util"),{PasetoNotSupported:GR}=xi(),KR=Th(),JR=HR(qS.generateKeyPair),$R=32,QR=["rsa",{modulusLength:2048}];async function YR(t){switch(t){case"local":return qS.createSecretKey(await KR($R));case"public":{let{privateKey:e}=await JR(...QR);return e}default:throw new GR("unsupported v1 purpose")}}US.exports=YR});var HS=te((Eue,jS)=>{var XR=PS(),ZR=OS(),e_=NS(),t_=zS(),r_=WS();jS.exports={sign:XR,verify:ZR,encrypt:e_,decrypt:t_,generateKey:r_}});var KS=te((Due,GS)=>{var{createPrivateKey:i_,KeyObject:o_}=require("crypto"),n_=kc(),s_=Rc(),a_=yh();function l_(t){if(t instanceof o_||(t=i_(t)),t.type!=="private"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public signing key must be a private ed25519 key");return t}GS.exports=async function(e,r,n={}){var{footer:i}=n,o=Cr(n,["footer"]);let s=s_(e,o);r=l_(r);let a=n_(i);return a_("v2.public.",s,a,void 0,r,64)}});var $S=te((Aue,JS)=>{var{createPublicKey:m_,KeyObject:u_}=require("crypto"),c_=Nc(),f_=nm(),p_=xh();function d_(t){if((!(t instanceof u_)||t.type==="private")&&(t=m_(t)),t.type!=="public"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public verify key must be a public ed25519 key");return t}JS.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=Cr(s,["complete","buffer"]);r=d_(r);let{m:a,footer:m}=await p_("v2.public.",e,void 0,64,r);if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let c=f_(a);return c_(n,c),i?{payload:c,footer:m,version:"v2",purpose:"public"}:c}});var YS=te((Fue,QS)=>{var h_=require("crypto"),{promisify:g_}=require("util"),{PasetoNotSupported:y_}=xi(),b_=g_(h_.generateKeyPair);async function x_(t){switch(t){case"public":{let{privateKey:e}=await b_("ed25519");return e}default:throw new y_("unsupported v2 purpose")}}QS.exports=x_});var ZS=te((Lue,XS)=>{var w_=KS(),T_=$S(),M_=YS();XS.exports={sign:w_,verify:T_,generateKey:M_}});var oP=te((Iue,eP)=>{var{PasetoInvalid:tP,PasetoNotSupported:rP}=xi(),{decode:iP}=im(),v_=nm();eP.exports=(t,{parse:e=!0}={})=>{if(typeof t!="string")throw new TypeError("token must be a string");let{0:r,1:i,2:o,3:n,length:s}=t.split(".");if(s!==3&&s!==4)throw new tP("token value is not a PASETO formatted value");if(r!=="v1"&&r!=="v2")throw new rP("unsupported PASETO version");if(i!=="local"&&i!=="public")throw new rP("unsupported PASETO purpose");let a={footer:n?iP(n):void 0,payload:void 0,version:r,purpose:i};if(i==="local")return a;let m=r==="v1"?256:64,c;try{c=iP(o).slice(0,-m)}catch(p){throw new tP("token value is not a PASETO formatted value")}return e?a.payload=v_(c):a.payload=c,a}});var sP=te((Oue,nP)=>{var S_=oP();nP.exports={decode:S_}});var lP=te((kue,aP)=>{var P_=xi(),E_=HS(),D_=ZS(),{decode:A_}=sP();aP.exports={decode:A_,V1:E_,V2:D_,errors:P_}});var N0=te(ry=>{var _0="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");ry.encode=function(t){if(0<=t&&t<_0.length)return _0[t];throw new TypeError("Must be between 0 and 63: "+t)};ry.decode=function(t){var e=65,r=90,i=97,o=122,n=48,s=57,a=43,m=47,c=26,p=52;return e<=t&&t<=r?t-e:i<=t&&t<=o?t-i+c:n<=t&&t<=s?t-n+p:t==a?62:t==m?63:-1}});var ny=te(iy=>{var B0=N0(),oy=5,C0=1<<oy,V0=C0-1,z0=C0;function jC(t){return t<0?(-t<<1)+1:(t<<1)+0}function HC(t){var e=(t&1)==1,r=t>>1;return e?-r:r}iy.encode=function(e){var r="",i,o=jC(e);do i=o&V0,o>>>=oy,o>0&&(i|=z0),r+=B0.encode(i);while(o>0);return r};iy.decode=function(e,r,i){var o=e.length,n=0,s=0,a,m;do{if(r>=o)throw new Error("Expected more digits in base 64 VLQ value.");if(m=B0.decode(e.charCodeAt(r++)),m===-1)throw new Error("Invalid base64 digit: "+e.charAt(r-1));a=!!(m&z0),m&=V0,n=n+(m<<s),s+=oy}while(a);i.value=HC(n),i.rest=r}});var $a=te(Yt=>{function GC(t,e,r){if(e in t)return t[e];if(arguments.length===3)return r;throw new Error('"'+e+'" is a required argument.')}Yt.getArg=GC;var U0=/^(?:([\w+\-.]+):)?\/\/(?:(\w+:\w+)@)?([\w.-]*)(?::(\d+))?(.*)$/,KC=/^data:.+\,.+$/;function km(t){var e=t.match(U0);return e?{scheme:e[1],auth:e[2],host:e[3],port:e[4],path:e[5]}:null}Yt.urlParse=km;function Ka(t){var e="";return t.scheme&&(e+=t.scheme+":"),e+="//",t.auth&&(e+=t.auth+"@"),t.host&&(e+=t.host),t.port&&(e+=":"+t.port),t.path&&(e+=t.path),e}Yt.urlGenerate=Ka;function sy(t){var e=t,r=km(t);if(r){if(!r.path)return t;e=r.path}for(var i=Yt.isAbsolute(e),o=e.split(/\/+/),n,s=0,a=o.length-1;a>=0;a--)n=o[a],n==="."?o.splice(a,1):n===".."?s++:s>0&&(n===""?(o.splice(a+1,s),s=0):(o.splice(a,2),s--));return e=o.join("/"),e===""&&(e=i?"/":"."),r?(r.path=e,Ka(r)):e}Yt.normalize=sy;function q0(t,e){t===""&&(t="."),e===""&&(e=".");var r=km(e),i=km(t);if(i&&(t=i.path||"/"),r&&!r.scheme)return i&&(r.scheme=i.scheme),Ka(r);if(r||e.match(KC))return e;if(i&&!i.host&&!i.path)return i.host=e,Ka(i);var o=e.charAt(0)==="/"?e:sy(t.replace(/\/+$/,"")+"/"+e);return i?(i.path=o,Ka(i)):o}Yt.join=q0;Yt.isAbsolute=function(t){return t.charAt(0)==="/"||U0.test(t)};function JC(t,e){t===""&&(t="."),t=t.replace(/\/$/,"");for(var r=0;e.indexOf(t+"/")!==0;){var i=t.lastIndexOf("/");if(i<0||(t=t.slice(0,i),t.match(/^([^\/]+:\/)?\/*$/)))return e;++r}return Array(r+1).join("../")+e.substr(t.length+1)}Yt.relative=JC;var W0=function(){var t=Object.create(null);return!("__proto__"in t)}();function j0(t){return t}function $C(t){return H0(t)?"$"+t:t}Yt.toSetString=W0?j0:$C;function QC(t){return H0(t)?t.slice(1):t}Yt.fromSetString=W0?j0:QC;function H0(t){if(!t)return!1;var e=t.length;if(e<9||t.charCodeAt(e-1)!==95||t.charCodeAt(e-2)!==95||t.charCodeAt(e-3)!==111||t.charCodeAt(e-4)!==116||t.charCodeAt(e-5)!==111||t.charCodeAt(e-6)!==114||t.charCodeAt(e-7)!==112||t.charCodeAt(e-8)!==95||t.charCodeAt(e-9)!==95)return!1;for(var r=e-10;r>=0;r--)if(t.charCodeAt(r)!==36)return!1;return!0}function YC(t,e,r){var i=Ja(t.source,e.source);return i!==0||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0||r)||(i=t.generatedColumn-e.generatedColumn,i!==0)||(i=t.generatedLine-e.generatedLine,i!==0)?i:Ja(t.name,e.name)}Yt.compareByOriginalPositions=YC;function XC(t,e,r){var i=t.generatedLine-e.generatedLine;return i!==0||(i=t.generatedColumn-e.generatedColumn,i!==0||r)||(i=Ja(t.source,e.source),i!==0)||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0)?i:Ja(t.name,e.name)}Yt.compareByGeneratedPositionsDeflated=XC;function Ja(t,e){return t===e?0:t===null?1:e===null?-1:t>e?1:-1}function ZC(t,e){var r=t.generatedLine-e.generatedLine;return r!==0||(r=t.generatedColumn-e.generatedColumn,r!==0)||(r=Ja(t.source,e.source),r!==0)||(r=t.originalLine-e.originalLine,r!==0)||(r=t.originalColumn-e.originalColumn,r!==0)?r:Ja(t.name,e.name)}Yt.compareByGeneratedPositionsInflated=ZC;function e2(t){return JSON.parse(t.replace(/^\)]}'[^\n]*\n/,""))}Yt.parseSourceMapInput=e2;function t2(t,e,r){if(e=e||"",t&&(t[t.length-1]!=="/"&&e[0]!=="/"&&(t+="/"),e=t+e),r){var i=km(r);if(!i)throw new Error("sourceMapURL could not be parsed");if(i.path){var o=i.path.lastIndexOf("/");o>=0&&(i.path=i.path.substring(0,o+1))}e=q0(Ka(i),e)}return sy(e)}Yt.computeSourceURL=t2});var my=te(G0=>{var ay=$a(),ly=Object.prototype.hasOwnProperty,Ss=typeof Map!="undefined";function Vo(){this._array=[],this._set=Ss?new Map:Object.create(null)}Vo.fromArray=function(e,r){for(var i=new Vo,o=0,n=e.length;o<n;o++)i.add(e[o],r);return i};Vo.prototype.size=function(){return Ss?this._set.size:Object.getOwnPropertyNames(this._set).length};Vo.prototype.add=function(e,r){var i=Ss?e:ay.toSetString(e),o=Ss?this.has(e):ly.call(this._set,i),n=this._array.length;(!o||r)&&this._array.push(e),o||(Ss?this._set.set(e,n):this._set[i]=n)};Vo.prototype.has=function(e){if(Ss)return this._set.has(e);var r=ay.toSetString(e);return ly.call(this._set,r)};Vo.prototype.indexOf=function(e){if(Ss){var r=this._set.get(e);if(r>=0)return r}else{var i=ay.toSetString(e);if(ly.call(this._set,i))return this._set[i]}throw new Error('"'+e+'" is not in the set.')};Vo.prototype.at=function(e){if(e>=0&&e<this._array.length)return this._array[e];throw new Error("No element indexed by "+e)};Vo.prototype.toArray=function(){return this._array.slice()};G0.ArraySet=Vo});var $0=te(K0=>{var J0=$a();function r2(t,e){var r=t.generatedLine,i=e.generatedLine,o=t.generatedColumn,n=e.generatedColumn;return i>r||i==r&&n>=o||J0.compareByGeneratedPositionsInflated(t,e)<=0}function Wf(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}Wf.prototype.unsortedForEach=function(e,r){this._array.forEach(e,r)};Wf.prototype.add=function(e){r2(this._last,e)?(this._last=e,this._array.push(e)):(this._sorted=!1,this._array.push(e))};Wf.prototype.toArray=function(){return this._sorted||(this._array.sort(J0.compareByGeneratedPositionsInflated),this._sorted=!0),this._array};K0.MappingList=Wf});var uy=te(Q0=>{var Rm=ny(),Mt=$a(),jf=my().ArraySet,i2=$0().MappingList;function ri(t){t||(t={}),this._file=Mt.getArg(t,"file",null),this._sourceRoot=Mt.getArg(t,"sourceRoot",null),this._skipValidation=Mt.getArg(t,"skipValidation",!1),this._sources=new jf,this._names=new jf,this._mappings=new i2,this._sourcesContents=null}ri.prototype._version=3;ri.fromSourceMap=function(e){var r=e.sourceRoot,i=new ri({file:e.file,sourceRoot:r});return e.eachMapping(function(o){var n={generated:{line:o.generatedLine,column:o.generatedColumn}};o.source!=null&&(n.source=o.source,r!=null&&(n.source=Mt.relative(r,n.source)),n.original={line:o.originalLine,column:o.originalColumn},o.name!=null&&(n.name=o.name)),i.addMapping(n)}),e.sources.forEach(function(o){var n=o;r!==null&&(n=Mt.relative(r,o)),i._sources.has(n)||i._sources.add(n);var s=e.sourceContentFor(o);s!=null&&i.setSourceContent(o,s)}),i};ri.prototype.addMapping=function(e){var r=Mt.getArg(e,"generated"),i=Mt.getArg(e,"original",null),o=Mt.getArg(e,"source",null),n=Mt.getArg(e,"name",null);this._skipValidation||this._validateMapping(r,i,o,n),o!=null&&(o=String(o),this._sources.has(o)||this._sources.add(o)),n!=null&&(n=String(n),this._names.has(n)||this._names.add(n)),this._mappings.add({generatedLine:r.line,generatedColumn:r.column,originalLine:i!=null&&i.line,originalColumn:i!=null&&i.column,source:o,name:n})};ri.prototype.setSourceContent=function(e,r){var i=e;this._sourceRoot!=null&&(i=Mt.relative(this._sourceRoot,i)),r!=null?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[Mt.toSetString(i)]=r):this._sourcesContents&&(delete this._sourcesContents[Mt.toSetString(i)],Object.keys(this._sourcesContents).length===0&&(this._sourcesContents=null))};ri.prototype.applySourceMap=function(e,r,i){var o=r;if(r==null){if(e.file==null)throw new Error(`SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map's "file" property. Both were omitted.`);o=e.file}var n=this._sourceRoot;n!=null&&(o=Mt.relative(n,o));var s=new jf,a=new jf;this._mappings.unsortedForEach(function(m){if(m.source===o&&m.originalLine!=null){var c=e.originalPositionFor({line:m.originalLine,column:m.originalColumn});c.source!=null&&(m.source=c.source,i!=null&&(m.source=Mt.join(i,m.source)),n!=null&&(m.source=Mt.relative(n,m.source)),m.originalLine=c.line,m.originalColumn=c.column,c.name!=null&&(m.name=c.name))}var p=m.source;p!=null&&!s.has(p)&&s.add(p);var d=m.name;d!=null&&!a.has(d)&&a.add(d)},this),this._sources=s,this._names=a,e.sources.forEach(function(m){var c=e.sourceContentFor(m);c!=null&&(i!=null&&(m=Mt.join(i,m)),n!=null&&(m=Mt.relative(n,m)),this.setSourceContent(m,c))},this)};ri.prototype._validateMapping=function(e,r,i,o){if(r&&typeof r.line!="number"&&typeof r.column!="number")throw new Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.");if(!(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0&&!r&&!i&&!o)){if(e&&"line"in e&&"column"in e&&r&&"line"in r&&"column"in r&&e.line>0&&e.column>=0&&r.line>0&&r.column>=0&&i)return;throw new Error("Invalid mapping: "+JSON.stringify({generated:e,source:i,original:r,name:o}))}};ri.prototype._serializeMappings=function(){for(var e=0,r=1,i=0,o=0,n=0,s=0,a="",m,c,p,d,y=this._mappings.toArray(),P=0,_=y.length;P<_;P++){if(c=y[P],m="",c.generatedLine!==r)for(e=0;c.generatedLine!==r;)m+=";",r++;else if(P>0){if(!Mt.compareByGeneratedPositionsInflated(c,y[P-1]))continue;m+=","}m+=Rm.encode(c.generatedColumn-e),e=c.generatedColumn,c.source!=null&&(d=this._sources.indexOf(c.source),m+=Rm.encode(d-s),s=d,m+=Rm.encode(c.originalLine-1-o),o=c.originalLine-1,m+=Rm.encode(c.originalColumn-i),i=c.originalColumn,c.name!=null&&(p=this._names.indexOf(c.name),m+=Rm.encode(p-n),n=p)),a+=m}return a};ri.prototype._generateSourcesContent=function(e,r){return e.map(function(i){if(!this._sourcesContents)return null;r!=null&&(i=Mt.relative(r,i));var o=Mt.toSetString(i);return Object.prototype.hasOwnProperty.call(this._sourcesContents,o)?this._sourcesContents[o]:null},this)};ri.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return this._file!=null&&(e.file=this._file),this._sourceRoot!=null&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e};ri.prototype.toString=function(){return JSON.stringify(this.toJSON())};Q0.SourceMapGenerator=ri});var Y0=te(Ps=>{Ps.GREATEST_LOWER_BOUND=1;Ps.LEAST_UPPER_BOUND=2;function cy(t,e,r,i,o,n){var s=Math.floor((e-t)/2)+t,a=o(r,i[s],!0);return a===0?s:a>0?e-s>1?cy(s,e,r,i,o,n):n==Ps.LEAST_UPPER_BOUND?e<i.length?e:-1:s:s-t>1?cy(t,s,r,i,o,n):n==Ps.LEAST_UPPER_BOUND?s:t<0?-1:t}Ps.search=function(e,r,i,o){if(r.length===0)return-1;var n=cy(-1,r.length,e,r,i,o||Ps.GREATEST_LOWER_BOUND);if(n<0)return-1;for(;n-1>=0&&i(r[n],r[n-1],!0)===0;)--n;return n}});var Z0=te(X0=>{function fy(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}function o2(t,e){return Math.round(t+Math.random()*(e-t))}function py(t,e,r,i){if(r<i){var o=o2(r,i),n=r-1;fy(t,o,i);for(var s=t[i],a=r;a<i;a++)e(t[a],s)<=0&&(n+=1,fy(t,n,a));fy(t,n+1,a);var m=n+1;py(t,e,r,m-1),py(t,e,m+1,i)}}X0.quickSort=function(t,e){py(t,e,0,t.length-1)}});var tF=te(Hf=>{var q=$a(),dy=Y0(),Qa=my().ArraySet,n2=ny(),_m=Z0().quickSort;function je(t,e){var r=t;return typeof t=="string"&&(r=q.parseSourceMapInput(t)),r.sections!=null?new wi(r,e):new Wt(r,e)}je.fromSourceMap=function(t,e){return Wt.fromSourceMap(t,e)};je.prototype._version=3;je.prototype.__generatedMappings=null;Object.defineProperty(je.prototype,"_generatedMappings",{configurable:!0,enumerable:!0,get:function(){return this.__generatedMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__generatedMappings}});je.prototype.__originalMappings=null;Object.defineProperty(je.prototype,"_originalMappings",{configurable:!0,enumerable:!0,get:function(){return this.__originalMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__originalMappings}});je.prototype._charIsMappingSeparator=function(e,r){var i=e.charAt(r);return i===";"||i===","};je.prototype._parseMappings=function(e,r){throw new Error("Subclasses must implement _parseMappings")};je.GENERATED_ORDER=1;je.ORIGINAL_ORDER=2;je.GREATEST_LOWER_BOUND=1;je.LEAST_UPPER_BOUND=2;je.prototype.eachMapping=function(e,r,i){var o=r||null,n=i||je.GENERATED_ORDER,s;switch(n){case je.GENERATED_ORDER:s=this._generatedMappings;break;case je.ORIGINAL_ORDER:s=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var a=this.sourceRoot;s.map(function(m){var c=m.source===null?null:this._sources.at(m.source);return c=q.computeSourceURL(a,c,this._sourceMapURL),{source:c,generatedLine:m.generatedLine,generatedColumn:m.generatedColumn,originalLine:m.originalLine,originalColumn:m.originalColumn,name:m.name===null?null:this._names.at(m.name)}},this).forEach(e,o)};je.prototype.allGeneratedPositionsFor=function(e){var r=q.getArg(e,"line"),i={source:q.getArg(e,"source"),originalLine:r,originalColumn:q.getArg(e,"column",0)};if(i.source=this._findSourceIndex(i.source),i.source<0)return[];var o=[],n=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",q.compareByOriginalPositions,dy.LEAST_UPPER_BOUND);if(n>=0){var s=this._originalMappings[n];if(e.column===void 0)for(var a=s.originalLine;s&&s.originalLine===a;)o.push({line:q.getArg(s,"generatedLine",null),column:q.getArg(s,"generatedColumn",null),lastColumn:q.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n];else for(var m=s.originalColumn;s&&s.originalLine===r&&s.originalColumn==m;)o.push({line:q.getArg(s,"generatedLine",null),column:q.getArg(s,"generatedColumn",null),lastColumn:q.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n]}return o};Hf.SourceMapConsumer=je;function Wt(t,e){var r=t;typeof t=="string"&&(r=q.parseSourceMapInput(t));var i=q.getArg(r,"version"),o=q.getArg(r,"sources"),n=q.getArg(r,"names",[]),s=q.getArg(r,"sourceRoot",null),a=q.getArg(r,"sourcesContent",null),m=q.getArg(r,"mappings"),c=q.getArg(r,"file",null);if(i!=this._version)throw new Error("Unsupported version: "+i);s&&(s=q.normalize(s)),o=o.map(String).map(q.normalize).map(function(p){return s&&q.isAbsolute(s)&&q.isAbsolute(p)?q.relative(s,p):p}),this._names=Qa.fromArray(n.map(String),!0),this._sources=Qa.fromArray(o,!0),this._absoluteSources=this._sources.toArray().map(function(p){return q.computeSourceURL(s,p,e)}),this.sourceRoot=s,this.sourcesContent=a,this._mappings=m,this._sourceMapURL=e,this.file=c}Wt.prototype=Object.create(je.prototype);Wt.prototype.consumer=je;Wt.prototype._findSourceIndex=function(t){var e=t;if(this.sourceRoot!=null&&(e=q.relative(this.sourceRoot,e)),this._sources.has(e))return this._sources.indexOf(e);var r;for(r=0;r<this._absoluteSources.length;++r)if(this._absoluteSources[r]==t)return r;return-1};Wt.fromSourceMap=function(e,r){var i=Object.create(Wt.prototype),o=i._names=Qa.fromArray(e._names.toArray(),!0),n=i._sources=Qa.fromArray(e._sources.toArray(),!0);i.sourceRoot=e._sourceRoot,i.sourcesContent=e._generateSourcesContent(i._sources.toArray(),i.sourceRoot),i.file=e._file,i._sourceMapURL=r,i._absoluteSources=i._sources.toArray().map(function(P){return q.computeSourceURL(i.sourceRoot,P,r)});for(var s=e._mappings.toArray().slice(),a=i.__generatedMappings=[],m=i.__originalMappings=[],c=0,p=s.length;c<p;c++){var d=s[c],y=new eF;y.generatedLine=d.generatedLine,y.generatedColumn=d.generatedColumn,d.source&&(y.source=n.indexOf(d.source),y.originalLine=d.originalLine,y.originalColumn=d.originalColumn,d.name&&(y.name=o.indexOf(d.name)),m.push(y)),a.push(y)}return _m(i.__originalMappings,q.compareByOriginalPositions),i};Wt.prototype._version=3;Object.defineProperty(Wt.prototype,"sources",{get:function(){return this._absoluteSources.slice()}});function eF(){this.generatedLine=0,this.generatedColumn=0,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}Wt.prototype._parseMappings=function(e,r){for(var i=1,o=0,n=0,s=0,a=0,m=0,c=e.length,p=0,d={},y={},P=[],_=[],ie,Xe,Ee,K,Q;p<c;)if(e.charAt(p)===";")i++,p++,o=0;else if(e.charAt(p)===",")p++;else{for(ie=new eF,ie.generatedLine=i,K=p;K<c&&!this._charIsMappingSeparator(e,K);K++);if(Xe=e.slice(p,K),Ee=d[Xe],Ee)p+=Xe.length;else{for(Ee=[];p<K;)n2.decode(e,p,y),Q=y.value,p=y.rest,Ee.push(Q);if(Ee.length===2)throw new Error("Found a source, but no line and column");if(Ee.length===3)throw new Error("Found a source and line, but no column");d[Xe]=Ee}ie.generatedColumn=o+Ee[0],o=ie.generatedColumn,Ee.length>1&&(ie.source=a+Ee[1],a+=Ee[1],ie.originalLine=n+Ee[2],n=ie.originalLine,ie.originalLine+=1,ie.originalColumn=s+Ee[3],s=ie.originalColumn,Ee.length>4&&(ie.name=m+Ee[4],m+=Ee[4])),_.push(ie),typeof ie.originalLine=="number"&&P.push(ie)}_m(_,q.compareByGeneratedPositionsDeflated),this.__generatedMappings=_,_m(P,q.compareByOriginalPositions),this.__originalMappings=P};Wt.prototype._findMapping=function(e,r,i,o,n,s){if(e[i]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+e[i]);if(e[o]<0)throw new TypeError("Column must be greater than or equal to 0, got "+e[o]);return dy.search(e,r,n,s)};Wt.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var r=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var i=this._generatedMappings[e+1];if(r.generatedLine===i.generatedLine){r.lastGeneratedColumn=i.generatedColumn-1;continue}}r.lastGeneratedColumn=Infinity}};Wt.prototype.originalPositionFor=function(e){var r={generatedLine:q.getArg(e,"line"),generatedColumn:q.getArg(e,"column")},i=this._findMapping(r,this._generatedMappings,"generatedLine","generatedColumn",q.compareByGeneratedPositionsDeflated,q.getArg(e,"bias",je.GREATEST_LOWER_BOUND));if(i>=0){var o=this._generatedMappings[i];if(o.generatedLine===r.generatedLine){var n=q.getArg(o,"source",null);n!==null&&(n=this._sources.at(n),n=q.computeSourceURL(this.sourceRoot,n,this._sourceMapURL));var s=q.getArg(o,"name",null);return s!==null&&(s=this._names.at(s)),{source:n,line:q.getArg(o,"originalLine",null),column:q.getArg(o,"originalColumn",null),name:s}}}return{source:null,line:null,column:null,name:null}};Wt.prototype.hasContentsOfAllSources=function(){return this.sourcesContent?this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return e==null}):!1};Wt.prototype.sourceContentFor=function(e,r){if(!this.sourcesContent)return null;var i=this._findSourceIndex(e);if(i>=0)return this.sourcesContent[i];var o=e;this.sourceRoot!=null&&(o=q.relative(this.sourceRoot,o));var n;if(this.sourceRoot!=null&&(n=q.urlParse(this.sourceRoot))){var s=o.replace(/^file:\/\//,"");if(n.scheme=="file"&&this._sources.has(s))return this.sourcesContent[this._sources.indexOf(s)];if((!n.path||n.path=="/")&&this._sources.has("/"+o))return this.sourcesContent[this._sources.indexOf("/"+o)]}if(r)return null;throw new Error('"'+o+'" is not in the SourceMap.')};Wt.prototype.generatedPositionFor=function(e){var r=q.getArg(e,"source");if(r=this._findSourceIndex(r),r<0)return{line:null,column:null,lastColumn:null};var i={source:r,originalLine:q.getArg(e,"line"),originalColumn:q.getArg(e,"column")},o=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",q.compareByOriginalPositions,q.getArg(e,"bias",je.GREATEST_LOWER_BOUND));if(o>=0){var n=this._originalMappings[o];if(n.source===i.source)return{line:q.getArg(n,"generatedLine",null),column:q.getArg(n,"generatedColumn",null),lastColumn:q.getArg(n,"lastGeneratedColumn",null)}}return{line:null,column:null,lastColumn:null}};Hf.BasicSourceMapConsumer=Wt;function wi(t,e){var r=t;typeof t=="string"&&(r=q.parseSourceMapInput(t));var i=q.getArg(r,"version"),o=q.getArg(r,"sections");if(i!=this._version)throw new Error("Unsupported version: "+i);this._sources=new Qa,this._names=new Qa;var n={line:-1,column:0};this._sections=o.map(function(s){if(s.url)throw new Error("Support for url field in sections not implemented.");var a=q.getArg(s,"offset"),m=q.getArg(a,"line"),c=q.getArg(a,"column");if(m<n.line||m===n.line&&c<n.column)throw new Error("Section offsets must be ordered and non-overlapping.");return n=a,{generatedOffset:{generatedLine:m+1,generatedColumn:c+1},consumer:new je(q.getArg(s,"map"),e)}})}wi.prototype=Object.create(je.prototype);wi.prototype.constructor=je;wi.prototype._version=3;Object.defineProperty(wi.prototype,"sources",{get:function(){for(var t=[],e=0;e<this._sections.length;e++)for(var r=0;r<this._sections[e].consumer.sources.length;r++)t.push(this._sections[e].consumer.sources[r]);return t}});wi.prototype.originalPositionFor=function(e){var r={generatedLine:q.getArg(e,"line"),generatedColumn:q.getArg(e,"column")},i=dy.search(r,this._sections,function(n,s){var a=n.generatedLine-s.generatedOffset.generatedLine;return a||n.generatedColumn-s.generatedOffset.generatedColumn}),o=this._sections[i];return o?o.consumer.originalPositionFor({line:r.generatedLine-(o.generatedOffset.generatedLine-1),column:r.generatedColumn-(o.generatedOffset.generatedLine===r.generatedLine?o.generatedOffset.generatedColumn-1:0),bias:e.bias}):{source:null,line:null,column:null,name:null}};wi.prototype.hasContentsOfAllSources=function(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})};wi.prototype.sourceContentFor=function(e,r){for(var i=0;i<this._sections.length;i++){var o=this._sections[i],n=o.consumer.sourceContentFor(e,!0);if(n)return n}if(r)return null;throw new Error('"'+e+'" is not in the SourceMap.')};wi.prototype.generatedPositionFor=function(e){for(var r=0;r<this._sections.length;r++){var i=this._sections[r];if(i.consumer._findSourceIndex(q.getArg(e,"source"))!==-1){var o=i.consumer.generatedPositionFor(e);if(o){var n={line:o.line+(i.generatedOffset.generatedLine-1),column:o.column+(i.generatedOffset.generatedLine===o.line?i.generatedOffset.generatedColumn-1:0)};return n}}}return{line:null,column:null}};wi.prototype._parseMappings=function(e,r){this.__generatedMappings=[],this.__originalMappings=[];for(var i=0;i<this._sections.length;i++)for(var o=this._sections[i],n=o.consumer._generatedMappings,s=0;s<n.length;s++){var a=n[s],m=o.consumer._sources.at(a.source);m=q.computeSourceURL(o.consumer.sourceRoot,m,this._sourceMapURL),this._sources.add(m),m=this._sources.indexOf(m);var c=null;a.name&&(c=o.consumer._names.at(a.name),this._names.add(c),c=this._names.indexOf(c));var p={source:m,generatedLine:a.generatedLine+(o.generatedOffset.generatedLine-1),generatedColumn:a.generatedColumn+(o.generatedOffset.generatedLine===a.generatedLine?o.generatedOffset.generatedColumn-1:0),originalLine:a.originalLine,originalColumn:a.originalColumn,name:c};this.__generatedMappings.push(p),typeof p.originalLine=="number"&&this.__originalMappings.push(p)}_m(this.__generatedMappings,q.compareByGeneratedPositionsDeflated),_m(this.__originalMappings,q.compareByOriginalPositions)};Hf.IndexedSourceMapConsumer=wi});var iF=te(rF=>{var s2=uy().SourceMapGenerator,Gf=$a(),a2=/(\r?\n)/,l2=10,Ya="$$$isSourceNode$$$";function Br(t,e,r,i,o){this.children=[],this.sourceContents={},this.line=t??null,this.column=e??null,this.source=r??null,this.name=o??null,this[Ya]=!0,i!=null&&this.add(i)}Br.fromStringWithSourceMap=function(e,r,i){var o=new Br,n=e.split(a2),s=0,a=function(){var y=_(),P=_()||"";return y+P;function _(){return s<n.length?n[s++]:void 0}},m=1,c=0,p=null;return r.eachMapping(function(y){if(p!==null)if(m<y.generatedLine)d(p,a()),m++,c=0;else{var P=n[s]||"",_=P.substr(0,y.generatedColumn-c);n[s]=P.substr(y.generatedColumn-c),c=y.generatedColumn,d(p,_),p=y;return}for(;m<y.generatedLine;)o.add(a()),m++;if(c<y.generatedColumn){var P=n[s]||"";o.add(P.substr(0,y.generatedColumn)),n[s]=P.substr(y.generatedColumn),c=y.generatedColumn}p=y},this),s<n.length&&(p&&d(p,a()),o.add(n.splice(s).join(""))),r.sources.forEach(function(y){var P=r.sourceContentFor(y);P!=null&&(i!=null&&(y=Gf.join(i,y)),o.setSourceContent(y,P))}),o;function d(y,P){if(y===null||y.source===void 0)o.add(P);else{var _=i?Gf.join(i,y.source):y.source;o.add(new Br(y.originalLine,y.originalColumn,_,P,y.name))}}};Br.prototype.add=function(e){if(Array.isArray(e))e.forEach(function(r){this.add(r)},this);else if(e[Ya]||typeof e=="string")e&&this.children.push(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};Br.prototype.prepend=function(e){if(Array.isArray(e))for(var r=e.length-1;r>=0;r--)this.prepend(e[r]);else if(e[Ya]||typeof e=="string")this.children.unshift(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};Br.prototype.walk=function(e){for(var r,i=0,o=this.children.length;i<o;i++)r=this.children[i],r[Ya]?r.walk(e):r!==""&&e(r,{source:this.source,line:this.line,column:this.column,name:this.name})};Br.prototype.join=function(e){var r,i,o=this.children.length;if(o>0){for(r=[],i=0;i<o-1;i++)r.push(this.children[i]),r.push(e);r.push(this.children[i]),this.children=r}return this};Br.prototype.replaceRight=function(e,r){var i=this.children[this.children.length-1];return i[Ya]?i.replaceRight(e,r):typeof i=="string"?this.children[this.children.length-1]=i.replace(e,r):this.children.push("".replace(e,r)),this};Br.prototype.setSourceContent=function(e,r){this.sourceContents[Gf.toSetString(e)]=r};Br.prototype.walkSourceContents=function(e){for(var r=0,i=this.children.length;r<i;r++)this.children[r][Ya]&&this.children[r].walkSourceContents(e);for(var o=Object.keys(this.sourceContents),r=0,i=o.length;r<i;r++)e(Gf.fromSetString(o[r]),this.sourceContents[o[r]])};Br.prototype.toString=function(){var e="";return this.walk(function(r){e+=r}),e};Br.prototype.toStringWithSourceMap=function(e){var r={code:"",line:1,column:0},i=new s2(e),o=!1,n=null,s=null,a=null,m=null;return this.walk(function(c,p){r.code+=c,p.source!==null&&p.line!==null&&p.column!==null?((n!==p.source||s!==p.line||a!==p.column||m!==p.name)&&i.addMapping({source:p.source,original:{line:p.line,column:p.column},generated:{line:r.line,column:r.column},name:p.name}),n=p.source,s=p.line,a=p.column,m=p.name,o=!0):o&&(i.addMapping({generated:{line:r.line,column:r.column}}),n=null,o=!1);for(var d=0,y=c.length;d<y;d++)c.charCodeAt(d)===l2?(r.line++,r.column=0,d+1===y?(n=null,o=!1):o&&i.addMapping({source:p.source,original:{line:p.line,column:p.column},generated:{line:r.line,column:r.column},name:p.name})):r.column++}),this.walkSourceContents(function(c,p){i.setSourceContent(c,p)}),{code:r.code,map:i}};rF.SourceNode=Br});var oF=te(Kf=>{Kf.SourceMapGenerator=uy().SourceMapGenerator;Kf.SourceMapConsumer=tF().SourceMapConsumer;Kf.SourceNode=iF().SourceNode});var sF=te((jze,nF)=>{var m2=Object.prototype.toString,hy=typeof Buffer.alloc=="function"&&typeof Buffer.allocUnsafe=="function"&&typeof Buffer.from=="function";function u2(t){return m2.call(t).slice(8,-1)==="ArrayBuffer"}function c2(t,e,r){e>>>=0;var i=t.byteLength-e;if(i<0)throw new RangeError("'offset' is out of bounds");if(r===void 0)r=i;else if(r>>>=0,r>i)throw new RangeError("'length' is out of bounds");return hy?Buffer.from(t.slice(e,e+r)):new Buffer(new Uint8Array(t.slice(e,e+r)))}function f2(t,e){if((typeof e!="string"||e==="")&&(e="utf8"),!Buffer.isEncoding(e))throw new TypeError('"encoding" must be a valid string encoding');return hy?Buffer.from(t,e):new Buffer(t,e)}function p2(t,e,r){if(typeof t=="number")throw new TypeError('"value" argument must not be a number');return u2(t)?c2(t,e,r):typeof t=="string"?f2(t,e):hy?Buffer.from(t):new Buffer(t)}nF.exports=p2});var dF=te((Es,gy)=>{var d2=oF().SourceMapConsumer,yy=require("path"),Zi;try{Zi=require("fs"),(!Zi.existsSync||!Zi.readFileSync)&&(Zi=null)}catch(t){}var h2=sF();function aF(t,e){return t.require(e)}var lF=!1,mF=!1,by=!1,Nm="auto",Ds={},Bm={},g2=/^data:application\/json[^,]+base64,/,An=[],Fn=[];function xy(){return Nm==="browser"?!0:Nm==="node"?!1:typeof window!="undefined"&&typeof XMLHttpRequest=="function"&&!(window.require&&window.module&&window.process&&window.process.type==="renderer")}function y2(){return typeof process=="object"&&process!==null&&typeof process.on=="function"}function Jf(t){return function(e){for(var r=0;r<t.length;r++){var i=t[r](e);if(i)return i}return null}}var wy=Jf(An);An.push(function(t){if(t=t.trim(),/^file:/.test(t)&&(t=t.replace(/file:\/\/\/(\w:)?/,function(i,o){return o?"":"/"})),t in Ds)return Ds[t];var e="";try{if(Zi)Zi.existsSync(t)&&(e=Zi.readFileSync(t,"utf8"));else{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),r.readyState===4&&r.status===200&&(e=r.responseText)}}catch(i){}return Ds[t]=e});function Ty(t,e){if(!t)return e;var r=yy.dirname(t),i=/^\w+:\/\/[^\/]*/.exec(r),o=i?i[0]:"",n=r.slice(o.length);return o&&/^\/\w\:/.test(n)?(o+="/",o+yy.resolve(r.slice(o.length),e).replace(/\\/g,"/")):o+yy.resolve(r.slice(o.length),e)}function b2(t){var e;if(xy())try{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),e=r.readyState===4?r.responseText:null;var i=r.getResponseHeader("SourceMap")||r.getResponseHeader("X-SourceMap");if(i)return i}catch(a){}e=wy(t);for(var o=/(?:\/\/[@#][\s]*sourceMappingURL=([^\s'"]+)[\s]*$)|(?:\/\*[@#][\s]*sourceMappingURL=([^\s*'"]+)[\s]*(?:\*\/)[\s]*$)/mg,n,s;s=o.exec(e);)n=s;return n?n[1]:null}var My=Jf(Fn);Fn.push(function(t){var e=b2(t);if(!e)return null;var r;if(g2.test(e)){var i=e.slice(e.indexOf(",")+1);r=h2(i,"base64").toString(),e=t}else e=Ty(t,e),r=wy(e);return r?{url:e,map:r}:null});function vy(t){var e=Bm[t.source];if(!e){var r=My(t.source);r?(e=Bm[t.source]={url:r.url,map:new d2(r.map)},e.map.sourcesContent&&e.map.sources.forEach(function(o,n){var s=e.map.sourcesContent[n];if(s){var a=Ty(e.url,o);Ds[a]=s}})):e=Bm[t.source]={url:null,map:null}}if(e&&e.map&&typeof e.map.originalPositionFor=="function"){var i=e.map.originalPositionFor(t);if(i.source!==null)return i.source=Ty(e.url,i.source),i}return t}function uF(t){var e=/^eval at ([^(]+) \((.+):(\d+):(\d+)\)$/.exec(t);if(e){var r=vy({source:e[2],line:+e[3],column:e[4]-1});return"eval at "+e[1]+" ("+r.source+":"+r.line+":"+(r.column+1)+")"}return e=/^eval at ([^(]+) \((.+)\)$/.exec(t),e?"eval at "+e[1]+" ("+uF(e[2])+")":t}function x2(){var t,e="";if(this.isNative())e="native";else{t=this.getScriptNameOrSourceURL(),!t&&this.isEval()&&(e=this.getEvalOrigin(),e+=", "),t?e+=t:e+="<anonymous>";var r=this.getLineNumber();if(r!=null){e+=":"+r;var i=this.getColumnNumber();i&&(e+=":"+i)}}var o="",n=this.getFunctionName(),s=!0,a=this.isConstructor(),m=!(this.isToplevel()||a);if(m){var c=this.getTypeName();c==="[object Object]"&&(c="null");var p=this.getMethodName();n?(c&&n.indexOf(c)!=0&&(o+=c+"."),o+=n,p&&n.indexOf("."+p)!=n.length-p.length-1&&(o+=" [as "+p+"]")):o+=c+"."+(p||"<anonymous>")}else a?o+="new "+(n||"<anonymous>"):n?o+=n:(o+=e,s=!1);return s&&(o+=" ("+e+")"),o}function cF(t){var e={};return Object.getOwnPropertyNames(Object.getPrototypeOf(t)).forEach(function(r){e[r]=/^(?:is|get)/.test(r)?function(){return t[r].call(t)}:t[r]}),e.toString=x2,e}function fF(t,e){if(e===void 0&&(e={nextPosition:null,curPosition:null}),t.isNative())return e.curPosition=null,t;var r=t.getFileName()||t.getScriptNameOrSourceURL();if(r){var i=t.getLineNumber(),o=t.getColumnNumber()-1,n=/^v(10\.1[6-9]|10\.[2-9][0-9]|10\.[0-9]{3,}|1[2-9]\d*|[2-9]\d|\d{3,}|11\.11)/,s=n.test(process.version)?0:62;i===1&&o>s&&!xy()&&!t.isEval()&&(o-=s);var a=vy({source:r,line:i,column:o});e.curPosition=a,t=cF(t);var m=t.getFunctionName;return t.getFunctionName=function(){return e.nextPosition==null?m():e.nextPosition.name||m()},t.getFileName=function(){return a.source},t.getLineNumber=function(){return a.line},t.getColumnNumber=function(){return a.column+1},t.getScriptNameOrSourceURL=function(){return a.source},t}var c=t.isEval()&&t.getEvalOrigin();return c&&(c=uF(c),t=cF(t),t.getEvalOrigin=function(){return c}),t}function w2(t,e){by&&(Ds={},Bm={});for(var r=t.name||"Error",i=t.message||"",o=r+": "+i,n={nextPosition:null,curPosition:null},s=[],a=e.length-1;a>=0;a--)s.push(`
    at `+fF(e[a],n)),n.nextPosition=n.curPosition;return n.curPosition=n.nextPosition=null,o+s.reverse().join("")}function pF(t){var e=/\n    at [^(]+ \((.*):(\d+):(\d+)\)/.exec(t.stack);if(e){var r=e[1],i=+e[2],o=+e[3],n=Ds[r];if(!n&&Zi&&Zi.existsSync(r))try{n=Zi.readFileSync(r,"utf8")}catch(a){n=""}if(n){var s=n.split(/(?:\r\n|\r|\n)/)[i-1];if(s)return r+":"+i+`
`+s+`
`+new Array(o).join(" ")+"^"}}return null}function T2(t){var e=pF(t);process.stderr._handle&&process.stderr._handle.setBlocking&&process.stderr._handle.setBlocking(!0),e&&(console.error(),console.error(e)),console.error(t.stack),process.exit(1)}function M2(){var t=process.emit;process.emit=function(e){if(e==="uncaughtException"){var r=arguments[1]&&arguments[1].stack,i=this.listeners(e).length>0;if(r&&!i)return T2(arguments[1])}return t.apply(this,arguments)}}var v2=An.slice(0),S2=Fn.slice(0);Es.wrapCallSite=fF;Es.getErrorSource=pF;Es.mapSourcePosition=vy;Es.retrieveSourceMap=My;Es.install=function(t){if(t=t||{},t.environment&&(Nm=t.environment,["node","browser","auto"].indexOf(Nm)===-1))throw new Error("environment "+Nm+" was unknown. Available options are {auto, browser, node}");if(t.retrieveFile&&(t.overrideRetrieveFile&&(An.length=0),An.unshift(t.retrieveFile)),t.retrieveSourceMap&&(t.overrideRetrieveSourceMap&&(Fn.length=0),Fn.unshift(t.retrieveSourceMap)),t.hookRequire&&!xy()){var e=aF(gy,"module"),r=e.prototype._compile;r.__sourceMapSupport||(e.prototype._compile=function(n,s){return Ds[s]=n,Bm[s]=void 0,r.call(this,n,s)},e.prototype._compile.__sourceMapSupport=!0)}if(by||(by="emptyCacheBetweenOperations"in t?t.emptyCacheBetweenOperations:!1),lF||(lF=!0,Error.prepareStackTrace=w2),!mF){var i="handleUncaughtExceptions"in t?t.handleUncaughtExceptions:!0;try{var o=aF(gy,"worker_threads");o.isMainThread===!1&&(i=!1)}catch(n){}i&&y2()&&(mF=!0,M2())}};Es.resetRetrieveHandlers=function(){An.length=0,Fn.length=0,An=v2.slice(0),Fn=S2.slice(0),My=Jf(Fn),wy=Jf(An)}});var hF=S(require("util"));function Xa(t){return t!=null&&typeof t!="string"&&typeof t[Symbol.iterator]=="function"}function g(t){return t==null?"":typeof t=="string"?t:Array.isArray(t)?t.map(g).join(","):t.toString()}var vF=["number","string","boolean"];function Vr(t){return vF.indexOf(typeof t)!==-1||t instanceof Date}function Cm(t){return Array.isArray(t)&&t.every(Vr)}var Ey=["boolean","number","bigint","symbol","string","object","function"];function Xt(t,e){if(t==null&&e==null)return 0;if(t==null)return-1;if(e==null)return 1;let r=typeof t,i=typeof e;return(r==="string"||r==="symbol")&&(i==="string"||i==="symbol")?g(t).localeCompare(g(e)):Array.isArray(t)&&Array.isArray(e)?SF(t,e):r!==i?Ey.indexOf(r)-Ey.indexOf(i):t>e?1:t<e?-1:0}function eo(t,e){return Xt(t,e)<0}function As(t,e){return Xt(t,e)>=0}function Fs(t,e){return Xt(t,e)>0}function SF(t,e){if(L(t)&&L(e))return 0;let r=Math.min(t.length,e.length);for(let i=0;i<r;i++){let o=Xt(t[i],e[i]);if(o!==0)return o}return Xt(t.length,e.length)}var zr;(function(t){t[t.Empty=0]="Empty",t[t.Primitive=1]="Primitive",t[t.Symbol=2]="Symbol",t[t.Object=3]="Object",t[t.Array=4]="Array",t[t.Iterable=5]="Iterable",t[t.Instance=6]="Instance",t[t.Function=7]="Function",t[t.Unknown=8]="Unknown"})(zr||(zr={}));function PF(t){return typeof t=="symbol"}function xe(t){return typeof t=="function"}function Vm(t){return EF(t)===3}function EF(t){return t==null?0:PF(t)?2:Vr(t)?1:Array.isArray(t)?4:Xa(t)?5:xe(t)?7:typeof t=="object"?t.constructor!=null&&t.constructor.name==="Object"?3:6:8}function pr(t){return xe(t)?t():t}function Ls(t){for(let e of t){let r=e();if(r!=null)return r}}var Za=()=>{};function f(t,e){return t==null?void 0:e(t)}function In(t,e,r){return t==null||e==null?void 0:r(t,e)}function Dy(t,e,r,i){return t==null||e==null||r==null?void 0:i(t,e,r)}function M(t,e){return t??pr(e)}function J(t,e,r){return t!=null?e(t):pr(r)}function Mi(t,e,r,i){return M(In(t,e,r),i)}function vi(t){return t!=null}function zm(t){return t!=null&&t.every(vi)}function Ay(...t){return t.find(vi)}function Is(t){return t==null||g(t)==="null"?void 0:t}function T(t){if(t==null)return!0;let e=g(t);return e.length===0||e.trim().length===0}var DF=/^\s*(?:null|undefined)?\s*$/i;function Os(t){return t==null||DF.exec(t)!=null}function v(t){return!T(t)}function Qf(t){if(t==null)return;let e=g(t);return e.length===0||e.trim().length===0?void 0:e}function Zt(t,e){if(t==null)return pr(e);let r=g(t).trim();return r.length>0?r:pr(e)}function Yf(t,e){return T(t)?!1:e(t)}function U(t,e){if(t===!1||t==null||t==="")return;let r=g(t);return v(r)?e(r):void 0}function ii(t,e,r){return M(U(t,e),r)}function Xf(...t){for(let e of t)if(v(e))return e}function k(t,e,r,i){return JSON.stringify(t,AF(e,i),Is(r))}function AF(t,e){let r=[],i=[],o=e??((n,s)=>r[0]===s?"[Circular ~]":"[Circular ~."+i.slice(0,r.indexOf(s)).join(".")+"]");return function(n,s){if(r.length>0){let m=r.indexOf(this);m>=0?(r.splice(m+1),i.splice(m,Infinity,n)):(r.push(this),i.push(n)),r.indexOf(s)>=0&&(s=o.call(this,n,s))}else r.push(s);return t==null?s:t.call(this,n,s)}}function to(t,e){return k(t)===k(e)}function Fy(t){return t!=null&&(Array.isArray(t)||isFinite(t.length)&&xe(t[Symbol.iterator])&&xe(t.push)&&xe(t.pop)&&xe(t.forEach)&&xe(t.some))}function Ur(t,e,r){if(e==null)throw new Error("null key");if(t.has(e))return t.get(e);{let i=r();return i!=null&&t.set(e,i),i}}var Zf;(function(_){_.isDefined=!1,_.isEmpty=!0,_.get=()=>{},_.exists=()=>!1;let o=()=>_;_.map=o,_.flatMap=o,_.filter=o,_.forEach=o,_.getOrElse=ie=>ie(),_.orElse=ie=>V(ie()),_.zip1=o,_.zip2=o,_.zip3=o})(Zf||(Zf={}));var Ly=Zf,el=class{constructor(e){this.a=e;this.isDefined=!0;this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new el(e(this.a))}flatMap(e){let r=e(this.a);return Iy(r)?r:V(r)}filter(e){return V(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,r){return V(e).flatMap(i=>r(this.a,i))}zip2(e,r,i){return V(e).flatMap(o=>V(r).flatMap(n=>i(this.a,o,n)))}zip3(e,r,i,o){return V(e).flatMap(n=>V(r).flatMap(s=>V(i).flatMap(a=>o(this.a,n,s,a))))}};function Iy(t){return t instanceof el||t===Ly}function V(t){return Iy(t)?t:t!=null?new el(t):Ly}function re(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function tl(t,e){return re(t)?e(t):void 0}var Um=t=>(e,r)=>re(e)&&re(r)&&t(e,r),rl=Um((t,e)=>t<e),ro=Um((t,e)=>t<=e),On=Um((t,e)=>t>e),qr=Um((t,e)=>t>=e);function Oy(t,e){return t/(e===0?1e-8:e)}function ky(t,e,r){return t==null||e==null?!1:t===e?!0:qr(t<e?Oy(t,e):Oy(e,t),r)}function qm(t,e,r){return t==null||e==null?!1:Math.abs(t-e)<r}function FF(t){if(!re(t))return;let e=Math.trunc(t);return e===0?Math.abs(e):e}function LF(t){return xe(t.toNumber)}function Ry(t,e){if(T(t))return e.defaultValue;if(re(t))return e.nton(t);if(LF(t))return e.nton(t.toNumber());try{let r=e.ston(g(t));return re(r)?e.nton(r):e.defaultValue}catch{return e.defaultValue}}function H(t,e){return Ry(t,w({defaultValue:void 0,nton:r=>FF(r),ston:parseInt},e))}function Wr(t,e){return Ry(t,w({defaultValue:void 0,nton:r=>r,ston:parseFloat},e))}function N(t){return re(t)&&t>0}function _y(t,e){return re(t)&&re(e)&&t>e?t:void 0}function Wm(t){return re(t)&&t>=0}function ks(t,e){return V(t).flatMap(r=>H(r)).flatMap(e).get()}function ep(t){let e=H(t);return N(e)?String(e):void 0}function Si(t,e){return re(t)?e(t):void 0}function zo(t,e,r){return Si(t,i=>Si(e,o=>r(i,o)))}function tp(t,e,r){return re(t)?e(t):r}function Ny(t,e){return re(t)?t:pr(e)}function Ze(t){return t<0?-Math.round(-t):Math.round(t)}function Be(t,e){if(t===0||e===0)return 0;let r=e-Ze(Math.ceil(Math.log10(Math.abs(t)))),i=Math.pow(10,Math.abs(r));return r<0?Ze(t/i)*i:Ze(t*i)/i}function Z(t,e,r){if(t>e||!re(t)||!re(e))throw new Error(`invalid clamp(${t}, ${e}, ${r})`);return re(r)?r<t?t:r>e?e:r:Ze((t+e)/2)}function ce(t,e){if(!N(t))return[];let r=Math.round(t);return r<=0?[]:[...Array(r)].map((i,o)=>e(o))}function er(t,e,r=[]){if(t=Math.ceil(t),e=Math.floor(e),e<t)return t;if(C(r)&&r.length+10>e-t){let o=io(t,e).filter(n=>!r.includes(n));return Ae(o,n=>n[er(0,o.length)])}let i=Math.floor(Math.random()*(e-t))+t;return r.includes(i)?er(t,e,r):i}var By="0123456789abcdefghijkmnopqrstuvwxyz";function il(t,e=By){let r="";for(let i=0;i<t;i++)r+=IF(e);return r}function IF(t=By){return t[er(0,t.length)]}function ct(t){return typeof t=="string"}function Pi(t,e){return t=g(t),e=g(e),t.startsWith(e)?t:e+t}function Ht(t,e){return t=g(t),e=g(e),t.endsWith(e)?t:t+e}function dr(t,e=80){if(t==null)return"";let r=g(t);return r.length<=e?r:r.slice(0,e-1)+"\u2026"}var oo=/\r?\n/gm;function OF(t,e,r){r==null&&(r=t.length);for(let i=r;i>=0;i--)if(t.substr(i).startsWith(e))return i;return-1}function no(t,e={maxLineLen:75,prefix:""}){if(t.includes(`
`))return Y(t.split(oo).map(i=>no(i,e)));if(t=Pi(g(t),e.prefix).trim(),t.length<=e.maxLineLen)return[t];let r=OF(t," ",e.maxLineLen);if(r>e.prefix.length)return[t.slice(0,r),...no(t.slice(r+1),e)];{let i=t.indexOf(" ",e.prefix.length+1);return i>0&&i<t.length-1?[t.slice(0,i),...no(t.slice(i+1),e)]:[t]}}function ol(t,e,r){return e===""?t:t.split(e).join(r)}function Ei(...t){return t.join(" ").replace(/\s+/g," ").trim()}function F(t){return t==null?[]:Array.isArray(t)?t:Xa(t)?Array.from(t):[t]}function C(t){return Fy(t)&&t.length>0&&t.some(e=>e!=null)}function Cy(t,e){return C(t)?t:pr(e)}function L(t){return!C(t)}function Ae(t,e){return C(t)?e(t):void 0}function kF(t){return Vr(t)||Cm(t)?t:t.valueOf()}function Y(t,e=[]){if(t==null)return e;for(let r of t)if(r!=null)if(Array.isArray(r))for(let i of r)i!=null&&e.push(i);else e.push(r);return e}function tr(t){return kn(A(t),kF)}function rp(t,e){for(let r=0;r<t.length;r++)e[r]=t[r];return e.length=t.length,e}function kn(t,e){return rp($(t,e),t)}function $(t,e){return F(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:f(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>Xt(r.cmp,i.cmp)).map(r=>r.item)}function jm(t,e){return t!=null&&e!=null&&t.length===e.length&&t.every((r,i)=>r===e[i])}function Hm(t,e){return jm(t.slice(0,e.length),e)}function ft(t,e){for(let r=0;r<t.length;)e(t[r],r,t)?r++:t.splice(r,1);return t}function so(t,e){if(t==null)return!1;for(let r of t)if(e.valueOf()===r.valueOf())return!0;return!1}function Gm(t,e){return t==null||e==null?!1:e.every(r=>so(t,r))}function Km(t,e,r){let i=t.map(r);for(let o of e){let n=r(o);i.includes(n)||(t.push(o),i.push(n))}return t}function A(t){if(t==null)return[];let e=F(t);return e.every(vi)?e:e.filter(vi)}function _s(t){let e=F(t).filter(r=>!Os(g(r)));return ct(e[0])?e.map(r=>g(r).trim()):e}function R(t){return F(t).map(e=>g(e).trim()).filter(e=>e.length>0)}function z(t){return hr(A(t),e=>k(e))}function hr(t,e=r=>k(r)){if(L(t))return[];let r=new Map;for(let i of t)if(i!=null){let o=e(i);o!=null&&Ur(r,o,()=>i)}return[...r.values()]}function Jm(t,e){if(L(t))return[];let r=[];for(let i of t)i!=null&&r.every(o=>!e(i,o))&&r.push(i);return r}function Sr(t,e){return t.reduce((r,i,o)=>r+(e(i,o)?1:0),0)}function Rs(t,e){return t.reduce((r,i,o)=>r+e(i,o),0)}function nl(t,e){if(t==null||e==null)return 0;if(t===e||(typeof t=="string"&&(t=t.split("")),typeof e=="string"&&(e=e.split("")),jm(t,e)))return t.length;let r=0;for(;t[r]===e[r];)r++;return r}function io(t,e,r=i=>i){return Rn(t,e,1,r)}function Rn(t,e,r=1,i=o=>o){let o=[];if(t<e)for(let n=t;n<e;n+=r)o.push(i(n));else for(let n=t;n>e;n-=r)o.push(i(n));return o}function $m(t,e){let r=new Set(e);return t.filter(i=>!r.has(i))}function Qm(t){return t!=null?t[t.length-1]:void 0}function l(t,e){return new Vy(t,e).asMemoizedThunk()}var Vy=class{constructor(e,r){this.thunk=e;this.ttlMs=r;this.lastSet=0;this.listeners=[]}asMemoizedThunk(){let e=this.apply.bind(this);return e.set=this.set.bind(this),e.clear=this.clear.bind(this),e.unset=this.unset.bind(this),e.prior=this.prior.bind(this),e.refresh=this.refresh.bind(this),e.ttl=this.ttl.bind(this),e.setTTL=this.setTTL.bind(this),e.onChange=this.onChange.bind(this),e.toJSON=this.toJSON.bind(this),e.lastSetAgoMs=this.lastSetAgoMs.bind(this),e}async onSetResult(e,r){if(L(this.listeners))return;let i=await e,o=await r;if(!to(i,o))for(let n of this.listeners)n(o,i)}setResult(e){return this.lastSet=Date.now(),this.onSetResult(this.result,e),this.result=e}apply(){return(this.lastSet===0||this.ttlMs!=null&&this.lastSet+this.ttlMs<=Date.now())&&this.setResult(this.thunk()),this.result}set(e){return this.setResult(e)}unset(){this.setResult(void 0),this.lastSet=0}clear(){let e=this.result;return this.unset(),e}prior(){return this.result}refresh(){return this.setResult(this.thunk())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=e}onChange(e){this.listeners.push(e),f(this.result,e)}toJSON(){return"(Lazy)"}lastSetAgoMs(){return Date.now()-this.lastSet}};var E=1e3,D=60*E,At=60*D,ot=24*At,zy=7*ot,Uy=365.25*ot,JV=l(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));function Ns(t){return t instanceof Date}function qy(t,e){return new Date(M(e,new Date).getTime()-t)}function Di(t){let e=Ns(t)?t.getTime():re(t)?t:Date.now();return Math.floor(e/E)}function _n(t){let e=String(t);return e.length>=2?e:("0"+e).slice(-2)}function Wy(t){let e=Ns(t)?t:new Date(t);return e.getFullYear()+_n(e.getMonth()+1)+_n(e.getDate())+_n(e.getHours())+_n(e.getMinutes())+_n(e.getSeconds())}function jy(t){let e=Ns(t)?t:new Date(t);return e.getFullYear()+"-"+_n(e.getMonth()+1)+"-"+_n(e.getDate())}function he(...t){let e=Object.freeze(t),r={};for(let a of e)r[a]=a;let i=a=>a!=null&&e.includes(a),o=a=>a==null?-1:e.indexOf(a),n=(a,m)=>i(a)?a:pr(m),s=(a,m)=>i(a)?m(a):void 0;return w(w({},r),{values:e,length:e.length,has:i,indexOf:o,validOrElse:n,mapValid:s})}function we(t,e){return r=>`[${t}m${r}[${e}m`}var ZV=we(30,39),Ym=we(31,39),Xm=we(32,39),Bs=we(33,39),Zm=we(34,39),eu=we(35,39),tu=we(36,39),ez=we(37,39),Cs=we(90,39),Hy=we(91,39),tz=we(92,39),Gy=we(93,39),Ky=we(94,39),rz=we(95,39),iz=we(96,39),oz=we(97,39),Jy=we(40,49),nz=we(41,49),sz=we(42,49),az=we(43,49),lz=we(44,49),mz=we(45,49),uz=we(46,49),cz=we(47,49),fz=we(100,49),pz=we(101,49),dz=we(102,49),hz=we(103,49),gz=we(104,49),yz=we(105,49),bz=we(106,49),xz=we(107,49);var Zy=S(require("process"));function vt(t,e){return e!=null?e(t):typeof t=="string"?console.log(t):console.dir(t,{depth:3}),t}function nt(t){return t==null||typeof t!="object"?[]:Object.keys(t).filter(e=>typeof e=="string"&&(t.propertyIsEnumerable==null||t.propertyIsEnumerable(e)===!0))}function pt(t){return nt(t).map(e=>t[e])}function ze(t){return nt(t).map(e=>[e,t[e]])}function st(t,e){return typeof e!="object"&&(e={}),A(t).reduce((r,[i,o])=>vt(r,()=>{i!=null&&o!=null&&(r[i]=o)}),e)}function oi(t){if(t==null)return;let e=ze(t).filter(([r,i])=>r!=null&&i!=null);return L(e)?void 0:st(e)}function ip(t){if(t==null)return;let e=ze(t).filter(([r,i])=>r!=null&&v(i));return L(e)?void 0:st(e)}function Uo(t,e,r={}){let i=A(ze(t).sort(([o],[n])=>o.localeCompare(n,void 0,{sensitivity:"base"})).map(([o,n])=>e(o,n)));return st(i.filter(([o,n])=>o!=null&&n!=null),r)}function at(t,...e){if(t==null)return t;if(!e.every(i=>typeof i=="string"))throw new Error("bad keys: "+k(e));if(L(e))return{};let r={};for(let i of e){let o=t[i];o!=null&&(r[i]=o)}return r}function kt(t,...e){if(t==null||e.every(i=>T(t[i])))return t;let r=ze(t).filter(([i])=>!e.includes(i));return L(r)?void 0:st(r)}function ru(t){return pt(t).every(e=>e!=null)}function qo(t){return ru(t)?t:void 0}function $y(t){return t.filter(ru)}function op(t){return st($(ze(t),([e])=>e.toLowerCase()))}function iu(t,e,...r){return t!=null&&xe(t[e])?t[e].bind(t)(...r):void 0}function Qy(t,e){if(T(e))return;if(t[e]!=null)return t[e];let r=e.toLocaleLowerCase().normalize();for(let i of nt(t))if(r===i.toLocaleLowerCase().normalize()&&t[i]!=null)return t[i]}function np(t){return typeof t=="boolean"}function B(t){if(typeof t=="boolean")return t;if(t==null)return!1;if(t===1)return!0;let e=String(t).toLowerCase();return["true","1"].includes(e)}function Yy(t){return B(t)?!0:Pr(t)?!1:void 0}function Xy(t){return B(t)?1:0}function Pr(t){if(typeof t=="boolean")return!t;if(t==null)return!1;if(t===0)return!0;let e=String(t).toLowerCase();return["false","0"].includes(e)}function He(t){return Qy(Zy.env,t)}function ao(t){return B(He(t))}var eb=S(require("process"));var Vs=S(require("process"));function RF(){switch(g(Vs.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return Vs.argv.some(t=>t.endsWith("mocha")||t.endsWith(".spec.js"))?"test":"production"}}var zs=(()=>{let t=RF();return Vs.env.NODE_ENV=t,t})();var Te=zs==="test",Er=zs==="production";function Nn(){return Te&&B(Vs.env.SINGLE_SPEC_TESTS)}var Us=Date.now();var lo="PhotoStructure",mo=l(()=>lo+(Er?"":`-${zs}`));var ou=he("main","web","sync","sync-file","info","test","logcat","logtail","list","billing");function rb(t){let e=ou.indexOf(t);return e<0?ou.length+1:e}var _F=["main","test"],NF=["main","web","test","info"],BF=["sync","sync-file"];function ib(t){switch(t){case"main":case"web":return D;case"sync":case"sync-file":default:return 10*E}}var ni="";function Dr(){if(T(ni))throw Error("serviceName() is unset");return ni}function nu(t){if(!Te&&t!==ni&&ni!=="")throw new Error("Cannot set service name twice");ni=t,si.unset(),tb()}var CF=l(()=>[{re:/sync-file|billing/,f:tu},{re:/sync/,f:Zm},{re:/web/,f:Xm},{re:/db/,f:eu},{re:/main/,f:Bs},{re:/info/,f:Ky},{re:/test/,f:Ym}]),si=l(()=>R([ni,g(eb.pid)]).join("-"));function ob(t){let e=CF().find(r=>t.match(r.re));return e!=null?Jy(e.f(t)):t}function ai(){return ni===ou.main}function qs(){return ni===ou.web}function Wo(){return _F.includes(Dr())}function sl(){return!Wo()&&ni!=="info"}function VF(){return ni==="sync"}function sp(){return ni==="sync-file"}function nb(){return NF.includes(Dr())}function sb(){return BF.includes(Dr())}var ab=l(()=>VF()||Te&&!sp());var vT=S(require("os")),da=S(require("path"));var zF=he("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),ap=zF.values,Xz=he("s480","s240","s120","s60"),lb=[60,120,240,480];var lp=l(()=>new Intl.NumberFormat),sU=l(()=>ol(lp().format(1111),"1","").charAt(0)),aU=l(()=>ol(lp().format(1.1),"1","").charAt(0));function su(t){return lp().format(t)}var mp=1e3,Ge=mp*1e3,uo=Ge*1e3,lU=uo*1e3,up=1024,Ai=up*1024,al=Ai*1024,mU=al*1024,UF=["B","KB","MB","GB","TB","PB"];function li(t,e=3){if(t===0)return"0";if(!re(t))return"-";let r=Math.floor(Math.log10(t)),i=Math.floor(r/3),o=Math.pow(10,i*3),n=UF[i];return Be(t/o,e)+" "+n}var qF=1e6;function au(t){return Be(t/qF,2)}var uU=he("tiny","small","medium","large","original");function mb(t){return t<320*240?"tiny":t<720*480?"small":t<1920*1080?"medium":"large"}function lu(t,e,r=e+"s"){return su(t)+" "+(t===1?e:r)}function mu(t,e,r=e+"s"){return{count:su(t),desc:t===1?e:r}}var ra=S(require("fs")),Tl=S(require("fs-extra")),Bt=S(require("path")),Dx=S(require("zlib"));var ub=S(require("util"));var WF=require("deep-eql");function $e(t,e){return WF(t,e)}function ll(t,e){return t==null||e==null?!1:$e(t,e)}async function Bn(t,e){return Mi(await t,await e,$e,()=>!1)}async function cp(t,e,...r){return Mi(await t,await e,(i,o)=>$e(at(i,...r),at(o,...r)),()=>!1)}function uu(...t){return t!=null&&t.every(v)}function cb(t){return t==null||t.some(e=>e==null)}function Ke(t,e){if(t!=null)for(let r of A(t)){let i=e(r);if(i!=null)return i}}async function fp(t,e){if(t!=null){let r=-1;for(let i of t){r++;try{if(i==null)continue;let o=await e(i,r);if(o!=null)return o}catch(o){}}}}function fb(t,e){for(let r=t.length-1;r>=0;r--)if(e(t[r]))return t[r]}function pb(t,...e){let r=t.length;return ft(t,i=>e.every(o=>!$e(i,o))),r!==t.length}var db=t=>{if(Vr(t))return t;if(Array.isArray(t))return k(t);if(xe(t.valueOf))return t.valueOf();throw new Error("Cannot get primitive value for "+(0,ub.inspect)(t))};function pp(t,e,r=db){let i=new Set(e.map(r));return t.filter(o=>i.has(r(o)))}function hb(t,e,r=db){return L(t)&&L(e)?1:pp(t,e,r).length*2/(t.length+e.length)}function cu(t,e=r=>k(r)){rp(hr(t,e),t)}function Cn(t,e){let r=[],i=[];return t.forEach((o,n)=>(e(o,n)?r:i).push(o)),[r,i]}function yb(t){return gb(t.sort())}function gb(t){if(t==null||t.length===0)return[];let e=t[0],r=t.lastIndexOf(e);return[{t:e,count:r+1},...gb(t.slice(r+1))]}function bb(t,e){return t.reduce((r,i)=>r.concat(...A(e(i))),[])}function xb(t,e){return t.length>e&&t.splice(0,t.length-e),t}function wb(t,e){return t.length=Math.min(t.length,e),t}function Vn(...t){let e=Math.max(...t.map(r=>r.length));return ce(e,r=>t.map(i=>i[r]))}function Tb(...t){let e=Math.max(...t.map(i=>i.length)),r=[];return ce(e,i=>t.map(o=>r.push(o[i]))),r}function Mb(t){return ce(t.length,e=>t.slice(0,e+1))}function dp(t){return fu(t,e=>e.valueOf())}function pu(t){return t[vb(t)]}function vb(t){return Sb(t,e=>e.valueOf())}function fu(t,e){return Pb(t,e,(r,i)=>eo(r,i))}function Sb(t,e){return Pb(t,e,(r,i)=>Fs(r,i))}function co(t,e){return t[fu(t,e)]}function et(t,e){return t[Sb(t,e)]}function Pb(t,e,r){if(L(t))return-1;let i=-1,o;for(let n=0;n<t.length;n++){let s=t[n];if(s!=null){let a=e(s);a!=null&&(o==null||r(a,o)===!0)&&(i=n,o=a)}}return i}function Ws(t,e){return e<=0&&(e=1),Rn(0,t.length,e,r=>t.slice(r,r+e))}function lt(t){return Eb(t,!0)}function Fi(t){return Eb(t,!1)}function Eb(t,e){return new Promise(r=>{if(t<=0)r();else{let i=setTimeout(()=>r(),Math.ceil(t+.5));e&&i.unref!=null&&xe(i.unref)&&i.unref()}})}function W(t,e=1){return setTimeout(t,Math.max(1,Math.ceil(e)))}async function x(t,e){let r=await t;return r==null?void 0:e(r)}async function le(t,e){let r=[];for(let i of F(await t))if(i!=null){let o=await i;if(o!=null){let n=await e(o);n!=null&&r.push(n)}}return r}async function Db(t,e=console.dir.bind(console)){let r=await t;return await e(r),r}var jF=require("he"),ml={};function zn(t,e){if(e<1)return"";for(ml[t]==null&&(ml[t]=t);e>ml[t].length;)ml[t]+=t;return ml[t].substring(0,e)}function rr(t,e,r){if(r.length===0)throw new Error("leftPad() given empty pad");if(typeof t=="number"&&t<0)return"-"+rr(String(-t),e-1,r);let i=String(t);return zn(r,e-i.length)+i}function Ab(t,e,r){if(r.length===0)throw new Error("rightPad() given empty pad");let i=String(t);return i+zn(r,e-i.length)}function Rt(t){return rr(t,2,"0")}function Fb(t,e,r,i){return t.substr(0,e)+zn(i,r)+t.substr(e+r)}function jo(t,e,r){let i=Math.min(Math.ceil(t.length/e),M(r,()=>t.length))-1;return i<=0?[t]:[...ce(i,o=>t.slice(o*e,(o+1)*e)),t.slice(i*e)]}function mi(t,e){let r=e.exec(t);if(r==null||r[1]==null)return;let i=r[0].indexOf(r[1])+r.index;return{captured:r[1],uncaptured:t.substring(0,i)+t.substring(i+r[1].length),unmatched:t.substring(0,r.index)+t.substring(r.index+r[0].length),matchedIndex:i}}function Qe(t,e){let r=g(t),i=g(e);return i.length>0&&r.startsWith(i)?r.slice(i.length):r}function du(t,e){return t=g(t),e=g(e),Lb(t,e)?t.slice(e.length):t}function ir(t,e){if(e==null)return t;let r=g(t),i=g(e);return i.length>0&&r.endsWith(i)?r.slice(0,-i.length):r}function Ib(t,e,r){return e==null?ir(t,r):(t=g(t),t.endsWith(r)&&t.startsWith(e)?t.slice(e.length,-r.length):t)}function Ob(t,e=80,r=80){let i=g(t),o=i.length-(e+r);return o<=0?i:i.slice(0,e).trim()+" \u2026(+"+o+" chars)\u2026"+i.slice(-r).trim()}function Ho(t){t=g(t);let e=t.normalize().split("");return T(t)?t:e[0].toLocaleUpperCase()+e.slice(1).join("")}function hp(t,e){return t.localeCompare(e,void 0,{sensitivity:"base"})}function Oe(t,e){if(t==null||e==null)return!1;let r=g(t),i=g(e);return r.length!==i.length?!1:r===i||r.toLowerCase()===i.toLowerCase()?!0:r.localeCompare(i,void 0,{sensitivity:"base"})===0||hp(r.normalize(),i.normalize())===0}function kb(t){return Jm(t,Oe)}function gp(t){return t.sort(hp)}function Rb(t,e){return F(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:f(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>{let o=hp(r.cmp[0],i.cmp[0]);return o!==0?o:Xt(r.cmp[1],i.cmp[1])}).map(r=>r.item)}function Lb(t,e){return t==null||e==null||e.length===0||t.length===0?!1:Oe(t.substring(0,e.length),e)}function _b(t,e){if(L(t)||T(e))return;for(let i of t)if(Oe(i,e))return{index:0,match:i};for(let i of t){let o=e.indexOf(i);if(o>=0)return{index:o,match:i}}let r=e.normalize();for(let i of t){{let n=r.indexOf(i);if(n>=0)return{index:n,match:i}}let o=i.normalize();{let n=r.indexOf(o);if(n>=0)return{index:n,match:o}}{let n=r.toLocaleLowerCase(),s=o.toLocaleLowerCase(),a=n.indexOf(s);if(a>=0)return{index:a,match:s}}}}function _t(t,e){return L(t)||T(e)?!1:t.some(r=>Oe(e,r))}function Un(t){return g(t).replace(/\u001b\[[0-9;]+[a-z]/gi,"")}var HF=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function yp(t){return HF.reduce((e,[r,i])=>e.replace(r,i),t).normalize()}var GF=/^(['"]).+\1$/;function bp(t){return T(t)||(t=g(t).trim(),GF.exec(yp(t))!=null&&(t=t.slice(1,-1).trim())),t}function Nb(t){return t.split(/(?<=[\\/_,:=-]+)/).map(e=>jF.escape(e.normalize())).join("<wbr>")}function xp(t){return g(t).normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function Bb(t){return g(t).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")}function Cb(t){let e=gp(R(t)),r=e.filter((i,o)=>!Lb(e[o+1],i));return $(r,i=>t.indexOf(i))}function ui(...t){for(let e of t){let r=e();if(r!=null)return r}}function Vb(t,e){for(let r of t){let i=r();if(i!=null&&(e==null||e(i)))return i}}function dt(t,e){try{return t()}catch(r){return e!=null?e(r):void 0}}function Ar(t){return t}function js(t,e){if(e==null)return t;for(let[r,i]of ze(e))i!=null&&(t[r]=i);return t}function hu(t,e){let r={};for(let i of nt(t)){let o=e(i,t[i]);o!=null&&(r[i]=o)}return r}function zb(t,e){return t==null?!1:nt(t).every(r=>$e(t[r],e[r]))}function fo(t,e){if(e==null||t==null||T(e))return t;if(Array.isArray(t))return A(t.map(a=>fo(a,e)));let r=e.indexOf("."),i=r<0?e:e.slice(0,r),o=r<0?void 0:e.slice(r+1),n=nt(t);if(n.includes(i))return fo(t[i],o);let s=n.find(a=>Oe(a,i));if(s!=null)return fo(t[s],o)}var Gt=class{constructor(e){this.id=e;this._state="pending";this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i})}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve(),r=>this.reject(r)),this}observeQuietly(e){return e.then(()=>this.resolve(),()=>this.resolve()),this}get pending(){return this._state==="pending"}get settled(){return!this.pending}get resolved(){return this._state==="resolved"}get rejected(){return this._state==="rejected"}get state(){return this._state}then(e,r){return this.promise.then(e,r)}};var Qb=S(require("util"));var ul=class{constructor(e){this.maxLength=e;this._length=0;this._firstIndex=0;if(e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...ce(e,()=>null))}mapIndex(e,r){return e=Math.trunc(e)??0,e<0&&(e+=this._length),e<0||e>this._length-1?void 0:r((e+this._firstIndex+this.maxLength)%this.maxLength)}item(e){return this.mapIndex(e,r=>this.store[r])}set(e,r){return this.mapIndex(e,i=>this.store[i]=r)}get length(){return this._length}set length(e){this._length=Z(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){let e=this;function*r(){for(let i=0;i<e.length;i++)yield e.mapIndex(i,o=>e.store[o])}return r()}push(...e){for(let r of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,i=>{this.store[i]=r});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(let r of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,i=>{this.store[i]=r,this._firstIndex=i});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}shiftOrFirst(){return this.length>1?this.shift():this.item(0)}every(e){for(let r=0;r<this._length;r++)if(!e(this.item(r),r))return!1;return!0}some(e){for(let r=0;r<this._length;r++)if(e(this.item(r),r))return!0;return!1}forEach(e){for(let r=0;r<this._length;r++)e(this.item(r),r)}map(e){let r=[];for(let i=0;i<this._length;i++)r.push(e(this.item(i),i));return r}reduce(e,r){let i=r;for(let o=0;o<this._length;o++)i=e(i,this.item(o),o);return i}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,r=>{this.mapIndex(this._length-1-e,i=>{let o=this.store[i];this.store[i]=this.store[r],this.store[r]=o})});return this}toA(){return[...this]}slice(e,r){return[...this].slice(e,r)}};var qn=class{constructor(){this.m=new Map}incr(e,r=1){let i=this.get(e)+r;return i===0?this.m.delete(e):this.m.set(e,i),this}get(e){return M(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){let e=new or(0);for(let r of this.keys())if(re(r))e.push(r);else return;return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){let e=this.keyAvg();return $([...this.entries()],([r,i])=>[-i,tp(e,o=>Math.abs(r-o),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(r=>r[0])}get averageCounts(){return vt(new or(this.size),e=>[...this.m.values()].forEach(r=>e.push(r)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return tr([...this.keys()]).map(e=>e+" "+this.get(e)).join(`
`)}};function Ub(...t){return t.find(N)}function wp(...t){for(let e of Y(t)){let r=Wr(e);if(r!=null&&r!==0)return r}}function Go(t,e){return ks(t,r=>r>=0?e(r):void 0)}function Hs(t,e){return Si(t,r=>r>=0?e(r):void 0)}function ge(t,e){return ks(t,r=>r>0?e(r):void 0)}function Wn(t,e,r){return M(ge(t,e),r)}function ht(t,e,r){return r==null||!re(r)?!1:([t,e]=[Math.min(t,e),Math.max(t,e)],qr(r,t)&&ro(r,e))}var KF=/[+-]?[0-9\,\.]+/;function jn(t){if(re(t))return t;if(T(t))return;let e=String(t);return f(KF.exec(e),r=>Wr(e.substr(r.index)))}function gu(t){return H(jn(t))}function qb(t){if(re(t))return t;let e=g(t);if(e.includes("/")){let r=e.split("/",2);return zo(gu(r[0]),gu(r[1]),(i,o)=>i/o)}else return jn(e)}function Wb(t,e){if(t===e)return 1;if(t.length!==e.length)throw new Error(`hammRatioBinaryString(${t}, ${e}): invalid lengths`);let r=0;for(let i=0;i<t.length;i++)t[i]===e[i]&&r++;return Z(0,1,2*r/t.length-1)}function jb(t){return t instanceof Set?t:new Set(F(t))}function yu(t,e){return new Set([...t,...e])}function Tp(t,e){let r=jb(e);return new Set([...t].filter(i=>r.has(i)))}function Hb(t,e){let r=jb(e);return new Set([...t].filter(i=>!r.has(i)))}function Gb(t){let e;for(let r of t)r!=null&&(e==null||r<e)&&(e=r);return e}function Kb(t){let e;for(let r of t)r!=null&&(e==null||r>e)&&(e=r);return e}function Mp(t,e){let r=new qn;return F(t).forEach(i=>tl(i,o=>r.incr(o))),r.topKeys(e)}function vp(t){return Mp(t,1)[0]}function Ko(t){return F(t).reduce((e,r)=>re(r)?e+r:e,0)}function St(t){let e=A(F(t));return L(e)?void 0:e.reduce((r,i,o)=>o===0?i:r*o/(o+1)+i/(o+1),0)}function Jb(t){let e=F(t);return f(St(e),r=>{let i=(e.length-1)/2,o=Ko(e.map((s,a)=>(s-r)*(a-i))),n=Ko(e.map(s=>(s-r)**2));return n===0?0:o/n})}function JF(t){return f(St(t),e=>St(t.map(r=>Math.pow(r-e,2))))}function $b(t){return f(JF(t),e=>Math.sqrt(e))}function cl(t){let e;for(let r of t)e=e==null?r:(e+r)/2;return e??NaN}function Sp(t,e){let r=0;return t.reduce((i,o,n)=>{let s=Wn(e[n],a=>a,1);return r+=s,i+o*s},0)/r}var or=class{constructor(e=20){this.maxSamples=e;this._n=0,this._samples=new ul(e)}static merge(e,r){if(e.n===0&&r.n===0)return new or(Math.max(e.maxSamples,r.maxSamples));if(e.n===0)return r.clone();if(r.n===0)return e.clone();if(e.n<=e.maxSamples){let i=r.clone();return i.pushAll(e.samples),i}else if(r.n<=r.maxSamples){let i=e.clone();return i.pushAll(r.samples),i}else{let i=new or(Math.max(e.maxSamples,r.maxSamples));i._n=e.n+r.n,i._avg=e._avg*e.n/i.n+r._avg*r.n/i.n,i._min=Math.min(e._min,r._min),i._max=Math.max(e._max,r._max),i._m=e._m*e.n/i.n+r._m*r.n/i.n,i._s=e._s*e.n/i.n+r._s*r.n/i.n;let o=Y(Vn(e.samples,r.samples));return i._samples.push(...o),i._weightedTotalAvg=cl([i._avg,...o]),i}}[Qb.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=this._min==null?e:Math.min(e,this._min),this._max=this._max==null?e:Math.max(e,this._max),this._n===1||this._m==null||this._s==null||this._avg==null||this._weightedTotalAvg==null)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{let r=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-r)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return vt(new or(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){return e.forEach(r=>this.push(r)),this}stats(e=2){let r=o=>f(o,n=>Be(n,e)),i={};return this.empty||(i.sum=r(this.sum),i.mean=r(this.avg),i.sd=r(this.stdDev)),i.k=Be(this.n,e),i}get empty(){return this._n===0}get n(){return this._n}get avg(){return this.empty?void 0:Be(this._avg,4)}get sum(){return this._avg==null||this.empty?0:this._avg*this._n}get max(){return this._max}get min(){return this._min}get p84(){return ge(this.avg,e=>ge(this.stdDev,r=>e+r))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return f(this.variance,Math.sqrt)}get sampleMode(){return f(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;let r=new qn;return this._samples.forEach(i=>r.incr(i)),r.topKeys(e)}get sampleStdDev(){return Ae(this._samples,$b)}get sampleAvg(){return Ae(this._samples,St)}get sampleSlope(){return M(Ae(this._samples,Jb),0)}get samples(){return[...this._samples]}p(e){if(this._samples.length===0)return 0;let r=[...this._samples].sort((o,n)=>o-n),i=Math.floor(r.length*(e/100));return r[i]}get weightedSampleAvg(){return Ae(this._samples,e=>Be(cl(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}};var Ks=S(require("os"));var Xb=S(require("events"));var Yb=S(require("events")),Pp=class extends Yb.EventEmitter{constructor(){super(...arguments);this.events=[]}emit(e,...r){return super.emit(e,...r),this.events.push({name:e,args:r}),!0}clear(){this.events.length=0}};var Hq=l(()=>new Pp),$F=l(()=>{let t=new Xb.EventEmitter;return t.setMaxListeners(50),t}),Ue=$F();function j(t){Ue.on("clearCache",t)}function Zb(t){Ue.emit("migration",t)}function ex(t){Ue.on("pause",t)}function tx(t){Ue.on("resume",t)}function Fr(t){Ue.emit("fileChanged",t)}function Gs(t){Ue.on("fileCopied",t)}function Ep(t,e){Ue.emit("fileCopied",t,e)}function Kt(t){Ue.on("fileChanged",t)}function rx(t){Ue.on("nonFatal",({message:e,error:r})=>t(e,r))}function ix(){Ue.emit("volumesChanged")}function ox(t){Ue.on("volumesChanged",t)}function nx(){Ue.emit("settingsChanged")}function sx(t){Ue.on("settingsChanged",t)}function ax(t){Ue.on("vacuuming",t)}W(()=>{j(()=>{Dp.unset(),Ap.unset(),Ft.unset(),lx.unset(),fl.unset(),pl.unset(),QF.unset()})});var Dp=l(()=>((0,Ks.freemem)()*2+(0,Ks.totalmem)())/3),Ap=l(()=>(0,Ks.cpus)().length),Ft=l(()=>{let t=1*uo,e=Math.max(1,Math.floor(Dp()/t)),r=u.cpuLoadPercent.valueOrDefault/100*Ap();return Z(1,e,Math.floor(r))}),lx=l(()=>{let t=500*Ge,e=Math.floor(Dp()/t),r=Math.max(1,Math.floor(1.5*Ap()*(u.cpuLoadPercent.valueOrDefault/100)));return Z(1,r,e)}),fl=l(()=>Z(1,24,Ft())),pl=l(()=>Z(1,6,Math.ceil(lx()/fl()))),QF=fl;var Ip=S(require("timers")),px=S(require("util"));function Se(t){if(Os(t))return"";let e=t instanceof Error?z(_s([g(t.name).trim(),U(t.code,r=>`code ${r.trim()}`),g(t.message).trim()])).join(": "):g(t);return dr(e,255)}function ci(t){return t==null?"(undefined)":[Se(t),...F(Fp(t.stack))].join(`
`)}function Fp(t){return T(t)?void 0:g(t).split(`
`).slice(0,6)}function bu(t){if(T(t))throw new Error("undefined error");if(t instanceof Error)return t;if(Array.isArray(t)){let e=t[0];return e instanceof Error?(t.length>1&&(e.errors=t.slice(1)),e):new Error(t.map(r=>g(r)).filter(v).join(", "))}else{let e=Se(t),r=e.indexOf(":");if(r>2&&r<15){let i=new Error(e.slice(r+1).trim());return i.name=e.slice(0,r).trim(),i}else return new Error(e)}}function xu(t){return t instanceof Error}var po=he("pending","resolved","rejected");var ye="\xB9",Nt="\xB2",dl="\xB3",wu="\u2074",hl="\u2075",ho="\u2076",Js="\u2077",YF=[ye,Nt,dl,wu,hl,ho,Js];function mx(t,...e){return t+e.filter(r=>r!=null&&!t.includes(r)).join("")}var XF=/[â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g;function Tu(t){return t.replace(XF,"")}function ux(t){return t.split("").filter(e=>YF.includes(e)).join("")}function ZF(t){return Se(t).includes(wu)}var eL=[dl,"0 output files created","BatchCluster has ended, cannot enqueue","called while not idle","Can't set headers after they are sent","debugger attached","debugger listening on","diskutil: interrupted","ECONNRESET","end() called before task completed","EPIPE","for help","Format error in file","https://nodejs.org/en/docs/inspector","Invalid data found when processing input","Missing expected status message","net::ERR_","onExit(exit) called end()","This socket has been ended by the other party","Unexpected error while trimming","Warning"].map(t=>t.toLowerCase());function nr(t){if(t==null)return!0;let e=Se(t).toLowerCase(),r=eL.some(i=>e.includes(i));return me()||!ZF(t)&&!Li(t)&&r}var tL=/SQLITE_BUSY|database is locked/i;function gl(t){return t.code==="SQLITE_BUSY"||Se(t).match(tL)!=null}function cx(t){return Se(t).match(/database .+ not open/i)!=null}function rL(t){return Se(t).match(/SQLITE_CONSTRAINT|constraint failed/i)!=null}function Lp(t){return!Li(t)&&!Se(t).includes(Nt)&&!rL(t)&&!Pr(t.retriable)}function fx(t){return!Lp(t)}var iL=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+ye,"i");function Li(t){return t==null?!1:B(t.fatal)?!0:iL.exec(Se(t))!=null}var Mu=S(require("timers"));function $s(t,e,...r){return vt((0,Mu.setTimeout)(t,Math.round(e),...r),i=>i.unref())}function jr(t,e,...r){return vt((0,Mu.setInterval)(t,Math.round(e),...r),i=>i.unref())}var gr=class{constructor(e){this.name=e;this.start=Date.now();this.state=po.pending;this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i}),this.logger=h("Deferred("+this.toString()+")")}toString(){return ct(this.name)?this.name:k(this.name)}[px.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(r=>{this.resolve(r)}).catch(r=>{this.logger.warn("observeQuietly.reject()",r),this.resolve(void 0)}),this}observe(e){return e.then(r=>{this.maybeResolve(r)}).catch(r=>{this.maybeReject(r)}),this}setTimeout(e){return f(this.priorTimeout,Ip.clearTimeout),this.priorTimeout=$s(()=>{if(this.pending){let r="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(r)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===po.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==po.pending}get resolved(){return this.state===po.resolved}get rejected(){return this.state===po.rejected}get settledMs(){return this.end==null?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=po.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(nr(e)?"info":"warn",".reject()",e);let r=bu(e);return this.settle(()=>{this._error=r,this.state=po.rejected,this._reject(r)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(r=>e(r))}settle(e){if(this.state===po.pending){f(this.priorTimeout,Ip.clearTimeout),e(),this.end=Date.now();let r=this.settledMs;if(this.resolved&&r>5e3){let i=r>5e3?"info":"debug";this.logger.log(i,"Completed in "+r+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}};var Ii=class{constructor(){this._pushCount=0;this.lastPushTs=0;this._arr=[];this.nextSettledLatches=[];this.serialLatencyAvg=new or;this.applyListeners=[]}get arr(){return ft(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}onApply(e){this.applyListeners.push(e)}_emitApply(e){for(let r of this.applyListeners)r(e)}push(e,r){return this._emitApply(e),this._push(e,r)}_push(e,r){this._pushCount++,this.lastPushTs=Date.now();let i=xe(r)?r():r;return this.arr.push(new gr(e).observeQuietly(i).finally(()=>this.emitSettled())),i}emitSettled(){for(let e of this.nextSettledLatches)e.resolve();this.nextSettledLatches.length=0}awaitNextSettled(){let e=new Gt;return this.nextSettledLatches.push(e),e}serial(e,r){let i=Date.now();return this._push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}serialByName(e,r){let i=Date.now();return this._push(e,this.awaitAllByName(e).then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}oneRunAtATime(e,r){return this.pending?this.awaitAll():this.serial(e,r)}maybeRun(e,r){return this.maybeRunConcurrent(e,r,1)}maybeRunConcurrent(e,r,i=Ft()){return this.pendingCount>=i?void 0:this.push(e,r)}get pendingCount(){return Sr(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return this.arr.length===0}async awaitAll(){for(let e of[...this.arr])await e.promise}async awaitAllByName(e){for(let r of[...this.arr])r.name===e&&await r.promise}async pushAll({name:e,laters:r,maxConcurrent:i=Ft()}){i=Z(1,Ft()*2,i);let o=[];for(let n of r){for(;this.pendingCount>=i;)await this.awaitNextSettled();o.push(this.push(e,n))}return Promise.all(o)}};async function Jo({name:t,laters:e,maxConcurrent:r}){return new Ii().pushAll({name:t,laters:e,maxConcurrent:r})}async function dx(t){let e=await t;return xe(e)?e():e}async function ke(t,e,r=()=>{},i=()=>{}){let o=!1,n=!1,s;return await Promise.race([dx(t).then(a=>{if(!n)return s=a,o=!0,a}),lt(e).then(()=>{o||(n=!0)})]),o?await i(s):await r(),s}async function hx(t,e,r){let i=[];for(let o of Ws(F(await t),e)){let n=[];for(let s of o)if(s!=null){let a=await s;a!=null&&n.push(a)}for(let s of F(await r(n)))s!=null&&i.push(s)}return i}function gx(t,e){return Promise.race([t.then(()=>!0),lt(e).then(()=>!1)]).catch(()=>!1)}async function Op(t){try{return await t,!0}catch(e){return!1}}async function yx(t){return await t!=null}async function vu(t){let e=A(t);C(e)&&await Promise.all(e)}async function yl(t){let e=[];for(let r of F(await t)){let i=await r;if(i!=null)if(Array.isArray(i))for(let o of i){let n=await o;n!=null&&e.push(n)}else e.push(i)}return e}async function Hn(t){let e=A(await t);return L(e)?[]:A(await Promise.all(e))}async function Qs(t,e,r){if(t==null)return[];let i=A(await t);return L(i)?[]:(await Jo({name:"thenCollectParallel",laters:i.map((n,s)=>async()=>[await e(n,s),n]),maxConcurrent:r})).filter(([n,s])=>n!=null&&s!=null)}async function sr(t,e,r){return(await Qs(t,e,r)).map(i=>i[0])}async function Oi(t,e,r){return(await Qs(A(t),e,r)).filter(([o])=>o).map(([,o])=>o)}var XW=30*E;async function gt(t,e=!0){if(t==null)return e;let r=await t;return r==null?e:!B(r)}async function pe(t,e,r){let i=await t;if(i==null)return r();let o=await e(i);return o??r()}async function Ys(t,e,r,i){let o=await t;if(o==null)return i();let n=await e;if(n==null)return i();let s=await r(o,n);return s??i()}async function Re(t,e){return M(await t,e)}async function bx(t,e){for(let r of t)try{let i=await r();if(i!=null)return i}catch(i){e(i)}}async function bl(t,e){return $(await Qs(t,e),r=>r[0]).map(r=>r[1])}var xx=S(require("fs")),xl=S(require("os")),go=S(require("process"));var wl=(0,xl.platform)(),s3=go.default.argv.includes("--inspect")||B(go.default.env.NODE_INSPECT),wx=!g(__filename).includes("Platform"),I=wl==="win32"||wl==="cygwin",Tx=I&&v(go.default.env.PORTABLE_EXECUTABLE_DIR),ae=wl==="darwin",tt=wl==="linux",a3=tt&&(0,xl.arch)()==="x64",kp=(0,xl.arch)()==="arm",oL=tt&&kp,l3=tt&&(v(go.default.env.APPIMAGE)||v(go.default.env.APPDIR)),m3=tt&&v(go.default.env.SNAP_USER_DATA),Xs=ae||tt,nL="PS_IS_ELECTRON",sL="PS_IS_DOCKER",fi=go.default.versions.electron!=null||B(go.default.env[nL]);function Ce(){return tt&&(ao(sL)||ao("PS_DOCKER"))}var u3=l(()=>oL&&g(Rp()).startsWith("Raspberry Pi")),Rp=l(()=>{try{return tt?f((0,xx.readFileSync)("/proc/device-tree/model"),g):void 0}catch{return}}),Mx=I?"win":ae?"mac":tt?"linux":wl;var ar=15*E,Gn=5*D,G=35*E,yr=7*E,vx=1*At,Su=E/(2*Ai);var Zs=25*E;var ea=S(require("stream")),Sx=S(require("util"));async function ki(t){t!=null&&(dt(()=>iu(t,"unref")),me()?t.end(null):await new Promise(e=>t.end(null,e)),await lt(50),dt(()=>iu(t,"destroy")))}async function Px(t){t!=null&&(dt(()=>iu(t,"unref")),me()?t.close(Za):await new Promise(e=>t.close(e)))}function Ex(t){for(let e of[t?.stdin,t?.stdout,t?.stderr])try{e?.destroy()}catch{}}var Kn=(0,Sx.promisify)(ea.pipeline);function ta(t){return t.destroyed?"destroyed":`${t.remoteFamily}:${t.remoteAddress}:${t.remotePort}`}var _p=class extends ea.Transform{constructor(e){super({transform:(r,i,o)=>{this.onProgress(this.bytes+=r.length),o(r)}});this.onProgress=e;this.bytes=0}};var Ml=Bt.default.posix;function aL(t,e){if(T(t)||Bt.default.sep===Ml.sep)return t;let r=v(e)?Bt.default.sep+Bt.default.sep+e+Bt.default.sep:"",i=t.split(Ml.sep);return Oe(i[0],e)&&i.unshift(),r+i.join(Bt.default.sep)}function Hr(t){return T(t)||Bt.default.sep===Ml.sep||Ml.sep===Bt.default.sep?t:t.split(Bt.default.sep).join(Ml.sep)}var Ax=/^([A-Z]:)[\\/]?(.*)$/i;function lL(t){let e=Ax.exec(t);return e!=null?e[1].toUpperCase()+"\\"+e[2]:t}function Gr(...t){let e=Bt.default.join(...t);return Bt.default.resolve(I?lL(e):e)}function Fx(t){return pi(aL(t))}function Lx(t){return pi(t).ext}var mL=/(\.(?:gz|z|7z|xz|bz2))$/i;function pi(t){let e=mi(t,mL),r=Bt.default.parse(M(e?.uncaptured,t));return w(w({},r),e==null?{}:{ext:r.ext+e.captured,base:r.base+e.captured})}function ia(t,e){return v(t)&&v(e)&&(t===e||t.startsWith(Ht(e,Bt.default.sep)))}function $o(t){return Qe(t,Bt.default.sep).split(Bt.default.sep)}function Pu(t,e){return t.nativePath===e.nativePath?"":Qe(Hr(e.nativePath),Ht(Hr(t.nativePath),"/"))}var Ix=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function Ri(t){return J(g(t).match(Ix),e=>e[1],()=>t).toLowerCase().normalize()}function Ox(t){return f(g(t).match(Ix),e=>Ke([e[2],e[3]],H))}function oa(t){if(T(t))return!1;try{return ra.default.statSync(t).isDirectory()}catch{return!1}}async function vl(t){if(!T(t))try{return await ke(Tl.default.stat(t),ar)}catch{return}}async function kx(t){return pe(vl(t),e=>e.isDirectory(),()=>!1)}async function Rx(t){if(T(t))return!1;try{return await vl(t)!=null}catch{return!1}}async function Qo(t,e=Zs){if(T(t))return!1;try{let r=await ke(vl(t),e);return r==null||!r.isDirectory()?!1:await gx(Tl.default.access(t,ra.default.constants.R_OK|(I?0:ra.default.constants.X_OK)),e)}catch{return!1}}function Np(t){return t.startsWith("\\\\")}function _x(t){return Xs&&t.startsWith("/")||I&&(Np(t)||t.match(Ax)!=null)}var uL=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});function Nx(t){return t==null||t.isFile()&&t.size===0}async function Eu(t){let e=w(w({},uL),t),r=pi(e.nativePath);await Tl.default.mkdirp(r.dir);{let i=await vl(e.nativePath);if(!e.requireNumber&&(i==null||e.emptyIsNew&&Nx(i)))return e.nativePath}for(let i=e.startIndex;i<=e.maxVersions;i++){let o=Bt.default.join(r.dir,`${r.name}-${rr(i,e.leftPad,"0")}${r.ext}`),n=await vl(o);if(n==null||e.emptyIsNew&&Nx(n))return o}throw new Error("There are already more than "+e.maxVersions+" of "+e.nativePath)}async function Bx(t){if(t.endsWith(".gz"))return t;let e=t+".gz";return await Kn([ra.default.createReadStream(t),(0,Dx.createGzip)(),ra.default.createWriteStream(e)]),await Tl.default.unlink(t),e}var Cx=S(require("os")),Vx=S(require("path"));var di=l(()=>{let t=[];I?t.push(He("USERPROFILE")):t.push(He("HOME"));for(let e of R(t)){let r=(0,Vx.resolve)(e);if(oa(r))return r}return(0,Cx.homedir)()});function Bp(){if(Ce()&&oa("/ps/cache"))return"/ps/cache";if(I){for(let t of R([He("TEMP"),He("LOCALAPPDATA")]))if(oa(t))return Gr(t,mo())}if(ae){let t=Gr(di(),"Library","Caches");if(oa(t))return Gr(t,mo())}return Gr(di(),".cache",mo().toLowerCase())}var Cp=S(require("path"));var zx=S(require("fs")),Ux=S(require("fs-extra")),Du=S(require("path")),qx=S(require("process"));var na=l(()=>{let t=[qx.env.PS_CONFIG_DIR,Ce()?"/ps/config":void 0];I&&(t.push(He("APPDATA")),t.push((0,Du.resolve)(di(),"AppData","Roaming"))),ae&&t.push((0,Du.resolve)(di(),"Library","Application Support")),!ae&&Xs&&t.push(He("XDG_DATA_HOME"),He("XDG_CONFIG_HOME"),(0,Du.resolve)(di(),".config"));let e=R(t);for(let r of e)try{if((0,zx.statSync)(r).isDirectory())return r}catch{}for(let r of e)try{return(0,Ux.mkdirpSync)(r),r}catch{console.error("Failed to mkdirp "+r)}throw new Error("Cannot determine appData"+ye)});function Wx(){return Ce()?"/ps/logs":ae?(0,Cp.resolve)(di(),"Library","Logs",lo.toLowerCase()):cL()}function cL(){return(0,Cp.resolve)(na(),lo.toLowerCase(),"logs")}var Lt="1.0.0-alpha.1";var Vp=new Date(1615764034e3);var fL=()=>Lt.includes("-alpha"),pL=()=>Lt.includes("-beta"),jx=()=>fL()?"alpha":pL()?"beta":"latest";var gT=S(require("path"));var Ju=S(require("batch-cluster"));async function Au(t,{timeoutMs:e,timeBetweenMs:r,acceptable:i,timeoutResult:o,unref:n}){let s=e==null?void 0:e+Date.now();for(;s==null||Date.now()<s;){let a=Date.now(),m=await t();if(m==null||(xe(i)?!i(m):m===!1)){let c=Date.now()-a,p=M(r,()=>Z(100,5e3,c*er(4,10)));await(Pr(n)?Fi(p):lt(p))}else return m}return o}async function yt(t,e){return Au(t,w(w({},e),{acceptable:r=>B(r),timeoutResult:!1}))}var mT=S(require("process"));var Pt=class{constructor(e,r,i,o,n){this.name=e;this._isEnded=o;this.endTimeoutMs=n;this.onEnds=[];this._ended=!1;this.logger=h(e),this.onEnds.push(r),Jn(i,this)}get ended(){return J(this._isEnded,e=>e(),()=>!1)||this._ended}end(){if(!this._ended)return this._ended=!0,vu(this.onEnds.map(e=>e()))}};var hd=S(require("child_process")),gd=S(require("process"));async function sa(t,e){let r;return Promise.race([t().then(i=>{if(r==null)return r=!0,i}),lt(e).then(()=>{if(r==null)throw r=!1,new Error("timeout")})])}function Kr(t,e){let r=N(e.timeoutMs)?()=>sa(t,e.timeoutMs):t;if(e.maxRetries<=0)return r();let i=V(e.onRetryWaitUntil).getOrElse(()=>s=>lt((e.retryDelay??250)*M(s,1))),o=0,n=async()=>{try{return await r()}catch(s){if(await e.errorIsRetriable?.(s)===!1||o>e.maxRetries)throw s;return o++,await i(o),n()}};return n()}var Hx=S(require("util"));var zp=class{constructor(e,r){this.ttlMs=e;this.maxLength=r;this.times=[];this.a=[]}[Symbol.iterator](){this.vacuum();let e=[...this.a];function*r(){for(let i of e)yield i}return r()}push(...e){ce(e.length,()=>this.times.push(Date.now())),this.a.push(...e),this.maxLength!=null&&this.vacuum()}pushUniq(...e){e.forEach(r=>{this.includes(r)||this.push(r)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(this.a.length===0)return;if(this.maxLength!=null){let i=this.a.length-this.maxLength;this.times.splice(0,i),this.a.splice(0,i)}let e=Date.now()-this.ttlMs,r=this.times.findIndex(i=>i>e);r===-1?this.clear():r>0&&(this.times.splice(0,r),this.a.splice(0,r))}};var Yo=class{constructor(e){this.ttlMs=e;this._eventCount=0;this._lastEventTime=0;if(e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new zp(e)}[Hx.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){let e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return ge(this.eventDeltas.length,()=>cl(this.eventDeltas))}get msPerEvent(){return St(this.eventDeltas)}get eventsPerMs(){return Hs(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return Hs(this.eventsPerMs,e=>Be(E*e,3))}get eventsPerMinute(){return Hs(this.eventsPerMs,e=>Be(D*e,3))}};function Gx(t){let e=ir(g(t).trim().toUpperCase(),":");return J(dL[e],r=>r.description,()=>t)}var dL=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}});var hL=Date.now(),Fu=l(()=>h("Error")),Kx=new Yo(D),qp=new Yo(D);function Jx(t,e){return e.exec(Se(t))!=null}function gL(){let t=Date.now()>hL+u.probationMs.valueOrDefault,e=rl(qp.eventsPerMinute,u.fatalErrorRatePerMinute.valueOrDefault);return Fu().tap({level:"info",msg:"isFatalErrorAllowed()",result:ai()&&t&&e,meta:{mainService:ai(),postProbation:t,lowErrorRate:e,fatalErrorRatePerMin:qp.eventsPerMinute,errorRatePerMin:Kx.eventsPerMinute,fatalErrorRatePerMinuteSetting:u.fatalErrorRatePerMinute.valueOrDefault}})}function Lu(){let t={};return Error.captureStackTrace(t,Lu),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)}var yL=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function bL(t){let e=Tu(Un(t)),r=e;do r=e,e=yL.reduce((i,o)=>i.replace(o,""),e).trim();while(r!==e);return R(e.split(/\s+/).map(i=>{if(i.startsWith("E")){let o=Gx(i);return e.toLowerCase().includes(o.toLowerCase())?"":o+":"}return i})).join(" ")}function hi(t,e=256){let r=Se(t),i=ux(r);return dr(bL(r),e-i.length)+i}function $x(t,e){return g(t).split(/\r?\n/).map(r=>Qe(r,e)).map(r=>r.replace(/: ?/,"")).filter(v).join(", ")}function se(t,e,r){if(T(t)&&e==null){Fu().warn("onError() with empty args",Lu());return}let i=Se(t)+Se(e)+Se(r),o=Li(e)||Li(i)||B(r?.fatal);if(!o&&nr(i)){Fu().info("onError(): (ignorable): "+ci(e),w({message:t},r));return}f(Up(),s=>s.writeRecentLogEntries()),Kx.onEvent(),o&&qp.onEvent();let n=!o||gL()?"nonFatal":"fatal";Fu().log(n==="fatal"?"error":"warn","onError(): "+ci(e),w({event:n,message:t},M(r,{}))),me()||Ue.emit(n,{message:t,error:e})}var jw=S(require("child_process")),kl=S(require("process"));var Qx=S(require("util"));function aa(t){return t==null?[]:Object.keys(t)}var _e=class{constructor(e,r){this.maxSize=e;this.clearEveryMs=r;this.setsSinceLastSpill=0;this.expireListeners=[];if(e<1)throw new Error("maxSize must be positive");if(e>3e4)throw new Error("maxSize is too big");this.clear(),N(r)&&(this.clearInterval=jr(()=>{this.spill()},Ze(r/2)))}spill(){if(this.priorCache!=null&&this.currentCache!=null&&C(this.expireListeners)){for(let e in this.priorCache)if(this.currentCache[e]==null){let r=this.priorCache[e];if(r!=null)for(let i of this.expireListeners)i(e,r)}}this.priorCache=this.currentCache??Object.create(null),this.currentCache=Object.create(null),this.setsSinceLastSpill=0}[Qx.inspect.custom](){return w(w({},this.priorCache),this.currentCache)}end(){this.clearInterval!=null&&clearInterval(this.clearInterval)}clear(){return this.visit((e,r)=>{for(let i of this.expireListeners)i(e,r)}),this.currentCache=Object.create(null),this.priorCache=Object.create(null),this.setsSinceLastSpill=0,this}get size(){if(this.currentCache==null||this.priorCache==null)return 0;let e=0;for(let r of yu(aa(this.priorCache),aa(this.currentCache)))this.has(r)&&e++;return e}has(e){return this.currentCache[e]!=null||this.priorCache[e]!=null}keys(){return z([...aa(this.priorCache),...aa(this.currentCache)]).filter(e=>this.currentCache[e]!=null)}delete(e){let r=this.currentCache[e];if(r!=null){this.currentCache[e]=void 0;for(let o of this.expireListeners)o(e,r)}let i=this.priorCache[e];if(i!=null&&(this.priorCache[e]=void 0,r==null))for(let o of this.expireListeners)o(e,i)}visit(e){for(let r of yu(aa(this.priorCache),aa(this.currentCache))){let i=this.currentCache[r]??this.priorCache[r];i!=null&&e(r,i)}}deleteIf(e){for(let r of this.keys()){let i=M(this.currentCache[r],this.priorCache[r]);i!=null&&e(r,i)&&this.delete(r)}}get(e){return e=g(e),this.currentCache[e]??this.priorCache[e]}set(e,r){e=g(e),this.currentCache[e]==null&&(this.setsSinceLastSpill>=this.maxSize&&this.spill(),this.setsSinceLastSpill++),this.currentCache[e]=r}getOrSet(e,r){e=g(e);let i=this.get(e);if(i!=null)return i;let o=r();return this.set(e,o),o}on(e,r){this.expireListeners.push(r)}},_i=class{constructor(e){this.opts=e;this.uid=0;this.cacheSyncHits=0;this.cacheAsyncHits=0;this.cacheMisses=0;this.timeouts=0;this.cache=new _e(e.maxSize,e.clearEveryMs)}get size(){return this.cache.size}stats(){return{size:this.size,cacheSyncHits:this.cacheSyncHits,cacheAsyncHits:this.cacheAsyncHits,cacheMisses:this.cacheMisses,timeouts:this.timeouts}}get(e){let r=this.cache.get(e);return r==null||r.__uid!=null?void 0:r}clear(){this.cache.clear(),this.cacheSyncHits=0,this.cacheAsyncHits=0,this.cacheMisses=0,this.timeouts=0}deleteIf(e){for(let r of this.cache.keys())e(r)&&this.cache.delete(r)}async getOrSetAsync(e,r,i=1){e=g(e);{let a=this.get(e);if(a!=null)return this.cacheSyncHits++,a}let o=this.uid++,n=Date.now(),s=this.cache.getOrSet(e,()=>({__uid:o,__start:n}));if(s.__uid===o)return this.cacheMisses++,ke(r,this.opts.timeoutMs,()=>{this.timeouts++,this.cache.get(e)?.__uid===o&&this.cache.delete(e)},a=>{this.cache.set(e,a)});{let a=s.__start;if(a!=null){let c=a+this.opts.timeoutMs-Date.now();if(c>0){let p=Au(()=>this.get(e),{timeoutMs:c});if(p!=null)return this.cacheAsyncHits++,p}}return i>0?this.getOrSetAsync(e,r,i-1):void 0}}};var br=S(require("fs")),Je=S(require("fs-extra")),sn=S(require("path")),Ew=S(require("util")),Xn=S(require("zlib"));async function Sl(t,e){return t==null||e==null?J(t,A,()=>[]):Oi(t,e)}async function Yx(t,e){return t==null||e==null||await e(t)?t:void 0}var Wp=class{constructor(e,r){this.l=e;this.listener=r;this.ts=Date.now()}elapsed(e){let r=Date.now(),i=r-this.ts;this.ts=r,f(this.listener,o=>o(e,i)),i>2&&this.l.log(i>500?"warn":i>100?"info":"debug",e,{elapsedMs:i})}};async function Jr(t){let e=Date.now(),r=await t();return{elapsedMs:Date.now()-e,result:r}}async function la(t){let e=Date.now(),r=await t;return{elapsedMs:Date.now()-e,result:r}}var xL=15,ma=class{constructor(){this.errors=new qn;this.times=new Map}async time(e,r,i){let o=Date.now();try{let n=await r(),s=Date.now()-o;return i!=null&&i(n,s),this.push(e,s),s>2*E&&h("time("+e+")").warn("slow",{elapsed:s}),n}catch(n){throw this.errors.incr(e),i!=null&&i(n,Date.now()-o),n}}get entriesBySumDesc(){return $([...this.times.entries()],([,e])=>-e.sum)}stats(e){let r=this.entriesBySumDesc.filter(([n])=>n.startsWith(e)),i=r.reduce((n,s)=>or.merge(s[1],n),new or),o=r.map(([n,s])=>[n,s.stats()]);return st([["merged",i.stats()],...o])}mkElapsed(e){return new Wp(e,(r,i)=>this.push(r,i))}push(e,r){r>xL&&Ur(this.times,e,()=>new or).push(r)}weightedAvg(e){return V(this.times.get(e)).map(r=>r.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[r,i])=>w(w({},e),{[r]:i.n}),{})}weightedAvgs(){return oi([...this.times.entries()].reduce((e,[r,i])=>w(w({},e),{[r]:tl(i.weightedSampleAvg,Ze)}),{}))}report(){return this.entriesBySumDesc.reduce((e,[r,i])=>w(w({},e),{[r]:w({sumSec:Be(i.sum/E,3)},kt(i.stats(),"sum"))}),{})}},Xx=l(()=>vt(new ma,t=>new Pt("PromiseTimer",()=>{let e=h("PromiseTimer");e.info(`timings:
`,t.report()),Ae(t.errorCounts(),r=>e.warn(`error counts:
`,r))},be.service)));function Zx(t){return Xx().mkElapsed(h(t))}function mt(t,e,r){return Xx().time(t,e,r)}function ew(t,e,r){return l(async()=>mt(t,e),r)}var aw=S(require("crypto"));var jp=S(require("zlib"));var tw="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function Hp(t){if(typeof t=="number"&&t<tw.length)return tw[t];let e=t.toString(16);return e.length%2==1&&(e="0"+e),Buffer.from(e,"hex").toString("base64")}function rw(t){return BigInt("0x0"+Buffer.from(t,"base64").toString("hex"))}function Iu(t){return(0,jp.gunzipSync)(Buffer.from(t,"base64")).toString("utf8")}var iw=l(()=>Iu("H4sIAAAAAAAAA1WcgZarLM+Fb8ibQkWlInhA2rFX/+8nOPN+/1qnAa1jEUKydxLP0oZPGtxcB3ecg0t5cMXpo+OqflV7bYNrP4P7fofRxWEcP8M4bcPodRynYcx5GNuhT9HnHsZ7HyZXh2lSG69hOtTP6udDn6TPzzC1qI+O72mYdd3s4zCHn2E+dHxNg/dl8CUP/h2Hxa36JH3+Dct8DovfhyUs+qjd9dG9l+scVncNa9Anz/rEYb3PYdPxpv7WXsPLncMrrPp8h1dpw66/3RufQ5+izzXsHzdEjT3q2eJ5DVHjPJY8HKEOR16GpL9P4RxSHvWZhnQdQy7HcLqmzz2cGtOpa0+N6dTznpqbM5/6XMP5rwxnScPZZn2CPvfw71/Qpw3FjfrUoeT3UDTn5e2GOu9D9T9D3YI+11B176rfrf/iUO9luMZjuPR81+camubwPR/DR/f55FWfc/hoHT/VD59rGX5+foY7zMOd2/B1kz778PXr4FyaBxdKGNzLaYmPaUXsEru0IGm5dQU9TZpLTdqQvjo8T/XKgbLoF1wdda6iO5ce2jU05sPf3nxxFy/FKYvEVyoyV+mKv5zEZxzGgCqFVYfh0nXhR708SqXyhEjrMF5c0qK+bRy2S0rlJiexIgqHHynYJg2QeEtIB6atrQidC6eui5qrKXGY0cwcdS6bPp63hLR9KlKRqXHnlhLiGma3ZokjSUfp+SoNDahs2L1EUu8lTZgj5/JUJTxCI53zqUuK9E/iHOZ2jBIay/zWnM63buBnjcr/SCzOo+MFZa8b4ishPVgmKeniJ4SfpfYa38IIFmZtCZqXJejXlqCHWYIecIlSuyWlW3tDPyShS7JUcvVTkJByr/5wEkmH4dTesW+zNGbNWgWJNqwl12FtI0JbcXOvIKHRb67MEh8deqeeH72EHyViRLDv9JNbdkVCa7llT0/zsuWDLw7OFXpSPYldomqrXtrHW+OLj3ZT2D9+CIcWJSRtwhcDfwWpj7awellDe+WQhlfVk7/eWtDdjQhpzu7iKCG12FmoPWXtcBZ+z1rVnYXfWe6dRd5bDcPOekSv4UZ0MvJnMRy3xFu9rEeN3CAypxJNYqEn/YuZS5o2U2x6jsNJ+Q8XEJpnCZkPl7xE1aFviyyKbiWBbXkhos5lbcsj77dE1LmcHGKV0JQcuZrQrdqiixvfMvqjXXVITgNPPHlyxyHxDUPyMpXJaycn/9El/uca0iqlSVljSXX5DKlpoVLTuuWo+cuHliwXXSJxS1x50MLIWPFEp1u9xMtJ7JzTIE+vG0jQi/SSCX3rpSqnL+/h3KTAEv9kGqW7Jw99Bu7Ck59BfucMiUP+NpwmdIMgIy1jKmsaLq7Ttj/ZYGf2WFTN/Zk3bKzm+WRBz1wmBD2twlmCDotMgYTOXZsOm5T1bDtCz3s2bt+qLHe7OLz4Qr/27588zr8WDplljVSa4ofi/SVR6GlfliyjXt7atZVpr04qUCeZoOo1fxKrhGxi3eTAKrapYpskvth0hIxCxepVFL1G3b5G7d96yDTXQ3uhHhwmWZCKblR0rWY5qXrKildNJWJF6It/fpNo+rbwbeEnL0TTqlbsmoR+qGm1apNa1Dvpuq++veQJJKRXl1urhLTuYp9f3snNeL8gvhJ6tsufTUJTfPk2DtemObhYwSuPiBMhj3qVkCWaH65LT3k17vfRgNqY76FFPVY7NNLGZLcqG9HadA5vr4vfq4zRO4xFwpv4DO8sF/bGQL0vjfTDICX24eMv+T3m9MOcfsJL3wap6OfUrv2wyD9yZsMP8/yTtdI3f3a7HOQGx3v4Bm2Xbwzj8D00yG/W7375oS+T6MaxTZKYXyRnckM2vN+M7XPzEcBRbdGZ1Um33OZBUhEL4KLXyrl4buofURMuj3qZX8VXpq8eUaY/6G+LedTrcsHkLf/puP7Wk8qDrltEyjSPLlRzrHK5oy5akQW3OnOllod+0++OYcF5hgO3GsybBhZkjFlrPWbmUVIPLqe76XxeuYMsgnlgjU3yy3m7ZzZXXLxmRtL6bB7N0YZcZdKRDXc9c6ZeQoXtm3DWk/ltrkR6yaUgV/t2xR+7TVo0+Vq79CaDyYx/l2GXxOtvwXuTBZmAAJhpycy3LLQAgAzUFKwf2PPIYFJ3i15zO0VM65RX7pM37pkxOcIIhg9yBCAURijJeczulO8Msv0KEE0FyyYpTZsqRkowQkZhat5k0ead2tcBJdCK2RVZ+dm7KKjgRxkwScGVOUTtzTkUPfucWa85Z6GBubhFWKRgA+fy1dadG7MnNCET720+tR7yrX7STAxezisKQRd5PS+ToPOy4pIXltDLaAE4ouYBmZGaAaEPrdTiLgf+uDTbgh2y+4uP0pnFVmSxFVlsRRZbEWGRDQiymswLZ+waDdaZVF+2Tecj9nWRXiGTvNai+QxIYfAl25X5+iKbfMFSnOzTUjKoRfs3IeV3V4dLWgUxhfR9kUVfQ/rmYY3A2TVJQQVhGMNq91wzJm6VruqaErR/hW1kSiRl1iXbCdCR1q0N/y8p27be+QT2zIZ7Xl1+BXBc1viFf4TXNy2dAJGvevYtvKTtklrfLSetr4BNQlZDP29pzmb6sMkg6fwnaNW2+9C6hFkKKpQzC+9Lao1CejXJyty+3Et/Jbkjd5nNl4wK8pImvPwoG4q8kMLoL/+RpXptTqv8EvgrkptG8sqs4Cu3oDNt1d5/tWtvQCf5EMEm8JCbZM0lAU1u0ZW7gIvO+CTLv/sit7uHQ5q2B55xj1lOfM97BkahUbvtekEqrf5uc7jf5YRXjcEkHEvbLknydFEuJUoWaX701fDXoTEjAV+HXFs0qxWPRTtIIIzr82Lga1nAZlr/Ido8x9wceKxJk2MbtRaxMQOxYdOkgLvhMd1ZUvMsKbsn2LNx/nqB0a7Et5d296HlQs4B2IY10MhmZ1JXrlgMSe0yWX/Nj6QY1iGYCIZLF/ito7jTwBu7T7LRx4oeZj00Ao1ZkrFVLJUQnjT8aKwX0pvsZzKAj9G26+pyE9xz+wX8Mxk0wuT+aZYkZT2SZ5ySxZn0JoPJDECUrU72LEl7WXfIYMtke1CESTuIaRYwfOGZ5RD0i+IK9AtzKxCv6wWBgXNuBhXK4SUkkNDszOkSEM8lsJYU085c9MvK9XXnW+EOwCQs2m87mDJ0ZHmAJSMs2uMfT9Ew5KVfl2yb5BeMJ5sPVESHJTdDm8HOVOs30GSMAEvWS9KuP8GqkkDPAi4MP7KfZ/hqJk9ZlYq8dWVs0nyhUO5svhIJx9fOk4xv+kXzfBag4Fk8AFPzQx/ierY0wf35xX/hlqX9F6FSstFuQcqPSHrrS0/+NfRBhnAOAy5XfRl35CmvpNuDSYOdl0JVycS37002sLzrvg7lRouqA5NUN4eKFGaojuurw8tU3Z8zBXhoq6B9qKdA6tsJtoj0JoNJzh+AUp3W9f7UTtdoZEsFcaVj1fxvDdg6ra68c93BTnUH+SCBu4aaIxRcJE66XeW66RfQarbx5Aq8zlcRiNX07YBaERHJHQk3EsKIAFtseG1oI5IzUZahyksCcYViJHu/6IkusbHV5I7U6gst27cGVyWD5A/A1rPiQsDyWYLAWnddZ0jY7iPJed0DeTmTXCMnLYnfF0jW7F2mLZcY5C0ZhfGujB5ewhgVWQ0/C9brsWbAMyGOq8AYhaa1o+XAgzPpkdH6kSvzj/qtguNb3W5kFUz/gIuuD4il7YQhZJ6lXbpQI38bHns77NvbLbrbW5S+yyzJM76DnQl2RrweeV0NKQ/1ztjnd4tiREgvRI4V/WxEMT4BuvnRjruHT4Hq3H4VQbk91u8OyyLsLdvlgOHEpAJWAinorf2ob203idazUTVa9pPT7r8KzTodajQaAfNDAwRFCx3fwGhCFWr0oL0hOqWOwPWbjhC1AD4weiSWpIYQkPq7NHgE1AO3E/ZNjYFgV7+yTKP7ws9G7+wkjeCtl4UEde+7NVK70Bvd0xu+FyJvMnWjEIXmyhpPk1ZdKZAgMCMH2dH5YoA95jzfYHKLluUlGB7f2AJjtj2vBhUQVIfTjUKMAeBeO4pXA7wX0+MPGs8uh5i4i6w3gF6GiWcXTyPYJvjaG6D6WMzKWcOVOdmROZ1RHknEXojfRtbMd4D5efa2i1GC+nF81vje6DHv/nx3rAG4r2Fkawz2282sgRAIgAiNuzg3Loky6WIAmfDCtAYeU6PTZNOklcYbtdgCqIfmDVkQgTSGYFSDJhhfaEYYFmfNYY3tTJjDyZX5NE5hLlAUwvjK1vpdWr9LA/6oOflzbU0ZVrkaPJ6aekIuAjhbjZ3ML3wZbCJwVIyRqPla4HHa4Q8epzoVw65TafZE5WESnTQJ3fjOLhjEbT87uw3ANLuDvQi3kEbS6Idm1FwEIsyzBjHnFagk8+96c1isMusf0UomeS5ifzpZKlBpvv2ivTt/w0dHPkkvxSg04QJN2oXEI7Rc1Y1qtg+coyWMnv85+W5h0IXYpjaumiPoZqITl/GJAzck4oCGSLkxvSIQxgJC7Ucywat4gy2xBjKH3txQhDn04CbTCqnIH5iEID9N4WeFAkunEdp4S9d50U24pjUcaY1mOEY1kjHiE4VHMUarAKKMx7p1uiFgIDUVxxB+FskIWTZ5zVLoH2uMbewCv5AOZmnN5oLUGBMpzo5EQjZjIQxp7ctoTYN2YBXXJiNL0PVgUdePY9uvH0+zObftRGBv0Ow2em/0IxEt2CAOxFVn4ghiIKvRjoQy0NjJvNvJgs0SGXnriTZhTZ0MMjefNog43nLt2hSrBhEOW0ZZCRhRSFpBkRUNXZgqpOrtu9q/e2PeA+jhVFPFoURQbB1e7k3IA4oCC/Efwj+QlGoMpIqC7ERUIowDoEkTelOgIVEOvze7moOJFKBwRlGSfoTmgoDwe1xyVaMyHxjiLgPhv6IrZqXEVy7ojFhLgreITx5Egomh7m3BJEBXOlNxH5EIwEAxZgLJEIOmCdN+GPEgDhS1pS/ISGcgLByR37HpFw43BSC+C+AvsTYCgYfmgVCvmkxj0QM12ULEBVOpphEXdrYRDnDJqKbpn5obO6FmNEZyjFziE6iLBlpA8xyF3uhm/kr8rBwmVwZNuf48dEYTXu63IRz9JUxx7K5xMo/ByMqELtEEO5K5UjOHhZOCeJEm+gNyY0ynzEkO89A9CHa3qO0BhUHn4TCM+tvS2uAv2odqRIp3GAwEIQmaRphMAW4k33CtuuGhOUtB8Fh8JXbaEo2DpSzuv6rJjJNG40wQsESg265scxC+TC3KMqmpOKJ0HyIOEBtjNimiYMJfJCJkoAU6Bxlrwa/e6MrLj7K7+RI2hcjMzTjPvpP6c4l4FIwmd0oDs/HmzkRtnAXJvf4ZuXGcTPnL0entSlEq0YTgF4LUQQAfKvM6rTlwKGcwBRN3MQIS5IAsWp4tuP7tf/6dCbpnP/J3wggTR1JbIt1jJDAujqfdWLSjiwW4ySEVP13aD8XLWXA0Ey8uYiMavAwmwLp46DMNOQ/REAxEkeuWH1PTxOsFV2eZ7dJ3XAnHy32syeNQqnAhZEWOYVJjeAnSItUQSBMtGMpX1m0yrmJx9QXFtIajKJWkwc6rwV1XnoGmsVfgLA91Me6y+QBt2cLroom+0Yj10uSFkyWc1mTXG0LyNKE38BpRo03NhE5Uby7LGl3io2YN0rMRmJdt9nZ0G/uRo0jWwIvgnAXSA/OF9TBcGh0lg0Y1T8ISNCxxlWM+OhuykwVoVLW5oEWncY9aN4KFVZooVazE94j6tzNollp5c+uPwzfWW6bkINz/gsvg6i4122aRf5tBET9nzMc0S7oOYL14TNcbOE1M/J0ur9lYUCdDWkKYDubCGhgPCGS4grToJD/ADrhCwUqpweRd2Ri8mBAPJspzkTUA/dBc9rNy3lJTWV2imFcHpWqEdGkapEcgQc4G1ZPRaefMMzTtG43z7UxprfEQGoyVuEzPLrgiWPEOYdfUvUHSRXxm1ROquQGJajAzb9tPw0ecQLqkRv/EagSvaWRYLmM6uhKqwyXEEtLwkWuFC7XvVyd/NGd66B//Yw0BlHm4nZwNtGh8C3WJC836g6+zaB5N4GQkafx1B8vxldUedQkh3tSbIq60kv+DMsGiWlj57uNQIrGbkR3kFrkJnXYiYLcmyoGYtWru5bckbXH/fPnXYFAa5kZq/4J2Da7+tC+ZD8G76P4N7ofHmY045TeUSXhxIhMRLiMjDhwCT0or0Ug9STEqYI7UW/t7bNxAliOLP8OkRmfE6srLAnuKJNZowWi07EU9xY5NJcMBI4ZCGZUKGCFaLQEZjZj1r9J+sDxjbOKeB5kOU1Mo1Byy5TkwgbQkZa29LPMxERlWOxNvUBucnZcmkj2RfQlWoyB9hQZBrfxDseBDco9VqGK8utsdZRTxE6NQBvo6NoNHEKYdKEO2pPV8Sb/f133jkycB+03uAIOqFWeznAlteFq+T57nmYi0GYVK5vx7y/nz6nmXs0W7nzat/N2k6cBSTphya2U1Xs6I1eRua5P0CCSvR1OrOxr1IddgzMv0Gs5FVItMDNli2rUzLMP0cKt+Pa0xqNlRcCEmZZkXqNRMfkZEmfHpz43uya8Fy728YAW0UhsyL+I+lp/R0yy+t4cVdezBvj/9Zd/Lc61GuVIzBqb2eo6ZH2vtvEVsJykZ66LFf4hbs4gh+Z5o973778saQ++NoG0PX+O5oG3cx1r/tL/nYXL972FmRs386nj+2YtSyKAI/GvD3OSCLBqlNUVVaVlitXUiozkf3YfOOax2XY6izpYlMgM6l3trh5WdiHuI38l1EYntbYbM5SA9EqRoo7E6jB75osm4qYbRosYrKheJsfmv7By1Vw62a9miUD25o76Pe0tWKDJwiN3a61K0T5OxuIMSkCUGc/q9haXJJ/QKlYt9Sh6IfGJv/dOGp4XqtTIGY3eyVJ3lYatpdSujbcbb5MzOnjMSuMm0KzmJFVdOPojM6cnxreebxfPazf5YY5+/NWfbbyv7XOssqF9mOfOVXBz0kP0Nm5L5YdyboD7QxihXodRFOMLa6u37fGnLUYu2es3VwOIwL1sjlu6GYBGMJM41+ilE2JYn2yhmlSHmL2E47OJL9s/acGhqN8vkUImxP/vaaM83kKWROlbyNGKzDeaTg1GflMl57Llm4re0PE+UNaQGJLoNlGuMxxnlUXv3FqdNKEacbwC3sK9lXmMgCyMt4jk1DZvlPITXkrWrBe8Otz2MKM7BjqPtzwO04WpnQ790iKwLUNttlmsJRnCYfve03tr814beVve0z/n6ex72U2L70taKPRcNKladA6WbKrkbTNjTPgSH41zMDx2PPTgKK04VDtSQbAxoSdTCvcTLvmrrdW/kVYrdr7fkXK4PlU5GOmRfZXSqwXI5YKAteRLG31v/tOFp7ftW7LpkfoNcCnaOPAp1YqesL/PR22DUgwCSUZDN2kzxXm8hHH1/CqjMlrmRIeglPIKXo7W7HWOfd2obmUgohtyrZVa6HzpBdhF2IsNcezYlJ/e0/mmDZVAg/mds+l3KeIrFvs/cViKpJ/s5WHuxr09RjCB/fWLPLJcS3g7+QkudTsmGktS+AODS/kzEvrcZgrP5XtQDrn1aMipOW5wsSzAi+6/pdnETBZpCtVzLYTUPxX1v6lm0zQv4Q2woUYWnViwlWQaG+S/+n+WLBS0jNRQiOodxKS0i+0McR/thJj/DziArcxYyF24XzBcZcawQ1EbjO51xFIq+qhyY5VFo4RLWPpRE81LJwWv/yOZEsgTWUje6CaYC+0V8WHe1bDVox9kJhz8ApxAPxg/l6GQDDa6WgbHzJ3EvCoxkOMi3aMKMt1zO9EZtAqzWC8NNKxLJeIB70rPe+qd9uIn2n3aHEAYVSMR6YCmnccj6zjFDgT7B8AD5GsKvl1sCGXcyNz0vcz7HRRD0JnMjXqPWHx47ARnphKWUzliKRVTIyQQ77viztzomzCQ9uvD+E9mZMxKZMuZhWRZtNGfVTCg8rS74sRxMZyi0/mk7K3lIShN/Fi8ZzY9czRCPWhHvXg5l9RCCBXhMEZfV/GA7pV4F6gJ88pZnIQBJq97wcRC5WTQkmt1Ru3DdZ+sx88/2UJHPZ0ZvfqQUdYI/jCQByLR4YY2nFWlYwcXesi48z1f6wPx+Zd+FgNV2vCtWoS18Uu+0eGmeCIUFqsUQIgSF/IzGaXEZLYy3YoxODoKzaiUoZ6cFxeqXCpULEIXyzZZW6B3/2wm/nWwkIRGXHgHVBvs9X9mZ+wHYYR0t0CGkf5y7ZUJAZCQeegewLi0hNy2U33mm5mRycEu0LRCENABviN+QvJW1C4Iat+kdA/EOtTI0329ocN7OiOejQAB51pAMh2G6DuWPsWP6DjKFeN++V0BlwqzkOhxPS0dmx1kShESCfdWhyQSxE3keAJjCJwbSWSVnqHzrcFzGiuik5UJcT4NY6uu383cm/HYsY7IUtPTp5A7nD8P9dHx6gL191VKH2oLuHWuHabJN8XT8b0c/QRrd7mMd7pP7YKm8iv2veufvDOA88lO1d74d7gdTto7rwwO002x1Vm9fLUsio2QpES/obOBYNtHQjpRXvM7OUKBhnaqNNwGwtYBUfwlpkz6mEOvEBFLsfTnL5Qlky4f5kQJvoRIqwgE55CXm000XBnkuD1KgOssK5Py6PUmS4+ixFWEOb6hgEdsVIK8PbA6WyggrjhRAXC/LY5TRyicohcKK/XZIarBPZI1Bt2ytYfUhJuoHMDpiChR3a6JcPUhMvC0EsOJyrdC7kKK0hMQz5rU54JT77fydIU0RSKCStijFqPBKkU+xaqjRbZaLyDiXclmOIeAWgb0bcyg8GwzQvlyIBAuG3VcmZLdSIotz779Ksv8qCahVDmaloMiZf1bH74Rt6chsUGVUZBxvIOOyy1TFHm7v0XTrBKv5iQ0Y5wReekw94eEs4n4FkPMhwp0pETy0KMVi1l5o7uMJsqfZomFCiwJvVrbNFBJq7x0C6iLw1GkcBPEMivaO/+38fQWaFOun0PGAdJMMOmTNtOWX4SDWz/ZM7RiTFXcDGeGmOW55BjRIdSkvXYd8suAaYT5RBet8YUSJwm0hpEi4mviVJvwkHWe1K8KS5jwEHvscCjUGC3wKc8w2G4AP0qJWotNYXHWuBKU5nZwGCnD6ieKfHtKu2/l5UCQ/0TvZKnbkN4J13s6qeoR8iSwLf5zle09gSk340kFleFDlZCnup/N3Jvx2cg9oGwTO6QZeghnfsGiBPUieZp4ygMKLEoVyjtOB5+ZAnNsC2qZ12n66Axf7dpkxl3+6NUeHOpRL3J7O+cC5pJUTP+qdVnsUGuRX4TmUMtYeC7Eosv8YWDJODQoDs9abAnEZOXCmBZVJSpBTD+RJqyGVtQLpUq/DkW+u985LQKWHTi2IzMBqyh9zoxYsttKa3glP52shY4xNAtNJWSkEInpMtI0nZ4NSWgM+Dh3nfYk39w4ILuA+gW6lYzMzjwSbatPerWKH9S2PZCU3VI1YBc4HT71bqNmV5Kbfzt6hXQ8xw8J7yPnK7WuoLvYORkOmnk6xJbAOeYlrK97zgoiAwNi8FZ4nwSuqzUlthmJxYzl+qtiLHCz46QLF9zOSROgsjGzhaOtc7rfzdyb8dqzApvO8jtsAbmO85SH3QQQQKntYkYyZ07e08vRtV4f50sxbeJkCFYNx7LiPv+ZCdf1X7nXCNH2pxaIc69sIeeoMNSIyTlSEL4t4F0Nzi57EIiguLt4SYdSRE/Pk/axiA57dXw9YJrxmMUAA86sFi9bOTrvTKl96LxsiI6tqsVb3tXH3KKvFSQloJN6KEZrSvOOMx1wNM3GOXIBMEThKeNqgHjb0sLpyQ1IG7Tqmqv6Jj1pk1nqY/bFdVGUYMIqaDWbFemGmrls+eLSY1QQkjwdvGXqL1yaLWybtjJifSKQBiqfn/3od6xhMfVBP6iDHafGO3KFMsbiifnYOb+BWwYcVasoNWLClZirCSo/bGaJoBil8nX37oRcOqwWZ/SlLF+06bRFL+RDRs2mlJ1IfrOY7m6+iAMOtVACm3iPpMPiX25tF1aQWbW1WhVFhRnbuZ/KnQY/FTcL0MlTUUwRBZKu6DpeGT8St4wjqn/XUxOuopf4mM/0W52oUsMqbh3KbTRGlXLQ60ohNPmG0Oq4NQH4xG1v+XHkPvPTVtHr1+rmGMCat11aeeFajdliQN1i+SRhAbgvITFTLU7tXh9DzCrrulZuLKLzVH39aqR0j7Jsl/gMFWPrxYZfY2rvN1ku9VpmKysCv9fgUG71PLbp7iLJOHwhJn+R+LuIaZoMEa49tH8AsA5VEn85cLT4ltm4Yi2S8G3vqvV4NAiI8sM6AVcMKl596nl0udArXE4OyKDb5NeJM/okvWYTs6f13DoAwy69fVBTri5siSkMGlfSL5dDfxFPJn0slqGFQL/QnJ0VOmX8ZSHkH27/ZMsKsea6EkXg9LV+H7BaFCPlq3zGUyaJML8EP8/JJ+opGCBOI4+FS6AkTpN6jwgAQUA/3QAYZtWyVtN612X+1p6WDgciaf+JG0U+/vfD05FroiXUaVDu1UjslKfh12yjEhsoFHiaaM4bJqsDOW1poOEK7BBNDTMViNFehIlYmAFb11+PbQ26O2SjdkenXfnvy43kEZ0t3S85bp5KVzNdMlK6KGUglSJz2BBZZVt043h+854SbZ9Ysz2zkDOfvf3siXlQGqfdR7/tEcw7z4E+PDHLi3pZZTr+oYCuhx4dr+On/6F13Mie7S0spEwQHjKPFj397mQiPp55SfxuDqP5FCtr8g8WTes/+ovf+Oxf+errLKZ43WUb9xITwOqPFeE5LxBMGmWIbSTZTrgFuaSO59JG6W2bXUSncfmecNHTMH4vsnOF1kYHvMRzL3gq3S0+1p827V94TVS8723kyuqe3yjfqZZvvL5ul9Zt9d/Gpxu62ZSRmXhHtfhvbfrXj7B7XPDfB6Sfmwqh+e2GQMoXLKidbyXr2aDWxK2U8VL5qTqsUpA7vmxoN7czh5i8/+K2ve5GqvahmrZBRzZV6BXQ9DWIVnrejqGb9vbNboh97Qhan3HWL6Ibsn1APYQ0o5uODF6HACrGR3yAoa9ESzZiefBettBDI0xV3LKm72tiEknopKe9MgBjdbygETfjrhv+6hEgKGU8CF1Y0+kR0xH6A61boKcd2vVln+etpI9hTLaTReM/H/UYlemQAvnHaG1Tmba2SyAhhtWyr/aoo1ux7XIHlWYdJNil6Mh2PG7aIlkUOPvkviKCuhRH+QV2BGRMKDm0kFvAHiWbvzq5KxAPcmlt3x/6/s6tdamfNXRP9ATuTQM3pt1v4HwqkA6uR0gEEMIFbq7yywE+zH8YLFGLW3goko3CA6B6WMLrFm7e+8E8iHJRA6saooJF9fU1Chy5zQw5KSpCl5dBwPQ6vNIQqT53kq/3mqQSc9qXYO1my57x/gyMQFX9zr4tXtN857Y0XnLcWKq+c8T6QNPeWfjVeEGrC5FZHs3vpociHTKH4t9xe7gz8b9b3/2Z9/29+rV6O0DC5o8OLiDElkfjKaW+UaZcU2YK1J3l69CB1H9qJ7kEIXTO00P1+5fKpKnmIdfePTxcHmbdDBsAK0qjyttXERe6b0ecE3p9attKx2+89xJBPXkHoLrHJCDXLPZ5OE8yOtHSLUPLByPCAbDNzhnV/vCtB+Bg8BcUnGmJpmacrU9O7V1gJ5tD9uvLlbCA6FShiUXf/65orhBVZHZdrb7v2O9+8soDn03AOK9d8iBlRwn+EYDaAifgs78xEY6veH2evnBRNHZkrmKbjRQ6rXa0U1ImK8v6G9ol/OOBvN/fSKdd0E7m5ItoYe8Zhc4bhzYEZzorJfJmMGdaoTnJ5BADWP2+2mYsrT2iOtzwSaEgX5GURybiMlz5dXus4jRZZvkFeHH7H68eQntqsJEmzmCxx/del7kgOuqevhASP8WuZSwqIQi/mwBpunWh3T2Au96/bo/QLM8XrEkXL7HjnSaaezcR9eR0ixPzm7Qb5Ja0Fr/dD4/xlSPIrS9u6pf2lafydEDOZIntdyx1Hd4T2qu9sil/5XzPkW128Og3yo1EJUp68okt5607AnDzw//TD0yeYPAUULPc48KuXZWKJhBjYaljSwq2sbIKyiqkXNlufmDQUioCRdDdxT/qPYzLD+Wc5BUhkyY3mGGmWxyq30RbKp1nB2SqMea1p68bR4lGiJz59wqmtB33RnsyweFGjBWKpJaN05s/+BfuPLHhEdSv9Ovsesuj91V5NWm2iqXN/7KFMNlB0ha3O3Z79EpVg/9uECMrR7CW1gF2eZOyq78XKZtopQLbnauzKvQdevr4Rb0x/Fg6z9rtGkSz9FCjiGX4nATqhH1wslAxgN8ogzZ7sdUKfrL61WFyR8iYLP8oXHIyfVHcWgyyYfMC+pjtZ1XGPDVKHsciWBYpUZT8pQz2/iZziq6d/J00yzI+K0uR4D8+skf5WA76K6/0lOvs/DgRhHVGbp66UV1aCX+21OOF4sn4GuwVDjEiemGWZTQtMmR3ZHkOiqQkvCwzaLl5dYC0ssrR5m/O+pb1b7eWsKHzenYdujjaF11MRGP3b/lZ96UYvu/rbq4SJmuWkLd1ztU1mrzUKRmUg5MKdhf7k8HiR6IIuv0UgzkXPThWclc1clnJziyz/rstlGfhvajK1NBmKP0bA1hPAHzMPfPY6bvvjg7ePiTZsRLC/Wz7v8ORBeO/Ikity+ddu5qeXNpF81br3g6OfekIJv1vWDo5eoj/LV5U9CLePwWIKrbh+tznIibI8+VP7QbUkwvfZe8K8Vr8zzRsBQw3jJGBQqG5ITBne4XS52WtzlP383XoR08fImBVbhboJXFhN5qpl8RYBdPWXwGs7UOKfnugmIPR/DsL/HmTtK5t/3gPutSeXtFULIyIPVfO7Mw+8U+22l9uG84ck0m1F8nIheF2C7P8dsKWApPjn1f/BCLJM/2GKX7reD+yby3Vg7quF9Vdi/Nn+XycA/mJGnhrw1eqzeKvgz19bjJlibfmLkO7Xn/vWXN0ULOgZJgu/U41w+u/cU9k9wlz6CKg24l0jS0b3nfREs6ggFmvoSyILQkeTyzd/B7jj/w7+3zfhfw8yseJKXiZZzXAM+xFeicLSgczKbASOu/134P/3IPzvweOgtdHFCP72tuubu8mPyjKTZiIOrF2Vq6Y8921cn/LJTti0TYk8/DI1s7x/LpjHfmcKg39p13e2185kk8P/AUrqYkahTAAA").split(","));function nw(t){return ow(t.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}function ow(t){let e=t.indexOf("1");if(e===-1)return[t];{let r=t.substr(0,e),i=ow(t.substr(e+1));return Y(i.map(o=>[r+"l"+o,r+"i"+o]))}}var Xo=class{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return Ko([...this.store.values()].map(e=>e.length))}add(e,...r){let i=Ur(this.store,e,()=>[]);return i.push(...r),i}set(e,r){this.store.set(e,r)}delete(e,r){if(r==null)return this.store.delete(e);{let i=this.store.get(e);if(i==null)return!1;{let o=pb(i,r);return o&&i.length===0&&this.store.delete(e),o}}}clear(){return this.store.clear(),this}keys(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield i)}return r()}values(){let e=this;function*r(){for(let[,i]of e.store.entries())i.length>0&&(yield i)}return r()}flatValues(){let e=this;function*r(){for(let[,i]of e.store.entries())if(i.length>0)for(let o of i)yield o}return r()}entriesArray(){return[...this.store.entries()].filter(([,e])=>C(e))}entries(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield[i,o])}return r()}tuples(){let e=this;function*r(){for(let[i,o]of e.store.entries())for(let n of F(o))n!=null&&(yield[i,n])}return r()}filterInPlace(e){let r=!1;for(let[i,o]of this.store.entries()){let n=o.length;ft(o,s=>e(i,s)),r=r||n!==o.length}return r}};function Gp(t,e){let r=new Xo;return t.forEach(i=>f(e(i),o=>r.add(o,i))),r}var TL=l(()=>sw(iw())),Ou=3;function sw(t){let e=new Xo,r=[];for(let i of t)i.length<Ou?r.push(i):e.add(i.slice(0,Ou),i);return{trie:e,small:r}}function ML(t,e){let r=Bb(xp(t.toLowerCase().normalize())),{small:i,trie:o}=e==null?TL():sw(e);for(let n of[r.replace(/[^a-z]/gi,""),...nw(r)]){let s=i.find(a=>n.includes(a));if(s!=null)return s;for(let a=0;a<n.length-(Ou-1);a++){let m=o.get(n.substr(a,Ou));if(m!=null){let c=n.substr(a),p=m.find(d=>c.startsWith(d));if(p!=null)return p}}}}function vL(t){return ML(t)!=null}function Pl(t){let e=10,r="";do r=t();while(e-- >0&&vL(r.replace(/[^a-z]/gi,"")));return r}var lw=BigInt(0);function Kp(t,e,r=0){if(!isFinite(e)||t<=1)return[];let i=[];if(e===0)i.push(0);else for(;e>0;)i.push(e%t),e=Math.floor(e/t);for(;i.length<r;)i.push(0);return i.reverse()}var Zo=class{constructor(e,r,i=Ar){this.name=e;this.numerals=r;this.decodePreparser=i;this.base=r.length}digitsToNumerals(e){return e.map(r=>this.numerals[r]).join("")}encode(e,r=0){if(!isFinite(e))return"";let i=e<0;return i&&(e=Math.abs(e),r--),(i?"-":"")+this.digitsToNumerals(Kp(this.base,e,r))}encodeBigInt(e){if(typeof e!="bigint")throw new Error("bad input");if(e===lw)return this.numerals[0];let r=[],i=BigInt(this.base),o=e;for(;o>lw;)r.push(Number(o%i)),o=o/i;return this.digitsToNumerals(r.reverse())}encodeBuffer(e){if(e==null||e.length===0)return"";let r=[0];for(let i of e)for(r.forEach((o,n)=>{i+=o<<8,r[n]=i%this.base,i=Math.floor(i/this.base)});i>0;)r.push(i%this.base),i=Math.floor(i/this.base);return this.digitsToNumerals(r.reverse())}decode(e){return f(this.decodeBigInt(e),r=>{if(r>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(r)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(e==null||T(e))return;e=xe(this.decodePreparser)?this.decodePreparser(e):e;let r=e[0]==="-";r&&(e=e.slice(1));let i=BigInt(this.base),o=BigInt(0);for(let n of e){let s=this.numerals.indexOf(n);if(s<0)return;o=o*i+BigInt(s)}return r?BigInt(-1)*o:o}randomChars(e){return this.encodeBuffer((0,aw.randomBytes)(e+3)).slice(1,e+1)}safeRandomChars(e){return Pl(()=>this.randomChars(e))}randomUid(e=20,r=5,i="-"){return jo(this.randomChars(e),r).join(i)}safeRandomUid(e,r=5,i="-"){return Pl(()=>this.randomUid(e,r,i))}tokenEql(e,r,i){let o=this.normalizeToken(e),n=this.normalizeToken(r);return o.length>=i&&o===n}normalizeToken(e){return this.decodePreparser(e.trim()).split("").filter(r=>this.numerals.includes(r)).join("")}},T4=new Zo("hex","0123456789abcdef",t=>t.toLowerCase()),en=new Zo("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),SL=new Zo("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",t=>t.toLowerCase()),ua=new Zo("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",t=>t.toLowerCase()),ku=new Zo("TokenRadix","0123456789abcdefhjkmnpqrtuvwxy",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9")),M4=new Zo("AlphaRadix","abcdefghjkmnpqrtuvwxyz"),v4=new Zo("NumericRadix","0123456789",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9"));function Ru(t,e){let r=t.toUpperCase().normalize(),i=e.toUpperCase().normalize();return ui(()=>r===i?1:void 0,()=>T(t)!==T(e)?0:void 0,()=>t.length===1&&e.length===1?0:void 0,()=>{let o=mw(r),n=mw(i),s=PL(o,n).length;return 2*s/(o.length+n.length)})}function mw(t){return t==null||t.length===0?[]:t.slice(0,-1).split("").map((e,r)=>e+t[r+1])}function PL(t,e){let r=Tp(t,e),i=[];return r.forEach(o=>{let n=Math.min(Sr(t,s=>s===o),Sr(e,s=>s===o));ce(n,()=>i.push(o))}),i}function uw(t){return Sr(t.normalize().split(""),e=>e.toLowerCase().localeCompare(e)!==0)}function cw(t){let e=t+`
`;return I?e.replace(oo,`\r
`):e}function yo(...t){return Y(t.map(e=>g(e).split(oo)))}var xw=S(require("fs")),Dl=S(require("fs-extra")),$n=S(require("path"));var fa=S(require("fs-extra")),Xp=S(require("path"));var Jp=S(require("crypto")),fw=S(require("fs"));var pw=192;async function _u(t,e){let r=Jp.default.createHash("sha512"),i=0,o=M(e?.msbits,pw)/8;return await le(t,n=>new Promise((s,a)=>{let m=fw.default.createReadStream(n,{autoClose:!0});m.on("error",c=>a(c)),m.on("data",c=>{i+=c.length,e?.observer?.onProgress(i),r.update(c)}),m.on("end",()=>s())})),r.digest().slice(0,o)}function EL(t,e=pw){return Jp.default.createHash("sha512").update(t).digest().slice(0,e/8)}function gi(t,e=9,r=en,i=224){return r.encodeBuffer(EL(t,i)).substring(0,e)}function tn(t,e=24,r=ua,i=224){return gi(t,e,r,i)}var hw=S(require("fs")),El=S(require("fs-extra")),gw=S(require("util")),ca=S(require("zlib"));function DL({message:t,cause:e,retriable:r,ignorable:i,fatal:o,doNotSend:n}){let s=[t];U(Qe(Se(e),"Error: "),m=>s.push(m));let a=Cb(R(s)).join(": ");return o=o||a.includes(ye),r=(r||a.includes(Js))&&!a.includes(Nt),n=n||!a.includes(wu),i=i||a.includes(dl),mx(Tu(a),o?ye:void 0,n?ho:void 0,i&&!o?dl:void 0,!r&&!o?Nt:void 0,r&&!o?Js:void 0)}var ue=class extends Error{constructor({cause:e,message:r,retriable:i=!0,ignorable:o=!1,fatal:n=!1,doNotSend:s=!1}){super(DL({message:r,cause:e,retriable:i,ignorable:o,fatal:n,doNotSend:s}));this.cause=e,e!=null&&(this.stack=e.stack),this.retriable=i,this.fatal=n}};var dw=S(require("stream"));var $p=class extends dw.Writable{constructor(e){super(e);this.deferred=new gr("WritableToBuffer");this._buf=[];this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",r=>{this.deferred.reject(r)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,r,i){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,r)),i()}};var cH=l(()=>h("zcat"));async function Qp(t,e,r){if((await(0,El.stat)(t)).size===0)return;let o=[],n=[(0,hw.createReadStream)(t,w({autoClose:!0},r)).on("error",s=>o.push(s))];if(t.toLowerCase().endsWith(".gz")?n.push((0,ca.createGunzip)().on("error",s=>o.push(s))):t.toLowerCase().endsWith(".br")&&n.push((0,ca.createBrotliDecompress)().on("error",s=>o.push(s))),n.push(e),await Kn(n),C(o))throw new ue({message:"zReadFile("+t+") failed",cause:o[0]})}async function Yp(t,e){if((await(0,El.stat)(t)).size===0)return Buffer.from([]);let i=new $p;return await Qp(t,i,e),await i.buffer}async function yw(t){return JSON.parse((await Yp(t)).toString())}var AL=(0,gw.promisify)(ca.gzip);async function bw(t,e){let r=k(e),i=await AL(r);return(0,El.outputFile)(t,i)}var FL="readdircache",LL=l(async()=>{let t=(0,Xp.join)(u.cacheDir.valueOrDefault,FL);return await(0,fa.mkdirp)(t),t},D);async function IL(t){return(0,Xp.join)(await LL(),...jo(tn(t)+".json.gz",2,3))}var Zp=l(()=>h("Readdir"));function ed(t){return t!=null&&v(t.basename)&&np(t.isFile)&&np(t.isDirectory)}W(()=>{j(()=>Nu.prior()?.clear()),Kt(t=>{t==null?Nu.prior()?.clear():Nu.prior()?.deleteIf(e=>e.startsWith(t))})});var Nu=l(()=>new _i({maxSize:500,timeoutMs:G,clearEveryMs:D}));async function td(t){let e=await Nu().getOrSetAsync(t,()=>OL(t));if(e==null)throw new Error("readdir() timeout for "+t);return e}async function OL(t){let e=await IL(t);try{let o=(await(0,fa.stat)(e)).mtimeMs;if(Date.now()-o<u.readdirCacheSeconds.valueOrDefault*E){let n;if(await yt(async()=>(n=await yw(e),n!=null&&Array.isArray(n)&&n.every(ed)),{timeoutMs:G-E,timeBetweenMs:250}))return n}}catch(o){o.code!=="ENOENT"&&Zp().debug("Failed to read from readdir cache",o)}let r=await la((0,fa.readdir)(t,{withFileTypes:!0})),i=Rb(r.result.map(o=>({basename:o.name,isFile:o.isFile(),isDirectory:o.isDirectory()})),o=>o.basename);if(r.elapsedMs>=500)try{await bw(e,i),Zp().debug("Wrote readdir cache for slow directory",{nativePath:t,elapsedMs:r.elapsedMs})}catch(o){Zp().debug("Failed to write to readdir cache",o)}return i}var Al=class{constructor(e,r){this.base=e;ed(r)?(this.isFile=r.isFile,this.isDirectory=r.isDirectory):(this.isFile=r.isFile(),this.isDirectory=r.isDirectory()),r instanceof xw.Stats&&(this.size=r.size,this.mtimeMs=r.mtimeMs)}},ww=l(()=>h("DirectoryEntry")),rn=class{constructor(e,r){this.dir=e;this.dirent=r;this.nativePath=(0,$n.join)(this.dir,r.base),this.ext=pi(r.base).ext}static async for(e){let r=pi(e);try{let i=await(0,Dl.stat)(e);return new rn(r.dir,new Al(r.base,i))}catch{return}}async join(...e){return rn.for((0,$n.join)(this.nativePath,...e))}get base(){return this.dirent.base}get name(){return ir(this.base,this.ext)}get pathnames(){return this.nativePath.split($n.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}get isRoot(){return this.dir===(0,$n.parse)(this.dir).dir}parent(){let e=pi(this.dir);return e.dir===this.dir?this:new rn(e.dir,{base:e.base,isFile:!1,isDirectory:!0,mtimeMs:void 0,size:void 0})}async childNames(){try{return this.isDirectory()?(await td(this.nativePath)).map(e=>e.basename):void 0}catch(e){ww().warn("childNames() failed to readdir("+this.nativePath+")",e);return}}async children(){try{return this.isDirectory()?(await td(this.nativePath)).map(r=>new rn(this.nativePath,new Al(r.basename,r))):void 0}catch(e){ww().warn("children() failed to readdir("+this.nativePath+")",e);return}}async visitDescendantFiles(e){for(let r of F(await this.children()))await(r.isFile()?e(r):r.isDirectory()?r.visitDescendantFiles(e):void 0)}async filterDescendantFiles(e){let r=[];return await this.visitDescendantFiles(async i=>{await e(i)===!0&&r.push(i)}),r}stat(){return(0,Dl.stat)(this.nativePath).catch(()=>{})}async size(){return Re(this.dirent.size,()=>x(this.stat(),e=>e.size))}async mtimeMs(){return Re(this.dirent.mtimeMs,()=>x(this.stat(),e=>e.mtimeMs))}unlink_(){return(0,Dl.unlink)(this.nativePath)}};var kL=64,Fl=class extends _e{constructor(){super(kL);W(()=>Kt(e=>this.clearFromPath(e))),W(()=>j(()=>this.clear())),this.on("expire",(e,r)=>r?.clear())}clearFromPath(e){T(e)?this.clear():this.visit((r,i)=>{r.startsWith(e)&&i.clear()})}};var Tw=S(require("stream"));var rd=class extends Tw.Transform{constructor(){super({objectMode:!1,autoDestroy:!0})}async _transform(e,r,i){let o=(g(this._prior)+g(e)).split(oo),n=o.pop();this._prior=n===""?void 0:n;for(let s of o)this.push(s)||await lt(1);i()}_flush(e){this._prior!=null&&this.push(this._prior),this._prior=void 0,e()}};var Bu=S(require("timers"));function RL(t){return t!=null&&v(t.path)&&v(t.op)&&ht(0,100,t.pct)}var _L="progress";function id(t){RL(t)&&Ue.emit(_L,w(w({},t),{pct:Ze(Z(0,100,t.pct))}))}function Ll(t,e,r=!1){let i=r?Date.now()+e:0,o=0,n=(...s)=>{let a=Date.now();if(a>=i)return i=a+e,o++,t(...s)};return n.count=()=>o,n}var Cu=500,on=class{constructor(e,r,i=Cu){this.context=e;this.total=r;this.throttleMs=i;this.start=Date.now();this.emit=Ll(()=>{id(w(w({},this.context),{pct:this.pct,elapsedMs:this.elapsedMs}))},this.throttleMs,!0)}incrProgress(e){this.onProgress(e+M(this.current,0))}onProgress(e){this.current=Z(0,this.total,M(e,M(this.current,0)+1)),this.emit()}get pct(){return Ze(100*M(this.current,0)/this.total)}get elapsedMs(){return Date.now()-this.start}},Qn=class{constructor(e,r,i,o=Cu){this.ctx=e;this.total=r;this.progress=i;this.throttleMs=o;this.start=Date.now();this.onInterval=Ll(()=>x(this.progress(),n=>this.emit(n)),this.throttleMs),this.timer=(0,Bu.setInterval)(()=>this.onInterval(),Cu)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){f(e,r=>id(w(w({},this.ctx),{pct:100*Z(0,this.total,r)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>Cu&&this.emit(this.total),this.end()}end(){f(this.timer,e=>(0,Bu.clearInterval)(e)),this.timer=void 0}};var Yn=S(require("path")),Sw=S(require("process"));var Mw=S(require("fs")),od=S(require("path"));function vw(t){let e=[];for(;t!==(0,od.dirname)(t);)t=(0,od.dirname)(t),e.push(t);return e}function NL(t){try{return(0,Mw.readdirSync)(t)}catch(e){return[]}}function Vu(t,e){let r=NL(t);return e.every(i=>r.includes(i))}var nd=l(()=>(0,Yn.dirname)(process.execPath)),Lr;(function(c){c.Root=l(()=>{let p=["icc","migrations","public","views"],d=[];Ce()&&d.push("/ps/app"),fi&&d.push((0,Yn.join)(nd(),"resources"),(0,Yn.join)(nd(),"..","Resources")),d.push(...R([nd(),(0,Sw.cwd)(),__dirname])),cu(d);for(let y of d){if(Vu(y,p))return y;for(let P of vw(y).slice(0,4)){if(Vu(P,p))return P;let _=(0,Yn.join)(y,"node_modules","photostructure");if(Vu(_,p))return _}}throw new Error("Failed to find project root. Looked in "+d)});let e=p=>l(()=>(0,Yn.join)(c.Root(),p));c.Bin=e("bin"),c.ICC=e("icc"),c.Migrations=e("migrations"),c.Public=e("public"),c.Tools=e("tools"),c.Views=e("views");async function m(p=c.Root()){return ae?new RegExp(`^\\/Volumes\\/${lo}[^\\/]*\\/${lo}.app\\/`,"i").exec(p)!=null:!1}c.isInDMG=m})(Lr||(Lr={}));function nn(t,e,r){let i=new Pw(e,r,!0);return i.read(t),i.done}var Pw=class{constructor(e,r,i=!0){this.sep=e;this.onData=r;this.filterBlanks=i;this.incompleteChunk="";this.done=new Gt}onChunk(e){if(e==null)return;let i=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=i.pop(),i.forEach(o=>{(!this.filterBlanks||v(o))&&this.onData(o)})}clear(){this.onChunk(""),v(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",r=>this.onChunk(r)),e.on("end",()=>{this.clear(),this.done.resolve()}),this}};var Dw=I?"wip-":".",sd=new Fl,$r=class{constructor(e,r){this.dirent=r;this.bflog=l(()=>h("BaseFile("+this.nativePath+")"));this._childDirectoryEntries=l(()=>x(this.directoryEntry(),e=>e.children()));this.stat=l(()=>this.trap("stat",()=>Je.default.stat(this.nativePath).catch(()=>{})),$r.attrTTL);this.statSync=l(()=>this.trapSync("statSync",()=>dt(()=>br.default.statSync(this.nativePath))),$r.attrTTL);this.shaResult=l(async()=>{let e=await this.size();if(e===0||e==null)return;let r=e>5*Ai?new on({op:"Computing SHA of",path:this.nativePath},e):void 0,i=await Jr(()=>this.trap("sha",()=>_u([this.nativePath],{observer:r}))),o=f(i.result,n=>n.toString("base64"));return{elapsedMs:i.elapsedMs,buffer:i.result,b64:o}},$r.attrTTL);if(r!=null)this.nativePath=r.nativePath,this.dir=r.dir,this.base=r.base,this.name=r.name,this.ext=r.ext;else{this.nativePath=Gr(e);let i=pi(this.nativePath);this.dir=i.dir,this.base=i.base,this.name=i.name,this.ext=i.ext}this.posixPath=Hr(this.nativePath),sd.set(e,this)}toJSON(){return{nativePath:this.nativePath}}[Ew.inspect.custom](){return this.toJSON()}static async withFastestAccess(e){let r=A(e),i=await Promise.all(r.map(o=>o.shaMs()));return r[dp(i)]}static forPosix(e){return e instanceof $r?e:this.for(e.split("/").join(sn.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(e instanceof $r)return e;let i=sd.get(e);if(i!=null)return i;let o=Gr(e);return sd.getOrSet(o,()=>new $r(o,r))}static clear(e){Fr(e)}for(e,r){return $r.for(e,r)}clear(){return this.dirent=void 0,this._childDirectoryEntries.unset(),this.stat.unset(),this.statSync.unset(),this.shaResult.unset(),this}clearThisAndParent(){return Fr(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return e==null?!1:e instanceof $r?this.nativePath===e.nativePath:this.nativePath===$r.for(e).nativePath}get isUNC(){return Np(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return Pu(e,this)}async directoryEntry(){return this.dirent==null&&(this.dirent=await x(this.stat(),e=>new rn(this.dir,new Al(this.base,e)))),this.dirent}async childDirectoryEntries(e){let r=await this._childDirectoryEntries();return r==null||e==null||L(r)?r:await Oi(r,e)}_directoryEntryChild(e){return this.for((0,sn.join)(this.nativePath,e.base),e)}childNames(){return x(this.childDirectoryEntries(),e=>e.map(r=>r.base))}async children(e){return(await this.childDirectoryEntries(e))?.map(r=>this._directoryEntryChild(r))}async childFiles(e){let r=[];for(let i of F(await this.childDirectoryEntries()))if(i.isFile()){let o=this._directoryEntryChild(i);(e==null||await e(o))&&r.push(o)}return r}async childDirectories(e){return x(this.childDirectoryEntries(),r=>Hn(r.filter(i=>i.isDirectory()).map(async i=>Yx(this._directoryEntryChild(i),e))))}childrenSync(){return M(this.trapSync("childrenSync",()=>br.default.readdirSync(this.nativePath).map(e=>this.join(e))),[])}async hasChildren(e){let r=await this.childNames();return C(e)?Gm(r,e):C(r)}async hasNoChildren(){return await this.isFile()||L(await this.childNames())}async visitDescendants(e){return x(this.children(),async r=>{for(let i of r)await i.visitDescendants(e),await e(i)})}async descendants(e){let r=[];for(let o of F(await this.childFiles()))await e(o)&&r.push(o);let i=await this.childDirectories();if(i!=null)return await Jo({name:"descendants",laters:i.map(o=>()=>x(o.descendants(e),n=>r.push(...n)))}),r}async ancestorWithChildren(e){return await this.hasChildren(e)?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}async siblings(e){let r=this.parent();return(await this.siblingDirectoryEntries(e))?.map(i=>r._directoryEntryChild(i))}async siblingDirectoryEntries(e){return this.parent().childDirectoryEntries(async r=>r.base!==this.base&&(e==null||await e(r)))}async selfAndSiblings(){return this.parent().children()}async firstExistingSelfOrAncestor(){return this.isRoot||await this.exists()?this:this.parent().firstExistingSelfOrAncestor()}get pathnames(){return this.nativePath.split(sn.sep).filter(e=>e!=null&&e!=="")}get pathnamesWithoutDrive(){return I?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(I?1:0)}get isRoot(){return this.pathnames.length===(I?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return e!=null&&(this.nativePath===e.nativePath||Hm(e.pathnames,this.pathnames))}isDescendantOf(e){return e!=null&&e.isAncestorOf(this)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){let e=this.parent();return this.isRoot?[]:[...e.parents(),e]}async normalize(){return this.isUNC?this:await this.exists()||this.isRoot?this:x(this.parent().normalize(),async e=>{let r=await e.childNames();if(C(r)){for(let o of r)if(o===this.base)return e.join(o);let i=this.base.normalize();for(let o of r)if(o.normalize()===i)return e.join(o);if(ae||I){for(let o of r)if(Oe(o,this.base))return e.join(o)}}})}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return L(e)||$e(["."],e)?this:_x(e[0])?this.for((0,sn.join)(...e)):this.for((0,sn.join)(this.nativePath,...e))}joinYMD(e=new Date){return Dy(e?.getFullYear(),e?.getMonth(),e?.getDate(),(r,i,o)=>this.join(g(r),Rt(i+1),Rt(o)))}child(...e){if(L(e))return this;let r=Y(e.map(i=>i.split(sn.sep))).filter(i=>i!=="..");return this.join(...r)}async trap(e,r,i="warn"){try{return await mt("fs."+e,r)}catch(o){this.bflog().log(i,`trap: ${e}() failed: ${o}`);return}}async trapOr(e,r,i="warn"){try{return this.bflog().trace(`trapOr ${e}()`),await r(),!0}catch(o){return this.bflog().log(i,`trapOr: ${e}() failed: ${o}`),!1}}trapSync(e,r){try{return this.bflog().trace(`trapSync ${e}()`),r()}catch(i){this.bflog().warn(`trapSync: ${e}() failed: ${i}`);return}}async exists(){return this.dirent!=null||await yx(this.stat())}existsSync(){return this.dirent!=null||this.statSync()!=null}async notExists(){return gt(this.exists())}mtime(){return x(this.stat(),e=>e.mtime)}mtimeMs(){return x(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return x(this.stat(),e=>Di(e.mtime))}async lastModifiedUtc(){return x(this.stat(),e=>e.mtime.toUTCString())}statTimes(){return x(this.stat(),e=>z([e.birthtimeMs,e.mtimeMs,e.ctimeMs].filter(r=>r!=null&&r!==0)))}maxStatMs(){return x(this.statTimes(),pu)}maxStatDate(){return x(this.maxStatMs(),e=>new Date(e))}minStatMs(){return x(this.statTimes(),Gb)}minStatDate(){return x(this.minStatMs(),e=>new Date(e))}size(){return x(this.stat(),e=>e.size)}async access(e){try{return await Je.default.access(this.nativePath,e),!0}catch{return!1}}isExecutable(){return this.access(br.default.constants.R_OK|(I?0:br.default.constants.X_OK))}isReadable(){return this.access(br.default.constants.R_OK)}isNotReadable(){return gt(this.isReadable())}isReadWritable(){return this.access(br.default.constants.R_OK|br.default.constants.W_OK)}isNotReadWritable(){return gt(this.isReadWritable())}isHiddenPosix(){return this.base.startsWith(".")}async isEmpty(e=0){if(await this.isDirectory())return C(await this.childNames());{let r=await this.size();return r==null||r<=e}}isNonEmpty(e=1){return gt(this.isEmpty(e))}async isNonEmptyFile(e=1){return await this.isFile()&&await this.isNonEmpty(e)}async modifiedGTE(e){return x(this.mtime(),r=>Di(r)>=Di(e))}async modifiedCloseTo(e,r){return x(this.mtimeMs(),i=>Math.abs(i-e)<=r)}async isRecent(e){let r=await this.maxStatMs();return r!=null&&r>Date.now()-e}async modifiedGT(e){if(e!=null)return x(this.mtime(),r=>Di(r)>Di(e))}async isDirectory(){return this.dirent!=null?this.dirent.isDirectory():pe(this.stat(),e=>e.isDirectory(),()=>!1)}async isNotDirectory(){return gt(this.isDirectory())}isDirectorySync(){return this.dirent!=null?this.dirent.isDirectory():J(this.statSync(),e=>e.isDirectory(),()=>!1)}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile(){return this.dirent!=null?this.dirent.isFile():this.stat().then(e=>V(e).map(r=>r.isFile()).getOrElse(()=>!1))}isFileSync(){return this.dirent!=null?this.dirent.isFile():V(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>Je.default.rmdir(this.nativePath),e)}async mkdirp_(){try{await Je.default.mkdirp(this.nativePath)}catch(e){if(e.code!=="EEXIST")throw e}if(await yt(()=>this.clear().isDirectory(),{timeoutMs:2*E,timeBetweenMs:200})===!1)throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return await this.clear().isDirectory()||this.isRoot?this:this.trap("mkdirp",async()=>this.mkdirp_())}mkdirpSync_(){return Je.default.mkdirpSync(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",()=>this.mkdirpSync_())}sha(){return x(this.shaResult(),e=>e.b64)}shaMs(){return x(this.shaResult(),e=>e.elapsedMs)}async writeStream_(e,r){return await Kn(A([e,f(r?.onProgress,i=>new _p(i)),Je.default.createWriteStream(this.nativePath,r)])),this.clearThisAndParent()}async writeJsonMaybe(e,r={}){return this.trap("writeJsonMaybe",()=>this.writeJSON_(e,r))}async writeJSON_(e,r={}){return await this.parent().mkdirp(),await Je.default.writeFile(this.nativePath,k(e,r.replacer,r.spaces),w({flag:"w"},r)),this.clearThisAndParent()}readJson(e="warn"){return this.trap("readJson",()=>Kr(async()=>await this.isNonEmptyFile()?Je.default.readJson(this.nativePath):void 0,{maxRetries:1,onRetryWaitUntil:()=>Fi(e==="warn"?250:25),errorIsRetriable:r=>r.errno!==-2}),e)}readJsonSync(){return this.trapSync("readJsonSync",()=>Je.default.readJsonSync(this.nativePath))}readFileSync_(){return Je.default.readFileSync(this.nativePath)}readFile_(){return Je.default.readFile(this.nativePath)}readFile(e="warn"){return this.trap("readFile",()=>this.readFile_(),e)}async zReadFile_(e){return Yp(this.nativePath,e)}async zcat(e){return this.trap("zcat",()=>x(this.zReadFile_(e),g))}async zCopyFile(e,r){return this.trap("zCopyFile",async()=>(await e.parent().mkdirp(),await Qp(this.nativePath,br.default.createWriteStream(e.nativePath),r),e))}readLines(){return x(this.readFile(),e=>yo(e.toString()))}readFileSync(){return dt(()=>f(br.default.readFileSync(this.nativePath),g))}writeTxt_(e){return this.writeFile_(cw(e))}async writeFile_(e){return await this.parent().mkdirp(),await Je.default.writeFile(this.nativePath,e),this.clearThisAndParent()}wip(e=Dw){return this.sibling(e+this.base)}async unwip_(e=Dw){let r=this.sibling(Qe(this.base,e));return this.mv_(r,{overwrite:!0})}async dest(e){let r=e.clear();return v(this.ext)&&T(r.ext)||await r.isDirectory()?r.join(this.base):r}copyFile_(e){return mt("fs.copyFile",async()=>{let r=(await this.dest(e)).clear();if(this.nativePath===r.nativePath)return this;if(await r.parent().mkdirp()==null)return this.bflog().throw("Cannot mkdirp "+r.dir);try{return await this._copyFile(r)}catch(o){if(fx(o))throw o;return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:r.nativePath,error:o}),await this._nativeCopyFile(r)}finally{this.clearThisAndParent()}})}async _copyFile(e){let r,i,o=e;try{let n=await Re(this.stat(),()=>this.clear().stat());if(n==null)return this.bflog().throw("Can't copy missing files"+Nt);if(n.size===0)await e.touch(n.mtime,n.atime);else{if(u.verifyFileCopies.valueOrDefault&&await this.sha()==null)return this.bflog().throw("Can't copy file without SHA"+Nt);i=e.wip();let s=Je.default.copyFile(this.nativePath,i.nativePath);n.size>5*Ai&&(r=new Qn({op:"Copying",path:this.nativePath,dest:e.nativePath},n.size,()=>i.clear().size())),await s;let a=await yt(async()=>n.size===await i.clear().size(),{timeoutMs:G});if(u.verifyFileCopies.valueOrDefault){let m=a&&await yt(()=>Bn(this.sha(),i.clear().sha()),{timeoutMs:G});if(!m)return this.bflog().throw("copyFile_() failed",{sizeMatches:a,shaMatches:m})}if(!a)return this.bflog().throw("copyFile_() failed",{expectedSize:n.size,actualSize:await i.clear().size()});if(o=await i.unwip_(),o==null)return this.bflog().throw("copyFile_("+e+") failed: .unwip() was null");await Je.default.utimes(o.nativePath,n.atime,n.mtime)}try{await Je.default.chmod(o.nativePath,n.mode)}catch(s){this.bflog().debug(`copyFile_(${o.nativePath}) warning: couldn't chmod to ${n.mode}: ${s}`)}return this.bflog().debug(`copyFile_(${e.nativePath}): success`),Ep(this.nativePath,e.nativePath),e}catch(n){throw this.bflog().warn(`copyFile_(${i?.nativePath}) failed: ${n}`),await i?.unlink(),await e.unlink(),n}finally{f(r,n=>n.end())}}async copyTimeoutMs(){return pe(this.size(),e=>Math.max(G,e*Su),()=>G)}async _nativeCopyFile(e){let r;try{if(await e.parent().mkdirp()==null)return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});let i=await this.stat(),o=f(i,n=>n.size);return i==null||o==null?this.bflog().throw("Can't copy missing files"):(o>5*Ai&&(r=new Qn({op:"Copying",path:this.nativePath,dest:e.nativePath},o,()=>e.clear().size())),I?await de.instance().execute(`Copy-Item -LiteralPath ${Zn(this.nativePath)} -Destination ${Zn(e.nativePath)}`,n=>n):await oe("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:await this.copyTimeoutMs()}),Ep(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(i){return this.bflog().throw("_nativeCopyFile("+e+"): "+i)}finally{f(r,i=>i.end())}}async touch(e=Date.now(),r){return this.trap("touch",()=>x(this.ensureFile(),()=>this.utimes(e,r)))}async utimes(e,r){let i=M(e,Date.now()),o=M(r,i);return this.trap("utimes",()=>Je.default.utimes(this.nativePath,Di(o),Di(i)).then(()=>this.clearThisAndParent()))}async unlink(e="warn"){return this.trap("unlink",async()=>(await Je.default.unlink(this.nativePath),this.clearThisAndParent()),e)}async rmrf(e="info"){return this.trap("rmrf",async()=>(this.bflog().log(e,"rmrf()"),await Je.default.remove(this.nativePath),this.clearThisAndParent()))}async unlock(){return ae&&await this.clear().exists()&&await oe("chflags",["nouchg",this.nativePath],{timeout:G}),this}async renameWithNameSuffix_(e){return x(this.withNameSuffix(e).ensureNew_({emptyIsNew:!0}),r=>r.unlink("debug").then(()=>this.mv_(r)))}async mv_(e,r={overwrite:!1}){let i=await this.dest(e);if(this.nativePath===i.nativePath)return this.bflog().warn("mv(): no-op",new Error("internal error")),this;await i.parent().mkdirp(),this.bflog().debug("mv",i);try{await Je.default.move(this.nativePath,i.nativePath,r)}catch(o){this.bflog().warn("mv() try #1 failed. Calling unlock() and waiting for source to be non-empty.",o),await Promise.all([this.unlock(),i.unlock()]),await yt(()=>this.clear().isNonEmptyFile(),{timeoutMs:7*E}),await Je.default.move(this.nativePath,i.nativePath,r)}return await i.unlock(),this.clearThisAndParent(),i.clearThisAndParent()}async pipeTo(e,r){return this.trap("pipeTo("+e+")",async()=>{let i=await this.sibling(e).ensureNew_();return await Kn([br.default.createReadStream(this.nativePath),r,br.default.createWriteStream(i.nativePath)]),await this.unlink(),i})}async gunzip(){return this.pipeTo(ir(this.base,".gz"),(0,Xn.createGunzip)())}async gzip(){return this.pipeTo(this.base+".gz",(0,Xn.createGzip)())}async compressBrotli(){return this.pipeTo(this.base+".br",(0,Xn.createBrotliCompress)())}ensureFile(){return this.trap("ensureFile",()=>Je.default.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync_(){return Je.default.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return Ri(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get baseWithoutCountWithParent(){return this.parent().base+"/"+this.baseWithoutCount}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}async ensureNewNativePath(e){return Eu(w({nativePath:this.nativePath},e))}ensureNew_(e={}){return this.ensureNewNativePath(e).then(r=>this.for(r))}async renameYMDHMS_(e){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");let r=Wy(await Re(this.mtime(),()=>new Date)),i=J(e,o=>this.parent().join(o),()=>this.parent());return this.mv_(i.join(this.name+"-"+r+this.ext),{overwrite:!0})}async saveIfNewOrDelete(e){if(await this.clear().isEmpty()){await this.unlink("trace");return}let r=await this.siblingWithSameContents();if(r!=null)return await this.unlink(),r;let i=await this.sibling(e).ensureNew_();return this.mv_(i)}async chmod(e){return await Je.default.chmod(this.nativePath,e),this.clear()}zreadline(){return br.default.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe((0,Xn.createGunzip)()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)}).pipe(new rd)}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return mt("fs.childWithSameContents",async()=>{if(await this.notExists()||!await this.isDirectory())return;let r=await e.size(),i=await this.children(),o=[];for(let s of F(i))await s.size()===r&&!e.eql(s)&&o.push(s);if(L(o))return;let n=await e.sha();for(let s of o.sort((a,m)=>Ru(a.base,m.base)).reverse())if(await s.sha()===n)return s})}async applyWip(e,r=0,i=15*E){let o=this.wip();try{if(await o.parent().mkdirp(),(await o.clear().isRecent(i)||await this.clear().isRecent(i))&&(this.bflog().info("applyWip(): recent WIP exists. Waiting for a bit to see if someone else will do my work."),await yt(()=>this.clear().isNonEmpty(r),{timeoutMs:i*2,timeBetweenMs:500}))){this.bflog().info("applyWip(): yay, someone else did my work.");return}await this.touch(),await o.unlink("trace");let n=await e(o);if(await yt(()=>o.clear().isNonEmptyFile(),{timeoutMs:E}))return await o.unwip_(),n;throw new Error("applyWip(): empty after apply for "+this)}catch(n){throw await o.unlink(),await this.unlink(),n}}async applyIfEmpty_(e,r=0){return await this.clear().isNonEmpty(r)?this.bflog().debug("applyIfEmpty(): non-empty"):(this.bflog().debug("applyIfEmpty(): empty, applying..."),await this.applyWip(e,r)),this.touch()}firstMatchingLine(e){let r=new gr("firstMatchingLine("+this+")"),i=br.default.createReadStream(this.nativePath,{flags:"r"});return i.on("error",o=>{o.errno===-2||o.code==="ENOENT"?(r.maybeResolve(void 0),i.close()):r.maybeReject(o)}),i.on("close",()=>r.maybeResolve(void 0)),nn(i,oo,o=>{let n=e.exec(o);n!=null&&(r.maybeResolve(n),i.close())}),r.promise}contemporary(e,r){return Ys(this.statTimes(),e.statTimes(),(i,o)=>{for(let n of i)for(let s of o)if(qm(n,s,r))return!0;return!1},()=>!1)}},Me=$r;Me.attrTTL=3*D,Me.projectRoot=l(()=>{let e=Lr.Root();if(e==null)throw new Error("Cannot find project path");return $r.for(e)});function zu(t){let e=A(t).filter(([r,i])=>r!=null&&i!=null);return new Map(e)}function Il(t,e){return zu(A(t).map(e))}async function Aw(t,e){if(t==null)return new Map;let r=await Promise.all(A(F(t)).map(i=>e(i)));return zu(r)}var es=S(require("process"));function rt(t){return g(t).replace(/[-.,\\^$*+?()|[\]{}]/g,"\\$&")}function Fw(t){return t.replace(/[ââ']/g,"[\u2018\u2019']").replace(/[ââââÂ«Â»ã"]/g,'[\u201C\u201D\u201E\u201D\xAB\xBB\u3003"]')}function Lw(t,e){let r=[];for(let i of t)try{new RegExp(i),r.push(i)}catch{r.push(rt(i))}return new RegExp(r.join("|"),e)}var Iw=class{constructor(e){this.h=e;this.text=M(e.text,g(e)),this.greedyLeft=M(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}},ad=l(()=>h("Fixed"));function bo(t,e,r=!0){return new Ow(t,e,r).entries}var Ow=class{constructor(e,r,i=!0){this.warnIfMissingHeaders=i;let o=r.split(/[\r\n]{1,2}/);this.headerRow=o[0],this.rows=o.slice(1);let n=Math.max(...this.rows.map(s=>s.length));this.col2blanks=new Map(ce(n,s=>[s,Sr(this.rows,a=>T(a[s]))])),this.headers=this.extractHeaders(e.map(s=>new Iw(s))),this.entries=this.rows.map(s=>this.headers.map(a=>a.toEntry(s))).map(s=>st(s)).filter(s=>pt(s).some(v))}extractHeaders(e){let r=this.headerRow;$(e,s=>-s.text.length),e.forEach(s=>{let a=new RegExp(`\\b${rt(s.text)}\\b`,"i"),m=a.exec(r);m==null?this.warnIfMissingHeaders&&ad().warn("extractHeaders(): Failed to find header!",{re:a,headerLine:r}):(s.indexOf=m.index,r=Fb(r,m.index,s.text.length," "))});let i=e.filter(s=>s.indexOf!=null),o=$(i,s=>s.indexOf);o.forEach((s,a)=>{let m=s.indexOf,c=o[a-1],p=a===0?0:c.indexOf+c.text.length-1,[d,y]=s.greedyLeft?[p,m]:[m,p];s.leftIdx=f(this.firstBlankColumn(d,y),P=>P+1),a===0&&s.leftIdx==null&&(s.leftIdx=0),s.leftIdx==null&&ad().warn("no blank column for "+s.text+" between "+m+" and "+p)}),ft(o,s=>s.leftIdx!=null),o.slice(0,-1).forEach((s,a)=>{let m=o[a+1];s.rightIdx=m.leftIdx-1});let n=F(Hb(e.map(s=>s.text),o.map(s=>s.text)));return n.length>0&&ad().warn("Missing headers",{missingHeaders:n}),o}firstBlankColumn(e,r){return io(e,r).find(i=>this.col2blanks.get(i)===this.rows.length)}};var Uu=()=>"wmic",kw=()=>"fsutil";var Rw=()=>"ping";var CL=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;function _w(t){let e=CL.exec(t);if(e==null)return;let r=e.slice(1,8).map(d=>H(d));if(!zm(r))return;let[i,o,n,s,a,m,c]=r,p=H(e[8],{defaultValue:0});return new Date(Date.UTC(i,o-1,n,s,a,m,c/1e3)-p*D)}var VL=/Date\((\d+)\)/;function Nw(t){return V(t).flatMap(e=>VL.exec(e)).flatMap(e=>e[1]).flatMap(H).filter(e=>ht(0,Date.now()+ot,e)).map(e=>new Date(e)).get()}var zL=l(()=>h("Ps"));function UL(t){return t!=null&&N(t.pid)&&t.start!=null&&v(t.cmd)}async function Bw(t){return x(Ol([t]),e=>F(e).find(r=>r.pid===t))}async function Cw(t){return L(t)||jm([es.default.pid],t)?F(t):x(Ol(t),e=>e.map(r=>r.pid))}async function Ol(t){let e=F(t).filter(N);if(L(e))throw new Error("Invalid pids: "+k(t));return Db(x(I?qL(e):WL(e),r=>r.filter(i=>UL(i)&&e.includes(i.pid))),r=>zL().debug("pidInfo()",{pids:e,result:r}))}function jL(t){return t.map(e=>({pid:e.Id,start:Nw(e.StartTime),cmd:e.ProcessName}))}var HL="Get-Process",GL="| Select-Object -Property Id,ProcessName,StartTime";function Vw(t){return z([...t.filter(N),es.default.pid]).join(",")}async function qL(t){if(me()||de.instance().ended)return KL(t);let e=[HL,"-Id",Vw(t),"-ErrorAction SilentlyContinue",GL].join(" ");return x(de.instance().executeJsonToA(e),r=>jL(r))}var zw={maxBuffer:1024*1024,timeout:15*E,ignoreExitCode:!0,ignoreStderr:!0},Uw=["CommandLine","CreationDate","ProcessId"];async function KL(t){let e=["process"];if(C(t)){let o=z([...t.filter(N),es.default.pid]).map(n=>`ProcessId=${n}`).join(" or ");e.push("where",o)}e.push("get",Uw.join(","));let r=await qe(Uu(),e,zw),i=$y(bo(Uw,r.result).map(o=>({pid:H(o.ProcessId,{defaultValue:-1}),start:_w(o.CreationDate),cmd:g(o.CommandLine)})));return i.find(o=>o.pid===es.default.pid)||i.push({pid:es.default.pid,start:new Date(Us),cmd:"node "+es.default.title}),i}function JL(t){return bo(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],t).map(e=>({pid:H(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:g(e.COMMAND)}))}async function WL(t){let e=await qe("ps",["-p",Vw(t),"-wwwo","pid,lstart,command"],w(w({},zw),{ignoreExitCode:!0}));return JL(e.result)}var qw=S(require("path")),Ww=S(require("process"));function Ni(){return Zt(Ww.env.PS_CONFIG_DIR,()=>(0,qw.resolve)(na(),mo().toLowerCase()))}var Bi=l(()=>h("Pids")),$L=10*E;function Hw(t,e){if(t==null||e==null)return!1;let r=f(e.start,o=>o.getTime()),i=t.startTime;return N(r)&&N(i)&&Math.abs(r-i)<$L}async function QL(t,e){return t==null||e==null||t.name!==g(e.pid)?!1:Hw(await t.readJson(),e)}function Gw(t,e=!1){let r=["/PID",g(H(t)),"/T"];e&&r.push("/F"),jw.default.execFile("taskkill",r)}async function YL(t,e=!1){if(me()||de.instance().ended)return Gw(t,e);try{let r=A(["Stop-Process","-Id",H(t),e?"-Force":void 0]).join(" ");await de.instance().execute(r,Ar)}catch(r){Bi().warn("killWin(): pwsh error, using TASKKILL: "+r),Gw(t,e)}}async function XL(t,e=!1){try{kl.default.kill(t,e?"SIGKILL":"SIGTERM")}catch(r){if(!String(r).includes("ESRCH"))throw r}}function qu(t,e=!1,r=!0){if(t===kl.default.pid||t===kl.default.ppid)throw new Error("cannot self-terminate");return e&&r&&an.instance().onKill(t),I?YL(t,e):XL(t,e)}async function Wu(t){return await Bw(t)!=null}var ld=class{constructor(e=Me.for(Ni()).join("pids")){this.pidsDir=e;this.p=new Ii;this.recentPids=new _e(10*E);this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",async()=>{let r=M(e.everything,!1),i=M(e.force,I),o=await this.pidfiles(),n=await Aw(o,y=>x(y.readJson(),P=>[P.pid,P])),s=z(Y(F(n.values()).map(y=>[y.pid,y.ppid])));if(L(s))return Bi().debug("killOldProcs(): no pidfiles"),[];let a=await Ol(s);if(Bi().debug("killOldProcs()",{pids:s,allEntries:a}),a==null){se("Pids.killOldProcs(): failed to get process information");return}let m=new Set(a.map(y=>y.pid)),c=a.filter(y=>n.has(y.pid)),p=$(A(c.map(y=>f(n.get(y.pid),P=>Hw(P,y)?w(w({},P),y):void 0))),y=>y.pid).filter(y=>kl.default.pid!==y.pid),d=r?p:p.filter(y=>!m.has(y.ppid)||!m.has(y.pid)||N(y.timeoutTime)&&Date.now()>=y.timeoutTime||e.everythingBefore!=null&&y.startTime<e.everythingBefore);Bi().debug("killOldProcs()",{trackedEntries:c,victims:d,pidfiles:F(n.values())});for(let y of d)Bi().debug("killOldProcs(): killing",{entry:y}),qu(y.pid,i,!1);return await this.vacuumPids(),$(d,y=>y.pid)})}async addPid(e,r,i=!1){if(e==null)throw new Error("undefined info");let o=e.pid;if(!N(o))throw new Error("undefined pid");let n=e.ppid+":"+e.pid;return i&&this.recentPids.delete(n),this.recentPids.getOrSet(n,async()=>{let s=this.pidsDir.join(e.pid+".json"),a=V(dt(()=>pi(e.cmd).base)).filter(v).getOrElse(()=>e.cmd),m=r.getTime(),c=ge(e.maxAgeMs,d=>m+d),p=w(w({},e),{cmd:a,startTime:m,timeoutTime:c});return await s.writeJsonMaybe(p)==null?Bi().throw("Failed to write to "+s,{info:e,force:i}):(Bi().debug("addPid() wrote "+s,p),s)})}pidfiles(){return this.pidsDir.clear().children(e=>e.ext===".json"&&H(e.name)!=null)}async onKill(e){let r=this.pidsDir.join(e+".json");return x(r.clear().readJson(),i=>this.addPid(w(w({},i),{maxAgeMs:1}),qy(D),!0).catch(o=>{Bi().info("onKill(): failed to rewrite pidfile: "+o,{pid:e})}))}async vacuumPids(){let e=await this.pidfiles(),r=F(e).map(o=>H(o.name)).filter(N);if(L(r))return;let i=await Ol(r);if(i==null){se("Failed to get pidInfo for pids "+r);return}Bi().debug("vacuumPids",{pids:r,pidfiles:F(e).map(o=>o.base),entries:i});for(let o of e){let n=i.find(s=>g(s.pid)===o.name);(n==null||!await QL(o,n))&&(Bi().debug("vacuumPids(): Removing old pidfile "+o.base,{psEntry:n,pidfile:await o.readFile().then(g).catch(s=>"(failed to read file: "+s+")")}),await o.unlink())}}},an=ld;an.instance=l(()=>new ld);function ju(t,e){return an.instance().addPid(t,e)}var jK=l(()=>{let t=[{everything:!1,force:!1,intervalMs:5*D},{everything:!1,force:!0,intervalMs:17*D}].map(e=>jr(()=>an.instance().killOldProcs(e),e.intervalMs));return new Pt("ProcCleaner",()=>(t.map(clearInterval),an.instance().killOldProcs()),be.predb)});var Rl=he("AboveNormal","Normal","BelowNormal","Idle"),md=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19});var ts=class{constructor(e){this.ttlMs=e;this.expireListeners=[];this.delegate=new Map;this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,r=this.ttlMs){return this.delegate.set(e,Date.now()+(r-this.ttlMs)),this}addIfMissing(e,r){let i=this.delegate.get(e);if(i==null||this.isEntryExpired(e,i))return this.add(e),r()}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(let[r,i]of this.delegate)this.isEntryExpired(r,i)||e(r,r,this)}has(e){return!this.isEntryExpired(e,this.delegate.get(e))}values(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield i)}return r()}entries(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield[i,i])}return r()}toA(){return this.vacuum(),[...this.delegate.keys()]}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}on(e,r){this.expireListeners.push(r)}isEntryExpired(e,r){return vt(r==null||r+this.ttlMs<=Date.now(),i=>{r!=null&&i&&(this.expireListeners.forEach(o=>o(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,r)=>{this.isEntryExpired(r,e)})}};var Kw=l(()=>h("Renice"));W(()=>j(()=>ud.prior()?.clear()));var ud=l(()=>new ts(D));async function Hu(t){if(ud().has(t))return;ud().add(t);let e=u.processPriority.valueOrDefault;return ge(t,async()=>{try{await(I?ZL(t,e):eI(t,M(md[e],md.BelowNormal))),Kw().info("Renice pid "+t+" to "+e)}catch(r){Kw().info("Failed to renice pid "+t+"",r);return}})}async function ZL(t,e){return ge(t,r=>Rl.mapValid(e,i=>de.instance().execute(`(Get-Process -Id ${t}).PriorityClass = "${e}"`,o=>o)))}async function eI(t,e=19){return qe("renice",[e,"-p",t].map(g),{timeout:10*E,isIgnorableError:()=>!0,ignoreExitCode:!0,maxRetries:0})}var tT=S(require("process"));var $w=S(require("process"));var Ci=class{constructor(e){this.a=e}async _map(e,r){let i=this.a!=null?await this.a():void 0,o=cd(i)?await i.get():i;return o!=null?e(o):r()}async isDefined(){return this._map(()=>!0,()=>!1)}async isEmpty(){return this._map(()=>!1,()=>!0)}async get(){return this._map(e=>e,()=>{})}async getRequired(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}async exists(e){return this._map(e,()=>!1)}map(e){return new Ci(async()=>this._map(e,()=>{}))}flatMap(e){return new Ci(async()=>this._map(e,()=>{}))}filter(e){return new Ci(async()=>this._map(async r=>await e(r)?r:void 0,()=>{}))}catch(e){return new Ci(()=>this.get().catch(async r=>e(r)))}forEach(e){return new Ci(async()=>{let r=await this.get();return await f(r,e),r})}async getOrElse(e){return M(await this.get(),e)}orElse(e){return new Ci(async()=>{let r=await this.get(),i=r??await e();return cd(i)?i.get():i})}};function cd(t){return t instanceof Ci}function bt(t){return cd(t)?t:new Ci(()=>t)}var Jw;(function(r){r.and=async(...i)=>{for(let o of i)if(!B(await o()))return!1;return!0},r.or=async(...i)=>{for(let o of i)if(B(await o()))return!0;return!1}})(Jw||(Jw={}));async function Ct(...t){if(t!=null)for(let e of t){if(e==null)continue;let r=await e();if(r!=null)return r}}var Qw="en",Xw=l(async()=>fd(await Ct(()=>Yw(),()=>I?tI():void 0,()=>ae?rI():void 0,()=>Xs?iI():void 0)));function Yw(t=$w.default.env){return Ay(t.LC_ALL,t.LC_MESSAGES,t.LANG,t.LANGUAGE)}var oI=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function fd(t){if(T(t)||Oe("c",t)||Oe("posix",t))return Qw;{let e=oI.exec(t);return e==null?Qw:A([e[1],e[2]]).join("-")}}function tI(){return x(de.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),t=>t.Name)}var Zw={timeout:10*E};function rI(){return bt(oe("defaults",["read","-globalDomain","AppleLocale"],Zw)).flatMap(fd).get()}var nI=/^([a-z_]+)\s*=\s*"(.+)"$/i;function iI(){return bt(oe("locale",[],Zw)).flatMap(t=>t.split(`
`).map(e=>f(e.match(nI),r=>[r[1],r[2]]))).flatMap(st).flatMap(Yw).flatMap(fd).get()}function eT(){return{LANG:"C",LC_ALL:"C"}}var q8=l(()=>new Set(pt(u).map(t=>t.key)));var iT=l(()=>_l().filter(t=>t.hasValue()));function sI(){iT.unset()}var oT=l(()=>{try{return new RegExp(u.sensitiveEnvRegExp.valueOrDefault,"i")}catch(t){return console.error(`Invalid setting for "sensitiveEnvRegExp": ${t}. Using default value.`),new RegExp(u.sensitiveEnvRegExp.defaultValue,"i")}});W(()=>{u.sensitiveEnvRegExp.addListener(()=>{oT.unset(),nT.unset()});for(let t of _l())t.addListener(sI)});var nT=l(()=>{let t=oT();return hu(tT.default.env,(e,r)=>t.exec(e)!=null?void 0:r)});function aI(){return iT().reduce((t,e)=>e.maybeAddToEnv(t),w(w({NODE_ENV:zs},Ce()?{PS_IS_DOCKER:"1"}:{}),fi?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}))}function dd(t){let e=M(t,{}),r=M(e.forceCLocale,!0);return w(w({},kt(e,"forceCLocale")),{env:pd(e.env,r),detached:!1,shell:!1})}function pd(t,e){let r=oi(w(w(w(w(w({},nT()),{PATH:rT()}),e?eT():{}),aI()),M(t,{})));return u.logStdout.deleteFromEnv(r),u.tailLogs.deleteFromEnv(r),r}var Vt=l(()=>h("ChildProcess"));function Gu(t){return at(t,"pid","killed","connected","exitCode","signalCode")}function sT(t,e){return yt(()=>gt(Wu(t)),{timeoutMs:e})}async function Nl(t,e=30*E){if(t==null)return!1;let r=t.pid;if(Vt().debug("endProcess("+r+")",{killed:t.killed,connected:t.connected}),r<=0)return Vt().warn("endProcess(): asked to end invalid pid",Gu(t)),!1;if(r===gd.default.pid)return Vt().warn("endProcess(): asked to end MY pid",Gu(t)),!1;await Fi(250),await Ex(t);{let i=t.kill();Vt().debug("endProcess("+r+")",{killResult:i,childGotSigterm:t.killed}),i||await qu(r).catch(o=>{Vt().warn("endProcess(): kill("+r+",false) failed: "+o)})}if(dt(()=>t.unref()),Nn())return!0;if(await sT(r,e))return Vt().debug("endProcess(): exitted",Gu(t)),!0;{an.instance().onKill(r);let i=t.kill("SIGKILL");Vt().warn("endProcess("+r+") had to resort to SIGKILL",{killResult:i}),i||await qu(r,!0).catch(o=>{Vt().warn("endProcess(): kill("+r+",true) failed: "+o)})}return sT(r,5e3)}function lI(t,e){return t!=="renice"&&t!=="which"&&t!=="where"&&[t,...e].every(r=>!r.endsWith("web.js")&&!r.endsWith("db.js")&&!r.includes("sqlite3"))}function aT(t,e,r,i){let o=new Date,n=!1;t.on("exit",()=>n=!0);let s=lI(e,r);return $s(async()=>{if(n)return;await yt(()=>N(t.pid),{timeoutMs:5*E});let a=t.pid;if(N(a))return s&&await Hu(a),ju({pid:a,cmd:e,maxAgeMs:i,ppid:gd.default.pid},o);Vt().info("newProc(): not writing pidfile, child_process has no pid",{cmd:e,cp:Gu(t)})},I?500:250),t}function lT(t,e,r,i){let o=dd(i);return Vt().debug("spawn()",{command:t,args:e,maxAgeMs:r,opts:o}),aT(hd.default.spawn(t,e,o),t,e,r)}function ln(t,e,r,i){let o=dd(i);return aT(hd.default.execFile(t,e,o),t,e,r)}async function qe(t,e,r){return Kr(()=>mI(t,e,r),{timeoutMs:r.timeout,maxRetries:M(r.maxRetries,3),onRetryWaitUntil:i=>lt(100*i),errorIsRetriable:i=>Vt().tap({msg:"stdoutResult.errorIsRetriable()",result:Jx(i,/EPERM/),meta:{error:i,cmd:t,args:e}})})}async function mI(t,e,r){let i=M(r.quiet,!1),o=M(r.ignoreStderr,!1),n=M(r.ignoreExitCode,!1),s=[];Vt().debug("stdoutResult(): execFile",{cmd:t,args:e});let a=await ln(t,e,r.timeout,kt(r,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(r.disconnect===!0)return a.disconnect(),{result:"",pid:a.pid};let m=k({cmd:t,args:e}),c=new gr(m);setTimeout(()=>{c.pending&&Vt().warn("stdoutResult(): SLOW COMMAND",{cmd:t,args:e})},r.timeout/3).unref(),c.setTimeout(r.timeout);let p=(d,y)=>{if(nr(y)||xe(r.isIgnorableError)&&r.isIgnorableError(y)){Vt().debug("stdoutResult(): ignorable error for "+d,{cmd:t,args:e,opts:r,error:y});return}a.pid!=null&&Nl(a),i||Vt().warn("stdoutResult(): "+d,{cmd:t,args:e,opts:r,error:y}),c.pending&&c.reject(y)};try{a.on("error",d=>p("on(error)",d)),a.on("close",d=>{let y=Date.now()-c.start,P=d!==0?"warn":"debug",_=s.join("");i||Vt().log(P,"stdoutResult(): on(close)",{cmd:t,code:d,args:e,elapsedMs:y,result:Ob(_,160,160)}),!n&&d!==0?c.reject(new Error("non-zero exit code: "+k({code:d,cmd:t,args:e}))):c.resolve({result:_,code:Is(d),pid:a.pid})}),ki(a.stdin),a.stdout?.on("data",d=>{d!=null&&s.push(d)}),a.stderr?.on("error",d=>p("stderr(error)",d)),a.stderr?.on("data",d=>o?Vt().warn("stdoutResult(): stderr(data): "+g(d)):p("stderr(data)",d))}catch(d){p("try/catch",d)}return await c.promise}function oe(t,e,r){return qe(t,e,r).then(i=>i.result)}var Bl=class extends Pt{constructor(e,r,i=be.service,o=!1){super(e,()=>this.t.end(),i,()=>this.t.ended,e==="sync-file"?G:E);this.name=e;this.t=r;r.on("childStart",n=>{this.logger.info("Started child process "+e+":"+n.pid),Hu(n.pid).catch(s=>this.onError("renice failed for "+e,s)),o&&n.on("exit",()=>Nl(n,5*E)),ju({pid:n.pid,ppid:mT.default.pid,cmd:e,maxAgeMs:r.options.maxProcAgeMillis+D},new Date).catch(s=>this.onError("addPid failed for "+e,s))}),r.on("startError",n=>{this.lastStartError=n,this.onError("failed to start",n)}),r.on("taskError",(n,s)=>{this.lastTaskError=n,this.onError("failed to run "+f(s,a=>a.command),n)}),r.on("internalError",n=>{this.lastInternalError=n,this.onError("internal error",n)}),r.on("endError",n=>{this.logger.error("observeBatchCluster.endError()",n)})}onError(e,r){!this.t.ended&&!me()&&!nr(r)?se(this.name+": "+e,r):this.logger.warn("onError() (ending or ignorable): "+e,r)}};var Ku=24;function rs(t,e=2){if(e<=0)return t;if(t!=null)return Cm(t)?t:Array.isArray(t)?uI(t):Vr(t)?t:xu(t)?w(w({},t),{stack:Fp(t.stack)}):Vm(t)?hu(t,(r,i)=>rs(i,e-1)):t}function uI(t,e=rs){if(t!=null)return t.length<=Ku?t.map(e):[...t.slice(0,Ku).map(e),`\u2026 (${t.length} total items)`]}var Vi=he("error","warn","info","debug","trace"),uT=st(Vi.values.map((t,e)=>[t,e]));function Cl(t){return uT[t]??uT.trace}var cI=l(()=>Vi.values.filter(t=>t!==Vi.trace)),fI=48,yd=l(()=>st(cI().map(t=>[t,new ul(fI)])));function cT(){pt(yd()).forEach(t=>t.clear())}function fT(t){yd()[t.l]?.push(t)}function pT(){let t=[];for(let e of pt(yd()))t.push(...e.toA());return $(t,e=>e.ts)}function pa(t,e){return t>=e?"error":t>=e/2?"warn":t>=e/4?"info":"debug"}var pI=/^[a-z]*/i,Vl=class{constructor(e,r){this.context=e;this.loggers=r;this.error=(e,r)=>{this.log("error",e,r)};this.warn=(e,r)=>{this.log("warn",e,r)};this.info=(e,r)=>{this.log("info",e,r)};this.debug=(e,r)=>{this.log("debug",e,r)};this.trace=(e,r)=>{this.log("trace",e,r)};this.filterContext=J(pI.exec(g(this.context)),i=>i[0],()=>this.context)}addContext(e){return new Vl(this.context+e,this.loggers)}throw(e,r){let i=Li(e)||r?.fatal,n=!(r?.retriable===!1)&&Lp(e),s=nr(e)||r?.ignorable;r=r==null?void 0:rs(kt(r,"fatal","retriable","ignorable"));let a=new ue({cause:bu(e),message:R([this.context,r==null?void 0:k(r)]).join(" "),fatal:i,retriable:n,ignorable:s});throw this.log(s===!0?"warn":"error",ci(e),r),a}tap(e){return this.log(M(e.level,"debug"),e.msg,w({result:e.result},e.meta)),e.result}log(e,r,i){if(i=rs(i),mn().enabled(e,this.context))for(let o of this.loggers())o.log(e,this.context,r,i);else e!=="trace"&&fT({ts:Date.now(),l:e,ctx:this.context,msg:r,meta:i})}async flush(){for(let e of this.loggers())await e.flush()}async end(){for(let e of this.loggers())await e.end()}};var dI=10*D,dT="{ready}",hT=" | ConvertTo-Json -Compress";function Zn(t){let e=t.replace(/['`"ââ#]/g,r=>"`"+r).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v");return'"'+e+'"'}function hI(){return[`function prompt {"${dT}"}`,...ii(u.powerShellCulture.valueOrDefault,t=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${t}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${t}'`],[])].join(";")}W(()=>j(()=>de.instance.prior()?.clearMockResults()));var bd=class{constructor(){this.name="PowerShell";this.logger=h("PowerShell");this.mockResults=new Map;this.bco=new Bl("PowerShell",new Ju.BatchCluster({processFactory:()=>ln("powershell",u.powerShellArgs.values,dI),logger:()=>h("PowerShell"),versionCommand:hI(),pass:dT,fail:"Error",exitCommand:"exit",maxProcs:Ft()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:G,cleanupChildProcs:!1}),be.postdb),this.pwsh=this.bco.t}get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return x(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,r){this.pushMockResult(Ht(e,hT),r)}pushMockResult(e,r){this.mockResults.set(e,r)}clearMockResults(){this.mockResults.clear()}async execute(e,r){if(this.pwsh.ended||me()){this.logger.warn("execute() failed (ended)",{cmd:e});return}if(Te&&this.mockResults.has(e)){let i=this.mockResults.get(e);return r(i.stdout,i.stderr,i.passed)}try{this.logger.debug("execute()",{cmd:e});let i=await Jr(()=>this.pwsh.enqueueTask(new Ju.Task(e,(o,n,s)=>r(f(o,a=>Qe(a,e)),n,s))));return this.logger.log(pa(i.elapsedMs,7*E),"execute()",{cmd:e,elapsedMs:i.elapsedMs}),i.result}catch(i){this.logger.warn("execute() failed: "+i,{cmd:e});return}}async executeJson(e){let r=await this.execute(Ht(e,hT),(i,o,n)=>({stdout:i,stderr:o,passed:n}));if(r==null){this.logger.warn("executeJson(): null result",{cmd:e});return}if(T(r.stdout)||v(r.stderr)||!r.passed){this.logger.warn("executeJson(): failed result",w({cmd:e},r));return}try{return JSON.parse(r.stdout)}catch(i){let o=r.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:dr(r.stdout),after:dr(o)}),JSON.parse(o)}}async executeJsonToA(e){return x(this.executeJson(e),r=>Array.isArray(r)?r:[r])}},de=bd;de.instance=l(()=>{if(!I)throw new Error("PowerShell isn't available on this platform");return new bd});async function gI(){return I?de.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}var yT=l(async()=>{if(I){let t=await gI();if(v(t))return t}return $u()}),$u=l(()=>(0,gT.resolve)(di(),"Pictures"));var bT=["7artisans","Bower","Canon","Carl Zeiss","Cosina","Fuji","Fujifilm","Goerz","Hasselblad","Hirox","Hoya","Konica","Leica","Leidolf","Lensbaby","Meike","Meopta","Minolta","Neewer","Nikon","Olympus","Opteka","Panasonic","Pentacon","Pentax","Ricoh","Rodenstock","Rokinon","Ross","Samsung","Samyang","Seiko","Sigma","Silor","Soligor","Sony","Sunpak","Tamron","Tiffen","Tokina","Topcon","Venus","Voigtl\xE4nder","Wray","Yongnuo","Zhong Yi","Zuiko"];var zl=["EXIF","EXV","MIE","XMP"];var xT=S(require("path")),xo=S(require("process"));function xd(t){return g(t).replace(/([A-Z])([a-z])/g,(e,r,i)=>"_"+r.toLowerCase()+i).replace(/[A-Z]+|[0-9]+/g,e=>"_"+e).replace(/^_/,"")}function yI(t){return"PS_"+xd(t).toUpperCase()}var rJ=V(w({},xo.env)).map(t=>Er?Object.freeze(t):t).get(),b=he("Paths","Logging","Networking","Processes","Tools","Updates","Desktops","Volumes","Db","HealthChecks","Filters","Previews","Reporting","Deduping","Sidecars","Sync","Tagging","Web","Subscriptions"),Ul=Object.freeze([b.Db,b.HealthChecks,b.Filters,b.Previews,b.Reporting,b.Deduping,b.Sidecars,b.Sync,b.Tagging,b.Web,b.Subscriptions]),wd=Object.freeze(b.values.filter(t=>!Ul.includes(t))),wo=t=>v(t)&&t!=="undefined"?g(t).trim():void 0,Ir=class{constructor(e){this.opts=e;this._persist=!1;this.listeners=[]}hasValue(){return this._value!=null}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){let r=M(e,xo.env);for(let i of[this.key,...F(this.opts.envAliases)]){let o=f(r[i],n=>this.opts.fromEnv(n));if(o!=null)return o}}importFromEnv(e=xo.env){if(!this._persist)return f(this.readFromEnv(e),r=>this.setValue(r))}importFromFile(e){if(!(this.hasValue()&&!this._persist))return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){ft(this.listeners,r=>r===e)}onChange(){let e=this.value;this.listeners.forEach(r=>r(e))}get name(){return this._name}_setName(e){if(this._name!=null)throw new Error("cannot set name twice");this._name=e,this._key=yI(e),this.importFromEnv()}get persist(){return this._persist}get key(){return this._key}get category(){return this.opts.category}get categoryType(){return Ul.includes(this.category)?"library":"system"}get transient(){return this.opts.transient===!0}get advanced(){return J(this.opts.advanced,e=>e(),()=>!0)}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}maybeSetValue(e){e!=null&&(this.value=e)}set valueAndEnv(e){this.value=e,this.addToEnv(xo.env,e)}get envValueOrDefault(){return this.opts.toEnv(this.valueOrDefault)}set tmpValue(e){this._persist=!1,this.addToEnv(xo.env,e),this.setValue(e)}set tmpValueIfUnset(e){this.isUnset()&&(this.tmpValue=e)}setValue(e){let r=this._value,i=this.opts.toEnv(e),o=this.opts.fromEnv(i);return this._value=o,$e(r,this._value)||this.onChange(),this._value}get defaultValue(){return pr(this.opts.defaultValue)}get exampleValue(){return V(this.opts.exampleValue).flatMap(e=>e()).filter(v).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return this.value!=null?this.value:this.defaultValue}maybeAddToEnv(e,r){let i=M(e,xo.env);return this.hasValue()&&(i[this.key]=wo(this.opts.toEnv(M(r,this.valueOrDefault)))),i}addToEnv(e,r){let i=M(e,xo.env);return i[this.key]=wo(this.opts.toEnv(M(r,this.valueOrDefault))),i}deleteFromEnv(e){let r=M(e,xo.env);return delete r[this.key],f(this.opts.envAliases,i=>i.forEach(o=>{delete r[o]})),r}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),h("Settings."+this.name).info(".unset()"),this}addToJSON(){return{}}toJSON(){return{key:this.key,value:this.value,defaultValue:this.opts.defaultValue}}},un=class extends Ir{constructor(e){super(w({toEnv:wo,fromEnv:wo,defaultValue:void 0},e))}hasValue(){return v(this.value)}};function wT(t){return t==null?void 0:t.trim()}var Ye=class extends Ir{constructor(e){super(w({toEnv:wT,fromEnv:wT},e))}hasValue(){return v(this.value)}};function Td(t,e){let r=g(t).toLowerCase();return e.find(i=>i.toLowerCase()===r)}var To=class extends Ir{constructor(e){super(w({toEnv:i=>Td(i,e.validValues),fromEnv:i=>Td(i,e.validValues)},e));if(this.validValues=e.validValues,this.defaultValue!=null&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}};function bI(t){return U(g(t).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return Y(JSON.parse(e)).map(g)}catch{}for(let r of["\xA6",xT.delimiter])if(e.includes(r))return e.split(r);return[e]})}function TT(t){return Os(t)?void 0:Ae(bI(t),ql)}function xI(t){return Ae(ql(t),k)}function ql(t){return z(_s(t))}var Fe=class extends Ir{constructor(e){super(w({defaultValue:[],fromEnv:TT,toEnv:xI},e))}push(...e){this.value=ql([...this.valueOrDefault,...e])}get values(){return ql(this.valueOrDefault)}set values(e){this.value=ql(e)}removeValueFromEnv(e){f(this.value,r=>this.tmpValue=r.filter(i=>i!==e))}};function wI(t,e){return MT(TT(t),e)}function MT(t,e){if(t==null)return;let r=[];for(let i of t){let o=Td(i,e);o!=null&&r.push(o)}return r}var Md=class extends Ir{constructor(e){super(w({fromEnv:r=>wI(r,e.validValues),toEnv:r=>f(r,i=>k(z(i)))},e));this.validValues=e.validValues}asValidValues(e){return MT(e,this.validValues)}addToJSON(){return{validValues:this.validValues}}},Ne=class extends Ir{constructor(e){super(w(w({},e),{toEnv:wo,fromEnv:H}))}};var Qu=class extends Ir{constructor(e){super(w(w({},e),{toEnv:wo,fromEnv:Wr}))}},It=class extends Ir{constructor(e){super(w(w({},e),{toEnv:wo,fromEnv:r=>V(r).flatMap(parseInt).map(i=>Z(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},is=class extends Ir{constructor(e){super(w(w({},e),{toEnv:wo,fromEnv:r=>V(r).flatMap(parseFloat).map(i=>Z(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},O=class extends Ir{constructor(e){super(w(w({},e),{toEnv:wo,fromEnv:Yy}))}};var ha=require("process"),ST=Object.freeze(["/usr/local/sbin","/usr/local/bin","/opt/local/sbin","/opt/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),Yu=l(()=>Er),lr=()=>!Yu(),TI=Object.freeze(I?[...ii(ha.env.SYSTEMROOT,t=>[t,(0,da.join)(ha.env.SYSTEMROOT,"System32"),(0,da.join)(ha.env.SYSTEMROOT,"System32","webm")],()=>[]),"C:\\cygwin64\\bin"]:ST),u={copyAssetsToLibrary:new O({category:b.Paths,description:`Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page's "May PhotoStructure organize your photos and videos?" section. Read more about this setting here: <https://photostructure.com/getting-started/automatic-library-organization/>.`,defaultValue:!0,advanced:()=>!1}),libraryPath:new un({envAliases:["PS_LIBRARY","PS_LIBRARY_DIR"],category:b.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>lr()?"/home/test/Pictures":Ce()?"/ps/library":$u(),defaultValue:()=>Ce()&&!lr()?"/ps/library":void 0,advanced:()=>!1}),previewsDir:new Ye({category:b.Paths,description:`This is the directory that PhotoStructure uses to store preview images. This defaults to the ".photostructure/previews" directory inside your PhotoStructure library. Absolute paths here are supported, but if you keep your library and previews directory separated, take care when you open your library on different computers, as this setting needs to be adjusted for those computers as well.
NOTE: "originalDirs" is recommended instead of this setting; If you get "previewsDir" wrong, your library won't work. If you get "originalsDir" wrong, you just break full-screen zoom and non-transcoded videos.`,defaultValue:()=>".photostructure/previews"}),originalsDir:new Ye({category:b.Paths,description:`This is the directory that PhotoStructure uses to store original images when "copyAssetsToLibrary" is enabled. Absolute paths are supported. Relative paths are evaluated from your libraryPath. This setting defaults to ".", which is the same as your PhotoStructure library directory.
If you open your PhotoStructure library on a different computer, and that computer doesn't have access to your originals volume, full-screen zoom won't work, and non-transcoded videos will not play.
This system setting needs to be set appropriately on different computers (it won't be set automatically!)
If you have a large library and want to use an SSD, we recommend you set your libraryPath to your SSD, and use this setting to store your originals on a larger volume, rather than using the "previewsDir" setting.`,defaultValue:()=>"."}),forceOpen:new O({category:b.Paths,description:"DANGEROUS: if set, all previously-existing library locks will be removed. This should only be necessary if the prior PhotoStructure process was not shut down gracefully.",defaultValue:!1,transient:!0}),scanAllDrives:new O({category:b.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new O({category:b.Paths,description:"Deprecated, and will be removed in the next version. If set, PhotoStructure will automatically add your pictures directory to your `scanPaths` setting.",defaultValue:!1,advanced:()=>!1}),scanPaths:new Fe({category:b.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1,exampleValue:()=>lr()?["/path/one","/path/two"]:[$u()]}),cacheDir:new Ye({category:b.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free. Note that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory.",exampleValue:()=>lr()?"/tmp/ps_cache_dir":Bp(),defaultValue:()=>Bp()}),neverIgnored:new Fe({category:b.Paths,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),pidfile:new un({envAliases:["PIDFILE"],category:b.Paths,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),scanLibraryFirst:new O({category:b.Paths,description:"Should PhotoStructure scan your library before all other paths are synchronized?",defaultValue:!1}),scanLibraryLast:new O({category:b.Paths,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!0}),logLevel:new Ye({envAliases:["PS_LOG","LOG"],category:b.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc').",defaultValue:()=>Yu()?"error":"info"}),logDir:new Ye({category:b.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>Wx(),exampleValue:()=>lr()?"/var/log/photostructure":void 0}),logCompression:new O({category:b.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>Yu()}),logElapsedMs:new O({category:b.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new O({category:b.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new un({category:b.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new O({envAliases:["LOG_STDOUT","PS_STDOUT"],category:b.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new O({category:b.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new O({category:b.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR is set, this defaults to false. See <https://no-color.org/>.",defaultValue:()=>T(ha.env.NO_COLOR)}),logSql:new O({category:b.Logging,description:"Log SQL queries to the default log level. *This is really chatty* and impacts performance. Normally these log messages are completely disabled.",defaultValue:()=>!1}),localhost:new Ye({category:b.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). See <https://letsencrypt.org/docs/certificates-for-localhost/> and <https://photostructure.com/faq/troubleshooting/#windows-firewall-issues>.',defaultValue:()=>"127.0.0.1"}),httpPort:new Ne({category:b.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),trustProxy:new Ye({category:b.Networking,description:`Support for PhotoStructure instances running behind a reverse proxy. See <http://expressjs.com/en/guide/behind-proxies.html>. This setting should either be "false" (don't trust any proxies), "loopback", (only trust localhost), a single subnet (like "127.0.0.0/8"), or a comma-delimited set of subnets.`,defaultValue:"false"}),exposeNetworkWithoutAuth:new O({category:b.Networking,description:`Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.
**Don't enable this unless you know what you are doing**.`,defaultValue:()=>Ce()&&!lr()}),rpcPort:new Ne({category:b.Networking,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),exiftoolProcsPerChild:new It({category:b.Processes,description:"Each PhotoStructure process spins up an ExifTool when needed. Note that the `web`, `sync`, and `sync-file` services all use exiftool, so the total number of exiftool processes can be many times larger than this value.",min:1,max:8,defaultValue:2}),sensitiveEnvRegExp:new Ye({category:b.Processes,description:'PhotoStructure spawns a number of processes (including "exiftool" and "ffmpeg"), and passes through environment variables, mostly to ensure locale and TZ settings are correct. To prevent environment values that contain sensitive information, like API access tokens, from either being logged, or being accessed by external tools, all environment variables whose key matches this setting will be removed. This regex is applied case-insensitively.',defaultValue:"key|secret|pass|_user|aws_"}),bounceMinutes:new Ne({category:b.Processes,description:"PhotoStructure will bounce the web and sync processes periodically. Set to 0 to disable.",defaultValue:60*(lr()?5:ae?2:5)}),setupTimeoutMs:new Ne({category:b.Processes,description:"To prevent unhealthy services running as zombies, they self-terminate if the setup processes are not complete within this amount of time. Note that only the environment variable value is used for this setting.",defaultValue:35*E}),probationMs:new Ne({category:b.Processes,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*D}),minTimeBetweenServiceRestartsMs:new Ne({category:b.Processes,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*E}),fatalErrorRatePerMinute:new Ne({category:b.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),minDiskFreeGb:new Ne({category:b.Processes,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new It({category:b.Processes,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new To({category:b.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>Rl.BelowNormal,validValues:Rl.values}),maxMemoryMb:new It({category:b.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.",defaultValue:500,min:256,max:8e3}),maxRssMemoryMb:new It({category:b.Processes,description:"PhotoStructure will restart services if their' resident set size consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:250,max:8e3}),maxTasksPerProcess:new It({category:b.Processes,description:"PhotoStructure will recycle sync-file processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>lr()?10:200,min:1,max:5e3}),pollIntervalMs:new Ne({category:b.Processes,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>Yu()?D:5*E}),inspect:new O({category:b.Processes,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,transient:!0,advanced:()=>!0}),ignoreUnhealthyVolumes:new O({category:b.Volumes,description:"When true, PhotoStructure ignores volumes that are not healthy (due to needing filesystem checks, or remote filesystems that are not available).",defaultValue:!0}),validateMountpoints:new O({category:b.Volumes,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist.",defaultValue:!0}),readVolumeUuidFiles:new O({category:b.Volumes,description:`When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume UUID, which can help with cross-host library portability. Set this to false if you don't want PhotoStructure to read these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),writeVolumeUuidFiles:new O({category:b.Volumes,description:`When true, PhotoStructure (tries to) write ".uuid" files into the root directory of volumes, which enables cross-host library portability. Set this to false if you don't want PhotoStructure to try to write these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),forceLocalDbReplica:new O({category:b.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:()=>Ce()&&!lr()}),dbBackupsCount:new Ne({category:b.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",defaultValue:20}),maxBusyDbMs:new Ne({category:b.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 2 minutes, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>2*D}),dbTimeoutMs:new Ne({category:b.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",defaultValue:()=>E}),dbBackupIntervalMinutes:new is({category:b.Db,description:"How many minutes should elapse between backing of your library database? Note that PhotoStructure vacuums and optimizes the database before a backup is taken. You want this period to be frequent enough such that data loss isn't too painful. Note that backups can cause the webserver to be momentarily unresponsive. Default is every hour.",min:lr()?.5:1,max:60*12,defaultValue:()=>lr()?.5:30}),dbCacheSizeMb:new Ne({category:b.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:192}),dbBatchSelectSize:new It({category:b.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",defaultValue:128,min:1,max:900}),dbBatchUpsertSize:new It({category:b.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",defaultValue:16,min:1,max:500}),healthCheckExiftool:new O({category:b.HealthChecks,description:"When true, PhotoStructure verifies ExifTool is available and a valid version.",defaultValue:!0}),healthCheckLibraryIsWritable:new O({category:b.HealthChecks,description:"When true, PhotoStructure verifies the library directory exists, and is writable.",defaultValue:!0}),healthCheckVolumes:new O({category:b.HealthChecks,description:"When true, PhotoStructure verifies volumes as part of periodic health checks.",defaultValue:!0}),healthCheckFreeSpace:new O({category:b.HealthChecks,description:"When true, PhotoStructure verifies that the library and cache volumes have sufficient free space.",defaultValue:!0}),healthCheckDb:new O({category:b.HealthChecks,description:"When true, PhotoStructure verifies that the library database can be read from and written to.",defaultValue:!0}),enableSIMD:new O({category:b.Tools,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to false on macOS due to instability on that platform.",defaultValue:()=>!(lr()||ae)}),enableVipsCache:new O({category:b.Tools,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations? This defaults to false to reduce memory consumption.",defaultValue:()=>!1}),showFileInFolderUsesThunar:new O({category:b.Tools,description:`If we're on Linux, should we use Thunar (via dbus) to "show file in folder"?`,defaultValue:!1}),showFileInFolderUsesFileUri:new O({category:b.Tools,description:"Does the showFileInFolderCommand expect a file: URI to the file? If this is false, the native path will be appended instead.",exampleValue:()=>!0,defaultValue:()=>tt}),showFileInFolderCommand:new Fe({category:b.Tools,description:`If set, the first argument will be used as a command (or path to command), and the subsequent arguments (if present) will be used as arguments. The native path to the file or the file: URI will be appended, based on the value given to the "showFileInFolderUsesFileUri" setting. If this is set to an empty array, the default tool for your platform will be used instead: "nautilus -s" on linux, "open -R" on mac, and "explorer /select" on Windows.
This is provided to support Linux desktops that don't use Gnome.`,defaultValue:[]}),dcraw_emuPath:new Ye({category:b.Tools,description:'This should be the absolute, native path to the "dcraw_emu" binary on this system. If this is set to "dcraw_emu", PhotoStructure will search your $PATH. See <https://www.libraw.org/docs/Samples-LibRaw.html>.',defaultValue:"dcraw_emu"}),ffmpegPath:new Ye({category:b.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc. See <https://photostructure.com/getting-started/video-support/>.',defaultValue:"ffmpeg"}),ffmpegTranscodeArgs:new Fe({category:b.Tools,description:`The following are the default arguments added to transcode requests made to ffmpeg (when ffmpeg is available). The following arguments will proceed the command: "-loglevel error -threads T -i INPUT_FILE_PATH" (where T is replaced by ~half the available CPU threads, and INPUT_FILE_PATH is the full native pathname to the source video). The following arguments will follow the arguments in this setting: "-b:v VIDEO_BITRATE_KBPS OUTPUT_FILE_PATH".
CAUTION: this is an advanced setting. Editing this may cause videos that require transcoding to not be imported, or not be viewable on all browsers and platforms. See <https://forum.photostructure.com/t/hardware-accelerated-encoding-transcoding/166> for more details.`,defaultValue:["-c:a","aac","-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high"]}),heifConvertPath:new Ye({category:b.Tools,description:'This should be the absolute, native path to the "heif-convert" binary on this system. If this is set to "heif-convert", PhotoStructure will search your $PATH. See <https://photostructure.com/getting-started/heif-support/>.',defaultValue:"heif-convert"}),powerShellArgs:new Fe({category:b.Tools,description:`The following are the default arguments added to spin up PowerShell on Windows devices.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1> for all arguments that PowerShell.exe accepts.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-5.1> for a description of Bypass.
See <https://forum.photostructure.com/t/eliminate-powershell-profile-and-execution-policy-related-errors/184> for more details about why this needs to be configurable.
(Versions prior to v1.0.0 only specified "-NoLogo").`,defaultValue:["-NoLogo","-NoProfile","-ExecutionPolicy","Bypass"]}),powerShellCulture:new Ye({category:b.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),toolPaths:new Fe({category:b.Tools,description:`These paths are appended to the PATH to ensure PhotoStructure can find and run external tools like ffmpeg. Use your operating system's separator to separate paths (":" for mac and linux, ";" for windows).`,defaultValue:()=>ao("SETTINGS_IO_TEST")?ST:TI}),vlcPath:new Ye({category:b.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),openAtLogin:new O({category:b.Desktops,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!fi}),updateChannel:new To({category:b.Desktops,description:'TL:DR; keep this on "latest." This setting only applies to PhotoStructure for Desktops, and controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds have not been thoroughly tested. Please only consider changing this if customer support asks you to, and that you have recent backups of your system.',defaultValue:()=>jx(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new O({category:b.Desktops,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new Ne({category:b.Desktops,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:60*24}),autoHideMenuBar:new O({category:b.Desktops,description:"If true, PhotoStructure for Desktops on Windows and Linux will auto hide the menu bar unless the Alt key is pressed.",defaultValue:!1}),email:new un({category:b.Reporting,description:"If set, this email will be used for license subscriptions and added to error reports, so we can contact you to help debug the issue. It is not required. Setting a value here does not subscribe you to any marketing emails.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new O({category:b.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new Ne({category:b.Reporting,description:`Set this to zero to remove all bugs in PhotoStructure.
HUR HUR #DADJOKE
If your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.`,defaultValue:3}),minStreamCorrPct:new It({category:b.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),hiddenHomeTags:new Fe({category:b.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", and "Keyword").',defaultValue:()=>["Type"]}),placeholderThumbs:new O({category:b.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),cspReportOnly:new O({category:b.Web,description:"Only report CSP violations. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>.",defaultValue:()=>!1}),cspDirective:new un({category:b.Web,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src>.",exampleValue:()=>"https://myphotos.example.com"}),readdirCacheSeconds:new Ne({category:b.Sync,description:"readdir() can take a long time over slow network shares and when directories are very large. This setting controls how long to cache readdir results that are slow (which take >= .5 seconds). Set to 0 to disable readdir() caching.",defaultValue:300}),verifyFileCopies:new O({category:b.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new Ye({category:b.Sync,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:`If you chose to copy assets into your library, they will be copied into <originals directory>/<result of this pattern>/<original imagename>.
- See the originalsDir system setting for what your <originals directory> is (it defaults to your library root directory).
- Please encode this path with forward-slashes, even if you're on Windows.
- If you want to add a static path, escape the pathname with single quotes (like "'photos'/y/MM/dd").
- This will always be interpreted as a relative path from your PhotoStructure library.
- See <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.`,defaultValue:"y/y-MM-dd"}),transcodeVideos:new O({category:b.Sync,description:"Should videos that are not in a browser-supported format be transcoded during import? Note that this is a plus-only feature. FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),transcodeBitrateQVGA:new Ne({category:b.Sync,description:"What max bitrate should PhotoStructure encode QVGA (320 \xD7 240) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:800}),transcodeBitrateUHD:new Ne({category:b.Sync,description:"What max bitrate should PhotoStructure encode UHD (3840\u2009\xD7\u20092160) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:18e3}),doNotTranscodeMimetypes:new Fe({category:b.Sync,description:`Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "['video/quicktime','video/mp4']").`,defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),doNotTranscodeVideoCodecs:new Fe({category:b.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following video codecs. The video codec may be stored in the "VideoCodec", "CompressorID", or "CompressorName" tags.',defaultValue:()=>["avc1"]}),doNotTranscodeAudioCodecs:new Fe({category:b.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following audio codecs. The audio codec is stored in the "AudioCodec" tag.',defaultValue:()=>["mp4a","sowt"]}),statTimeoutSeconds:new It({category:b.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new O({category:b.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncIntervalHours:new Ne({category:b.Sync,description:`This value controls both how often the sync process discovers new or changed files for any given volume.
Note that this value is the duration between the last completion time and when the next sync should be scheduled.
WARNING: Setting this value to a small value will mean PhotoStructure is constantly scanning your disks, which will add wear and tear and possibly reduce the lifespan of your storage media.
Note that setting this to a zero or negative value will disable automatic scheduling of the sync process.`,defaultValue:24}),rebuild:new O({category:b.Sync,description:"When set, all files in your library will be re-imported (caution: slow!).",defaultValue:!1,transient:!0}),forceSync:new O({category:b.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),skipModelUpdates:new O({category:b.Sync,description:"When set, skip any pending library database updates.",defaultValue:!1,transient:!0}),exitWhenDone:new O({category:b.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),matchSidecarsCaseInsensitively:new O({category:b.Sidecars,description:`If set to true, PhotoStructure will look for sidecar files that match file basenames (with or without the file extension), regardless of case (for example: "IMAGE.XMP" will be a sidecar for "image.jpg").
If set to false, sidecars must match case (so only "image.jpg.xmp" and "image.xmp" will match for "image.jpg").
This defaults to false just to be conservative, but true should be fine in normal cases.`,defaultValue:!1}),defaultSidecarType:new To({category:b.Sidecars,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:zl}),writeMetadataToSidecarsIfImage:new O({category:b.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to images into sidecars. If set to false, PhotoStructure will overwrite original images with metadata changes.",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new O({category:b.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to videos into sidecars. If set to false, PhotoStructure will overwrite original videos with metadata changes. This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new O({category:b.Sync,description:'Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents. If this is set to false, the original file will be retained in the same directory. "image.jpg" will be stored as "image_original.jpg".',defaultValue:!1}),fuzzyDateParsing:new O({category:b.Sync,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),fuzzyYearParsing:new O({category:b.Sync,description:`When enabled, PhotoStructure will use directories starting with a number that looks year-like (four digits, 1826-the present) to infer the captured-at time, if all other date parsers have failed. Note that setting this to true "forces" the "fuzzyDateParsing" setting to be true.
To elaborate: PhotoStructure first looks for metadata with a date, then looks for an ISO-compliant YMD timestamp in the filename or path, and then, if "fuzzyDateParsing" or this setting is enabled, a YMD or YM datestamp, and then finally, if this setting is enabled, it looks for a directory that begins with a number that is between 1826-2020.`,defaultValue:!1}),minValidYear:new Ne({category:b.Sync,description:"If PhotoStructure encounters a year that is less than this value, it will consider it invalid and look elsewhere for dates. The default value, 1826, is the first year a photograph was captured, as per <https://en.wikipedia.org/wiki/History_of_photography>. If you have paintings or other imagery from before this time, you'll want to make this value less than the earliest image in your library.",defaultValue:1826}),useStatToInferDates:new O({category:b.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in the file "birthtime" (on Windows), or the lesser value of "mtime" and "ctime" (on macOS and Linux). Note that these values are not very reliable, as file transfers and backups frequently don't retain these values correctly.`,defaultValue:!0}),usePathsToInferDates:new O({category:b.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.`,defaultValue:!0}),useLibraryPathsToInferDates:new O({category:b.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths *for files that are in your PhotoStructure library. This defaults to false, as prior versions of PhotoStructure may have placed files into incorrect datestamped directories.`,defaultValue:!1}),maxDuplicatePathElements:new Ne({category:b.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),skipAssetFileUpdates:new O({category:b.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),skipAssetUpdates:new O({category:b.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new O({category:b.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>lr()?!0:(0,vT.cpus)().length>=8}),excludeNoMediaAssetsOnRebuild:new O({category:b.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),strictDeduping:new O({category:b.Deduping,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true.',defaultValue:!1}),useImageHashes:new O({category:b.Deduping,description:"Building image hashes slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing. If you set this from false to true, and you'd previously imported new assets, you may want to rebuild your library to re-aggregate your assets.",defaultValue:!0}),includeSharpDominantColor:new O({category:b.Deduping,description:"PhotoStructure's image library, sharp, computes the dominant color using a 4096-bin 3D histogram. This doubles image hashing time, but the most-dominant color might be more accurate.",defaultValue:!1}),minExposureSettingsCoeffPct:new It({category:b.Deduping,description:"This is the minimum similarity coefficient between exposure setting values two images must be to be considered equivalent. Many cameras actually report different exposure setting values between JPG and RAW: values within 90% of each other should avoid false-positives.",defaultValue:()=>90,max:100,min:0}),minImageCoeffPct:new It({category:b.Deduping,description:"This is the minimum image hash similarity coefficient for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image similarity. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minImageGreyscaleCoeffPct:new It({category:b.Deduping,description:"This is the minimum image hash similarity coefficient for greyscale images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>93,max:100,min:0}),minColorCoeffPct:new It({category:b.Deduping,description:"This is the minimum similarity coefficient found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 50% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minMeanCoeffPct:new It({category:b.Deduping,description:"If the average of image and color similarity coefficients exceeds this score, the image will be considered a match.",defaultValue:()=>65,max:100,min:0}),fuzzyDateImageCoeffWeight:new is({category:b.Deduping,description:'Image similar, by default, is somewhat lax to ensure JPG+RAW and downsampled or edited images are matched together. This is OK when dates must match, and the date is exactly correct. When dates are manually set to something "fuzzy", with perhaps only the year, month, and day, or is inferred by siblings, we need to be more discriminate with image contents to prevent incorrectly grouping photos from that day into a single asset. This value is multiplied with minImageCorrPct and minColorCorrPct to make them more stringent. For example, by default, the minImageCorrPct is 80%, and when the dates are manually set, and this weight is 1.2, the minImageCorrPct for manually-set-date files will be 90%.',defaultValue:()=>1.4,max:2,min:.5}),greyscaleColorThreshold:new It({category:b.Deduping,description:"When looking at each pixel in L*a*b* space, a greyscale image is expected to have a* and b* values around 0. If the absolute value of every a* and b* value is under this setting's value, the image will be considered to be greyscale. A value of 0 will force all images to be considered non-greyscale.",defaultValue:5,max:128,min:0}),modeCorrCieDiffWeight:new is({category:b.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to the CIE94 color delta e. Smaller values apply a larger discount to color deltas.",defaultValue:()=>.6,max:2,min:0}),modeCorrIndexDiffWeight:new is({category:b.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to difference between the color indexes. Smaller values apply a larger discount to index differences.",defaultValue:()=>.6,max:2,min:0}),gpsErrorMeters:new Ne({category:b.Deduping,description:`What's the maximum number of meters between GPS fixpoints that should be considered equivalent locations? Note that JPG+RAW pairs from smartphones frequently have different GPS locations due to one being recorded from a rough WiFi fix, and another from aGPS.
GPS position error is ~10-100m. Cellular position error is ~500-750m.`,defaultValue:500}),lensMakes:new Fe({category:b.Deduping,description:"Used to match lensId when Google Takeout has stripped metadata.",defaultValue:()=>bT}),variantSortCriteria:new Fe({category:b.Previews,description:'How should PhotoStructure pick the "best" asset file variant for a given asset? You may reorder the default fields. Only "resolution", "fileSize", "mtime", "schemeIdx", "isCover", "count", and "isBrowserSupported" are understood: other field names will be ignored. Details about these fields are here: <https://photostructure.com/faq/what-do-you-mean-by-dedupe/#how-does-photostructure-pick-which-file-to-show>.',defaultValue:["resolution","mtime","schemeIdx","isCover","count","isBrowserSupported","fileSize"]}),variantSortCriteriaPower:new is({category:b.Deduping,description:'Larger variant sort criteria, "resolution" and "fileSize", are scaled to ignore smaller (irrelevant) differences. Scalars are raised to this power to reduce them, so a value of 1 means the criterion is unchanged from the "raw" value.',defaultValue:()=>.15,max:1,min:1e-6}),jpegQuality:new It({category:b.Previews,description:"JPEG output quality for previews. Smaller values produce smaller images with lower quality. The default value of 85 strikes a balance that has almost no noticeable compression artifacts, yet still compresses images reasonably well. Values less than ~50-70 can produce noticeable artifacts (depending on the image).",defaultValue:()=>85,max:100,min:10}),dcrawEmuArgs:new Fe({category:b.Previews,description:`What options do you want to pass to dcraw_emu? Note that "-T -o 1 -j -Z -" will always be added (as we need TIFF, sRGB, raw pixels send to stdout). The "-h" arg will be added if the preview image needed is less than half the resolution of the original.
Run "dcraw_emu" with no arguments to get usage help.
"-q 1" sets interpolation quality to "0".
"-H 2" turns on highlight blending.
"-w" uses the camera-set white balance.
Note: changing these values can dramatically (> 10x!) increase the time it takes to render RAW images.`,defaultValue:["-q","0","-w"]}),iccProfileMappings:new Fe({category:b.Previews,description:`Maps an original image profile to a filename stored in the "icc" directory. See that directory's _info.md for more information about this settings.`,defaultValue:["Display P3:DisplayP3Compat-v2-magic.icc","Adobe RGB:AdobeCompat-v2.icc"]}),squareThumbStrategy:new To({category:b.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>.',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new Qu({category:b.Previews,description:`When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.
Note that if a video is shorter than this value, the frame will be captured from the middle of the video.`,defaultValue:1.5}),sharpen:new O({category:b.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new O({category:b.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new Md({category:b.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:$m(ap,["uhd8k","uhd5k","qqvga"]),validValues:ap}),embeddedPreviews:new Fe({category:b.Previews,description:`For larger source images that are greater than 15MP, what embedded image preview tags should be used when present? Using these embedded images speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["PreviewImage","PreviewTIFF","JpgFromRaw"]}),embeddedThumbnails:new Fe({category:b.Previews,description:`Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["ThumbnailImage","ThumbnailTIFF"]}),skipPreviews:new O({category:b.Previews,description:"No previews will be built. The UI will be broken if this is set.",defaultValue:!1}),requireMakeModel:new O({category:b.Filters,description:"Normally PhotoStructure requires images to have EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),minImageDimension:new Ne({category:b.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new Ne({category:b.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minVideoDurationSec:new Qu({category:b.Filters,description:"What's the minimum number of seconds for a video to be imported?",defaultValue:2}),minAssetFileSizeBytes:new Ne({envAliases:["PS_MIN_ASSET_SIZE_BYTES","PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:b.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*mp}),maxAssetFileSizeBytes:new Ne({envAliases:["PS_MAX_ASSET_SIZE_BYTES","PS_MAX_ASSET_SIZE","PS_MAX_FILE_SIZE_BYTES"],category:b.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library).",defaultValue:.5*uo}),validateJpegImages:new O({category:b.Filters,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateRawImages:new O({category:b.Filters,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateVideos:new O({category:b.Filters,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!lr()}),validationErrorBlocklist:new Fe({category:b.Filters,description:`If any of the following patterns match a validation error found in a photo or video, the file will be considered corrupt and not be imported into your library.
Note the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message, so, for example, a value of "caution" will ignore any error message that contains the string "caution".`,defaultValue:()=>["Cannot determine format of input stream","corrupt","error","failed","invalid","not a .+ file","nothing was written into output file","partial file","Premature end of .+ file"]}),tagCamera:new O({category:b.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new O({category:b.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new O({category:b.Tagging,description:`Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you'll need to "Rebuild" your library to make the setting take effect).`,defaultValue:!0}),tagYMD:new To({category:b.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["y","ym","ymd",""]}),tagDateFromStat:new O({category:b.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!lr()}),tagKeywordsFromPath:new O({category:b.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new O({category:b.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new Ye({category:b.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new Ye({category:b.Tagging,description:`PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "Objects\u2283Tools\u2283Hammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don't want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.`,defaultValue:"/|>\u2283"}),tagFileType:new O({category:b.Tagging,envAliases:["PS_TAG_TYPE"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0}),tagWhoSynonyms:new Fe({category:b.Tagging,description:'List hierarchical tags that PhotoStructure should interpret to be face names. Digicam uses "People". This is matched case-insensitively.',defaultValue:()=>["People","Face","Faces"]}),tagJsonFaces:new O({category:b.Tagging,description:'Google Takeout provides .json sidecars that may contain the names of the people (or pets) found in the image. Should PhotoStructure import these tags under "Who"?.',defaultValue:!0}),tagFaceRegions:new O({category:b.Tagging,description:'Picasa and other software supports embedding face names within "RegionInfo" metadata. If this setting is enabled, PhotoStructure will import these tags under "Who".',defaultValue:!0}),tagWhoNames:new Fe({category:b.Tagging,description:`This is a list of tags that will be examined for strings or string arrays. All values associated to these fields will be interpreted as names. Note that "dotted notation" is supported.
Set this value to an empty array to disable scanning for person names.`,defaultValue:["People","PersonInImage","PersonInImageWDetails.PersonName","PersonInImageName"]}),tagNamesFormatter:new To({category:b.Tagging,description:`How should PhotoStructure format the "Who" tags for assets whose files are tagged with "people" strings?
"as-is" will tag names directly to "Who", so, "Who/Albert Einstein".
"family/given" will tag "Who/Einstein/Albert" (for regions that provide given names first). The default is "as-is," because discerning given and family names aren't reliably inferable.
See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"as-is",validValues:["as-is","family/given"]}),tagNamesDefaultFamily:new Ye({category:b.Tagging,description:'If a name is missing a family name, if this value is not blank, it will be provided as a default. If this value is blank, the name tag will be Who/given. Note that this setting is only used if "tagNamesFormatter" is set to "family/given".',defaultValue:"-"}),tagNamesCapitalizedAsFamily:new O({category:b.Tagging,description:"Assume uppercased names are family names (this is common practice in geneology).",defaultValue:!0}),tagNamesOrder:new To({category:b.Tagging,description:`How should PhotoStructure parse people's names? Note that this setting is only used if "tagNamesFormatter" is set to "family/given". See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"western",validValues:["western","eastern"]}),tagNamesSurnamePrefixes:new Fe({category:b.Tagging,description:'List all family name prefixes to be considered part of the family name. These are matched case-insensitively. This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>["A","D\u2019","Da","De la","De las","De","Del","Della","Den","Des","Di","Du","La","Las","Le","Li","Lo","Mc","Mac","op de","ten","ter","Van \u2018t","van der","van","von der","von","z","zu"]}),tagNamesSurnames:new Fe({category:b.Tagging,description:`List all family names you expect in tags that are not single words that are found at the end of a tagged name. Hyphenated family names (like "Ocasio-Cortez") do not need to be listed here: only compound family names, and if your language doesn't separate family names with whitespace. In the latter case, either include all family names, or include all givenNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesGiven:new Fe({category:b.Tagging,description:`List all given names you expect in tags that are not single words. Hyphenated given names (like "Rose-Ann") do not need to be listed here. If your language doesn't separate family names and given names with whitespace, either include all given names, or include all familyNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesFamilySurrounds:new Fe({category:b.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added as a family name. As an example, if you use the default "()", then "Michelle LaVaughn (Robinson) Obama" will be name tagged with both "Who/Robinson/Michelle LaVaughn" and "Who/Obama/Michell LaVaugn". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["()"]}),tagNamesGivenSurrounds:new Fe({category:b.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added to the end of the given name with the surrounds retained. As an example, if you use the defaults of "[]" and double-quotes, then "Joe "Joey" Smith" will be name tagged with Who/Smith/Joe "Joey". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["[]",'""']}),tagNamesLexical:new O({category:b.Tagging,description:'Assume any name with a comma is in "lexical name order", which is always "lastname, given name(s)". If the given name is found to be "sr.", "senior", "jr.", or "junior", the name will be considered to be in western order ($givenNames $familyName, $modifier), and the $modifier will be added to the $givenNames. If this is set to false, commas are ignored.',defaultValue:!0}),excludedRootTags:new Fe({category:b.Tagging,description:"Keywords starting with the given roots will be omitted from your PhotoStructure library.",defaultValue:()=>["http:","https:"]}),tagDisplayNameFS:new Ye({category:b.Tagging,description:`What should PhotoStructure call the "root" tag for browsing by filesystem paths? Note that this value is only for the UI, and will update the "_displayName" of the /fs/ tag: this value won't change the URL path from be "/tag/fs/.../". Reasonable options that have been suggested include "Folder", "Directory", "Drive", "File", "Path", "Volume", or "Computer".`,defaultValue:"Folder"}),tagAlbums:new O({category:b.Tagging,description:'Should PhotoStructure look for $tagJsonAlbumFilename (by default, "metadata.json") files in the same directory as asset files for album titles?',defaultValue:!0}),tagAlbumFilenames:new Fe({category:b.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the file that PhotoStructure should look for with album metadata? This can be JSON, XMP, MIE, or EXIF encoded.`,defaultValue:["metadata.json"]}),tagAlbumTitle:new Ye({category:b.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.title"}),tagAlbumTitleHierarchies:new O({category:b.Tagging,description:'If true, album titles will be split as hierarchical keywords. If false, album titles will not be split, and all albums will be under the "Albums" root tag.',defaultValue:!1}),tagAlbumDescription:new Ye({category:b.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.description"}),tagAlbumDate:new Ye({category:b.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.date"}),tagAlbumsExcluded:new Fe({category:b.Tagging,description:'For "metadata.json" albums, some are automatically generated. If the title or description includes any given string, it will be ignored.',defaultValue:["Album for automatically uploaded content"]}),pickPlanOnWelcome:new O({category:b.Subscriptions,description:'If set to true, the welcome page flow will redirect to https://account.photostructure.com/plans to have you pick between "plus" and "lite". If set to false, the welcome page will continue directly to the settings page with a "lite" license. You can still upgrade to a paid plan later from the main menu or the about page, even if this is false.',defaultValue:!0}),autoRefreshLicense:new O({category:b.Subscriptions,description:`PhotoStructure uses cryptographically signed licenses to locally store your current plan subscription status. These licenses are only valid for the current subscription period, and must be refreshed when your subscription renews or converts from a free trial to a paid subscription. To minimize the hassle of license renewals, PhotoStructure can automatically renew expired licenses in the background.
If the current license has expired and this value is true, PhotoStructure will make one secure POST request to https://account.photostructure.com/ that contains several lossy one-way hashes of current system metadata. We hash all identifying metadata to only 15 characters to alleviate any privacy concerns. If your plan subscription is active, a new license will be added to your library.
Set this to false and set the "reportErrors" setting to false if you don't want PhotoStructure "phoning home" for any reason.
Note that if this is disabled, license renewals will require manual intervention: click "Upgrade" from the main menu, pick your plan, authenticate, and the license will automatically refresh.`,defaultValue:!0}),license:new un({category:b.Subscriptions,description:`Subscription licenses are normally saved automatically into both your library and system configuration directories. This setting just provides users with an alternative way to provide a license, if it's more convenient. Any value provided to this setting will be considered in addition to existing license files when PhotoStructure is trying to find the "best" license available.`})};for(let[t,e]of ze(u))e._setName(t);function MI(t){let e=(T(t)?"":t).split(da.delimiter);if(I&&T(ha.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return e.push(...u.toolPaths.valueOrDefault),z(e).filter(v).join(da.delimiter)}var rT=l(()=>MI(ha.env.PATH)),_l=l(()=>{let t=pt(u).filter(e=>!e.transient);return $(t,e=>[e.categoryType==="system"?0:1,b.indexOf(e.category),e.advanced,e.name])}),PT=l(()=>_l().filter(t=>wd.includes(t.category))),vI=l(()=>_l().filter(t=>Ul.includes(t.category)));var ET;(function(o){o.highlight=()=>!1,o.silent=!1,o.enabled=()=>!o.silent,o.defaultLevelIndex=Cl("trace")})(ET||(ET={}));var SI=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i,DT=class{constructor(e){this.silent=!1;this.contexts=[];this.setup(e)}setup(e){this.contexts.length=0;let r=Cl(u.logLevel.defaultValue),i=v(e)?e:u.logLevel.valueOrDefault;R(i.split(",")).forEach(o=>{let n=SI.exec(o.trim());if(n==null)Te||console.error("LogFilterImpl: Ignoring '"+o+"' from "+e);else{let s=g(n[1]).toLowerCase(),a=Cl(n[2]);T(s)?r=a:this.contexts.push({prefix:s,levelIndex:a})}}),this.defaultLevelIndex=r}contextOverride(e){if(this.contexts.length===0&&T(e))return;let r=g(e).toLowerCase();return this.contexts.find(i=>r.startsWith(i.prefix))}enabled(e,r){if(this.silent)return!1;let i=Cl(e);if(i<=this.defaultLevelIndex)return!0;let o=this.contextOverride(r);return o!=null&&i<=o.levelIndex}highlight(e){let r=this.contextOverride(e);return r!=null&&r.levelIndex>=this.defaultLevelIndex}},Xu;function mn(){return Xu==null&&(Xu=new DT,u.logLevel.addListener(()=>Xu.setup())),Xu}var AT=l(()=>Vi.values[mn().defaultLevelIndex],5*E);function FT(t,e){return mn().enabled(t)?e():void 0}var vd=class{constructor(e){this.valueOf=e;this.store=[]}get length(){return this.store.length}add(e){if(e==null)return;let r=this.valueOf(e);if(r!=null){if(this.store.length===0){this.store.push(e);return}if(eo(r,this.valueOf(this.store[0]))){this.store.unshift(e);return}for(let i=this.store.length-1;i>=0;i--)if(As(this.valueOf(e),this.valueOf(this.store[i]))){this.store.splice(i+1,0,e);return}this.store.unshift(e)}}shiftLt(e){if(this.length===0)return[];let r=0;if(eo(this.valueOf(Qm(this.store)),e))r=this.store.length;else for(;eo(this.valueOf(this.store[r]),e);)r++;return r===0?[]:this.splice(0,r)}splice(e,r){return this.store.splice(e,r)}};var kT=S(require("process"));var IT=S(require("util"));var LT=S(require("luxon"));var PI=Date.now();function Zu(t){let e=u.logElapsedMs.valueOrDefault?LT.Duration.fromMillis(t-PI).toFormat("hhhh:mm:ss.SSS"):new Date(t).toISOString();return u.logColor.valueOrDefault?u.logElapsedMs.valueOrDefault?Bs(e):Cs(e):e}var Sd=Te?250:750;var Pd=class{constructor(e={}){this.logLevels={trace:"trace",debug:Cs("debug"),info:tu("info "),error:Hy("error"),warn:Gy("warn ")};this.inspectOptions=w(w({},Pd.defaultInspectOptions()),e),Te&&(this.inspectOptions.breakLength=255)}formatMeta(e){if(e==null)return;let r=rs(e);return r==null?void 0:(0,IT.inspect)(r,this.inspectOptions)}formatLogEntry(e){let r=mn().highlight(e.ctx)?Bs:Zm;return R([Zu(e.ts),ob(M(e.from,()=>this.inspectOptions.processName())),this.logLevels[e.l],r(e.ctx),e.msg,this.formatMeta(e.meta)]).map(i=>g(i)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:si(),ctx:r,msg:i,meta:o})}},ec=Pd;ec.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:Ku+1,processName:si});var OT=S(require("util"));var Ed=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e;this.paddedLogLevels=st(Vi.values.map(e=>[e,Ab(e,5," ")]))}formatLogEntry(e){return R([Zu(e.ts),si(),this.paddedLogLevels[e.l],Un(e.ctx),Un(e.msg),f(e.meta,r=>(0,OT.inspect)(r,this.inspectOptions))]).map(r=>g(r)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:si(),ctx:r,msg:i,meta:o})}};var EI=l(()=>{u.logColor.addListener(()=>Dd.unset())}),Dd=l(()=>(kT.env.NO_COLOR!=null&&(u.logColor.tmpValue=!1),EI(),u.logColor.valueOrDefault?new ec({processName:()=>""}):new Ed));function RT(t){return t?.ts}var DI=!1;var AI=new vd(RT);function _T(...t){for(let e of t)DI?AI.add(e):console.log(Dd().formatLogEntry(e))}var Ad=class{log(e,r,i,o){_T({ts:Date.now(),l:e,from:si(),ctx:r,msg:i,meta:o})}enabled(e,r){return mn().enabled(e,r)}async flush(){}end(){}},os=Ad;os.instance=l(()=>new Ad);var NT=S(require("path")),BT=S(require("timers"));var FI=require("fs");var tc=class{constructor(e,r={}){this.logDir=e;this.ended=!1;this.mutex=new Ii;this._linesSinceRotate=0;this.pendingWrites=[];this._startIndex=0;this.endTimeoutMs=15*E;this.end=l(async()=>(this.ended=!0,f(this.flushInterval,BT.clearInterval),this.flushInterval=void 0,await this.flush(),this.mutex.serial("close",()=>this._closeCurrent())));this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",()=>this._flush());this.shouldRotate=()=>this._stream==null||this._linesSinceRotate>=this.opts.maxLinesPerFile;this.name="LogWriter("+e+")",this.opts=w({maxLinesPerFile:25e4,errorLogger:os.instance(),flushEveryMs:Sd,processName:si},r),this.flushInterval=jr(()=>this.maybeFlush(),this.opts.flushEveryMs),CT(this)}log(e,r,i,o){if(this.ended&&e==="error")this.opts.errorLogger.log(e,r,i,o);else{let n={ts:Date.now(),l:e,ctx:r,msg:i};o!=null&&(n.meta=o),e==="error"&&(this.writeRecentLogEntries(),this.flush()),this.pendingWrites.push(k(n)+`
`)}}writeRecentLogEntries(){this.pendingWrites.push(...pT().map(e=>k(e)+`
`)),cT()}async flush(){await this.mutex.serial("flush",()=>this._flush())}async _flush(){let e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this._rotate();let r=this._stream;if(r==null){this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");return}let i=this.opts.maxLinesPerFile-this._linesSinceRotate,o=e.splice(0,i);this._linesSinceRotate+=o.length,r.write(o.join(""))}}errback(e){return r=>this.opts.errorLogger.log("error","Caught error from "+e,r)}async _rotate(){await this._closeCurrent(),this._currentFile=await Eu({nativePath:(0,NT.join)(this.logDir,jy(new Date),Un(this.opts.processName())+".log"),emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=FI.createWriteStream(this._currentFile).on("error",this.errback("file write stream"))}async _closeCurrent(){let e=this._stream;this._stream=void 0,this._linesSinceRotate=0;let r=this._currentFile;this._currentFile=void 0,await ki(e),u.logCompression.valueOrDefault&&(await lt(this.opts.flushEveryMs),await f(r,Bx))}};var Fd=l(()=>[os.instance()]);function Up(){return Fd().find(t=>t instanceof tc)}function tb(){let t=u.logDir.valueOrDefault,e=Up();(e==null||e.logDir!==t)&&(yi(e),e=new tc(t));let r=[e];(u.logStdout.valueOrDefault||u.tailLogs.valueOrDefault)&&r.push(os.instance()),Fd.set(r)}function h(t){return new Vl(t,Fd)}var ns=l(()=>h(eu("Endable"))),rc=new Xo;jr(()=>VT(),1*D);var LI=5*E,be=he("first","service","predb","db","postdb","logger");function zT(t){return Jn(be.first,t)}function UT(t){return Jn(be.db,t)}function CT(t){return Jn(be.logger,t)}function Jn(t,e){return be.validOrElse(t,()=>{throw new Error("internal error: invalid rank "+t)}),rc.add(t,e),e}var qT=!1;function me(){return qT}async function yi(t,e){let r=await t;if(r==null||r.ended)return;let i=Te&&ao("SINGLE_SPEC_TESTS")?100:Ub(e,r.endTimeoutMs,LI);return ns().debug(r.name+" ending...",{timeoutMs:i}),ke(r.end(),i,()=>ns().warn(r.name+".end() timed out"),()=>ns().debug(r.name+".end() completed")).catch(o=>{dt(()=>ns().warn(r.name+".end() rejected: "+o))})}function VT(){rc.filterInPlace((t,e)=>!e.ended),ns().debug("vacuumEndables()",rc.entriesArray().map(([t,e])=>[t,e.map(r=>r.name)]))}var WT=l(async()=>{let t=Nn()?250:void 0;ns().info("endEndables()",{isTest:Te,isSingleSpecTests:Nn}),Te||(qT=!0),VT();for(let e of be.values){let r=M(rc.get(e),[]);C(r)&&(ns().debug("endEndables(): ending "+e),await Promise.all(r.map(i=>yi(i,t))))}});var KT=S(require("commander")),JT=S(require("process"));var jT=S(require("process"));var II=new Date().getFullYear(),OI=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.

Copyright \xA9 2017-${II}, PhotoStructure Inc.

Running this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,HT={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",list:"List all paths in a Library.",logcat:"Chronologically sort and pretty-print PhotoStructure logfiles.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."};function GT(t){return t.on("--help",()=>{console.log(`
`+no(OI,{maxLineLen:jT.stdout.columns??78,prefix:""}).join(`
`)+`
`)})}var Ld=class{constructor(e,r,i){this.serviceName=e;this.args=r;this.additionalDescription=i;this.plugins=[];nu(e)}add(...e){return this.plugins.push(...e),this}async parse(){let e=GT(KT.program.description(HT[this.serviceName]+ii(this.additionalDescription,i=>`

`+i,()=>"")));f(this.args,i=>{e=e.arguments(i)});for(let i of this.plugins)e=i.beforeParse(e);e.version(Lt,"--version","Output the version number (spoiler: it's "+Lt+")"),e.parse(JT.default.argv);let r=e.opts();for(let i of this.plugins)await i.afterParse(r);return e}};var $T=S(require("process"));function QT(t){return B($T.default.env.__is_daemon)||B(t?.daemon)||!T(t?.pidfile)}var YT={beforeParse:(t,e=!1)=>(t.option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.'),e||t.option("--info|--verbose",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.'),t.option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.').option("--color","Enable ASCII terminal colors",!0).option("--no-color","Disable ASCII terminal colors"),t),afterParse:t=>{f(t.color,o=>u.logColor.tmpValue=o);let e=B(t.warn),r=B(t.info)||B(t.verbose),i=B(t.debug);e&&(u.logLevel.tmpValue="warn"),r&&(u.logLevel.tmpValue="info"),i&&(u.logLevel.tmpValue="debug"),!QT(t)&&(e||r||i)&&(u.logStdout.tmpValue=!0)}};var hv=S(require("path"));var kI=[[["360"],"GoPro 360 video (QuickTime-based)"],[["3FR"],"Hasselblad RAW (TIFF-based)"],[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["AVIF"],"AV1 Image File Format (QuickTime-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["CZI"],"Zeiss Integrated Software RAW (ZISRAW)"],[["DCP"],"DNG Camera Profile (DNG-like)"],[["DCR"],"Kodak Digital Camera RAW (TIFF-based)"],[["DNG"],"Digital Negative (TIFF-based)"],[["DV"],"Digital Video"],[["ERF"],"Epson RAW Format (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["FFF"],"Hasselblad Flexible File Format (TIFF-based)"],[["FFF"],"FLIR Systems thermal image File Format"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HDP","WDP","JXR"],"Windows HD Photo / Media Photo / JPEG XR (TIFF-based)"],[["HDR"],"Radiance RGBE High Dynamic-Range"],[["HEIC","HEIF","HIF"],"High Efficiency Image Format (QuickTime-based)"],[["IIQ"],"Phase One Intelligent Image Quality RAW (TIFF-based)"],[["INSP"],"Insta360 Picture (JPEG-based)"],[["INSV"],"Insta360 Video (QuickTime-based)"],[["J2C","J2K","JPC"],"JPEG 2000 codestream"],[["JP2","JPF","JPM","JPX"],"JPEG 2000 image [Compound/Extended]"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PEF"],"Pentax (RAW) Electronic Format (TIFF-based)"],[["PNG","JNG","MNG"],"Portable/JPEG/Multiple-image Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Kyocera Contax N Digital RAW"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["X3F"],"Sigma/Foveon RAW"],[["XMP"],"Extensible Metadata Platform sidecar file"]],xt=he("RawImage","Sharp","Video","Sidecar","AssetFile","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser"),RI=l(()=>{let t=new Xo,e=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"];for(let s of e)t.add(s,xt.RawImage);let r=A(["GIF","JPEG","PNG","PPM","TIFF","WEBP"]);for(let s of r)t.add(s,xt.Sharp);let i=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"];for(let s of i)t.add(s,xt.Video);let o=[...r,"HEIC",...e,...i];for(let s of o)t.add(s,xt.AssetFile);for(let s of zl)t.add(s,xt.Sidecar);for(let s of[...o,...zl])t.add(s,xt.Exif);for(let s of["GIF","JPEG","MP4","PNG","WEBM","WEBP"])t.add(s,xt.SupportedByCurrentBrowser);for(let s of["GIF","JPEG","MP4","PNG"])t.add(s,xt.SupportedByOldBrowser);let n=kI.map(s=>s[0]);for(let s of t.keys()){let a=n.find(m=>m.includes(s));if(a!=null&&a.length>0){let m=t.get(s);for(let c of a)t.has(c)||t.set(c,m)}}return t});function Id(t){return f(_I(t),e=>RI().get(e))}var NI=/\.?([a-z0-9]{2,4})$/i;function _I(t){return f(NI.exec(g(t)),e=>e[1].toUpperCase())}function ga(t,e){return J(Id(t),r=>r.includes(e),()=>!1)}function Wl(t){return ga(t,xt.Video)}function jl(t){return ga(t,xt.Sidecar)}function XT(t){return ga(t,xt.Exif)}function ZT(t){return ga(t,xt.SupportedByCurrentBrowser)}function Od(t,e){let r=BI(e);return r===""?t:t+"?"+r}function BI(t){if(t==null)return"";let e=ze(t).filter(([,r])=>r!=null);return L(e)?"":e.map(r=>r.map(g).map(encodeURIComponent).join("=")).join("&")}var zi="pslib",Mo="psfile",Qr="psnet";var ic=S(require("dns"));function bi(t,e){let r=0,i=new _i(e),o=n=>(r++,i.getOrSetAsync(k(n),async()=>t(n)));return o.clear=n=>{if(n==null)i.clear();else{let s=k(n);i.deleteIf(a=>s===a)}},o.size=()=>i.size,o.callCount=()=>r,o}var CI=bi(async t=>{let e=I?await Rw():"ping";return oe(e,[I?"-n":"-c","1",t],{timeout:5*E})},{maxSize:255,timeoutMs:yr,clearEveryMs:10*D}),kd=new RegExp("\\b"+ce(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),dY=bi(async t=>V(await CI(t).catch(e=>{console.warn("failed to ping: "+e)})).filter(v).flatMap(e=>kd.exec(g(e))).map(e=>e[0]).get(),{maxSize:255,timeoutMs:yr,clearEveryMs:10*D});var VI=new RegExp("^"+kd.source+"$"),zI=bi(async t=>{let e=VI.exec(t)==null?t:await eM(t);return g(e).toLowerCase().normalize()},{maxSize:128,timeoutMs:yr}),UI=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function Rd(t){return UI.exec(t)!=null}function tM(t){let e=t.split(".").map(r=>H(r)).filter(r=>ht(0,255,r));return e.length===4?e:void 0}var rM=bi(async t=>{if(!T(t)){if(tM(t)!=null)return[t];try{return await ic.promises.resolve4(t)}catch(e){oc().warn("No name found for "+t);return}}},{maxSize:256,timeoutMs:yr,clearEveryMs:10*D}),oc=l(()=>h("nslookup"));W(()=>j(()=>eM.clear()));var eM=bi(async t=>{try{let e=await ke(()=>Rd(t)?t.startsWith("127.")?["localhost"]:["127.0.0.1"]:tM(t)!=null?ic.promises.reverse(t):ic.promises.resolve4(t),5*E);if(e==null)return oc().info("nslookup("+t+"): timeout"),t;let r=e.find(v);return r??(oc().warn("No name found for "+t),t)}catch(e){return oc().warn("Failed to look up "+t+", using name.",e),t}},{maxSize:256,timeoutMs:yr,clearEveryMs:10*D});async function iM(t,e){return T(t)||T(e)?!1:Oe(t,e)||Rd(t)&&Rd(e)?!0:Ys(rM(t),rM(e),(r,i)=>r.some(o=>i.includes(o)),()=>!1)}var qI=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;async function WI(){let t=await oe("mount",[],{timeout:G});return A(t.split(`
`).map(e=>f(qI.exec(e),r=>{let[i,o,n]=r.slice(1),s=n.split(",").map(a=>a.trim());return{filesystem:i,mountpoint:o,options:s}})))}var oM=l(async()=>Oi(await WI(),async t=>t.options.includes("nobrowse")||t.options.includes("quarantine")||await jI(t.mountpoint)).then(t=>t.map(e=>e.filesystem)),ar);async function jI(t){let e=Me.for(t),r=await pe(await e.childNames(),i=>i.filter(o=>!o.startsWith(".")).map(o=>o.toLowerCase()).sort(),()=>[]);return $e(r,["applications","photostructure.app"])}function _d(t){return H(t,{defaultValue:0})*1024}var HI=["devfs"],GI=["udev","tmpfs","devtmpfs","shm"],KI=ae?HI:GI,JI=["/boot/efi","/dev/shm"];async function ss(t,e){let r=ae?await oM():[],i=["-k","-P"];t&&i.push("-l"),v(e)&&i.push(e);let o=await oe("df",i,{timeout:G,ignoreStderr:!0,ignoreExitCode:!0});return bo(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],o).map(s=>({filesystem:s.Filesystem,size:_d(s["1024-blocks"]),used:_d(s.Used),available:_d(s.Available),mountpoint:s["Mounted on"]})).filter(s=>{let a=g(s.filesystem),m=g(s.mountpoint);return v(m)&&!JI.includes(m)&&v(a)&&!r.includes(a)&&!KI.includes(a)})}var as=l(async()=>{if(!tt||Ce())return!1;try{return(await qe(nc,["version"],{timeout:G,ignoreStderr:!0})).code===0}catch(t){return!1}}),nc="gio",nM=["mount","--monitor","--anonymous"],$I=l(()=>h("Gio.gioVolumes()")),ya=l(()=>ke(async()=>{let t=await YI(),e=(await yl(t.map(async r=>{let i=await ss(!1,r.nativePath).catch(n=>{$I().warn("Failed to df "+r+": "+n)}),o=f(i,n=>n[0]);return f(o,n=>n.mountpoint=r.nativePath),o}))).filter(r=>r.size>0);return Promise.all(e.map(async r=>pe(QI(r.mountpoint),i=>(r.remoteHost=i.remoteHost,r.remoteShare=i.remoteShare,r.label=i.displayName,r.remote=!0,r),()=>r)))},ar,()=>h("Gio.gioVolumes").warn("timed out after "+ar+"ms")),Gn),XI=h("Gio.getRemoteInfo()"),QI=bi(async t=>{try{let e=(await oe(nc,["info",t],{timeout:G})).split(/[\n\r]+/),r=U(e.find(i=>i.startsWith("uri: ")),i=>new URL(Qe(i,"uri: ")));return{displayName:f(e.find(i=>i.startsWith("display name: ")),i=>Qe(i,"display name: ")),remoteHost:f(r,i=>i.hostname),remoteShare:V(r).flatMap(i=>i.pathname).flatMap(i=>Qe(i,"/")).flatMap(i=>ir(i,"/")).flatMap(decodeURIComponent).filter(v).get()}}catch(e){XI.warn("gio info failed",{mountpoint:t,err:e});return}},{maxSize:255,timeoutMs:yr,clearEveryMs:10*D}),sc=l(async()=>x(Me.for("/proc/mounts").readLines(),t=>t.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1])),Gn);async function YI(){return await as()?yl(await x(sc(),t=>t.map(e=>Me.for(e).clear().childDirectories()))):[]}var ba=S(require("luxon"));function Nd(t,e,r){return t!=null&&e!=null&&Math.abs(t.getTime()-e.getTime())<=r}function sM(t,e=2500){return t==null?!1:Ns(t)?Nd(t,new Date,e):Math.abs(t-Date.now())<e}function Bd(t,e=5*E){return N(t)&&Date.now()-t<=e}function aM(t=new Date){return[t.getFullYear(),Rt(t.getMonth()+1),Rt(t.getDate()),"-",Rt(t.getHours()),Rt(t.getMinutes()),Rt(t.getSeconds())].join("")}function Cd(t=new Date){return[t.getUTCFullYear(),Rt(t.getUTCMonth()+1),Rt(t.getUTCDate()),"-",Rt(t.getUTCHours()),Rt(t.getUTCMinutes()),Rt(t.getUTCSeconds())].join("")}function Vd(t){return V(t).filter(v).map(e=>ba.DateTime.fromISO(e)).filter(e=>e.isValid).map(e=>e.toMillis()).get()}function lM(t){return f(ZI(t),e=>e*100+ac(t.millisecond))}function ZI(t){return t==null||!t.isValid?void 0:H(t.toFormat("yMMddHHmmss"))}function ac(t){return Math.floor(t/10)}function zd(t,e){if(t==null||t<0)return;let r=t,i=()=>{let d=r%100;return r=Math.floor(r/100),d},o=10*i(),n=i(),s=i(),a=i(),m=i(),c=i();return{year:r,month:c,day:m,hour:a,minute:s,second:n,millisecond:o,zone:f(e,d=>ba.Info.normalizeZone(d))}}function lc(t,e){return f(zd(t,e),r=>ba.DateTime.fromObject(r))}function Hl(t,e){return f(lc(t,e),r=>r.toMillis())}function mc(t){let e=new Date(t);return H([e.getFullYear(),...[e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),ac(e.getUTCMilliseconds())].map(Rt)].join(""))}function uc(t){return new mM(w({name:A([t.cmd,...t.args]).join(" "),childFactory:()=>lT(t.cmd,t.args,30*D),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},t))}var mM=class{constructor(e){this.startMs=Date.now();this._stopped=!1;this.logger=l(()=>h("WatchedChild("+A([this.name,this.pid]).join(":")+")"));this.startRate=new Yo(2*D);this.mutex=new Ii;this._ended=!1;this.onError=async(e,r)=>{let i=Li(e)||Li(r),o=new ue({message:e+f(r,Se),cause:xu(r)?r:void 0}),n=nr(o),s={src:e,fatal:i,ignorable:n,errToS:Se(r)};if(this.logger().log(n?"warn":"error","onError()",s),this._ended||n)return;if(this.lastError=o,se(e,o),i)return this.end();if(this.opts.onError(e,r))return this.logger().warn("onError requested restart",s),this._restart()};this.name=e.name,this.opts=w({dataSep:`
`,maxErrorsPerMinute:3,endableRank:be.first,exitCommand:"",restartOnExit:!0},e),this.endTimeoutMs=ib(this.name),Jn(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}async end(){return this._ended=!0,this._stop()}get proc(){return this.cp}get pid(){return f(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return J(this.pid,e=>Wu(e),async()=>!1)}notRunning(){return gt(this.running())}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}async _stop(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});let e=this.cp;return this.cp=void 0,e==null?!0:this.stopChild(e)}async stopChild(e){return await V(this.opts.exitCommand).filter(v).flatMap(r=>V(e).flatMap(i=>i.stdin).filter(i=>i.writable).forEach(i=>dt(()=>i.write(r+`
`))).map(ki).get()),Nl(e,this.endTimeoutMs)}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:On(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){if(this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),this._ended||me())return!1;if(!e&&this.startRate.msSinceLastEvent<u.minTimeBetweenServiceRestartsMs.valueOrDefault){this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:u.minTimeBetweenServiceRestartsMs.valueOrDefault});return}return this.mutex.serial(`WatchedChild(${this.name}).restart`,async()=>(await this._stop(),this._stopped=!1,this._start()))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,async()=>(this._stopped=!1,this._start()))}async _restart(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,async()=>(await this._stop(),this._stopped||this._ended?!1:this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),Bd(this.startMs,u.probationMs.valueOrDefault)&&se("Can't restart "+this.name+", failure rate is too high."+ye,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),this.opts.onRestart?.(),this._start())))}async _start(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended||await this.running())return!1;this.startRate.onEvent();let e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);let r="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:i,desc:o})=>{f(i,n=>n.on("error",s=>this.onError(r+o+".on(error)",s)))}),f(this.cp.stdout,i=>nn(i,this.opts.dataSep,o=>{this.logger().trace("onDataChunked()",o),this.opts.onStdout(o)})),f(this.cp.stderr,i=>i.on("data",o=>{g(o).includes("Error: Cannot find module")&&se("Failed to start "+this.name+ye,new Error(dr(o,256))),this.opts.onStderr?.(o)===!0&&this.onError(r+".stderr.on(data)",o)})),this.cp.on("exit",async(i,o)=>{this.logger().info("onExit",{code:i,signal:o,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?(await this._restart(),this.logger().info("onExit(): finished setting up new child "+this.pid)):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending "+this.pid),this.end())}),!0}};var Ud=S(require("timers"));function cc(t,e){e=Math.ceil(e);let r,i=[],o=(...n)=>{i=n,f(r,Ud.clearTimeout),r=$s(()=>t(...i),e)};return o.reset=()=>{f(r,Ud.clearTimeout),r=void 0},o.now=()=>{o.reset(),t()},o}var eO=h("Mountpoints.localMountpointSetup()");async function uM(){let t=await x(ss(!1),e=>R(e.map(r=>r.mountpoint)));if(t!=null&&await as())try{await x(ya(),e=>t.push(...e.map(r=>r.mountpoint)))}catch(e){eO.warn("Failed to fetch gio volumes",e)}return f(t,e=>e.filter(r=>!r.startsWith("/snap/")&&r!=="/dev"))}var tO=/\s([A-Z]:\\)/g,cM=async()=>bt(de.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(t=>t.map(e=>e.Root)).filter(C).orElse(()=>rO()).map(t=>t.sort()).getRequired(),rO=async()=>{let t=(await oe(await kw(),["fsinfo","drives"],{timeout:10*E})).trim(),e=[],r;for(;(r=tO.exec(t))!==null;)e.push(r[1]);return e};var iO=()=>I?cM():uM(),fM;function pM(t){fM=t,oO()}var oO=l(async()=>{Wo()?W(async()=>{let t=h("Mountpoints.localMountpointSetup()");ae&&(t.info("Setting up Mac diskutil activity watcher"),ut.setTTL(Gn),dM()),tt&&(await as()&&(t.info("Setting up Linux gio mount monitor"),ut.setTTL(Gn),hM()),await nO()&&(t.info("Setting up Linux findmnt mount monitor"),ut.setTTL(Gn),gM()))},30*E).unref():await vu([yi(dM.clear()),yi(hM.clear()),yi(gM.clear())])}),ut=l(async()=>(await Kr(()=>Ct(fM,iO),{maxRetries:3,onRetryWaitUntil:r=>lt(r*1500)}).catch(r=>{se("mountpoints() failed",r)}))?.sort(),ar);W(()=>j(()=>ut.unset()));var dM=l(()=>uc({cmd:"diskutil",args:["activity"],onStdout:cc(()=>ut.unset(),1.5*E)})),hM=l(()=>uc({cmd:nc,args:nM,onStdout:cc(()=>{ya.unset(),sc.unset(),ut.unset()},1.5*E)})),nO=l(async()=>{if(!tt)return!1;try{return(await qe("findmnt",["--version"],{timeout:G,ignoreStderr:!0})).code===0}catch(t){return!1}}),gM=l(()=>uc({cmd:"findmnt",args:["--poll"],onStdout:cc(()=>{sc.unset(),ut.unset()},1.5*E)}));function Or(t,e){let r=ew("vol."+t,()=>Kr(e,{maxRetries:2,timeoutMs:G,errorIsRetriable:i=>nr(i)}),vx);return ut.onChange(()=>r.unset()),W(()=>j(()=>r.unset())),r}var sO=Or("localMountpoints",()=>x(ss(!0),t=>t.map(e=>e.mountpoint))),yM=Or("dfPosix",async()=>{let t=await ss(!1);if(t!=null)return await x(sO(),e=>{t.forEach(r=>{r.remote=!e.includes(r.mountpoint)})}),await as()&&await x(ya(),e=>t.push(...e)),t});async function bM(t,e){if(!I)throw new Error("wtf");return await x(M(e,()=>aO()),r=>{let i=Il(r,o=>[o.mountpoint,o]);t.forEach(o=>{f(i.get(o.mountpoint),n=>{o.remote=!0,o.remoteHost=n.host,o.remoteShare=n.share,o.ok=n.ok})})}),t}var xM=["LocalName","RemoteName","Status"],lO=["NETUSE","get",xM.join(",")],wM=/^\\\\(.+?)\\(.+)$/,TM=/^[a-z]:\\?$/i;async function uO(){let t=await de.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return t==null?mO():A(t.filter(e=>v(e.LocalName)).map(e=>f(qd(e.RemoteName),({host:r,share:i})=>f(TM.exec(g(e.LocalName)),o=>({mountpoint:Ht(o[0],"\\"),host:r,share:i,ok:e.Status==="OK"&&e.ConnectionState==="Connected"})))))}function qd(t){if(!T(t))return V(t).flatMap(e=>wM.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>V(t).flatMap(e=>dt(()=>new URL(e))).filter(e=>v(e.hostname)).map(e=>({host:e.hostname,share:V(e.pathname).filter(v).getOrElse(()=>"/")}))).get()}async function mO(){let t=Uu(),e=await oe(t,lO,{timeout:15*E}),r=bo(xM,e);return A(r.map(i=>f(wM.exec(g(i.RemoteName)),o=>f(TM.exec(g(i.LocalName)),n=>({mountpoint:Ht(n[0],"\\"),host:o[1],share:o[2],ok:i.Status==="OK"})))))}var aO=Or("netInfoWin",uO);var MM=l(()=>h("DfWin")),vM=Or("dfWin",async()=>(await cO()).filter(e=>e.ok!==!1&&N(e.size))),fO="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free";function pO(t){return v(t.Root)&&t.Free!=null&&t.Used!=null?w({mountpoint:t.Root,label:t.Description,size:t.Used+t.Free,used:t.Used,available:t.Free,remote:v(t.DisplayRoot)},f(qd(t.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))):void 0}var dO="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus,UniqueId",hO=/\{([-a-z0-9]{7,})\}/i;function gO(t){return MM().tap({msg:"uniqueId2uuid",result:f(hO.exec(g(t)),e=>e[1]),meta:{s:t}})}function yO(t){if(t.DriveLetter==null||t.DriveLetter==="null"||t.FileSystemLabel==="System Reserved")return;let e=t.Size!=null&&t.SizeRemaining!=null&&v(t.DriveLetter)&&(Yf(t.HealthStatus,r=>Oe(r,"Healthy"))||Yf(t.OperationalStatus,r=>Oe(r,"OK")));return{mountpoint:t.DriveLetter+":\\",filesystem:t.FileSystem,label:t.FileSystemLabel,uuid:gO(t.UniqueId),size:t.Size,used:t.Size-t.SizeRemaining,available:t.SizeRemaining,remote:!1,ok:e}}async function cO(){let t=await le(de.instance().executeJsonToA(fO).catch(o=>(se("volumeInfoWin(): LocalAndNetCmd failed",o),[])),o=>ip(pO(o))),e=await le(de.instance().executeJsonToA(dO).catch(o=>(se("_localAndNet(): LocalCmd failed",o),[])),o=>ip(yO(o))),r=z([...t,...e].filter(o=>o.ok===!1).map(o=>o.mountpoint)),i=tr(z([...t,...e].map(o=>o.mountpoint)).filter(o=>!r.includes(o)));return MM().info("volumeInfoWin()",{getPsDrive:t,getVolumes:e,mountpoints:i,unhealthy:r}),i.map(o=>w(w({},t.find(n=>o===n.mountpoint)),e.find(n=>o===n.mountpoint)))}async function SM(t){return x(bO(),e=>t.map(r=>J(e.get(r.mountpoint),i=>w(w({},r),i),()=>r)))}var bO=Or("mnt2uuidMac",async()=>{let e=(await oe("diskutil",["info","-all"],{timeout:G})).split(/^\s*\*{8,12}\s*$/m);return Il(e,r=>{let i=Il(r.split(/\s*\n+\s*/),a=>{let[m,c]=a.split(":").map(p=>p.trim());return _t(["not applicable","no file system"],c)?void 0:[m.toLowerCase(),c]}),o=i.get("mount point"),n=i.get("volume name"),s=i.get("volume uuid");return T(o)?void 0:[o,{label:n,uuid:s}]})});function fc({input:t,lowerCaseKeys:e}){let r={},i;for(let o of yo(t).filter(n=>n.match(/^\s*#/)==null)){let n=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+|#.*?)/gim;for(;(i=n.exec(o))!=null;){let[,s,a,m]=i;r[e?s.toLowerCase():s]=Ib(m,a,a)}}return r}var xO=l(()=>h("LocalVolumesPosix"));async function PM(t){return x(await wO(),e=>gp(z([...e.filter(i=>!i.ignorable).map(i=>i.mountpoint),...t.map(i=>i.mountpoint)])).map(i=>w(w({},t.find(o=>o.mountpoint===i)),e.find(o=>o.mountpoint===i))))}var wO=Or("localVolumeInfoPosix",async()=>{let t=await oe("lsblk",["-P","-b","--output","mountpoint,label,fsused,fsavail,uuid"],{timeout:G}),e=yo(t).map(i=>fc({input:i,lowerCaseKeys:!0})).filter(i=>i!=null),r=await sr(e,async i=>{let o=T(i.mountpoint)||i.mountpoint.startsWith("/snap/")||i.mountpoint==="/boot"||i.mountpoint.startsWith("/boot/")||!await kx(i.mountpoint);return zo(H(i.fsused),H(i.fsavail),(n,s)=>w({mountpoint:i.mountpoint,label:i.label,uuid:i.uuid,ignorable:o,used:n,available:s,size:n+s},Ce()?void 0:{remote:!1}))});return xO().tap({msg:"lsblk",result:r})});var TO=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i,MO=/^([^:\s]+):(\/.+)$/;async function EM(t){return t.filter(e=>e.remote).forEach(e=>{J(TO.exec(g(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]},()=>f(MO.exec(g(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]}))}),t}async function DM(t,e){try{return await(e.timeoutMs==null?t():ke(t,e.timeoutMs,()=>se(e.message+": timeout",void 0,e.context)))}catch(r){se(e.message,r,e.context);return}}var AM=S(require("crypto"));function vO(){let t=(0,AM.randomBytes)(16);t[6]=t[6]&15|64;let e=t.toString("hex");return[e.slice(0,8),e.slice(8,12),e.slice(12,16),e.slice(16,20),e.slice(20)].join("-")}function pc(){return Pl(vO)}var ate=l(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/);var Gl=l(()=>h("VolumeUUID")),FM=ar/2,Wd=new Map;W(()=>{j(()=>Wd.clear()),ut.onChange(()=>Wd.clear())});async function LM(t){await Jo({name:"addVolumeUUIDs",laters:t.map(e=>()=>SO(e))})}async function SO(t){if(B(t.ignorable)){Gl().debug("volumeUUID(): ignorable is true for "+t.mountpoint);return}if(Pr(t.ok)){Gl().debug("volumeUUID(): remoteOK is false for "+t.mountpoint);return}await x(Ur(Wd,t.mountpoint,()=>sa(()=>DM(()=>PO(t),{message:"readVolumeUUID("+t.mountpoint+")"}),FM)),e=>t.uuid=e)}async function PO(t){let e=ee.for(t.mountpoint).join(".uuid");if(u.readVolumeUuidFiles.valueOrDefault){let r=await sa(()=>bt(e.readFile("debug")).map(i=>i.toString().trim()).filter(v).get(),FM);if(r!=null&&r.length>6)return Gl().debug("Serving UUID from .uuid",{uuid:r,mountpoint:t.mountpoint}),r}if(t.mountpoint==="/")return t.uuid;if(u.writeVolumeUuidFiles.valueOrDefault){let r=Zt(t.uuid,pc);if(await e.parent().isReadWritable())try{return await e.writeTxt_(r),Gl().info("volumeUUID(): Saved new UUID for "+t.mountpoint,{uuid:r}),r}catch(i){Gl().warn("volumeUUID(): Failed to save new UUID for "+t.mountpoint,i)}}return t.uuid}var Kl=l(()=>h("Volumes"));async function EO(){let t=await ke(I?vM():yM(),ar,()=>se("Timed out getting local volume metadata"));if(t==null){Kl().warn("df failed");return}let e=u.validateMountpoints.valueOrDefault?A(await Jo({name:"nonRpcVolumes: filter unhealthy volumes",laters:t.map(o=>async()=>{try{if(await Qo(o.mountpoint,Zs/2))return o;Kl().info("validateMountpoints(): "+o.mountpoint+" is not a directory")}catch(n){Kl().info("validateMountpoints(): failed to stat "+o.mountpoint,n)}})})):t;e.some(o=>o.remote&&T(o.remoteHost))&&await ke(I?bM(e):EM(e),10*E).catch(o=>{se("Failed to get remote volume info",o)});let r=M(await(I?e:ae?SM(e):PM(e)),e);ft(r,o=>!B(o.ignorable)),u.ignoreUnhealthyVolumes.valueOrDefault&&ft(r,o=>!Pr(o.ok));for(let o of r)o.remote=B(o.remote),U(o.remoteHost,n=>o.remoteHost=n.toLowerCase().normalize().trim());for(let o of r)T(o.label)&&delete o.label;Kl().debug("nonRpcVolumes(): before addVolumeUUIDs",r),await LM(r);let i=$(r,o=>o.mountpoint);return Kl().debug("_volumes(): final result",{sorted:i}),Object.freeze(i)}var IM;function OM(t){IM=t}var kM=[],DO=async()=>{try{let t=await Ct(IM,EO);return Ae(t,e=>{let r=e.map(i=>i.mountpoint).sort();$e(kM,r)||(ix(),kM=r)}),t}catch(t){se("volumes() failed",t);return}},Ot=Or("volumes",DO),are=l(()=>I?V(He("SystemDrive")).filter(v).orElse(()=>"C:").map(t=>Ht(t,"\\")).get():"/");async function xa(t){return x(Ot(),e=>jd(e,t))}function jd(t,e){let r=t.filter(i=>ia(e,i.mountpoint));return et(r,i=>nl(i.mountpoint,e))}var yc=S(require("path"));function dc(t,e){let r=0,i=new _e(e.maxSize,e.ttlMs),o=n=>(r++,i.getOrSet(k(n),()=>t(n)));return o.clear=n=>n==null?i.clear():i.delete(k(n)),o.size=()=>i.size,o.callCount=()=>r,o}var hc=S(require("path")),RM=S(require("punycode")),_M=S(require("util"));var X;(function(t){t[t.Null=0]="Null",t[t.Backspace=8]="Backspace",t[t.Tab=9]="Tab",t[t.LineFeed=10]="LineFeed",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.ExclamationMark=33]="ExclamationMark",t[t.DoubleQuote=34]="DoubleQuote",t[t.Hash=35]="Hash",t[t.DollarSign=36]="DollarSign",t[t.PercentSign=37]="PercentSign",t[t.Ampersand=38]="Ampersand",t[t.SingleQuote=39]="SingleQuote",t[t.OpenParen=40]="OpenParen",t[t.CloseParen=41]="CloseParen",t[t.Asterisk=42]="Asterisk",t[t.Plus=43]="Plus",t[t.Comma=44]="Comma",t[t.Dash=45]="Dash",t[t.Period=46]="Period",t[t.Slash=47]="Slash",t[t.Digit0=48]="Digit0",t[t.Digit1=49]="Digit1",t[t.Digit2=50]="Digit2",t[t.Digit3=51]="Digit3",t[t.Digit4=52]="Digit4",t[t.Digit5=53]="Digit5",t[t.Digit6=54]="Digit6",t[t.Digit7=55]="Digit7",t[t.Digit8=56]="Digit8",t[t.Digit9=57]="Digit9",t[t.Colon=58]="Colon",t[t.Semicolon=59]="Semicolon",t[t.LessThan=60]="LessThan",t[t.Equals=61]="Equals",t[t.GreaterThan=62]="GreaterThan",t[t.QuestionMark=63]="QuestionMark",t[t.AtSign=64]="AtSign",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.OpenSquareBracket=91]="OpenSquareBracket",t[t.Backslash=92]="Backslash",t[t.CloseSquareBracket=93]="CloseSquareBracket",t[t.Caret=94]="Caret",t[t.Underline=95]="Underline",t[t.BackTick=96]="BackTick",t[t.a=97]="a",t[t.b=98]="b",t[t.c=99]="c",t[t.d=100]="d",t[t.e=101]="e",t[t.f=102]="f",t[t.g=103]="g",t[t.h=104]="h",t[t.i=105]="i",t[t.j=106]="j",t[t.k=107]="k",t[t.l=108]="l",t[t.m=109]="m",t[t.n=110]="n",t[t.o=111]="o",t[t.p=112]="p",t[t.q=113]="q",t[t.r=114]="r",t[t.s=115]="s",t[t.t=116]="t",t[t.u=117]="u",t[t.v=118]="v",t[t.w=119]="w",t[t.x=120]="x",t[t.y=121]="y",t[t.z=122]="z",t[t.OpenCurlyBrace=123]="OpenCurlyBrace",t[t.Pipe=124]="Pipe",t[t.CloseCurlyBrace=125]="CloseCurlyBrace",t[t.Tilde=126]="Tilde",t[t.U_Combining_Grave_Accent=768]="U_Combining_Grave_Accent",t[t.U_Combining_Acute_Accent=769]="U_Combining_Acute_Accent",t[t.U_Combining_Circumflex_Accent=770]="U_Combining_Circumflex_Accent",t[t.U_Combining_Tilde=771]="U_Combining_Tilde",t[t.U_Combining_Macron=772]="U_Combining_Macron",t[t.U_Combining_Overline=773]="U_Combining_Overline",t[t.U_Combining_Breve=774]="U_Combining_Breve",t[t.U_Combining_Dot_Above=775]="U_Combining_Dot_Above",t[t.U_Combining_Diaeresis=776]="U_Combining_Diaeresis",t[t.U_Combining_Hook_Above=777]="U_Combining_Hook_Above",t[t.U_Combining_Ring_Above=778]="U_Combining_Ring_Above",t[t.U_Combining_Double_Acute_Accent=779]="U_Combining_Double_Acute_Accent",t[t.U_Combining_Caron=780]="U_Combining_Caron",t[t.U_Combining_Vertical_Line_Above=781]="U_Combining_Vertical_Line_Above",t[t.U_Combining_Double_Vertical_Line_Above=782]="U_Combining_Double_Vertical_Line_Above",t[t.U_Combining_Double_Grave_Accent=783]="U_Combining_Double_Grave_Accent",t[t.U_Combining_Candrabindu=784]="U_Combining_Candrabindu",t[t.U_Combining_Inverted_Breve=785]="U_Combining_Inverted_Breve",t[t.U_Combining_Turned_Comma_Above=786]="U_Combining_Turned_Comma_Above",t[t.U_Combining_Comma_Above=787]="U_Combining_Comma_Above",t[t.U_Combining_Reversed_Comma_Above=788]="U_Combining_Reversed_Comma_Above",t[t.U_Combining_Comma_Above_Right=789]="U_Combining_Comma_Above_Right",t[t.U_Combining_Grave_Accent_Below=790]="U_Combining_Grave_Accent_Below",t[t.U_Combining_Acute_Accent_Below=791]="U_Combining_Acute_Accent_Below",t[t.U_Combining_Left_Tack_Below=792]="U_Combining_Left_Tack_Below",t[t.U_Combining_Right_Tack_Below=793]="U_Combining_Right_Tack_Below",t[t.U_Combining_Left_Angle_Above=794]="U_Combining_Left_Angle_Above",t[t.U_Combining_Horn=795]="U_Combining_Horn",t[t.U_Combining_Left_Half_Ring_Below=796]="U_Combining_Left_Half_Ring_Below",t[t.U_Combining_Up_Tack_Below=797]="U_Combining_Up_Tack_Below",t[t.U_Combining_Down_Tack_Below=798]="U_Combining_Down_Tack_Below",t[t.U_Combining_Plus_Sign_Below=799]="U_Combining_Plus_Sign_Below",t[t.U_Combining_Minus_Sign_Below=800]="U_Combining_Minus_Sign_Below",t[t.U_Combining_Palatalized_Hook_Below=801]="U_Combining_Palatalized_Hook_Below",t[t.U_Combining_Retroflex_Hook_Below=802]="U_Combining_Retroflex_Hook_Below",t[t.U_Combining_Dot_Below=803]="U_Combining_Dot_Below",t[t.U_Combining_Diaeresis_Below=804]="U_Combining_Diaeresis_Below",t[t.U_Combining_Ring_Below=805]="U_Combining_Ring_Below",t[t.U_Combining_Comma_Below=806]="U_Combining_Comma_Below",t[t.U_Combining_Cedilla=807]="U_Combining_Cedilla",t[t.U_Combining_Ogonek=808]="U_Combining_Ogonek",t[t.U_Combining_Vertical_Line_Below=809]="U_Combining_Vertical_Line_Below",t[t.U_Combining_Bridge_Below=810]="U_Combining_Bridge_Below",t[t.U_Combining_Inverted_Double_Arch_Below=811]="U_Combining_Inverted_Double_Arch_Below",t[t.U_Combining_Caron_Below=812]="U_Combining_Caron_Below",t[t.U_Combining_Circumflex_Accent_Below=813]="U_Combining_Circumflex_Accent_Below",t[t.U_Combining_Breve_Below=814]="U_Combining_Breve_Below",t[t.U_Combining_Inverted_Breve_Below=815]="U_Combining_Inverted_Breve_Below",t[t.U_Combining_Tilde_Below=816]="U_Combining_Tilde_Below",t[t.U_Combining_Macron_Below=817]="U_Combining_Macron_Below",t[t.U_Combining_Low_Line=818]="U_Combining_Low_Line",t[t.U_Combining_Double_Low_Line=819]="U_Combining_Double_Low_Line",t[t.U_Combining_Tilde_Overlay=820]="U_Combining_Tilde_Overlay",t[t.U_Combining_Short_Stroke_Overlay=821]="U_Combining_Short_Stroke_Overlay",t[t.U_Combining_Long_Stroke_Overlay=822]="U_Combining_Long_Stroke_Overlay",t[t.U_Combining_Short_Solidus_Overlay=823]="U_Combining_Short_Solidus_Overlay",t[t.U_Combining_Long_Solidus_Overlay=824]="U_Combining_Long_Solidus_Overlay",t[t.U_Combining_Right_Half_Ring_Below=825]="U_Combining_Right_Half_Ring_Below",t[t.U_Combining_Inverted_Bridge_Below=826]="U_Combining_Inverted_Bridge_Below",t[t.U_Combining_Square_Below=827]="U_Combining_Square_Below",t[t.U_Combining_Seagull_Below=828]="U_Combining_Seagull_Below",t[t.U_Combining_X_Above=829]="U_Combining_X_Above",t[t.U_Combining_Vertical_Tilde=830]="U_Combining_Vertical_Tilde",t[t.U_Combining_Double_Overline=831]="U_Combining_Double_Overline",t[t.U_Combining_Grave_Tone_Mark=832]="U_Combining_Grave_Tone_Mark",t[t.U_Combining_Acute_Tone_Mark=833]="U_Combining_Acute_Tone_Mark",t[t.U_Combining_Greek_Perispomeni=834]="U_Combining_Greek_Perispomeni",t[t.U_Combining_Greek_Koronis=835]="U_Combining_Greek_Koronis",t[t.U_Combining_Greek_Dialytika_Tonos=836]="U_Combining_Greek_Dialytika_Tonos",t[t.U_Combining_Greek_Ypogegrammeni=837]="U_Combining_Greek_Ypogegrammeni",t[t.U_Combining_Bridge_Above=838]="U_Combining_Bridge_Above",t[t.U_Combining_Equals_Sign_Below=839]="U_Combining_Equals_Sign_Below",t[t.U_Combining_Double_Vertical_Line_Below=840]="U_Combining_Double_Vertical_Line_Below",t[t.U_Combining_Left_Angle_Below=841]="U_Combining_Left_Angle_Below",t[t.U_Combining_Not_Tilde_Above=842]="U_Combining_Not_Tilde_Above",t[t.U_Combining_Homothetic_Above=843]="U_Combining_Homothetic_Above",t[t.U_Combining_Almost_Equal_To_Above=844]="U_Combining_Almost_Equal_To_Above",t[t.U_Combining_Left_Right_Arrow_Below=845]="U_Combining_Left_Right_Arrow_Below",t[t.U_Combining_Upwards_Arrow_Below=846]="U_Combining_Upwards_Arrow_Below",t[t.U_Combining_Grapheme_Joiner=847]="U_Combining_Grapheme_Joiner",t[t.U_Combining_Right_Arrowhead_Above=848]="U_Combining_Right_Arrowhead_Above",t[t.U_Combining_Left_Half_Ring_Above=849]="U_Combining_Left_Half_Ring_Above",t[t.U_Combining_Fermata=850]="U_Combining_Fermata",t[t.U_Combining_X_Below=851]="U_Combining_X_Below",t[t.U_Combining_Left_Arrowhead_Below=852]="U_Combining_Left_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_Below=853]="U_Combining_Right_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below=854]="U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below",t[t.U_Combining_Right_Half_Ring_Above=855]="U_Combining_Right_Half_Ring_Above",t[t.U_Combining_Dot_Above_Right=856]="U_Combining_Dot_Above_Right",t[t.U_Combining_Asterisk_Below=857]="U_Combining_Asterisk_Below",t[t.U_Combining_Double_Ring_Below=858]="U_Combining_Double_Ring_Below",t[t.U_Combining_Zigzag_Above=859]="U_Combining_Zigzag_Above",t[t.U_Combining_Double_Breve_Below=860]="U_Combining_Double_Breve_Below",t[t.U_Combining_Double_Breve=861]="U_Combining_Double_Breve",t[t.U_Combining_Double_Macron=862]="U_Combining_Double_Macron",t[t.U_Combining_Double_Macron_Below=863]="U_Combining_Double_Macron_Below",t[t.U_Combining_Double_Tilde=864]="U_Combining_Double_Tilde",t[t.U_Combining_Double_Inverted_Breve=865]="U_Combining_Double_Inverted_Breve",t[t.U_Combining_Double_Rightwards_Arrow_Below=866]="U_Combining_Double_Rightwards_Arrow_Below",t[t.U_Combining_Latin_Small_Letter_A=867]="U_Combining_Latin_Small_Letter_A",t[t.U_Combining_Latin_Small_Letter_E=868]="U_Combining_Latin_Small_Letter_E",t[t.U_Combining_Latin_Small_Letter_I=869]="U_Combining_Latin_Small_Letter_I",t[t.U_Combining_Latin_Small_Letter_O=870]="U_Combining_Latin_Small_Letter_O",t[t.U_Combining_Latin_Small_Letter_U=871]="U_Combining_Latin_Small_Letter_U",t[t.U_Combining_Latin_Small_Letter_C=872]="U_Combining_Latin_Small_Letter_C",t[t.U_Combining_Latin_Small_Letter_D=873]="U_Combining_Latin_Small_Letter_D",t[t.U_Combining_Latin_Small_Letter_H=874]="U_Combining_Latin_Small_Letter_H",t[t.U_Combining_Latin_Small_Letter_M=875]="U_Combining_Latin_Small_Letter_M",t[t.U_Combining_Latin_Small_Letter_R=876]="U_Combining_Latin_Small_Letter_R",t[t.U_Combining_Latin_Small_Letter_T=877]="U_Combining_Latin_Small_Letter_T",t[t.U_Combining_Latin_Small_Letter_V=878]="U_Combining_Latin_Small_Letter_V",t[t.U_Combining_Latin_Small_Letter_X=879]="U_Combining_Latin_Small_Letter_X",t[t.LINE_SEPARATOR=8232]="LINE_SEPARATOR",t[t.PARAGRAPH_SEPARATOR=8233]="PARAGRAPH_SEPARATOR",t[t.NEXT_LINE=133]="NEXT_LINE",t[t.U_CIRCUMFLEX=94]="U_CIRCUMFLEX",t[t.U_GRAVE_ACCENT=96]="U_GRAVE_ACCENT",t[t.U_DIAERESIS=168]="U_DIAERESIS",t[t.U_MACRON=175]="U_MACRON",t[t.U_ACUTE_ACCENT=180]="U_ACUTE_ACCENT",t[t.U_CEDILLA=184]="U_CEDILLA",t[t.U_MODIFIER_LETTER_LEFT_ARROWHEAD=706]="U_MODIFIER_LETTER_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_RIGHT_ARROWHEAD=707]="U_MODIFIER_LETTER_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_UP_ARROWHEAD=708]="U_MODIFIER_LETTER_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_DOWN_ARROWHEAD=709]="U_MODIFIER_LETTER_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING=722]="U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING",t[t.U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING=723]="U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING",t[t.U_MODIFIER_LETTER_UP_TACK=724]="U_MODIFIER_LETTER_UP_TACK",t[t.U_MODIFIER_LETTER_DOWN_TACK=725]="U_MODIFIER_LETTER_DOWN_TACK",t[t.U_MODIFIER_LETTER_PLUS_SIGN=726]="U_MODIFIER_LETTER_PLUS_SIGN",t[t.U_MODIFIER_LETTER_MINUS_SIGN=727]="U_MODIFIER_LETTER_MINUS_SIGN",t[t.U_BREVE=728]="U_BREVE",t[t.U_DOT_ABOVE=729]="U_DOT_ABOVE",t[t.U_RING_ABOVE=730]="U_RING_ABOVE",t[t.U_OGONEK=731]="U_OGONEK",t[t.U_SMALL_TILDE=732]="U_SMALL_TILDE",t[t.U_DOUBLE_ACUTE_ACCENT=733]="U_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_RHOTIC_HOOK=734]="U_MODIFIER_LETTER_RHOTIC_HOOK",t[t.U_MODIFIER_LETTER_CROSS_ACCENT=735]="U_MODIFIER_LETTER_CROSS_ACCENT",t[t.U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR=741]="U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_HIGH_TONE_BAR=742]="U_MODIFIER_LETTER_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_MID_TONE_BAR=743]="U_MODIFIER_LETTER_MID_TONE_BAR",t[t.U_MODIFIER_LETTER_LOW_TONE_BAR=744]="U_MODIFIER_LETTER_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR=745]="U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK=746]="U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK=747]="U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_UNASPIRATED=749]="U_MODIFIER_LETTER_UNASPIRATED",t[t.U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD=751]="U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_UP_ARROWHEAD=752]="U_MODIFIER_LETTER_LOW_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD=753]="U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD=754]="U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RING=755]="U_MODIFIER_LETTER_LOW_RING",t[t.U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT=756]="U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT=757]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT=758]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_LOW_TILDE=759]="U_MODIFIER_LETTER_LOW_TILDE",t[t.U_MODIFIER_LETTER_RAISED_COLON=760]="U_MODIFIER_LETTER_RAISED_COLON",t[t.U_MODIFIER_LETTER_BEGIN_HIGH_TONE=761]="U_MODIFIER_LETTER_BEGIN_HIGH_TONE",t[t.U_MODIFIER_LETTER_END_HIGH_TONE=762]="U_MODIFIER_LETTER_END_HIGH_TONE",t[t.U_MODIFIER_LETTER_BEGIN_LOW_TONE=763]="U_MODIFIER_LETTER_BEGIN_LOW_TONE",t[t.U_MODIFIER_LETTER_END_LOW_TONE=764]="U_MODIFIER_LETTER_END_LOW_TONE",t[t.U_MODIFIER_LETTER_SHELF=765]="U_MODIFIER_LETTER_SHELF",t[t.U_MODIFIER_LETTER_OPEN_SHELF=766]="U_MODIFIER_LETTER_OPEN_SHELF",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROW=767]="U_MODIFIER_LETTER_LOW_LEFT_ARROW",t[t.U_GREEK_LOWER_NUMERAL_SIGN=885]="U_GREEK_LOWER_NUMERAL_SIGN",t[t.U_GREEK_TONOS=900]="U_GREEK_TONOS",t[t.U_GREEK_DIALYTIKA_TONOS=901]="U_GREEK_DIALYTIKA_TONOS",t[t.U_GREEK_KORONIS=8125]="U_GREEK_KORONIS",t[t.U_GREEK_PSILI=8127]="U_GREEK_PSILI",t[t.U_GREEK_PERISPOMENI=8128]="U_GREEK_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_PERISPOMENI=8129]="U_GREEK_DIALYTIKA_AND_PERISPOMENI",t[t.U_GREEK_PSILI_AND_VARIA=8141]="U_GREEK_PSILI_AND_VARIA",t[t.U_GREEK_PSILI_AND_OXIA=8142]="U_GREEK_PSILI_AND_OXIA",t[t.U_GREEK_PSILI_AND_PERISPOMENI=8143]="U_GREEK_PSILI_AND_PERISPOMENI",t[t.U_GREEK_DASIA_AND_VARIA=8157]="U_GREEK_DASIA_AND_VARIA",t[t.U_GREEK_DASIA_AND_OXIA=8158]="U_GREEK_DASIA_AND_OXIA",t[t.U_GREEK_DASIA_AND_PERISPOMENI=8159]="U_GREEK_DASIA_AND_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_VARIA=8173]="U_GREEK_DIALYTIKA_AND_VARIA",t[t.U_GREEK_DIALYTIKA_AND_OXIA=8174]="U_GREEK_DIALYTIKA_AND_OXIA",t[t.U_GREEK_VARIA=8175]="U_GREEK_VARIA",t[t.U_GREEK_OXIA=8189]="U_GREEK_OXIA",t[t.U_GREEK_DASIA=8190]="U_GREEK_DASIA",t[t.U_OVERLINE=8254]="U_OVERLINE",t[t.UTF8_BOM=65279]="UTF8_BOM"})(X||(X={}));var AO=/^\w[\w\d+.-]*$/,FO=/^\//,LO=/^\/\//;function IO(t,e){if(!t.scheme&&e===!0)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${t.authority}", path: "${t.path}", query: "${t.query}", fragment: "${t.fragment}"}`);if(t.scheme&&!AO.test(t.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(t.path){if(t.authority){if(!FO.test(t.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(LO.test(t.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}}function OO(t,e){return!t&&!e?"file":t}function kO(t,e){switch(t){case"https":case"http":case"file":e?e[0]!==Jt&&(e=Jt+e):e=Jt;break}return e}var Ve="",Jt="/",RO=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,Le=class{static isUri(e){return e instanceof Le?!0:e==null?!1:typeof e.authority=="string"&&typeof e.fragment=="string"&&typeof e.path=="string"&&typeof e.query=="string"&&typeof e.scheme=="string"&&typeof e.fsPath=="function"&&typeof e.with=="function"&&typeof e.toString=="function"}constructor(e,r,i,o,n,s=!1){typeof e=="object"?(this.scheme=e.scheme||Ve,this.authority=e.authority||Ve,this.path=e.path||Ve,this.query=e.query||Ve,this.fragment=e.fragment||Ve):(this.scheme=OO(e,s),this.authority=M(r,Ve),this.path=kO(this.scheme,M(i,Ve)),this.query=M(o,Ve),this.fragment=M(n,Ve),IO(this,s))}get fsPath(){return Hd(this,!1)}with(e){if(e==null)return this;let{scheme:r,authority:i,path:o,query:n,fragment:s}=e;return r===void 0?r=this.scheme:r===null&&(r=Ve),i===void 0?i=this.authority:i===null&&(i=Ve),o===void 0?o=this.path:o===null&&(o=Ve),n===void 0?n=this.query:n===null&&(n=Ve),s===void 0?s=this.fragment:s===null&&(s=Ve),r===this.scheme&&i===this.authority&&o===this.path&&n===this.query&&s===this.fragment?this:new wa(r,i,o,n,s)}static parse(e,r=!1){let i=RO.exec(e);if(!i)return new wa(Ve,Ve,Ve,Ve,Ve);let o=i[2]||Ve,n=gc(i[4]||Ve),s=(i[5]||Ve).split("/").map(gc).join("/"),a=o==="psfile"&&s.startsWith("//")?s.slice(1):s,m=gc(i[7]||Ve),c=gc(i[9]||Ve);return new wa(o,n,a,m,c,r)}static file(e){let r=Ve;if(I&&(e=e.replace(/\\/g,Jt)),e[0]===Jt&&e[1]===Jt){let i=e.indexOf(Jt,2);i===-1?(r=e.substring(2),e=Jt):(r=e.substring(2,i),e=e.substring(i)||Jt)}return new wa("file",r,e,Ve,Ve)}static from(e){return new wa(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...r){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let i;return I&&e.scheme==="file"?i=Le.file(hc.win32.join(Hd(e,!0),...r)).path:i=hc.posix.join(e.path,...r),e.with({path:i})}isRootPath(){return this.path==null||this.path===Jt}get pathBase(){return this.isRootPath()?"":f(this.path,e=>fb(e.split(Jt),v))}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(Jt))})}join(...e){return this.with({path:Ht(this.path,Jt)+e.join(Jt)})}toString(e=!1){return Gd(this,e)}toJSON(){return this}[_M.inspect.custom](){return this.toString()}},_O=Tx?1:void 0,wa=class extends Le{constructor(){super(...arguments);this._formatted=null;this._fsPath=null}get fsPath(){return this._fsPath==null&&(this._fsPath=Hd(this,!1)),this._fsPath}toString(e=!1){return e?Gd(this,!0):(this._formatted==null&&(this._formatted=Gd(this,!1)),this._formatted)}toJSON(){let e={$mid:1};return this._fsPath!=null&&(e.fsPath=this._fsPath,e._sep=_O),this._formatted!=null&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),this.query&&(e.query=this.query),this.fragment&&(e.fragment=this.fragment),e}},NM={[X.Colon]:"%3A",[X.Slash]:"%2F",[X.QuestionMark]:"%3F",[X.Hash]:"%23",[X.OpenSquareBracket]:"%5B",[X.CloseSquareBracket]:"%5D",[X.AtSign]:"%40",[X.ExclamationMark]:"%21",[X.DollarSign]:"%24",[X.Ampersand]:"%26",[X.SingleQuote]:"%27",[X.OpenParen]:"%28",[X.CloseParen]:"%29",[X.Asterisk]:"%2A",[X.Plus]:"%2B",[X.Comma]:"%2C",[X.Semicolon]:"%3B",[X.Equals]:"%3D",[X.Space]:"%20"};function BM(t,e){let r,i=-1;for(let o=0;o<t.length;o++){let n=t.charCodeAt(o);if(n>=X.a&&n<=X.z||n>=X.A&&n<=X.Z||n>=X.Digit0&&n<=X.Digit9||n===X.Dash||n===X.Period||n===X.Underline||n===X.Tilde||e&&n===X.Slash)i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r!==void 0&&(r+=t.charAt(o));else{r===void 0&&(r=t.substr(0,o));let s=NM[n];s!==void 0?(i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r+=s):i===-1&&(i=o)}}return i!==-1&&(r+=encodeURIComponent(t.substring(i))),r!==void 0?r:t}function NO(t){let e;for(let r=0;r<t.length;r++){let i=t.charCodeAt(r);i===X.Hash||i===X.QuestionMark?(e===void 0&&(e=t.substr(0,r)),e+=NM[i]):e!==void 0&&(e+=t[r])}return e!==void 0?e:t}function Hd(t,e){let r;return t.authority&&t.path.length>1&&t.scheme==="file"?r=`//${t.authority}${t.path}`:t.path.charCodeAt(0)===X.Slash&&(t.path.charCodeAt(1)>=X.A&&t.path.charCodeAt(1)<=X.Z||t.path.charCodeAt(1)>=X.a&&t.path.charCodeAt(1)<=X.z)&&t.path.charCodeAt(2)===X.Colon?e?r=t.path.substr(1):r=t.path[1].toLowerCase()+t.path.substr(2):r=t.path,I&&(r=r.replace(/\//g,"\\")),r}function Gd(t,e){let r=e?NO:BM,i="",{scheme:o,query:n,fragment:s}=t,{authority:a,path:m}=t;if(o&&(i+=o,i+=":"),(a||o==="file")&&(i+=Jt,i+=Jt),a){let c=a.indexOf("@");if(c!==-1){let p=a.substr(0,c);a=a.substr(c+1),c=p.indexOf(":"),c===-1?i+=r(p,!1):(i+=r(p.substr(0,c),!1),i+=":",i+=r(p.substr(c+1),!1)),i+="@"}c=a.indexOf(":"),c===-1?i+=r(a,!1):(i+=r(a.substr(0,c),!1),i+=a.substr(c))}if(m){if(m.length>=3&&m.charCodeAt(0)===X.Slash&&m.charCodeAt(2)===X.Colon){let c=m.charCodeAt(1);c>=X.A&&c<=X.Z&&(m=`/${String.fromCharCode(c+32)}:${m.substr(3)}`)}else if(m.length>=2&&m.charCodeAt(1)===X.Colon){let c=m.charCodeAt(0);c>=X.A&&c<=X.Z&&(m=`${String.fromCharCode(c+32)}:${m.substr(2)}`)}i+=r(m,!0)}return n&&(i+="?",i+=r(n,!1)),s&&(i+="#",i+=e?s:BM(s,!1)),i}function CM(t){try{return decodeURIComponent(t)}catch{return t.length>3?t.substr(0,3)+CM(t.substr(3)):t}}var VM=/(%[0-9A-Za-z][0-9A-Za-z])+/g;function gc(t){return t.startsWith("xn--")?(0,RM.toUnicode)(t):t.match(VM)?t.replace(VM,e=>CM(e)):t}function Jl(t){return Le.isUri(t)?t:Le.parse(t)}var ls=dc(t=>U(t,gi),{maxSize:128,ttlMs:D});W(()=>{j(()=>Kd.unset()),Ot.onChange(()=>Kd.unset())});var Kd=l(async()=>x(Ot(),t=>zu(t.map(e=>[ls(e.uuid),e.mountpoint]))));function zM(t,e){if(T(t)||e==null||T(e.uuid))return;let r=Hr(t),i=Hr(e.mountpoint);if(!r.normalize().startsWith(i.normalize()))return;let o=Pi(r.slice(i.length),"/");return Le.from({scheme:Mo,authority:ls(e.uuid),path:o})}function Jd(t,e){return(0,yc.join)(t,...e.split("/").slice(1))}async function UM(t,e){if(t.scheme!==Mo)throw new Error("invalid URI: "+t+" (bad scheme)");if(T(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=e!=null&&e.includes(yc.sep);if(r){let o=await xa(e);if(o?.uuid!=null&&ls(o.uuid)===t.authority)return Jd(e,t.path)}let i=await x(Kd(),o=>o.get(t.authority));if(v(i))return Jd(i,t.path);if(r)return Jd(e,t.path)}var qM=S(require("path"));var zre=Le.from({scheme:zi,path:""});function WM(t){let e=u.libraryPath.value;if(T(e)||T(t)||!t.startsWith(e))return;let r="/"+Pu({nativePath:e},{nativePath:t});return Le.from({scheme:zi,path:r})}function jM(t){if(t.scheme!==zi)throw new Error("invalid URI: "+t+" (bad scheme)");let e=u.libraryPath.value;if(T(e))throw new Error("invalid URI: "+t+" (no library set)");return(0,qM.join)(e,...t.path.split("/"))}var ms=S(require("path"));function HM(t,e){if(!T(t)){if(e!=null&&e.remote===!0&&v(e.remoteHost)&&v(e.remoteShare))return Le.from({scheme:Qr,authority:e.remoteHost,path:ms.posix.join("/"+e.remoteShare,Qe(Hr(t),Hr(e.mountpoint)))});if(t.startsWith("\\\\"))return Le.file(t).with({scheme:Qr})}}async function GM(t,e){if(t.scheme!==Qr)throw new Error("invalid URI: "+t+" (bad scheme)");if(T(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=t.path.split("/").slice(1),i=r[0];if(T(i))throw new Error("invalid URI: "+t+" (missing share)");if(I)return`\\\\${t.authority}\\${r.join(ms.sep)}`;let o=r.slice(1),n=await Ot();for(let s of F(n))if(!!s.remote&&Oe(s.remoteShare,i)&&await iM(t.authority,s.remoteHost))return(0,ms.join)(s.mountpoint,...o);if(await Qo(e))return(0,ms.join)(e,...o)}var BO=["http:","https:","file:",Mo,Qr].map(t=>t+"//");function KM(t){let e=g(t).toLowerCase();return BO.some(r=>e.startsWith(r))}var CO=l(()=>h("UriNormalization"));function JM(t){try{return Le.parse(t).toString()}catch(e){return CO().warn("Failed to normalize invalid URI",{uri:t,err:e}),t}}function VO(t,e){try{if(t==null||e==null)return!1;let r=Le.parse(t),i=Le.parse(e);return r.scheme===i.scheme&&r.authority===i.authority&&r.path.normalize()===i.path.normalize()}catch{return!1}}async function $M(t,e){try{if(t==null||e==null)return!1;if(to(t,e))return!0;let r=t.toString(),i=e.toString();return VO(r,i)?!0:await Ys(us(r),us(i),(o,n)=>o.normalize()===n.normalize(),()=>!1)}catch{return!1}}var QM=l(()=>h("FileURI"));async function $l(t,e){if(t==null||T(t))return QM().throw("empty nativePath passed to nativePath2uri()",{retriable:!1});let r=l(()=>Re(e,()=>xa(t)));return Ct(()=>WM(t),async()=>zM(t,await r()),async()=>HM(t,await r()),()=>Le.file(t))}function zO(t){try{return Le.isUri(t)?t:Le.parse(t,!0)}catch(e){QM().warn("bad URI",{uri:t,err:e});return}}async function us(t,e){if(T(t))return;let r=zO(t);if(r!=null)switch(r.scheme){case"file":return r.fsPath;case Mo:return UM(r,e);case Qr:return GM(r,e);case zi:return jM(r);default:throw new Error("unsupported URI: "+t)}}async function UO(t){let e=await de.instance().executeJsonToA(["Get-Item -Force -LiteralPath",Zn(t.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return V(e).flatMap(r=>r[0]).flatMap(r=>r.Mode).filter(v).flatMap(r=>r.includes("h")||r.includes("s")).getOrElse(()=>!1)}async function qO(t){try{let e=await oe("stat",["-f","%f",t.nativePath],{timeout:10*E}),r=H(e);return r!=null?(r&32768)>0:!1}catch(e){return!1}}function bc(t){return t.base.startsWith(".")?!0:I?UO(t):ae?qO(t):!1}function XM(t,e,r){let i={};try{for(let o of t)for(let n of nt(o)){let s=o[n]();if(i[n]=M(s,!1),s===!0)return s}return!1}finally{YM(r,e,i)}}function YM(t,e,r){let i=r==null?"warn":"debug";t.log(i,e,r)}async function ZM(t,e,r){let i={};try{for(let o of t)for(let n of nt(o)){let s=await o[n]();if(i[n]=s,s)return s}return!1}finally{YM(r,e,i)}}var $d=class{constructor(){this.store=new Map}add(e,r){Ur(this.store,e,()=>new Set).add(r)}delete(e,r){f(this.store.get(e),i=>{i.delete(r),i.size===0&&this.store.delete(e)})}find(e){return Go(e.findIndex((r,i)=>this.store.get(r)?.has(e[i+1])),r=>e.slice(r,r+2))}has(e){return this.find(e)!=null}};var WO=l(()=>h("NeverIgnoredPaths")),jO=l(()=>{u.neverIgnored.addListener(()=>{Ql.clear(),Fr(),WO().info("Settings.neverIgnored changed",u.neverIgnored.value)}),u.scanPaths.addListener(()=>{Ql.clear(),Fr()}),j(()=>Ql.clear())}),Ql=l(()=>(jO(),new Set(R([...u.scanPaths.values,...u.neverIgnored.values]))));function Ta(t){return Ql().has(t)||Ql().has(t.toLowerCase())}function ev(t){return Ta(t)?{pathIsNeverIgnored:()=>!1}:void 0}var tv=S(require("path"));var HO=/^\.?NoMedia$/i,rv="NoMedia";function iv(t){return[t,t.toLowerCase(),t.toUpperCase()]}var GO=Object.freeze([...iv("."+rv),...iv(rv)]);function ov(t){return HO.exec(t)!=null}var xc=new _i({maxSize:1024,timeoutMs:ar,clearEveryMs:D});W(()=>j(()=>xc.clear()));W(()=>Kt(t=>{t==null?xc.clear():xc.deleteIf(e=>e.startsWith(t))}));var wc=l(()=>h("hasNoMedia()"));async function cn(t){return t==null?!1:Ta(t.nativePath)?wc().tap({msg:t+" is never ignored",result:!1}):t instanceof Me?cn(await t.directoryEntry()):ov(t.base)?wc().tap({msg:t+" basename is NoMedia",result:!0}):$o(t.nativePath).some(ov)?wc().tap({msg:t+" parent path is NoMedia",result:!0}):await t.isDirectory()&&await xc.getOrSetAsync(t.nativePath,async()=>{for(let r of GO)if(await Rx((0,tv.join)(t.nativePath,r)))return wc().tap({msg:t+" is a directory and has a noMedia child, "+r,result:!0});return!1})===!0?!0:t.isRoot?!1:x(t.parent(),cn)}function nv(t){let e=u.maxDuplicatePathElements.valueOrDefault;for(let r of new Set(t))if(Sr(t,i=>i===r)>e)return!0;return!1}var De=class{constructor(e){this.apply=e}static lift(e){return new De(e)}static and(...e){return new De(async r=>{for(let i of e)if(!await i.apply(r))return!1;return!0})}static or(...e){return new De(async r=>{for(let i of e)if(await i.apply(r))return!0;return!1})}static logged(e,...r){return bb(r,i=>ze(i).map(([o,n])=>n.asAsync().logged(e,o)))}static andLogged(e,...r){return this.and(...this.logged(e,...r))}static orLogged(e,...r){return this.or(...this.logged(e,...r))}static async andExplain(e,r){let i=[],o=[];for(let n of r)for(let[s,a]of ze(n))(await a.apply(e)?i:o).push(s);return{accepted:i,rejected:o}}asAsync(){return this}and(...e){return De.and(this,...e)}not(){return new De(e=>gt(this.apply(e)))}or(e){return new De(async r=>await this.apply(r)||await e.apply(r))}async filter(e){return Sl(e,r=>this.apply(r))}logged(e,r){return new De(async o=>{let n=await this.apply(o);return e.log(n?"debug":"info",[Cs(r),n?Xm("ACCEPT"):Ym("REJECT"),dr(o)].join(" ")),n})}};var KO=h("Snap"),av=De.lift(async t=>{if(!await sv())return!1;let r=$o(t.nativePath).indexOf("snap");return r<0?!1:F(await JO()).includes($o[r+1])}),sv=l(async()=>{if(!tt||Ce())return!1;try{return await oe("snap",["--version"],{timeout:10*E,quiet:!0,maxRetries:0}),!0}catch{return!1}}),JO=l(async()=>{if(!await sv())return[];try{return await bo(["Name","Version"],await oe("snap",["list"],{timeout:10*E})).map(t=>t.Name)}catch(t){return KO.warn("snap failed",t),[]}},30*E);var lv=class{constructor(e=Te){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize()));this.ignorableDirectories=new Set(["#snapshot","__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Support","Applications","arangodb","cache","caches","CacheClip","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iMovie Cache","iTunes Cache","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","SteamApps","System Volume Information","System32","temp","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase()));this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/resources\/media\/face/i,/\/facetile[-_]/i,/\/.*?\.photos?library\/(?!(masters?|originals)\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i];this.systemDirs=z(R([na(),He("APPDATA"),He("SYSTEMROOT"),He("ProgramFiles"),He("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize()));this.ignorableSubdirs=new $d;tt&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);let r=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",r),this.addIgnorableSubdirs("cygwin",r),this.addIgnorableSubdirs("cygwin64",r),this.addIgnorableSubdirs("local",r),this.addIgnorableSubdirs("Windows",["Boot","Containers","Cursors","Fonts","Help","Installer","Logs","Microsoft.NET","SoftwareDistribution","System","System32","SysWOW64","Temp"]),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...r]),this.addIgnorableSubdirs("lfs",["objects"]),this.addIgnorableSubdirs("var",["cache","crash","games","lib","local","lock","log","mail","run","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);let i=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",i),this.addIgnorableSubdirs("Perl64",i),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(He("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("temp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),I&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,r){if(T(e))return;let i=e.toLowerCase().normalize();R(r).forEach(o=>this.ignorableSubdirs.add(i,o.toLowerCase().normalize()))}ignorablePathPredicates(e){let r=ev(e);if(r!=null)return r;let i=e.toLowerCase().normalize(),o=R($o(i));return{hiddenPosix:()=>o.some(n=>n.startsWith(".")),systemDir:()=>this.systemDirs.some(n=>i.startsWith(n)),ignorableRoot:()=>this.ignorableRootDirectories.has(o[0]),ignorableDirectory:()=>o.some(n=>this.ignorableDirectories.has(n)),ignorablePath:()=>this.ignorableSubdirs.has(o),ignorablePattern:()=>{let n=Hr(e);return this.ignorableDirectoryPatterns.some(s=>s.test(n))}}}ignorablePath(e){return XM([this.ignorablePathPredicates(e)],e,h("ignorablePath()"))}},mv=l(()=>new lv);function uv(t){return w(w({},mv().ignorablePathPredicates(t)),{notExists:()=>ee.for(t).notExists()})}function Yl(t){return mv().ignorablePath(t)}function cv(t){return Yl(t.nativePath)}function fv(t){let e=t.nativePath.toLowerCase().normalize();return Ta(t.nativePath)||Ta(e)?{pathIsNeverIgnored:()=>!1}:w(w({},uv(t.nativePath)),{snapDirectory:async()=>tt&&await av.apply(t),noMedia:async()=>await cn(t)===!0,hidden:()=>bc(t),seemsRecursive:()=>nv(t.pathnames),mountpoint:async()=>pe(ut(),r=>r.includes(t.nativePath),()=>!1)})}async function pv(t){return await t.isDirectory()?fv(t):uv(t.nativePath)}async function dv(t){return ZM([fv(t)],t.nativePath,h("ignorableDirectory()"))}var gv=new Fl;var ee=class extends Me{constructor(e,r){super(e,r);this.nativePath=e;this.pflog=l(()=>h("PosixFile("+this.nativePath+")"));this.uriObject=l(()=>$l(this.nativePath));this.uri=l(()=>x(this.uriObject(),g));this.fileuri=l(()=>Le.file(this.nativePath).toString());this.mountpoint=l(()=>I&&this.nativePath.startsWith("\\\\")?this.for(this.nativePath.split("\\").slice(0,4).join("\\")):x(ut(),e=>this.bestMountpoint(e.map(r=>this.for(r)))));this.etag=l(()=>x(this.stat(),e=>[e.size,e.mtime.getTime()].map(r=>en.encode(r)).join("-")));this.isMountpoint=l(async()=>await this.isDirectory()&&await pe(ut(),e=>e.includes(this.nativePath),()=>!1));this.sidecars=l(async()=>{if(this.isSidecar())return[];let e=await this.parent().childDirectoryEntries(i=>i.base!==this.base&&jl(i.ext)&&(i.name===this.name||i.name===this.base||(u.matchSidecarsCaseInsensitively.valueOrDefault?Oe(i.name,this.name)||Oe(i.name,this.base):!1)||Ri(i.name)===Ri(this.name)||(u.matchSidecarsCaseInsensitively.valueOrDefault?Oe(Ri(i.name),Ri(this.name)):!1)));if(e==null)return[];let r=e.map(i=>this.parent()._directoryEntryChild(i));return bl(r,i=>i.maxStatMs())});this.shaWithSidecars=l(async()=>{let e=[this,...await this.sidecars()].map(i=>i.nativePath);return(await _u(tr(e))).toString("base64")},Me.attrTTL)}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(T(e))throw new Error("unexpectedly empty path");if(e instanceof ee)return e;if(e instanceof Me)return this.for(e.nativePath,r);if(KM(e))throw new Error("use forUri");let i=gv.get(e);if(i!=null)return i;let o=Gr(e);return gv.getOrSet(o,()=>new ee(o,r))}static forPosix(e){return this.for(e.replace(/\//g,hv.sep))}static forUri(e,r){return x(us(e,r),i=>this.for(i))}for(e,r){return ee.for(e,r)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.sidecars.unset(),this}bestMountpoint(e){return et(e.filter(r=>ia(this.nativePath,r.toString())).map(r=>ee.for(r)),r=>V(nl(this.pathnames,r.pathnames)).filter(i=>i>=r.pathnames.length).get())}async isDeleted(e){if(e=await Zt(e,()=>this.uri()),this.isUNC)return this.pflog().tap({result:void 0,msg:"isDeleted(): UNC not supported"});if(await this.exists())return this.pflog().tap({result:!1,msg:"isDeleted(): file exists"});if(e==null)return this.pflog().tap({result:void 0,level:"warn",msg:"isDeleted(): missing URI"});if(e=Jl(e),e.isRootPath())return this.pflog().tap({result:void 0,msg:"isDeleted(): uri isRootPath",meta:{uri:e}});if(g(e.pathBase).normalize()!==this.base.normalize())return this.pflog().tap({level:"warn",result:void 0,msg:"isDeleted(): uri isn't correct",meta:{uri:e,expectedBase:this.base,uriBase:e.pathBase}});let r=await this.parent().isDeleted(e.parent());return r==null?this.pflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{uri:e}}):this.pflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted, which means I am deleted.",meta:{parentDeleted:r,uri:e}})}async httpHeaders(){return{ETag:await this.etag(),"Last-Modified":await this.lastModifiedUtc()}}async hide(){let e=await(I?oe("attrib",["+h",this.nativePath],{timeout:10*E}).catch(r=>r):ae?oe("chflags",["hidden",this.nativePath],{timeout:10*E}).catch(r=>r):"");if(v(e)){this.pflog().warn("hide("+this.nativePath+") failed: "+e);return}else return this.clear()}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}async mkNoMedia_(){if(await this.isFile())throw new Error("mkNoMedia(): "+this+" is a file.");await this.mkdirp_();let e=this.join(".NoMedia");await e.isNotDirectory()&&await e.isEmpty()&&(await e.writeTxt_(["This directory's contents are excluded from PhotoStructure libraries.","","See <https://photostructure.com/nomedia/> for details."].join(`
`)),Fr(this.nativePath))}async mkNoMedia(){try{return await this.mkNoMedia_(),this}catch(e){this.pflog().warn("Could not add .NoMedia file to "+this,e);return}}hasNoMedia(){return cn(this)}ignorableCheap(){return Yl(this.nativePath)}async ignorable(){return await this.isDirectory()?dv(this):cv(this)}hidden(){return bc(this)}isSidecar(){return jl(this.ext)}async sidecar(){return bt(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+Pi(u.defaultSidecarType.valueOrDefault,".").toLowerCase()))}async jsonSidecars(){let e=await this.siblings(r=>Oe(r.ext,".json")&&(r.name===this.name||r.name===this.base||Ri(r.name)===Ri(this.name)));return this.pflog().tap({msg:"jsonSidecars()",result:e==null?void 0:await bl(e,r=>r.maxStatMs())})}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",async()=>{let e=await this.mtimeMs(),r=await this.sidecars(),i=await Promise.all(F(r).map(n=>n.mtimeMs())),o=[e,...i].filter(N);return Ae(o,n=>Math.floor(Math.max(...n)))})}thisOrSidecareMaxMtimeSec(){return x(this.thisOrSidecareMaxMtimeMs(),e=>Di(e))}};function Qd(t){return re(t)&&[0,90,180,270].includes(t)}function Ma(t){let e=f(t,r=>Ze(r+Math.ceil(-r/360)*360));return Qd(e)?e:void 0}function yv(t){let e=Ma(t);return e===90||e===270}function xv(t,e){return Ma(e)===0?t:new bv([...t]).rotate(e).m}var bv=class{constructor(e,r=1){this.m=e;this.ary=r;if(this.rows=Math.sqrt(e.length/r),this.rows!==Math.floor(this.rows))throw new Error(`Only square tuple matrices are supported: ${this.ary===1?"":this.ary}(${this.rows}\xD7${this.rows}) != ${e.length}`)}index(e,r){return this.ary*(r+e*this.rows)}swap(e,r){for(let i=0;i<this.ary;i++){let o=this.m[e+i];this.m[e+i]=this.m[r+i],this.m[r+i]=o}}transpose(){for(let e=0;e<this.rows;e++)for(let r=e+1;r<this.rows;r++)this.swap(this.index(e,r),this.index(r,e));return this}reverseRows(){for(let e=0;e<this.rows;e++)for(let r=0;r<this.rows/2;r++)this.swap(this.index(r,e),this.index(this.rows-1-r,e));return this}reverseCols(){for(let e=0;e<this.rows;e++)for(let r=0;r<this.rows/2;r++)this.swap(this.index(e,r),this.index(e,this.rows-1-r));return this}reverse(){let e=this.rows**2;for(let r=0;r<e/2;r++)this.swap(r,e-1-r);return this}rotate(e){switch(Ma(e)){case 0:break;case 90:this.transpose(),this.reverseCols();break;case 180:this.reverse();break;case 270:this.transpose(),this.reverseRows();break;default:throw new Error("unsupported rotate("+e+")")}return this}};function wv(t,e){let r=Math.pow(2,e),i=[];for(;t>0;)i.unshift(t%r),t=Math.floor(t/r);return i}function Xl(t){t.dims.forEach(r=>r.value=Z(r.min,r.max,r.value));let e=0;for(let r=0;r<t.bitDepth;r++){e*=2;let i=r%t.dims.length,o=t.dims[i],n=St([o.min,o.max]);o.value>n?(e+=1,o.min=n):o.max=n}return e}function Tc(t,e){if(e.bitDepth>52||e.bitDepth<0)return;let r=$O(t);for(let i=0;i<e.bitDepth;i++){let o=i%e.dims.length,n=e.dims[o],s=St([n.min,n.max]);r.includes(e.bitDepth-i-1)?n.min=s:n.max=s}return e.dims.map(i=>St([i.min,i.max]))}function $O(t){return t.toString(2).split("").reverse().map((e,r)=>e==="1"?r:-1).filter(e=>e!==-1)}function Tv(t,e){return t.map((r,i)=>r*e[i])}function Mv(t,e){return t.map((r,i)=>{if(r.length!==e.length)throw new Error("misshaped matrix on row "+i);return Ko(r.map((o,n)=>o*e[n]))})}var QO=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]];function YO(t){return f(g(t).match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),e=>[e[1],e[2],e[3]].map(r=>parseInt(r,16)))}function vv(t){return f(YO(t),Zl)}function Zl(t){return ZO(XO(t))}function ek(t){return[t[0],t[1],t[2]].map(e=>Z(0,255,e))}function XO(t){let e=ek(t).map(r=>r/255).map(r=>r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92);return Mv(QO,e)}var Yd={X:.95047,Y:1,Z:1.08883},tk=216/24389,rk=24389/27;function ZO(t){let[e,r,i]=Tv(t,[1/Yd.X,1/Yd.Y,1/Yd.Z]).map(o=>o>tk?Math.pow(o,1/3):(rk*o+16)/116);return[116*r-16,500*(e-r),200*(r-i)]}function vo(t,e){return Xl({dims:[{value:t[0],min:0,max:100},{value:t[1],min:-80,max:80},{value:t[2],min:-80,max:80}],bitDepth:e})}function va(t,e){return Tc(t,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:e})}function em(t,e){return ik({L:t[0],a:t[1],b:t[2]},{L:e[0],a:e[1],b:e[2]})}function ik(t,e){let r=1,i=.045,o=.015,n=t.L-e.L,s=t.a-e.a,a=t.b-e.b,m=Math.sqrt(t.a*t.a+t.b*t.b),c=Math.sqrt(e.a*e.a+e.b*e.b),p=m-c,d=s*s+a*a-p*p;return d=d<0?0:Math.sqrt(d),Math.sqrt((n/r)**2+(p/(1+i*m))**2+(d/(1+o*m))**2)}function Sv(t,e){return co(t,r=>em(r,e))}var Xd=l(()=>[{name:"Acid green",rgb:"#B0BF1A"},{name:"Amaranth",rgb:"#E52B50"},{name:"Amethyst",rgb:"#9966CC"},{name:"Antique brass",rgb:"#CD9575"},{name:"Antique bronze",rgb:"#665D1E"},{name:"Antique fuchsia",rgb:"#915C83"},{name:"Apple green",rgb:"#8DB600"},{name:"Apricot",rgb:"#FBCEB1"},{name:"Aqua",rgb:"#00FFFF"},{name:"Aquamarine",rgb:"#7FFFD4"},{name:"Artichoke",rgb:"#8F9779"},{name:"Ash grey",rgb:"#B2BEB5"},{name:"Asparagus",rgb:"#87A96B"},{name:"Avocado",rgb:"#568203"},{name:"Azure",rgb:"#4988F5"},{name:"Beaver",rgb:"#9F8170"},{name:"Beige",rgb:"#F6F1DE"},{name:"Bistre",rgb:"#3D2B1F"},{name:"Black coffee",rgb:"#3B2F2F"},{name:"Black olive",rgb:"#3B3C36"},{name:"Black pearl",rgb:"#041322"},{name:"Black",rgb:"#000000"},{name:"Blond",rgb:"#FAF0BE"},{name:"Blood red",rgb:"#660000"},{name:"Blue bell",rgb:"#A2A2D0"},{name:"Blue sapphire",rgb:"#126180"},{name:"Blue-green",rgb:"#0D98BA"},{name:"Blue-violet",rgb:"#7366BD"},{name:"Blue",rgb:"#1F75FE"},{name:"Brandy",rgb:"#87413F"},{name:"Brick red",rgb:"#CB4154"},{name:"Bright green",rgb:"#66FF00"},{name:"Bright lilac",rgb:"#D891EF"},{name:"Brink pink",rgb:"#FB607F"},{name:"Bronze",rgb:"#CD7F32"},{name:"Brown",rgb:"#88540B"},{name:"Bud green",rgb:"#7BB661"},{name:"Burgundy",rgb:"#800020"},{name:"Burnished brown",rgb:"#A17A74"},{name:"Burnt orange",rgb:"#CC5500"},{name:"Burnt sienna",rgb:"#E97451"},{name:"Burnt umber",rgb:"#8A3324"},{name:"Byzantium",rgb:"#702963"},{name:"Cadet blue",rgb:"#5F9EA0"},{name:"Cadet",rgb:"#536872"},{name:"Cadmium green",rgb:"#006B3C"},{name:"Cadmium red",rgb:"#E30022"},{name:"Candy pink",rgb:"#E4717A"},{name:"Cardinal",rgb:"#C41E3A"},{name:"Caribbean green",rgb:"#00CC99"},{name:"Carmine",rgb:"#960018"},{name:"Carnelian",rgb:"#B31B1B"},{name:"Cerise",rgb:"#DE3163"},{name:"Cerulean blue",rgb:"#2A52BE"},{name:"Cerulean",rgb:"#007BA7"},{name:"Champagne",rgb:"#F3E5AB"},{name:"Charcoal",rgb:"#36454F"},{name:"Chartreuse",rgb:"#DFFF00"},{name:"Chestnut",rgb:"#954535"},{name:"Chocolate",rgb:"#7B3F00"},{name:"Citrine",rgb:"#E4D00A"},{name:"Citron",rgb:"#9FA91F"},{name:"Claret",rgb:"#7F1734"},{name:"Cobalt blue",rgb:"#0047AB"},{name:"Cocoa brown",rgb:"#D2691E"},{name:"Coffee",rgb:"#6F4E37"},{name:"Cool grey",rgb:"#8C92AC"},{name:"Copper red",rgb:"#CB6D51"},{name:"Copper rose",rgb:"#996666"},{name:"Copper",rgb:"#B87333"},{name:"Coral",rgb:"#F88379"},{name:"Cornflower blue",rgb:"#6495ED"},{name:"Cosmic cobalt",rgb:"#2E2D88"},{name:"Cotton candy",rgb:"#FFBCD9"},{name:"Crimson",rgb:"#DC143C"},{name:"Cyan",rgb:"#00B7EB"},{name:"Cyclamen",rgb:"#F56FA1"},{name:"Cyprus",rgb:"#003E40"},{name:"Dark brown",rgb:"#654321"},{name:"Dark byzantium",rgb:"#5D3954"},{name:"Dark cornflower blue",rgb:"#26428B"},{name:"Dark cyan",rgb:"#008B8B"},{name:"Dark goldenrod",rgb:"#B8860B"},{name:"Dark green",rgb:"#006400"},{name:"Dark liver",rgb:"#534B4F"},{name:"Dark magenta",rgb:"#8B008B"},{name:"Dark moss green",rgb:"#4A5D23"},{name:"Dark olive green",rgb:"#556B2F"},{name:"Dark orange",rgb:"#FF8C00"},{name:"Dark orchid",rgb:"#9932CC"},{name:"Dark pastel green",rgb:"#03C03C"},{name:"Dark powder blue",rgb:"#003399"},{name:"Dark purple",rgb:"#301934"},{name:"Dark red",rgb:"#8B0000"},{name:"Dark salmon",rgb:"#E9967A"},{name:"Dark sea green",rgb:"#8FBC8F"},{name:"Dark sienna",rgb:"#3C1414"},{name:"Dark slate blue",rgb:"#483D8B"},{name:"Dark slate grey",rgb:"#2F4F4F"},{name:"Dark spring green",rgb:"#177245"},{name:"Dark turquoise",rgb:"#00CED1"},{name:"Dark violet",rgb:"#9400D3"},{name:"Deep blue",rgb:"#0066FF"},{name:"Deep chestnut",rgb:"#B94E48"},{name:"Deep saffron",rgb:"#FF9933"},{name:"Deep sky blue",rgb:"#00BFFF"},{name:"Deep space",rgb:"#000040"},{name:"Deep taupe",rgb:"#7E5E60"},{name:"Denim",rgb:"#1560BD"},{name:"Desert",rgb:"#C19A6B"},{name:"Dim grey",rgb:"#696969"},{name:"Drab",rgb:"#967117"},{name:"Earth yellow",rgb:"#E1A95F"},{name:"Ebony",rgb:"#555D50"},{name:"Ecru",rgb:"#C2B281"},{name:"Eggplant",rgb:"#614051"},{name:"Eggshell",rgb:"#F0EAD6"},{name:"Elderberry",rgb:"#171828"},{name:"Electric blue",rgb:"#7DF9FF"},{name:"Electric purple",rgb:"#BF00FF"},{name:"Emerald",rgb:"#50C878"},{name:"English green",rgb:"#1B4D3E"},{name:"English lavender",rgb:"#B48395"},{name:"English red",rgb:"#AB4B52"},{name:"Fern green",rgb:"#4F7942"},{name:"Fire opal",rgb:"#E95C4B"},{name:"Firefly",rgb:"#0E2A30"},{name:"Flame",rgb:"#E25822"},{name:"Flax",rgb:"#EEDC82"},{name:"Forest green",rgb:"#014421"},{name:"French beige",rgb:"#A67B5B"},{name:"French blue",rgb:"#0072BB"},{name:"French lilac",rgb:"#86608E"},{name:"French sky blue",rgb:"#77B5FE"},{name:"Fuchsia purple",rgb:"#CC397B"},{name:"Fuchsia",rgb:"#FF00FF"},{name:"Gold",rgb:"#E6BE8A"},{name:"Golden brown",rgb:"#996515"},{name:"Golden yellow",rgb:"#FFDF00"},{name:"Goldenrod",rgb:"#DAA520"},{name:"Glacier blue",rgb:"#C8DDE8"},{name:"grey",rgb:"#808080"},{name:"Green-blue",rgb:"#2887C8"},{name:"Green-yellow",rgb:"#ADFF2F"},{name:"Green",rgb:"#00A000"},{name:"Harvest gold",rgb:"#DA9100"},{name:"Heliotrope grey",rgb:"#AA98A9"},{name:"Heliotrope",rgb:"#DF73FF"},{name:"Hot magenta",rgb:"#FF1DCE"},{name:"Hot pink",rgb:"#FF69B4"},{name:"Imperial red",rgb:"#ED2939"},{name:"Indigo dye",rgb:"#00416A"},{name:"Indigo",rgb:"#4B0082"},{name:"Iris",rgb:"#5A4FCF"},{name:"Jade",rgb:"#00A86B"},{name:"Jasper",rgb:"#113126"},{name:"Jet",rgb:"#343434"},{name:"Jungle green",rgb:"#29AB87"},{name:"Kelly green",rgb:"#4CBB17"},{name:"Key lime",rgb:"#E8F48C"},{name:"Khaki",rgb:"#C3B091"},{name:"Lapis lazuli",rgb:"#26619C"},{name:"Laurel green",rgb:"#A9BA9D"},{name:"Lavender grey",rgb:"#C4C3D0"},{name:"Lavender",rgb:"#B57EDC"},{name:"Licorice",rgb:"#1A1110"},{name:"Light blue",rgb:"#ADD8E6"},{name:"Light coral",rgb:"#F08080"},{name:"Light grey",rgb:"#D3D3D3"},{name:"Light green",rgb:"#90EE90"},{name:"Light periwinkle",rgb:"#C5CBE1"},{name:"Light pink",rgb:"#FFB6C1"},{name:"Light salmon",rgb:"#FFA07A"},{name:"Light sea green",rgb:"#20B2AA"},{name:"Light steel blue",rgb:"#B0C4DE"},{name:"Light yellow",rgb:"#FFFFE0"},{name:"Lilac",rgb:"#C8A2C8"},{name:"Lime",rgb:"#BFFF00"},{name:"Linen",rgb:"#FAF0E6"},{name:"Magenta",rgb:"#FF0090"},{name:"Mahogany",rgb:"#C04000"},{name:"Malachite",rgb:"#0BDA51"},{name:"Mango",rgb:"#FDBE02"},{name:"Marigold",rgb:"#EAA221"},{name:"Maroon",rgb:"#800000"},{name:"Mauve taupe",rgb:"#915F6D"},{name:"Mauve",rgb:"#B783A9"},{name:"Medium aquamarine",rgb:"#66DDAA"},{name:"Medium blue",rgb:"#0000CD"},{name:"Medium orchid",rgb:"#BA55D3"},{name:"Medium purple",rgb:"#9370DB"},{name:"Medium sea green",rgb:"#3CB371"},{name:"Medium slate blue",rgb:"#7B68EE"},{name:"Medium spring green",rgb:"#00FA9A"},{name:"Medium turquoise",rgb:"#48D1CC"},{name:"Middle blue green",rgb:"#8DD9CC"},{name:"Middle blue purple",rgb:"#8B72BE"},{name:"Middle blue",rgb:"#7ED4E6"},{name:"Middle green yellow",rgb:"#ACBF60"},{name:"Middle green",rgb:"#4D8C57"},{name:"Middle purple",rgb:"#D982B5"},{name:"Middle red purple",rgb:"#A55353"},{name:"Middle red",rgb:"#E58E73"},{name:"Midnight blue",rgb:"#003366"},{name:"Midnight green",rgb:"#004953"},{name:"Moss green",rgb:"#8A9A5B"},{name:"Mossy oak",rgb:"#887848"},{name:"Mulberry",rgb:"#C54B8C"},{name:"Mustard",rgb:"#FFDB58"},{name:"Myrtle green",rgb:"#317873"},{name:"Neon blue",rgb:"#4666FF"},{name:"Nickel",rgb:"#727472"},{name:"Ocean green",rgb:"#48BF91"},{name:"Ochre",rgb:"#CC7722"},{name:"Olive green",rgb:"#B5B35C"},{name:"Olive",rgb:"#808000"},{name:"Olivine",rgb:"#9AB973"},{name:"Orange-red",rgb:"#FF5349"},{name:"Orange",rgb:"#FF7F00"},{name:"Orange",rgb:"#FFAA1D"},{name:"Orchid pink",rgb:"#F2BDCD"},{name:"Orchid",rgb:"#DA70D6"},{name:"Pale cerulean",rgb:"#9BC4E2"},{name:"Pale pink",rgb:"#FADADD"},{name:"Pale purple",rgb:"#FAE6FA"},{name:"Pale silver",rgb:"#C9C0BB"},{name:"Pansy purple",rgb:"#78184A"},{name:"Pastel pink",rgb:"#DEA5A4"},{name:"Pastel yellow",rgb:"#FFFF99"},{name:"Peach",rgb:"#FFDAB9"},{name:"Pear",rgb:"#D1E231"},{name:"Periwinkle",rgb:"#CCCCFF"},{name:"Persimmon",rgb:"#EC5800"},{name:"Pesto",rgb:"#7C7631"},{name:"Pewter blue",rgb:"#8BA8B7"},{name:"Phthalo green",rgb:"#123524"},{name:"Pink",rgb:"#D74896"},{name:"Pistachio",rgb:"#93C572"},{name:"Powder Blue",rgb:"#BEEEEF"},{name:"Plum",rgb:"#8E4585"},{name:"Prune",rgb:"#701C1C"},{name:"Prussian Blue",rgb:"#04146D"},{name:"Puce",rgb:"#CC8899"},{name:"Pumpkin",rgb:"#FF7518"},{name:"Purple navy",rgb:"#4E5180"},{name:"Purple",rgb:"#A020F0"},{name:"Raisin black",rgb:"#242124"},{name:"Raw sienna",rgb:"#D68A59"},{name:"Raw umber",rgb:"#826644"},{name:"Rebecca purple",rgb:"#663399"},{name:"Red-purple",rgb:"#E40078"},{name:"Red-violet",rgb:"#C71585"},{name:"Red",rgb:"#ED1C24"},{name:"Rosy brown",rgb:"#BC8F8F"},{name:"Royal blue dark",rgb:"#002366"},{name:"Royal purple",rgb:"#7851A9"},{name:"Rufous",rgb:"#A81C07"},{name:"Saffron",rgb:"#F4C430"},{name:"Salmon pink",rgb:"#FF91A4"},{name:"Salmon",rgb:"#FA916D"},{name:"Sandy brown",rgb:"#F4A460"},{name:"Sap green",rgb:"#507D2A"},{name:"Scarlet",rgb:"#FF2400"},{name:"Sea green",rgb:"#2E8B57"},{name:"Sepia",rgb:"#985E2B"},{name:"Sepia black",rgb:"#2B0202"},{name:"Sienna",rgb:"#882D17"},{name:"Silver",rgb:"#A8A8A8"},{name:"Sky blue",rgb:"#87CEEB"},{name:"Sky magenta",rgb:"#CF71AF"},{name:"Slate blue",rgb:"#6A5ACD"},{name:"Slate grey",rgb:"#708090"},{name:"Steel pink",rgb:"#CC33CC"},{name:"Straw",rgb:"#E4D96F"},{name:"Tan",rgb:"#D2B48C"},{name:"Tangerine",rgb:"#F28500"},{name:"Taupe grey",rgb:"#8B8589"},{name:"Taupe",rgb:"#483C32"},{name:"Tea green",rgb:"#D0F0C0"},{name:"Tea rose",rgb:"#F4C2C2"},{name:"Teal blue",rgb:"#367588"},{name:"Teal",rgb:"#008080"},{name:"Terra cotta",rgb:"#E2725B"},{name:"Thistle",rgb:"#D8BFD8"},{name:"Turquoise blue",rgb:"#00FFEF"},{name:"Turquoise green",rgb:"#A0D6B4"},{name:"Turquoise",rgb:"#40E0D0"},{name:"Turtle green",rgb:"#2A380B"},{name:"Ultra pink",rgb:"#FF6FFF"},{name:"Ultra red",rgb:"#FC6C85"},{name:"Ultramarine",rgb:"#3F00FF"},{name:"Umber",rgb:"#635147"},{name:"Umbra",rgb:"#202000"},{name:"Vermilion",rgb:"#E34234"},{name:"Violet-blue",rgb:"#324AB2"},{name:"Violet-red",rgb:"#F75394"},{name:"Violet",rgb:"#8F00FF"},{name:"Viridian",rgb:"#40826D"},{name:"Vivid burgundy",rgb:"#9F1D35"},{name:"Vivid sky blue",rgb:"#00CCFF"},{name:"Vivid blue",rgb:"#0084FF"},{name:"Vivid indigo",rgb:"#3A00E7"},{name:"Wheat",rgb:"#F5DEB3"},{name:"White",rgb:"#FFFFFF"},{name:"Wisteria",rgb:"#C9A0DC"},{name:"Yellow-green",rgb:"#9ACD32"},{name:"Yellow-orange",rgb:"#FFAE42"},{name:"Yellow",rgb:"#FFEF00"}].map(Pv)),Zd=18;function Pv(t){let e=vv(t.rgb);return w(w({},t),{name:Ho(t.name),lab:e,labhash:vo(e,Zd)})}function eh(t,e=Xd()){return ok(t,e)[0]}var nk=vo([100,100,100],Zd),sk=nk*(1/4);function ok(t,e=Xd()){let r=vo(t,Zd),i=[];for(let o of e)if(Math.abs(r-o.labhash)<sk){let n=em(t,o.lab);n<40&&i.push(w(w({},o),{cieDiff:n}))}return $(i,o=>o.cieDiff).slice(0,5)}var cse=l(()=>[{index:0,name:"yellows",rgb:"#FFDF00"},{index:1,name:"greens",rgb:"#0BDA51"},{index:2,name:"blues",rgb:"#0000ff"},{index:3,name:"reds",rgb:"#ff0000"}].map(Pv));var IE=S(require("exiftool-vendored")),OE=S(require("path"));var Dv=S(require("file-type")),Av=S(require("fs-extra")),Fv=S(require("path"));var fn=S(require("fs-extra"));async function Ev(t,e=0,r){let i=-1;try{let o=await M(r,()=>x((0,fn.stat)(t),s=>s.size-e)),n=Buffer.alloc(o);return i=await(0,fn.open)(t,"r"),await(0,fn.read)(i,n,0,o,e)}finally{await Go(i,fn.close)}}W(()=>{j(()=>Mc.prior()?.clear()),Kt(t=>t==null?Mc.prior()?.clear():Mc.prior()?.delete(t))});var Mc=l(()=>new _e(512,3*D));async function tm(t){return Mc().getOrSet(t,async()=>{let{buffer:e}=await Ev(t,0,248);return bt((0,Dv.fromBuffer)(e)).filter(r=>r.mime!=="image/tiff").orElse(()=>bt(Op((0,Av.stat)(t))).filter(r=>r).flatMap(()=>Sa().readRaw(t,["-mimetype"])).flatMap(r=>r.MIMEType).filter(v).map(r=>({ext:ak(t),mime:r})).get()).get()})}function ak(t){return Qe((0,Fv.extname)(t),".")}var th=S(require("os"));async function rh(t){let e=I?"where":"which";try{let r=await qe(e,[t],{timeout:G,ignoreExitCode:!0,ignoreStderr:!0});return r.code===0&&v(r.result)?r.result.trim().split(`
`)[0]?.trim():void 0}catch{return}}async function ih(t){return t!=null&&await t.exists()?t.nativePath:void 0}async function vc(t,e){let r=f(Lr.Tools(),o=>Me.for(o));if(fi&&(r==null||await r.isNotDirectory()))throw new Error("Cannot find project path for tools"+ye);function i(o){return r?.join(Mx+"-"+o,M(e,t),t+(I?".exe":""))}return Ct(()=>ih(i(th.default.arch())),()=>th.default.arch()==="x64"?ih(i("ia32")):void 0,()=>lk(t))}async function lk(t){return Ct(()=>rh(t),()=>ih(Me.for(Lr.Bin())?.join(t)),()=>{throw new Error("Cannot find path for "+t)})}var Lv=l(()=>vc("dcraw_emu","libraw")),Iv=l(()=>vc("raw-identify","libraw")),oh=l(()=>vc("jpegtran")),Ov=l(()=>vc("sqlite3"));var Sc=new _e(512);j(()=>Sc.clear());Kt(t=>t==null?Sc.clear():Sc.delete(t));var kv=l(()=>h("RawInfo"));async function Pc(t){return Sc.getOrSet(t.nativePath,async()=>{try{let e=await Iv(),r=await oe(e,["-s",t.nativePath],{timeout:Zs});return U(r,mk)}catch(e){kv().warn("raw-identify failed",{file:t.nativePath,error:Se(e)});return}})}function mk(t){let[e,r,i,o,n]=t.split("	");return kv().tap({msg:"parseRawInfoOutput()",result:zo(H(o),H(n),(s,a)=>({Filename:e,Make:r,Model:i,ImageSize:{width:s,height:a}})),meta:{input:t}})}var NP=S(require("os"));function uk(t,e,r=.5){return(1-r)*t+r*e}function rm(t,e,r){let i=e.x-t.x,n=(r-t.x)/i;return uk(t.y,e.y,n)}function $t(t){return v(t)&&(t.startsWith("video/")||t==="application/mp4"||t==="application/ogg")}function cs(t){return f(t,e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(N))}function pn(t){return f(t,e=>ui(()=>Rv(e.Orientation),()=>Rv(e.CameraOrientation),()=>Ma(e.Rotation)))}var ck=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function Rv(t){return f(t,e=>ck.get(e))}var yae=new Map([[0,1],[90,6],[180,3],[270,8]]);function _v(t){return t!=null&&N(t.width)&&N(t.height)}function kr(t){return`${t.width} \xD7 ${t.height}`}function Nv(t){return mb(t.width*t.height)}function nh(t){return{width:t.height,height:t.width}}function Bv(t,e){return yv(e)?nh(t):t}function Cv(t){return t.width/t.height<1}function xr(t){return au(t.width*t.height)}var fk=l(()=>h("SizeInfo"));function fs(t,e,r){let i=Ke([r?.ImageSize,{width:t.ImageWidth,height:t.ImageHeight}],s=>_v(s)?s:void 0);if(fk().debug("extractSizeInfo()",{filename:t.FileName,mimetype:t.MIMEType,rawInfo:r,fileDimensions:i}),i==null)return;let o=Bv(i,e),n=Be(o.width/o.height,5);return{ImageHeight:o.height,ImageWidth:o.width,aspectRatio:n,dimensions:o,rotation:e,fileDimensions:i}}var pk=D,dk=15*D,hk=10,gk={p0:{x:.8*Ge,y:4*E},p1:{x:20*Ge,y:12*E}},sh={p0:{x:11*Ge,y:12*E},p1:{x:26*Ge,y:24*E}},Vv={p0:{x:7*Ge,y:45*E},p1:{x:32*Ge,y:90*E}};function zv(t){return Wl(t.ext)?Math.max(M(ge(t.durationMs,e=>e*hk),0),rm(Vv.p0,Vv.p1,t.bytes)):0}function Uv(t){return x(yk(t),e=>e.result)}function yk(t){return x(bk(t),xk)}function bk(t){return x(t.size(),async e=>({bytes:e,ext:t.ext,durationMs:Wl(t.ext)?await x(Ie(t),r=>ge(r.Duration,i=>i*E)):void 0}))}function qv(t){return rm(sh.p0,sh.p1,Z(11*Ge,100*Ge,M(t,0)))}function xk(t){let e=Z(.5*Ge,64*uo,t.bytes),r=5*E,i=G,o=2*e*Su,n=y=>rm(y.p0,y.p1,Z(.5*Ge,50*Ge,e)),s=n(gk),m=Id(t.ext)?.includes(xt.RawImage)===!0?n(sh):0,c=zv(t),p=u.validateVideos.valueOrDefault?c:0;return{result:Z(pk,dk,Math.round(r+i+o+s+m+c+p)),dbMs:r,tagMs:i,copyMs:o,thumbMs:s,rawDecodeMs:m,transcodeMs:c,validateMs:p}}var Ec=new _e(256);W(()=>j(()=>Ec.clear()));W(()=>Gs((t,e)=>{Ec.getOrSet(t,()=>[]).push(e),Ec.getOrSet(e,()=>[]).push(t)}));function wk(t){return[t.toString(),...F(Ec.get(t.toString()))]}function Wv(t,e,r){for(let o of wk(t)){let n=r.get(o);if(n!=null)return n}let i=e(t);return r.set(t.toString(),i),i}var Dc=he("plus","lite");var jv=`
Hello, and thank you for using PhotoStructure!

The files in this folder support your PhotoStructure Library, including

  * a database with the filepaths to your photos and movies
  * previews and thumbnails of your photos and movies
  * content metadata about these assets, like ratings and sharing information
  * albums that both you and PhotoStructure Curators have assembled

Moving or deleting any files here will cause problems using your library.

If you have any questions, please visit <https://photostructure.com/support/>.

Sincerely,

Your Friendly Neighborhood PhotoStructure, v${Lt}`;function zt(t=u.libraryPath.value){return U(t,e=>ee.for(e).join(".photostructure"))}function ps(t=u.libraryPath.value){return U(t,e=>ee.for(e).join(u.originalsDir.valueOrDefault))}async function ah(t){let e=zt(t);if(e==null)throw new Error("empty dataDir");if(await e.mkdirp()==null)throw new Error("Could not mkdirp "+e);await e.mkNoMedia();let r=e.join("README.txt");return await r.size()!==jv.length&&await r.writeTxt_(jv),e}var Tk=require("https");async function Hv(t,e={}){return e.headers==null&&(e.headers={}),T(e.headers["user-agent"])&&(e.headers["user-agent"]=mo+" v"+Lt),new Promise((r,i)=>{let o=Tk.request(t.toString(),e);o.setTimeout(M(e.timeout,G),()=>{i(new ue({message:"Timeout fetching <"+t+">",doNotSend:!0,retriable:!0}))}),o.on("response",n=>{let s=[];n.setEncoding("utf8"),n.on("data",a=>s.push(a)),n.on("end",()=>{r({ok:ht(200,399,n.statusCode),headers:n.headers,body:s.join(""),statusCode:n.statusCode,statusMessage:n.statusMessage})})}).on("error",n=>{i(n)}),f(e.body,n=>o.write(n)),o.end()})}var Gv=S(require("zlib"));var cle=l(()=>JSON.parse(Iu("H4sIAAAAAAAAA6tWylWyUqrKyUxS0lEqADKTivJLcjJdUpPzcwuKUouLgyvzkoFSeUCptKL8XCCzDKQqsTjVzATISQRySvKDS4oy89KB3Bwgt7QkzUKpFgCQWYV5WQAAAA==")));function Ui(t){return JSON.parse((0,Gv.brotliDecompressSync)(Buffer.from(t,"base64")).toString("utf8"))}var uh=S(require("os"));var Kv=S(require("fs/promises"));var Mk=l(()=>h("ReadFile"));async function lh(t){try{return await(0,Kv.readFile)(t)}catch(e){Mk().info(".readFileMaybe("+t+")",e);return}}var mh=class{constructor(e,r,i){this.file=e;this.mkObject=r;this.onWrite=i;this.prior=l(()=>this.file.readJson("debug"))}async read(){let e=await this.prior();return h("JsonFileStore").debug("prior "+this.file,e),e??x(this.mkObject(),r=>this.write(r))}async write(e){try{return await this.file.writeJSON_(e,{spaces:2}),await this.prior.set(Promise.resolve(e)),h("JsonFileStore").info("wrote to "+this.file,e),this.onWrite!=null&&await this.onWrite(this.file,e),e}catch(r){throw new ue({cause:r,message:"Failed to write to "+this.file})}}};function vk(){return ku.safeRandomUid(16,4)}var Jv=class extends mh{constructor(e,r){super(e.join("."+r+"-uid.json"),()=>({uid:vk(),version:Lt,type:this.type,createdAt:Date.now()}),i=>i.hide());this.rootDir=e;this.type=r;this.read_=l(()=>pe(this.read(),e=>e.uid,()=>"missing!").catch(e=>{throw new ue({cause:e,fatal:!0,message:"Failed to read "+this.rootDir})}))}},Ac=l(()=>f(zt(),t=>new Jv(t,"library")));W(()=>{j(()=>{Ac.unset()}),u.libraryPath.addListener(()=>Ac.unset())});var $v=S(require("os"));var Sk=/^(?:[0:]+|[f:]+)$/i,Qv=l(()=>z(Y(pt((0,$v.networkInterfaces)()).map(t=>F(t).map(e=>e.mac))).filter(t=>v(t)&&Sk.exec(t)==null)));var Pk=l(()=>Ui("G7kAIIzUYs0Z7qRuS32pmsUk/UyD8OFBrsHUYemDqh3/zMuNBya1K0GYBazpDR8puUeR5pOPDwrAyLrH9L4GAhPQPWicizajRNayvHKU52siIpE9GddV7bjtHChhuc6wwPIkg/x4NH0P")),Yr=he("cu","lc","lm","mp","wm","li","cm","ma","vl");function Yv(t){return $(z(t.filter(Ek)),e=>[Yr.indexOf(e.split(":")[0]),e])}function Xv(t){return Pk()[t]}var Zv=15;async function qi(t,e){try{let r=g(await e);return T(r)||r.match(/^[\s0:_\/-]*$/)!=null?void 0:t+":"+gi(r.trim(),Zv,en)}catch(r){h("toUID").warn("failed",{pfx:t,err:r});return}}var Dk=l(()=>new RegExp(`^(${Yr.values.join("|")}):[0-9a-zA-Z]{${Zv}}$`));function Ek(t){return t!=null&&Dk().exec(t)!=null}var Po=l(()=>Ui("GwkBABwHdoyzjXCwzccdzUv9+g11VQzlNQjNotPVt0S2zHa8CLMs19auq91f4APvhhMIPZZ0m49e3qooFMQq6ej4jJBRUbv5BmSQzUeTCzW5mdaimgkX4ZqrHjPAjQ8XSSsp+cYQ79EXELnYMzlJwyYHVTq/nMkq900q5+mx2ayLgl3s6O7FgGooQh++7vpBI+Qpw3dCNqYDIfr6zPvUur259BmFMDQjV/hviADXURsBk2HJBesB")),Fc=l(()=>h(Po().n));async function Ak(){return qi(Yr.li,await Ac()?.read_())}function Fk(){return qi(Yr.cm,(0,uh.cpus)()[0].model)}function Lk(){return Qv().map(t=>qi(Yr.ma,t))}async function Ik(){return F(await Ot()).map(t=>qi(Yr.vl,t.uuid))}async function Ok(){let t=await oe(Po().c,["-1"],{timeout:5*E});return Fc().tap({msg:Po().c,result:t.match(/serial.*=\s*([a-z0-9-]{12,})/i)?.[1]})}async function kk(){try{return U(await Ok(),t=>qi(Yr.lc,t+":"+(0,uh.cpus)()[0].model))}catch(t){Fc().info(Po().c+" failed",t);return}}async function _k(){try{let t=await Rk();return qi(Yr.mp,t)}catch(t){Fc().info("ioreg failed",t);return}}async function Rk(){return(await oe(Po().i,Po().ia,{timeout:5*E})).match(/uuid" = "([a-z0-9-]{12,})"/i)?.[1]}async function Nk(){return(await de.instance().executeJson(Po().w))?.MachineGuid}async function Bk(){let t=await Nk();return qi(Yr.wm,t)}var Ck=l(async()=>Ce()?[]:tt?[qi(Yr.lm,lh(Po().lv)),qi(Yr.lm,lh(Po().le)),kk()]:ae?[_k()]:I?[Bk()]:[]);async function Lc(){let t=await Promise.all([Ak,Fk,Ik,Lk,Ck].map(async e=>{try{return await ke(e(),5*E)}catch(r){return Fc().warn(r)}}));return Yv(z(await yl(t)))}var Pa=class{constructor(e,r,i,o){this.s=e;this._l=r;this._sids=i;this.meta={src:o}}get l(){return this._l}get ok(){if(this._l==null)return!1;let e=pp(this._sids,this._l.uids),r=z(e.map(s=>s.split(":")[0])),i=A(r.map(s=>Xv(s))),o=i.length>=this._l.mat,n=ht(this._l.iat?.getTime(),this._l.exp?.getTime()+ot,Date.now());return this.meta[ve().o]=n,this.meta[ve().u]=o,this.meta[ve().m]=i,n&&o}cmpVal(){return[this.ok,-Dc.indexOf(this.l?.[ve().T]),this.l?.exp?.getTime()??1,this.meta.matchedSchemes]}cmp(e){return Xt(this.cmpVal(),e.cmpVal())}};var Ic=l(()=>h("writeLicense"));async function tS(t){let e=await ch(t,"candidate");if(e==null)return Ic().error("!ok",t);await eS(e,zt()?.join(ve().d)),await eS(e,Me.for(Ni()).join(ve().d)),dn.unset()}async function Vk(t){return(await le(t.childFiles(),async e=>ch((await e.readFile())?.toString().trim(),e.nativePath))).filter(e=>e.ok&&e instanceof Pa)}async function eS(t,e){if(e==null)return;if((await Vk(e)).some(i=>i.cmp(t)>=0)){Ic().info("saveIfBetter(): no-op for "+e);return}else{let i=e.join(gi(t.s)+".txt");return await i.writeFile_(t.s).then(()=>(Ic().info("saveIfBetter(): wrote to "+i),i)).catch(o=>{Ic().error("saveIfBetter(): failed to save license to "+e,o)})}}var Eo=l(()=>h(Wi().l)),Wi=l(()=>Ui("G9YAwIzTFfOihHWPgG6m/h0h65IqCersIGkdlq6+6ra6+PjQ8mHlRTkDg6UJJqPJEIU6WaIUNodfF2xPB7iLWJDlIN8z6xhOKyn4qqHpZlh6qCZUoQghd4BVMkz3A0IIevFn+7UO7uM+VGJb/MeZXfHngpQWZzk=")),rS=l(async()=>{let t=Wi().s+": ";try{if(!u[Wi().s].valueOrDefault)return Eo().debug(t+"no-op (settings disabled)");let e=(await dn()).filter(n=>n.l!=null&&v(n.s)),r=new Date,i=e.find(n=>n.ok&&r<n.l.exp);if(i!=null)return Eo().debug(t+"no-op: ",i);let o=await Me.for(Ni()).join(Wi().s).mkdirp_();for(let n of e){if(T(n.s)||n.l==null||r<n.l.exp)continue;let s=n.l.uids.find(a=>a.startsWith("cu:"));if(s==null){Eo().debug(t+"skipping (no cu)",n);continue}await o.join(tn(n.s,14)+".txt").applyIfEmpty_(async a=>{await zk(s),await a.writeJSON_({l:n.l,at:Date.now()}),Eo().warn(t+"requested",n)})}}catch(e){Eo().warn(t+"failed",e)}},15*D);async function zk(t){try{let e=await Lc();if(L(e))return Eo().warn("no-op: empty sids");let r=k({uids:[...e,t]}),i=w(w({},Wi().r),{body:r}),o=await Hv(Wi().u,i);Eo().info(Wi().u,{req:i,response:o}),o.ok?await tS(JSON.parse(o.body)?.[Wi().a]):Eo().warn(Wi().u,{req:i,response:o})}catch(e){Eo().warn(Wi().u,e)}}var mP=S(lP());var Da=l(()=>Ui("G9AAICwK7KZhK2gx/dEjjDHuEVVxShG2PVDGAcBqBqP3binicrOwzdRXMfMKd00dlj6bnSYcBaK1S8KWhAGGv73Zu73eMMKnXGoKt4NsAefjf3tdIWcHCM4FdbL+J+haq7GA2/ps1jHled6Oe+3j+k+BBQbgzzJmnLDvnTnXr11NbkL3X+vvWdyYILH9urnb+EV39HOm4Y5Hcrfqyt5i5iCfpGaVUqOnNfYDdeWC8wV2OWE=")),Vue=l(()=>{try{return require(Da().c)[Da().m](Da().o)}catch(t){se(Da().m+ye,t)}});function uP(t){return mP.V2[Da().w](t,Da().o)}var ve=l(()=>Ui("GwwBABwHdkzj5qg5WDnubFuq7NaxSKjiobwK4iGSLDp98J87fqD679bWgnaVtCVBQAEFBJm7aiN4y7puJw8PPz+CHDoAhk5Fd0AhTjKYPbo8F5freFUJHhQHc2xp4qfyoqKKAmGb7IkFZwkajH7uJCR829lmguhEXw/iusqUQE4nk7LeJyad4wmdptoVln0otnUOO3UHnEyjrxtXUr7B")),cP=l(()=>h(ve().l));async function F_(t){let e=await uP(Pi(g(t).trim(),ve().p)),r=Vd(e[ve().i]);if(r==null)throw new Error("bad "+ve().i+": "+e[ve().i]+" ("+t+")");let i=Vd(e[ve().r]);if(i==null)throw new Error("bad "+ve().r+": "+e[ve().r]+" ("+t+")");return e[ve().a]=e[ve().a]>=0?e[ve().a]:2,e[ve().i]=new Date(r),e[ve().r]=new Date(i),e[ve().b]=g(e.uids).split(","),e}async function vh(t,e){try{return new Pa(t,await F_(t),await Lc(),e)}catch(r){return cP().tap({msg:ve().v,result:{s:t,ok:!1,meta:{err:r}}})}}async function ch(t,e){if(T(t))return;let r=await vh(t,e);return B(r?.ok)&&r instanceof Pa?r:void 0}var dn=l(async()=>{let t=A([zt()?.join(ve().d),Me.for(Ni()).join(ve().d)]),e=Y(await sr(t,o=>o.childFiles())),r=Y(await sr(e,async o=>U(F(await o.readLines()).map(n=>n.trim()).join(""),n=>vh(n,o.nativePath))));await U(u[ve().L].value,async o=>r.push(await vh(o,"Settings")));let i=L_(r);return W(rS),cP().tap({msg:ve().d+"()",result:i})});async function L_(t){return $(t,e=>[!e.ok,Dc.indexOf(e.l?.[ve().T]),-(e.l?.exp?.getTime()??1)])}W(()=>dn[ve().n]=()=>null);function Sh(){return x(dn(),t=>t[0]?.ok?t[0]:void 0)}async function Ph(){return bt(Sh()).flatMap(t=>t.l?.[ve().T]).getOrElse(()=>ve().f)}async function ji(){try{return await Ph()===ve().f}catch{return!0}}var I_=l(()=>{u.cacheDir.addListener(()=>Do.unset())}),Do=l(()=>{try{I_();let t=ee.for(u.cacheDir.valueOrDefault);return t.mkNoMedia_(),t}catch(t){throw se("Failed to set up cacheDir"+ye,t),t}},D);var O_=["image/gif","image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"];function Bc(t){return O_.includes(g(t).toLowerCase())}var k_=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);function bn(t){return k_.has(g(t).toLowerCase())}var R_=/^\(?Binary data (\d+).*use -b option to extract\)?$/i,Aa=class{constructor(e){this.binaryDataBytes=e}};function fP(t){if(typeof t!="string")return;let e=t.match(R_);return e==null?void 0:new Aa(H(e[1],{defaultValue:0}))}function Cc(t,e){return rl(t.width,e.width)&&rl(t.height,e.height)}function pP(t,e){return ro(t.width,e.width)&&ro(t.height,e.height)}var dP=l(()=>h("HeifConvert"));W(()=>j(()=>Vc.unset()));var Vc=l(async()=>rh(u.heifConvertPath.valueOrDefault));async function __(){let t=await Vc();return dP().tap({msg:"isHeifConvertSupported()",result:v(t),meta:{heifConvertPath:t}})}async function hP(t){if(!!await __())return x(Hi(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await qe(u.heifConvertPath.valueOrDefault,["-q",String(u.jpegQuality.valueOrDefault),t.nativePath,r.nativePath],{timeout:G})}catch(i){dP().warn("heif2jpeg(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var gP=l(()=>h("sips")),yP=l(async()=>{try{return await oe("command",["-v","sips"],{timeout:yr})}catch(t){let e=Me.for("/usr/bin/sips");if(await e.isExecutable())return e.nativePath;gP().info("sips is missing from $PATH",t);return}});async function bP(t){return x(Hi(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await qe("sips",["-s","format","jpeg","-s","formatOptions",String(u.jpegQuality.valueOrDefault),t.nativePath,"--out",r.nativePath],{timeout:G})}catch(i){gP().warn("sips(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var N_=l(()=>h("Heif")),zc=l(async()=>{try{if(ae)try{let e=await yP();if(!T(e))return{ok:!0,msg:e}}catch(e){N_().error("Failed to find the sips tool (either in PATH or /usr/bin).",e)}let t=await Vc();return{ok:v(t),msg:Zt(t,u.heifConvertPath.valueOrDefault+": not installed")}}catch(t){return{ok:!1,msg:hi(t)}}});async function Uc(){return(await zc()).ok}W(()=>j(()=>zc.unset()));var B_=/^image\/hei[fc]$/i;function hs(t){return B_.exec(g(t))!=null}async function xP(t,e,r,i=1e3){let o=await yt(()=>C(t.listeners(e)),{timeoutMs:i});return o&&t.emit(e,r),o}var TP=S(require("util"));function wP(t,e){let r=t.width/t.height,i=e.width/e.height;if(r>=i){let o=Math.min(e.width,t.width);return{width:o,height:Math.ceil(o/r)}}else{let o=Math.min(e.height,t.height);return{width:Math.ceil(e.height*r),height:o}}}var qt=he("fit","sq");var C_=he("cover","contain","fill","inside","outside"),xn;(function(o){let t=l(()=>h("Reducers.Square"));o.name=qt.sq,o.fit="cover";function i(n,s){let a=pP(n,s)?w(w({},n),{fit:C_.cover}):void 0;return t().tap({msg:"reduce()",result:a,meta:{max:n,input:s}})}o.reduce=i})(xn||(xn={}));var Rr;(function(o){let t=l(()=>h("Reducers.Fit"));o.name=qt.fit,o.fit="inside";function i(n,s){if(Cc(s,n)){t().trace(`reduce(): input ${kr(s)} is too small for ${kr(n)}`);return}return wP(s,n)}o.reduce=i})(Rr||(Rr={}));var zfe=require("sharp"),Qt=class{constructor(e,r,i,o,n=!0){this.name=e;this.maxWidth=r;this.maxHeight=i;this.reducer=o;this.rotational=n;this.megapixels=l(()=>au(this.maxWidth*this.maxHeight));this.max={width:r,height:i},Qt._Sizes.push(this)}static sq(){return this._Sizes.filter(e=>e.reducer===xn)}static largestSq(){return et(this.sq(),e=>e.megapixels())}static fit(){let e=u.previewResolutions.valueOrDefault;return this._Sizes.filter(r=>r.reducer===Rr&&e.includes(r.name))}static largestFit(){return et(this.fit(),e=>e.megapixels())}[TP.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"\xD7"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&Cv(e)?nh(this.max):this.max,e)}resize(e,r){return r=r.resize(w(w({},e),{fit:this.reducer.fit,withoutEnlargement:!0})),r}toJpeg({path:e,sh:r,outputSize:i}){return(xr(i)<2||u.sharpen.valueOrDefault)&&(r=r.sharpen()),r.jpeg({quality:u.jpegQuality.valueOrDefault,progressive:u.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}},We=Qt;We._Sizes=[],We.UHD8k=new Qt("uhd8k",7680,4320,Rr,!1),We.UHD5k=new Qt("uhd5k",5120,2880,Rr,!1),We.UHD=new Qt("uhd4k",4096,2160,Rr),We.QHD=new Qt("qhd",3120,1440,Rr),We.FHD=new Qt("fhd",1920,1080,Rr),We.HD=new Qt("hd",1280,720,Rr),We.WVGA=new Qt("wvga",720,480,Rr),We.QVGA=new Qt("qvga",320,240,Rr),We.QQVGA=new Qt("qqvga",160,120,Rr),We.S480=new Qt("s480",480,480,xn),We.S240=new Qt("s240",240,240,xn),We.S120=new Qt("s120",120,120,xn),We.S60=new Qt("s60",60,60,xn);var qc=h("libraw");var V_=["-T"],z_=["-Z","-"],U_=["-o","1"],q_=["-t","0","-j"];async function MP(t){let e=Date.now(),r=await Xr(t);if(r==null)return qc.throw("Cannot decode RAW "+t+": no EXIF dimensions."+ho+Nt);let i=We.largestFit().outputSize(r),o=[];i!=null&&4*xr(i)<xr(r)&&(qc.debug("Large original source: using -h"),o.push("-h"));let n=await Lv(),s=[...V_,...z_,...U_,...o,...q_,...u.dcrawEmuArgs.values,t.nativePath],a=5*D,m={encoding:"buffer",timeout:a,maxBuffer:250*Ge};qc.debug("dcraw_emu()",{cmd:n,args:s,opts:m});let c=await ln(n,s,a,m),p=async P=>{await xP(c.stdout,"error","Problem from "+t+": "+$x(P,t.nativePath))||qc.error("No listeners for error when reading "+t,P),c.kill("SIGINT")};c.on("error",p),c.stderr.on("data",p);let d=qv(await t.size())/7,y=new Qn({path:t.nativePath,op:"Converting raw image"},d,()=>Date.now()-e);return c.on("close",()=>y.end()),c.stdout}var Eh=require("sharp"),gs=h("SharpReadable");async function j_(t,e,r,i){let o=e?.[r];if(!(o instanceof Aa))return;let n=i.width*i.height*.1;if(o.binaryDataBytes==null||o.binaryDataBytes<n){gs.debug("imgFromExif(): rejecting (too small) "+r,{minBytes:n,val:o});return}let s=await W_(t,r),a=await f(s,Xr);return gs.tap({msg:"imgFromExif()",meta:{src:t.baseWithGrandparent,tag:r,dim:a,minDim:i},result:a!=null&&Cc(i,a)?s:void 0})}var H_=l(()=>{Eh.simd(u.enableSIMD.valueOrDefault),Eh.cache(u.enableVipsCache.valueOrDefault),Eh.concurrency(pl())});function ys(t,e,r=!1){return mt(`img.sharpReadable${t.ext.toUpperCase()}`,()=>G_(t,e,r))}async function G_(t,e,r=!1){H_();let o=await Ie(t,!r),n=o?.MIMEType;if(o==null||T(n))throw new Error(t+" is not supported (missing mimetype)");if(hs(n)&&!await Uc()){gs.warn("sharpReadable(): HEIF file, but heif support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}if($t(n)&&!await am()){gs.warn("sharpReadable(): video file, but video support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}let s=[],a=pn(o),m=fs(o,a,bn(n)?await Pc(t):void 0);if(m!=null){let d=M(e,{width:m.dimensions.width*.95,height:m.dimensions.height*.95});if(xr(d)>15&&(r||a==null||a===0)&&!$t(n)){let P=u.embeddedPreviews.valueOrDefault;e!=null&&xr(e)<1&&P.unshift(...u.embeddedThumbnails.values),s.push(...P.map(_=>()=>j_(t,o,_,d)))}}hs(n)&&(ae&&s.push(()=>bP(t)),s.push(()=>hP(t))),Bc(n)&&s.push(async()=>t),m!=null&&bn(n)&&s.push(()=>(gs.info("sharpReadable() -> dcraw()",{src:t.nativePath,minDim:e}),SP({src:t,desc:"dcraw",suffix:".tiff",f:()=>MP(t)}))),n.startsWith("video/")&&s.push(()=>Kr(()=>sm(t,n),{maxRetries:1}));let c=[],p=await bx(s,d=>{gs.warn("strategy failed for "+t+": "+d),c.push(d)});if(p==null)throw M(c[0],new Error("Cannot read "+t+" ("+n+")"));return p}function W_(t,e){let r=e.toLowerCase().endsWith("tiff")?".tiff":".jpg";return x(Hi(t,e,r),i=>i.applyIfEmpty_(async o=>{try{return await vP(e,t.nativePath,o.nativePath)}catch(n){gs.warn("Failed to extract embedded "+e+" from "+t.nativePath+": "+n);return}}))}var ede=require("sharp"),K_=l(()=>h("ImgCache")),J_="imgcache";async function lm(){return Do().join(J_).mkdirp_().catch(t=>{se("Failed to create imgCache directory"+ye,t)})}async function Hi(t,e,r){let i=await t.stat();if(i==null)throw new Error(`cachedImgFile(${t}): unreadable`);let o=await lm();if(o==null)throw new Error("imgcache dir is missing");let n=await tm(t.nativePath);if(n==null)throw new Error("Cannot read filetype for "+t);let s=tn(k({basename:t.base.toLowerCase(),mimetype:n.mime,size:i.size}));r=Pi(r,".");let a=o.join(...jo(s.slice(0,24),2,3),e+r);if(await a.parent().mkdirp()==null)throw new Error("Cannot make dest dir, "+a.parent());return K_().debug("cachedImgFile("+t.baseWithGrandparent+")",{desc:e,ext:r,result:a}),a}async function SP({src:t,desc:e,suffix:r,f:i}){try{return await x(Hi(t,e,r),o=>o.applyIfEmpty_(async n=>x(i(),s=>n.writeStream_(s))))}catch(o){throw new ue({cause:o,message:"readableToFile() failed"})}}var $_=I?"NUL":"/dev/null",Q_=l(()=>h("jpegtran"));async function PP(t){let e=await oh();try{await qe(e,["-outfile",$_,t.nativePath],{timeout:30*E,isIgnorableError:mm})}catch(r){throw new ue({cause:r,doNotSend:!0,fatal:!1,retriable:!1})}}async function EP(t,e){let r=t.wip();Q_().info("rotateInPlace("+t+")",e),await Y_(t,r,e),await r.unwip_(),Fr(t.nativePath)}async function Y_(t,e,r){let i=await oh();if(!Qd(r))throw new Error("refusing to rotate("+t+", "+r+")");await oe(i,["-copy","all","-trim","-rotate",r.toFixed(0),"-outfile",e.nativePath,t.nativePath],{timeout:D})}var X_=require("sharp"),Dh=l(()=>h("ValidFile")),Wc=l(()=>new _e(1024,D));W(()=>j(()=>Wc.prior()?.clear()));W(()=>Kt(t=>V(t).forEach(e=>{Wc.prior()?.delete(e)}).orElse(()=>{Wc.prior()?.clear()})));var Z_=l(()=>Lw(u.validationErrorBlocklist.values,"i"));function mm(t){return Dh().tap({msg:"isIgnorableValidationError",result:Z_().exec(Se(t))==null})}async function jc(t){if(await ji()||!u.validateJpegImages.valueOrDefault&&!u.validateVideos.valueOrDefault){Dh().debug("no validation for "+t,{validateJpegImages:u.validateJpegImages.valueOrDefault,validateVideos:u.validateVideos.valueOrDefault});return}return Wv(t,eN,Wc())}async function eN(t){let e=ee.for(t);try{let r=await So(e);if(r==null)throw new Error("Cannot validate, no mimetype");if($t(r))u.validateVideos.valueOrDefault&&(Dh().debug("validating "+e),await DP(e,r));else if(r.startsWith("image/")){if(r==="image/jpeg"){if(u.validateJpegImages.valueOrDefault)return await PP(e)}else if(u.validateRawImages.valueOrDefault){let i=await ys(e);if(i==null)throw new Error("Cannot read");await X_(i.nativePath,{failOnError:!0}).tiff().toBuffer()}}else throw new Error("Unsupported mimetype, "+r)}catch(r){throw new ue({cause:r,message:"invalid file "+e,retriable:!1,doNotSend:!0,ignorable:!0})}}var AP=l(()=>h("ffmpeg")),tN=l(()=>Z(1,8,Ze(Ft()/2))),rN=/ffmpeg version (\S+)/i,um=l(async()=>{try{let t=await qe(u.ffmpegPath.valueOrDefault,["-version"],{timeout:G,ignoreStderr:!0,isIgnorableError:()=>!0}),e=rN.exec(t.result)?.[1];return AP().info("ffmpegVersion",{version:e,code:t.code,stdout:t.result.split(`
`,1)[0]}),t.code===0&&v(e)?e:void 0}catch(t){return}}),rhe=l(()=>pe(um(),t=>"version "+t,()=>"(not found)"));W(()=>j(()=>um.unset()));async function FP(){return Re(um.prior(),()=>um.refresh())}async function cm(){return await um()!=null}async function LP(t){return await t.dest.exists()&&await t.dest.isEmpty()&&await t.dest.unlink(),qe(u.ffmpegPath.valueOrDefault,A(["-loglevel","error","-i",t.src.nativePath,...Hs(t.startAtSec,e=>["-ss",e.toFixed(1)])??[],"-vframes","1","-f","singlejpeg","-y",t.dest.nativePath]),{timeout:D,isIgnorableError:mm})}async function IP(t){return AP().tap({msg:"ffmpegValidVideo",meta:{src:t.nativePath},result:await qe(u.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",g(tN()),"-i",t.nativePath,"-f","null","-"],{timeout:M(await Uv(t),2*D),isIgnorableError:mm,ignoreExitCode:!0,quiet:!1})})}var OP=S(require("path"));var Fa=l(()=>h("vlc"));var iN=/VLC (?:version|media player) ([0-9.]+)/i,kP=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"],fm=l(()=>oN());W(()=>j(()=>fm.unset()));async function RP(){return Re(fm.prior(),()=>fm.refresh())}async function Ah(){return!kp&&await pe(fm(),t=>t.version!=null,()=>!1)}function nN(){return x(fm(),t=>t.version==null?void 0:t.path)}async function sN(t){return x(qe(t,[...kP,"--version"],{timeout:G,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),e=>V(e.result).filter(v).map(r=>r.trim()).flatMap(r=>iN.exec(r)).flatMap(r=>r[1]).get())}function aN(t){return x(de.instance().execute(`(Get-Item -path ${Zn(t)}).VersionInfo.FileVersion`,e=>e).catch(e=>{Fa().warn("Failed to run vlcInfoWin: "+t+": "+e)}),e=>Is(e.trim()))}async function oN(){let t=[];function e(...r){t.push(ee.for((0,OP.join)(...r)))}if((!I||u.vlcPath.hasValue())&&t.push(u.vlcPath.valueOrDefault),ae){let r="/Applications/VLC.app/Contents/MacOS/VLC";U(He("HOME"),i=>e(i+r)),e(r)}if(I){let r=["VideoLAN","VLC","vlc.exe"];U(He("LOCALAPPDATA"),i=>{e(i,"Apps",...r)}),U(He("ProgramFiles"),i=>{e(i,...r)}),U(He("ProgramFiles(x86)"),i=>{e(i,...r)})}for(let r of t)try{if(r instanceof ee&&await r.clear().notExists())continue;let i=r.toString(),o=await(I?aN(i):sN(i));if(T(o)){Fa().info("vlcInfo(): no VLC version found for "+r);continue}else return vt({path:i,version:o},n=>Fa().info("vlcInfo()",n))}catch(i){Fa().warn("vlcInfo(): err:"+i,{path:r})}}async function _P(t){let e=await nN();if(T(e))return Fa().throw("vlcFrame(): empty vlcPath",w(w({},t),{ignorable:!0}));let r=Qe(t.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(r))return Fa().throw("vlcFrame(): Invalid destination extension"+Nt,{format:r,args:t});let i=t.startAtSec??0,o=i+1,n=await qe(e,A([...kP,"--avcodec-hw=none","--video-filter=scene","--scene-format="+r,"--scene-replace","--scene-ratio=500","--scene-path="+t.dest.dir,"--scene-prefix="+t.dest.name,"--start-time="+i.toFixed(1),"--stop-time="+o.toFixed(1),t.src.nativePath,"vlc://quit"]),{timeout:D,ignoreStderr:!0});if(t.dest.clear(),N(n.code))throw new Error("vlc failed: "+k(n));return n}var uge=l(async()=>(0,NP.totalmem)()>16*al&&Ft()>5&&await cm()?2:1);async function Fh(t){return await Ct(()=>B(t?.ignoreffmpeg)&&!Er?void 0:x(FP(),e=>({ok:!0,msg:"FFmpeg "+e})),()=>B(t?.ignorevlc)?void 0:x(RP(),e=>({ok:!0,msg:"VLC "+e.version})),()=>({ok:!1,msg:"(no video tools were found)"}))}var am=l(async()=>(await Fh()).ok);W(()=>j(()=>am.unset()));async function sm(t,e,r){if(!$t(e))return;let i=B(r?.useVlc)?!1:B(await Re(r?.useFfmpeg,()=>cm())),o=!i&&B(await Re(r?.useVlc,()=>Ah()));if(!i&&!o)return;let n=h("img/Video.extractVideoFrame("+t+")"),s=await Hi(t,"frame",".jpg");n.debug("extractVideoFrame",{dest:s.nativePath,mimetype:e});let a=await t.mtimeMs();if(a==null)return n.throw("null mtime");let m=await Ie(t);if(m==null)return n.throw("no tags");let c=pn(m);n.debug("video orientation:"+c);let p=fs(m,c)?.dimensions,d=await s.stat(),y=d==null?void 0:await Xr(s);if(d!=null&&d.mtimeMs>a&&y!=null&&(p==null||y.height===p.height&&y.width===p.width))return n.debug("prior dest, "+s+" seems reasonable",{srcDim:p,destDim:y}),s;let P=cs(m),_=Math.min(P??0,u.videoFrameAtSec.valueOrDefault);return n.info("extracted metadata",{startAtSec:_,duration:P}),await s.applyWip(async ie=>{let Xe=w({src:t,dest:ie,startAtSec:_},p);await(i?LP(Xe):_P(Xe)),await BP(ie),o&&c!=null&&c!==0&&(n.info("rotating in place..."+ie,{rot:c}),await EP(ie,c))}),s}async function lN(){return u.transcodeVideos.valueOrDefault&&(await cm()||await Ah())}async function CP(t){let e=h("needsTranscoding("+t+")");if(!await lN())return e.tap({msg:"videoTranscodingSupported is false",result:!1});let r=await Ie(t);if(r==null)return e.tap({msg:"Cannot transcode files that exiftool can't read",result:!1});let i=r.MIMEType;if(!$t(i))return e.tap({msg:"not transcoding (unsupported mimetype)",result:!1,meta:{mimetype:i}});let o=cs(r);if(!Fs(o,u.minVideoDurationSec.valueOrDefault))return e.tap({msg:"not transcoding (video duration is too short)",result:!1,meta:{duration:o}});let n=R([r.AudioFormat]),s=n.some(p=>_t(u.doNotTranscodeAudioCodecs.values,p)),a=R([r.VideoCodec,r.CompressorID,r.CompressorName]),m=a.some(p=>_t(u.doNotTranscodeVideoCodecs.values,p)),c=_t(u.doNotTranscodeMimetypes.values,i);return e.tap({msg:"result",result:!(s&&m&&c),meta:{mimetype:i,isSafeMimetype:c,audioCodecs:n,isSafeAudioCodec:s,videoCodecs:a,isSafeVideoCodec:m}})}async function DP(t,e){let r=h("img/Video.validVideo("+t+")");if(await sm(t,e)==null&&r.throw("Could not extract a video frame"),await cm())return IP(t)}var gE=S(require("luxon"));var wt=S(require("exiftool-vendored")),it=S(require("luxon"));var VP=S(require("luxon"));var Lh=14,mN=l(()=>VP.DateTime.local().offset,At);function zP(t){return t==null||Math.abs(t)>Lh*60?!1:t===0?mN()===0:!0}var Ih=S(require("exiftool-vendored"));var uN=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/,Tr=class{constructor(e,r,i,o=0,n=1){this.start=e;this.middle=r;this.end=i;this.index=o;this.splits=n;this.toISOString=this.toString.bind(this);this.year=Lo(this.middle),this.month=Fo(this.middle),this.day=Ao(this.middle)}static fromISO(e){e=g(e).trim();let r=uN.exec(e);if(r==null)return;let i=Ih.ExifDateTime.fromISO(r[1]),o=Ih.ExifDateTime.fromISO(r[2]),n=H(r[3]),s=H(r[4]);return this.for(i,o,n,s)}static for(e,r,i=0,o=1){if(!mr(e)||!mr(r))return;let n=Gi(e),s=Gi(r);if(n==null||s==null)return;o=Z(1,1e3,H(o,{defaultValue:1})),i=Z(0,o-1,H(i,{defaultValue:0}));let a=f(n.toDateTime().until(s.toDateTime()).divideEqually(o+1)[i],m=>m.end);if(a!=null)return new Tr(n,Gi(a,M(n.zone,s.zone)),s,i,o)}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return M(this.start.zone,this.end.zone)}get hasTimes(){return wr(this.start)&&wr(this.end)}toString(e=!0){return`${pm(this.start,e)}/${pm(this.end,e)}`+(this.index===0&&this.splits===1?"":`/${this.index}/${this.splits}`)}includes(e){if(e==null)return!1;let r=Gi(e);return r!=null?this.interval().contains(r.toDateTime()):this.year===Lo(e)&&this.month===Fo(e)&&this.day===Ao(e)}};function Hc(t,e=2){return t==null?"":rr(t,e,"0")}function mr(t){if(t==null||typeof t=="string"||t===0)return!1;let e=Zr(t);return e==null||e===0||!UP(Lo(t),Fo(t),Ao(t))?!1:wr(t)?J(cN(t),r=>r.isValid,()=>!1):!0}function wn(t,e){return mr(t)?e(t):void 0}var qP=l(()=>u.minValidYear.valueOrDefault,At),Oh=l(()=>new Date(Date.now()+ot).getFullYear(),At),WP=l(()=>new Date(Date.now()+ot).getMonth()+1,At);W(()=>j(()=>{qP.unset(),Oh.unset(),WP.unset()}));function fN(t){return ht(qP(),Oh(),t)}function pN(t,e){return As(e,Oh())&&Fs(t,WP())?!1:ht(1,12,t)}function dN(t,e,r){return r!=null&&it.DateTime.fromObject({year:t,month:e,day:r}).isValid}function UP(t,e,r){return fN(t)&&(e==null||pN(e,t)&&(r==null||dN(t,e,r)))}var La=class{constructor(e,r,i){this.year=e;this.month=r;this.day=i}static for(e,r,i){return UP(e,r,i)?new La(e,r,i):void 0}static localToday(){return kh(new Date)}toString(){return A([this.year,this.month,this.day]).map(e=>Hc(e)).join("-")}toISOString(){return this.toString()}toDateTime(){return it.DateTime.fromObject(this)}},jP=class{constructor(e,r,i,o,n){this.monthsToMonth=e;this.re=r;this.yearIndex=i;this.monthIndex=o;this.dayIndex=n}apply(e){let r=this.re.exec(e);if(r!=null){let i=parseInt(r[this.yearIndex],10),o=this.month(r),n=this.dayIndex==null?void 0:parseInt(r[this.dayIndex],10);return La.for(i,o,n)}else return}month(e){if(this.monthIndex==null)return;let r=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(r)?this.monthsToMonth.get(r):H(r)}},Io="((?:19|20)[0-9]{2})",HP="(1[0-2]|0[1-9])",hN="(1[0-2]|0?[1-9])",GP="([1-3][0-9]|0[1-9])",Gc="([1-3][0-9]|0?[1-9])",gN="(1[0-9]|2[0-3]|0[0-9])",KP="([0-5][0-9])",yN=KP,bN=KP,Kc="([-\\.\\,:_/ |])",Jc=Kc+"?",xN="(?:(\\.[0-9]+))?",JP="(?:(Z|UTC)|(?:([+-])([01][0-9]):?([0-5][0-9])))",wN=new RegExp("\\d\\d\\s*"+JP,"i");function Rh(t){return f(wN.exec(t),e=>$P(e.slice(1)))}function $P(t,e){if(L(t))return e;let[r,i]=t.splice(0,2),[o,n]=t.splice(0,2).map(s=>H(s));return _t(["z","utc"],r)?0:cb([i,o,n])?e:(i==="-"?-1:1)*(o*60+n)}function _h(t){return U(t,e=>Vb([()=>wt.ExifDateTime.fromEXIF(e),()=>TN(e)],r=>mr(r)))}var MN=l(()=>h("FuzzyDate"));function QP(t,e=!1){if(!T(t))for(let{desc:r,f:i}of[{desc:"DateInterval.fromISO",f:()=>Tr.fromISO(t)},{desc:"parseDateTime",f:()=>_h(t)},{desc:"DateTime.fromFormat(macOS)",f:()=>it.DateTime.fromFormat(t,"y-M-d 'at' H.m.s")},{desc:"DateTime.fromFormat(gnome)",f:()=>it.DateTime.fromFormat(t,"y-M-d H-m-s")},{desc:"DateTime.fromFormat(yMMdd_HHmmss)",f:()=>it.DateTime.fromFormat(t,"yMMdd_HHmmss")},{desc:"ExifDate.fromEXIF",f:()=>wt.ExifDate.fromEXIF(t)},{desc:"fuzzyDate.parseYMD",f:()=>Ia().parseYMD(t)},{desc:"new Date()",f:()=>e?new Date(t):void 0}]){let o=i();if(mr(o)){let n=Rh(t);return n!=null&&(o.tzoffsetMinutes=n),MN().tap({msg:"parseDated()",result:o,meta:{s:t,desc:r,tzoffsetMinutes:n}})}}}var YP=class{constructor(e){this.locale=e;this.monthsToMonth=new Map;this.ymdPatterns=[];this.ymPatterns=[];this.yPatterns=[];this.setup()}parseYMD(e){return Ke(this.ymdPatterns,r=>r.apply(e))}addParser(e,r,i,o){let n=new jP(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),r,i,o);o!=null&&i!=null?this.ymdPatterns.push(n):u.fuzzyYearParsing.valueOrDefault&&o==null&&i!=null?this.ymPatterns.push(n):u.fuzzyYearParsing.valueOrDefault&&o==null&&i==null&&this.yPatterns.push(n)}setup(){let e=["short","long"];for(let i of z([this.locale,"en-US"]))for(let o of e){let n=new Intl.DateTimeFormat(i,{month:o});ce(12,s=>{let a=n.format(new Date(2017,s));this.monthsToMonth.set(a.toLowerCase(),s+1)})}let r="("+tr([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(Io+Kc+hN+"\\2"+Gc,1,3,4),this.addParser(Io+Jc+HP+"\\2"+GP,1,3,4),this.addParser(Io+Jc+r+"\\2"+Gc,1,3,4),this.addParser(r+Jc+Gc+",?\\2"+Io,4,1,3),this.addParser(Gc+Jc+r+",?\\2"+Io,4,3,1),u.fuzzyDateParsing.valueOrDefault&&(this.addParser(r+Kc+Io,3,1),this.addParser(Io+Kc+r,1,3)),this.addParser(Io,1)}extractDateFromPath(e){if(!u.usePathsToInferDates.valueOrDefault)return;SN.forEach(i=>{Hm(e,i)&&e.splice(0,i.length)}),e=e.filter(i=>v(i)&&e[0].match(vN)==null);let r=[...e].reverse();return ui(()=>Ke(r,i=>this.parseYMD(i)),()=>this.parseYMD(r.slice(0,4).join(" ")),()=>this.parseYMD(e.slice(0,4).join(" ")),...u.fuzzyDateParsing.valueOrDefault?[()=>Ke(this.ymPatterns,i=>Ke(r,o=>i.apply(o))),()=>Ke(this.ymPatterns,i=>i.apply(e.join(" "))),()=>Ke(this.yPatterns,i=>Ke(r.slice(1),o=>i.apply(o)))]:[])}},vN=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P_?)\d+)$/i,PN=l(()=>{u.fuzzyDateParsing.addListener(()=>Ia.unset()),u.fuzzyYearParsing.addListener(()=>Ia.unset()),u.usePathsToInferDates.addListener(()=>Ia.unset())}),Ia=l(()=>(PN(),new YP(void 0))),SN=[];function XP(t){return Ia().extractDateFromPath(t)}function Nh(t){return Ia().parseYMD(t)}function ZP(t){return t!=null&&(t instanceof La||t instanceof wt.ExifDate||t instanceof wt.ExifDateTime||t instanceof Date||t instanceof Tr||t instanceof it.DateTime||zm([t.year,t.month,t.day]))}function Lo(t){return f(t,e=>e instanceof Date?e.getFullYear():e.year)}function Fo(t){return f(t,e=>e instanceof Date?e.getMonth()+1:e.month)}function Ao(t){return f(t,e=>e instanceof Date?e.getDate():e.day)}function EN(t){return wr(t)?t instanceof Date?t.getHours():t.hour:void 0}function eE(t){return wr(t)?t instanceof Date?t.getMinutes():t.minute:void 0}function tE(t){return wr(t)?t instanceof Date?t.getSeconds():t.second:void 0}function rE(t){return wr(t)?t instanceof Date?t.getMilliseconds():t.millisecond:void 0}function iE(t){return wr(t)&&(N(eE(t))||N(tE(t))||N(rE(t)))}function DN(t,e=!0){if(t==null)return;if(t===0)return e?"UTC":"";let r=t<0?"-":"+",i=Ze(t/15)*15,o=Math.abs(i),n=Math.floor(o/60),s=Math.floor(Math.abs(o%60));return`${e?"UTC":""}${r}${Hc(n)}:${Hc(s)}`}function Tn(t){return t instanceof wt.ExifDateTime?t.hasZone&&zP(t.tzoffsetMinutes):t instanceof it.DateTime?t.zone!=null&&t.zone.type!=="local":!1}function Bh(t){return t instanceof it.DateTime?f(t.zone,e=>e.name):t instanceof wt.ExifDateTime?t.zone:void 0}function TN(t,e=AN){let r=e.exec(t);if(r==null)return;let i=[...r.slice(1)],[o,n,s,a,m,c]=i.splice(0,6).map(_=>H(_));if(o==null||n==null||s==null||!u.fuzzyDateParsing.valueOrDefault&&(a==null||m==null))return;let p=Z(0,999,Wr(i.shift(),{defaultValue:0})*1e3),d=$P(i),y=DN(d),P=it.DateTime.fromObject({year:o,month:n,day:s,hour:a,minute:m,second:c,millisecond:p,zone:y});return P.isValid?Gi(P,y):void 0}var FN="[-:_ ]?",AN=new RegExp([Io,HP,GP,gN,yN,bN,xN].join(FN)+JP+"?","i");function cN(t){if(t instanceof it.DateTime)return t;if(t instanceof wt.ExifDateTime)return t.toDateTime();if(t instanceof Tr)return t.middle.toDateTime();if(t instanceof Date)return it.DateTime.fromJSDate(t)}function Gi(t,e){if(t==null||!wr(t))return;if(t instanceof it.DateTime)return wt.ExifDateTime.fromDateTime(t);let r=Zr(t);if(r==null)return;let i=T(e)?Tn(t)?Bh(t):void 0:e,o=U(i,s=>LN(r,s));if(e!=null&&o==null)return;let n=f(Lo(t),s=>f(Fo(t),a=>f(Ao(t),m=>f(EN(t),c=>new wt.ExifDateTime(s,a,m,c,M(eE(t),0),M(tE(t),0),rE(t),o,t.rawValue)))));return mr(n)?n:void 0}function oE(t){if(t==null)return;if(typeof t=="number")return new Date(t);if(t instanceof Date)return t;if(t instanceof it.DateTime)return t.toJSDate();if(t.toDate!=null)return t.toDate();if(N(t.year)&&N(t.month)&&N(t.day))return new Date(t.year,M(t.month,1)-1,t.day,12);let e=g(t);if(v(e))return f(IN(e),oE)}function Zr(t){if(!(t==null||ct(t)))return re(t)?t:t instanceof Date?t.getTime():t instanceof it.DateTime?t.toMillis():f(oE(t),e=>e.getTime())}function Ch(t){if(!(t==null||ct(t)))return re(t)?mc(t):t instanceof wt.ExifDateTime||t instanceof it.DateTime?ON(t):t instanceof Date?mc(t.getTime()):f(Zr(t),mc)}function ON(t){return parseInt([t.year,t.month,t.day,t.hour,t.minute,t.second].map(e=>Rt(e)).join("")+"00")+ac(t.millisecond??0)}function nE(t){return f(t,e=>e instanceof wt.ExifDateTime?e.tzoffsetMinutes:e instanceof it.DateTime?e.offset:void 0)}function Vh(t){return f(t,e=>e instanceof it.DateTime||e instanceof wt.ExifDateTime||e instanceof Date?0:e instanceof wt.ExifDate?ot:e instanceof Tr?e.intervalMs:void 0)}function pm(t,e=!0){if(t==null)return;if(t instanceof Tr)return t.toString(e);let r=re(t)?new Date(t):t;return wr(r)?f(Gi(r),i=>i.toISOString({includeOffset:e})):kN(r)}function IN(t,e){return typeof t!="string"||T(t)?void 0:V(wt.ExifDateTime.fromISO(t,e)).orElse(()=>wt.ExifDate.fromISO(t)).orElse(()=>wt.ExifTime.fromEXIF(t)).get()}function kN(t,e="-"){return A([Lo(t),Fo(t),Ao(t)]).map(r=>Hc(r)).join(e)}function kh(t){return f(t,e=>f(Lo(e),r=>new La(r,Fo(e),Ao(e))))}function sE(t,e){return ro(zh(t,e),ot)}function zh(t,e){let[r,i]=[t,e].map(Zr);return r==null||i==null?void 0:r-i}function wr(t){return t instanceof Date||t instanceof wt.ExifDateTime||t instanceof it.DateTime}function LN(t,e){let r=it.Info.normalizeZone(e);return r.isValid?r.offset(t):void 0}function aE(t,e){return t instanceof it.DateTime?t.setZone(e,{keepLocalTime:!0}):Gi(t,e)}var Oo=class{static lift(e){return new class extends Oo{apply(r){return e(r)}}}and(e){return Oo.lift(r=>this.apply(r)&&e.apply(r))}or(e){return Oo.lift(r=>this.apply(r)||e.apply(r))}filter(e){return e.filter(r=>this.apply(r))}asAsync(){return De.lift(e=>Promise.resolve(this.apply(e)))}},Gge=Oo.lift(vi),Kge=Oo.lift(()=>!0);function dm(t){return Oo.lift(e=>ga(e?.ext,t))}var Zge=dm(xt.SupportedByCurrentBrowser),eye=dm(xt.Video),$c=dm(xt.AssetFile);var Ki=l(()=>h("TagInference"));async function lE(t,e){if(v(e.Make)&&v(e.Model))return;if(T(e.Make)&&(g(e.HandlerDescription)+g(e.CompressorName)).includes("GoPro")){e.Make="GoPro";return}let r=bs(t),i=await Uh(t);if(i==null)return;let o=A(Y(Vn(i.younger,i.older))).slice(0,50).filter(n=>Ru(bs(n),r)>.7).slice(0,10);Ki().info("inferMakeAndModel("+t+"): looking at nearby siblings",o.map(n=>n.base));for(let n of o){let s=await Ie(n);if(s!=null&&uu(s.Make,s.Model)){Ki().info("inferMakeAndModel("+t+")",{sibling:n.base,Make:s.Make,Model:s.Model}),e.Make=s.Make,e.Model=s.Model;return}}}async function mE(t){return x(RN(t),({before:e,after:r,index:i,slots:o})=>{if(!sE(e.date,r.date)){Ki().debug("inferCapturedAtFromSiblings(): rejecting, not same day",{file:t.nativePath,before:g(e),after:g(r)});return}return f(Tr.for(e.date,r.date,i,o),n=>({date:n,src:`before:${e.src},after:${r.src}`}))})}async function uE(t,e=7){return fp(F(t).slice(0,e),(r,i)=>x(Ie(r),o=>x(Qc(o),n=>w(w({},n),{index:i}))))}async function _N(t,e=7){return fp(t.slice(0,e),(r,i)=>x(Ie(r),o=>x(Qc(o),n=>V(n).filter(s=>Tn(s.date)).flatMap(s=>Bh(s.date)).map(s=>({zoneName:s,index:i})).get())))}W(()=>j(()=>cE.prior()?.clear()));var cE=l(()=>new _e(1024));function RN(t){return cE().getOrSet(t.nativePath,async()=>{let e=await Uh(t),r=await uE(e?.younger),i=await uE(e?.older);return r==null||i==null?void 0:{before:r,after:i,index:r.index,slots:r.index+i.index+1}})}W(()=>j(()=>fE.prior()?.clear()));var fE=l(()=>new _e(2048,D));function bs(t){let e=ct(t)?t:t.name;return fE().getOrSet(e,()=>(f(/(?:burst)(.{8,})$/i.exec(e),r=>e=r[1]),f(/^(?:(?:dsc[0f]?|img|mov|mvi|mvimg|vid|gpfr|gopro?|gp|gf|p)(?:[-_ ])?)(\S.+)$/i.exec(e),r=>e=r[1]),e.replace(/\s*-?\s*copy( \(?\d+\)?)?\s*$/i,"").replace(/\s*\((another |\d+[a-z]{2} )?copy\)\s*$/i,"").replace(/^[-\s_0]+/,"").replace(/[\s-_][\d\s]{0,2}$/,"").replace(/_cover$/i,"").toLowerCase().normalize()))}var NN=dm(xt.AssetFile);async function Uh(t,e=7){let r=await t.parent().childDirectoryEntries(p=>p.isFile()&&!p.name.startsWith(".")&&!jl(p.ext)&&NN.apply(p));if(r==null){Ki().info("nearestSiblings(): can't readdir parent, "+t.parent());return}let i=await t.statTimes();if(L(i)){Ki().info("nearestSiblings(): statTimes() missing from "+t);return}let o=$(r,p=>bs(p)),n=o.findIndex(p=>p.base===t.base);if(n<0){Ki().warn("nearestSiblings(): can't find self in siblings: "+t);return}let[s,a]=[o.slice(n-e*2,n),o.slice(n+1,n+1+e*2)],m=[],c=[];for(;C(s)&&m.length<e;){let p=ee.forDirectoryEntry(s.pop());await pE(t,p)&&m.push(p)}for(;C(a)&&c.length<e;){let p=ee.forDirectoryEntry(a.shift());await pE(t,p)&&c.push(p)}return{younger:m,older:c}}function pE(t,e,r=2*ot){let i=zh(Nh(t.base),Nh(e.base));return i!=null&&Math.abs(i)>r?!1:t.contemporary(e,r)}async function dE(t){let e=await Uh(t),r=Tb(F(e?.younger),F(e?.older)).slice(0,10);return Ki().tap({msg:"nearestSiblingTzOffset("+t+")",result:await x(_N(r),i=>i.zoneName),meta:{zipped:r}})}async function hE(t){let e=_h(bs(t)),r=f(e,Zr);if(e==null||r==null){Ki().debug("extractStatBname() bname isn't dated",{bname:bs(t),fromName:e,fromNameMs:r});return}let i=await t.stat();if(i==null){Ki().debug("extractStatBname() no stat",{fromName:e,fromNameMs:r});return}return Ki().tap({msg:"extractStatBname()",result:Ke(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],o=>Math.abs(i[o]-r)<Lh?{src:o,date:e}:void 0),meta:{fromName:e,fromNameMs:r,stat:i}})}var BN=l(()=>h("CapturedAt"));function CN(t){return g(t).toLowerCase().startsWith("tags")}var Oa=class{constructor(e,r,i,o,n){this.nativePath=e;this.date=r;this.src=i;this.mtime=o;this.precisionMs=n;this.toISOString=l(()=>pm(this.date))}spread(e){let r=w(w({},this),e);return new Oa(r.nativePath,r.date,r.src,r.mtime)}toLocal(){return Ch(this.date)}toOffset(){return nE(this.date)}get isFromTags(){return CN(this.src)}toPrecisionMs(){return M(this.precisionMs,()=>Vh(this.date))}toString(){return k({nativePath:this.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return Tn(this.date)}hasTime(){return wr(this.date)}};function yE(t){let e=$(t,r=>-r.mtime.getTime());return ui(()=>e.find(r=>r.src.startsWith("tags")),()=>e.find(r=>r.src.startsWith("bname+stat")),()=>e.find(r=>r.src.startsWith("bname")),()=>e.find(r=>r.src.startsWith("siblings")),()=>e.find(r=>r.src.startsWith("path")),()=>t[0])}async function zN(t,e,r,i){let o=await r;if(!!mr(o))return Tn(o)?o:e!=null&&e.tz!=null&&gE.Info.isValidIANAZone(e.tz)?aE(o,e.tz):i?o:VN(t,o)}async function VN(t,e){if(!mr(e))return;if(Tn(e))return e;let r=await dE(t);if(r!=null){let i=Gi(e,r);if(mr(i))return i}return e}function UN(t,e){return t==null||e||!u.usePathsToInferDates.valueOrDefault||!u.useLibraryPathsToInferDates.valueOrDefault&&ia(t.nativePath,u.libraryPath.value)}async function bE(t,e,r){let i=await t.mtime(),o=async(n,s)=>x(s,a=>x(zN(t,e,a.date,r),m=>new Oa(t.nativePath,m,R([n,a.src]).join(":"),i,a.precisionMs)));return Ct(()=>o("tags",Qc(e)),()=>o("bname+stat",hE(t)),()=>r?void 0:o("siblings",mE(t)),()=>r||!u.usePathsToInferDates.valueOrDefault?void 0:o("bname",f(QP(bs(t)),n=>({date:n,src:"",precisionMs:pu([Vh(n),E])}))),()=>UN(t,r)?void 0:o("path",f(XP(t.pathnamesWithoutDrive),n=>({src:"",date:n}))),()=>u.useStatToInferDates.valueOrDefault?o("stat",x(t.minStatDate(),n=>({src:"",date:n}))):void 0)}var xE=["SubSecDateTimeOriginal","SubSecCreateDate","SubSecTimeDigitized","SubSecMediaCreateDate","DateTimeOriginal","OriginalCreateDateTime","CreateDate","DateTimeCreated","DateCreated","DateTimeDigitized","MediaCreateDate","DateTime","SubSecTime","ModifyDate","photoTakenTime"];function wE(t,e){return wn(t[e],r=>({src:e,date:r}))}function Qc(t){if(t==null)return;let e=A(xE.map(i=>({date:t[i],src:i,ts:f(Zr(t[i]),o=>Math.floor(o/1e3))}))),r=e.filter(i=>mr(i.date)&&i.ts!=null);return FT(Vi.debug,()=>{BN().debug("capturedAtFromTags()",{rawArr:e,validArr:r})}),ui(()=>et(r,i=>f(Ch(i.ts),o=>[-Math.floor(o/1e8),wr(i.date)?1:0,iE(i.date)?1:0,Tn(i.date)?1:0,-xE.indexOf(i.src)])),()=>wE(t,"DateTimeUTC"),()=>wE(t,"GPSDateTime"))}var qN=h("ExposureSettings");function TE(t){let e={focalLength:t.FocalLength,iso:wp(t.ISO,t.ISOSpeed,t.SonyISO),aperture:wp(t.FNumber,t.Fnumber,t.ApertureValue,t.SonyFNumber),shutterSpeed:Xf(t.ExposureTime,t.ShutterSpeed,t.SonyExposureTime)};return qN.debug("extracted from "+t.FileName,{exposureSettings:e}),qo(e)}var Yc=30;function qh(t){return Math.floor(t/5)*5}function Wh(t){return re(t)&&t!==0&&ht(-90,90,t)}function jh(t){return re(t)&&t!==0&&ht(-180,180,t)}function WN(t,e){return Wh(t)&&jh(e)}function Hh(t,e,r=Yc){return f(ME(t,e,qh(r)),i=>ua.encode(i))}function Xc(t,e){return ME(t,e,30)}function ME(t,e,r=Yc){return WN(t,e)?Xl({dims:[{min:-180,value:e,max:180},{min:-90,value:t,max:90}],bitDepth:qh(r)}):void 0}function jN(t,e=Yc){return f(Tc(t,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:qh(e)}),r=>r.reverse())}function vE(t,e=Yc){let[r,i]=jN(t,e);return{lat:r,lon:i}}var HN=12742e3;function SE(t,e){if(!(t==null||e==null))return t===e?0:GN(vE(t),vE(e))}function GN(t,e){let r=t.lat*Math.PI/180,i=e.lat*Math.PI/180,o=(e.lat-t.lat)*Math.PI/180,n=(e.lon-t.lon)*Math.PI/180,s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(r)*Math.cos(i)*Math.sin(n/2)*Math.sin(n/2),a=Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return HN*a}function Gh(t){return ks(t?.timestamp,e=>wn(new Date(e*1e3),r=>r))}async function Zc(t){return x(t.readJson("info"),e=>oi({Title:Qf(e.title),Description:Qf(e.description),GPSLatitude:Ke([e?.geoData?.latitude,e?.geoData?.latitude],r=>Wh(r)?r:void 0),GPSLongitude:Ke([e?.geoData?.longitude,e?.geoData?.longitude],r=>jh(r)?r:void 0),GPSAltitude:Ke([e?.geoData?.altitude,e?.geoData?.altitude],r=>re(r)?r:void 0),favorited:e.favorited==null?void 0:B(e.favorited),peopleNames:Ae([...F(e.people),...F(e.person)],r=>R(r.map(i=>i.name))),creationTime:Gh(e.creationTime),modificationTime:Gh(e.modificationTime),photoTakenTime:Gh(e.photoTakenTime),imageViews:ks(e.imageViews,r=>r)}))}function Kh(t,e,r=""){let i=t.replace(e,r);return i===t?t:Kh(i,e,r)}var KN=["BenQ","GoPro","HTC","LG","NEC","OnePlus","Sony","TrueHDR"],JN=new Map(KN.map(t=>[t.toLowerCase(),t]));function $N(t){let e=t.trim(),r=JN.get(e.toLowerCase());return r??(e.length<4?e:e.toLowerCase().replace(/(?:^|\s|-)\S/g,i=>i.toUpperCase()))}var PE=class{constructor(){this.ignorables=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|");this.ignorableSep="[\\s\\.,_-]*";this.IgnorableMakePatterns=new RegExp(`${this.ignorableSep}(?:${this.ignorables})${this.ignorableSep}$`,"i");this.IgnorableModelPatterns=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i];this.samsungPatterns=[[/^PL150 /,"PL150"],[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-G98[01]/,"Galaxy S20"],[/^SM-G98[56]/,"Galaxy S20+"],[/^SM-G988/,"Galaxy S20 Ultra"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]];this.lgPatterns=[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]];this.onePlusPatterns=[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]];this.CommonNamesByMake={Samsung:this.samsungPatterns,LG:this.lgPatterns,OnePlus:this.onePlusPatterns}}},Jh=l(()=>new PE);function hm(t){return U(t,e=>(e=bp(e),e=Kh(e,Jh().IgnorableMakePatterns),e=e.replace(/\s+app on Apple iDevice$/i,""),e=e.replace(/\bLGE\b/,"LG"),e=$N(e),e))}var QN=/<(.+?)[,/].+>/;function EE(t,e){if(T(t)||T(e))return;let r=bp(e);if(t==="Samsung"){let o=QN.exec(r);o!=null&&(r=o[1])}let i=f(Jh().CommonNamesByMake[t],o=>o.find(([n])=>r.match(n)!=null));if(i!=null)return i[1].trim();t==="Sony"&&(r=r.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"\u03B1").replace(/7CL/i,"7c").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V").replace(/M6$/," VI").replace(/M7$/," VII").replace(/M8$/," VIII").replace(/M9$/," IX").replace(/M10$/," X").replace(/M11$/," XI")),t==="Olympus"&&(r=J(/^(.+?\d)mark(i.+?)$/i.exec(r),o=>`${o[1]} Mark ${o[2]}`,()=>r)),t==="Canon"&&(r=r.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel"));for(let o of Jh().IgnorableModelPatterns)r=Kh(r,o).trim();return r=r.replace(new RegExp(`^${rt(t)}\\s+`,"i"),""),t.match(/^HP|Hewlett.Packard$/i)!=null&&r.match(/^hp\b/i)!=null&&(r=r.slice(2).trim()),r}var YN=/\b(n\/a|unknown)\b/i;function XN(t){return t.filter(e=>v(e)&&YN.exec(e)==null)}var DE=l(()=>h("LensMakeModel"));function ef(t){let e=hm(t.LensMake),r=hm(t.Make),i=XN([e,t.LensMake,r,t.Make]),o=a=>(a=FE(a),i.reduce((m,c)=>du(m,c).trim(),a)),n=Ke([t.LensInfo,t.LensSpec,t.LensModel,t.LensID],AE),s=A([t.LensID,t.LensModel,t.LensSpec,t.LensInfo]);DE().debug("extractLensMakeModel",{lensMake:e,lensInfo:n,lensModels:s});for(let a of s){let m=AE(a)!=null;if(DE().debug("extractLensMakeModel",{lensModel:a,hasLengthAndAperture:m}),!!m){if(v(e))return{lensMake:e,lensModel:o(a),lensInfo:n};if(a.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:o(a),lensInfo:n};for(let c of R([e,r,...u.lensMakes.values]))if(a.toLowerCase().includes(c.toLowerCase()))return i.unshift(c),{lensMake:c,lensModel:o(a),lensInfo:n}}}}function AE(t){if(T(t)||g(t).toLowerCase().includes("unknown"))return;let e=ZN(t.replace(/\b(AF-S|DG|Digital|DI|DX|E|ED|HSM|LM|OIS|Pro|R|XF)\b/gi,"")),r=/[\d.-]+mm/.exec(e)?.[0],i=/f\/[\d.-]+/.exec(e)?.[0];if(!(r==="0mm"||i==="f/0"))return In(r,i,(o,n)=>`${o} ${n}`)}function FE(t,e=3){return t.replace(/\d+\.\d+/g,r=>J(Wr(r),i=>String(Be(i,e)),r))}function ZN(t){return FE(t).replace(/(\d) - (\d)/g,(e,r,i)=>`${r}-${i}`).replace(/(\d)\s+mm\b/,(e,r)=>r+"mm").replace(/\s+f\/?(\d)/i,(e,r)=>" f/"+r)}function LE(t){let e=z(["OLYMPUS DIGITAL CAMERA",t.originalMake,t.originalModel,t.Model,t.Make,t.CameraID]).map(i=>U(i,o=>o.trim().toLowerCase().normalize())),r=(...i)=>{for(let o of i){let n=g(t[o]).trim();if(v(n)&&!e.includes(n.toLowerCase().normalize()))return n}};return oi({title:r("XPTitle","Title","ObjectName"),description:r("XPSubject","Description","ImageDescription","Caption-Abstract")})}var Ji=l(()=>h("ExifTags")),eB=!1;function tB(){return u.exiftoolProcsPerChild.value??(Ft()>4?3:2)}var $h=l(()=>new Bl("ExifTool",new IE.ExifTool({logger:()=>h("ExifTool"),maxProcs:tB(),maxIdleMsPerProcess:5*D,maxTasksPerProcess:u.maxTasksPerProcess.valueOrDefault,cleanupChildProcs:!1}),be.service,!0).t);function Sa(){let t=$h();return t.ended?$h.refresh():t}function kE(){return ke(Sa().version(),G,()=>{throw new Error("ExifTool timed out")})}function RE(){return f($h.prior(),t=>t.ended?void 0:ke(t.version(),G,()=>{throw new Error("ExifTool timed out")}))}Gs((t,e)=>x(_E(t),r=>{let i=ee.for(e);return tf.getOrSetAsync(i.nativePath,()=>Promise.resolve(w(w({},r),{SourceFile:i.nativePath,FileName:i.base,Directory:i.dir})))}));function vP(t,e,r){return Sa().extractBinaryTag(t,e,r)}var tf=new _i({maxSize:128,timeoutMs:D}),rf=new _i({maxSize:128,timeoutMs:D});function NE(){tf.clear(),rf.clear()}W(()=>j(NE));Kt(t=>{T(t)?NE():(tf.deleteIf(e=>e.startsWith(t)),rf.deleteIf(e=>e.startsWith(t)))});var BE=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];async function CE(t,e){let r=i=>x(Ie(i,!1),o=>kt(o,...BE));return await Bn(t.clear().sha(),e.clear().sha())||await Bn(r(t),r(e))}async function _r(t){if(t==null)return;let e=ee.for(t);if(!(await e.isEmpty()||await e.isNotReadable()))return mt("tags.readTags",async()=>x(Ie(e),r=>rB(e,r)))}async function _E(t){return tf.get(String(t))}async function VE(t){return x(_r(t),e=>e.capturedAt)}async function So(t){if(T(t))return;let e=ee.for(t);return Ct(()=>x(rf.get(e.nativePath),r=>r.MIMEType),()=>x(_E(e),r=>r.MIMEType),()=>x(tm(e.nativePath),r=>r.mime==="image/tiff"?void 0:r.mime),()=>XT(e.ext)?x(Ie(e,!1),r=>r.MIMEType):void 0)}async function ka(t,e){let r=ee.for(t),i=e==null||T(e.ImageHeight)?await Ie(r):e;if(i==null)return;let o=M(pn(e),()=>pn(i)),n=bn(i.MIMEType)?await Pc(r).catch(a=>{Ji().warn("Failed to read raw info",{file:r.nativePath,err:Se(a)})}):void 0,s=fs(i,o,n);if(s!=null)return s;if($t(i.MIMEType))return x(sm(r,i.MIMEType),a=>ka(a,i))}async function BP(t){await Sa().deleteAllTags(t.nativePath),await t.sibling(t.base+"_original").unlink("trace")}async function Ie(t,e=!0){let r=ee.for(t);if(!!await r.isFile())return mt("tags.readRawTags",async()=>{let i=await zE(r.nativePath);if(i==null||!e)return i;let o=Qs(r.jsonSidecars(),Zc),n=Qs(r.sidecars(),a=>zE(a.nativePath)),s=w({},i);for(let[a,m]of[...await o,...await n]){let c=kt(a,...BE);C(pt(c))?((s.sidecars??(s.sidecars=[])).push(m.base),js(s,c),Ji().debug("readRawTags() sidecar had values",{sidecar:m.base,safeTags:c})):Ji().debug("readRawTags() sidecar was empty",{sidecar:m.base})}return s})}var Qh=new Gt,Yh=new Gt;I||(Qh.resolve(),Yh.resolve());async function zE(t){return rf.getOrSetAsync(t,async()=>{Ji().debug("_readRawTags("+t+") not cached, reading now.");let e=Qh.pending;e?Qh.resolve():await Yh.promise;let r=Wl((0,OE.extname)(t))?[]:void 0,i=await mt("exiftool.read()",()=>ke(la(Sa().read(t,r).catch(o=>{Ji().info("Failed to read "+t,o)})),G));return e&&Yh.resolve(),f(i,o=>(Ji().debug("_readRawTags("+t+") in "+o.elapsedMs+"ms"),f(o.result,n=>{for(let a of nt(n)){let m=n[a];if(typeof m=="string"){let c=fP(m);c!=null&&(n[a]=c)}}let s=R([n.Error,...M(n.errors,[]),n.Warning].map(g));return C(s)&&(n.problems=s),n.exiftoolMs=o.elapsedMs,eB&&(n.instance=pc()),n})))})}async function rB(t,e){if(e==null)return;let r=e.MIMEType,i=t.nativePath;if(T(r)){Ji().debug("No mimetype for "+t);return}let o=t.nativePath.startsWith(u.cacheDir.valueOrDefault)||t.pathnames.includes(".photostructure");o||await lE(t,e);let n=e;n.originalMake=e.Make,n.originalModel=e.Model,e.Make=hm(e.Make),e.Model=EE(e.Make,e.Model);let s=ef(e),a=await bE(t,e,o);if(a==null){Ji().info("No capturedAt for "+t);return}let m=TE(e),c=await ka(t,e);if(c==null){Ji().info("No size info for "+i);return}let p=r.startsWith("video/")?cs(e):void 0,d=w(w(w(w({mimetype:r,exposureSettings:m},LE(n)),s),c),{duration:p,capturedAt:a,tz:e.tz});return Ji().debug("parsedTags",w(w({nativePath:i},d),{capturedAt:f(a,y=>({date:y.date,src:y.src}))})),w(w({},n),d)}function Xr(t){return x(ka(t.nativePath),e=>({width:e.ImageWidth,height:e.ImageHeight}))}var of=require("sharp"),ko=12,Mn=7;var iB=h("ImageHash"),oB=250,Ra=new _e(oB);j(()=>Ra.clear());Kt(t=>v(t)?Ra.delete(t):Ra.clear());Gs((t,e)=>f(Ra.get(t),r=>Ra.getOrSet(e,()=>r)));var xs=8,UE={width:96,height:96};function nB(t){return Hp(BigInt("0b0"+t.map(e=>e===1?1:0).join("")))}function sB(t){let e=[[],[],[]];for(let r=0;r<t.length;r+=3){let i=Zl([t[r],t[r+1],t[r+2]]);e[0].push(i[0]),e[1].push(i[1]),e[2].push(i[2])}return e}function aB(t){let e=u.greyscaleColorThreshold.valueOrDefault;for(let r of t)if(Math.abs(r[1])>e||Math.abs(r[2])>e)return!1;return!0}function qE(t){return 1<2?St(t):St([St(t),vp(t)])}async function lB(t){let e=h("ImageHash("+t+")");try{let i=await ys(t,UE,!0);if(i==null){e.warn("Cannot build readable stream");return}if(await Xr(t)==null){e.warn("Can't extract dimensions");return}let n=of(i.nativePath).removeAlpha();i.isDescendantOf(await lm())&&eo(await i.size(),2*Ge)&&(n=n.trim(4)),n=n.resize(w(w({},UE),{fit:of.fit.fill,kernel:of.kernel.lanczos3,fastShrinkOnLoad:!0,withoutEnlargement:!0}));let{data:s,info:a}=await n.raw().toBuffer({resolveWithObject:!0}),m=Rn(0,s.length,3,K=>Zl([s[K],s[K+1],s[K+2]])),c=aB(m),p=Mp(m.map(K=>vo(K,ko)),Mn);if(!c&&u.includeSharpDominantColor.valueOrDefault){let K=await mt(`img.imageHash.stats ${t.ext.toUpperCase()}`,()=>n.stats()),Q=vo(Zl([K.dominant.r,K.dominant.g,K.dominant.b]),ko);p=z([Q,...p]).slice(0,Mn)}let d=of(s,{raw:w(w({},a),{channels:3})}).resize({width:xs,height:xs}),{data:y}=await d.raw().toBuffer({resolveWithObject:!0}),P=sB(y),_=c?[qE(P[0]),0,0]:ce(3,K=>qE(P[K])),Xe=(c?[P[0]]:P).map((K,Q)=>{let jt=_[Q];return K.map(vr=>vr>=jt?1:0)});if(c){let K=ce(xs*xs,()=>0);Xe.push(K,K)}return{meanHash:nB(Y(Xe)),isGreyscale:c,modes:p}}catch(r){e.warn("Failed to imageHash("+t.nativePath+")",r);return}}async function gm(t){return Ra.getOrSet(t.nativePath,()=>Jr(()=>mt(`img.imageHash${t.ext.toUpperCase()}`,()=>lB(t))).then(({elapsedMs:e,result:r})=>iB.tap({level:pa(e,4*E),msg:"imageHash()",result:r,meta:{file:t.nativePath,elapsedMs:e}})))}var nf=h("ImageHashComparison");function sf(t){return f(t,e=>Be(e,2))}var mB=2.3,uB=20;function WE(t,e){return nf.tap({msg:"weightedAvgCorr",result:$e(t,e)?1:Sp(t.map((r,i)=>{let o=Sv(e,r);if(o==null)return 0;let n=e.indexOf(o),s=Math.abs(i-n)*u.modeCorrIndexDiffWeight.valueOrDefault,a=Math.round(em(r,o))*u.modeCorrCieDiffWeight.valueOrDefault,m=1-(a+s-mB)/uB;return Z(0,1,m)}),[5,4,3,2,1]),meta:{a:t,b:e}})}function cB(t,e){return St([WE(t,e),WE(e,t)])}function jE(t,e){let r=t.map(o=>o[0]),i=e.map(o=>o[0]);return $e(r,i)?1:Sp(r.map((o,n)=>{let s=fu(i,c=>Math.abs(c-o));if(s==null)return 0;let a=Math.abs(n-s),m=Math.abs(o-i[s])*.66+a*2;return Z(0,1,1-(m-3)/20)}),[4,3,2,1])}function fB(t,e){return St([jE(t,e),jE(e,t)])}function HE(t){return A(A(t?.modes).map(e=>va(e,ko)))}var pB=/A{20}=?$/;function GE(t){return t?.match(pB)!=null}var dB=[0,90,180,270];function KE(t,e,r=xs){let i=e?1:3,o=r*r*i,s=rr(rw(t).toString(2).slice(0,o),o,"0").split("").map(d=>parseInt(d,2));if(e)return s;let[a,m,c]=ce(3,d=>s.slice(d*r*r,(d+1)*r*r));return a.map((d,y)=>d*4+m[y]*2+c[y])}function hB(t,e,r,i=xs){if(T(t)||T(e))return{hammRatio:0,aRotation:0};if(t===e)return{hammRatio:1,aRotation:0};let o=KE(t,r,i),n=KE(e,r,i).map(m=>rr(m.toString(2),r?1:3,"0")).join(""),s=dB.map(m=>({aRotation:m,hammRatio:Wb(xv(o,m).map(c=>rr(c.toString(2),r?1:3,"0")).join(""),n)})),a=et(s,m=>m.hammRatio);return{aRotation:a.aRotation,hammRatio:sf(a.hammRatio)}}function af(t,e){if(t==null||e==null)return;let r=GE(t.meanHash)||GE(e.meanHash);r&&nf.debug("imageHashCompare(): greyscale comparison mode.");let i=HE(t),o=HE(e),n=hB(t.meanHash,e.meanHash,r),s=r?fB(i,o):cB(i,o),a=St([n.hammRatio,n.hammRatio,s]),m={imageCorr:sf(n.hammRatio),aRotation:n.aRotation,colorCorr:sf(s),meanCorr:sf(a),greyscale:r,a:t,b:e};return nf.debug("imageHashCompare()",m),qo(m)}function Xh(t){return Be(Z(0,1,t),3)}function JE(t,e=1){if(t==null)return!1;let r=Xh(e*(t.greyscale?u.minImageGreyscaleCoeffPct.valueOrDefault:u.minImageCoeffPct.valueOrDefault)/100),i=Xh(e*u.minColorCoeffPct.valueOrDefault/100),o=Xh(e*u.minMeanCoeffPct.valueOrDefault/100),n=qr(t.imageCorr,r),s=qr(t.colorCorr,i),a=!t.greyscale&&qr(t.meanCorr,o);return nf.tap({msg:"isSimilarComparison",result:n&&s||a,meta:w({goodImageCorr:n,minImageCorr:r,goodColorCorr:s,minColorCorr:i},t)})}var $E=S(require("@iarna/toml"));var lf=h("SettingsIO"),QE="settings.toml";function mf(){return ee.for(Ni()).join(QE)}function uf(t){return Ke([t,u.libraryPath.value],e=>U(e,r=>f(zt(r),i=>i.join(QE))))}async function yB(){B(u.scanMyPictures.value)&&(u.scanMyPictures.value=!1,u.scanPaths.push(await yT()))}async function cf(t=mf()){let e=await Re(YE(t),()=>[]);return await yB(),Ro.unset(),e}var Ro=l(()=>bB(),yr);W(()=>{j(()=>Ro.unset()),u.libraryPath.addListener(()=>Ro.unset())});function bB(t){let e=uf(t);return lf.tap({msg:"_libraryHasSettings",result:M(e?.clear().existsSync(),!1),level:"info",meta:{libraryPath:t,settings:u.libraryPath.value,librarySettingsFile:e?.nativePath}})}var XE={maxLineLen:78,prefix:"# "};async function wB(t,e){let r=await t.clear().isNonEmpty(),i=r?await t.wip():t;await xB(i,e,t),lf.info("maybeWriteFile(): wrote settings",{dest:i,file:t,nonDefaults:e.filter(o=>o.hasValue()).map(o=>({name:o.name,value:o.value}))}),r&&(await gt(Bn(ff(i),ff(t)))&&(lf.info("Archiving prior, different contents",{dest:i,file:t}),await t.renameYMDHMS_("old")),await i.unwip_())}var TB=l(()=>Lt);async function xB(t,e,r){let i=M(await ff(r),{}),o=Y(["","Hello!","",`These are ${e[0].categoryType} settings for PhotoStructure.`,""," - Please shut down PhotoStructure before editing this file.",""," - PhotoStructure has TWO settings files!",""," - Most settings have reasonable defaults, which are provided after the",'   description. Remove the "#" from the beginning of the line to override',"   the default.",""," - See <https://photostructure.com/getting-started/advanced-settings/>","   for more details","","Thanks for using PhotoStructure! Visit <https://photostructure.com/support> or email <support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+TB()].map(s=>no(s,XE)));o.push("","");let n="";e.forEach(s=>{let a=`${Ho(s.categoryType)}.${s.category.toLowerCase()}`;a!==n&&(n=a,o.push("",zn("#",78),"#","# Settings for "+a+":","#","",""));let m="# +"+zn("-",s.name.length+4)+"+",c=ze(w(w({env:s.key},Ae(s.opts.envAliases,P=>({"env aliases":P}))),s.addToJSON())).map(([P,_])=>`${P}: ${k(_)}`).join(", ");o.push(...no([m,"|  "+s.name+"  |",m,"",`${s.opts.description.replace(/\n/g,`

`)}`,`(${c})`,""].join(`
`),XE));let p=i[s.name],d={},y=s.valueToPersist(p);y!=null?(d[s.name]=y,o.push(...ZE(d))):(d[s.name]=s.exampleValue,o.push(...ZE(d).map(P=>"# "+P))),o.push("","")}),await t.writeTxt_(`
`+o.map(s=>s.trimRight()).join(`
`)+`

`),nx()}function ZE(t){return yo(...ze(t).map(([e,r])=>e+" = "+k(r,void 0,2)))}async function eD(t=mf()){return wB(t,PT())}async function pf(t){return f(uf(t),e=>YE(e))}async function ff(t){return x(t.readFile(),e=>lf.tap({msg:`read(${t})`,result:$E.default.parse(yp(e.toString()))}))}async function YE(t){let e=h("SettingsIO.importFileSettings("+t.nativePath+")");try{let r=await ff(t);if(r==null){if(await t.isNonEmpty())throw new Error("Failed to read "+t);return[]}let i=new Map(ze(u).filter(([,n])=>n instanceof Ir&&!n.transient).map(([n,s])=>[n.toLowerCase(),s])),o=A(ze(r).map(([n,s])=>{let a=i.get(g(n).toLowerCase());return a==null?e.warn("Failed to import (no setting with this name)",{key:n}):a.importFromFile(s),a}));return e.info("loaded",{tomlMap:r,imported:o.map(n=>at(n,"name","value","persist"))}),o}catch(r){e.error("Cannot read"+ci(r));return}}var nTe=l(()=>new Set([u.logLevel,u.httpPort,u.rpcPort,u.license].map(t=>t.key)));function tD(t){return t!=null&&C(t.warn)||MB(t)}function MB(t){return t!=null&&C(t.bad)||vB(t)}function vB(t){return t!=null&&C(t.fail)}function rD(t){return{ok:F(t.ok),warn:F(t.warn),bad:F(t.bad),fail:F(t.fail)}}function df(...t){t=A(t);function e(r){return z(A(Y(t.map(r))))}return{ok:e(r=>r.ok),warn:e(r=>r.warn),bad:e(r=>r.bad),fail:e(r=>r.fail)}}var Zh=S(require("process"));function iD(){let t=(0,Zh.memoryUsage)();return Ko([t.external,t.heapUsed,t.arrayBuffers])}function oD(){return(0,Zh.memoryUsage)().rss}var SB=!1;function eg(){return SB}var Lm=S(require("process"));function _o(t){let e=t;return e==null?void 0:N(e)?e:On(e.id,-20)?e.id:N(e.assetId)?e.assetId:Wm(e.tagId)?e.tagId:void 0}function nD(t,e){return Mi(_o(t),_o(e),(r,i)=>r===i,()=>!1)}var hD=S(require("util"));var tg=l(()=>h("AssetFileSorter")),PB=[Qr,"file",Mo,zi];function EB(t){return f(t,e=>zo(e.width,e.height,(r,i)=>sD(r*i)))}function sD(t){return Math.round(Math.pow(t,u.variantSortCriteriaPower.valueOrDefault))}function DB(t){return Math.round(t/(2*D))}async function aD(t){return qo(w({uri:await t.uri(),mtime:await t.thisOrSidecareMaxMtimeMs(),fileSize:await t.size(),sha:await t.sha()},await Xr(t)))}function lD(t){for(let i of z(t.map(o=>o.sha))){let o=t.filter(s=>s.sha===i),n=Math.max(...A(o.map(s=>s.mtime)));o.forEach(s=>s.mtime=n)}let e=A(t.map(i=>f(rg(i),o=>f(AB(o),n=>({f:i,crit:n,pojo:o}))))),r=$(e,({crit:i})=>i);return Ae(r,i=>i.map(o=>o.f))}function rg(t){let e=EB(t),r=Le.parse(t.uri);if(T(r.scheme)||T(r.path)||t.mtime==null){tg().debug("assetFileSortCriteriaPojo(): skipping",{af:t,parsedURI:r});return}let i=PB.indexOf(r.scheme);if(i===-1){tg().debug("assetFileSortCriteriaPojo(): skipping",{af:t,schemeIdx:i,parsedURI:r});return}let o=Fx(r.path),n=o.base.toLowerCase().includes("cover"),s=ZT(o.ext),a=M(Ox(o.name),0),m=DB(t.mtime),c=Si(t.fileSize,sD),p={resolution:e,mtime:m,schemeIdx:i,fileSize:c,isCover:n,count:a,isBrowserSupported:s},d={};for(let y of u.variantSortCriteria.values)f(p[y],P=>d[y]=P);return d.uri=t.uri,d}function AB(t){let e=pt(t);if(e.some(r=>r==null)){tg().debug("pojoToCriteria(): skipping",{pojo:t});return}else return e}function mD(t,e,r){let o=We.fit().map(a=>[a.outputSize(t),a]).filter(([a])=>a!=null),n=t;function s(a,m){let c=xr(n)/xr(a),d=m===0&&(r!=="image/jpeg"||N(e))||c>3||xr(a)-xr(n)>2.5;return d&&(n=a),d}return o.filter(([a],m)=>s(a,m))}function uD(t){return t==="qhd"?"wvga":t==="uhd"?"uhd4k":t}function cD(t,e){return Gm(R(t).map(uD),R(e).map(uD))}var fD=S(require("sharp"));var FB=l(()=>h("Sharp"));async function pD(t){try{let{data:e,info:r}=await t.raw().toBuffer({resolveWithObject:!0});return LB(e,r)}catch(e){return FB().info("Failed to buffer-clone sharp",e),t.clone()}}function LB(t,e){return(0,fD.default)(t,{raw:e})}var eMe=require("sharp"),IB=l(async()=>{let t=ee.for(Lr.ICC()),e={};for(let r of u.iccProfileMappings.valueOrDefault){let[i,o]=r.split(":"),n=t.join(o);await n.isNonEmptyFile()?e[i]=n.nativePath:h("SharpColorspace").warn(" iccProfileMappings has an invalid ICC profile filename: "+o)}return Object.freeze(e)});async function dD(t,e){let o=(await Ie(t,!1))?.ProfileDescription;if(!T(o)){let n=await IB();for(let s of nt(n))if(o.includes(s))return e.withMetadata({icc:n[s]})}return e.toColorspace("srgb")}var OB=require("sharp"),ig=class{constructor(e,r){this.ap=e;this.assetFiles=r;this.badShas=new ts(2*D);this.logger=h("AssetPreviewBuilder("+e.assetId+")")}[hD.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build_(e){return mt("img.AssetPreviewBuilder.build()",async()=>{let r=A(await lD(await this.assetFiles));for(this.logger.info("build_(): asset file candidates:",r.map(i=>i.uri).reverse());C(r);){let i=r.pop(),o=await ee.forUri(i.uri);if(o==null)continue;let n=await o.sha();if(!(n==null||this.badShas.has(n)))try{return await this._build(o,i,e)}catch(s){this.badShas.add(n),this.logger.warn("Failed to set shown file to "+i,Se(s))}}return this.logger.throw("none of the files are valid",{ignorable:!0,retriable:!1})})}async _build(e,r,i){this.logger.info("_build("+e+")",{uri:r.uri}),B(i.validate)&&await jc(e);let o=await e.size(),n=await e.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:o,mtime:n,best:r}),o==null||n==null)return this.logger.throw("build(): missing stat info for best file",{ignorable:!0,best:r});if(r.width==null||r.height==null||r.mimetype==null||r.sha==null)return this.logger.throw("IE build(): missing fields for best file "+e,{ignorable:!0,best:r});let s=mD(r,r.rotation,r.mimetype),a=w(w({assetFileId:r.id},at(r,"assetId","uri","width","height","mimetype","sha","rotation")),{path:e.nativePath,mtime:n,filesize:o,fitSizes:s.map(([,K])=>K.name).join(",")});if(i.force!==!0&&!u.forceSync.valueOrDefault){let K=await this.ap.readInfo.refresh();if(K!=null){if(K.assetId!==a.assetId)throw new Error("IE build(): Mismatched asset IDs for "+r+": "+k({priorInfo:K,info:a}));let Q=K.fitSizes.split(","),jt=a.fitSizes.split(",");if(K.sha!=null&&K.sha===a.sha&&K.rotation===a.rotation&&cD(Q,jt)){let vr=$m(Q,jt);if(C(vr)){this.logger.info("build(): removing previews that aren't required anymore.",{leftovers:vr});for(let fr of vr){let Ti=s.find(([,Ln])=>Ln.name===fr);if(Ti==null)this.logger.warn("build(): Failed to clean up: missing fit size",{fitsize:Ti,fits:s});else{let Ln=this.ap.fileForWidth(Ti[1].reducer.name,Ti[0].width);this.logger.debug("build(): unlinking unwanted preview "+Ln,{fitsize:Ti}),await Ln.unlink("warn")}}}return this.logger.debug("build(): SHA and rotation match, and previews exist.",{info:a,priorInfo:K}),await this.ap.writeInfo(a),a}}}let m=new on({path:e.nativePath,op:"Building previews for"},We.sq().length+We.fit().length);if(this.logger.debug("Rebuilding all previews from "+r.uri,{assetId:r.assetId,best:r,info:a}),await this.ap.parent.mkdirp()==null)throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+r);let c=await this.ap.existingFiles(),p=await ys(e,We.largestFit().max);if(p==null)throw new ue({message:"AssetPreviewBuilder.build(): "+r.uri+", "+e.nativePath+", is not readable by sharp.",retriable:!1});let d=await dD(e,OB(p.nativePath));r.mimetype.startsWith("image/")&&!hs(r.mimetype)&&r.rotation!=null&&r.rotation!==0&&(d.rotate(r.rotation),this.logger.debug("build(): rotating "+r.rotation+"\xB0")),p.name.toLowerCase().includes("thumbnail")&&dt(()=>d.trim(1));let y=[],P,_,ie=We.largestSq(),Xe=co(s,([K,Q])=>f(ie.outputSize(K),()=>Q.megapixels()))?.[1].name,Ee=at(r,"width","height");{let K=d.clone(),Q=Ee;for(let[jt,vr]of s){let fr=Date.now(),Ti=Q,Ln=this.ap.fileForWidth(vr.reducer.name,jt.width).wip();K=vr.resize(jt,K),Q=jt,vr.name===Xe&&(_=K.clone(),P=jt),await vr.toJpeg({path:Ln.nativePath,sh:K,outputSize:jt}),m.onProgress(),this.logger.debug("resize("+vr.name+") "+kr(Ti)+" -> "+kr(jt)+" in "+(Date.now()-fr)+" ms"),y.push(Ln)}}{_==null?(this.logger.debug("square resize(): resorting to ",{origDim:Ee,bestFitNameForSq:Xe}),_=d,P=Ee):this.logger.debug("square resize(): using to ",{sqDim:P,bestFitNameForSq:Xe});let K=!1;for(let Q of We.sq()){let jt=Date.now(),vr=P,fr=Q.outputSize(M(P,Ee));if(fr==null){this.logger.debug("skipping square output for "+Q.max);continue}K||(fr.position=u.squareThumbStrategy.valueOrDefault,K=!0),this.logger.debug("Applying ",{outputSize:fr});let Ti=this.ap.fileForWidth(Q.reducer.name,fr.width).wip();Q.resize(fr,_),fr.position!=null&&(this.logger.debug("Cloning square crop to make position consistent",{outputSize:fr}),_=await pD(_)),P=fr,await Q.toJpeg({path:Ti.nativePath,sh:_,outputSize:fr}),m.onProgress(),y.push(Ti),this.logger.debug("resize("+Q.name+") "+kr(vr)+" -> "+kr(fr)+" in "+(Date.now()-jt)+" ms")}}try{await Promise.all(c.map(K=>K.unlink())),await Promise.all(y.map(K=>K.unwip_())),await this.ap.writeInfo(a),this.logger.debug("Previews unwipped and info written",{info:a})}catch(K){throw await le(y,Q=>Q.unlink()),new ue({cause:K,fatal:!1,message:"Failed to create previews from "+e})}return a}};var hf=class{constructor(e,r=""){this.query="";if(this.query=r,this.assetId=_o(e),this.assetId==null)throw new Error("internal error: null asset id "+k({id:e}))}static onNewPage(){this.pageImageCount=0}get unset(){return this.assetId==null||this.assetId<=0}assetUrl(){return this.unset?"":`/asset/${this.assetId}${this.query}`}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,r){return`/img/${this.assetId}/${e}/${r}${this.query}`}imgActualLink(e){return`/img/${A([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e,r="m"){return w(w({},this.imgAttrs("sq",lb,e)),{sizes:r==="s"?"80px":r==="m"?"160px":"320px"})}imgAttrs(e,r,i,o){if(this.unset)return{src:"/images/clear-64.png"};let n=Math.min(...r),s={width:g(n)},a=this.imgLink(e,n);hf.pageImageCount++,i=M(i,()=>hf.pageImageCount>72),i?(s.src="/images/clear-64.png",s["data-src"]=a):s.src=a,e===qt.sq&&(s.height=g(n));let m=r.map(c=>gD(this.imgLink(e,c),c));return f(o,c=>m.push(gD(this.imgActualLink(),c.width))),s[(i?"data-":"")+"srcSet"]=m.join(","),s}},vn=hf;vn.pageImageCount=0;function gD(t,e){return t+" "+e+"w"}var kB=h("extractPreviewInfo");function ym(t,e){let r=e.posixPathFrom(t).replace(/\//g,"").split("-"),i=H(r[0]),o=r[1],n=qt.validOrElse(o,void 0),s=gu(r[2]);if(N(i))return{file:e,assetId:i,reducer:n,width:s};kB.warn("Failed to extract preview info",{file:e,previewsRoot:t,arr:r,assetId:i,reducer:n,width:s})}async function yD(t,e){return In(e.assetId,e.width,(r,i)=>x(Xr(e.file),o=>{let n=Nv(o),s=ir(t,Lx(t));return{size:n,basename:`${s}-${n}${e.file.ext}`,title:og(e.file,n,"image",o),description:`Download ${n}`,details:`(${kr(o)} ${e.file.ext})`,href:new vn(r).imgLink(qt.fit,i)}}))}function og(t,e,r,i){return`Download ${e} ${t.ext} ${r} (${kr(i)})`}var bve=new ma,ng=class{constructor(e,r,i){this.previewsRoot=e;this.alp=i;this.readInfo=l(()=>this.infoJson().readJson("debug"));this.logger=h("AssetPreviews(assetId:"+_o(r)+")"),this.assetId=_o(r),this.urls=new vn(r);let o=rr(this.assetId,8,"0"),n=jo(o,3);this.basename=n.pop()+"-",this.parent=e.join(...n)}existingFiles(){return Re(this.parent.childFiles(e=>e.base.startsWith(this.basename)),()=>[])}existingJpgs(){return Re(this.parent.childFiles(e=>e.base.startsWith(this.basename)&&e.ext===".jpg"),()=>[])}async previews(){let e=await this.existingFiles();return bl(A(e.map(r=>ym(this.previewsRoot,r))),r=>r?.file.size())}async deleteAll(){this.parent.clear();let e=await this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return await Promise.all(e.map(r=>r.unlink())),e}file(e){return this.parent.join(this.basename+e)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(e){return this.readInfo.unset(),this.infoJson().writeJsonMaybe(e,{spaces:2})}fileForWidth(e,r){return this.file(e+"-w"+r+".jpg")}filesForReducer(e){let r=this.basename+e+"-";return this.existingFiles().then(i=>i.filter(o=>o.base.startsWith(r)))}async smallestFileForReducer(e){return co(await this.filesForReducer(e),r=>M(f(ym(this.previewsRoot,r),i=>i.width),0))}async largestFileForReducer(e){return et(await this.filesForReducer(e),r=>M(f(ym(this.previewsRoot,r),i=>i.width),0))}async widths(e){let r=await this.filesForReducer(e);return tr(A(r.map(i=>f(ym(this.previewsRoot,i),o=>o.width))))}async posterLink(){let e=await this.widths(qt.fit);return this.urls.imgLink(qt.fit,Math.max(...e))}async imgAttrs(e,r=!1,i=!0){if(!r&&e===qt.sq)return this.urls.sqImgAttrs(i);{let o=e===qt.fit?await this.readInfo():void 0;return this.urls.imgAttrs(e,await this.widths(e),i,o)}}};var sg=class{constructor(e,r){this.root=e;this.alp=r;this.id2ap=new _e(512)}async build_(e){return this.apb(e.assetId,e.assetFiles).build_(e)}apb(e,r){return new ig(this.ap(e),r)}ap(e){let r=g(_o(e)),i=this.id2ap.get(r);if(i!=null&&nD(e,i.assetId))return i;{let o=new ng(this.root,e,this.alp);return re(e)||this.id2ap.set(r,o),o}}clearAssetId(e){this.id2ap.delete(g(e))}};var RB=l(()=>h("Broadcaster")),ag;(function(e){e.broadcast=async(r,i)=>(RB().warn("broadcast sent to no-op",{event:r,args:i}),!1)})(ag||(ag={}));var lg=ag;var gf=lg;function bD(t){gf=t}function xD(t){gf===lg&&(gf=t)}function mg(t,e){gf.broadcast(t,e)}var SD=S(require("net"));var vD=S(require("process"));var wD=S(require("os")),TD=S(require("process"));var _B=0,NB=l(()=>gi((0,wD.hostname)()+String.fromCharCode(31)+TD.pid)+"-");function yf(){return NB()+ua.encode(++_B)}var MD=S(require("util"));var ug=class{constructor(e,r,i,o){this.id=e;this.method=r;this.params=i;this.timer=o;this.start=Date.now();this.name="rpc.RequestResponse("+r+")#"+e,this.d=new gr(this.name)}[MD.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),f(this.d.settledMs,r=>this.timer.push(this.method,r)))}reject(e){return this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}};var BB=(Te?7:30)*E,CB=Te?500:5*E,VB={requestTTL:BB,retriesPerRequest:5,delayBetweenRetries:CB,maxPendingRequests:10},zB=0,cg=class extends Pt{constructor(e,r,i={}){super("rpc.Client("+e+"#"+zB+++")",()=>this.onEnd(),be.first);this.streamFactory=r;this.mkStreamRate=new Yo(D);this.pending=new Map;this.times=new ma;this.changeListeners=[()=>this.mkStreamRate.onEvent()];this.stream=l(async()=>{try{if(this.flapping)return this.onError("stream() is restarting too frequently (epm: "+this.mkStreamRate.eventsPerMinute+")");let e=await this.streamFactory();return e==null?this.onError("streamFactory() returned null"):(this.changeListeners.forEach(r=>r()),e.on("end",r=>this.onFinish("on(end)",r)),e.on("close",r=>this.onFinish("on(close)",r)),e.on("error",r=>this.onError("stream error",r)),nn(e,`
`,r=>this.onData(r)),e)}catch(e){return this.onError("streamFactory rejection",e)}});this.ping=l(()=>this.request("ping",{serviceName:Dr(),pid:vD.pid}),250);this.opts=w(w({},VB),i),this.stream()}onEnd(){return this.logger.info("end()",{ending:me(),timings:this.times.report(),pendingSize:this.pending.size}),this.pending.clear(),this.close()}addChangeListener(e){this.changeListeners.push(e)}get flapping(){return this.logger.tap({level:Te?"debug":"trace",msg:"flapping()",result:this.mkStreamRate.msSinceLastEvent<this.opts.delayBetweenRetries||On(this.mkStreamRate.eventsPerMinute,3),meta:{msSinceLastStream:this.mkStreamRate.msSinceLastEvent,mkStreamRatePerMin:this.mkStreamRate.eventsPerMinute}})}broadcast(e,r){return this.request("broadcast",{event:e,args:r})}sendRecentLogs(){return this.request("sendRecentLogs")}async ready(){return this.ended?(this.logger.debug("ready(): false (ended)"),!1):await this.stream()!=null}async request(e,r){if(this.ended){if(me())return;throw new Error("client is ending")}if(T(e))throw new Error("method cannot be blank");return this.submit(e,r)}async submit(e,r){let i=await this.stream();if(i==null)return this.onError("submit("+e+"): stream is closed");let o=yf(),n=new ug(o,e,r,this.times);return n.setTimeout(this.opts.requestTTL),this.pending.set(o,n),n.d.finally(()=>this.pending.delete(o)),this.logger.log(Te?"debug":"trace","sending request",{id:o,method:e,params:r}),i.write(k({id:o,method:e,params:r})+`
`),n.response}close(){return this.logger.info("close()",{ended:this.ended}),x(this.stream.clear(),ki)}onData(e){if(!T(e))try{this.logger.log(Te?"debug":"trace","onData()",{req:e});let r=JSON.parse(e);if(T(r.sid))throw new Error("response is missing server id");if(this.sid!==r.sid&&(this.sid!=null&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:r.sid}),Ue.emit("rpcServerChange")),this.sid=r.sid,me()))return;if(r.id==null)if(v(r.event)){this.logger.trace("re-broadcasting event",r),Ue.emit(r.event,r.args);return}else throw new Error("missing request id from response");let i=this.pending.get(r.id);this.pending.delete(r.id),i==null?this.logger.warn("unknown or stale request ID",{resp:r,pendingIds:[...this.pending.keys()]}):r.error!=null?(i.reject(r.error),this.logger.warn("Rejected",{resp:r,rr:i})):(i.resolve(r.result),this.logger.debug("Resolved",r.result))}catch(r){this.logger.warn("invalid input: "+e,r)}}async onError(e,r){return this.logger.warn(e+" onError(): "+f(r,i=>M(i.stack,i))),this.restart()}async restart(){if(this.logger.info("restart()",{ended:this.ended,flapping:this.flapping}),await this.close(),this.ended||me()){this.logger.warn("restart(): Ending. Rejecting new connection.");return}if(this.flapping){this.logger.warn("restart(): Too many recent errors, we'll try reconnecting again in a bit",{errPerMin:this.mkStreamRate.eventsPerMinute});return}let e=await this.stream();if(e!=null){let r=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+r.length+" jobs now."),r.forEach(i=>i.reject("restarting"+Js)),e}else{this.logger.warn("restart(): stream() returned null");return}}onFinish(e,r){if(this.ended)return;let i=r==null||r===!1;return this.logger.info("onFinish",{source:e,error:r,restarting:i}),i?this.restart():this.onError(e,r)}};var fg=h("RpcClient");function UB(t){let e=new Gt,r=new SD.default.Socket;return r.on("error",i=>e.reject(i)),r.connect(t,"localhost",()=>{fg.debug("Connected to "+t),e.resolve()}),e.then(()=>r)}var Sn=l(()=>{if(Wo())return;let t=u.rpcPort.valueOrDefault;fg.debug("Creating new RPC client to "+t);let e=new cg("db@localhost:"+t,()=>UB(t));return e.addChangeListener(()=>_a.unset()),e}),_a=l(async()=>{try{if(Wo())return!1;let t=await ke(f(Sn(),e=>e.ping()),E);return v(t)}catch(t){return fg.warn("rpcClientReady(): ping failed",t),!1}},D);var PD=S(require("process"));var qB=require("net"),Nr=h("rpc.Server"),WB=({params:t,conn:e})=>(U(t.serviceName,r=>{T(e.serviceName)&&(e.serviceName=r)}),ge(t.pid,r=>{T(e.pid)&&(e.pid=r)}),`pong to ${e.serviceName}@${e.pid} from ${Dr()}@${PD.pid} at ${new Date}`),ED=class{constructor(e){this.socket=e}toString(){return T(this.serviceName)?ta(this.socket):`${this.serviceName}:${this.pid}`}},pg=class{constructor(e,r=!0){this.port=e;this.unref=r;this._ended=!1;this._ready=new Gt;this.connections=[];this.onPause=()=>this.broadcast("pause");this.onResume=()=>this.broadcast("resume");this.handlers=new Map;this.sid=l(()=>en.randomChars(12));this.start=Ll(async()=>{if(!this.ended)return Nr.debug("start("+this.port+")"),this.server=qB.createServer(this.onConnect.bind(this)),this.server.on("listening",()=>{Nr.info("listening on "+this.port),this._ready.resolve()}),this.server.on("error",async e=>{Nr.warn("error, rejecting ready"),this._ready.reject(),await this.onError("createServer"+ye,e)}),this.server.listen(this.port,u.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise},5e3);this.end=l(async()=>{this._ended=!0,Ue.removeListener("pause",this.onPause),Ue.removeListener("resume",this.onResume),await this.closeAllConnections(),await Px(this.server)});this.name="Server:"+e,this.addHandler("ping",WB),this.addSimpleHandler("broadcast",i=>(Ue.emit(i.event,i.args),this.broadcast(i.event,i.args))),ex(this.onPause),tx(this.onResume),zT(this),bD(this)}get connectionCount(){return this.connections.length}async serialize(e){return k(w({sid:this.sid()},e))+`
`}addHandler(e,r){let i=this.handlers.get(e);i!=null&&Nr.warn("addHandler(): overwriting",{method:e,prior:i,newHandler:r}),this.handlers.set(e,r)}addSimpleHandler(e,r){this.addHandler(e,({params:i})=>r(i))}addSimpleHandlers(e){ze(e).forEach(([r,i])=>this.addSimpleHandler(r,i))}get ended(){return this._ended||me()}get ready(){return this._ready.promise}closeAllConnections(){let e=this.connections.map(r=>ki(r.socket));return this.connections.length=0,Promise.all(e)}broadcast(e,r){return this.sendAll({event:e,args:r})}async sendAll(e,r="write"){let i=await this.serialize(e),o=[...this.connections],n=o.length;Nr.debug("sendAll()",{pojo:e,method:r});for(let s of o)try{s.socket.writableEnded?n--:s.socket[r](i,()=>n--)}catch{n--}return yt(()=>n<=0,{timeoutMs:E})}onConnect(e){Nr.info("Connection from "+ta(e)),this.unref&&e.unref();let r=new ED(e);this.connections.push(r),e.on("end",()=>{Nr.info("Closing connection from "+ta(e)),ft(this.connections,i=>i.socket!==e)}),e.on("error",async i=>{Nr.warn("on error from "+ta(e)+": "+i),await this.onError("socket",i),e.end()});try{nn(e,`
`,i=>this.onRequest(i,r))}catch(i){Nr.warn("Caught error from "+ta(e)+": "+i),e.end()}}async onRequest(e,r){if(Nr.debug("onRequest()",e),T(e))return;let i="missing",o="missing";try{let n=JSON.parse(e);return U(n.id,s=>i=s),U(n.method,s=>o=s),await mt("rpc."+o,()=>this.handle(i,o,n.params,r))}catch(n){Nr.warn("invalid request",{line:e,error:n}),r.socket.write(await this.serialize({id:i,error:M(n.message,()=>g(n))}))}}async handle(e,r,i,o){let n=this.handlers.get(r);if(n==null)throw Nr.warn("bad handler request",{method:r,params:i,supported:nt(this.handlers)}),new Error("No handler for "+r);let{elapsedMs:s,result:a}=await Jr(()=>n({id:e,method:r,params:i,conn:o}));Nr.log(pa(s,E),"handle()",{method:r,conn:g(o),elapsedMs:s,id:e,params:i,result:a}),o.socket.write(await this.serialize({id:e,result:a}))}async onError(e,r){this.ended||se(e,r)}};var DD=S(require("fs-extra")),bf=S(require("os")),dg=S(require("process"));var jB=l(async()=>{if(u.forceOpen.valueOrDefault){let t=zt();t!=null&&await sa(async()=>Promise.all(F(await AD(t)).map(e=>e.unlink())),7*E)}}),FD=At;function HB(t){return f(t,e=>e.join("opened-by"))}function AD(t){return HB(t)?.clear().children(r=>r.ext===".json")}async function LD(){return J(zt(),async t=>cp(xf(t),hg(),"hostname","pid"),async()=>!1)}var hg=l(async()=>({hostname:(0,bf.hostname)(),pid:dg.pid})),xf=bi(t=>GB(t),{maxSize:3,timeoutMs:G,clearEveryMs:er(7*E,G)});async function GB(t){await jB();let e=!sp(),r=h("currentLibraryLockOwner("+t+")"),i=(0,bf.hostname)(),o=await AD(t);if(L(o)){r.warn("no opened-by files found.");return}let n=await Hn(o.map(async Q=>{let jt=await Q.readJson();if(e&&jt==null&&await Q.modifiedCloseTo(Date.now(),G)!==!0){r.warn("unlinking old empty json file: "+Q),await Q.unlink("debug");return}else return w({file:Q},jt)}));r.debug("read",{jsons:n});let s=Date.now()-FD,[a,m]=Cn(n,Q=>Q.updatedAt>s);e&&C(m)&&(r.debug("Unlinking expired opened-by files:",{minUpdatedAt:s,staleJsons:m}),await Promise.all(m.map(Q=>Q.file?.unlink("debug"))));let[c,p]=Cn(a,Q=>Q.hostname===i),d=c.map(Q=>Q.pid),y=M(await Cw(d),d),[P,_]=Cn(c,Q=>y.includes(Q.pid));e&&C(_)&&(r.debug("Unlinking zombie opened-by files:",_),await Promise.all(_.map(Q=>Q.file?.unlink())));let ie=[...P,...p];if(L(ie)){r.debug("No valid opened-by files.");return}let Xe=co(ie,Q=>Q.createdAt),Ee=ie.filter(Q=>Q.systemUID===Xe.systemUID),K=co(Ee,Q=>[rb(Q.serviceName),M(Q.createdAt,()=>Date.now())]);return r.tap({msg:"currentLibraryLockOwner",level:"info",result:K})}j(()=>xf.clear());var gg=class extends Pt{constructor(e){super("OpenedByIO()",()=>this.onEnd(),be.postdb);this.ldd=e;this.createdAt=Date.now();this.watchers=[];this.intervalMs=FD/4;this.file=l(()=>this.dir.join(tn((0,bf.hostname)(),7)+"-"+dg.pid+".json"));this.json=l(async()=>w({serviceName:Dr(),createdAt:this.createdAt,updatedAt:Date.now()},await hg()),this.intervalMs/2);this.write_=l(async()=>{let e=await this.json();await this.file().writeJSON_(e),xf.clear()},this.intervalMs/2);this.setup=l(async()=>{if(await this.write_(),ai())for(let e of this.file().selfAndParents(4))try{let r=(0,DD.watch)(e.nativePath,{persistent:!1,recursive:!1},()=>this.lockOwner.refresh()).on("error",i=>(this.logger.warn("watch().on(error):",i),this.lockOwner.refresh()));this.watchers.push(r)}catch(r){this.logger.warn("Failed to set up watch",{f:e.nativePath,err:r})}});this.lockOwner=l(async()=>{if(!me())return await this.setup(),xf(this.ldd)},7*E);this.dir=e.join("opened-by"),this.timer=jr(()=>this.write_(),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write_.unset()}refresh_(){return this.clear(),this.write_()}async onEnd(){this.watchers.forEach(e=>e.close()),this.watchers.length=0,f(this.timer,clearInterval),this.timer=void 0,await this.file().unlink()}async deleteAllLocks(e=!1){e?await this.dir.rmrf():await this.dir.visitDescendants(r=>r.eql(this.file())?void 0:r.unlink())}async isLockOwner(){return cp(this.lockOwner(),hg(),"hostname","pid")}async throwIfUnavailable(e){this.logger.debug("throwIfAvailable()",{from:e});let r=await this.lockOwner();if(this.logger.debug("throwIfAvailable()",{from:e,lockOwner:r}),r==null)return;let i=await this.json();if(this.logger.debug("throwIfAvailable()",{from:e,json:i}),r!=null&&r.hostname!==i.hostname)throw this.logger.warn("library is unavailable",{lockOwner:r,json:i}),new Error(`Library is already opened by ${r.hostname} (${r.serviceName}:${r.pid}) ${e}`+(qs()?"":ye)+ho+Nt)}};var wf,Na=l(()=>h("Vacuum"));function bm(t){return t==null||t.schema==="models"?B(wf):!1}var ID=async t=>{typeof t!="boolean"&&Na().throw("invalid setVacuuming argument",{value:t}),Na().debug("setVacuuming()",{value:t}),wf=t};ax(ID);async function OD(){return x(Sn()?.request("isVacuuming"),t=>(Na().info("checkRemoteVacuuming() received RPC value",{value:t}),f(t,ID)))}async function yg(t){if(!await LD()){Na().info("withVacuumEvent(): no-op, I'm not the lock owner.");return}Na().info("db vacuum starting...");try{return wf=!0,mg("vacuuming",!0),await t()}finally{wf=!1,mg("vacuuming",!1),Na().info("db vacuum finished.")}}var KB=l(()=>h("RpcServiceHandlers")),kD=l(()=>({libraryPath:()=>u.libraryPath.value,healthChecks:()=>ws(),isVacuuming:()=>KB().tap({msg:"isVacuuming",result:bm()}),mountpoints:()=>ut(),volumes:()=>Ot(),paused:()=>eg()}));var RD=l(()=>h("RpcServer")),_D=l(async()=>{if(!await Wo())return;RD().info("Setting up RPC...");let t=u.rpcPort.valueOrDefault,e=!0,r=new pg(t,e);return r.addSimpleHandlers(kD()),await r.start(),RD().info("RPC service serving port "+r.port),r});var ND={broadcast:(t,e)=>pe(_D(),r=>r.broadcast(t,e),()=>x(Sn(),r=>r.broadcast(t,e)))};var KD=S(require("util"));var BD=S(require("knex"));var $i=(0,BD.default)({client:"sqlite3",useNullAsDefault:!0});async function Tf(t,e){let r=Date.now(),i=0,o=r+u.maxBusyDbMs.valueOrDefault;for(;Date.now()<o;)try{return await t()}catch(n){if(!gl(n)||Date.now()>=o)throw n;e?.(),await Fi(er(500,1500)*++i)}throw new Error("handleDbRetries(): timeout after "+u.maxBusyDbMs.valueOrDefault+"ms")}function Mf(t,e=25){let r;for(let i=0;i<e;i++)try{return t()}catch(o){if(r=o,!gl(o))throw o}throw r}var xm=l(()=>h("Transactions")),JB=D,CD=10,vf=!1;async function Mr(t,e,r=!1,i=!1){if(t.db==null)throw new Error("tx(): null db");try{return r&&(vf=!0),!i&&bm(t)&&await yt(()=>!bm(t),{timeoutMs:JB})==null&&xm().throw("Timeout while waiting for external vacuum to complete"),await Kr(async()=>t.inTransaction?e(t.db):Tf(()=>t.db.transaction(()=>e(t.db)).deferred(),t.onRetry),{maxRetries:CD,errorIsRetriable:async o=>r||vf?!1:(xm().warn("errorIsRetriable()",o),gl(o)||cx(o)?(t.closeDb(),xm().warn("Trying to reopen the db "+t.dbfile),!0):!1),timeoutMs:u.maxBusyDbMs.valueOrDefault/10,onRetryWaitUntil:o=>{let n=er(10,u.maxBusyDbMs.valueOrDefault/(CD-o));return xm().warn("onRetryWaitUntil()",{retryCount:o,delayMs:n}),Fi(n)}})}catch(o){if(r||vf)return;throw xm().warn("tx(): raised",o),o}finally{r&&(vf=!1)}}var $B=".sqlite3";function Ba(t,e){return t.join(e,"db"+$B)}var VD,Ca=()=>VD;function zD(t){VD=t}var bg=new Map;function xg(t){bg.set(t.$ctor,t)}var QB=([t,e])=>t!=null&&e!=null;function UD(t,e){if(e==null)throw new Error("json is null");if(t!=null&&v(t.$ctor)&&!bg.has(t.$ctor)&&xg(t),e instanceof t)return e;let r=V(e.$ctor).flatMap(o=>bg.get(o)).getOrElse(()=>t);if(e instanceof r)return e;let i=new r;return e==null?i:No(i,e,z([t.tableName+".",r.tableName+"."]))}function No(t,e,r=[]){let i=t.class();return nt(e).filter(n=>n!=="$ctor").filter(n=>e[n]!=null).map(n=>{let s=e[n];return r.forEach(a=>n=Qe(n,a)),so(i.booleanFields,n)?[n,B(s)]:[n,s]}).filter(QB).forEach(([n,s])=>t[n]=s),t}function qD(t){return t===null||so(["number","string"],typeof t)}function wg(t){return t!=null&&Array.isArray(t)?t.every(wg):ze(t).every(([,e])=>qD(e))}function WD(t){return Uo(t,(e,r)=>{if(!e.startsWith("$")){if(typeof r=="boolean")return[e,r?1:0];if(qD(r))return[e,r];if(ZP(r))return[e,Zr(r)]}})}function YB(t){return t!=null&&ct(t.sql)&&(t.bindings==null||wg(t.bindings))}function Sf(t){if(t==null)throw new Error("null sql");if(YB(t))return t;if(ct(t))return{sql:t};if(xe(t.toSQL))return kt(t.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+k(t))}function jD(t){return t.replace(/\s*--.*?\n/g,"").split(";").map(e=>e.replace(/\s+/g," ").trim()).filter(v)}var HD=Te?25:1e3,GD=l(()=>h("DbRequest")),wm=class{constructor(e,r){this.db=e;this.tableName=r;this.cachedStatements=new _e(256)}qb(){return $i(this.tableName)}prep(e,r,i=!1){let o=Sf(r);try{let n=this.cachedStatements.getOrSet((i===!0?"pluck:":"")+o.sql,()=>{let s=e.prepare(o.sql);return i===!0?s.pluck():s});return n.database.open?{sq:o,stmt:n}:(this.cachedStatements.clear(),this.prep(e,r,i))}catch(n){return GD().throw("prep() failed",{error:n,sqlQuery:o,retriable:!1})}}async wrap({q:e,pluck:r,m:i}){try{return await Mr(this.db(),o=>{let{sq:n,stmt:s}=this.prep(o,e,r),a=s[i].bind(s);return n.bindings==null?a():a(n.bindings)})}catch(o){if(String(o.message).includes("AdvisoryLock"))throw o;GD().throw(o,w({method:i},Sf(e)))}}run(e){return this.wrap({q:e,m:"run"})}async runScript(e,r=""){let i=Zx("runScript()");for(let o of e){if(T(o)||o.trim().startsWith("--"))continue;await this.run({sql:o});let n=ol(dr(o,60),r,"");i.elapsed(n)}}mapRun(e){return Mr(this.db(),r=>e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return J(o.bindings,s=>n.run(s),()=>n.run())}))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}updateOrIgnore(e){let r=Sf(e(this.qb()));return r.sql=r.sql.replace(/update /i,"UPDATE OR IGNORE "),this.wrap({q:r,m:"run"})}first(e){return this.wrap({q:e,m:"get"})}firstf(e){return this.wrap({q:e(this.qb()),m:"get"})}mapAll(e){return Mr(this.db(),r=>Y(e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return J(o.bindings,s=>n.all(s),()=>n.all())})))}all(e){return this.wrap({q:e,m:"all"})}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}async batched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(HD),m:"all"}),C(r)&&await e.onResults(r);while(C(r)&&!me())}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}async pluckBatched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(HD),pluck:!0,m:"all"}),C(r)&&await e.onResults(r);while(C(r))}};var Tg=class{constructor(e,r){this.model=e;this.db=r;this.columnNames=l(()=>Mf(()=>this.db().pragma(`table_info(${this.tableName})`).map(e=>e.name)));this.logger=h(`ModelOps(${e.tableName})`),xg(e),this.dbl=new wm(this.db,e.tableName)}get dbOpen(){return J(this.db(),e=>e.open,()=>!1)}get tableName(){return this.model.tableName}query(){return this.model.query()}async toDbValued(e){let r=this.model.fromJSON(e),i=WD(r);return at(i,...await this.columnNames())}run(e){return this.dbl.run(e)}fromJSON(e){return x(e,r=>this.model.fromJSON(r))}async fromJSONs(e){return(await Hn(e)).map(o=>this.model.fromJSON(o))}first(e){return this.fromJSON(this.dbl.first(e))}firstf(e){return this.first(e(this.query()))}all(e=this.query()){return this.fromJSONs(this.dbl.all(e))}allf(e){return this.all(e(this.query()))}findOne(e){return this.fromJSON(this.dbl.first(e))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e,r){return this.findOneBy(w(w({},r),{id:e}))}async findByIds(e){let r=await Mr(this.db(),async()=>le(Ws(F(e).filter(N),u.dbBatchSelectSize.valueOrDefault),i=>this.dbl.all(this.query().whereIn("id",i))));return $(await this.fromJSONs(Y(r)),i=>e.indexOf(i.id))}findBy(e){return this.all(this.model.queryBy(e))}findWhereIn(e,r){return this.all(this.model.query().whereIn(e,r))}rows(e){return this.count(M(e,()=>this.model.query()))}count(e){return Re(this.dbl.pluckFirst(e.count()),()=>0)}countf(e){return this.count(e(this.query()))}async insert(e){return Mr(this.model.db(),()=>le(e,r=>this.insertOne(r)))}async upsertOne(e){return this.modelSupportsUpsert?(await this.upsert([e]))[0]:e.id==null?this.insertOne(e):this.updateOne(e)}async insertOne(e){if(e.id!=null)throw new Error("insert called for "+k(e)+Nt);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames()),o=await this.dbl.runf(s=>s.insert(i)),n=await Wn(H(o.lastInsertRowid),s=>this.findById(s),()=>{this.logger.throw("internal error: lastInsertedRowId was non-numeric",{runInfo:o})});return e instanceof this.model&&No(e,n),n}async updateOne(e){if(e.id==null)throw new Error("update called for "+k(e)+Nt);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames());return await this.dbl.runf(o=>o.where({id:e.id}).update(i)),r}get ucn(){return this.model.uniqueColumnName}get ucnFieldNames(){return M(this.ucn,"id").split(",")}get modelSupportsUpsert(){return this.ucn!=null&&this.ucn!=="id"}get ucnConstraint(){return`(${this.ucn})`}onConflictClause(e){let r=[...this.ucn.split(","),"id","createdAt"],i=e.filter(n=>!r.includes(n)).sort().map(n=>`${n}=excluded.${n}`).join(","),o=["ON CONFLICT",this.ucnConstraint];return T(i)?o.push("DO NOTHING"):o.push("DO UPDATE SET",i),o.join(" ")}async upsertDbJson(e){let r=this.query().insert(e).toSQL(),i=new Set;for(let n of e)for(let s of nt(n))i.add(s);let o={sql:`${r.sql} ${this.onConflictClause([...i.values()])}`,bindings:r.bindings};await this.run(o)}pickModelUcn(e){return at(e,...this.ucnFieldNames)}async reload(e){return await le(e,async r=>x(this.findOneBy(this.pickModelUcn(r)),i=>No(r,i))),e}async upsert(e,r=!1){if(this.modelSupportsUpsert){let i=await this.columnNames(),o=await Mr(this.db(),async()=>hx(F(e),u.dbBatchUpsertSize.valueOrDefault,async n=>{let s=n.map(a=>this.model.fromJSON(a));return s.forEach(a=>a.$beforeUpsert()),await this.upsertDbJson(s.map(a=>a.$toDbJSON(i))),s}));return r?o:this.reload(o)}else return Mr(this.db(),()=>le(e,i=>this.upsertOne(i)))}async delete(e){return Ae(e.filter(N),r=>this.run(this.model.query().delete().whereIn("id",r)))}async batched(e){let r=u.dbBatchSelectSize.valueOrDefault,i,o;do i=await this.allf(n=>(n=e.qb(n),o!=null&&(n=n.andWhere("id",">",o)),n.orderBy("id","asc").limit(r))),C(i)&&(o=Math.max(...i.map(n=>n.id)),await e.onResults(i));while(C(i))}};var Bo=class{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return this._logger==null&&(this._logger=h(this.tableName)),this._logger}static query(){return $i(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static ops(){return this._ops==null&&(this._ops=new Tg(this,this.db)),this._ops}static get dbl(){return this.ops().dbl}static async txOp(e){return Mr(this.db(),()=>e(this.ops()))}static async tx(e,r=!1){return Mr(this.db(),()=>e(this.dbl),r)}static rows(){return this.ops().rows()}static truncate(){if(Er)throw new Error("rejecting attempt to truncate in prod");return this.dbl.run("DELETE FROM "+this.tableName)}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return g(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${M(this.id,this[this.class().uniqueColumnName])})`}logger(){return h(g(this.valueOf()))}[KD.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return UD(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}$toShallowJSON(){return this.$_toJSON(B)}$toDbJSON(e){let r=this.$_toJSON(Xy,!1);return v(e)?at(r,...e):r}toJSON(){return this.$_toJSON(B)}$_toJSON(e,r=!0){let i=this.class();return Uo(this,(o,n)=>{if(!(n==null||!Vr(n)))return so(i.booleanFields,o)?[o,e(n)]:[o,n]},r?{$ctor:i.$ctor}:{})}upsert(e){return e!=null&&No(this,e),this.class().ops().upsertOne(this)}$beforeUpsert(){}async reload(){return x(this.class().ops().findById(this.id),e=>No(this,e))}delete(){return f(this.id,e=>this.class().ops().delete([e]))}};Bo.schema="models",Bo.db=Ca;var oAe=`
SELECT
  al1.name,
  al1.lockId
FROM
  AdvisoryLock AS al1
  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name
  AND al1.createdAt > al2.createdAt
WHERE
  al2.createdAt IS NULL
`.replace(/\s+/," "),Mg=class extends Bo{static vacuum(e=30*D){return this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async currentAcquiredLocks(){return this.dbl.pluckAllf(e=>e.select("name").where({acquired:1}))}static async allLocks(){return this.dbl.pluckAllf(e=>e.select("name"))}static async withLocks({lockNames:e,f:r,timeoutMs:i}){let o=Date.now(),n={},s=yf();this.logger().debug("withLocks()",{lockNames:e,lockId:s});let a=n.locks=e.map(c=>({name:c,lockId:s,acquired:0,createdAt:Date.now()}));await this.tx(c=>c.runf(p=>p.insert(a)));let m=l(()=>this.logger().warn("long wait time for",e));try{let c=await yt(async()=>{let p=!0,d=await this.tx(y=>y.runf(P=>P.where({lockId:s}).update({acquired:1})),p);return d==null&&!sM(o,5*E)&&m(),d!=null},{timeoutMs:i,timeBetweenMs:er(5,500)});if(this.logger().info("withLocks()",{lockNames:e,acquired:c}),c){n.acquireMs=Date.now()-o;let p=await Jr(async()=>r(s));n.result=p.result,n.runMs=p.elapsedMs}}finally{let c=await Jr(()=>Mg.tx(p=>p.runf(d=>d.where({lockId:s}).delete())));n.releaseMs=c.elapsedMs,n.released=!0}return n}},Va=Mg;Va.tableName="AdvisoryLock",Va.uniqueColumnName="name,lockId";var XB=(t,e)=>Va.withLocks({lockNames:t,f:e,timeoutMs:D}).then(r=>r.result),JD={withAdvisoryLocks:XB};var Tm=S(require("luxon"));function $D(t,e,r=Tm.DateTime.DATETIME_MED){return wn(t,i=>(U(e,o=>i=i.setLocale(o)),i.toLocaleString(r)))}var ZB=/(\.\d\d\d)\d+/;function QD(t){if(!T(t))return V(Tm.DateTime.fromISO(t.replace(ZB,(e,r)=>r),{setZone:!0})).filter(e=>e.isValid).orElse(()=>f(Tr.fromISO(t),e=>e.middle.toDateTime())).get()}var e1=new Map;function YD(t,e="en-US"){return Ur(e1,e,()=>new Intl.DateTimeFormat(e,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(Zr(t))}function XD(t){return f(QD(t),lM)}var t1=/^\d{1,4}-\d{2}-\d{2}$/;function ZD(t){return U(t,e=>ui(()=>f(Tr.fromISO(e),r=>r.intervalMs),()=>V(e.match(t1)).flatMap(()=>Tm.DateTime.fromISO(e)).filter(mr).map(()=>ot).get(),()=>V(Tm.DateTime.fromISO(e)).filter(mr).map(()=>0).get()))}function eA(t){if(t==null)return;if(ct(t))return QD(t)?.toJSDate();let e=t?.timestamp,r=t?.formatted,i=Si(e,o=>new Date(o*E));if(v(r)){let o=new Date(r);if(!Nd(i,o,E))return}return i}var tA=128,rA=8;var ne=Object.freeze({When:"When",Who:"Who",Where:"Where",What:"What",Camera:"Camera",Lens:"Lens",Albums:"Albums",Keywords:"Keywords",Type:"Type",FS:"fs"}),PAe=[ne.When,ne.Camera,ne.Lens,ne.Type,ne.FS];var iA=l(()=>h("Names"));function vg(t){return Fw(rt(t))}function r1(){return u.tagNamesSurnames.values.map(t=>new RegExp("\\b("+vg(t)+")\\b","i"))}function i1(){return u.tagNamesGiven.values.map(t=>new RegExp("\\b("+vg(t)+")\\b","i"))}function o1(){return Ae(R(u.tagNamesSurnamePrefixes.values),t=>$(t,e=>-e.length).map(e=>new RegExp(`\\b(${vg(e)}\\s+\\S+)`,"i")))}function n1(){let t=R(u.tagNamesGivenSurrounds.values);for(let e of t)e.length!==2&&iA().warn("Settings.tagNamesFamilySurrounds has an invalid value:",e);return t.map(e=>new RegExp(`(${rt(e.charAt(0))}\\s*[^${rt(e.charAt(0))}]+\\s*${rt(e.charAt(1))})`,"i"))}function s1(){let t=R(u.tagNamesFamilySurrounds.values);for(let e of t)e.length!==2&&iA().warn("Settings.tagNamesFamilySurrounds has an invalid value:",e);return t.map(e=>new RegExp(`${rt(e.charAt(0))}\\s*([^${rt(e.charAt(0))}]*)\\s*${rt(e.charAt(1))}`,"i"))}var a1=/(\(\s*\d+\s*-\s*(?:[\d\?]{1,4})?\s*\)?)/,l1=/(,?\s*(?:jr\.?|junior|sr.?|senior|i+\.?))$/i,m1=/\b([A-Zââ']+(?:[-A-Zââ']{2}))\b/;function u1(t){if(T(t))return;let e=t.trim(),r=f(mi(e,a1),y=>(e=y.unmatched.trim(),y.captured.replace(/\s+/g,""))),i=f(mi(e,l1),y=>(e=y.unmatched.trim(),y.captured.trim())),o=[],n=[],s=[];for(let y of i1()){let P=mi(e,y);P!=null&&(o.push(P.captured),e=P.unmatched.trim())}for(let y of n1()){let P;do P=mi(e,y),P!=null&&(n.push(P.captured),e=P.unmatched.trim());while(P!=null)}let a;function m(y){(a==null||a>y.matchedIndex)&&(a=y.matchedIndex)}if(u.tagNamesCapitalizedAsFamily.valueOrDefault){let y;do y=mi(e,m1),y!=null&&(m(y),s.push(y.captured),e=y.unmatched.trim());while(y!=null)}for(let y of s1()){let P;do P=mi(e,y),P!=null&&(m(P),s.push(P.captured),e=P.unmatched.trim());while(P!=null)}if(u.tagNamesLexical.valueOrDefault){let y=e.indexOf(",");y>=0&&(a=void 0,s.push(e.substring(0,y).trim()),o.push(e.substring(y+1).trim()),e="")}for(let y of r1()){let P=mi(e,y);P!=null&&(m(P),s.push(P.captured),e=P.unmatched.trim())}for(let y of F(o1())){let P=mi(e,y);P!=null&&(m(P),s.push(P.captured),e=P.unmatched.trim())}a!=null&&e.length>a&&Ae(R(e.substr(a).split(/\s+/)),y=>{s.push(...y),e=e.substr(0,a)});let c=R(e.split(/\s+/)),p=o.length,d=s.length;if(c.length>0)if(p===0&&d>0)o.push(...c);else if(d===0&&p>0&&c.length===1)s.push(...c);else if(c.length===1)o.push(...c);else{let y=u.tagNamesOrder.valueOrDefault==="western";s.push(y?c.pop():c.shift()),o.push(...c)}return{givenNames:z(R([...o,...n])),modifier:i,lifespan:r,familyNames:z(R(s))}}function oA(t){return R(t).join(" ")}function Sg(t){if(T(t))return[];if(u.tagNamesFormatter.valueOrDefault==="family/given"){let e=u1(t);if(e==null)return[];{let r=oA([oA(e.givenNames)+ii(e.modifier,o=>o.startsWith(",")?o:" "+o.trim(),""),e.lifespan]);return R(Cy(e.familyNames,[u.tagNamesDefaultFamily.valueOrDefault])).map(o=>[ne.Who,o,r])}}else return[[ne.Who,t.trim()]]}var c1=h("WhoTagger");async function nA(t){if(await ji())return;let e=[];if(u.tagJsonFaces.valueOrDefault){let i=Y(await sr(t,o=>o.jsonSidecars()));await sr(i,async o=>{let n=await Zc(o);f(n?.peopleNames,s=>e.push(...s))})}u.tagFaceRegions.valueOrDefault&&await sr(t,async i=>{let o=await Ie(i,!0);for(let n of F(o?.RegionInfo?.RegionList))n.Type==="Face"&&e.push(n.Name)}),C(u.tagWhoNames.values)&&await sr(t,async i=>{let o=await Ie(i,!0);for(let n of u.tagWhoNames.values)e.push(...F(fo(o,n)))});let r=z(Y(z(e).map(Pg)));return c1.tap({msg:"whoTagFiles()",level:"info",result:r,meta:{names:e,files:t.map(i=>i.nativePath)}})}function sA(t){return Ef(Pf(t[0]))}function Ef(t){return!T(t)&&_t([ne.Who,...u.tagWhoSynonyms.values],t)}function Pg(t){if(!T(t))return Array.isArray(t)?(Ef(t[0])&&t.shift(),t.length===0?void 0:t.length===1?Sg(t[0]):[[ne.Who,...t]]):Sg(t)}var Qi=String.fromCharCode(31),Df="Library",aA=[{name:ne.When,ordinal:1},{name:ne.Albums,ordinal:2},{name:ne.FS,ordinal:3},{name:ne.Who,ordinal:4},{name:ne.Camera,ordinal:5},{name:ne.Lens,ordinal:6},{name:ne.Keywords,ordinal:7},{name:ne.Type,ordinal:8}];function Pf(t){return f(t,e=>M(e.name,g(e)))}function lA(t){return t.map(Pf)}function ur(t,e=Qi){return lA(t).join(e)+(e===Qi?e:"")}function mA(t){return Qm(Pn(t))}function Pn(t,e=Qi){return g(t).split(e).filter(v)}function uA(t){return ur(Pn(t))}function Af(t){return lA(t).join(Qi).toLowerCase()}function cA(t,e){let r=new Set(A(e).map(i=>Af(i)));return A(t).filter(i=>!r.has(Af(i)))}function f1(t,e){let r=Af(t);return e.some(i=>r===Af(i))}async function fA(t,e){let r=cA(e,t),i=cA(t,e),o=u.excludedRootTags.valueOrDefault;return ft(r,n=>{let s=o.includes(Pf(n[0]).toLowerCase());return s&&!f1(n,i)&&(i.push(n),console.log("removing bad tag",n)),!s}),await ji()&&ft(i,n=>!sA(n)),{add:r,remove:i}}var Yi=l(()=>h("Migrations")),p1=new RegExp(`^(${rt(Qr)}://.*?/)(.*)$`),d1=t=>V(t).filter(ct).flatMap(e=>p1.exec(e)).map(e=>e[1].toLowerCase()+e[2]).getOrElse(()=>t);function h1(t,e=ko){return wv(t,e).map(r=>va(r,e))}function g1(t,e){return ge(t,()=>f(h1(t,6)[e],r=>vo(r,ko)))}function y1(t){return t.endsWith(Qi)?t:t+Qi}function pA(t,e){L(e)&&Yi().warn("mergeTags(): empty tagIds",{tagIds:e});function r(d){return t.prepare(d).run()}let i=new Map(t.prepare("SELECT id, _path FROM Tag WHERE id IN ("+e.join(",")+")").all().map(({id:d,_path:y})=>[d,y])),o=$(e.map(d=>{let y=i.get(d);return{id:d,path:y,base:mA(y)}}),d=>[d.base,d.path]);o.reverse(),Yi().info("mergeTags()",{arr:o});let n=o[0],s=n.id;if(L(o)||!N(s)){Yi().warn("mergeTags(): empty array, or missing winner",{arr:o,winner:n,winnerId:s});return}let a=o.slice(1);if(C(a)){let d=a.map(y=>y.id).join(",");r(`UPDATE OR IGNORE AssetTag SET tagId = ${s} WHERE tagId in (${d})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${d})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${d})`),r(`DELETE FROM AssetTag WHERE tagId in (${d})`),r(`DELETE FROM Tag WHERE id in (${d})`)}let m=t.prepare("select _path from Tag where id = :id").get({id:s})._path,c=Pn(m),p=t.prepare("SELECT id, _path FROM Tag WHERE id = :winnerId OR _path LIKE :like COLLATE NOCASE").all({winnerId:s,like:Ht(m,Qi)+"%",winnerPath:m});for(let d of p){let y=ur([...c,...Pn(du(d._path,m))]);d._path!==y&&(Yi().info("mergeTags(): repairing tag path",{ea:d,newPath:y}),t.prepare("UPDATE OR IGNORE Tag SET _path = :path, updatedAt = :updatedAt WHERE id = :id").run({id:d.id,updatedAt:Date.now(),path:y}))}return Yi().tap({msg:"mergeTags()",level:"info",result:{winner:n,losers:a},meta:{tagIds:e,winnerPath:m}})}function dA(t){let e=t.prepare(["SELECT","rtrim(_path, char(31)) as path,","count(*) AS cnt,","group_concat(id) AS ids","FROM Tag","GROUP BY path","COLLATE NOCASE","HAVING cnt > 1"].join(" ")).all();for(let r of e)r.ids=A(g(r.ids).split(",").map(i=>H(i)));return kn(e,r=>r.path).reverse(),Yi().tap({msg:"dedupeTags()",result:e.map(r=>pA(t,r.ids)),meta:{rows:e}})}var Eg={lowercase_psnet_hostname:t=>{t.function("lowercase_psnet_hostname",{deterministic:!0},d1),t.transaction(()=>{t.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),t.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),t.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")})()},force_stable_channel:async()=>{try{await cf();let t=u.updateChannel.value;t!=="stable"&&(u.updateChannel.value="stable",await eD(),Yi().info("force_stable_channel(): reset updateChannel",{priorValue:t}))}catch(t){Yi().error("force_stable_channel(): failed: "+t)}},numeric_captured_at:t=>{t.function("isoToLocal",{deterministic:!0},XD),t.function("isoToOffsetMinutes",{deterministic:!0},Rh),t.function("isoToPrecisionMs",{deterministic:!0},ZD),t.transaction(()=>{t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),t.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),t.exec("DROP INDEX asset_captured_at_geohash_idx"),t.exec("DROP INDEX assetfile_exifuid_idx"),t.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")})()},spread_modes:t=>{t.function("plucklabmodeb6",{deterministic:!0},g1),t.transaction(()=>{ce(Mn,e=>t.exec(`ALTER TABLE AssetFile ADD COLUMN mode${e} integer`)),t.exec("UPDATE AssetFile SET "+ce(Mn,e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`).join(", "))})()},normalize_asset_file_uris:t=>{t.function("normalizeURI",{deterministic:!0},JM),t.transaction(()=>{let e=t.prepare("SELECT normalizeURI(uri) AS nuri, count(*) AS cnt, GROUP_CONCAT(id) AS ids FROM AssetFile GROUP BY nuri HAVING cnt > 1").all(),r=[];for(let i of e){let o=g(i.ids).split(","),n=t.prepare("SELECT id, shown, version, updatedAt FROM AssetFile WHERE id in ("+o.join(",")+")").all(),s=et(n,m=>[m.shown,m.version,m.updatedAt]),a=n.filter(m=>m.id!==s.id);r.push(...a.map(m=>m.id))}for(let i of Ws(r,256))t.exec("DELETE FROM AssetFile WHERE id in ("+i.join(",")+")");t.exec("UPDATE AssetFile SET uri = normalizeURI(uri)")})()},dedupe_tag_paths:t=>{t.transaction(()=>dA(t))()},suffix_tag_paths:t=>(t.function("tag_path_suffix",{deterministic:!0},y1),t.transaction(()=>{dA(t),t.exec("UPDATE Tag SET _path = tag_path_suffix(_path)")})()),normalize_tag_paths:t=>{let e=t.prepare("SELECT id, _path FROM Tag WHERE _path LIKE '%' || char(31) || char(31) || '%'").all();Yi().info("normalize_tag_paths():",{badTags:e});for(let r of e){let i=uA(r._path);pA(t,A([r.id,...t.prepare("SELECT id FROM Tag WHERE _path = ?").pluck().all(i)]))}},drop_tc_tables:t=>{let e=/^(ct|taf|tag_counts)_[a-z0-9]{6}$/i,r=t.prepare("SELECT name FROM sqlite_master WHERE type='table'").pluck().all(),i=r.filter(o=>e.exec(o)!=null);Yi().info("drop_tc_tables()",{tables:r,victims:i});for(let o of i)t.exec("DROP TABLE "+o)}};var b1=`
CREATE TABLE IF NOT EXISTS migrations (
  id integer NOT NULL PRIMARY KEY, 
  name varchar(255) NOT NULL, 
  migration_time integer NOT NULL 
)
`;function x1(t){return t.name.includes("_nofk")}var Dg=class{constructor(e,r,i){this.migrationsDir=e;this.db=r;this.fsMigrations=l(()=>this.migrationsDir.children(e=>e.ext===".sql"));this.migrationsInDatabase=l(()=>this.db.prepare("SELECT name from migrations").pluck().all());this.assertKnownMigrations=l(()=>{if(!wx)return;let e=this.migrationsInDatabase().filter(r=>{let[i,o,n]=[r.slice(0,4),r.slice(4,6),r.slice(6,8)].map(a=>H(a)),s=new Date(i,o-1,n);return this.logger.debug("migration filter",{migrationName:r,migrationDate:s,gitDate:Vp}),Vp.getTime()<s.getTime()});if(C(e))throw new ue({fatal:!0,doNotSend:!0,message:"PhotoStructure is not forward-compatible with newer libraries. Please upgrade to open this library",cause:new Error("Unknown migrations: "+e.join(","))})});this.logger=h("Migration("+k({schema:e.base,db:i.nativePath})+")"),r.exec(b1),this.addMigrationStmt=r.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}async apply(e){this.assertKnownMigrations();let r=await this.fsMigrations();if(r==null)throw new Error("no migration files found for "+this.migrationsDir);let i=[],o=this.migrationsInDatabase();for(let n of r)o.includes(n.name)?this.logger.debug("latest(): already applied "+n.base):(await f(e,s=>s(n)),await ke(this.applyMigration(n),5*D,()=>{throw new ue({fatal:!0,ignorable:!1,message:"Migration "+n.name+" timed out."})}),i.push(n.base));return this.logger.info("up to latest!",{appliedMigrations:i}),i}async applyMigration(e){Zb(e.name);try{let r=Date.now(),i=(await e.readLines()).filter(s=>T(s)||s.trim().startsWith("--")),o=Eg[e.name.replace(/^[\d_-]+/,"")],n=xe(o);if(L(i)&&n)throw new ue({message:"empty migration "+e.name,fatal:!0});return n?await o.bind(Eg)(this.db):await this.applySqlMigration(e),this.logger.debug("applyMigration() completed",{elapsedMs:Date.now()-r,codeMigration:n,migration:e.baseWithParent}),this.db.transaction(()=>{this.addMigrationStmt.run(e.name,Date.now())})()}catch(r){return this.logger.throw("Failed to apply migration "+e.baseWithParent,ci(r))}}async applySqlMigration(e){let r=x1(e);try{let i=g(await e.readFile());if(T(i)){this.logger.error("Empty migration: "+e);return}r&&this.db.pragma("foreign_keys = OFF");for(let o of R(i.split(";")))try{this.db.exec(o)}catch(n){throw new ue({cause:n,fatal:!0,message:`Failed to apply: ${o}`})}if(r){let o=this.db.pragma("foreign_key_check");if(C(o))throw this.logger.error("foreign_key_check failed",o),new Error("Foreign key checks failed during migration "+e.name)}}finally{r&&this.db.pragma("foreign_keys = ON")}}};var Fg=S(require("path"));var Ag=S(require("fs-extra"));function hA(t){try{return V(t).filter(v).flatMap(Ag.statSync).flatMap(e=>Number(e.size)).get()}catch{return}}var w1=require("better-sqlite3");function Mm(t,e=u.dbTimeoutMs.valueOrDefault){let r;if(u.logSql.valueOrDefault){let i=h("SQLite("+t.split(Fg.sep).slice(-2).join(Fg.sep)+")"),o=AT();r=n=>i.log(o,n.replace(/\s{2,}/g," "))}return f(hA(t),i=>{u.dbCacheSizeMb.tmpValue=Math.max(u.dbCacheSizeMb.valueOrDefault,Math.ceil(1.1*i/Ai)),h("mkdb("+t+")").info("Dynamically setting dbCacheSize to "+u.dbCacheSizeMb.value,{dbFileSize:i})}),T1(new w1(t,{fileMustExist:!1,readonly:!1,timeout:e,verbose:r}))}function T1(t){let e=['encoding = "UTF-8"',"threads = "+Z(1,4,Ft()),"foreign_keys = ON","page_size = "+16*up,"trusted_schema = 0","cache_size = -"+u.dbCacheSizeMb.valueOrDefault*Ai/1024,"locking_mode = NORMAL","journal_mode = WAL","busy_timeout = "+u.dbTimeoutMs.valueOrDefault,"synchronous = NORMAL","auto_vacuum = NONE"];return Mf(()=>{for(let r of e)t.pragma(r)}),t}var gA=["-wal","-journal"];var TFe=l(()=>h("SQLiteFiles"));function za(t){return[t,...gA.map(e=>t.sibling(t.base+e))].filter(e=>e.clear().existsSync())}function yA(t,e,r=u.dbTimeoutMs.valueOrDefault){let i=Mm(g(t),r);try{return e(i)}finally{i.close()}}async function bA(t,e,r=u.dbTimeoutMs.valueOrDefault){let i=Mm(g(t),r);try{return await e(i)}finally{i.close()}}var KFe=require("better-sqlite3"),En=h("SQLite");async function xA(t,e){try{await e.parent().mkdirp_();let r=new on({path:g(t),op:"Backing up"},100);await bA(t,i=>i.backup(g(e),{progress({totalPages:o,remainingPages:n}){return r.onProgress((o-n)/o*100),100}}),G)}catch(r){throw new ue({cause:r,fatal:!0,message:`Could not back up db ${t} -> ${e}`})}}var M1=[{integrity_check:"ok"}];function wA(t){try{let e=t.pragma("integrity_check");if(to(e,M1))return En.info("verifyDb("+t.name+"): OK"),!0;throw new Error(k(e))}catch(e){throw new ue({cause:e,fatal:!0,retriable:!1,message:"verifyDb("+t.name+") failed"})}}function TA(t){try{return wA(t)}catch{return!1}}function Lg(t){return yA(t,wA,G)}var MA=["wal_checkpoint(RESTART)","optimize"];function vA(t){En.warn("optimizeDb() starting...",t.name);for(let e of MA)t.pragma(e);En.warn("optimizeDb() finished.")}async function SA(t,e="recover",r=!0){let o=(await t.parent().join(e).mkdirpSync_()).join(t.base);En.info(`repairDbFile_(${t} -> ${o})`);try{let n=await Ov(),s=3*Ge+await t.size()*1.25,a=10*s,m=new on({path:g(t),op:"Repairing db"},s),c=new Gt,p=ln(n,[t.nativePath,"."+e],5*D,{encoding:"buffer",maxBuffer:a});p.stdout.on("error",P=>se("sqlite "+e+" failed for "+t,new ue({cause:P,fatal:r})));let d=ln(n,[o.nativePath],5*D,{encoding:"buffer",maxBuffer:a});d.on("exit",()=>c.resolve()),p.stdout.on("end",()=>{d.stdin.end(MA.map(P=>"PRAGMA "+P+";").join(`
`))}),p.stdout.on("data",P=>{let _=P.length;m.incrProgress(_),d.stdin.write(P)}),await c,await Lg(o),En.info(`repairDbFile_(): ${o} is valid, finishing repair.`);let y=await le(za(t),P=>P.renameYMDHMS_("needed-repair"));return await le(za(o),P=>P.mv_(t.parent())),y.find(P=>P.ext===".db"||P.ext.startsWith(".sqlite"))}catch(n){return En.throw("failed to recover DB via dump and restore. Please see <https://photostructure.com/faq/restore-db-from-backup/> "+ye,n)}}async function PA(t){if(await t.notExists())return;let e=await t.parent().join("version-backup").mkdirp(),r=await e?.childWithSameContents(t);if(e==null||r!=null)return r;let i=e.join(aM()+"-"+t.base);return await Ig(t,i),i}async function Ig(t,e){En.info("coldDbBackup(): copying "+t+" to "+e);let r=za(t).filter(i=>!i.eql(t));await t.copyFile_(e),await le(r,i=>i.copyFile_(e)).catch(i=>En.warn("Failed to copy aux db files",i))}var vm=class extends Pt{constructor(e,r,i=()=>{}){super("Db("+e+")",()=>this.closeDb(),be.db);this.schema=e;this._dataDir=r;this._onMigration=i;this.endTimeoutMs=D;this.migrate=l(async()=>{let e=this.dbfile;if(this.db==null||e==null)throw new Error("Cannot migrate database: missing db");await this.maybeRepair();let r=l(async()=>(this._onMigration(),PA(e))),i=new Dg(Me.for(Lr.Migrations()).join(this.schema),this.db,e);return{appliedMigrations:await i.apply(r),migration:i}});this.onRetry=l(()=>this.closeDb(),u.maxBusyDbMs.valueOrDefault/4)}get datadir(){return M(this._dataDir,zt())}get dbfile(){return Ba(this.datadir,this.schema)}get open(){return this._db!=null&&this._db.open}get inTransaction(){return this.open&&this._db?.inTransaction===!0}prepare(e){return this.db.prepare(e)}pragma(e,r){return this.db.pragma(e,r)}get db(){let e=this._db==null;if(!this.open){this.logger.info("setting up new db connection to "+this.dbfile,{priorWasNull:e});try{this.dbfile.parent().mkdirpSync_(),this._db=Mm(this.dbfile.nativePath);let r=this._db.pragma("quick_check",{simple:!0});if(r!=="ok")throw new Error("Quick integrity check failed: "+r+ye)}catch(r){throw new ue({cause:r,fatal:!0,message:"Failed to set up "+this.dbfile})}}return this._db}closeDb(){try{this._db?.open===!0&&(this.logger.info("closing db",this._db),this._db?.close())}catch(e){this.logger.warn("closeDb(): .close() failed",e)}this._db=void 0}async maybeRepair(){let e=!0;try{e=TA(this.db)}catch{e=!1}e||(this.logger.warn("maybeRepair(): database failed validation. Trying to restore with dump/load."),await this.repair_())}async vacuum(){await yg(()=>this._vacuum())}async _vacuum(){try{await Tf(()=>{vA(this.db),this.db.exec("VACUUM")},this.onRetry)}catch(e){this.logger.warn("vacuum(): vacuum failed, trying to recover by dump-load",e),await this.repair_()}}async repair_(){this.logger.warn("repair_(): Attemping restore of "+this.dbfile),this.closeDb(),await yg(()=>SA(this.dbfile)),this.logger.info("repair_(): Database restoration was successful!")}};var Sm=class extends Pt{constructor(e){super(e.name,()=>{f(this.timer,clearInterval),this.timer=void 0},M(e.rank,be.first),()=>J(e._isEnded,r=>r(),()=>!1),e.endTimeoutMs);this.setup(e)}async setup(e){N(e.initialDelayMs)&&await lt(e.initialDelayMs),!this.ended&&(this.timer=jr(e.callback,Math.round(e.intervalMs),...F(e.args)))}};var Og=class{constructor(e,r,i,o=Cd()){this.seq=e;this.set=r;this.name=i;this.stamp=o}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return this.fromBasename(e.base)}static fromBasename(e){return f(this.parseRe.exec(e),r=>new Og(parseInt(r[2],10),parseInt(r[3],10),r[4],r[1]))}},Pm=Og;Pm.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;var Ua=class{constructor(e,r,i){this.dir=e;this.sets=r;this.seq=i;this.mods=l(()=>ce(this.sets,e=>Math.pow(2,e)).reverse())}static async for(e,r){return new Ua(e,r,M(await Ua.maxSeq(e),-1))}static async maxSeq(e){return Kb([...F(await x(e.childNames(),r=>r.map(i=>Pm.fromBasename(i)?.seq)))])}set(e){return this.sets-this.mods().findIndex(r=>e%r==0)}next(e){let r=++this.seq;return new Pm(r,this.set(r),e)}async hanoiFiles(){let e=await this.dir.clear().childNames();return A(e?.map(r=>Pm.fromBasename(r)))}async validHanoiFiles(e){let r=await Re(e,()=>this.hanoiFiles()),i=Gp(r,n=>n.set),o=[];for(let n of i.keys())f(et(i.get(n),s=>s.seq),s=>o.push(s));return o}async staleHanoiFiles(e){let r=await Re(e,()=>this.hanoiFiles()),o=(await this.validHanoiFiles(e)).map(n=>n.seq);return r.filter(n=>!o.includes(n.seq))}async staleFiles(){return this.staleHanoiFiles().then(e=>e.map(r=>r.toFile(this.dir)))}};var Ff=S(require("process"));function v1(){return Ff.stdout==null||Ff.stdout.destroyed||Ff.stdout.writableEnded}function kg(t,...e){v1()||console.log(t,...e)}var KLe=1*At;var Rg=class extends Sm{constructor(e,r,i,o,n,s=()=>{},a=()=>{}){super({name:"DbBackup("+i+")",callback:()=>this.backup(),intervalMs:u.dbBackupIntervalMinutes.valueOrDefault*D,rank:be.predb});this.db=e;this.isLockOwner=r;this.srcDbFile=i;this.backupsDir=o;this.replaceDir=n;this.beforeBackup=s;this.onBackupFinished=a;this.endTimeoutMs=D;this.mutex=new Ii;this.hanoi=l(()=>Ua.for(this.backupsDir,u.dbBackupsCount.valueOrDefault));Nn()||this.onEnds.push(async()=>{await this.mutex.serial("DbBackup.end()",async()=>{ai()&&kg("Verifying & backing up "+e.dbfile+"..."),await this._backup(!0),ai()&&kg("PhotoStructure library db has been backed up to "+o+".")})})}backup(){return this.mutex.maybeRun("DbBackup.backup()",()=>this._backup())}async _backup(e=this.ended){if(!await this.isLockOwner()){this.logger.info("backup(): not lock owner, no-op.");return}if(!e&&!this.db.open){this.logger.warn("backup(): db is already closed.",this.db.name);return}if(await this.srcDbFile.clear().isEmpty()){this.logger.warn("backup(): db is missing.",this.srcDbFile.nativePath);return}try{this.logger.info("backup(): beforeBackup...",{srcDb:this.srcDbFile.nativePath,backupsDir:this.backupsDir.nativePath}),await this.beforeBackup(),e&&this.db.open&&(this.logger.info("backup(): closing db before backup..."),await this.db.closeDb());let r=this.srcDbFile.parent().join("backup",this.srcDbFile.base);this.logger.info("backup(): starting backup to "+r),await xA(this.srcDbFile,r),this.logger.info("backup(): backup taken. Verifying "+r),await Lg(r),this.replaceDir!=null&&(this.logger.info("backup(): Copying to "+this.replaceDir),await Ig(r,this.replaceDir));let i=await za(r),o=await this.hanoi(),s=o.next("").toFilename();this.logger.info("backup(): Rotating files to "+this.backupsDir.join(s));for(let a of i)await a.mv_(this.backupsDir.join(s+a.base),{overwrite:!0});for(let a of await o.staleFiles())this.logger.info("backup(): removing stale backup "+a),await a.unlink();this.logger.info("backup(): finished successfully"),await this.onBackupFinished()}catch(r){this.logger.throw(r,{from:"DbBackup._backup() failed",fatal:!0,srcDb:this.srcDbFile.nativePath})}}};var EA=l(async()=>{let t=Do().join("local-db");return await t.join("README.txt").writeTxt_(`
This folder is only used when your library is on a remote filesystem.

You will corrupt your library if you remove this directory while PhotoStructure is
running.

If you have any questions, please visit <https://photostructure.com/support/>.`),t});var DA=S(require("fs-extra"));var Ts=11,qa=3;var AA=l(()=>h("StatsDbDir"));var S1="sync-state-";async function Lf(t=!0){let e=[];e.push(["Asset version",qa]),e.push(["Asset file version",Ts]),e.push(["Library path",u.libraryPath.value]);let r=gi(k(e),10,ku),i=Do().join(S1+r);return t&&(await(0,DA.mkdirp)(i.nativePath),await i.join("README.txt").applyIfEmpty_(o=>o.writeTxt_(`This folder holds state for library synchronization of

${u.libraryPath.value}

If you delete or modify the contents of this directory, you will need to
restart PhotoStructure. The next sync will rescan all your drives.

If you have any questions, please visit <https://photostructure.com/support/>.

`+e.map(([n,s])=>`${n}: ${s}`).join(`
`)).catch(n=>{AA().warn("Failed to write README to "+i,n)})),AA().info("Set up statsDbDir dir "+i)),i}var FA=l(async()=>new Intl.DateTimeFormat(await Xw(),{month:"short"})),LA=l(async()=>{let t=await FA();return io(0,12,e=>t.format(new Date(2016,e,1))).map(e=>ir(e,"."))});j(()=>{FA.unset(),LA.unset()});function P1(t){return 1e4-t}function E1(t){return 13-t}function IA(t){return 13-t}function D1(t){return 33-t}function A1(t){return ge(t,e=>({name:g(e),ordinal:P1(e)}))}async function _g(t){if(!!ht(1,12,t))return f((await LA())[t-1],e=>({name:String(t),displayName:e,ordinal:E1(t)}))}function F1(t){return ge(t,e=>({name:g(e),ordinal:D1(e)}))}async function Ng(t){let e=g(u.tagYMD.valueOrDefault).toLowerCase();if(t==null||e===""||e==="off"||e.startsWith("disable"))return;let r=[ne.When];if(e.startsWith("y")){let i=f(Lo(t),A1);if(i==null)return;r.push(i)}if(e.startsWith("ym")){let i=await f(Fo(t),_g);if(i==null)return r;r.push(i)}if(e.startsWith("ymd")){let i=f(Ao(t),F1);if(i==null)return r;r.push(i)}return r}async function OA(t,e){if(u.tagYMD.valueOrDefault==="")return;let r=[...e];L(e)&&await x(_r(t),o=>r.push(o.capturedAt));let i=yE(r);if(!(i==null||i.src.startsWith("stat")&&!u.tagDateFromStat.valueOrDefault))return Ng(i.date)}var Bg=4,Cg=8,kA=Bg**Cg;function RA(t,e,r){let[i,o,n,s,a]=L1(t),m=e,c=`(${i}*${m}*${m}+${o}*${m})%${r}`,p=`(${n}*${m}+${s})%${r}`;return`((${c})*(${p})+${a})%${r}`}var I1=[[353868013,472882027,479001599,517294153],[1012573,1230587,1355297,1572751],[756065159,812182027,899809343,989450477],[3959297,4514113,4823201,5133127],[573259391,666101999,694847533,746151647],[2275327,2770513,3073703,3511973],[173313197,182557181,203457869,222230231],[6054613,6189107,7752103,9852103]],_A=[1012573,1101689,1183811,1196089,1230587,1355297,1419641,1483733,1572751,2275327,2770513,3010349,3073703,3118691,3174823,3511973,3959297,4514113,4690451,4823201,5133127,5375327,6019889,6054613,6189107,7752103,7752103,9852103];function O1(t){return Kp(Bg,t,Cg).map((r,i)=>I1[i][r])}var L1=dc(t=>{let[e,r,i,o,n,s,a,m]=O1(t%kA),c=[e/r,i/o,n/s,a/m].map(p=>Be(p,7));return c.push(_A[t%_A.length]),c},{maxSize:128,ttlMs:D});var Vg=class{constructor(e){this.id=e}nextAssetBatch(e){let r={};return f(e,i=>r.capturedAtLt=i.getTime()),Od(`/tag-gallery/${this.id}`,r)}};var Ms=S(require("path"));var fOe=De.lift(t=>t.isFile()),pOe=De.lift(t=>t.isReadable());function Em(t){return De.lift(async e=>pe(Ie(e,!1),t,()=>!1))}function NA(t){return Em(e=>uu(...t.map(r=>e[r])))}var k1=De.lift(async t=>{let e=await So(t);if(e==null||!e.startsWith("image/")&&!e.startsWith("video/"))return!1;let r=e.startsWith("video/")?u.minVideoDimension.valueOrDefault:u.minImageDimension.valueOrDefault;return pe(ka(t),i=>qr(i.ImageWidth,r)&&qr(i.ImageHeight,r),()=>!1)}),R1=De.lift(async t=>{let e=await So(t);if(e==null)return!1;if(!e.startsWith("video/"))return!0;let r=await Ie(t,!1);return r==null?!1:qr(cs(r),u.minVideoDurationSec.valueOrDefault)}),_1=NA(["MIMEType"]),N1=NA(["Make","Model"]),B1=Em(t=>H(t.Rating,{defaultValue:0})>=0),dOe=Em(t=>so(["image/jpeg","image/png"],g(t.MIMEType))),C1=Em(t=>g(t.MIMEType).startsWith("image/")),V1=Em(t=>g(t.MIMEType).startsWith("video/")),z1=C1.and(N1).or(V1);async function U1(t){return!T(t)&&(Bc(t)||bn(t)||$t(t)&&await am()||hs(t)&&await Uc())}var q1=De.lift(async t=>pe(So(t.nativePath),U1,()=>!1)),zg=De.lift(async t=>!Yl(t.nativePath)),BA=De.lift(async t=>gt(cn(t))),CA=De.lift(async t=>pe(t.size(),e=>ht(u.minAssetFileSizeBytes.valueOrDefault,u.maxAssetFileSizeBytes.valueOrDefault,e),()=>!1)),hOe=De.andLogged(h("fileFilterNoStat"),{exifExtFilter:$c},{notHiddenCheap:zg}),gOe=De.andLogged(h("fileFilterCheap"),{exifExtFilter:$c},{notHiddenCheap:zg},{noMediaFilter:BA},{fileSizeFilter:CA}),Ug=l(()=>A([{exifExtFilter:$c},{fileSizeFilter:CA},{notHiddenCheap:zg},{noMediaFilter:BA},{hasMimeType:_1},{supportedMimeTypeFilter:q1},u.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:z1}:void 0,{notRejected:B1},{minDimensionsFilter:k1},u.minVideoDurationSec.valueOrDefault>0?{minVideoDurationFilter:R1}:void 0])),VA=l(()=>De.andLogged(h("fileFilterExpensive"),...Ug())),yOe=De.lift(async t=>T(t.ext)),bOe=De.lift(async t=>t.isDirectory());function If({a:t,b:e,field:r,desc:i,parser:o}){let n=o(t[r]),s=o(e[r]),a=u.minExposureSettingsCoeffPct.valueOrDefault/100;return n==null||s==null||ky(n,s,a)?void 0:"Different "+i+": "+t[r]+" \u2260 "+e[r]}function zA(t,e){if(!(t==null||e==null))return Ls([()=>If({a:t,b:e,field:"focalLength",desc:"focal length",parser:jn}),()=>If({a:t,b:e,field:"aperture",desc:"aperture",parser:jn}),()=>If({a:t,b:e,field:"shutterSpeed",desc:"shutter speed",parser:qb}),()=>If({a:t,b:e,field:"iso",desc:"ISO",parser:jn})])}function qg(t,e){for(let r of e){let i=t[r];if(v(i))return r+":"+g(i).trim()}}function Of(t){return qg(t,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"])}function kf(t){{let e=qg(t,["LensSerialNumber","LensID"]);if(e!=null)return e}return f(ef(t),({lensMake:e,lensModel:r})=>`${e.toLowerCase()}/${r.toLowerCase()}`)}function Rf(t){return qg(t,["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"])}var UA=[{ms:Uy,s:"year",p:"years"},{ms:30.4*ot,s:"month",p:"months"},{ms:zy,s:"week",p:"weeks"},{ms:ot,s:"day",p:"days"},{ms:At,s:"hour",p:"hours"},{ms:D,s:"minute",p:"minutes"},{ms:E,s:"second",p:"seconds"}];function Dm(t,e=2,r){if(!Wm(t))return re(t)?"-"+Dm(Math.abs(t),e):"";let i=UA.findIndex(s=>s.ms<=t);if(i===-1)return"";let o=t,n=A(UA.slice(i,i+e).map(s=>{if(!(s.ms>o)){let a=Math.floor(o/s.ms);return o-=a*s.ms,{i:a,s:lu(a,s.s,s.p)}}}));return L(n)?"":n.map(s=>s.s).join(", ")+J(r,s=>" "+(n[n.length-1].i!==1?s.singular:s.plural),"")}var W1=l(()=>h("FilePathTagger"));function qA(t){let e=[];for(let r of t)try{e.push(Wg(r))}catch(i){W1().warn("Failed to parse asset file URI",{uri:r})}return e}function Wg(t){let e=Jl(t),r=e.scheme===zi?Df:e.authority,i=e.path.split("/").slice(0,-1);return R([ne.FS,r,...i])}var cr=class extends Bo{static touch(e){return Ae(F(e).filter(N),r=>this.dbl.runf(i=>i.whereIn("id",r).update("updatedAt",Date.now())))}toID(){return"updateCount"in this&&(this.updateCount=Wn(this.updateCount,e=>e,1)),Wa(this)}get createdAtDate(){return ge(this.createdAt,e=>new Date(e))}get updatedAtDate(){return ge(this.updatedAt,e=>new Date(e))}$beforeUpsert(){if(this.createdAt==null&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this){let e=this;e.updateCount=Wn(e.updateCount,r=>r+1,1)}}};function Wa(t){return f(t,e=>({id:e.id,v:Ny(e.updateCount,0)}))}var jg=class extends cr{constructor(){super(...arguments);this.posixFile=l(()=>ee.forUri(this.uri,this.mountpoint))}static async recentAssetIdsByUriRoot(e,r,i=64){let o=Date.now()-r,n=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",o).andWhere("Asset.shown",1).andWhere("Asset.hidden",0);return v(e)&&(n=n.andWhere("AssetFile.uri","like",e+"%")),n=n.orderBy("AssetFile.updatedAt","desc").limit(i),this.logger().debug("recentAssetIdsByUriRoot",n.toSQL()),this.dbl.pluckAll(n)}static assetCountByMimetype(e){let r=this.query().select($i.raw("mimetype, count(*) as count")).join("Asset","Asset.id","AssetFile.assetId").where("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0);return v(e)&&(r=r.andWhere("uri","like",e+"%")),r=r.groupBy("mimetype").orderBy("mimetype"),this.dbl.all(r)}static async assetCountByMimetypeRoot(e){let r=await this.assetCountByMimetype(e);return tr(z(r.map(o=>o.mimetype.split("/")[0]))).map(o=>({mimetypeRoot:o,count:Rs(r,n=>n.mimetype.startsWith(o+"/")?n.count:0)}))}static children(e,r){let i=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${rt(e)}/[^/]+$}`);return this.ops().all(J(r,o=>o(i),()=>i))}get capturedAtDateTime(){return lc(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return $D(this.capturedAtDateTime,e)}static outdatedQuery(e){let r=this.query().where("version","<",Ts).orderBy("id");return L(e)?r:r.andWhere(i=>i.whereIn("mountpoint",e).orWhereNull("mountpoint"))}static async nextOutdated(e=Ar){return this.ops().findOne(e(this.outdatedQuery(await ut())))}static async outdatedCount(e=Ar){let r=this.outdatedQuery(await ut());return this.dbl.pluckFirst(e(r.count("id")))}static async setShown(e,r){if(this.logger().info("setShown()",{assetId:e,assetFileId:r}),!N(e)||!N(r))throw new Error("setShown(): invalid IDs: "+k({assetId:e,assetFileId:r}));await this.dbl.runf(n=>n.update("shown",0).where("assetId",e));let i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),o={assetId:e,assetFileId:r,updatedAt:Date.now()};return this.dbl.run({sql:i,bindings:o})}static async findByAsset(e,r){let i=this.query().select("AssetFile.*");return f(oi(e),o=>i.join("Asset","Asset.id","AssetFile.assetId").where(Uo(o,(n,s)=>["Asset."+n,s]))),f(oi(r),o=>i.where(Uo(o,(n,s)=>["AssetFile."+n,s]))),this.ops().all(i)}get modes(){return A(ce(Mn,e=>this["mode"+e]))}set modes(e){ce(Mn,r=>this["mode"+r]=e[r])}async matchesFile(e){if(this.version==null||this.version<Ts||u.forceSync.valueOrDefault)return!1;let r=await this.fileFields(e);return zb(r,this)}fileFields(e){return bt(e).orElse(()=>this.posixFile()).filter(r=>r.exists()).flatMap(async r=>({uri:await r.uri(),fileSize:await r.size(),mtime:await r.thisOrSidecareMaxMtimeMs()})).filter(ru).get()}isVersionUpToDate(){return As(this.version,Ts)}async siblingCount(){return jg.dbl.pluckFirstf(e=>e.count().where({assetId:this.assetId}).andWhereNot({id:this.id}))}async upsertIfNeeded(){let e=u.forceSync.valueOrDefault;if(await this.matchesFile()&&N(this.id)&&!e)return this.upsert();if(await this.isFileDeleted()){this.deleted=!0,await this.delete();return}if(!await this.notExists())return x(this.updateFromFile(),()=>this.upsert())}async maybeUpdateStats(e){return x(this.fileFields(e),r=>js(this,r))}async updateFromFile(e){let r=Date.now(),i=this.logger().addContext(".updateFromFile()");if(i.debug("before",this),this.id!=null&&await this.matchesFile(e)){i.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");return}if(e!=null&&await this.setFile(e),e==null&&(e=await this.posixFile()),e==null||await e.notExists()){i.info("no-op, "+e+" is missing");return}if(this.mountpoint==null&&await x(e.mountpoint(),d=>this.mountpoint=d.nativePath),await this.maybeUpdateStats(e)==null){i.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});return}let o=e.sha(),n={},s=await _r(e);if(s==null){i.error("missing tags for "+e);return}if(T(s.MIMEType)){i.error("missing MIMEType for "+e);return}n.mimetype=s.MIMEType;let a=s.capturedAt,m=a.toLocal();if(m==null)return i.throw("bad CapturedAt",a);n.capturedAtLocal=m,n.capturedAtOffset=a.toOffset(),n.capturedAtPrecisionMs=a.toPrecisionMs(),n.capturedAtSrc=a.src,f(s.exposureSettings,d=>{n.focalLength=d.focalLength,n.aperture=d.aperture,n.shutterSpeed=d.shutterSpeed,n.iso=d.iso});let c=s.dimensions;if(n.width=c.width,n.height=c.height,n.rotation=s.rotation,n.make=s.Make,n.model=s.Model,n.cameraId=Of(s),n.imageId=f(Rf(s),g),n.lensId=kf(s),n.geohash=Xc(s.GPSLatitude,s.GPSLongitude),n.durationMs=f(s.duration,d=>Math.round(d*1e3)),n.fps=f(Wr(s.VideoFrameRate),Ze),n.sha=await o,n.sha==null){i.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri});return}(u.useImageHashes.valueOrDefault||u.strictDeduping.valueOrDefault)&&await x(gm(e),d=>{n.meanHash=d.meanHash,n.modes=d.modes}),js(this,n),this.version=Ts;let p=Date.now()-r;return i.log(p>E?"info":"debug","after ("+p+"ms)",this),this}async updateFromShaSibling(e){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:e.sha==null||!e.isVersionUpToDate()||this.sha!=null&&e.sha!==this.sha?this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e}):(js(this,kt(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt")),this)}async getAsset(){return this.assetId==null||this.asset!=null?this.asset:this.asset=await Et.ops().findById(this.assetId)}async exists(){return pe(this.posixFile(),e=>e.exists(),()=>!1)}async notExists(){return gt(this.exists())}async isFileDeleted(){return pe(this.posixFile(),e=>e.isDeleted(this.uri),()=>!1)}async isFiltered(){return bt(this.posixFile()).filter(e=>e.exists()).flatMap(e=>VA().apply(e)).map(e=>!e).getOrElse(()=>!1)}async hasNoMedia(){return pe(this.posixFile(),e=>e.hasNoMedia(),()=>!1)}async setFile(e){let r=await e.uri();if(r==null)return this.logger().throw("setFile(): no URI for "+e);let i=await e.mountpoint();if(i==null)return this.logger().throw("setFile(): no mountpoint for "+e);if(this.uri!=null&&!await $M(r,this.uri))return this.logger().throw("setFile(): cannot reassign non-equivalent URI",{prior:this.uri,new:r,file:e.nativePath});if(await e.uriObject()==null)throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);return this.uri=r,this.mountpoint=i.nativePath,this.posixFile.set(Promise.resolve(e)),r}nativePath(){return x(this.posixFile(),e=>e.nativePath)}toCapturedAt(){return f(lc(this.capturedAtLocal,this.capturedAtOffset),e=>x(this.posixFile(),r=>new Oa(r.nativePath,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}async downloadables(e,r){try{let i=await this.posixFile();if(i==null)return[];let o=e.ap(this.assetId),n=[];if(await i.isNonEmpty()&&n.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:og(i,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:i.base,description:"Download original",details:`(${kr(this)} ${i.ext})`}),this.isVideo||!(B(this.shown)||this.sha===r))return n;let a=A(await Promise.all([...await o.previews()].reverse().filter(m=>m.reducer===qt.fit).map(m=>yD(i.base,m))));return n.push(...hr(a,m=>m.size)),n}catch(i){return se("AssetFile.downloadables failed",i,{context:this}),[]}}async pathInfo(){try{let e=Le.parse(this.uri),r=await us(e,this.mountpoint);if(r==null){this.logger().warn("pathInfo(): failed to build nativePath",{uri:this.uri});return}let i=e.fsPath,o=ir(r,i).split(Ms.sep),n=o.pop(),s=i.split(Ms.sep),a=Wg(e),m=await Pe.findByPath(a);if(m==null){this.logger().warn("pathInfo(): failed to find existing Tag",{tagPath:a});return}let c=await m.toApiPathElements();this.logger().info("pathInfo()",{uri:this.uri,fsPath:i,nativePath:r,mountpointParent:o,pathAfterMountpointParent:s,mountpointName:n,tag_path:m.path,pathElements:c}),c.shift(),T(n)?c.shift():c[0].displayName=n,s.splice(0,c.length);let p={nativePath:r,nativePathPrefixWbr:Nb(o.join(Ms.sep)+Ms.sep),pathElements:c,nativePathSuffix:s.join(Ms.sep),pathSep:Ms.sep,exists:await this.exists()};return this.logger().info("pathInfo()",{result:p}),p}catch(e){this.logger().warn("pathInfo(): failed",e);return}}async toApi(e,r){return x(this.pathInfo(),async i=>qo(w(w({assetId:this.assetId,assetFileId:this.id},i),{mimetype:this.mimetype,shown:B(this.shown),width:this.width,height:this.height,rotation:M(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:await this.downloadables(e,r),createdAtLocale:WA(this.createdAt),updatedAtLocale:WA(this.updatedAt)})))}get isVideo(){return $t(this.mimetype)}},Tt=jg;Tt.tableName="AssetFile",Tt.uniqueColumnName="uri",Tt.booleanFields=["shown"];function WA(t){return f(t,e=>Dm(Date.now()-e,1)+" ago")}var ei=class extends Bo{$pk(){return[M(this.assetId,()=>f(this.asset,e=>e.id)),M(this.tagId,()=>f(this.tag,e=>e.id))].join(":")}static addTagsToAsset(e,r){let i=ep(e);if(i==null){this.logger().warn("addTagsToAsset(): got null assetId");return}let o=A(r.map(ep));if(L(o)){this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:r});return}let n="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+o.map(s=>`(${i},${s})`).join(",");return this.dbl.run(n)}static removeTagsFromAsset(e,r){r=A(r);let i=this.query().whereIn("tagId",r).andWhere({assetId:e}).delete();return this.dbl.run(i)}};ei.tableName="AssetTag",ei.uniqueColumnName="assetId,tagId";function _f(t){return{id:t.id,at:t.capturedAtLocal}}var Hg=class{constructor(e,r,i,o){this.tags=e;this.before=r;this.after=i;this.limit=o;this.logger=()=>h("TaggedAssetStream("+this.toString()+")");this.logger().info("new",this.toJSON())}vacuum(){kn(this.before,e=>[-e.capturedAtLocal,-e.id]),wb(this.before,this.limit),kn(this.after,e=>[-e.capturedAtLocal,-e.id]),xb(this.after,this.limit)}toString(){return this.tags.map(e=>e.path.join("/")).join(",")}valueOf(){return this.toString()}get length(){return F(this.before).length+F(this.after).length}leftPad(e){return[...ce(this.limit-e.length,r=>({id:-(r+1),v:0})),...e]}rightPad(e){return[...e,...ce(this.limit-e.length,r=>({id:-(r+this.limit+1),v:0}))]}toJSON(){return{tags:this.tags.map(e=>e.toString()),assetIdsAfter:this.after.map(_f),assetIdsBefore:this.before.map(_f)}}mergeWith(e){Km(this.tags,e.tags,r=>r.path),Km(this.before,e.before,r=>r.id),Km(this.after,e.after,r=>r.id),this.logger().debug("mergeWith() complete",{tas:e.toJSON(),tags:this.tags.map(r=>r.path),beforeIds:this.before.map(_f),afterIds:this.after.map(_f)})}async toApi(){return this.vacuum(),this.logger().tap({msg:"toApi()",result:{tags:await le(this.tags,e=>e.toApiTag()),assetIdsAfter:this.leftPad(this.after.map(e=>e.toID())),assetIdsBefore:this.rightPad(this.before.map(e=>e.toID()))}})}streamCoeff(e){return this.logger().tap({msg:"streamCoeff",meta:{this:this.tags.map(r=>r.path),tas:e.tags.map(r=>r.path)},result:hb([...this.before,...this.after],[...e.before,...e.after],r=>r.id)})}};function jA(t){let e=u.minStreamCorrPct.valueOrDefault/100,r=[],i=t.filter(o=>o.length>5);for(let o of i){let n=et(r,s=>_y(s.streamCoeff(o),e));n==null?r.push(o):n.mergeWith(o)}return r}var Dt=class extends cr{constructor(){super(...arguments);this.attrs={};this.urls=l(()=>new vn(this.toID()))}static shownUnhidden(e){return M(e,()=>Dt.query()).andWhere({shown:1,hidden:0,excluded:0})}static shownCount(){return this.ops().countf(e=>e.where({shown:1,excluded:0}))}static outdatedQuery(){return this.query().where("version","<",qa).andWhere({shown:1,excluded:0})}static deletePreviews(e){return ti.instance().previews().ap(e).deleteAll()}static async delete(e){this.logger().warn("Deleting asset "+e),await ei.dbl.runf(r=>r.delete().where({assetId:e})),await Tt.dbl.runf(r=>r.delete().where({assetId:e})),await Dt.dbl.runf(r=>r.delete().where({id:e})),await Dt.deletePreviews(e)}static async exclude(e){return this.logger().info("Excluding asset "+e),{dbResult:await Dt.dbl.runf(r=>r.update({excluded:1}).where({id:e})),deletedPreviews:await Dt.deletePreviews(e)}}static nextOutdated(e=Ar){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=Ar){return this.dbl.pluckFirst(e(this.outdatedQuery()).count())}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static async addTags(e,r){let i=hr(r.filter(C),o=>ur(o));return this.logger().debug("addTags()",{assetId:e,tagPaths:r,uniqTagPaths:i}),L(i)?void 0:Dt.tx(async()=>{let n=(await le(i,s=>Pe.findOrCreate(s))).map(s=>s.id);return ei.addTagsToAsset(e,n)})}static async removeTags(e,r){if(L(r))return;let i=await le(r,o=>Pe.findByPath(o));return this.logger().info("removeTags()",{assetId:e,tags:i.map(o=>at(o,"id","path")),tagPaths:r}),ei.removeTagsFromAsset(e,A(i.map(o=>o.id)))}static unshownAssetIds(){return this.dbl.pluckAll(`
        SELECT DISTINCT af1.assetId
        FROM AssetFile af1
          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 
            ON af1.assetId = af2.assetId
        WHERE af2.assetId IS NULL`)}static archive(e){return this.tx(async()=>{await Dt.ops().findById(e)!=null&&(await ei.dbl.runf(i=>i.where({assetId:e}).delete()),await Tt.dbl.runf(i=>i.where({assetId:e}).delete()),await Dt.dbl.runf(i=>i.where({id:e}).delete()))})}get capturedAt(){return zd(this.capturedAtLocal)}get capturedAtMs(){return Hl(this.capturedAtLocal)}markUnshownAndUpsert(){return this.shown=!1,this.version=qa,this.upsert()}markShownAndUpsert(){return this.shown=!0,this.excluded==null&&(this.excluded=!1),this.version=qa,this.upsert()}toAssetId(){return{assetId:this.id,capturedAtLocal:this.capturedAtLocal}}renderCaption(e){return f(this.capturedAtMs,r=>"Taken "+YD(r,e))}async whenApiTag(){return bt(this.capturedAt).flatMap(e=>Ng(e)).flatMap(e=>Pe.findOrCreate(e)).flatMap(e=>e.toApiTag()).get()}addTagPaths(e){return Dt.addTags(this.id,e)}async findAssetFileByUri(e){return await this.getFiles(),this.files.find(r=>r.uri===e)}async addAssetFile(e){return await this.findAssetFileByUri(e.uri)==null&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}static getTags(e){return Pe.ops().all(Pe.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}async getTags(){return this.tags==null&&(this.tags=await Dt.getTags(this.id)),this.tags}static getTagPaths(e){let r=Pe.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return Pe.dbl.pluckAll(r)}async tagPaths(){return(await this.getTags()).map(r=>r.path.join("/")).sort()}async getStreams(e){if(this.streams==null){let r=await this.getTags();this.logger().info("getStreams(): fetched tags "+r,{limit:e});let i=await le(r,o=>o.getAssetStream(this,e));this.streams=jA(A(i));for(let o of this.streams)for(let n of o.tags)await n.getAncestors()}return this.streams}async getBeforeAfterId(){let e=await Dt.dbl.all(Dt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id"));this.afterId=f(e.find(r=>r.id>this.id),Wa),this.beforeId=f(e.reverse().find(r=>r.id<this.id),Wa),await Re(this.beforeId,()=>this.getBeforeId()),await Re(this.afterId,()=>this.getAfterId())}async getBeforeId(){return x(Dt.dbl.first(Dt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}])),e=>this.beforeId=Wa(e))}async getAfterId(){return x(Dt.dbl.first(Dt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}])),e=>this.afterId=Wa(e))}async getTagPaths(){return(await this.getTags()).map(r=>r.path)}async getFiles(){if(this.files!=null)return this.files;if(this.id==null)return this.files=[];let e=await Tt.ops().findBy({assetId:this.id});return this.files=$(e,r=>[!B(r.shown),-r.mtime])}async setShown(e){return Tt.setShown(this.id,e)}async getShown(){if(this.files!=null){let e=this.files.find(r=>B(r.shown));if(e!=null)return e}return x(Tt.ops().findOneBy({assetId:this.id,shown:1}),e=>vt(e,r=>r.asset=this))}async getCapturedAts(){return le(this.getFiles(),e=>e.toCapturedAt())}link(){return"/asset/"+this.id}sqAttrs(e=!0){return w(w(w({},this.urls().sqImgAttrs(e)),{title:this.renderCaption()}),this.attrs)}async getImgAttrs(e,r,i=!1){if(this.imgAttrs==null&&(this.imgAttrs=new Map),this.imgAttrs.get(r)==null){let o=e.ap(this.toID());await x(o.readInfo(),async s=>{s.mimetype.startsWith("video/")&&(this.poster=await o.posterLink())});let n=!0;this.imgAttrs.set(r,await o.imgAttrs(r,n,i))}return this.imgAttrs.get(r)}async fitAttrs(e){return w(w({},await this.getImgAttrs(e,qt.fit)),this.attrs)}isVideo(){if(this.files==null)throw new Error(".video called before getFiles()");return this.files.some(e=>e.isVideo)}videoAttrs(){return w({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(this.existingFiles==null)throw new Error(".videoSources called before getExistingFiles()");let e=this.existingFiles.filter(i=>i.isVideo).map(i=>({src:this.urls().videoLink(i.id),type:i.mimetype})),r=hr(e,i=>i.type);if(r.every(i=>i.type!=="video/mp4")){let i=this.existingFiles[0];r.unshift({src:this.urls().videoLink(i.id)+".mp4",type:"video/mp4"})}return r}async getPosixFiles(){let e=await this.getFiles();return A(await Promise.all(e.map(r=>r.posixFile())))}async getExistingAssetFiles(){return this.existingFiles==null&&(this.existingFiles=await Oi(await this.getFiles(),e=>pe(e.posixFile(),r=>r.exists(),()=>!1))),this.existingFiles}async findOrCreateByFile(e){let r=await e.uri();if(r==null)return;let i=F(await Tt.findByAsset({id:this.id},{uri:r}))[0];return M(i,async()=>{let o=new Tt;return o.asset=this,o.assetId=this.id,await o.setFile(e),o})}clear(){return this.existingFiles=void 0,this.files=void 0,this.imgAttrs=void 0,this.streams=void 0,this.tags=void 0,this}async setHidden(e){return this.hidden=e,this.upsert()}},Et=Dt;Et.tableName="Asset",Et.uniqueColumnName="id",Et.booleanFields=["shown","hidden","excluded"],Et.shownAssetCounts=l(()=>Dt.dbl.pluckFirst({sql:Ei("SELECT","  COUNT(DISTINCT Asset.id)","FROM Asset","WHERE","  Asset.shown = 1","  AND Asset.excluded = 0","  AND hidden = 0")}),7*E);function HA(t){return t.orderByRaw("COALESCE(ordinal, _path) COLLATE NOCASE")}j(()=>Pe.clear());async function GA(t){let e=await t;return e!=null&&Pe.cacheTag(e),e}var fe=class extends cr{constructor(){super(...arguments);this.urls=l(()=>new Vg(this.id));this.displayPath=l(async()=>{let e=await this.getParent();return[...e==null?[]:await e?.displayPath(),this.displayName]});this.descendantIds=l(async()=>fe.dbl.pluckAll({sql:Ei("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT id ","FROM descendants","WHERE id <> :tagId"),bindings:{tagId:this.id}}),7*E);this.ancestorIds=l(async()=>this.parentId===0||this.parentId==null?[]:fe.dbl.pluckAll({sql:Ei(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT id","FROM Tag","WHERE Tag.id in ancestors","  AND Tag.id <> :tagId","ORDER BY _path DESC"].join(" ")),bindings:{tagId:this.id}}))}static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this.recentTagsByPath.clear(),this.tagById.clear()}static cacheTags(e){return e.map(r=>this.cacheTag(r))}static cacheTag(e){return e!=null&&this.recentTagsByPath.set(e._path,Promise.resolve(e)),e?.id!=null&&this.tagById.set(e.id,Promise.resolve(e)),e}static newTag(e){let r=new fe;r._path=ur(e);let i=e[e.length-1];return i!=null&&Vm(i)&&(f(i.displayName,o=>r._displayName=o),f(i.ordinal,o=>r.ordinal=o),f(i.description,o=>r.description=o),f(i.releasedAt,o=>r.releasedAt=o)),r}static findByIdOrPath(e,r){return e===0?fe.root():N(e)?this.findById(e):this.findByPath(r)}static findById(e){return e===0?fe.root():fe.tagById.getOrSet(e,()=>GA(this.ops().findById(e)))}static async findByPath(e){let r=ur(e);return T(r)?fe.root():fe.recentTagsByPath.getOrSet(r,()=>x(this.ops().firstf(i=>i.where("_path","like",r)),i=>fe.cacheTag(i)))}static getPagedAssets(e,r){let i=new fe;return i.id=e,i.getPagedAssetIds(r)}static async findOrCreate(e){if(L(e))throw new Error("empty tagPath");let r=ur(e,"/"),i=await this.findByPath(e);if(this.logger().debug("_findOrCreate("+r+")",{prior:i}),i!=null)return i;let o=this.newTag(e),n=o.depth<=1?void 0:await this.findOrCreate(e.slice(0,-1));f(n,a=>o.parentId=a.id);let s=await GA(this.ops().upsertOne(o));return this.logger().debug("_findOrCreate("+r+") upserted",{newTag:o,result:s,parent:n}),s}clear(){return this.parent=void 0,this.root=void 0,this.children=void 0,this.ancestors=void 0,this.assets=void 0,this.relatedAssets=void 0,this.ancestorIds.unset(),this.descendantIds.unset(),this}siblingPath(e){return ur([...this.parentPath,e])}async changeName(e){return this.changePath(this.siblingPath(e))}maybeUpsertDisplayName(e){return T(e)||e===this._displayName?void 0:this.upsert({_displayName:e})}async changePath(e,r=!0){let i=this._path,o=await fe.findByPath(Pn(e));this.logger().info("changePath(): ",{priorPath:i,newPath:e,existingSibling:o});try{o==null?(await fe.tx(async()=>{await fe.dbl.runf(n=>n.where("_path","LIKE",i+"%").update({updatedAt:Date.now(),_path:$i.raw("REPLACE(_path, ?, ?)",[i,e])}))}),this._path=e):(e=o._path,this.logger().info("changePath(): replacing with sibling",e),await ei.dbl.updateOrIgnore(n=>n.where({tagId:this.id}).update({tagId:o.id})),await ei.dbl.runf(n=>n.where({tagId:this.id}).delete()),await le(this.getChildren(),n=>n.changePath(ur([...o.path,n.name]),!1)),await fe.dbl.runf(n=>n.where({parentId:this.id}).update({parentId:o.id})),await this.delete())}finally{r&&fe.clear()}}get name(){let e=this.path;return e[e.length-1]}get path(){return Pn(this._path)}get displayName(){return v(this._displayName)?this._displayName:this.name}get isRoot(){return this.id===0}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}get sortBy(){return[this.ordinal==null?2**51:this.ordinal,this.path.map(e=>e.toLowerCase())]}$childrenQuery(){return HA(fe.query().where({parentId:this.id}))}$assetsQuery(){return Et.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],f(this.parent,r=>r.setAncestors(e.slice(0,-1)))}async toApiPathElements(){return le(this.getAncestorsAndSelf(),e=>({tagPath:e.path,displayName:e.displayName}))}async toApiTag(){return{tagId:this.id,tagPath:this.path,displayPath:await this.displayPath(),description:this.description,assetCount:this.assetCount,assetFileCount:this.assetFileCount}}toStringId(){return"Tag("+this.path.join("/")+")"}async getParent(){if(!this.isRoot)return this.parentId!=null&&this.parent==null?this.parent=await fe.findById(this.parentId):this.parent}async getPagedChildren(e){if(this.id===0){let o=M(e.offset,0),n=o+M(e.limit,this.children.length);return[...this.children].slice(o,n)}let r=this.$childrenQuery();ge(e.offset,o=>{r.offset(o)}),ge(e.limit,o=>void r.limit(o));let i=await fe.ops().all(r);for(let o of i)fe.cacheTag(o);return i}async getDescendants(){return fe.ops().all({sql:Ei("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN descendants","  AND Tag.id <> :tagId"),bindings:{tagId:this.id}})}async getChildrenCount(){return this.children!=null?this.children.length:fe.dbl.pluckFirstf(e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count())}async getChildren(){return this.children=await fe.ops().all(this.$childrenQuery()),this.children.forEach(e=>{e.parent=this}),this.children}link(){return"/tag/"+this.path.map(encodeURIComponent).join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}async getAncestors(){if(this.ancestors==null){let e=Mb(this.parentPath).map(o=>ur(o)),r=await Promise.all(e.map(o=>fe.recentTagsByPath.get(o)));if(r.every(o=>o!=null))return this.ancestors=r;let i=fe.query().whereIn("_path",e).orderBy("_path");this.ancestors=await fe.ops().all(i),fe.cacheTags(this.ancestors),this.parent=M(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}async getAncestorsAndSelf(){return[...await this.getAncestors(),this]}async _getAncestors(){return this.parentId===0||this.parentId==null?[]:fe.ops().all({sql:Ei(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN ancestors","  AND Tag.id <> :tagId","ORDER BY Tag._path DESC"].join(" ")),bindings:{tagId:this.id}})}getPagedAssetIds(e){let r=this.$assetsQuery().select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal"),i="desc";return Go(e.capturedAtLt,o=>{r=r.where("capturedAtLocal","<",o)}),Go(e.capturedAtGt,o=>{r=r.where("capturedAtLocal",">",o),i="asc"}),Go(e.limit,o=>{r=r.limit(o)}),r=r.orderBy("capturedAtLocal",i),Et.dbl.all(r)}getAssets(){let e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return Et.ops().all(e)}async assetCountDesc(e){let r=this.assetCount;return(r==null||e==null||e.length===r||e.length===0?"":su(e.length)+" of ")+lu(r,"asset")}$assetStreamQuery(e,r,i){let o=this.path[0]===ne.When?Et.shownUnhidden():this.$assetsQuery();return o=o.distinct().where("capturedAtLocal",i,e.capturedAtLocal).andWhereNot("Asset.id",e.id).limit(i==="="?r*2:r),i==="="?o.orderByRaw(`ABS(Asset.id-${e.id})`):o.orderBy([{column:"capturedAtLocal",order:i===">"?"asc":"desc"},"Asset.id"])}async getAssetStream(e,r){r=N(r)?r:rA;let[i,o,n]=await le(["<","=",">"],s=>Et.ops().all(this.$assetStreamQuery(e,r,s)));for(let s of o)s.id<e.id?i.push(s):n.push(s);return new Hg([this],i,n.reverse(),r)}async getRelatedAssetIds(e,r=tA){let i=Math.max(256,await j1()),o=await ei.dbl.allf(n=>n.select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal").distinct().join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).andWhere("Asset.excluded",0).andWhere("Asset.hidden",0).orderByRaw(RA(e+M(this.id,0),"Asset.id",i)).limit(r));return this.logger().debug(this.path+": Found "+o.length+" related assets",o),o}get attrs(){return{href:this.link(),title:this.name}}},Pe=fe;Pe.tableName="Tag",Pe.uniqueColumnName="_path",Pe.recentTagsByPath=new _e(256),Pe.tagById=new _e(256,D),Pe.cmp=(e,r)=>Xt([M(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[M(r.ordinal,Number.MAX_SAFE_INTEGER),...r.path]),Pe.root=l(async()=>{let e=new fe;return e.id=0,e._path=Qi,e.parentId=void 0,e.children=(await fe.roots()).filter(r=>!_t(u.hiddenHomeTags.valueOrDefault,r.name)),e.ancestors=[],e.assetCount=await Et.shownAssetCounts(),e.upsert=()=>{throw new Error("upsert not supported on root")},e},7*E),Pe._upsertDefaultRoots=l(()=>fe.ops().upsert(aA.map(e=>({_path:ur([e.name]),ordinal:e.ordinal})))),Pe.roots=l(async()=>{await fe._upsertDefaultRoots();let e=await fe.ops().all(HA(fe.query().whereNull("parentId")));return e.forEach(r=>{r.parentId=void 0,r.ancestors=[],fe.cacheTag(r)}),e});var j1=l(()=>Et.dbl.pluckFirstf(t=>t.count()),D);var H1=`'${ne.When}' || char(31)`,G1=H1+" || '%' || char(31)",KA=G1+" || '%' || char(31)",K1=KA+" || '%' || char(31)",JA=l(()=>h("DateTagNormalizer"));async function J1(){return Pe.ops().allf(t=>t.whereNotNull("ordinal").andWhereRaw("_path LIKE "+KA+" AND _path NOT LIKE "+K1).limit(200*12))}async function $A(){await Pe.tx(async()=>le(J1(),$1))}async function $1(t){let e=await ge(t.ordinal,r=>_g(IA(r)));e==null?JA().warn("failed to fix tag (no monthTagRef)",{t}):e.name!==t.name&&(JA().info("Fixing month name",{tagRef:e,tag:t}),await t.changeName(e.name)),await t.maybeUpsertDisplayName(e?.displayName)}var QA=S(require("os")),YA=S(require("process"));var Gg=he("rebuildLibrary","forceRestartSync","enqueueAssetFileUpdates","enqueueAssetUpdates","applyNewTagger"),Kg=class extends cr{static incomplete(){return this.ops().allf(e=>e.whereIn("id",r=>r.table(Kg.tableName).min("id").whereNull("completedAt")))}static async getFirstPendingOp(e){return this.logger().tap({msg:"getFirstPendingOp",level:"info",result:await this.ops().firstf(r=>{let i=r.whereNull("completedAt").orderBy("createdAt","asc");return e!=null?i.andWhere(e):i}),meta:{pojo:e}})}static markOpCompleted(e){return T(e?.name)?this.logger().throw("markOpCompleted(): bad query",{query:e}):this.dbl.runf(r=>r.whereNull("completedAt").andWhere(e).update({completedAt:Date.now()}))}static async applyOnce(e,r,i=Ar){let o=await this.ops().firstf(a=>i(a.whereNotNull("completedAt").andWhere(e)));if(o!=null){this.logger().info("applyOnce(): already done",{prior:o});return}let n=await this.ops().insertOne(e),s=await r(n);return me()||await n.upsert({completedAt:Date.now()}),s}},ja=Kg;ja.tableName="Operation",ja.uniqueColumnName="id";var N_e=he("lastScannedDirectory","scannedDirectoryCount","completedDirectoryScan","enqueuedStaleFiles","processedImageCount","processedVideoCount"),Dn=class extends cr{};Dn.tableName="ProgressMeta",Dn.uniqueColumnName="progressId,name";var tNe=l(()=>E*(Ft()<=3?3:1.5)),Q1=Ei(`
SELECT
  p1.uri as uri,
  p1.lastUpdatedAt as lastUpdatedAt,
  p1.lastCompletedAt as lastCompletedAt,
  min(p2.createdAt) AS lastStartedAt
FROM
  (
    SELECT
      uri,
      max(updatedAt) AS lastUpdatedAt,
      max(completedAt) AS lastCompletedAt
    FROM
      Progress
    WHERE
      createdAt > :minCreatedAt
    GROUP BY
      uri
  ) AS p1
  JOIN Progress AS p2
    ON 
      p2.uri = p1.uri AND 
      p2.createdAt > :minCreatedAt AND
      (p2.createdAt > ifnull(p1.lastCompletedAt, 0) OR p2.completedAt = lastCompletedAt)
GROUP BY
  1,2,3
`),Y1=Ei(`
SELECT
  *
FROM
  ProgressMeta
WHERE
  id IN (
    SELECT
      max(pm.id)
    FROM
      ProgressMeta pm
      JOIN Progress p ON pm.progressId = p.id
      AND p.createdAt > :minCreatedAt
    WHERE
      p.uri = :uri
      AND p.hostname = :hostname
    GROUP BY
      p.uri,
      pm.name
  )
`),Nf=class extends cr{static async vacuum(e=90*ot){await Dn.dbl.runf(r=>r.whereIn("progressId",i=>i.table("Progress").select("id").where("createdAt","<=",Date.now()-e)).delete()),await this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async minCreatedAt(){let e=await ja.getFirstPendingOp({name:Gg.forceRestartSync});return Nf.logger().tap({msg:"minCreatedAt",level:"info",result:M(e?.createdAt,0),meta:{op:e}})}static async times(){let e=await this.minCreatedAt();return this.dbl.all({sql:Q1,bindings:{minCreatedAt:e}})}static async saveSyncState(e){return le(F(await e.progress()),r=>(r.state==="done"&&r.completedAt==null&&(this.logger().warn("caller saved done sync state without setting completedAt",Lu()),r.completedAt=Date.now()),r.id==null?this.logger().throw(e.name+" returned an unsaved Progress",r):r.upsert()))}static async insertNew(e,r){return this.ops().insertOne({uri:e,volume:r,pid:YA.pid,hostname:(0,QA.hostname)()})}toSyncState(){return{id:this.id,uri:this.uri,volume:this.volume,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return M(U(this.dekJSON,()=>R(JSON.parse(this.dekJSON))),()=>[])}set dek(e){this.dekJSON=k(R(e))}assignFromPojo(e){return No(this,e)}getThisMeta(){return Dn.ops().allf(e=>e.where({progressId:this.id}).orderBy("createdAt"))}async getMeta(){return Dn.ops().all({sql:Y1,bindings:{minCreatedAt:await Nf.minCreatedAt(),uri:this.uri,hostname:this.hostname}})}setMeta(e,r){return Dn.ops().upsertOne({progressId:this.id,name:e,value:r})}async getMetaAsRecord(){return st((await this.getMeta()).map(e=>[e.name,e.value]))}},Ha=Nf;Ha.tableName="Progress";var vs=l(()=>h("TagSql")),Jg,$g=l(()=>new wm(Ca,"Tag")),Bf=l(async()=>{if(Er&&Date.now()-Us<20*E)return;await Z1();let t=await $g().pluckFirst({sql:"SELECT MAX(rowid) FROM AssetTag"});vs().info("updateTagCounts()",{newMax:t,lastMax:Jg}),t!==Jg&&(Jg=t,await mt("db.updateTagCounts",()=>X1()))},7*E);function eC(t=il(6)){let e=`temp.ct_${t}`,r=`temp.taf_${t}`,i=`temp.tag_counts_${t}`;return jD(`
CREATE TABLE ${e} AS
SELECT
  DISTINCT t.id AS parentId,
  kid.id AS childId
FROM
  Tag t
  JOIN Tag kid ON kid._path LIKE (t._path || '%');

CREATE INDEX ${e}_idx ON ${e.replace(/^temp\./,"")}(parentId, childId);

CREATE TABLE ${r} AS
SELECT
  DISTINCT AssetTag.tagId as tagId,
  Asset.id AS assetId,
  AssetFile.id AS assetFileId
FROM
  AssetTag
  JOIN Asset ON AssetTag.assetId = Asset.id
  JOIN AssetFile ON AssetFile.assetId = Asset.id
WHERE
  Asset.hidden = 0
  AND Asset.excluded = 0
  AND Asset.shown = 1;

CREATE INDEX ${r}_idx ON ${r.replace(/^temp\./,"")}(tagId, assetId, assetFileId);

CREATE TABLE ${i} AS
SELECT
  parentId AS tagId,
  count(DISTINCT assetId) AS ac,
  count(DISTINCT assetFileId) AS afc
FROM
  ${e}
  JOIN ${r} ON childId = tagId
GROUP BY
  1;

CREATE INDEX ${i}_idx ON ${i.replace(/^temp\./,"")}(tagId, ac, afc);

-- Update used tags:

UPDATE Tag SET 
  assetCount = NULL,
  assetFileCount = NULL;

UPDATE Tag
SET
  assetCount = ac,
  assetFileCount = afc
FROM ${i}
WHERE tagId = id;

-- Clean up:

DROP INDEX IF EXISTS ${e}_idx;
DROP INDEX IF EXISTS ${r}_idx;
DROP INDEX IF EXISTS ${i}_idx;
DROP TABLE ${e};
DROP TABLE ${r};
DROP TABLE ${i};
`)}async function X1(){$g().db()==null&&vs().throw("updateTagCounts(): modelDb is unset",{retriable:!1});try{let t=il(6),e="_"+t,r=await la($g().runScript(eC(t),e)),i=Z(7*E,5*D,r.elapsedMs*20);vs().info("Updated tag counts",{elapsedMs:r.elapsedMs,newTTL:i}),Bf.setTTL(i),await tC()}catch(t){vs().warn("Failed to update tag counts",t)}}async function tC(t=Date.now()-10*D){let e=[-1];for(let r of io(0,5)){let i=await rC(t);if(L(i)||to(e,i))return;e=i}}async function rC(t){let e=await Pe.dbl.pluckAllf(r=>r.select("Tag.id").leftOuterJoin("AssetTag","AssetTag.tagId","Tag.id").leftOuterJoin($i.raw("Tag AS child ON child.parentId = Tag.id")).whereNull("AssetTag.assetId").andWhere(i=>i.whereNull("child.id")).andWhere(i=>i.whereNull("Tag.assetCount")).andWhere("Tag.createdAt","<",t).orderBy("Tag._path","asc"));vs().debug("vacuumLeafTags()",{candidates:e});for(let r of e)try{await Pe.dbl.runf(i=>i.where({id:r}).delete())}catch(i){vs().info("vacuumLeafTags(): failed to delete",{tagId:r,err:i})}return vs().info("vacuumLeafTags() complete.",{candidates:e}),e}async function Z1(){let t=h("updateTagMountpoints()"),e=await Pe.findByPath([ne.FS]);if(e==null){t.info("No root filesystem tag");return}await e.maybeUpsertDisplayName(u.tagDisplayNameFS.valueOrDefault);let r=await Ot();if(r==null){t.warn("no-op: volumes() returned null");return}for(let i of await e.getChildren()){if(i.name===Df){i.ordinal!==1&&await i.upsert({ordinal:1});continue}let o,n=r.find(s=>v(s.uuid)&&ls(s.uuid)===i.name);n!=null?o=Zt(n.label,n.mountpoint):o=await Tt.dbl.pluckFirstf(s=>s.select("mountpoint").where("uri","LIKE","psfile://"+i.name+"/%").limit(1)),o!=null?(await i.maybeUpsertDisplayName(o),t.info("updated tag",{id:i.id,path:i.path,displayName:o}),Pe.clear()):t.debug("cannot update tag: no current volume.",{id:i.id,path:i.path})}}var Am=class{constructor(e,r,i){this.dataDir=e;this.isLockOwner=r;this.localDbDir=i;this.endTimeoutMs=D;this.end=l(()=>f(this.backup.value,e=>e.end()));this.setup=l(async()=>{try{await this._setup(),this.logger.info("ModelDb reading from "+this.db.value?.dbfile)}catch(e){this.db.reject(e),this.backup.reject(e),this.logger.throw(e,{fatal:!0,from:"ModelDbJanitor.setup"})}});this.beforeBackup=async()=>{me()||!Te&&ai()&&await Mr(Ca(),async()=>{await Va.vacuum(),await Ha.vacuum(),await Bf()})};this.onBackupFinished=async()=>{!me()};this.onMigration=l(async()=>{this.logger.info("onMigration: removing prior stats db to clear prior work queues"),await x(Lf(!1),r=>r.rmrf("info"))});this.backupAndMigrate=async()=>ai()||await this.isLockOwner();this.name="ModelDbJanitor("+e+")",this.logger=h(this.name),this.db=new gr(this.name+".db"),this.backup=new gr(this.name+".backup"),this.srcDbFile=Ba(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),UT(this),this.setup()}static async for(e,r,i=EA){let o=new Am(e,r,i);return await o.setup(),o}get ended(){return this.end.prior()!=null}async _setup(){if(u.forceLocalDbReplica.valueOrDefault||await x(xa(this.srcDbFile.nativePath),r=>r.remote)===!0){let r=await this.localDbDir();return this.localDbReplica=Ba(r,"models"),this.logger.info("Library on remote drive. Using local db replica.",{src:this.srcDbFile.nativePath,local:this.localDbReplica}),await this.backupAndMigrate()&&(this.logger.info("Setting up local model db replica...."),await this.localDbReplica.parent().rmrf("info"),await this.srcDbFile.clear().exists()&&(await this.srcDbFile.copyFile_(this.localDbReplica),await this.localDbReplica.chmod(420)),this.logger.info("Local model db replica set up at "+this.localDbReplica)),this._finishSetup(r,this.srcDbFile.parent())}else return this._finishSetup(this.dataDir)}async _finishSetup(e,r){let i=await this.backupDir.mkdirp();if(i==null)throw new Error("Failed to create models DB backup dir "+this.backupDir);let o=new vm("models",e,this.onMigration),n=await this.backupAndMigrate();n?(await o.migrate(),this.backup.resolve(new Rg(o,this.backupAndMigrate,o.dbfile,i,r,this.beforeBackup,this.onBackupFinished))):this.backup.resolve(void 0),zD(o),this.db.resolve(o),n&&(await $A(),await Bf()),this.logger.info("Finished setup",{primaryDbDir:e,replaceDbDir:r,backupDir:i})}};var XA=l(()=>{pM(sl()?iC:void 0),OM(sl()?oC:void 0)}),iC=async()=>await _a()?f(Sn(),t=>t.request("mountpoints")):void 0,oC=async()=>await _a()?f(Sn(),t=>t.request("volumes")):void 0;var nC;function ZA(t){nC=t}async function e0(t){let e=new vm("stats",t);return ab()&&(await e.migrate(),new Sm({name:"statsDbJanitor vacuum",callback:()=>e.vacuum(),intervalMs:Te?20*E:5*D,rank:be.service})),ZA(e),e}function sC(t){return t.toDateTime().toFormat(u.assetSubdirectoryDatestampFormat.valueOrDefault).split("/")}var Qg=class{constructor(e,r){this.root=e;this.copyAssets=r;this.logger=h("AssetFileRepository")}directoryForDate(e){return this.root.join(...sC(e))}async importFile(e){let r=this.copyAssets();if(this.logger.debug("importFile()",{file:e,copyAssets:r}),!r||await ji())return e;if(await e.isDescendantOf(this.root))return this.logger.debug("no-op: "+e+" already contained by "+this.root),e;this.logger.debug("importing "+e);let i=await _r(e);if(i==null)throw new Error(e.nativePath+" has no tags (so, no createdAt)");let o=f(i.capturedAt,d=>kh(d.date));if(o==null)throw new Error(e.nativePath+" has no capturedAt");if(o.year==null||o.month==null||o.day==null)return this.logger.warn("Insufficient capturedAt precision to copy "+e+" into library.",{capturedAt:i.capturedAt}),e;let n=this.directoryForDate(o);if(await n.mkdirp()==null)throw new Error("Cannot create destination directory, "+n.nativePath+" for "+e.nativePath);let s=await n.children(),a=await e.size(),m=await Sl(s,d=>d.size().then(y=>y===a)),c=await e.sha();if(m.length>0){let d=await Sl(m,y=>y.sha().then(P=>P===c));if(d.length>0){let y=d[0];return this.logger.info(e+" matches "+y),this.handleSidecars(e,y)}}let p=await n.join(e.base).ensureNew_();return this.logger.info("Copying...",{src:e.nativePath,dest:p.nativePath}),await e.copyFile_(p),this.handleSidecars(e,p)}async handleSidecars(e,r){let i=M(await e.sidecars(),[]);for(let o of i)await this.handleSidecar(o,r);return C(i)&&Fr(r.nativePath),r}async handleSidecar(e,r){for(let o of M(await r.sidecars(),[]))if(await CE(e,o)){this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:o,dest:r});return}let i=await r.parent().join(r.name+e.ext).ensureNew_({emptyIsNew:!0});return e.copyFile_(i)}};var ti=class extends Pt{constructor(e){super(`Library(${e})`,()=>this.onEnd(),be.predb);this.start=Date.now();this._ready=new Gt;this.setup=l(async()=>{let e=()=>{if(this.ended||me())throw new Error};try{if(this.logger.debug("setup() started"),!Ro()){if(!nb())throw new Error("Cannot run "+Dr()+" without a library"+ye+ho);this.logger.warn("Library settings don't exist yet. Skipping setup.");return}await this.openedBy().throwIfUnavailable("(library setup)"),e(),await ah(this.rootDir),await pf(this.rootDir.nativePath);let r=this.originalsDir();if(r==null||await r.mkdirp()==null||!await r.isReadWritable())throw new Error(`Invalid value for ${u.originalsDir.key}: ${r} must be readable and writable.`);await this.statsDbDir(),await lm(),e(),xD(ND),sl()&&await _a()&&(await OD(),XA()),e(),await this.modelDb(),e(),sb()&&await this.statsDb()}catch(r){!this.ended&&!me()&&(se("Library.setup() failed"+(qs()?"":ye),r),this._ready.reject(r))}finally{this._ready.pending&&(this.logger.info("Library.setup() finished."),this._ready.resolve())}});this.openedBy=l(()=>new gg(this.dataDir));this.statsDbDir=l(()=>Lf());this.previews=l(()=>new sg(this.rootDir.join(u.previewsDir.valueOrDefault),JD));this.originalsDir=l(()=>ps(this.rootDir));this.assetFileRepository=l(()=>new Qg(this.originalsDir(),()=>u.copyAssetsToLibrary.valueOrDefault));this.modelDbJanitor=l(async()=>Am.for(this.dataDir,()=>this.openedBy().isLockOwner()));this.modelDb=l(async()=>(await this.modelDbJanitor()).db.promise);this.statsDb=l(async()=>e0(await this.statsDbDir()));this.statsDbFile=l(()=>this.statsDb().then(e=>e.dbfile));this.onEnd=l(async()=>{for(let{ea:e,t:r}of[{ea:this.statsDb,t:G},{ea:this.modelDbJanitor,t:D},{ea:this.openedBy,t:G}])await f(await e.clear(),i=>yi(i,r));this.logger.info("onEnd(): finished.")});this.rootDir=ee.for(e),this.dataDir=zt(this.rootDir),this.logger.info("new()")}static libraryPathChanged(){let e=f(u.libraryPath.value,Gr),r=f(this.priorInstance,i=>i.rootDir.nativePath);return e!==r}static instance(){let e=this.libraryPathChanged(),r=B(this.priorInstance?.ended),i;return(e||r)&&(i=yi(this.priorInstance,D),this.priorInstance=void 0),this.priorInstance==null&&Ro()&&(this.priorInstance=U(u.libraryPath.value,o=>vt(new ti(o),async n=>(await i,n.setup())))),this.priorInstance}static instanceRequired(){let e=ti.instance();if(e==null)throw new Error("Library is undefined"+ye);return e}get isPendingSetup(){return this._ready.pending}get ready(){return this._ready.promise}async requiredFiles(){let e=[];return await Qo(u.cacheDir.valueOrDefault)&&e.push({desc:"Cache directory",isDir:!0,file:()=>Do()}),this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library model DB",isDir:!1,file:()=>x(this.modelDbJanitor(),r=>r.srcDbFile)},{desc:"Library model DB (local replica)",isDir:!1,file:()=>x(this.modelDbJanitor(),r=>r.localDbReplica)}),e}};var Cf=class extends cr{static ping(e="ping"){return Cf.ops().upsertOne({name:e})}static async assertPing(e){let r=Date.now();try{if(Cf.db()==null)throw new Error("db is undefined");let i=await this.ping(e);if(this.logger().debug("assertPing()",{heartbeat:i}),Math.abs(r-i.updatedAt)>20*E)throw new Error("Heartbeat.updatedAt wasn't updated")}catch(i){throw new ue({cause:i,message:"Failed to write to the library database"})}}},Fm=Cf;Fm.tableName="Heartbeat",Fm.uniqueColumnName="name";var aC=0;function t0(){return Date.now()<=aC}var Ga=h("LibraryHealthChecks"),ws=l(()=>lC(),15*E);function Yg(){i0.unset(),ws.unset()}function o0(){return Yg(),ws.refresh()}W(()=>{u.libraryPath.addListener(Yg),ox(o0),sx(o0),rx(Yg)});async function lC(){if(t0())return{ok:["Library health checks are paused"]};if(!u.libraryPath.hasValue()&&!Ro())return{ok:["Library isn't set up yet"]};let t=ti.instance();if(t==null)return Ro()?{fail:["Missing library at "+u.libraryPath.value]}:{};if(t.isPendingSetup){t.ready.then(()=>ws.unset());let a=Date.now()-t.start;return a<G?{ok:["Library is setting up..."]}:a<3*D?{warn:["Library is taking a long time to set up..."]}:{fail:["Library took too long time to set up."]}}else try{await t.ready}catch(a){return{fail:["Library setup failed: "+hi(a)]}}let e=[],r=[],i=[],o=[],n=[],s=async a=>{try{return await a()}catch(m){n.push(m),Ga.warn("trap(): failed to run "+a.name+": "+ci(m)),o.push(hi(m));return}};if(await s(()=>t.openedBy().throwIfUnavailable("(library health check)")),u.healthCheckExiftool.valueOrDefault&&await s(()=>RE()),u.healthCheckLibraryIsWritable.valueOrDefault&&await s(()=>i0().catch(a=>{throw new ue({cause:a,message:"Cannot write to "+ps(),fatal:!0})})),I)try{let a=await de.instance().version();T(a)&&o.push("PowerShell isn't working (can't get version).")}catch(a){n.push(a),o.push(`PowerShell isn't working (${hi(a)}).`)}if(u.healthCheckFreeSpace.valueOrDefault||u.healthCheckVolumes.valueOrDefault){let a=await s(()=>Ot());if(L(a))o.push("Failed to scan system volumes."+ye);else if(u.healthCheckFreeSpace.valueOrDefault)for(let m of await t.requiredFiles())try{let c=await m.file();if(c==null)continue;if(c.clear(),m.isDir&&!await c.isDirectory())o.push(`${m.desc}, ${c}, is missing`+ye);else if(C(a)){let p=jd(a,c.nativePath);Ga.debug("checkDir()",{dir:c.nativePath,desc:m.desc,bestVolume:p,vols:a.map(d=>d.mountpoint)}),p==null?c.isUNC?r.push(`${m.desc}, ${c}: cannot be monitored for sufficient free space. Consider using a mapped network drive instead.`):o.push(`${m.desc}, ${c}, doesn't seem to have a mountpoint (?!)`):p.available<u.minDiskFreeGb.valueOrDefault*uo&&r.push(`Only ${li(p.available)} are available on ${p.mountpoint}.`)}}catch(c){n.push(c),o.push("Failed to check "+m.desc+": "+hi(c))}}return L(o)&&L(r)&&e.push("Library and support directories are OK"),v(Lm.env.TEST_FAIL)&&o.unshift(...Lm.env.TEST_FAIL.split(",")),v(Lm.env.TEST_WARN)&&r.unshift(...Lm.env.TEST_WARN.split(",")),u.healthCheckDb.valueOrDefault&&await s(()=>Fm.assertPing()),o.map(a=>se(a+hl)),df({ok:e,warn:r,bad:i,fail:o},r0())}var i0=l(async()=>mC(ps()),At);async function mC(t){if(t==null)return Ga.throw("copyExampleImageToLibraryDir(): undefined rootDir");let e=F(await Me.for(Lr.Public()).join("images").children()).find(o=>o.name.startsWith("splash"));if(e==null)return Ga.throw("copyExampleImageToLibraryDir(): missing validation image");t=Me.for(t);let r=t.join(".tmp-"+il(6)),i=r.join("write-test"+e.ext);try{await e.copyFile_(i);let o=await e.sha(),n=await i.sha();if(o!==n)return Ga.throw("Failed to copy sample file to library. Is "+t+" writable?",{ignorable:!0});Ga.debug(`Library root directory, ${t}, is writable`)}finally{await r.rmrf("debug")}}var uC=l(()=>new Pt("memoryCheck on exit",()=>{let t=h("PromiseTimer"),e=n0();t.log(tD(e)?"warn":"info","memory use on exit:",e)},be.service));function n0(){uC();let t=[],e=[],r=[];function i(o,n,s){if(!N(o))return se("memoryCheck(): invalid bytesUsed. "+k({bytesUsed:o,desc:s})+hl);let a=o/Ge,m=`used by ${Dr()} (${li(o,2)})`;a>=n?r.push(`${s} ${m} is high`):a>=n*.8?e.push(`${s} ${m} is high`):t.push(`${s} ${m} is OK`)}return i(iD(),u.maxMemoryMb.valueOrDefault,"Used memory"),i(oD(),u.maxRssMemoryMb.valueOrDefault,"RSS memory"),{ok:t,warn:e,bad:r}}function r0(){return!Te&&!u.scanAllDrives.valueOrDefault&&L(u.scanPaths.values)?{warn:["Nothing to scan: scanAllDrives is false and scanPaths is empty."]}:{}}async function s0(){try{return df(await ws(),n0())}catch(t){return rD({fail:[Zt(Se(t),"healthChecks failed")]})}}var a0=S(require("xml2js"));var Vf=l(()=>h("KeywordTagger")),Xg=l(()=>new RegExp(`\\s*[${rt(u.keywordDelimiters.valueOrDefault)}]\\s*`));u.keywordDelimiters.addListener(()=>Xg.clear());function zf(t){return t==null||t instanceof Aa?[]:R(Array.isArray(t)?Y(t.map(zf)):t.split(Xg()))}var l0=l(()=>U(u.keywordPathSeparators.valueOrDefault,t=>new RegExp(`\\s*[${rt(t)}]\\s*`)));u.keywordPathSeparators.addListener(()=>l0.clear());function m0(t){return t==null?[]:L(t.Category)?[[t._]]:Y(t.Category.map(m0).map(e=>e.map(r=>A([t._,...r]))))}var cC=/^\(?none\)?$/i;async function fC(t){if(!(T(t)||cC.exec(t)!=null))try{let e=await(0,a0.parseStringPromise)(t);return Y(F(e?.Categories?.Category).map(m0))}catch(e){Vf().warn("parseCategories() failed:",e);return}}async function pC(t){let e=[];return t!=null&&(await x(fC(t.Categories),r=>e.push(...r)),_s([t.CatalogSets,t.HierarchicalSubject,t.Keywords,t.LastKeywordXMP,t.CatalogSets,t.Subject,t.TagsList,t.XPKeywords]).forEach(r=>e.push(...Array.isArray(r)?r:zf(r)))),Vf().tap({msg:"rawTagKeywords()",result:z(e),meta:{t:t==null?void 0:at(t,"Categories","CatalogSets","HierarchicalSubject","Keywords","LastKeywordXMP","CatalogSets","Subject","TagsList","XPKeywords")}})}var u0=l(()=>new RegExp(`[ /${rt(u.keywordDelimiters.valueOrDefault)}]`));u.keywordDelimiters.addListener(()=>u0.clear());function c0(t){return Vf().tap({msg:"extractDashDashTags()",result:J(g(t).split("--")[1],e=>R(e.split(u0())),()=>[]),meta:{s:t}})}function dC(t){return[...c0(t.parent().posixPath),...c0(t.name)]}var hC=/\w{2,7}:\/\/\S+/gi;function f0(t){let e=[],r=[],i=[];for(let d of t)if(Array.isArray(d))i.push(d);else{let y=d.replace(hC,P=>(r.push(P),""));i.push(...y.split(Xg()))}let n=J(l0(),d=>i.map(y=>ct(y)?y.split(d):y),i).map(d=>Array.isArray(d)&&d.length===1?d[0]:d),[s,a]=Cn(n,Array.isArray),m=s.map(d=>R(d.map(y=>y.trim()))).filter(C),c=kb(Y(m));for(let d of m)e.push(d);let p=[...a,...r].map(d=>d.trim()).filter(d=>v(d)&&!_t(c,d));for(let d of p)e.push([ne.Keywords,d]);return z(e)}function gC(t){return Jm($(t,e=>{let r=e.join("/");return[r.normalize().toLowerCase(),-1*uw(r)]}),(e,r)=>Oe(k(e),k(r)))}function yC(t){let[e,r]=Cn(f0(t),s=>Ef(s[0])),i=z(Y(e.map(s=>[s.slice(1).join(", "),s.length>2?s[2]+" "+s[1]:void 0])));ft(r,s=>!_t(i,s.join(" ")));let o=gC(f0(r)),n=Y(i.map(Pg));return Vf().tap({msg:"processKeywords()",level:"info",result:$([...o,...n],s=>k(s)),meta:{tagKeywordsFromMetadata:u.tagKeywordsFromMetadata.valueOrDefault,whoNames:i,whoResults:n}})}async function p0(t){let e=u.tagKeywordsFromPath.valueOrDefault?Y(t.map(dC)):[],r=u.tagKeywordsFromMetadata.valueOrDefault?Y(await sr(t,i=>x(Ie(i),pC))):[];return yC([...e,...r])}var bC=l(()=>h("TypeTagger"));async function d0(t){let e=hr(t.map(i=>i.parent()),i=>i.nativePath),r=Y(e.map(i=>u.tagAlbumFilenames.values.map(o=>i.join(o))));return sr(r,xC)}async function xC(t){return wC(await Ie(t,!1))}function wC(t){if(t==null)return;let e=fo(t,u.tagAlbumTitle.valueOrDefault),r=fo(t,u.tagAlbumDescription.valueOrDefault),i=T(e)?[]:u.tagAlbumTitleHierarchies.valueOrDefault?zf(e):[e],o=L(i)?"(blank title)":_b(u.tagAlbumsExcluded.values,[g(e),g(r)].join(" ")),n=o==null?[ne.Albums,...i]:void 0;if(n!=null){let s={name:n[n.length-1],description:r};wn(eA(fo(t,u.tagAlbumDate.valueOrDefault)),a=>{s.releasedAt=a.getTime()}),n[n.length-1]=s}return bC().tap({msg:"albumFromFile()",result:n,meta:{title:e,desc:r,shouldExclude:o}})}function TC(t){return f(t,e=>U(e.Make,r=>U(e.Model,i=>[ne.Camera,r,i])))}function h0(t){return x(_r(t),TC)}function MC(t){return f(t,e=>U(e.lensMake,r=>U(R(u.tagFullLensModel.valueOrDefault?[e.lensModel,e.lensInfo]:[e.lensInfo,e.lensModel])[0],i=>[ne.Lens,r,i])))}function g0(t){return x(_r(t),MC)}var vC=l(()=>h("TypeTagger"));async function y0(t){let e=z(await Promise.all(t.map(So)));return A(e.map(SC))}var PC=new Map(["M2TS","JPEG","QuickTime"].map(t=>[t.toLowerCase(),t]));function SC(t){let[e,r]=t.split("/");if(!(T(e)||T(r)))return vC().tap({msg:"mimetypeToTag("+t+")",result:f(EC(r,t),i=>R([ne.Type,Ho(e),...i]))})}var DC=l(()=>new Map([["image/x-adobe-dng",["Raw","DNG"]],["image/x-fuji-raf",["Raw","Fujifilm"]],["video/m2ts",["MPEG-2"]],["video/mp4",["MPEG-4"]],["video/quicktime",["QuickTime"]],["video/x-msvideo",["AVI"]]]));function EC(t,e){return Ls([()=>DC().get(e.trim().toLowerCase()),()=>f(t.match(/^x-(\w{4,})-\w{3}/),r=>["Raw",Ho(r[1])]),()=>[AC(t.replace(/^(x-)|(vnd\.)|(prs\.)/i,"").replace(/-/g," "))]])}function AC(t){return t.match(/[a-z0-9]{3,4}/i)!=null?t.toUpperCase():M(PC.get(t.trim().toLowerCase()),()=>Ho(t))}var Co=h("AssetTagger");async function b0(t,e,r,i,o){let n=[];e.some(m=>m.nativePath===t.nativePath)||e.unshift(t),u.tagCamera.valueOrDefault&&await x(h0(t),m=>{Co.debug("Camera tag for "+t+":",m),n.push(m)}),u.tagLens.valueOrDefault&&await x(g0(t),m=>{Co.debug("Lens tag for "+t+":",m),n.push(m)}),await x(OA(t,i),m=>{Co.debug("Date tag for "+t+":",m),n.push(m)}),await x(p0(e),m=>{Co.debug("Keyword tags for "+t+":",m),n.push(...m)}),u.tagFileType.valueOrDefault&&await x(y0(e),m=>{Co.debug("MIME type tags for "+t+":",m),n.push(...m)}),await ji()||await x(nA(e),m=>{Co.debug("whoTagFiles for "+t+":",m),n.push(...m)}),await x(qA(o),m=>{Co.debug("file paths for uris",{uris:o,arr:m}),n.push(...m)}),u.tagAlbums.valueOrDefault&&await x(d0(e),m=>{Co.debug("Album tags for "+t+":",m),n.push(...m)});let s=hr(n,ur),a=await fA(r,s);return Co.info("tagAsset("+t+")",{priorTagPaths:r,after:s,result:a}),a}async function Uf(t){let e=ee.for(t),r=[];for(let[d,y]of ze(await pv(e)))await y()&&r.push(d);if(await e.notExists())return{nativePath:e.nativePath,ignoredBecause:r};let i=await VE(e),o=await _r(e),n=await De.andExplain(e,Ug()),s=await gm(e),a=z(s?.modes?.map(d=>V(va(d,ko)).flatMap(eh).map(y=>`${y.name} (${y.rgb})`).get())).join(", "),m=await b0(e,[],[],[],[await e.uri()]),c=f(o,d=>d.mimetype),p=w(w({nativePath:e.nativePath,ignoredBecause:r,filters:n,validFile:await jc(e).then(()=>"OK").catch(d=>hi(d)),uri:await e.uri(),sha:await e.sha(),mimetype:c,capturedAt:{date:i?.date,localCentiseconds:f(i,d=>d.toLocal()),offset:f(i,d=>d.toOffset()),src:f(i,d=>d.src)},cameraId:f(o,Of),imageId:f(o,Rf),lensId:f(o,kf),tags:f(m,d=>d.add),needsTranscoding:await CP(e),imageHash:w(w({},s),{dominantColors:a}),tz:f(o,d=>d.tz),tzSource:f(o,d=>d.tzSource),variantSortCriteria:await x(aD(e),rg),geohash:Hh(o?.GPSLatitude,o?.GPSLongitude),geohashNumeric:Xc(o?.GPSLatitude,o?.GPSLongitude)},J(o,d=>at(d,"dimensions","duration","Error","errors","exposureSettings","lensInfo","lensMake","lensModel","Make","Model","problems","rotation","tz","tzSource","Warning"),Za)),{_PhotoStructureVersion:Lt});return op(p)}var x0=["focalLength","aperture","shutterSpeed","iso"];var Zg=l(()=>h("AssetFileComparator")),FC=he("sha","mimetype","capturedAtSrc","capturedAtLocal","capturedAtPrecisionMs","make","model","cameraId","imageId","lensId","geohash",...x0,"meanHash","mode0","mode1","mode2","mode3","mode4"),IVe=FC.values;function Im(t,e,r,i=(o,n)=>[o,n]){let o=t[r],n=e[r];if(T(o)||T(n)||$e(o,n))return;let[s,a]=i(o,n);return $e(s,a)||$e(o,a)||$e(s,n)?void 0:`Different ${String(r)}: ${o} != ${n}`}function w0(t){return U(t,e=>e.toLowerCase().trim())}function T0(t,e){return[w0(t),w0(e)]}function M0(t){return t!=null&&t%1e6==0}function v0(t){return g(t).replace(/^[A-Z]\w+:/,"").trim()}function S0(t,e){if(t==null)return"af1 was undefined";if(e==null)return"af2 was undefined";if(ll(t.sha,e.sha)){Zg().debug("matching SHA",{af1:t,af2:e});return}let r=Math.max(...A([t.capturedAtPrecisionMs,e.capturedAtPrecisionMs,1e3])),i=Hl(t.capturedAtLocal),o=Hl(e.capturedAtLocal);if(i==null)return"af1 missing capturedAtLocal";if(o==null)return"af2 missing capturedAtLocal";if(!(t.capturedAtSrc==="stat"||e.capturedAtSrc==="stat")&&!qm(i,o,r))return`Different Captured-at times: ${[t,e].map(P=>`${P.capturedAtLocal}${"\xB1"+r+"ms"}`).join(" != ")}`;let s=z(R([t.make,e.make])).map(y=>y.toLowerCase());function a(y,P){let[_,ie]=[v0(y),v0(P)];if(_.endsWith(ie)||ie.endsWith(_)){let Xe=_.length-ie.length,Ee=(Xe>0?_:ie).slice(0,Math.abs(Xe)).trim().toLowerCase();if(s.includes(Ee)||_t(u.lensMakes.values,Ee))return Zg().debug("stripTagSources: one side didn't have a Make, but they match otherwise.",{a:y,b:P,prefix:Ee}),Xe>0?[ie,ie]:[_,_]}return[_,ie]}let m=Ls([()=>Im(t,e,"make",T0),()=>Im(t,e,"model",T0),()=>Im(t,e,"cameraId",a),()=>Im(t,e,"imageId",a),()=>Im(t,e,"lensId",a),()=>zA(t,e)]);if(m!=null)return m;if(!u.strictDeduping.valueOrDefault){let y=SE(t.geohash,e.geohash),P=ro(y,u.gpsErrorMeters.valueOrDefault),_=t.capturedAtLocal%100,ie=e.capturedAtLocal%100,Xe=_===ie&&_>0,Ee=[ll(t.cameraId,e.cameraId),ll(t.imageId,e.imageId),ll(t.lensId,e.lensId),P,Xe];if(Sr(Ee,Q=>Q)>=2&&r<=E)return}let c=af(t,e),p=M0(t.capturedAtLocal)||M0(e.capturedAtLocal)||!t.capturedAtSrc.includes("tags")||!e.capturedAtSrc.includes("tags"),d=p?u.fuzzyDateImageCoeffWeight.valueOrDefault:1;if(Zg().debug("Comparing image hashes",{fuzzy:p,corrWeight:d,c,af1:t,af2:e}),!JE(c,d))return"low image correlation"+(p?" (fuzzy dates require higher correlation)":"")}var P0=l(()=>h("SyncPaths")),LC=new ts(10*D);async function IC(){return le(Ot(),t=>t.ignorable!==!1&&N(t.size)?x($l(t.mountpoint,t),e=>({nativePath:t.mountpoint,uri:e.toString()})):void 0)}function OC(t){return x(t.uri(),e=>({nativePath:t.nativePath,uri:e}))}function kC(t){return x($l(t),e=>({nativePath:t,uri:e.toString()}))}async function RC(){return le(u.scanPaths.values,kC)}async function _C(){let t=[];t.push(...await RC()),u.scanAllDrives.valueOrDefault&&t.push(...await IC());let e=await pe(ps(),OC,()=>P0().throw("libraryOriginalsDir was null",u.libraryPath.value));u.scanLibraryFirst.valueOrDefault&&t.unshift(e),u.scanLibraryLast.valueOrDefault&&t.push(e),cu(t,i=>i.nativePath);let r=await Oi(t,i=>!LC.has(i.nativePath)&&Qo(i.nativePath));return P0().info("pathsToSync",r),r}async function E0(){let t=await _C(),e=await Ha.times();return t.map(r=>w(w({},e.find(i=>i.uri===r.uri)),r))}var qf=S(require("os")),ty=S(require("process"));var D0=S(require("child_process")),A0=S(require("fs")),Xi=S(require("os"));var ey=l(()=>h("os")),F0=l(()=>[NC(),"on",(0,Xi.arch)()].join(" "));function NC(){switch((0,Xi.platform)()){case"linux":return BC();case"darwin":return CC();case"win32":return VC();default:return Om()}}function Om(){return(0,Xi.platform)()+" "+(0,Xi.release)()}function BC(){try{let t=(0,A0.readFileSync)("/etc/os-release").toString(),e=fc({input:t,lowerCaseKeys:!0});if(v(e.pretty_name))return e.pretty_name;let r=M(e.version,e.version_id);return Mi(e.name,r,(i,o)=>i+" "+o,Om)}catch(t){return ey().warn("Failed to fetch /etc/os-release",t),Om()}}function L0(t){return t.split(".").slice(0,2).join(".")}var zC={"10.6":"Snow Leopard","10.7":"Lion","10.8":"Mountain Lion","10.9":"Mavericks","10.10":"Yosemite","10.11":"El Capitan","10.12":"Sierra","10.13":"High Sierra","10.14":"Mojave","10.15":"Catalina","11.1":"Big Sur"},I0=l(()=>(0,D0.execSync)("sw_vers -productVersion").toString().trim());function UC(t=I0()){return zC[L0(t)]}function CC(t=I0()){try{return ii(UC(t),e=>`macOS ${e} (${t})`,Om)}catch(e){return ey().warn("osNameMac(): unknown release",e),Om()}}var qC={"10.0":"10","6.3":"8.1","6.2":"8","6.1":"7","6.0":"Vista","5.2":"Server 2003","5.1":"XP","5.0":"2000","4.9":"ME","4.1":"98","4.0":"95"};function VC(t=(0,Xi.release)()){let e=qC[L0(t)];return e!=null?`Windows ${e} (${t})`:(ey().warn("osNameWin(): unknown release: "+t),`Windows (${t})`)}var O0=l(()=>yb((0,Xi.cpus)().map(t=>t.model)).map(t=>`${t.count} \xD7 ${t.t}`).join(", "),D);async function k0(t,e="(missing)"){try{let r=await t();return T(r)?e:r}catch(r){let i=hi(r);return T(i)?e:i}}async function WC(){if(ti.instance()==null)return;let t=[];t.push(mu(await Et.shownAssetCounts(),"asset"));let e=await Tt.assetCountByMimetypeRoot();for(let r of e)t.push(mu(r.count,r.mimetypeRoot+" file"));return t.push(mu(await Pe.rows(),"tag")),t}async function R0(t){let e=await Fh(t),r=await zc(),i=await Sh(),o=i?.l?.tier??"lite";return A([{term:"Version",defn:Lt},{term:"Edition",defn:lo+(fi?` for Desktops (${u.updateChannel.valueOrDefault} channel)`:Ce()?" for Docker":" for Servers")},{term:"Plan",defnClass:o,defn:o},B(i?.ok)?{term:"Licensed to",defn:i?.l?.sub}:void 0,{term:"OS",defn:F0()+(Ce()?" (docker)":"")},I?{term:"PowerShell",defn:await k0(()=>de.instance().version())}:void 0,fi?void 0:{term:"Node.js",defn:ty.default.versions.node},U(ty.default.versions.electron,n=>({term:"Electron",defn:n})),Ce()?{term:"ExifTool",defn:await k0(()=>kE())}:void 0,{term:"Video support",termURL:"https://photostructure.com/getting-started/video-support/",defn:e.msg,defnClass:e.ok?"ok":"warn"},{term:"HEIF support",termURL:"https://photostructure.com/getting-started/heif-support/",defn:r.msg,defnClass:r.ok?"ok":"warn"},ge(qf.default.freemem(),n=>({term:"Free memory",defn:li(n,2)+" / "+li(qf.default.totalmem(),2),defnClass:qf.default.totalmem()<2*al?"warn":"ok",defnTitle:"PhotoStructure requires at least 2 GB of RAM"})),{term:"CPUs",defn:O0()},{term:"Concurrency",defn:`Target system use: ${Be(u.cpuLoadPercent.valueOrDefault,2)}% (${fl()} syncs, ${pl()} threads/sync)`},qs()?{term:"Web uptime",defn:Dm(Date.now()-Us)}:void 0,U(Rp(),n=>({term:"Device",defn:n})),await x(WC(),n=>({term:"Library metrics",termURL:"https://photostructure.com/faq/metrics/",defn:n})),{term:"Library path",defn:M(u.libraryPath.value,"(unset)"),defnClass:u.libraryPath.isUnset()?"warn":"tt"}]).filter(({term:n,defn:s})=>v(n)&&v(s))}try{dF().install()}catch{}var P2={beforeParse(t){return t.option("--volumes","Emit a table with currently mounted volume metadata. See <https://photostructure.com/volumes> for details.").option("--sync-paths","Emit a table listing the paths that will be synced next.").option("--licensing","Emit licensing/plan information.").option("--child-env","Emit the environment variables provided to all spawned processes.").option("--json","emit metadata as JSON. Disables colorized output.")},afterParse:function(){}};async function E2(){try{let r=function(o){B(e.json)||ao("NO_COLOR")||Pr(e.color)?console.log(k(o,void 0,2)):console.log((0,hF.inspect)(o,{depth:4,colors:!0}))},t=await new Ld("info","[FILE...]",["* Omit any filenames to run diagnostics and output system configuration, tooling, and health check information.","* File paths should be absolute or relative to cwd.","* Provide 2 file paths to see why PhotoStructure may consider them variants of the same asset.","* To emit valid JSON, set NO_COLOR=1 or use --json."].join(`
`)).add(P2,YT).parse(),e=t.opts();if(nu("info"),await cf(),await pf(),B(e.volumes)){let o=await Ot();if(o==null)console.error("--volumes were requested, but `volumes()` failed. Please retry with --info for details.");else return r(o.map(n=>w(w(w({filesystem:n.filesystem,size:li(n.size),used:li(n.used),available:li(n.available),mountpoint:n.mountpoint},n.label!=null?{label:n.label}:void 0),{uuid:n.uuid,volsha:ls(n.uuid),remote:n.remote}),n.remote?{remoteHost:n.remoteHost,remoteShare:n.remoteShare}:void 0)))}if(B(e.licensing)){let o=(await dn())[0],n=f(o?.l,s=>({email:s.sub,issued_at:s.iat,expires:s.exp,meta:o.meta}));return r({subscription:await Ph(),current_license:n})}if(B(e.childEnv))return r(pd({},!1));let i=z(t.args);if(B(e.syncPaths)||L(i)){let o=h("info");o.info("Waiting for library to spin up..."),await ti.instance()?.ready,o.info("Library is ready.")}if(B(e.syncPaths))return r(await E0());if(L(i)){let o={systemInfo:await R0()};return o.paths={cacheDir:Zt(u.cacheDir.valueOrDefault,"(unset)"),logDir:Zt(u.logDir.valueOrDefault,"(unset)"),systemSettingsFile:mf().nativePath,librarySettingsFile:J(uf(),n=>n.nativePath,()=>"(unset)")},o.healthChecks=await s0(),o.nonDefaultSettings=st(pt(u).filter(n=>n.hasValue()).map(n=>[n.name,n.value])),r(o)}if(i.length===2){let o=ee.for(i[0]),n=ee.for(i[1]),s=await new Tt().updateFromFile(o),a=await new Tt().updateFromFile(n),m=await S0(s,a),c=m==null?"These two files will be aggregated into a single asset.":"These files represent different assets: "+m;r(await Mi(s,a,async()=>({fileComparison:c,variant:m==null,imageHashComparison:kt(await af(s,a),"a","b"),a:await Uf(o),b:await Uf(n)}),async()=>s==null?{error:"Failed to read "+o}:a==null?{error:"Failed to read "+n}:{error:"internal error"}))}else r(await Promise.all(i.map(Uf)))}catch(t){console.error("Failed ",t)}finally{await WT()}}E2();
//# sourceMappingURL=info.js.map
