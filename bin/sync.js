#!/usr/bin/env node
/* Copyright Â© 2021, PhotoStructure Inc. */
/* By using this software, you accept the terms in <https://photostructure.com/eula>. */
/* If you don't accept them, do not use this software. */
var JL=Object.create,ad=Object.defineProperty,QL=Object.getPrototypeOf,ow=Object.prototype.hasOwnProperty,$L=Object.getOwnPropertyNames,YL=Object.getOwnPropertyDescriptor,nw=Object.getOwnPropertySymbols,XL=Object.prototype.propertyIsEnumerable;var g=Object.assign,ZL=t=>ad(t,"__esModule",{value:!0});var ti=(t,e)=>{var r={};for(var i in t)ow.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(t!=null&&nw)for(var i of nw(t))e.indexOf(i)<0&&XL.call(t,i)&&(r[i]=t[i]);return r},Y=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports);var eI=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of $L(e))!ow.call(t,i)&&i!=="default"&&ad(t,i,{get:()=>e[i],enumerable:!(r=YL(e,i))||r.enumerable});return t},M=t=>eI(ZL(ad(t!=null?JL(QL(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var ki=Y((ope,Sn)=>{var l_={PasetoNotSupported:"ERR_PASETO_NOT_SUPPORTED",PasetoDecryptionFailed:"ERR_PASETO_DECRYPTION_FAILED",PasetoInvalid:"ERR_PASETO_INVALID",PasetoVerificationFailed:"ERR_PASETO_VERIFICATION_FAILED",PasetoClaimInvalid:"ERR_PASETO_CLAIM_INVALID",PasetoWorkerFailure:"ERR_PASETO_WORKER_FAILURE"},Mn=class extends Error{constructor(e){super(e);this.name=this.constructor.name,this.code=l_[this.constructor.name],Error.captureStackTrace(this,this.constructor)}};Sn.exports.PasetoError=Mn;Sn.exports.PasetoNotSupported=class extends Mn{};Sn.exports.PasetoDecryptionFailed=class extends Mn{};Sn.exports.PasetoInvalid=class extends Mn{};Sn.exports.PasetoVerificationFailed=class extends Mn{};Sn.exports.PasetoClaimInvalid=class extends Mn{};Sn.exports.PasetoWorkerFailure=class extends Mn{}});var Wp=Y((npe,SP)=>{SP.exports=t=>!!t&&t.constructor===Object});var qp=Y((spe,MP)=>{var m_=Wp();MP.exports=function(e){if(typeof e=="undefined")return Buffer.from("");if(Buffer.isBuffer(e))return e;if(m_(e))return Buffer.from(JSON.stringify(e),"utf8");if(typeof e!="string")throw new TypeError("options.footer must be a string, Buffer, or a plain object");return Buffer.from(e,"utf8")}});var Fg=Y((ape,PP)=>{var EP=1e3,DP=EP*60,AP=DP*60,Ag=AP*24,u_=Ag*7,c_=Ag*365.25,p_=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;PP.exports=t=>{let e=p_.exec(t);if(!e)throw new TypeError(`invalid time period format ("${t}")`);let r=parseFloat(e[1]);switch(e[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r*EP);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(r*DP);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(r*AP);case"day":case"days":case"d":return Math.round(r*Ag);case"week":case"weeks":case"w":return Math.round(r*u_);case"year":case"years":case"yr":case"yrs":case"y":return Math.round(r*c_)}}});var IP=Y((lpe,FP)=>{var LP=Fg();FP.exports=({audience:t,expiresIn:e,iat:r=!0,issuer:i,jti:o,kid:n,notBefore:s,now:a=new Date,subject:m},c)=>{if(!(a instanceof Date)||!a.getTime())throw new TypeError("options.now must be a valid Date object");let h=a.getTime();if(r!==void 0){if(typeof r!="boolean")throw new TypeError("options.iat must be a boolean");r&&(c.iat=new Date(h))}if(e!==void 0){if(typeof e!="string")throw new TypeError("options.expiresIn must be a string");c.exp=new Date(h+LP(e))}if(s!==void 0){if(typeof s!="string")throw new TypeError("options.notBefore must be a string");c.nbf=new Date(h+LP(s))}if(t!==void 0){if(typeof t!="string")throw new TypeError("options.audience must be a string");c.aud=t}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.issuer must be a string");c.iss=i}if(m!==void 0){if(typeof m!="string")throw new TypeError("options.subject must be a string");c.sub=m}if(n!==void 0){if(typeof n!="string")throw new TypeError("options.kid must be a string");c.kid=n}if(o!==void 0){if(typeof o!="string")throw new TypeError("options.jti must be a string");c.jti=o}return c}});var jp=Y((mpe,kP)=>{var f_=IP(),d_=Wp(),h_=t=>JSON.parse(JSON.stringify(t));kP.exports=(t,e)=>{if(Buffer.isBuffer(t)){if(Object.keys(e).length!==0)throw new TypeError("options cannot contain claims when payload is a Buffer");return t}if(!d_(t))throw new TypeError("payload must be a Buffer or a plain object");return t=h_(t),t=f_(e,t),Buffer.from(JSON.stringify(t),"utf-8")}});var RP=Y((upe,OP)=>{var{PasetoNotSupported:g_}=ki();OP.exports=t=>{if(!Number.isSafeInteger(t))throw new g_("message is too long for Node.js to safely process");let e=~~(t/4294967295),r=t%4294967295-e,i=Buffer.allocUnsafe(8);return i.writeUInt32LE(e,4),i.writeUInt32LE(r,0),i}});var Hp=Y((cpe,_P)=>{var NP=RP();_P.exports=(...t)=>{let e=NP(t.length);for(let r of t){r=Buffer.from(r,"utf8");let i=NP(Buffer.byteLength(r));e=Buffer.concat([e,i,r])}return e}});var Im=Y((ppe,Lg)=>{var y_=t=>t.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),b_=t=>t.replace(/-/g,"+").replace(/_/g,"/"),w_=t=>y_(t.toString("base64")),x_=t=>Buffer.from(b_(t),"base64");Lg.exports.decode=x_;Lg.exports.encode=w_});var kg=Y((fpe,BP)=>{var{encode:Ig}=Im();BP.exports=function(e,r,i){return i.length!==0?`${e}${Ig(Buffer.concat(r))}.${Ig(i)}`:`${e}${Ig(Buffer.concat(r))}`}});var UP=Y((dpe,CP)=>{var{timingSafeEqual:v_}=require("crypto"),VP=(t,e)=>{if(t.length===e)return t;let r=Buffer.alloc(e);return t.copy(r),r},T_=(t,e)=>{let r=Math.max(t.length,e.length);return v_(VP(t,r),VP(e,r))};CP.exports=T_});var km=Y((gpe,zP)=>{var Bs=require("crypto"),S_=require("util"),{PasetoWorkerFailure:hpe}=ki(),WP=Hp(),rl;if(Bs.hkdf){let t=S_.promisify(Bs.hkdf);rl=(e,r,i,o)=>t("sha384",e,i,o,r)}else rl=(t,e,r,i)=>{let o=Pn.hmac("sha384",t,r),n=Buffer.from(i),s=Buffer.from(""),a=Buffer.from(""),m;for(let h=1;Buffer.byteLength(s)<e;++m){m=Buffer.from(String.fromCharCode(h));let x=Buffer.concat([a,n,m]);a=Pn.hmac("sha384",x,o),s=Buffer.concat([s,a])}return Buffer.from(s).slice(0,e)};var M_=kg(),P_=UP(),Pn={async"aes-256-ctr-hmac-sha-384-encrypt"(t,e,r,i){let o=Pn.hmac("sha384",t,i);o=o.slice(0,32),e=Buffer.from(e);let n=o.slice(0,16),[s,a]=await Promise.all([rl(r,32,n,"paseto-encryption-key"),rl(r,32,n,"paseto-auth-key-for-aead")]),m=Pn.encrypt("aes-256-ctr",t,s,o.slice(16)),c=WP("v1.local.",o,m,e),h=Pn.hmac("sha384",c,a);return M_("v1.local.",[o,m,h],e)},async"aes-256-ctr-hmac-sha-384-decrypt"(t,e,r){let i=t.slice(0,32),o=t.slice(-48),n=t.slice(32,-48),s=i.slice(0,16),[a,m]=await Promise.all([rl(r,32,s,"paseto-encryption-key"),rl(r,32,s,"paseto-auth-key-for-aead")]),c=WP("v1.local.",i,n,e),h=Pn.hmac("sha384",c,m),x=Pn.decrypt("aes-256-ctr",n,a,i.slice(16));return!P_(o,h)||!x?!1:x},hmac(t,e,r){let i=Bs.createHmac(t,r);return i.update(e),i.digest()},verify(t,e,r,i){return Bs.verify(t,e,r,i)},sign(t,e,r){return Bs.sign(t,e,r)},encrypt(t,e,r,i){let o=Bs.createCipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])},decrypt(t,e,r,i){let o=Bs.createDecipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])}};zP.exports=Pn});var Og=Y((ype,qP)=>{var{sign:E_}=km(),D_=Hp(),A_=kg();qP.exports=async function(e,r,i,o,n,s){let a=D_(e,r,i),m=await E_(o,a,n);if(m.length!==s)throw new TypeError(`invalid ${e.slice(0,-1)} signing key bit length`);return A_(e,[r,m],i)}});var HP=Y((bpe,jP)=>{var{constants:{RSA_PKCS1_PSS_PADDING:F_,RSA_PSS_SALTLEN_DIGEST:L_},createPrivateKey:I_,KeyObject:k_}=require("crypto"),O_=qp(),R_=jp(),__=Og();function N_(t){if(t instanceof k_||(t=I_(t)),t.type!=="private"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public signing key must be a private RSA key");return t}jP.exports=async function(e,r,n={}){var{footer:i}=n,o=ti(n,["footer"]);let s=R_(e,o),a=O_(i);return r=N_(r),__("v1.public.",s,a,"sha384",{key:r,padding:F_,saltLength:L_},256)}});var Gp=Y((wpe,GP)=>{var{PasetoClaimInvalid:Zt}=ki(),KP=Fg();GP.exports=({ignoreExp:t,ignoreNbf:e,ignoreIat:r,maxTokenAge:i,subject:o,issuer:n,clockTolerance:s,audience:a,now:m=new Date},c)=>{if(!(m instanceof Date)||!m.getTime())throw new TypeError("options.now must be a valid Date object");let h=m.getTime();if("iss"in c&&typeof c.iss!="string")throw new Zt("payload.iss must be a string");if(n!==void 0){if(typeof n!="string")throw new TypeError("options.issuer must be a string");if(c.iss!==n)throw new Zt("issuer mismatch")}if("sub"in c&&typeof c.sub!="string")throw new Zt("payload.sub must be a string");if(o!==void 0){if(typeof o!="string")throw new TypeError("options.subject must be a string");if(c.sub!==o)throw new Zt("subject mismatch")}if("aud"in c&&typeof c.aud!="string")throw new Zt("payload.aud must be a string");if(a!==void 0){if(typeof a!="string")throw new TypeError("options.audience must be a string");if(c.aud!==a)throw new Zt("audience mismatch")}if(s!==void 0&&typeof s!="string")throw new TypeError("options.clockTolerance must be a string");let x=s?KP(s):0,S;if("iat"in c){if(typeof c.iat!="string")throw new Zt("payload.iat must be a string");if(S=new Date(c.iat).getTime(),!S)throw new Zt("payload.iat must be a valid ISO8601 string");if(!r&&S>h+x)throw new Zt("token issued in the future")}if("nbf"in c){if(typeof c.nbf!="string")throw new Zt("payload.nbf must be a string");let F=new Date(c.nbf).getTime();if(!F)throw new Zt("payload.nbf must be a valid ISO8601 string");if(!e&&F>h+x)throw new Zt("token is not active yet")}if("exp"in c){if(typeof c.exp!="string")throw new Zt("payload.exp must be a string");let F=new Date(c.exp).getTime();if(!F)throw new Zt("payload.exp must be a valid ISO8601 string");if(!t&&F<=h-x)throw new Zt("token is expired")}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.maxTokenAge must be a string");if(!("iat"in c))throw new Zt("missing iat claim");if(S+KP(i)<h+x)throw new Zt("maxTokenAge exceeded")}}});var Om=Y((xpe,JP)=>{var{PasetoInvalid:B_}=ki(),{strict:C_}=require("assert"),V_=Wp();JP.exports=t=>{try{let e=JSON.parse(t);return C_(V_(e)),e}catch(e){throw new B_("All PASETO payloads MUST be a JSON object")}}});var _g=Y((vpe,QP)=>{var{PasetoInvalid:Rg,PasetoVerificationFailed:U_}=ki(),{decode:$P}=Im(),{verify:z_}=km(),W_=Hp();QP.exports=async function(e,r,i,o,n){if(typeof r!="string")throw new TypeError("token must be a string");if(r.substr(0,e.length)!==e)throw new Rg(`token is not a ${e.slice(0,-1)} token`);let{0:s,1:a,length:m}=r.substr(e.length).split(".");if(m!==1&&m!==2)throw new Rg("token value is not a PASETO formatted value");let c,h;try{h=$P(s),c=$P(a||"")}catch(Fe){throw new Rg("token value is not a PASETO formatted value")}let x=h.slice(0,-o),S=h.slice(-o),F=W_(e,x,c);if(!await z_(i,F,n,S))throw new U_("invalid signature");return{m:x,footer:c.length?c:void 0}}});var XP=Y((Tpe,YP)=>{var{constants:{RSA_PKCS1_PSS_PADDING:q_,RSA_PSS_SALTLEN_DIGEST:j_},createPublicKey:H_,KeyObject:G_}=require("crypto"),K_=Gp(),J_=Om(),Q_=_g();function $_(t){if((!(t instanceof G_)||t.type==="private")&&(t=H_(t)),t.type!=="public"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public verify key must be a public RSA key");return t}YP.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=ti(s,["complete","buffer"]);r=$_(r);let{m:a,footer:m}=await Q_("v1.public.",e,"sha384",256,{key:r,padding:q_,saltLength:j_});if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let c=J_(a);return K_(n,c),i?{payload:c,footer:m,version:"v1",purpose:"public"}:c}});var Ng=Y((Spe,ZP)=>{var{createSecretKey:Y_,KeyObject:X_}=require("crypto");ZP.exports=function(e,r){if(r instanceof X_||(r=Y_(r)),r.type!=="secret"||r.symmetricKeySize!==32)throw new TypeError(`${e} secret key must be 32 bytes long symmetric key`);return r}});var Bg=Y((Mpe,eE)=>{var Z_=require("crypto"),{promisify:eN}=require("util"),tN=eN(Z_.randomFill);eE.exports=async function(e){let r=Buffer.allocUnsafe(e);return tN(r)}});var rE=Y((Ppe,tE)=>{var rN=qp(),iN=Ng().bind(void 0,"v1.local"),oN=jp(),nN=Bg(),{"aes-256-ctr-hmac-sha-384-encrypt":sN}=km();tE.exports=async function(e,r,s={}){var{footer:i,nonce:o}=s,n=ti(s,["footer","nonce"]);let a=oN(e,n);r=iN(r);let m=rN(i),c=r.export();return(o&&process.env.NODE_ENV!=="test"||!o)&&(o=await nN(32)),sN(a,m,c,o)}});var sE=Y((Epe,iE)=>{var{decode:oE}=Im(),{"aes-256-ctr-hmac-sha-384-decrypt":aN}=km(),{PasetoDecryptionFailed:lN,PasetoInvalid:nE}=ki(),mN=Gp(),uN=Ng().bind(void 0,"v1.local"),cN=Om(),Cg="v1.local.";iE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=ti(s,["complete","buffer"]);if(typeof e!="string")throw new TypeError(`token must be a string, got: ${typeof e}`);if(r=uN(r),e.substr(0,Cg.length)!==Cg)throw new nE("token is not a v1.local PASETO");let{0:a,1:m="",length:c}=e.substr(Cg.length).split(".");if(c>2)throw new nE("token value is not a PASETO formatted value");let h=oE(m),x=oE(a),S=r.export(),F=await aN(x,h,S);if(!F)throw new lN("decryption failed");if(o){if(Object.keys(n).length!==0)throw new TypeError("options cannot contain claims when options.buffer is true");return i?{payload:F,footer:h.length?h:void 0,version:"v2",purpose:"local"}:F}let U=cN(F);return mN(n,U),i?{payload:U,footer:h.length?h:void 0,version:"v1",purpose:"local"}:U}});var mE=Y((Dpe,aE)=>{var lE=require("crypto"),{promisify:pN}=require("util"),{PasetoNotSupported:fN}=ki(),dN=Bg(),hN=pN(lE.generateKeyPair),gN=32,yN=["rsa",{modulusLength:2048}];async function bN(t){switch(t){case"local":return lE.createSecretKey(await dN(gN));case"public":{let{privateKey:e}=await hN(...yN);return e}default:throw new fN("unsupported v1 purpose")}}aE.exports=bN});var cE=Y((Ape,uE)=>{var wN=HP(),xN=XP(),vN=rE(),TN=sE(),SN=mE();uE.exports={sign:wN,verify:xN,encrypt:vN,decrypt:TN,generateKey:SN}});var fE=Y((Fpe,pE)=>{var{createPrivateKey:MN,KeyObject:PN}=require("crypto"),EN=qp(),DN=jp(),AN=Og();function FN(t){if(t instanceof PN||(t=MN(t)),t.type!=="private"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public signing key must be a private ed25519 key");return t}pE.exports=async function(e,r,n={}){var{footer:i}=n,o=ti(n,["footer"]);let s=DN(e,o);r=FN(r);let a=EN(i);return AN("v2.public.",s,a,void 0,r,64)}});var hE=Y((Lpe,dE)=>{var{createPublicKey:LN,KeyObject:IN}=require("crypto"),kN=Gp(),ON=Om(),RN=_g();function _N(t){if((!(t instanceof IN)||t.type==="private")&&(t=LN(t)),t.type!=="public"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public verify key must be a public ed25519 key");return t}dE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=ti(s,["complete","buffer"]);r=_N(r);let{m:a,footer:m}=await RN("v2.public.",e,void 0,64,r);if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let c=ON(a);return kN(n,c),i?{payload:c,footer:m,version:"v2",purpose:"public"}:c}});var yE=Y((Ipe,gE)=>{var NN=require("crypto"),{promisify:BN}=require("util"),{PasetoNotSupported:CN}=ki(),VN=BN(NN.generateKeyPair);async function UN(t){switch(t){case"public":{let{privateKey:e}=await VN("ed25519");return e}default:throw new CN("unsupported v2 purpose")}}gE.exports=UN});var wE=Y((kpe,bE)=>{var zN=fE(),WN=hE(),qN=yE();bE.exports={sign:zN,verify:WN,generateKey:qN}});var ME=Y((Ope,xE)=>{var{PasetoInvalid:vE,PasetoNotSupported:TE}=ki(),{decode:SE}=Im(),jN=Om();xE.exports=(t,{parse:e=!0}={})=>{if(typeof t!="string")throw new TypeError("token must be a string");let{0:r,1:i,2:o,3:n,length:s}=t.split(".");if(s!==3&&s!==4)throw new vE("token value is not a PASETO formatted value");if(r!=="v1"&&r!=="v2")throw new TE("unsupported PASETO version");if(i!=="local"&&i!=="public")throw new TE("unsupported PASETO purpose");let a={footer:n?SE(n):void 0,payload:void 0,version:r,purpose:i};if(i==="local")return a;let m=r==="v1"?256:64,c;try{c=SE(o).slice(0,-m)}catch(h){throw new vE("token value is not a PASETO formatted value")}return e?a.payload=jN(c):a.payload=c,a}});var EE=Y((Rpe,PE)=>{var HN=ME();PE.exports={decode:HN}});var AE=Y((_pe,DE)=>{var GN=ki(),KN=cE(),JN=wE(),{decode:QN}=EE();DE.exports={decode:QN,V1:KN,V2:JN,errors:GN}});var I0=Y(zf=>{Object.defineProperty(zf,"__esModule",{value:!0});var xV;(function(t){t[t.None=0]="None",t[t.Error=1]="Error",t[t.Debug=2]="Debug",t[t.Verbose=3]="Verbose"})(xV=zf.LogLevel||(zf.LogLevel={}))});var k0=Y(Wf=>{Object.defineProperty(Wf,"__esModule",{value:!0});var vV;(function(t){t.Ok="ok",t.Exited="exited",t.Crashed="crashed",t.Abnormal="abnormal"})(vV=Wf.SessionStatus||(Wf.SessionStatus={}))});var R0=Y(Pl=>{Object.defineProperty(Pl,"__esModule",{value:!0});var O0;(function(t){t.Fatal="fatal",t.Error="error",t.Warning="warning",t.Log="log",t.Info="info",t.Debug="debug",t.Critical="critical"})(O0=Pl.Severity||(Pl.Severity={}));(function(t){function e(r){switch(r){case"debug":return t.Debug;case"info":return t.Info;case"warn":case"warning":return t.Warning;case"error":return t.Error;case"fatal":return t.Fatal;case"critical":return t.Critical;case"log":default:return t.Log}}t.fromString=e})(O0=Pl.Severity||(Pl.Severity={}))});var N0=Y(El=>{Object.defineProperty(El,"__esModule",{value:!0});var _0;(function(t){t.Unknown="unknown",t.Skipped="skipped",t.Success="success",t.RateLimit="rate_limit",t.Invalid="invalid",t.Failed="failed"})(_0=El.Status||(El.Status={}));(function(t){function e(r){return r>=200&&r<300?t.Success:r===429?t.RateLimit:r>=400&&r<500?t.Invalid:r>=500?t.Failed:t.Unknown}t.fromHttpCode=e})(_0=El.Status||(El.Status={}))});var B0=Y(qf=>{Object.defineProperty(qf,"__esModule",{value:!0});var TV;(function(t){t.Explicit="explicitly_set",t.Sampler="client_sampler",t.Rate="client_rate",t.Inheritance="inheritance"})(TV=qf.TransactionSamplingMethod||(qf.TransactionSamplingMethod={}))});var C0=Y(Qs=>{Object.defineProperty(Qs,"__esModule",{value:!0});var SV=I0();Qs.LogLevel=SV.LogLevel;var MV=k0();Qs.SessionStatus=MV.SessionStatus;var PV=R0();Qs.Severity=PV.Severity;var EV=N0();Qs.Status=EV.Status;var DV=B0();Qs.TransactionSamplingMethod=DV.TransactionSamplingMethod});var hL=Y(Nb=>{var dL="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");Nb.encode=function(t){if(0<=t&&t<dL.length)return dL[t];throw new TypeError("Must be between 0 and 63: "+t)};Nb.decode=function(t){var e=65,r=90,i=97,o=122,n=48,s=57,a=43,m=47,c=26,h=52;return e<=t&&t<=r?t-e:i<=t&&t<=o?t-i+c:n<=t&&t<=s?t-n+h:t==a?62:t==m?63:-1}});var Vb=Y(Bb=>{var gL=hL(),Cb=5,yL=1<<Cb,bL=yL-1,wL=yL;function uU(t){return t<0?(-t<<1)+1:(t<<1)+0}function cU(t){var e=(t&1)==1,r=t>>1;return e?-r:r}Bb.encode=function(e){var r="",i,o=uU(e);do i=o&bL,o>>>=Cb,o>0&&(i|=wL),r+=gL.encode(i);while(o>0);return r};Bb.decode=function(e,r,i){var o=e.length,n=0,s=0,a,m;do{if(r>=o)throw new Error("Expected more digits in base 64 VLQ value.");if(m=gL.decode(e.charCodeAt(r++)),m===-1)throw new Error("Invalid base64 digit: "+e.charAt(r-1));a=!!(m&wL),m&=bL,n=n+(m<<s),s+=Cb}while(a);i.value=cU(n),i.rest=r}});var Ll=Y(pr=>{function pU(t,e,r){if(e in t)return t[e];if(arguments.length===3)return r;throw new Error('"'+e+'" is a required argument.')}pr.getArg=pU;var xL=/^(?:([\w+\-.]+):)?\/\/(?:(\w+:\w+)@)?([\w.-]*)(?::(\d+))?(.*)$/,fU=/^data:.+\,.+$/;function Tu(t){var e=t.match(xL);return e?{scheme:e[1],auth:e[2],host:e[3],port:e[4],path:e[5]}:null}pr.urlParse=Tu;function Al(t){var e="";return t.scheme&&(e+=t.scheme+":"),e+="//",t.auth&&(e+=t.auth+"@"),t.host&&(e+=t.host),t.port&&(e+=":"+t.port),t.path&&(e+=t.path),e}pr.urlGenerate=Al;function Ub(t){var e=t,r=Tu(t);if(r){if(!r.path)return t;e=r.path}for(var i=pr.isAbsolute(e),o=e.split(/\/+/),n,s=0,a=o.length-1;a>=0;a--)n=o[a],n==="."?o.splice(a,1):n===".."?s++:s>0&&(n===""?(o.splice(a+1,s),s=0):(o.splice(a,2),s--));return e=o.join("/"),e===""&&(e=i?"/":"."),r?(r.path=e,Al(r)):e}pr.normalize=Ub;function vL(t,e){t===""&&(t="."),e===""&&(e=".");var r=Tu(e),i=Tu(t);if(i&&(t=i.path||"/"),r&&!r.scheme)return i&&(r.scheme=i.scheme),Al(r);if(r||e.match(fU))return e;if(i&&!i.host&&!i.path)return i.host=e,Al(i);var o=e.charAt(0)==="/"?e:Ub(t.replace(/\/+$/,"")+"/"+e);return i?(i.path=o,Al(i)):o}pr.join=vL;pr.isAbsolute=function(t){return t.charAt(0)==="/"||xL.test(t)};function dU(t,e){t===""&&(t="."),t=t.replace(/\/$/,"");for(var r=0;e.indexOf(t+"/")!==0;){var i=t.lastIndexOf("/");if(i<0||(t=t.slice(0,i),t.match(/^([^\/]+:\/)?\/*$/)))return e;++r}return Array(r+1).join("../")+e.substr(t.length+1)}pr.relative=dU;var TL=function(){var t=Object.create(null);return!("__proto__"in t)}();function SL(t){return t}function hU(t){return ML(t)?"$"+t:t}pr.toSetString=TL?SL:hU;function gU(t){return ML(t)?t.slice(1):t}pr.fromSetString=TL?SL:gU;function ML(t){if(!t)return!1;var e=t.length;if(e<9||t.charCodeAt(e-1)!==95||t.charCodeAt(e-2)!==95||t.charCodeAt(e-3)!==111||t.charCodeAt(e-4)!==116||t.charCodeAt(e-5)!==111||t.charCodeAt(e-6)!==114||t.charCodeAt(e-7)!==112||t.charCodeAt(e-8)!==95||t.charCodeAt(e-9)!==95)return!1;for(var r=e-10;r>=0;r--)if(t.charCodeAt(r)!==36)return!1;return!0}function yU(t,e,r){var i=Fl(t.source,e.source);return i!==0||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0||r)||(i=t.generatedColumn-e.generatedColumn,i!==0)||(i=t.generatedLine-e.generatedLine,i!==0)?i:Fl(t.name,e.name)}pr.compareByOriginalPositions=yU;function bU(t,e,r){var i=t.generatedLine-e.generatedLine;return i!==0||(i=t.generatedColumn-e.generatedColumn,i!==0||r)||(i=Fl(t.source,e.source),i!==0)||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0)?i:Fl(t.name,e.name)}pr.compareByGeneratedPositionsDeflated=bU;function Fl(t,e){return t===e?0:t===null?1:e===null?-1:t>e?1:-1}function wU(t,e){var r=t.generatedLine-e.generatedLine;return r!==0||(r=t.generatedColumn-e.generatedColumn,r!==0)||(r=Fl(t.source,e.source),r!==0)||(r=t.originalLine-e.originalLine,r!==0)||(r=t.originalColumn-e.originalColumn,r!==0)?r:Fl(t.name,e.name)}pr.compareByGeneratedPositionsInflated=wU;function xU(t){return JSON.parse(t.replace(/^\)]}'[^\n]*\n/,""))}pr.parseSourceMapInput=xU;function vU(t,e,r){if(e=e||"",t&&(t[t.length-1]!=="/"&&e[0]!=="/"&&(t+="/"),e=t+e),r){var i=Tu(r);if(!i)throw new Error("sourceMapURL could not be parsed");if(i.path){var o=i.path.lastIndexOf("/");o>=0&&(i.path=i.path.substring(0,o+1))}e=vL(Al(i),e)}return Ub(e)}pr.computeSourceURL=vU});var qb=Y(PL=>{var zb=Ll(),Wb=Object.prototype.hasOwnProperty,ea=typeof Map!="undefined";function Qo(){this._array=[],this._set=ea?new Map:Object.create(null)}Qo.fromArray=function(e,r){for(var i=new Qo,o=0,n=e.length;o<n;o++)i.add(e[o],r);return i};Qo.prototype.size=function(){return ea?this._set.size:Object.getOwnPropertyNames(this._set).length};Qo.prototype.add=function(e,r){var i=ea?e:zb.toSetString(e),o=ea?this.has(e):Wb.call(this._set,i),n=this._array.length;(!o||r)&&this._array.push(e),o||(ea?this._set.set(e,n):this._set[i]=n)};Qo.prototype.has=function(e){if(ea)return this._set.has(e);var r=zb.toSetString(e);return Wb.call(this._set,r)};Qo.prototype.indexOf=function(e){if(ea){var r=this._set.get(e);if(r>=0)return r}else{var i=zb.toSetString(e);if(Wb.call(this._set,i))return this._set[i]}throw new Error('"'+e+'" is not in the set.')};Qo.prototype.at=function(e){if(e>=0&&e<this._array.length)return this._array[e];throw new Error("No element indexed by "+e)};Qo.prototype.toArray=function(){return this._array.slice()};PL.ArraySet=Qo});var AL=Y(EL=>{var DL=Ll();function TU(t,e){var r=t.generatedLine,i=e.generatedLine,o=t.generatedColumn,n=e.generatedColumn;return i>r||i==r&&n>=o||DL.compareByGeneratedPositionsInflated(t,e)<=0}function td(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}td.prototype.unsortedForEach=function(e,r){this._array.forEach(e,r)};td.prototype.add=function(e){TU(this._last,e)?(this._last=e,this._array.push(e)):(this._sorted=!1,this._array.push(e))};td.prototype.toArray=function(){return this._sorted||(this._array.sort(DL.compareByGeneratedPositionsInflated),this._sorted=!0),this._array};EL.MappingList=td});var jb=Y(FL=>{var Su=Vb(),Lt=Ll(),rd=qb().ArraySet,SU=AL().MappingList;function gi(t){t||(t={}),this._file=Lt.getArg(t,"file",null),this._sourceRoot=Lt.getArg(t,"sourceRoot",null),this._skipValidation=Lt.getArg(t,"skipValidation",!1),this._sources=new rd,this._names=new rd,this._mappings=new SU,this._sourcesContents=null}gi.prototype._version=3;gi.fromSourceMap=function(e){var r=e.sourceRoot,i=new gi({file:e.file,sourceRoot:r});return e.eachMapping(function(o){var n={generated:{line:o.generatedLine,column:o.generatedColumn}};o.source!=null&&(n.source=o.source,r!=null&&(n.source=Lt.relative(r,n.source)),n.original={line:o.originalLine,column:o.originalColumn},o.name!=null&&(n.name=o.name)),i.addMapping(n)}),e.sources.forEach(function(o){var n=o;r!==null&&(n=Lt.relative(r,o)),i._sources.has(n)||i._sources.add(n);var s=e.sourceContentFor(o);s!=null&&i.setSourceContent(o,s)}),i};gi.prototype.addMapping=function(e){var r=Lt.getArg(e,"generated"),i=Lt.getArg(e,"original",null),o=Lt.getArg(e,"source",null),n=Lt.getArg(e,"name",null);this._skipValidation||this._validateMapping(r,i,o,n),o!=null&&(o=String(o),this._sources.has(o)||this._sources.add(o)),n!=null&&(n=String(n),this._names.has(n)||this._names.add(n)),this._mappings.add({generatedLine:r.line,generatedColumn:r.column,originalLine:i!=null&&i.line,originalColumn:i!=null&&i.column,source:o,name:n})};gi.prototype.setSourceContent=function(e,r){var i=e;this._sourceRoot!=null&&(i=Lt.relative(this._sourceRoot,i)),r!=null?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[Lt.toSetString(i)]=r):this._sourcesContents&&(delete this._sourcesContents[Lt.toSetString(i)],Object.keys(this._sourcesContents).length===0&&(this._sourcesContents=null))};gi.prototype.applySourceMap=function(e,r,i){var o=r;if(r==null){if(e.file==null)throw new Error(`SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map's "file" property. Both were omitted.`);o=e.file}var n=this._sourceRoot;n!=null&&(o=Lt.relative(n,o));var s=new rd,a=new rd;this._mappings.unsortedForEach(function(m){if(m.source===o&&m.originalLine!=null){var c=e.originalPositionFor({line:m.originalLine,column:m.originalColumn});c.source!=null&&(m.source=c.source,i!=null&&(m.source=Lt.join(i,m.source)),n!=null&&(m.source=Lt.relative(n,m.source)),m.originalLine=c.line,m.originalColumn=c.column,c.name!=null&&(m.name=c.name))}var h=m.source;h!=null&&!s.has(h)&&s.add(h);var x=m.name;x!=null&&!a.has(x)&&a.add(x)},this),this._sources=s,this._names=a,e.sources.forEach(function(m){var c=e.sourceContentFor(m);c!=null&&(i!=null&&(m=Lt.join(i,m)),n!=null&&(m=Lt.relative(n,m)),this.setSourceContent(m,c))},this)};gi.prototype._validateMapping=function(e,r,i,o){if(r&&typeof r.line!="number"&&typeof r.column!="number")throw new Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.");if(!(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0&&!r&&!i&&!o)){if(e&&"line"in e&&"column"in e&&r&&"line"in r&&"column"in r&&e.line>0&&e.column>=0&&r.line>0&&r.column>=0&&i)return;throw new Error("Invalid mapping: "+JSON.stringify({generated:e,source:i,original:r,name:o}))}};gi.prototype._serializeMappings=function(){for(var e=0,r=1,i=0,o=0,n=0,s=0,a="",m,c,h,x,S=this._mappings.toArray(),F=0,U=S.length;F<U;F++){if(c=S[F],m="",c.generatedLine!==r)for(e=0;c.generatedLine!==r;)m+=";",r++;else if(F>0){if(!Lt.compareByGeneratedPositionsInflated(c,S[F-1]))continue;m+=","}m+=Su.encode(c.generatedColumn-e),e=c.generatedColumn,c.source!=null&&(x=this._sources.indexOf(c.source),m+=Su.encode(x-s),s=x,m+=Su.encode(c.originalLine-1-o),o=c.originalLine-1,m+=Su.encode(c.originalColumn-i),i=c.originalColumn,c.name!=null&&(h=this._names.indexOf(c.name),m+=Su.encode(h-n),n=h)),a+=m}return a};gi.prototype._generateSourcesContent=function(e,r){return e.map(function(i){if(!this._sourcesContents)return null;r!=null&&(i=Lt.relative(r,i));var o=Lt.toSetString(i);return Object.prototype.hasOwnProperty.call(this._sourcesContents,o)?this._sourcesContents[o]:null},this)};gi.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return this._file!=null&&(e.file=this._file),this._sourceRoot!=null&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e};gi.prototype.toString=function(){return JSON.stringify(this.toJSON())};FL.SourceMapGenerator=gi});var LL=Y(ta=>{ta.GREATEST_LOWER_BOUND=1;ta.LEAST_UPPER_BOUND=2;function Hb(t,e,r,i,o,n){var s=Math.floor((e-t)/2)+t,a=o(r,i[s],!0);return a===0?s:a>0?e-s>1?Hb(s,e,r,i,o,n):n==ta.LEAST_UPPER_BOUND?e<i.length?e:-1:s:s-t>1?Hb(t,s,r,i,o,n):n==ta.LEAST_UPPER_BOUND?s:t<0?-1:t}ta.search=function(e,r,i,o){if(r.length===0)return-1;var n=Hb(-1,r.length,e,r,i,o||ta.GREATEST_LOWER_BOUND);if(n<0)return-1;for(;n-1>=0&&i(r[n],r[n-1],!0)===0;)--n;return n}});var kL=Y(IL=>{function Gb(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}function MU(t,e){return Math.round(t+Math.random()*(e-t))}function Kb(t,e,r,i){if(r<i){var o=MU(r,i),n=r-1;Gb(t,o,i);for(var s=t[i],a=r;a<i;a++)e(t[a],s)<=0&&(n+=1,Gb(t,n,a));Gb(t,n+1,a);var m=n+1;Kb(t,e,r,m-1),Kb(t,e,m+1,i)}}IL.quickSort=function(t,e){Kb(t,e,0,t.length-1)}});var RL=Y(id=>{var q=Ll(),Jb=LL(),Il=qb().ArraySet,PU=Vb(),Mu=kL().quickSort;function Qe(t,e){var r=t;return typeof t=="string"&&(r=q.parseSourceMapInput(t)),r.sections!=null?new Ni(r,e):new ir(r,e)}Qe.fromSourceMap=function(t,e){return ir.fromSourceMap(t,e)};Qe.prototype._version=3;Qe.prototype.__generatedMappings=null;Object.defineProperty(Qe.prototype,"_generatedMappings",{configurable:!0,enumerable:!0,get:function(){return this.__generatedMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__generatedMappings}});Qe.prototype.__originalMappings=null;Object.defineProperty(Qe.prototype,"_originalMappings",{configurable:!0,enumerable:!0,get:function(){return this.__originalMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__originalMappings}});Qe.prototype._charIsMappingSeparator=function(e,r){var i=e.charAt(r);return i===";"||i===","};Qe.prototype._parseMappings=function(e,r){throw new Error("Subclasses must implement _parseMappings")};Qe.GENERATED_ORDER=1;Qe.ORIGINAL_ORDER=2;Qe.GREATEST_LOWER_BOUND=1;Qe.LEAST_UPPER_BOUND=2;Qe.prototype.eachMapping=function(e,r,i){var o=r||null,n=i||Qe.GENERATED_ORDER,s;switch(n){case Qe.GENERATED_ORDER:s=this._generatedMappings;break;case Qe.ORIGINAL_ORDER:s=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var a=this.sourceRoot;s.map(function(m){var c=m.source===null?null:this._sources.at(m.source);return c=q.computeSourceURL(a,c,this._sourceMapURL),{source:c,generatedLine:m.generatedLine,generatedColumn:m.generatedColumn,originalLine:m.originalLine,originalColumn:m.originalColumn,name:m.name===null?null:this._names.at(m.name)}},this).forEach(e,o)};Qe.prototype.allGeneratedPositionsFor=function(e){var r=q.getArg(e,"line"),i={source:q.getArg(e,"source"),originalLine:r,originalColumn:q.getArg(e,"column",0)};if(i.source=this._findSourceIndex(i.source),i.source<0)return[];var o=[],n=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",q.compareByOriginalPositions,Jb.LEAST_UPPER_BOUND);if(n>=0){var s=this._originalMappings[n];if(e.column===void 0)for(var a=s.originalLine;s&&s.originalLine===a;)o.push({line:q.getArg(s,"generatedLine",null),column:q.getArg(s,"generatedColumn",null),lastColumn:q.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n];else for(var m=s.originalColumn;s&&s.originalLine===r&&s.originalColumn==m;)o.push({line:q.getArg(s,"generatedLine",null),column:q.getArg(s,"generatedColumn",null),lastColumn:q.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n]}return o};id.SourceMapConsumer=Qe;function ir(t,e){var r=t;typeof t=="string"&&(r=q.parseSourceMapInput(t));var i=q.getArg(r,"version"),o=q.getArg(r,"sources"),n=q.getArg(r,"names",[]),s=q.getArg(r,"sourceRoot",null),a=q.getArg(r,"sourcesContent",null),m=q.getArg(r,"mappings"),c=q.getArg(r,"file",null);if(i!=this._version)throw new Error("Unsupported version: "+i);s&&(s=q.normalize(s)),o=o.map(String).map(q.normalize).map(function(h){return s&&q.isAbsolute(s)&&q.isAbsolute(h)?q.relative(s,h):h}),this._names=Il.fromArray(n.map(String),!0),this._sources=Il.fromArray(o,!0),this._absoluteSources=this._sources.toArray().map(function(h){return q.computeSourceURL(s,h,e)}),this.sourceRoot=s,this.sourcesContent=a,this._mappings=m,this._sourceMapURL=e,this.file=c}ir.prototype=Object.create(Qe.prototype);ir.prototype.consumer=Qe;ir.prototype._findSourceIndex=function(t){var e=t;if(this.sourceRoot!=null&&(e=q.relative(this.sourceRoot,e)),this._sources.has(e))return this._sources.indexOf(e);var r;for(r=0;r<this._absoluteSources.length;++r)if(this._absoluteSources[r]==t)return r;return-1};ir.fromSourceMap=function(e,r){var i=Object.create(ir.prototype),o=i._names=Il.fromArray(e._names.toArray(),!0),n=i._sources=Il.fromArray(e._sources.toArray(),!0);i.sourceRoot=e._sourceRoot,i.sourcesContent=e._generateSourcesContent(i._sources.toArray(),i.sourceRoot),i.file=e._file,i._sourceMapURL=r,i._absoluteSources=i._sources.toArray().map(function(F){return q.computeSourceURL(i.sourceRoot,F,r)});for(var s=e._mappings.toArray().slice(),a=i.__generatedMappings=[],m=i.__originalMappings=[],c=0,h=s.length;c<h;c++){var x=s[c],S=new OL;S.generatedLine=x.generatedLine,S.generatedColumn=x.generatedColumn,x.source&&(S.source=n.indexOf(x.source),S.originalLine=x.originalLine,S.originalColumn=x.originalColumn,x.name&&(S.name=o.indexOf(x.name)),m.push(S)),a.push(S)}return Mu(i.__originalMappings,q.compareByOriginalPositions),i};ir.prototype._version=3;Object.defineProperty(ir.prototype,"sources",{get:function(){return this._absoluteSources.slice()}});function OL(){this.generatedLine=0,this.generatedColumn=0,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}ir.prototype._parseMappings=function(e,r){for(var i=1,o=0,n=0,s=0,a=0,m=0,c=e.length,h=0,x={},S={},F=[],U=[],Fe,or,$e,$,ee;h<c;)if(e.charAt(h)===";")i++,h++,o=0;else if(e.charAt(h)===",")h++;else{for(Fe=new OL,Fe.generatedLine=i,$=h;$<c&&!this._charIsMappingSeparator(e,$);$++);if(or=e.slice(h,$),$e=x[or],$e)h+=or.length;else{for($e=[];h<$;)PU.decode(e,h,S),ee=S.value,h=S.rest,$e.push(ee);if($e.length===2)throw new Error("Found a source, but no line and column");if($e.length===3)throw new Error("Found a source and line, but no column");x[or]=$e}Fe.generatedColumn=o+$e[0],o=Fe.generatedColumn,$e.length>1&&(Fe.source=a+$e[1],a+=$e[1],Fe.originalLine=n+$e[2],n=Fe.originalLine,Fe.originalLine+=1,Fe.originalColumn=s+$e[3],s=Fe.originalColumn,$e.length>4&&(Fe.name=m+$e[4],m+=$e[4])),U.push(Fe),typeof Fe.originalLine=="number"&&F.push(Fe)}Mu(U,q.compareByGeneratedPositionsDeflated),this.__generatedMappings=U,Mu(F,q.compareByOriginalPositions),this.__originalMappings=F};ir.prototype._findMapping=function(e,r,i,o,n,s){if(e[i]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+e[i]);if(e[o]<0)throw new TypeError("Column must be greater than or equal to 0, got "+e[o]);return Jb.search(e,r,n,s)};ir.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var r=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var i=this._generatedMappings[e+1];if(r.generatedLine===i.generatedLine){r.lastGeneratedColumn=i.generatedColumn-1;continue}}r.lastGeneratedColumn=Infinity}};ir.prototype.originalPositionFor=function(e){var r={generatedLine:q.getArg(e,"line"),generatedColumn:q.getArg(e,"column")},i=this._findMapping(r,this._generatedMappings,"generatedLine","generatedColumn",q.compareByGeneratedPositionsDeflated,q.getArg(e,"bias",Qe.GREATEST_LOWER_BOUND));if(i>=0){var o=this._generatedMappings[i];if(o.generatedLine===r.generatedLine){var n=q.getArg(o,"source",null);n!==null&&(n=this._sources.at(n),n=q.computeSourceURL(this.sourceRoot,n,this._sourceMapURL));var s=q.getArg(o,"name",null);return s!==null&&(s=this._names.at(s)),{source:n,line:q.getArg(o,"originalLine",null),column:q.getArg(o,"originalColumn",null),name:s}}}return{source:null,line:null,column:null,name:null}};ir.prototype.hasContentsOfAllSources=function(){return this.sourcesContent?this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return e==null}):!1};ir.prototype.sourceContentFor=function(e,r){if(!this.sourcesContent)return null;var i=this._findSourceIndex(e);if(i>=0)return this.sourcesContent[i];var o=e;this.sourceRoot!=null&&(o=q.relative(this.sourceRoot,o));var n;if(this.sourceRoot!=null&&(n=q.urlParse(this.sourceRoot))){var s=o.replace(/^file:\/\//,"");if(n.scheme=="file"&&this._sources.has(s))return this.sourcesContent[this._sources.indexOf(s)];if((!n.path||n.path=="/")&&this._sources.has("/"+o))return this.sourcesContent[this._sources.indexOf("/"+o)]}if(r)return null;throw new Error('"'+o+'" is not in the SourceMap.')};ir.prototype.generatedPositionFor=function(e){var r=q.getArg(e,"source");if(r=this._findSourceIndex(r),r<0)return{line:null,column:null,lastColumn:null};var i={source:r,originalLine:q.getArg(e,"line"),originalColumn:q.getArg(e,"column")},o=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",q.compareByOriginalPositions,q.getArg(e,"bias",Qe.GREATEST_LOWER_BOUND));if(o>=0){var n=this._originalMappings[o];if(n.source===i.source)return{line:q.getArg(n,"generatedLine",null),column:q.getArg(n,"generatedColumn",null),lastColumn:q.getArg(n,"lastGeneratedColumn",null)}}return{line:null,column:null,lastColumn:null}};id.BasicSourceMapConsumer=ir;function Ni(t,e){var r=t;typeof t=="string"&&(r=q.parseSourceMapInput(t));var i=q.getArg(r,"version"),o=q.getArg(r,"sections");if(i!=this._version)throw new Error("Unsupported version: "+i);this._sources=new Il,this._names=new Il;var n={line:-1,column:0};this._sections=o.map(function(s){if(s.url)throw new Error("Support for url field in sections not implemented.");var a=q.getArg(s,"offset"),m=q.getArg(a,"line"),c=q.getArg(a,"column");if(m<n.line||m===n.line&&c<n.column)throw new Error("Section offsets must be ordered and non-overlapping.");return n=a,{generatedOffset:{generatedLine:m+1,generatedColumn:c+1},consumer:new Qe(q.getArg(s,"map"),e)}})}Ni.prototype=Object.create(Qe.prototype);Ni.prototype.constructor=Qe;Ni.prototype._version=3;Object.defineProperty(Ni.prototype,"sources",{get:function(){for(var t=[],e=0;e<this._sections.length;e++)for(var r=0;r<this._sections[e].consumer.sources.length;r++)t.push(this._sections[e].consumer.sources[r]);return t}});Ni.prototype.originalPositionFor=function(e){var r={generatedLine:q.getArg(e,"line"),generatedColumn:q.getArg(e,"column")},i=Jb.search(r,this._sections,function(n,s){var a=n.generatedLine-s.generatedOffset.generatedLine;return a||n.generatedColumn-s.generatedOffset.generatedColumn}),o=this._sections[i];return o?o.consumer.originalPositionFor({line:r.generatedLine-(o.generatedOffset.generatedLine-1),column:r.generatedColumn-(o.generatedOffset.generatedLine===r.generatedLine?o.generatedOffset.generatedColumn-1:0),bias:e.bias}):{source:null,line:null,column:null,name:null}};Ni.prototype.hasContentsOfAllSources=function(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})};Ni.prototype.sourceContentFor=function(e,r){for(var i=0;i<this._sections.length;i++){var o=this._sections[i],n=o.consumer.sourceContentFor(e,!0);if(n)return n}if(r)return null;throw new Error('"'+e+'" is not in the SourceMap.')};Ni.prototype.generatedPositionFor=function(e){for(var r=0;r<this._sections.length;r++){var i=this._sections[r];if(i.consumer._findSourceIndex(q.getArg(e,"source"))!==-1){var o=i.consumer.generatedPositionFor(e);if(o){var n={line:o.line+(i.generatedOffset.generatedLine-1),column:o.column+(i.generatedOffset.generatedLine===o.line?i.generatedOffset.generatedColumn-1:0)};return n}}}return{line:null,column:null}};Ni.prototype._parseMappings=function(e,r){this.__generatedMappings=[],this.__originalMappings=[];for(var i=0;i<this._sections.length;i++)for(var o=this._sections[i],n=o.consumer._generatedMappings,s=0;s<n.length;s++){var a=n[s],m=o.consumer._sources.at(a.source);m=q.computeSourceURL(o.consumer.sourceRoot,m,this._sourceMapURL),this._sources.add(m),m=this._sources.indexOf(m);var c=null;a.name&&(c=o.consumer._names.at(a.name),this._names.add(c),c=this._names.indexOf(c));var h={source:m,generatedLine:a.generatedLine+(o.generatedOffset.generatedLine-1),generatedColumn:a.generatedColumn+(o.generatedOffset.generatedLine===a.generatedLine?o.generatedOffset.generatedColumn-1:0),originalLine:a.originalLine,originalColumn:a.originalColumn,name:c};this.__generatedMappings.push(h),typeof h.originalLine=="number"&&this.__originalMappings.push(h)}Mu(this.__generatedMappings,q.compareByGeneratedPositionsDeflated),Mu(this.__originalMappings,q.compareByOriginalPositions)};id.IndexedSourceMapConsumer=Ni});var NL=Y(_L=>{var EU=jb().SourceMapGenerator,od=Ll(),DU=/(\r?\n)/,AU=10,kl="$$$isSourceNode$$$";function ei(t,e,r,i,o){this.children=[],this.sourceContents={},this.line=t??null,this.column=e??null,this.source=r??null,this.name=o??null,this[kl]=!0,i!=null&&this.add(i)}ei.fromStringWithSourceMap=function(e,r,i){var o=new ei,n=e.split(DU),s=0,a=function(){var S=U(),F=U()||"";return S+F;function U(){return s<n.length?n[s++]:void 0}},m=1,c=0,h=null;return r.eachMapping(function(S){if(h!==null)if(m<S.generatedLine)x(h,a()),m++,c=0;else{var F=n[s]||"",U=F.substr(0,S.generatedColumn-c);n[s]=F.substr(S.generatedColumn-c),c=S.generatedColumn,x(h,U),h=S;return}for(;m<S.generatedLine;)o.add(a()),m++;if(c<S.generatedColumn){var F=n[s]||"";o.add(F.substr(0,S.generatedColumn)),n[s]=F.substr(S.generatedColumn),c=S.generatedColumn}h=S},this),s<n.length&&(h&&x(h,a()),o.add(n.splice(s).join(""))),r.sources.forEach(function(S){var F=r.sourceContentFor(S);F!=null&&(i!=null&&(S=od.join(i,S)),o.setSourceContent(S,F))}),o;function x(S,F){if(S===null||S.source===void 0)o.add(F);else{var U=i?od.join(i,S.source):S.source;o.add(new ei(S.originalLine,S.originalColumn,U,F,S.name))}}};ei.prototype.add=function(e){if(Array.isArray(e))e.forEach(function(r){this.add(r)},this);else if(e[kl]||typeof e=="string")e&&this.children.push(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};ei.prototype.prepend=function(e){if(Array.isArray(e))for(var r=e.length-1;r>=0;r--)this.prepend(e[r]);else if(e[kl]||typeof e=="string")this.children.unshift(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};ei.prototype.walk=function(e){for(var r,i=0,o=this.children.length;i<o;i++)r=this.children[i],r[kl]?r.walk(e):r!==""&&e(r,{source:this.source,line:this.line,column:this.column,name:this.name})};ei.prototype.join=function(e){var r,i,o=this.children.length;if(o>0){for(r=[],i=0;i<o-1;i++)r.push(this.children[i]),r.push(e);r.push(this.children[i]),this.children=r}return this};ei.prototype.replaceRight=function(e,r){var i=this.children[this.children.length-1];return i[kl]?i.replaceRight(e,r):typeof i=="string"?this.children[this.children.length-1]=i.replace(e,r):this.children.push("".replace(e,r)),this};ei.prototype.setSourceContent=function(e,r){this.sourceContents[od.toSetString(e)]=r};ei.prototype.walkSourceContents=function(e){for(var r=0,i=this.children.length;r<i;r++)this.children[r][kl]&&this.children[r].walkSourceContents(e);for(var o=Object.keys(this.sourceContents),r=0,i=o.length;r<i;r++)e(od.fromSetString(o[r]),this.sourceContents[o[r]])};ei.prototype.toString=function(){var e="";return this.walk(function(r){e+=r}),e};ei.prototype.toStringWithSourceMap=function(e){var r={code:"",line:1,column:0},i=new EU(e),o=!1,n=null,s=null,a=null,m=null;return this.walk(function(c,h){r.code+=c,h.source!==null&&h.line!==null&&h.column!==null?((n!==h.source||s!==h.line||a!==h.column||m!==h.name)&&i.addMapping({source:h.source,original:{line:h.line,column:h.column},generated:{line:r.line,column:r.column},name:h.name}),n=h.source,s=h.line,a=h.column,m=h.name,o=!0):o&&(i.addMapping({generated:{line:r.line,column:r.column}}),n=null,o=!1);for(var x=0,S=c.length;x<S;x++)c.charCodeAt(x)===AU?(r.line++,r.column=0,x+1===S?(n=null,o=!1):o&&i.addMapping({source:h.source,original:{line:h.line,column:h.column},generated:{line:r.line,column:r.column},name:h.name})):r.column++}),this.walkSourceContents(function(c,h){i.setSourceContent(c,h)}),{code:r.code,map:i}};_L.SourceNode=ei});var BL=Y(nd=>{nd.SourceMapGenerator=jb().SourceMapGenerator;nd.SourceMapConsumer=RL().SourceMapConsumer;nd.SourceNode=NL().SourceNode});var VL=Y((N4e,CL)=>{var FU=Object.prototype.toString,Qb=typeof Buffer.alloc=="function"&&typeof Buffer.allocUnsafe=="function"&&typeof Buffer.from=="function";function LU(t){return FU.call(t).slice(8,-1)==="ArrayBuffer"}function IU(t,e,r){e>>>=0;var i=t.byteLength-e;if(i<0)throw new RangeError("'offset' is out of bounds");if(r===void 0)r=i;else if(r>>>=0,r>i)throw new RangeError("'length' is out of bounds");return Qb?Buffer.from(t.slice(e,e+r)):new Buffer(new Uint8Array(t.slice(e,e+r)))}function kU(t,e){if((typeof e!="string"||e==="")&&(e="utf8"),!Buffer.isEncoding(e))throw new TypeError('"encoding" must be a valid string encoding');return Qb?Buffer.from(t,e):new Buffer(t,e)}function OU(t,e,r){if(typeof t=="number")throw new TypeError('"value" argument must not be a number');return LU(t)?IU(t,e,r):typeof t=="string"?kU(t,e):Qb?Buffer.from(t):new Buffer(t)}CL.exports=OU});var KL=Y((ra,$b)=>{var RU=BL().SourceMapConsumer,Yb=require("path"),go;try{go=require("fs"),(!go.existsSync||!go.readFileSync)&&(go=null)}catch(t){}var _U=VL();function UL(t,e){return t.require(e)}var zL=!1,WL=!1,Xb=!1,Pu="auto",ia={},Eu={},NU=/^data:application\/json[^,]+base64,/,Vn=[],Un=[];function Zb(){return Pu==="browser"?!0:Pu==="node"?!1:typeof window!="undefined"&&typeof XMLHttpRequest=="function"&&!(window.require&&window.module&&window.process&&window.process.type==="renderer")}function BU(){return typeof process=="object"&&process!==null&&typeof process.on=="function"}function sd(t){return function(e){for(var r=0;r<t.length;r++){var i=t[r](e);if(i)return i}return null}}var ew=sd(Vn);Vn.push(function(t){if(t=t.trim(),/^file:/.test(t)&&(t=t.replace(/file:\/\/\/(\w:)?/,function(i,o){return o?"":"/"})),t in ia)return ia[t];var e="";try{if(go)go.existsSync(t)&&(e=go.readFileSync(t,"utf8"));else{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),r.readyState===4&&r.status===200&&(e=r.responseText)}}catch(i){}return ia[t]=e});function tw(t,e){if(!t)return e;var r=Yb.dirname(t),i=/^\w+:\/\/[^\/]*/.exec(r),o=i?i[0]:"",n=r.slice(o.length);return o&&/^\/\w\:/.test(n)?(o+="/",o+Yb.resolve(r.slice(o.length),e).replace(/\\/g,"/")):o+Yb.resolve(r.slice(o.length),e)}function CU(t){var e;if(Zb())try{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),e=r.readyState===4?r.responseText:null;var i=r.getResponseHeader("SourceMap")||r.getResponseHeader("X-SourceMap");if(i)return i}catch(a){}e=ew(t);for(var o=/(?:\/\/[@#][\s]*sourceMappingURL=([^\s'"]+)[\s]*$)|(?:\/\*[@#][\s]*sourceMappingURL=([^\s*'"]+)[\s]*(?:\*\/)[\s]*$)/mg,n,s;s=o.exec(e);)n=s;return n?n[1]:null}var rw=sd(Un);Un.push(function(t){var e=CU(t);if(!e)return null;var r;if(NU.test(e)){var i=e.slice(e.indexOf(",")+1);r=_U(i,"base64").toString(),e=t}else e=tw(t,e),r=ew(e);return r?{url:e,map:r}:null});function iw(t){var e=Eu[t.source];if(!e){var r=rw(t.source);r?(e=Eu[t.source]={url:r.url,map:new RU(r.map)},e.map.sourcesContent&&e.map.sources.forEach(function(o,n){var s=e.map.sourcesContent[n];if(s){var a=tw(e.url,o);ia[a]=s}})):e=Eu[t.source]={url:null,map:null}}if(e&&e.map&&typeof e.map.originalPositionFor=="function"){var i=e.map.originalPositionFor(t);if(i.source!==null)return i.source=tw(e.url,i.source),i}return t}function qL(t){var e=/^eval at ([^(]+) \((.+):(\d+):(\d+)\)$/.exec(t);if(e){var r=iw({source:e[2],line:+e[3],column:e[4]-1});return"eval at "+e[1]+" ("+r.source+":"+r.line+":"+(r.column+1)+")"}return e=/^eval at ([^(]+) \((.+)\)$/.exec(t),e?"eval at "+e[1]+" ("+qL(e[2])+")":t}function VU(){var t,e="";if(this.isNative())e="native";else{t=this.getScriptNameOrSourceURL(),!t&&this.isEval()&&(e=this.getEvalOrigin(),e+=", "),t?e+=t:e+="<anonymous>";var r=this.getLineNumber();if(r!=null){e+=":"+r;var i=this.getColumnNumber();i&&(e+=":"+i)}}var o="",n=this.getFunctionName(),s=!0,a=this.isConstructor(),m=!(this.isToplevel()||a);if(m){var c=this.getTypeName();c==="[object Object]"&&(c="null");var h=this.getMethodName();n?(c&&n.indexOf(c)!=0&&(o+=c+"."),o+=n,h&&n.indexOf("."+h)!=n.length-h.length-1&&(o+=" [as "+h+"]")):o+=c+"."+(h||"<anonymous>")}else a?o+="new "+(n||"<anonymous>"):n?o+=n:(o+=e,s=!1);return s&&(o+=" ("+e+")"),o}function jL(t){var e={};return Object.getOwnPropertyNames(Object.getPrototypeOf(t)).forEach(function(r){e[r]=/^(?:is|get)/.test(r)?function(){return t[r].call(t)}:t[r]}),e.toString=VU,e}function HL(t,e){if(e===void 0&&(e={nextPosition:null,curPosition:null}),t.isNative())return e.curPosition=null,t;var r=t.getFileName()||t.getScriptNameOrSourceURL();if(r){var i=t.getLineNumber(),o=t.getColumnNumber()-1,n=/^v(10\.1[6-9]|10\.[2-9][0-9]|10\.[0-9]{3,}|1[2-9]\d*|[2-9]\d|\d{3,}|11\.11)/,s=n.test(process.version)?0:62;i===1&&o>s&&!Zb()&&!t.isEval()&&(o-=s);var a=iw({source:r,line:i,column:o});e.curPosition=a,t=jL(t);var m=t.getFunctionName;return t.getFunctionName=function(){return e.nextPosition==null?m():e.nextPosition.name||m()},t.getFileName=function(){return a.source},t.getLineNumber=function(){return a.line},t.getColumnNumber=function(){return a.column+1},t.getScriptNameOrSourceURL=function(){return a.source},t}var c=t.isEval()&&t.getEvalOrigin();return c&&(c=qL(c),t=jL(t),t.getEvalOrigin=function(){return c}),t}function UU(t,e){Xb&&(ia={},Eu={});for(var r=t.name||"Error",i=t.message||"",o=r+": "+i,n={nextPosition:null,curPosition:null},s=[],a=e.length-1;a>=0;a--)s.push(`
    at `+HL(e[a],n)),n.nextPosition=n.curPosition;return n.curPosition=n.nextPosition=null,o+s.reverse().join("")}function GL(t){var e=/\n    at [^(]+ \((.*):(\d+):(\d+)\)/.exec(t.stack);if(e){var r=e[1],i=+e[2],o=+e[3],n=ia[r];if(!n&&go&&go.existsSync(r))try{n=go.readFileSync(r,"utf8")}catch(a){n=""}if(n){var s=n.split(/(?:\r\n|\r|\n)/)[i-1];if(s)return r+":"+i+`
`+s+`
`+new Array(o).join(" ")+"^"}}return null}function zU(t){var e=GL(t);process.stderr._handle&&process.stderr._handle.setBlocking&&process.stderr._handle.setBlocking(!0),e&&(console.error(),console.error(e)),console.error(t.stack),process.exit(1)}function WU(){var t=process.emit;process.emit=function(e){if(e==="uncaughtException"){var r=arguments[1]&&arguments[1].stack,i=this.listeners(e).length>0;if(r&&!i)return zU(arguments[1])}return t.apply(this,arguments)}}var qU=Vn.slice(0),jU=Un.slice(0);ra.wrapCallSite=HL;ra.getErrorSource=GL;ra.mapSourcePosition=iw;ra.retrieveSourceMap=rw;ra.install=function(t){if(t=t||{},t.environment&&(Pu=t.environment,["node","browser","auto"].indexOf(Pu)===-1))throw new Error("environment "+Pu+" was unknown. Available options are {auto, browser, node}");if(t.retrieveFile&&(t.overrideRetrieveFile&&(Vn.length=0),Vn.unshift(t.retrieveFile)),t.retrieveSourceMap&&(t.overrideRetrieveSourceMap&&(Un.length=0),Un.unshift(t.retrieveSourceMap)),t.hookRequire&&!Zb()){var e=UL($b,"module"),r=e.prototype._compile;r.__sourceMapSupport||(e.prototype._compile=function(n,s){return ia[s]=n,Eu[s]=void 0,r.call(this,n,s)},e.prototype._compile.__sourceMapSupport=!0)}if(Xb||(Xb="emptyCacheBetweenOperations"in t?t.emptyCacheBetweenOperations:!1),zL||(zL=!0,Error.prepareStackTrace=UU),!WL){var i="handleUncaughtExceptions"in t?t.handleUncaughtExceptions:!0;try{var o=UL($b,"worker_threads");o.isMainThread===!1&&(i=!1)}catch(n){}i&&BU()&&(WL=!0,WU())}};ra.resetRetrieveHandlers=function(){Vn.length=0,Un.length=0,Vn=qU.slice(0),Un=jU.slice(0),rw=sd(Un),ew=sd(Vn)}});var vS=M(require("commander")),TS=M(require("process"));var dS=M(require("process"));function Ol(t){return t!=null&&typeof t!="string"&&typeof t[Symbol.iterator]=="function"}function d(t){return t==null?"":typeof t=="string"?t:Array.isArray(t)?t.map(d).join(","):t.toString()}var tI=["number","string","boolean"];function ri(t){return tI.indexOf(typeof t)!==-1||t instanceof Date}function Du(t){return Array.isArray(t)&&t.every(ri)}var sw=["boolean","number","bigint","symbol","string","object","function"];function Bt(t,e){if(t==null&&e==null)return 0;if(t==null)return-1;if(e==null)return 1;let r=typeof t,i=typeof e;return(r==="string"||r==="symbol")&&(i==="string"||i==="symbol")?d(t).localeCompare(d(e)):Array.isArray(t)&&Array.isArray(e)?rI(t,e):r!==i?sw.indexOf(r)-sw.indexOf(i):t>e?1:t<e?-1:0}function yi(t,e){return Bt(t,e)<0}function aw(t,e){return Bt(t,e)<=0}function Ci(t,e){return Bt(t,e)>=0}function Rl(t,e){return Bt(t,e)>0}function rI(t,e){if(N(t)&&N(e))return 0;let r=Math.min(t.length,e.length);for(let i=0;i<r;i++){let o=Bt(t[i],e[i]);if(o!==0)return o}return Bt(t.length,e.length)}var ii;(function(t){t[t.Empty=0]="Empty",t[t.Primitive=1]="Primitive",t[t.Symbol=2]="Symbol",t[t.Object=3]="Object",t[t.Array=4]="Array",t[t.Iterable=5]="Iterable",t[t.Instance=6]="Instance",t[t.Function=7]="Function",t[t.Unknown=8]="Unknown"})(ii||(ii={}));function iI(t){return typeof t=="symbol"}function xe(t){return typeof t=="function"}function Au(t){return oI(t)===3}function oI(t){return t==null?0:iI(t)?2:ri(t)?1:Array.isArray(t)?4:Ol(t)?5:xe(t)?7:typeof t=="object"?t.constructor!=null&&t.constructor.name==="Object"?3:6:8}function Cr(t){return xe(t)?t():t}var ld=()=>{};function p(t,e){return t==null?void 0:e(t)}function oa(t,e,r){return t==null||e==null?void 0:r(t,e)}function lw(t,e,r,i){return t==null||e==null||r==null?void 0:i(t,e,r)}function w(t,e){return t??Cr(e)}function Z(t,e,r){return t!=null?e(t):Cr(r)}function Wn(t,e,r,i){return w(oa(t,e,r),i)}function Vi(t){return t!=null}function Fu(t){return t!=null&&t.every(Vi)}function Lu(...t){return t.find(Vi)}function na(t){return t==null||d(t)==="null"?void 0:t}function P(t){if(t==null)return!0;let e=d(t);return e.length===0||e.trim().length===0}var nI=/^\s*(?:null|undefined)?\s*$/i;function sa(t){return t==null||nI.exec(t)!=null}function T(t){return!P(t)}function md(t){if(t==null)return;let e=d(t);return e.length===0||e.trim().length===0?void 0:e}function oi(t,e){if(t==null)return Cr(e);let r=d(t).trim();return r.length>0?r:Cr(e)}function ud(t,e){return P(t)?!1:e(t)}function K(t,e){if(t===!1||t==null||t==="")return;let r=d(t);return T(r)?e(r):void 0}function fr(t,e,r){return w(K(t,e),r)}function aa(...t){for(let e of t)if(T(e))return e}function I(t,e,r,i){return JSON.stringify(t,sI(e,i),na(r))}function sI(t,e){let r=[],i=[],o=e??((n,s)=>r[0]===s?"[Circular ~]":"[Circular ~."+i.slice(0,r.indexOf(s)).join(".")+"]");return function(n,s){if(r.length>0){let m=r.indexOf(this);m>=0?(r.splice(m+1),i.splice(m,Infinity,n)):(r.push(this),i.push(n)),r.indexOf(s)>=0&&(s=o.call(this,n,s))}else r.push(s);return t==null?s:t.call(this,n,s)}}function yo(t,e){return I(t)===I(e)}function mw(t){return t!=null&&(Array.isArray(t)||isFinite(t.length)&&xe(t[Symbol.iterator])&&xe(t.push)&&xe(t.pop)&&xe(t.forEach)&&xe(t.some))}function Pr(t,e,r){if(e==null)throw new Error("null key");if(t.has(e))return t.get(e);{let i=r();return i!=null&&t.set(e,i),i}}var cd;(function(U){U.isDefined=!1,U.isEmpty=!0,U.get=()=>{},U.exists=()=>!1;let o=()=>U;U.map=o,U.flatMap=o,U.filter=o,U.forEach=o,U.getOrElse=Fe=>Fe(),U.orElse=Fe=>W(Fe()),U.zip1=o,U.zip2=o,U.zip3=o})(cd||(cd={}));var uw=cd,_l=class{constructor(e){this.a=e;this.isDefined=!0;this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new _l(e(this.a))}flatMap(e){let r=e(this.a);return cw(r)?r:W(r)}filter(e){return W(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,r){return W(e).flatMap(i=>r(this.a,i))}zip2(e,r,i){return W(e).flatMap(o=>W(r).flatMap(n=>i(this.a,o,n)))}zip3(e,r,i,o){return W(e).flatMap(n=>W(r).flatMap(s=>W(i).flatMap(a=>o(this.a,n,s,a))))}};function cw(t){return t instanceof _l||t===uw}function W(t){return cw(t)?t:t!=null?new _l(t):uw}function oe(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function Nl(t,e){return oe(t)?e(t):void 0}var Iu=t=>(e,r)=>oe(e)&&oe(r)&&t(e,r),qn=Iu((t,e)=>t<e),jn=Iu((t,e)=>t<=e),bo=Iu((t,e)=>t>e),Hn=Iu((t,e)=>t>=e);function pw(t,e,r){return t==null||e==null?!1:Math.abs(t-e)<r}function aI(t){if(!oe(t))return;let e=Math.trunc(t);return e===0?Math.abs(e):e}function lI(t){return xe(t.toNumber)}function fw(t,e){if(P(t))return e.defaultValue;if(oe(t))return e.nton(t);if(lI(t))return e.nton(t.toNumber());try{let r=e.ston(d(t));return oe(r)?e.nton(r):e.defaultValue}catch{return e.defaultValue}}function V(t,e){return fw(t,g({defaultValue:void 0,nton:r=>aI(r),ston:parseInt},e))}function ni(t,e){return fw(t,g({defaultValue:void 0,nton:r=>r,ston:parseFloat},e))}function k(t){return oe(t)&&t>0}function dw(t,e){return oe(t)&&oe(e)&&t>e?t:void 0}function ku(t){return oe(t)&&t>=0}function la(t,e){return W(t).flatMap(r=>V(r)).flatMap(e).get()}function pd(t){let e=V(t);return k(e)?String(e):void 0}function wo(t,e){return oe(t)?e(t):void 0}function Gn(t,e,r){return wo(t,i=>wo(e,o=>r(i,o)))}function fd(t,e,r){return oe(t)?e(t):r}function hw(t,e){return oe(t)?t:Cr(e)}function Ye(t){return t<0?-Math.round(-t):Math.round(t)}function ve(t,e){if(t===0||e===0)return 0;let r=e-Ye(Math.ceil(Math.log10(Math.abs(t)))),i=Math.pow(10,Math.abs(r));return r<0?Ye(t/i)*i:Ye(t*i)/i}function re(t,e,r){if(t>e||!oe(t)||!oe(e))throw new Error(`invalid clamp(${t}, ${e}, ${r})`);return oe(r)?r<t?t:r>e?e:r:Ye((t+e)/2)}function Te(t,e){if(!k(t))return[];let r=Math.round(t);return r<=0?[]:[...Array(r)].map((i,o)=>e(o))}function Ct(t,e,r=[]){if(t=Math.ceil(t),e=Math.floor(e),e<t)return t;if(L(r)&&r.length+10>e-t){let o=xo(t,e).filter(n=>!r.includes(n));return Me(o,n=>n[Ct(0,o.length)])}let i=Math.floor(Math.random()*(e-t))+t;return r.includes(i)?Ct(t,e,r):i}var gw="0123456789abcdefghijkmnopqrstuvwxyz";function Bl(t,e=gw){let r="";for(let i=0;i<t;i++)r+=mI(e);return r}function mI(t=gw){return t[Ct(0,t.length)]}function It(t){return typeof t=="string"}function Ui(t,e){return t=d(t),e=d(e),t.startsWith(e)?t:e+t}function Vt(t,e){return t=d(t),e=d(e),t.endsWith(e)?t:t+e}function sr(t,e=80){if(t==null)return"";let r=d(t);return r.length<=e?r:r.slice(0,e-1)+"\u2026"}var vo=/\r?\n/gm;function uI(t,e,r){r==null&&(r=t.length);for(let i=r;i>=0;i--)if(t.substr(i).startsWith(e))return i;return-1}function To(t,e={maxLineLen:75,prefix:""}){if(t.includes(`
`))return pe(t.split(vo).map(i=>To(i,e)));if(t=Ui(d(t),e.prefix).trim(),t.length<=e.maxLineLen)return[t];let r=uI(t," ",e.maxLineLen);if(r>e.prefix.length)return[t.slice(0,r),...To(t.slice(r+1),e)];{let i=t.indexOf(" ",e.prefix.length+1);return i>0&&i<t.length-1?[t.slice(0,i),...To(t.slice(i+1),e)]:[t]}}function Cl(t,e,r){return e===""?t:t.split(e).join(r)}function zi(...t){return t.join(" ").replace(/\s+/g," ").trim()}function D(t){return t==null?[]:Array.isArray(t)?t:Ol(t)?Array.from(t):[t]}function L(t){return mw(t)&&t.length>0&&t.some(e=>e!=null)}function N(t){return!L(t)}function Me(t,e){return L(t)?e(t):void 0}function cI(t){return ri(t)||Du(t)?t:t.valueOf()}function pe(t,e=[]){if(t==null)return e;for(let r of t)if(r!=null)if(Array.isArray(r))for(let i of r)i!=null&&e.push(i);else e.push(r);return e}function dr(t){return Kn(A(t),cI)}function dd(t,e){for(let r=0;r<t.length;r++)e[r]=t[r];return e.length=t.length,e}function Kn(t,e){return dd(ie(t,e),t)}function ie(t,e){return D(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:p(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>Bt(r.cmp,i.cmp)).map(r=>r.item)}function Ru(t,e){return t!=null&&e!=null&&t.length===e.length&&t.every((r,i)=>r===e[i])}function _u(t,e){return Ru(t.slice(0,e.length),e)}function vt(t,e){for(let r=0;r<t.length;)e(t[r],r,t)?r++:t.splice(r,1);return t}function So(t,e){if(t==null)return!1;for(let r of t)if(e.valueOf()===r.valueOf())return!0;return!1}function Nu(t,e){return t==null||e==null?!1:e.every(r=>So(t,r))}function Bu(t,e,r){let i=t.map(r);for(let o of e){let n=r(o);i.includes(n)||(t.push(o),i.push(n))}return t}function A(t){if(t==null)return[];let e=D(t);return e.every(Vi)?e:e.filter(Vi)}function ma(t){let e=D(t).filter(r=>!sa(d(r)));return It(e[0])?e.map(r=>d(r).trim()):e}function z(t){return D(t).map(e=>d(e).trim()).filter(e=>e.length>0)}function G(t){return Mo(A(t),e=>I(e))}function Mo(t,e=r=>I(r)){if(N(t))return[];let r=new Map;for(let i of t)if(i!=null){let o=e(i);o!=null&&Pr(r,o,()=>i)}return[...r.values()]}function Er(t,e){return t.reduce((r,i,o)=>r+(e(i,o)?1:0),0)}function Ou(t,e){return t.reduce((r,i,o)=>r+e(i,o),0)}function Vl(t,e){if(t==null||e==null)return 0;if(t===e||(typeof t=="string"&&(t=t.split("")),typeof e=="string"&&(e=e.split("")),Ru(t,e)))return t.length;let r=0;for(;t[r]===e[r];)r++;return r}function xo(t,e,r=i=>i){return Jn(t,e,1,r)}function Jn(t,e,r=1,i=o=>o){let o=[];if(t<e)for(let n=t;n<e;n+=r)o.push(i(n));else for(let n=t;n>e;n-=r)o.push(i(n));return o}function Cu(t,e){let r=new Set(e);return t.filter(i=>!r.has(i))}function Vu(t){return t!=null?t[t.length-1]:void 0}function l(t,e){return new yw(t,e).asMemoizedThunk()}var yw=class{constructor(e,r){this.thunk=e;this.ttlMs=r;this.lastSet=0;this.listeners=[]}asMemoizedThunk(){let e=this.apply.bind(this);return e.set=this.set.bind(this),e.clear=this.clear.bind(this),e.unset=this.unset.bind(this),e.prior=this.prior.bind(this),e.refresh=this.refresh.bind(this),e.ttl=this.ttl.bind(this),e.setTTL=this.setTTL.bind(this),e.onChange=this.onChange.bind(this),e.toJSON=this.toJSON.bind(this),e.lastSetAgoMs=this.lastSetAgoMs.bind(this),e}async onSetResult(e,r){if(N(this.listeners))return;let i=await e,o=await r;if(!yo(i,o))for(let n of this.listeners)n(o,i)}setResult(e){return this.lastSet=Date.now(),this.onSetResult(this.result,e),this.result=e}apply(){return(this.lastSet===0||this.ttlMs!=null&&this.lastSet+this.ttlMs<=Date.now())&&this.setResult(this.thunk()),this.result}set(e){return this.setResult(e)}unset(){this.setResult(void 0),this.lastSet=0}clear(){let e=this.result;return this.unset(),e}prior(){return this.result}refresh(){return this.setResult(this.thunk())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=e}onChange(e){this.listeners.push(e),p(this.result,e)}toJSON(){return"(Lazy)"}lastSetAgoMs(){return Date.now()-this.lastSet}};var v=1e3,E=60*v,ft=60*E,lt=24*ft,Uu=7*lt,bw=365.25*lt,fz=l(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));function ua(t){return t instanceof Date}function ww(t,e){return new Date(w(e,new Date).getTime()-t)}function Wi(t){let e=ua(t)?t.getTime():oe(t)?t:Date.now();return Math.floor(e/v)}function Qn(t){let e=String(t);return e.length>=2?e:("0"+e).slice(-2)}function xw(t){let e=ua(t)?t:new Date(t);return e.getFullYear()+Qn(e.getMonth()+1)+Qn(e.getDate())+Qn(e.getHours())+Qn(e.getMinutes())+Qn(e.getSeconds())}function zu(t){let e=ua(t)?t:new Date(t);return e.getFullYear()+"-"+Qn(e.getMonth()+1)+"-"+Qn(e.getDate())}function Se(...t){let e=Object.freeze(t),r={};for(let a of e)r[a]=a;let i=a=>a!=null&&e.includes(a),o=a=>a==null?-1:e.indexOf(a),n=(a,m)=>i(a)?a:Cr(m),s=(a,m)=>i(a)?m(a):void 0;return g(g({},r),{values:e,length:e.length,has:i,indexOf:o,validOrElse:n,mapValid:s})}var ca=M(require("process"));function hd(t){return typeof t=="boolean"}function O(t){if(typeof t=="boolean")return t;if(t==null)return!1;if(t===1)return!0;let e=String(t).toLowerCase();return["true","1"].includes(e)}function vw(t){return O(t)?!0:bi(t)?!1:void 0}function Tw(t){return O(t)?1:0}function bi(t){if(typeof t=="boolean")return!t;if(t==null)return!1;if(t===0)return!0;let e=String(t).toLowerCase();return["false","0"].includes(e)}function pI(){switch(d(ca.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return ca.argv.some(t=>t.endsWith("mocha")||t.endsWith(".spec.js"))?"test":"production"}}var $o=(()=>{let t=pI();return ca.env.NODE_ENV=t,t})();var ne=$o==="test",hr=$o==="production";function $n(){return ne&&O(ca.env.SINGLE_SPEC_TESTS)}var qi=Date.now();var Yn="PhotoStructure",wi=l(()=>Yn+(hr?"":`-${$o}`));function Pe(t,e){return r=>`[${t}m${r}[${e}m`}var Pz=Pe(30,39),Wu=Pe(31,39),qu=Pe(32,39),pa=Pe(33,39),ju=Pe(34,39),Hu=Pe(35,39),Gu=Pe(36,39),Ez=Pe(37,39),fa=Pe(90,39),Sw=Pe(91,39),Dz=Pe(92,39),Mw=Pe(93,39),Pw=Pe(94,39),Az=Pe(95,39),Fz=Pe(96,39),Lz=Pe(97,39),Ew=Pe(40,49),Iz=Pe(41,49),kz=Pe(42,49),Oz=Pe(43,49),Rz=Pe(44,49),_z=Pe(45,49),Nz=Pe(46,49),Bz=Pe(47,49),Cz=Pe(100,49),Vz=Pe(101,49),Uz=Pe(102,49),zz=Pe(103,49),Wz=Pe(104,49),qz=Pe(105,49),jz=Pe(106,49),Hz=Pe(107,49);var Iw=M(require("process"));function kt(t,e){return e!=null?e(t):typeof t=="string"?console.log(t):console.dir(t,{depth:3}),t}function Tt(t){return t==null||typeof t!="object"?[]:Object.keys(t).filter(e=>typeof e=="string"&&(t.propertyIsEnumerable==null||t.propertyIsEnumerable(e)===!0))}function St(t){return Tt(t).map(e=>t[e])}function Xe(t){return Tt(t).map(e=>[e,t[e]])}function mt(t,e){return typeof e!="object"&&(e={}),A(t).reduce((r,[i,o])=>kt(r,()=>{i!=null&&o!=null&&(r[i]=o)}),e)}function xi(t){if(t==null)return;let e=Xe(t).filter(([r,i])=>r!=null&&i!=null);return N(e)?void 0:mt(e)}function gd(t){if(t==null)return;let e=Xe(t).filter(([r,i])=>r!=null&&T(i));return N(e)?void 0:mt(e)}function Yo(t,e,r={}){let i=A(Xe(t).sort(([o],[n])=>o.localeCompare(n,void 0,{sensitivity:"base"})).map(([o,n])=>e(o,n)));return mt(i.filter(([o,n])=>o!=null&&n!=null),r)}function Mt(t,...e){if(t==null)return t;if(!e.every(i=>typeof i=="string"))throw new Error("bad keys: "+I(e));if(N(e))return{};let r={};for(let i of e){let o=t[i];o!=null&&(r[i]=o)}return r}function jt(t,...e){if(t==null||e.every(i=>P(t[i])))return t;let r=Xe(t).filter(([i])=>!e.includes(i));return N(r)?void 0:mt(r)}function Ku(t){return St(t).every(e=>e!=null)}function Ul(t){return Ku(t)?t:void 0}function Dw(t){return t.filter(Ku)}function Aw(t){return mt(ie(Xe(t),([e])=>e.toLowerCase()))}function Fw(t,e){return t==null?t:mt(Xe(t).filter(([r,i])=>e(r,i)))}function Ju(t,e,...r){return t!=null&&xe(t[e])?t[e].bind(t)(...r):void 0}function Lw(t,e){if(P(e))return;if(t[e]!=null)return t[e];let r=e.toLocaleLowerCase().normalize();for(let i of Tt(t))if(r===i.toLocaleLowerCase().normalize()&&t[i]!=null)return t[i]}function ze(t){return Lw(Iw.env,t)}function Po(t){return O(ze(t))}var kw=M(require("util"));var fI=require("deep-eql");function Dr(t,e){return fI(t,e)}async function Xn(t,e){return Wn(await t,await e,Dr,()=>!1)}async function yd(t,e,...r){return Wn(await t,await e,(i,o)=>Dr(Mt(i,...r),Mt(o,...r)),()=>!1)}function Qu(...t){return t!=null&&t.every(T)}function Ow(t){return t==null||t.some(e=>e==null)}function Ze(t,e){if(t!=null)for(let r of A(t)){let i=e(r);if(i!=null)return i}}async function Zn(t,e){if(t!=null){let r=-1;for(let i of t){r++;try{if(i==null)continue;let o=await e(i,r);if(o!=null)return o}catch(o){}}}}function Rw(t,e){for(let r=t.length-1;r>=0;r--)if(e(t[r]))return t[r]}function _w(t,...e){let r=t.length;return vt(t,i=>e.every(o=>!Dr(i,o))),r!==t.length}var Nw=t=>{if(ri(t))return t;if(Array.isArray(t))return I(t);if(xe(t.valueOf))return t.valueOf();throw new Error("Cannot get primitive value for "+(0,kw.inspect)(t))};function bd(t,e,r=Nw){let i=new Set(e.map(r));return t.filter(o=>i.has(r(o)))}function Bw(t,e,r=Nw){return N(t)&&N(e)?1:bd(t,e,r).length*2/(t.length+e.length)}function $u(t,e=r=>I(r)){dd(Mo(t,e),t)}function da(t,e){let r=[],i=[];return t.forEach((o,n)=>(e(o,n)?r:i).push(o)),[r,i]}function Vw(t){return Cw(t.sort())}function Cw(t){if(t==null||t.length===0)return[];let e=t[0],r=t.lastIndexOf(e);return[{t:e,count:r+1},...Cw(t.slice(r+1))]}function Uw(t,e){return t.reduce((r,i)=>r.concat(...A(e(i))),[])}function Yu(t,e){return t.length>e&&t.splice(0,t.length-e),t}function zw(t,e){return t.length=Math.min(t.length,e),t}function es(...t){let e=Math.max(...t.map(r=>r.length));return Te(e,r=>t.map(i=>i[r]))}function Ww(...t){let e=Math.max(...t.map(i=>i.length)),r=[];return Te(e,i=>t.map(o=>r.push(o[i]))),r}function qw(t){return Te(t.length,e=>t.slice(0,e+1))}function wd(t){return jw(t,e=>e.valueOf())}function Xu(t){return t[Hw(t)]}function Hw(t){return Gw(t,e=>e.valueOf())}function jw(t,e){return Kw(t,e,(r,i)=>yi(r,i))}function Gw(t,e){return Kw(t,e,(r,i)=>Rl(r,i))}function Xo(t,e){return t[jw(t,e)]}function dt(t,e){return t[Gw(t,e)]}function Kw(t,e,r){if(N(t))return-1;let i=-1,o;for(let n=0;n<t.length;n++){let s=t[n];if(s!=null){let a=e(s);a!=null&&(o==null||r(a,o)===!0)&&(i=n,o=a)}}return i}function Zo(t,e){return e<=0&&(e=1),Jn(0,t.length,e,r=>t.slice(r,r+e))}var nx=M(require("util"));var ts=class{constructor(e){this.maxLength=e;this._length=0;this._firstIndex=0;if(e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...Te(e,()=>null))}mapIndex(e,r){return e=Math.trunc(e)??0,e<0&&(e+=this._length),e<0||e>this._length-1?void 0:r((e+this._firstIndex+this.maxLength)%this.maxLength)}item(e){return this.mapIndex(e,r=>this.store[r])}set(e,r){return this.mapIndex(e,i=>this.store[i]=r)}get length(){return this._length}set length(e){this._length=re(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){let e=this;function*r(){for(let i=0;i<e.length;i++)yield e.mapIndex(i,o=>e.store[o])}return r()}push(...e){for(let r of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,i=>{this.store[i]=r});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(let r of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,i=>{this.store[i]=r,this._firstIndex=i});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}shiftOrFirst(){return this.length>1?this.shift():this.item(0)}every(e){for(let r=0;r<this._length;r++)if(!e(this.item(r),r))return!1;return!0}some(e){for(let r=0;r<this._length;r++)if(e(this.item(r),r))return!0;return!1}forEach(e){for(let r=0;r<this._length;r++)e(this.item(r),r)}map(e){let r=[];for(let i=0;i<this._length;i++)r.push(e(this.item(i),i));return r}reduce(e,r){let i=r;for(let o=0;o<this._length;o++)i=e(i,this.item(o),o);return i}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,r=>{this.mapIndex(this._length-1-e,i=>{let o=this.store[i];this.store[i]=this.store[r],this.store[r]=o})});return this}toA(){return[...this]}slice(e,r){return[...this].slice(e,r)}};var dI=require("he"),zl={};function ha(t,e){if(e<1)return"";for(zl[t]==null&&(zl[t]=t);e>zl[t].length;)zl[t]+=t;return zl[t].substring(0,e)}function vi(t,e,r){if(r.length===0)throw new Error("leftPad() given empty pad");if(typeof t=="number"&&t<0)return"-"+vi(String(-t),e-1,r);let i=String(t);return ha(r,e-i.length)+i}function Jw(t,e,r){if(r.length===0)throw new Error("rightPad() given empty pad");let i=String(t);return i+ha(r,e-i.length)}function Ht(t){return vi(t,2,"0")}function Qw(t,e,r,i){return t.substr(0,e)+ha(i,r)+t.substr(e+r)}function en(t,e,r){let i=Math.min(Math.ceil(t.length/e),w(r,()=>t.length))-1;return i<=0?[t]:[...Te(i,o=>t.slice(o*e,(o+1)*e)),t.slice(i*e)]}function xd(t,e){let r=e.exec(t);if(r==null||r[1]==null)return;let i=r[0].indexOf(r[1])+r.index;return{captured:r[1],uncaptured:t.substring(0,i)+t.substring(i+r[1].length),unmatched:t.substring(0,r.index)+t.substring(r.index+r[0].length),matchedIndex:i}}function He(t,e){let r=d(t),i=d(e);return i.length>0&&r.startsWith(i)?r.slice(i.length):r}function Zu(t,e){return t=d(t),e=d(e),$w(t,e)?t.slice(e.length):t}function gr(t,e){if(e==null)return t;let r=d(t),i=d(e);return i.length>0&&r.endsWith(i)?r.slice(0,-i.length):r}function Yw(t,e,r){return e==null?gr(t,r):(t=d(t),t.endsWith(r)&&t.startsWith(e)?t.slice(e.length,-r.length):t)}function Xw(t,e=80,r=80){let i=d(t),o=i.length-(e+r);return o<=0?i:i.slice(0,e).trim()+" \u2026(+"+o+" chars)\u2026"+i.slice(-r).trim()}function ec(t){t=d(t);let e=t.normalize().split("");return P(t)?t:e[0].toLocaleUpperCase()+e.slice(1).join("")}function vd(t,e){return t.localeCompare(e,void 0,{sensitivity:"base"})}function ot(t,e){if(t==null||e==null)return!1;let r=d(t),i=d(e);return r.length!==i.length?!1:r===i||r.toLowerCase()===i.toLowerCase()?!0:r.localeCompare(i,void 0,{sensitivity:"base"})===0||vd(r.normalize(),i.normalize())===0}function Td(t){return t.sort(vd)}function Zw(t,e){return D(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:p(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>{let o=vd(r.cmp[0],i.cmp[0]);return o!==0?o:Bt(r.cmp[1],i.cmp[1])}).map(r=>r.item)}function $w(t,e){return t==null||e==null||e.length===0||t.length===0?!1:ot(t.substring(0,e.length),e)}function tn(t,e){return N(t)||P(e)?!1:t.some(r=>ot(e,r))}function ji(t){return d(t).replace(/\u001b\[[0-9;]+[a-z]/gi,"")}var hI=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function Sd(t){return hI.reduce((e,[r,i])=>e.replace(r,i),t).normalize()}var gI=/^(['"]).+\1$/;function Md(t){return P(t)||(t=d(t).trim(),gI.exec(Sd(t))!=null&&(t=t.slice(1,-1).trim())),t}function ex(t){return t.split(/(?<=[\\/_,:=-]+)/).map(e=>dI.escape(e.normalize())).join("<wbr>")}function Pd(t){return d(t).normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function tx(t){return d(t).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")}function rx(t){let e=Td(z(t)),r=e.filter((i,o)=>!$w(e[o+1],i));return ie(r,i=>t.indexOf(i))}function ix(...t){return t.find(k)}function Ed(...t){for(let e of pe(t)){let r=ni(e);if(r!=null&&r!==0)return r}}function rn(t,e){return la(t,r=>r>=0?e(r):void 0)}function ga(t,e){return wo(t,r=>r>=0?e(r):void 0)}function se(t,e){return la(t,r=>r>0?e(r):void 0)}function ya(t,e,r){return w(se(t,e),r)}function Pt(t,e,r){return r==null||!oe(r)?!1:([t,e]=[Math.min(t,e),Math.max(t,e)],Hn(r,t)&&jn(r,e))}var yI=/[+-]?[0-9\,\.]+/;function Dd(t){if(oe(t))return t;if(P(t))return;let e=String(t);return p(yI.exec(e),r=>ni(e.substr(r.index)))}function ox(t){return V(Dd(t))}var ht=class{constructor(e=20){this.maxSamples=e;this._n=0,this._samples=new ts(e)}static merge(e,r){if(e.n===0&&r.n===0)return new ht(Math.max(e.maxSamples,r.maxSamples));if(e.n===0)return r.clone();if(r.n===0)return e.clone();if(e.n<=e.maxSamples){let i=r.clone();return i.pushAll(e.samples),i}else if(r.n<=r.maxSamples){let i=e.clone();return i.pushAll(r.samples),i}else{let i=new ht(Math.max(e.maxSamples,r.maxSamples));i._n=e.n+r.n,i._avg=e._avg*e.n/i.n+r._avg*r.n/i.n,i._min=Math.min(e._min,r._min),i._max=Math.max(e._max,r._max),i._m=e._m*e.n/i.n+r._m*r.n/i.n,i._s=e._s*e.n/i.n+r._s*r.n/i.n;let o=pe(es(e.samples,r.samples));return i._samples.push(...o),i._weightedTotalAvg=Wl([i._avg,...o]),i}}[nx.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=this._min==null?e:Math.min(e,this._min),this._max=this._max==null?e:Math.max(e,this._max),this._n===1||this._m==null||this._s==null||this._avg==null||this._weightedTotalAvg==null)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{let r=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-r)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return kt(new ht(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){return e.forEach(r=>this.push(r)),this}stats(e=2){let r=o=>p(o,n=>ve(n,e)),i={};return this.empty||(i.sum=r(this.sum),i.mean=r(this.avg),i.sd=r(this.stdDev)),i.k=ve(this.n,e),i}get empty(){return this._n===0}get n(){return this._n}get avg(){return this.empty?void 0:ve(this._avg,4)}get sum(){return this._avg==null||this.empty?0:this._avg*this._n}get max(){return this._max}get min(){return this._min}get p84(){return se(this.avg,e=>se(this.stdDev,r=>e+r))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return p(this.variance,Math.sqrt)}get sampleMode(){return p(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;let r=new rs;return this._samples.forEach(i=>r.incr(i)),r.topKeys(e)}get sampleStdDev(){return Me(this._samples,ax)}get sampleAvg(){return Me(this._samples,Ot)}get sampleSlope(){return w(Me(this._samples,sx),0)}get samples(){return[...this._samples]}p(e){if(this._samples.length===0)return 0;let r=[...this._samples].sort((o,n)=>o-n),i=Math.floor(r.length*(e/100));return r[i]}get weightedSampleAvg(){return Me(this._samples,e=>ve(Wl(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}};var rs=class{constructor(){this.m=new Map}incr(e,r=1){let i=this.get(e)+r;return i===0?this.m.delete(e):this.m.set(e,i),this}get(e){return w(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){let e=new ht(0);for(let r of this.keys())if(oe(r))e.push(r);else return;return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){let e=this.keyAvg();return ie([...this.entries()],([r,i])=>[-i,fd(e,o=>Math.abs(r-o),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(r=>r[0])}get averageCounts(){return kt(new ht(this.size),e=>[...this.m.values()].forEach(r=>e.push(r)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return dr([...this.keys()]).map(e=>e+" "+this.get(e)).join(`
`)}};function lx(t){return t instanceof Set?t:new Set(D(t))}function tc(t,e){return new Set([...t,...e])}function Ad(t,e){let r=lx(e);return new Set([...t].filter(i=>r.has(i)))}function mx(t,e){let r=lx(e);return new Set([...t].filter(i=>!r.has(i)))}function ux(t){let e;for(let r of t)r!=null&&(e==null||r<e)&&(e=r);return e}function is(t){let e;for(let r of t)r!=null&&(e==null||r>e)&&(e=r);return e}function Fd(t,e){let r=new rs;return D(t).forEach(i=>Nl(i,o=>r.incr(o))),r.topKeys(e)}function Ld(t){return Fd(t,1)[0]}function Hi(t){return D(t).reduce((e,r)=>oe(r)?e+r:e,0)}function Ot(t){let e=A(D(t));return N(e)?void 0:e.reduce((r,i,o)=>o===0?i:r*o/(o+1)+i/(o+1),0)}function sx(t){let e=D(t);return p(Ot(e),r=>{let i=(e.length-1)/2,o=Hi(e.map((s,a)=>(s-r)*(a-i))),n=Hi(e.map(s=>(s-r)**2));return n===0?0:o/n})}function bI(t){return p(Ot(t),e=>Ot(t.map(r=>Math.pow(r-e,2))))}function ax(t){return p(bI(t),e=>Math.sqrt(e))}function Wl(t){let e;for(let r of t)e=e==null?r:(e+r)/2;return e??NaN}var on=class{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return Hi([...this.store.values()].map(e=>e.length))}add(e,...r){let i=Pr(this.store,e,()=>[]);return i.push(...r),i}set(e,r){this.store.set(e,r)}delete(e,r){if(r==null)return this.store.delete(e);{let i=this.store.get(e);if(i==null)return!1;{let o=_w(i,r);return o&&i.length===0&&this.store.delete(e),o}}}clear(){return this.store.clear(),this}keys(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield i)}return r()}values(){let e=this;function*r(){for(let[,i]of e.store.entries())i.length>0&&(yield i)}return r()}flatValues(){let e=this;function*r(){for(let[,i]of e.store.entries())if(i.length>0)for(let o of i)yield o}return r()}entriesArray(){return[...this.store.entries()].filter(([,e])=>L(e))}entries(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield[i,o])}return r()}tuples(){let e=this;function*r(){for(let[i,o]of e.store.entries())for(let n of D(o))n!=null&&(yield[i,n])}return r()}filterInPlace(e){let r=!1;for(let[i,o]of this.store.entries()){let n=o.length;vt(o,s=>e(i,s)),r=r||n!==o.length}return r}};function ql(t,e){let r=new on;return t.forEach(i=>p(e(i),o=>r.add(o,i))),r}function Gi(...t){for(let e of t){let r=e();if(r!=null)return r}}function cx(t,e){for(let r of t){let i=r();if(i!=null&&(e==null||e(i)))return i}}function et(t,e){try{return t()}catch(r){return e!=null?e(r):void 0}}function Vr(t){return t}function ba(t,e){if(e==null)return t;for(let[r,i]of Xe(e))i!=null&&(t[r]=i);return t}function rc(t,e){let r={};for(let i of Tt(t)){let o=e(i,t[i]);o!=null&&(r[i]=o)}return r}function px(t,e){return t==null?!1:Tt(t).every(r=>Dr(t[r],e[r]))}async function fx(t){let e=await t;return xe(e)?e():e}function nt(t){return dx(t,!0)}function gt(t){return dx(t,!1)}function dx(t,e){return new Promise(r=>{if(t<=0)r();else{let i=setTimeout(()=>r(),Math.ceil(t+.5));e&&i.unref!=null&&xe(i.unref)&&i.unref()}})}function B(t,e=1){return setTimeout(t,Math.max(1,Math.ceil(e)))}async function Ee(t,e,r=()=>{},i=()=>{}){let o=!1,n=!1,s;return await Promise.race([fx(t).then(a=>{if(!n)return s=a,o=!0,a}),nt(e).then(()=>{o||(n=!0)})]),o?await i(s):await r(),s}var ic=M(require("timers"));function wa(t,e,...r){return kt((0,ic.setTimeout)(t,Math.round(e),...r),i=>i.unref())}function Ur(t,e,...r){return kt((0,ic.setInterval)(t,Math.round(e),...r),i=>i.unref())}var os=l(()=>f(Hu("Endable"))),oc=new on;Ur(()=>hx(),1*E);var wI=5*v,Q=Se("first","service","predb","db","postdb","logger");function Id(t){return ns(Q.first,t)}function gx(t){return ns(Q.db,t)}function yx(t){return ns(Q.logger,t)}function ns(t,e){return Q.validOrElse(t,()=>{throw new Error("internal error: invalid rank "+t)}),oc.add(t,e),e}var bx=!1;function C(){return bx}function wx(...t){return Promise.all(t.map(e=>yt(e)))}async function yt(t,e){let r=await t;if(r==null||r.ended)return;let i=ne&&Po("SINGLE_SPEC_TESTS")?100:ix(e,r.endTimeoutMs,wI);return os().debug(r.name+" ending...",{timeoutMs:i}),Ee(r.end(),i,()=>os().warn(r.name+".end() timed out"),()=>os().debug(r.name+".end() completed")).catch(o=>{et(()=>os().warn(r.name+".end() rejected: "+o))})}function hx(){oc.filterInPlace((t,e)=>!e.ended),os().debug("vacuumEndables()",oc.entriesArray().map(([t,e])=>[t,e.map(r=>r.name)]))}var xx=l(async()=>{let t=$n()?250:void 0;os().info("endEndables()",{isTest:ne,isSingleSpecTests:$n}),ne||(bx=!0),hx();for(let e of Q.values){let r=w(oc.get(e),[]);L(r)&&(os().debug("endEndables(): ending "+e),await Promise.all(r.map(i=>yt(i,t))))}});var $T=M(require("os")),qa=M(require("path"));var xI=Se("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),kd=xI.values,lj=Se("s480","s240","s120","s60"),vx=[60,120,240,480];var Od=l(()=>new Intl.NumberFormat),gj=l(()=>Cl(Od().format(1111),"1","").charAt(0)),yj=l(()=>Cl(Od().format(1.1),"1","").charAt(0));function Ti(t){return Od().format(t)}var Rd=1e3,je=Rd*1e3,Eo=je*1e3,bj=Eo*1e3,_d=1024,Ki=_d*1024,Nd=Ki*1024,wj=Nd*1024,vI=["B","KB","MB","GB","TB","PB"];function ss(t,e=3){if(t===0)return"0";if(!oe(t))return"-";let r=Math.floor(Math.log10(t)),i=Math.floor(r/3),o=Math.pow(10,i*3),n=vI[i];return ve(t/o,e)+" "+n}var TI=1e6;function nc(t){return ve(t/TI,2)}var xj=Se("tiny","small","medium","large","original");function Tx(t){return t<320*240?"tiny":t<720*480?"small":t<1920*1080?"medium":"large"}function as(t,e,r=e+"s"){return Ti(t)+" "+(t===1?e:r)}var Oa=M(require("fs")),$l=M(require("fs-extra")),Qt=M(require("path")),ev=M(require("zlib"));async function b(t,e){let r=await t;return r==null?void 0:e(r)}async function le(t,e){let r=[];for(let i of D(await t))if(i!=null){let o=await i;if(o!=null){let n=await e(o);n!=null&&r.push(n)}}return r}async function Sx(t,e=console.dir.bind(console)){let r=await t;return await e(r),r}var _e=class{constructor(e){this.id=e;this._state="pending";this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i})}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve(),r=>this.reject(r)),this}observeQuietly(e){return e.then(()=>this.resolve(),()=>this.resolve()),this}get pending(){return this._state==="pending"}get settled(){return!this.pending}get resolved(){return this._state==="resolved"}get rejected(){return this._state==="rejected"}get state(){return this._state}then(e,r){return this.promise.then(e,r)}};var Ta=M(require("os"));var Px=M(require("events"));var Mx=M(require("events")),Bd=class extends Mx.EventEmitter{constructor(){super(...arguments);this.events=[]}emit(e,...r){return super.emit(e,...r),this.events.push({name:e,args:r}),!0}clear(){this.events.length=0}};var Fj=l(()=>new Bd),SI=l(()=>{let t=new Px.EventEmitter;return t.setMaxListeners(50),t}),me=SI();function Cd(){f("EventEmitter").info("emitClearCache()"),me.emit("clearCache")}function j(t){me.on("clearCache",t)}function Vd(){me.emit("idle")}function Ex(t){me.on("idle",t)}function Dx(t){me.emit("migration",t)}function Ax(){me.emit("pause")}function sc(t){me.on("pause",t)}function Fx(){me.emit("resume")}function xa(t){me.on("resume",t)}function zr(t){me.emit("fileChanged",t)}function va(t){me.on("fileCopied",t)}function Ud(t,e){me.emit("fileCopied",t,e)}function ar(t){me.on("fileChanged",t)}function Lx(t){me.on("fatal",({message:e,error:r})=>t(e,r))}function ac(t){me.on("nonFatal",({message:e,error:r})=>t(e,r))}function Ix(t){me.on("rpcServerChange",t)}function kx(){me.emit("volumesChanged")}function lc(t){me.on("volumesChanged",t)}function Ox(){me.emit("settingsChanged")}function Rx(t){me.on("settingsChanged",t)}function _x(t){me.on("vacuuming",t)}function Nx(t){me.on("writeRecentLogEntries",t)}B(()=>{j(()=>{zd.unset(),Wd.unset(),bt.unset(),Bx.unset(),nn.unset(),qd.unset(),jd.unset()})});var zd=l(()=>((0,Ta.freemem)()*2+(0,Ta.totalmem)())/3),Wd=l(()=>(0,Ta.cpus)().length),bt=l(()=>{let t=1*Eo,e=Math.max(1,Math.floor(zd()/t)),r=u.cpuLoadPercent.valueOrDefault/100*Wd();return re(1,e,Math.floor(r))}),Bx=l(()=>{let t=500*je,e=Math.floor(zd()/t),r=Math.max(1,Math.floor(1.5*Wd()*(u.cpuLoadPercent.valueOrDefault/100)));return re(1,r,e)}),nn=l(()=>re(1,24,bt())),qd=l(()=>re(1,6,Math.ceil(Bx()/nn()))),jd=nn;var Kd=M(require("timers")),zx=M(require("util"));function fe(t){if(sa(t))return"";let e=t instanceof Error?G(ma([d(t.name).trim(),K(t.code,r=>`code ${r.trim()}`),d(t.message).trim()])).join(": "):d(t);return sr(e,255)}function yr(t){return t==null?"(undefined)":[fe(t),...D(Hd(t.stack))].join(`
`)}function Hd(t){return P(t)?void 0:d(t).split(`
`).slice(0,6)}function Sa(t){if(P(t))throw new Error("undefined error");if(t instanceof Error)return t;if(Array.isArray(t)){let e=t[0];return e instanceof Error?(t.length>1&&(e.errors=t.slice(1)),e):new Error(t.map(r=>d(r)).filter(T).join(", "))}else{let e=fe(t),r=e.indexOf(":");if(r>2&&r<15){let i=new Error(e.slice(r+1).trim());return i.name=e.slice(0,r).trim(),i}else return new Error(e)}}function mc(t){return t instanceof Error}var Do=Se("pending","resolved","rejected");var ge="\xB9",Gt="\xB2",jl="\xB3",Ao="\u2074",Ma="\u2075",Si="\u2076",Pa="\u2077",MI=[ge,Gt,jl,Ao,Ma,Si,Pa];function uc(t,...e){return t+e.filter(r=>r!=null&&!t.includes(r)).join("")}var PI=/[â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g;function cc(t){return t.replace(PI,"")}function Cx(t){return t.split("").filter(e=>MI.includes(e)).join("")}function pc(t){return fe(t).includes(Ao)}var EI=[jl,"0 output files created","BatchCluster has ended, cannot enqueue","called while not idle","Can't set headers after they are sent","debugger attached","debugger listening on","diskutil: interrupted","ECONNRESET","end() called before task completed","EPIPE","for help","Format error in file","https://nodejs.org/en/docs/inspector","Invalid data found when processing input","Missing expected status message","net::ERR_","onExit(exit) called end()","This socket has been ended by the other party","Unexpected error while trimming","Warning"].map(t=>t.toLowerCase());function Kt(t){if(t==null)return!0;let e=fe(t).toLowerCase(),r=EI.some(i=>e.includes(i));return C()||!pc(t)&&!Ji(t)&&r}var DI=/SQLITE_BUSY|database is locked/i;function Hl(t){return t.code==="SQLITE_BUSY"||fe(t).match(DI)!=null}function Vx(t){return fe(t).match(/database .+ not open/i)!=null}function AI(t){return fe(t).match(/SQLITE_CONSTRAINT|constraint failed/i)!=null}function ls(t){return!Ji(t)&&!fe(t).includes(Gt)&&!AI(t)&&!bi(t.retriable)}function Ux(t){return!ls(t)}function fc(t){if(pc(t))return!1;if(O(t?.doNotSend))return!0;let e=fe(t).toLowerCase();return FI.some(r=>e.includes(r))||Kt(e)}var FI=[Si,"Corrupt JPEG data","premature end of data segment","VipsJpeg"],Gd=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+ge,"i");function Ji(t){return t==null?!1:O(t.fatal)?!0:Gd.exec(fe(t))!=null}var Jt=class{constructor(e){this.name=e;this.start=Date.now();this.state=Do.pending;this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i}),this.logger=f("Deferred("+this.toString()+")")}toString(){return It(this.name)?this.name:I(this.name)}[zx.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(r=>{this.resolve(r)}).catch(r=>{this.logger.warn("observeQuietly.reject()",r),this.resolve(void 0)}),this}observe(e){return e.then(r=>{this.maybeResolve(r)}).catch(r=>{this.maybeReject(r)}),this}setTimeout(e){return p(this.priorTimeout,Kd.clearTimeout),this.priorTimeout=wa(()=>{if(this.pending){let r="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(r)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===Do.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==Do.pending}get resolved(){return this.state===Do.resolved}get rejected(){return this.state===Do.rejected}get settledMs(){return this.end==null?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=Do.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(Kt(e)?"info":"warn",".reject()",e);let r=Sa(e);return this.settle(()=>{this._error=r,this.state=Do.rejected,this._reject(r)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(r=>e(r))}settle(e){if(this.state===Do.pending){p(this.priorTimeout,Kd.clearTimeout),e(),this.end=Date.now();let r=this.settledMs;if(this.resolved&&r>5e3){let i=r>5e3?"info":"debug";this.logger.log(i,"Completed in "+r+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}};var tt=class{constructor(){this._pushCount=0;this.lastPushTs=0;this._arr=[];this.nextSettledLatches=[];this.serialLatencyAvg=new ht;this.applyListeners=[]}get arr(){return vt(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}onApply(e){this.applyListeners.push(e)}_emitApply(e){for(let r of this.applyListeners)r(e)}push(e,r){return this._emitApply(e),this._push(e,r)}_push(e,r){this._pushCount++,this.lastPushTs=Date.now();let i=xe(r)?r():r;return this.arr.push(new Jt(e).observeQuietly(i).finally(()=>this.emitSettled())),i}emitSettled(){for(let e of this.nextSettledLatches)e.resolve();this.nextSettledLatches.length=0}awaitNextSettled(){let e=new _e;return this.nextSettledLatches.push(e),e}serial(e,r){let i=Date.now();return this._push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}serialByName(e,r){let i=Date.now();return this._push(e,this.awaitAllByName(e).then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}oneRunAtATime(e,r){return this.pending?this.awaitAll():this.serial(e,r)}maybeRun(e,r){return this.maybeRunConcurrent(e,r,1)}maybeRunConcurrent(e,r,i=bt()){return this.pendingCount>=i?void 0:this.push(e,r)}get pendingCount(){return Er(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return this.arr.length===0}async awaitAll(){for(let e of[...this.arr])await e.promise}async awaitAllByName(e){for(let r of[...this.arr])r.name===e&&await r.promise}async pushAll({name:e,laters:r,maxConcurrent:i=bt()}){i=re(1,bt()*2,i);let o=[];for(let n of r){for(;this.pendingCount>=i;)await this.awaitNextSettled();o.push(this.push(e,n))}return Promise.all(o)}};async function Ar({name:t,laters:e,maxConcurrent:r}){return new tt().pushAll({name:t,laters:e,maxConcurrent:r})}async function Wx(t,e,r){let i=[];for(let o of Zo(D(await t),e)){let n=[];for(let s of o)if(s!=null){let a=await s;a!=null&&n.push(a)}for(let s of D(await r(n)))s!=null&&i.push(s)}return i}function qx(t,e){return Promise.race([t.then(()=>!0),nt(e).then(()=>!1)]).catch(()=>!1)}async function dc(t){try{return await t,!0}catch(e){return!1}}async function jx(t){return!await dc(t)}async function Hx(t){return await t!=null}async function hc(t){let e=A(t);L(e)&&await Promise.all(e)}async function Gl(t){let e=[];for(let r of D(await t)){let i=await r;if(i!=null)if(Array.isArray(i))for(let o of i){let n=await o;n!=null&&e.push(n)}else e.push(i)}return e}async function ms(t){let e=A(await t);return N(e)?[]:A(await Promise.all(e))}async function Ea(t,e,r){if(t==null)return[];let i=A(await t);return N(i)?[]:(await Ar({name:"thenCollectParallel",laters:i.map((n,s)=>async()=>[await e(n,s),n]),maxConcurrent:r})).filter(([n,s])=>n!=null&&s!=null)}async function Da(t,e,r){return(await Ea(t,e,r)).map(i=>i[0])}async function Qi(t,e,r){return(await Ea(A(t),e,r)).filter(([o])=>o).map(([,o])=>o)}var F3=30*v;async function Et(t,e=!0){if(t==null)return e;let r=await t;return r==null?e:!O(r)}async function he(t,e,r){let i=await t;if(i==null)return r();let o=await e(i);return o??r()}async function Aa(t,e,r,i){let o=await t;if(o==null)return i();let n=await e;if(n==null)return i();let s=await r(o,n);return s??i()}async function ye(t,e){return w(await t,e)}async function Gx(t,e){for(let r of t)try{let i=await r();if(i!=null)return i}catch(i){e(i)}}async function Kl(t,e){return ie(await Ea(t,e),r=>r[0]).map(r=>r[1])}var Kx=M(require("fs")),Jl=M(require("os")),Fo=M(require("process"));var Ql=(0,Jl.platform)(),B3=Fo.default.argv.includes("--inspect")||O(Fo.default.env.NODE_INSPECT),Lo=!d(__filename).includes("Platform"),R=Ql==="win32"||Ql==="cygwin",Jx=R&&T(Fo.default.env.PORTABLE_EXECUTABLE_DIR),de=Ql==="darwin",ut=Ql==="linux",C3=ut&&(0,Jl.arch)()==="x64",Jd=(0,Jl.arch)()==="arm",LI=ut&&Jd,V3=ut&&(T(Fo.default.env.APPIMAGE)||T(Fo.default.env.APPDIR)),U3=ut&&T(Fo.default.env.SNAP_USER_DATA),Fa=de||ut,II="PS_IS_ELECTRON",kI="PS_IS_DOCKER",si=Fo.default.versions.electron!=null||O(Fo.default.env[II]);function Ne(){return ut&&(Po(kI)||Po("PS_DOCKER"))}var z3=l(()=>LI&&d(OI()).startsWith("Raspberry Pi")),OI=l(()=>{try{return ut?p((0,Kx.readFileSync)("/proc/device-tree/model"),d):void 0}catch{return}}),Qx=R?"win":de?"mac":ut?"linux":Ql;var Rt=15*v,us=5*E,H=35*v,Fr=7*v,$x=1*ft,gc=v/(2*Ki);var La=25*v;var Ia=M(require("stream")),Yx=M(require("util"));async function $i(t){t!=null&&(et(()=>Ju(t,"unref")),C()?t.end(null):await new Promise(e=>t.end(null,e)),await nt(50),et(()=>Ju(t,"destroy")))}async function Xx(t){t!=null&&(et(()=>Ju(t,"unref")),C()?t.close(ld):await new Promise(e=>t.close(e)))}function Zx(t){for(let e of[t?.stdin,t?.stdout,t?.stderr])try{e?.destroy()}catch{}}var cs=(0,Yx.promisify)(Ia.pipeline);function ka(t){return t.destroyed?"destroyed":`${t.remoteFamily}:${t.remoteAddress}:${t.remotePort}`}var Qd=class extends Ia.Transform{constructor(e){super({transform:(r,i,o)=>{this.onProgress(this.bytes+=r.length),o(r)}});this.onProgress=e;this.bytes=0}};var Yl=Qt.default.posix;function RI(t,e){if(P(t)||Qt.default.sep===Yl.sep)return t;let r=T(e)?Qt.default.sep+Qt.default.sep+e+Qt.default.sep:"",i=t.split(Yl.sep);return ot(i[0],e)&&i.unshift(),r+i.join(Qt.default.sep)}function ai(t){return P(t)||Qt.default.sep===Yl.sep||Yl.sep===Qt.default.sep?t:t.split(Qt.default.sep).join(Yl.sep)}var tv=/^([A-Z]:)[\\/]?(.*)$/i;function _I(t){let e=tv.exec(t);return e!=null?e[1].toUpperCase()+"\\"+e[2]:t}function rv(t){return w(t.nativePath,()=>Wr(t.toString()))}function Wr(...t){let e=Qt.default.join(...t);return Qt.default.resolve(R?_I(e):e)}function iv(t){return Mi(RI(t))}function ov(t){return Mi(t).ext}var NI=/(\.(?:gz|z|7z|xz|bz2))$/i;function Mi(t){let e=xd(t,NI),r=Qt.default.parse(w(e?.uncaptured,t));return g(g({},r),e==null?{}:{ext:r.ext+e.captured,base:r.base+e.captured})}function sn(t,e){return T(t)&&T(e)&&(t===e||t.startsWith(Vt(e,Qt.default.sep)))}function an(t){return He(t,Qt.default.sep).split(Qt.default.sep)}function yc(t,e){return t.nativePath===e.nativePath?"":He(ai(e.nativePath),Vt(ai(t.nativePath),"/"))}var nv=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function qr(t){return Z(d(t).match(nv),e=>e[1],()=>t).toLowerCase().normalize()}function sv(t){return p(d(t).match(nv),e=>Ze([e[2],e[3]],V))}function Ra(t){if(P(t))return!1;try{return Oa.default.statSync(t).isDirectory()}catch{return!1}}async function Xl(t){if(!P(t))try{return await Ee($l.default.stat(t),Rt)}catch{return}}async function av(t){return he(Xl(t),e=>e.isDirectory(),()=>!1)}async function lv(t){if(P(t))return!1;try{return await Xl(t)!=null}catch{return!1}}async function ln(t,e=La){if(P(t))return!1;try{let r=await Ee(Xl(t),e);return r==null||!r.isDirectory()?!1:await qx($l.default.access(t,Oa.default.constants.R_OK|(R?0:Oa.default.constants.X_OK)),e)}catch{return!1}}function $d(t){return t.startsWith("\\\\")}function mv(t){return Fa&&t.startsWith("/")||R&&($d(t)||t.match(tv)!=null)}var BI=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});function uv(t){return t==null||t.isFile()&&t.size===0}async function bc(t){let e=g(g({},BI),t),r=Mi(e.nativePath);await $l.default.mkdirp(r.dir);{let i=await Xl(e.nativePath);if(!e.requireNumber&&(i==null||e.emptyIsNew&&uv(i)))return e.nativePath}for(let i=e.startIndex;i<=e.maxVersions;i++){let o=Qt.default.join(r.dir,`${r.name}-${vi(i,e.leftPad,"0")}${r.ext}`),n=await Xl(o);if(n==null||e.emptyIsNew&&uv(n))return o}throw new Error("There are already more than "+e.maxVersions+" of "+e.nativePath)}async function cv(t){if(t.endsWith(".gz"))return t;let e=t+".gz";return await cs([Oa.default.createReadStream(t),(0,ev.createGzip)(),Oa.default.createWriteStream(e)]),await $l.default.unlink(t),e}var pv=M(require("os")),fv=M(require("path"));var Pi=l(()=>{let t=[];R?t.push(ze("USERPROFILE")):t.push(ze("HOME"));for(let e of z(t)){let r=(0,fv.resolve)(e);if(Ra(r))return r}return(0,pv.homedir)()});function Yd(){if(Ne()&&Ra("/ps/cache"))return"/ps/cache";if(R){for(let t of z([ze("TEMP"),ze("LOCALAPPDATA")]))if(Ra(t))return Wr(t,wi())}if(de){let t=Wr(Pi(),"Library","Caches");if(Ra(t))return Wr(t,wi())}return Wr(Pi(),".cache",wi().toLowerCase())}var Xd=M(require("path"));var dv=M(require("fs")),hv=M(require("fs-extra")),wc=M(require("path")),gv=M(require("process"));var _a=l(()=>{let t=[gv.env.PS_CONFIG_DIR,Ne()?"/ps/config":void 0];R&&(t.push(ze("APPDATA")),t.push((0,wc.resolve)(Pi(),"AppData","Roaming"))),de&&t.push((0,wc.resolve)(Pi(),"Library","Application Support")),!de&&Fa&&t.push(ze("XDG_DATA_HOME"),ze("XDG_CONFIG_HOME"),(0,wc.resolve)(Pi(),".config"));let e=z(t);for(let r of e)try{if((0,dv.statSync)(r).isDirectory())return r}catch{}for(let r of e)try{return(0,hv.mkdirpSync)(r),r}catch{console.error("Failed to mkdirp "+r)}throw new Error("Cannot determine appData"+ge)});function yv(){return Ne()?"/ps/logs":de?(0,Xd.resolve)(Pi(),"Library","Logs",Yn.toLowerCase()):CI()}function CI(){return(0,Xd.resolve)(_a(),Yn.toLowerCase(),"logs")}var wt="1.0.0-alpha.1",bv="1.0.0-alpha.1+20210314162034";var Zd=new Date(1615764034e3);var VI=()=>wt.includes("-alpha"),UI=()=>wt.includes("-beta"),wv=()=>VI()?"alpha":UI()?"beta":"latest";var qT=M(require("path"));var Hc=M(require("batch-cluster"));async function xc(t,{timeoutMs:e,timeBetweenMs:r,acceptable:i,timeoutResult:o,unref:n}){let s=e==null?void 0:e+Date.now();for(;s==null||Date.now()<s;){let a=Date.now(),m=await t();if(m==null||(xe(i)?!i(m):m===!1)){let c=Date.now()-a,h=w(r,()=>re(100,5e3,c*Ct(4,10)));await(bi(n)?gt(h):nt(h))}else return m}return o}async function Be(t,e){return xc(t,g(g({},e),{acceptable:r=>O(r),timeoutResult:!1}))}var NT=M(require("process"));var we=class{constructor(e,r,i,o,n){this.name=e;this._isEnded=o;this.endTimeoutMs=n;this.onEnds=[];this._ended=!1;this.logger=f(e),this.onEnds.push(r),ns(i,this)}get ended(){return Z(this._isEnded,e=>e(),()=>!1)||this._ended}end(){if(!this._ended)return this._ended=!0,hc(this.onEnds.map(e=>e()))}};var Eh=M(require("child_process")),Dh=M(require("process"));async function Na(t,e){let r;return Promise.race([t().then(i=>{if(r==null)return r=!0,i}),nt(e).then(()=>{if(r==null)throw r=!1,new Error("timeout")})])}function lr(t,e){let r=k(e.timeoutMs)?()=>Na(t,e.timeoutMs):t;if(e.maxRetries<=0)return r();let i=W(e.onRetryWaitUntil).getOrElse(()=>s=>nt((e.retryDelay??250)*w(s,1))),o=0,n=async()=>{try{return await r()}catch(s){if(await e.errorIsRetriable?.(s)===!1||o>e.maxRetries)throw s;return o++,await i(o),n()}};return n()}var xv=M(require("util"));var ps=class{constructor(e,r){this.ttlMs=e;this.maxLength=r;this.times=[];this.a=[]}[Symbol.iterator](){this.vacuum();let e=[...this.a];function*r(){for(let i of e)yield i}return r()}push(...e){Te(e.length,()=>this.times.push(Date.now())),this.a.push(...e),this.maxLength!=null&&this.vacuum()}pushUniq(...e){e.forEach(r=>{this.includes(r)||this.push(r)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(this.a.length===0)return;if(this.maxLength!=null){let i=this.a.length-this.maxLength;this.times.splice(0,i),this.a.splice(0,i)}let e=Date.now()-this.ttlMs,r=this.times.findIndex(i=>i>e);r===-1?this.clear():r>0&&(this.times.splice(0,r),this.a.splice(0,r))}};var li=class{constructor(e){this.ttlMs=e;this._eventCount=0;this._lastEventTime=0;if(e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new ps(e)}[xv.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){let e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return se(this.eventDeltas.length,()=>Wl(this.eventDeltas))}get msPerEvent(){return Ot(this.eventDeltas)}get eventsPerMs(){return ga(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return ga(this.eventsPerMs,e=>ve(v*e,3))}get eventsPerMinute(){return ga(this.eventsPerMs,e=>ve(E*e,3))}};function vv(t){let e=gr(d(t).trim().toUpperCase(),":");return Z(zI[e],r=>r.description,()=>t)}var zI=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}});var WI=Date.now(),Tc=l(()=>f("Error")),Tv=new li(E),eh=new li(E);function Sv(t,e){return e.exec(fe(t))!=null}function qI(){let t=Date.now()>WI+u.probationMs.valueOrDefault,e=qn(eh.eventsPerMinute,u.fatalErrorRatePerMinute.valueOrDefault);return Tc().tap({level:"info",msg:"isFatalErrorAllowed()",result:Lr()&&t&&e,meta:{mainService:Lr(),postProbation:t,lowErrorRate:e,fatalErrorRatePerMin:eh.eventsPerMinute,errorRatePerMin:Tv.eventsPerMinute,fatalErrorRatePerMinuteSetting:u.fatalErrorRatePerMinute.valueOrDefault}})}function Sc(){let t={};return Error.captureStackTrace(t,Sc),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)}var jI=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function HI(t){let e=cc(ji(t)),r=e;do r=e,e=jI.reduce((i,o)=>i.replace(o,""),e).trim();while(r!==e);return z(e.split(/\s+/).map(i=>{if(i.startsWith("E")){let o=vv(i);return e.toLowerCase().includes(o.toLowerCase())?"":o+":"}return i})).join(" ")}function fs(t,e=256){let r=fe(t),i=Cx(r);return sr(HI(r),e-i.length)+i}function Mv(t,e){return d(t).split(/\r?\n/).map(r=>He(r,e)).map(r=>r.replace(/: ?/,"")).filter(T).join(", ")}function J(t,e,r){if(P(t)&&e==null){Tc().warn("onError() with empty args",Sc());return}let i=fe(t)+fe(e)+fe(r),o=Ji(e)||Ji(i)||O(r?.fatal);if(!o&&Kt(i)){Tc().info("onError(): (ignorable): "+yr(e),g({message:t},r));return}p(vc(),s=>s.writeRecentLogEntries()),Tv.onEvent(),o&&eh.onEvent();let n=!o||qI()?"nonFatal":"fatal";Tc().log(n==="fatal"?"error":"warn","onError(): "+yr(e),g({event:n,message:t},w(r,{}))),C()||me.emit(n,{message:t,error:e})}function Pv(t,e){return t==null?new Error(e):(T(e)&&(t.message.toLowerCase().includes(e.toLowerCase())||(t.message+=": "+e)),t)}var wT=M(require("child_process")),lm=M(require("process"));var Ev=M(require("util"));function Ba(t){return t==null?[]:Object.keys(t)}var Ce=class{constructor(e,r){this.maxSize=e;this.clearEveryMs=r;this.setsSinceLastSpill=0;this.expireListeners=[];if(e<1)throw new Error("maxSize must be positive");if(e>3e4)throw new Error("maxSize is too big");this.clear(),k(r)&&(this.clearInterval=Ur(()=>{this.spill()},Ye(r/2)))}spill(){if(this.priorCache!=null&&this.currentCache!=null&&L(this.expireListeners)){for(let e in this.priorCache)if(this.currentCache[e]==null){let r=this.priorCache[e];if(r!=null)for(let i of this.expireListeners)i(e,r)}}this.priorCache=this.currentCache??Object.create(null),this.currentCache=Object.create(null),this.setsSinceLastSpill=0}[Ev.inspect.custom](){return g(g({},this.priorCache),this.currentCache)}end(){this.clearInterval!=null&&clearInterval(this.clearInterval)}clear(){return this.visit((e,r)=>{for(let i of this.expireListeners)i(e,r)}),this.currentCache=Object.create(null),this.priorCache=Object.create(null),this.setsSinceLastSpill=0,this}get size(){if(this.currentCache==null||this.priorCache==null)return 0;let e=0;for(let r of tc(Ba(this.priorCache),Ba(this.currentCache)))this.has(r)&&e++;return e}has(e){return this.currentCache[e]!=null||this.priorCache[e]!=null}keys(){return G([...Ba(this.priorCache),...Ba(this.currentCache)]).filter(e=>this.currentCache[e]!=null)}delete(e){let r=this.currentCache[e];if(r!=null){this.currentCache[e]=void 0;for(let o of this.expireListeners)o(e,r)}let i=this.priorCache[e];if(i!=null&&(this.priorCache[e]=void 0,r==null))for(let o of this.expireListeners)o(e,i)}visit(e){for(let r of tc(Ba(this.priorCache),Ba(this.currentCache))){let i=this.currentCache[r]??this.priorCache[r];i!=null&&e(r,i)}}deleteIf(e){for(let r of this.keys()){let i=w(this.currentCache[r],this.priorCache[r]);i!=null&&e(r,i)&&this.delete(r)}}get(e){return e=d(e),this.currentCache[e]??this.priorCache[e]}set(e,r){e=d(e),this.currentCache[e]==null&&(this.setsSinceLastSpill>=this.maxSize&&this.spill(),this.setsSinceLastSpill++),this.currentCache[e]=r}getOrSet(e,r){e=d(e);let i=this.get(e);if(i!=null)return i;let o=r();return this.set(e,o),o}on(e,r){this.expireListeners.push(r)}},Yi=class{constructor(e){this.opts=e;this.uid=0;this.cacheSyncHits=0;this.cacheAsyncHits=0;this.cacheMisses=0;this.timeouts=0;this.cache=new Ce(e.maxSize,e.clearEveryMs)}get size(){return this.cache.size}stats(){return{size:this.size,cacheSyncHits:this.cacheSyncHits,cacheAsyncHits:this.cacheAsyncHits,cacheMisses:this.cacheMisses,timeouts:this.timeouts}}get(e){let r=this.cache.get(e);return r==null||r.__uid!=null?void 0:r}clear(){this.cache.clear(),this.cacheSyncHits=0,this.cacheAsyncHits=0,this.cacheMisses=0,this.timeouts=0}deleteIf(e){for(let r of this.cache.keys())e(r)&&this.cache.delete(r)}async getOrSetAsync(e,r,i=1){e=d(e);{let a=this.get(e);if(a!=null)return this.cacheSyncHits++,a}let o=this.uid++,n=Date.now(),s=this.cache.getOrSet(e,()=>({__uid:o,__start:n}));if(s.__uid===o)return this.cacheMisses++,Ee(r,this.opts.timeoutMs,()=>{this.timeouts++,this.cache.get(e)?.__uid===o&&this.cache.delete(e)},a=>{this.cache.set(e,a)});{let a=s.__start;if(a!=null){let c=a+this.opts.timeoutMs-Date.now();if(c>0){let h=xc(()=>this.get(e),{timeoutMs:c});if(h!=null)return this.cacheAsyncHits++,h}}return i>0?this.getOrSetAsync(e,r,i-1):void 0}}};var Ir=M(require("fs")),rt=M(require("fs-extra")),dn=M(require("path")),rT=M(require("util")),xs=M(require("zlib"));async function Zl(t,e){return t==null||e==null?Z(t,A,()=>[]):Qi(t,e)}async function Dv(t,e){return t==null||e==null||await e(t)?t:void 0}var th=class{constructor(e,r){this.l=e;this.listener=r;this.ts=Date.now()}elapsed(e){let r=Date.now(),i=r-this.ts;this.ts=r,p(this.listener,o=>o(e,i)),i>2&&this.l.log(i>500?"warn":i>100?"info":"debug",e,{elapsedMs:i})}};async function mi(t){let e=Date.now(),r=await t();return{elapsedMs:Date.now()-e,result:r}}async function Ca(t){let e=Date.now(),r=await t;return{elapsedMs:Date.now()-e,result:r}}var GI=15,Va=class{constructor(){this.errors=new rs;this.times=new Map}async time(e,r,i){let o=Date.now();try{let n=await r(),s=Date.now()-o;return i!=null&&i(n,s),this.push(e,s),s>2*v&&f("time("+e+")").warn("slow",{elapsed:s}),n}catch(n){throw this.errors.incr(e),i!=null&&i(n,Date.now()-o),n}}get entriesBySumDesc(){return ie([...this.times.entries()],([,e])=>-e.sum)}stats(e){let r=this.entriesBySumDesc.filter(([n])=>n.startsWith(e)),i=r.reduce((n,s)=>ht.merge(s[1],n),new ht),o=r.map(([n,s])=>[n,s.stats()]);return mt([["merged",i.stats()],...o])}mkElapsed(e){return new th(e,(r,i)=>this.push(r,i))}push(e,r){r>GI&&Pr(this.times,e,()=>new ht).push(r)}weightedAvg(e){return W(this.times.get(e)).map(r=>r.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[r,i])=>g(g({},e),{[r]:i.n}),{})}weightedAvgs(){return xi([...this.times.entries()].reduce((e,[r,i])=>g(g({},e),{[r]:Nl(i.weightedSampleAvg,Ye)}),{}))}report(){return this.entriesBySumDesc.reduce((e,[r,i])=>g(g({},e),{[r]:g({sumSec:ve(i.sum/v,3)},jt(i.stats(),"sum"))}),{})}},Av=l(()=>kt(new Va,t=>new we("PromiseTimer",()=>{let e=f("PromiseTimer");e.info(`timings:
`,t.report()),Me(t.errorCounts(),r=>e.warn(`error counts:
`,r))},Q.service)));function Fv(t){return Av().mkElapsed(f(t))}function Ge(t,e,r){return Av().time(t,e,r)}function Lv(t,e,r){return l(async()=>Ge(t,e),r)}var Bv=M(require("crypto"));var rh=M(require("zlib"));var Iv="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function kv(t){if(typeof t=="number"&&t<Iv.length)return Iv[t];let e=t.toString(16);return e.length%2==1&&(e="0"+e),Buffer.from(e,"hex").toString("base64")}function Mc(t){return(0,rh.gunzipSync)(Buffer.from(t,"base64")).toString("utf8")}var Ov=l(()=>Mc("H4sIAAAAAAAAA1WcgZarLM+Fb8ibQkWlInhA2rFX/+8nOPN+/1qnAa1jEUKydxLP0oZPGtxcB3ecg0t5cMXpo+OqflV7bYNrP4P7fofRxWEcP8M4bcPodRynYcx5GNuhT9HnHsZ7HyZXh2lSG69hOtTP6udDn6TPzzC1qI+O72mYdd3s4zCHn2E+dHxNg/dl8CUP/h2Hxa36JH3+Dct8DovfhyUs+qjd9dG9l+scVncNa9Anz/rEYb3PYdPxpv7WXsPLncMrrPp8h1dpw66/3RufQ5+izzXsHzdEjT3q2eJ5DVHjPJY8HKEOR16GpL9P4RxSHvWZhnQdQy7HcLqmzz2cGtOpa0+N6dTznpqbM5/6XMP5rwxnScPZZn2CPvfw71/Qpw3FjfrUoeT3UDTn5e2GOu9D9T9D3YI+11B176rfrf/iUO9luMZjuPR81+camubwPR/DR/f55FWfc/hoHT/VD59rGX5+foY7zMOd2/B1kz778PXr4FyaBxdKGNzLaYmPaUXsEru0IGm5dQU9TZpLTdqQvjo8T/XKgbLoF1wdda6iO5ce2jU05sPf3nxxFy/FKYvEVyoyV+mKv5zEZxzGgCqFVYfh0nXhR708SqXyhEjrMF5c0qK+bRy2S0rlJiexIgqHHynYJg2QeEtIB6atrQidC6eui5qrKXGY0cwcdS6bPp63hLR9KlKRqXHnlhLiGma3ZokjSUfp+SoNDahs2L1EUu8lTZgj5/JUJTxCI53zqUuK9E/iHOZ2jBIay/zWnM63buBnjcr/SCzOo+MFZa8b4ishPVgmKeniJ4SfpfYa38IIFmZtCZqXJejXlqCHWYIecIlSuyWlW3tDPyShS7JUcvVTkJByr/5wEkmH4dTesW+zNGbNWgWJNqwl12FtI0JbcXOvIKHRb67MEh8deqeeH72EHyViRLDv9JNbdkVCa7llT0/zsuWDLw7OFXpSPYldomqrXtrHW+OLj3ZT2D9+CIcWJSRtwhcDfwWpj7awellDe+WQhlfVk7/eWtDdjQhpzu7iKCG12FmoPWXtcBZ+z1rVnYXfWe6dRd5bDcPOekSv4UZ0MvJnMRy3xFu9rEeN3CAypxJNYqEn/YuZS5o2U2x6jsNJ+Q8XEJpnCZkPl7xE1aFviyyKbiWBbXkhos5lbcsj77dE1LmcHGKV0JQcuZrQrdqiixvfMvqjXXVITgNPPHlyxyHxDUPyMpXJaycn/9El/uca0iqlSVljSXX5DKlpoVLTuuWo+cuHliwXXSJxS1x50MLIWPFEp1u9xMtJ7JzTIE+vG0jQi/SSCX3rpSqnL+/h3KTAEv9kGqW7Jw99Bu7Ck59BfucMiUP+NpwmdIMgIy1jKmsaLq7Ttj/ZYGf2WFTN/Zk3bKzm+WRBz1wmBD2twlmCDotMgYTOXZsOm5T1bDtCz3s2bt+qLHe7OLz4Qr/27588zr8WDplljVSa4ofi/SVR6GlfliyjXt7atZVpr04qUCeZoOo1fxKrhGxi3eTAKrapYpskvth0hIxCxepVFL1G3b5G7d96yDTXQ3uhHhwmWZCKblR0rWY5qXrKildNJWJF6It/fpNo+rbwbeEnL0TTqlbsmoR+qGm1apNa1Dvpuq++veQJJKRXl1urhLTuYp9f3snNeL8gvhJ6tsufTUJTfPk2DtemObhYwSuPiBMhj3qVkCWaH65LT3k17vfRgNqY76FFPVY7NNLGZLcqG9HadA5vr4vfq4zRO4xFwpv4DO8sF/bGQL0vjfTDICX24eMv+T3m9MOcfsJL3wap6OfUrv2wyD9yZsMP8/yTtdI3f3a7HOQGx3v4Bm2Xbwzj8D00yG/W7375oS+T6MaxTZKYXyRnckM2vN+M7XPzEcBRbdGZ1Um33OZBUhEL4KLXyrl4buofURMuj3qZX8VXpq8eUaY/6G+LedTrcsHkLf/puP7Wk8qDrltEyjSPLlRzrHK5oy5akQW3OnOllod+0++OYcF5hgO3GsybBhZkjFlrPWbmUVIPLqe76XxeuYMsgnlgjU3yy3m7ZzZXXLxmRtL6bB7N0YZcZdKRDXc9c6ZeQoXtm3DWk/ltrkR6yaUgV/t2xR+7TVo0+Vq79CaDyYx/l2GXxOtvwXuTBZmAAJhpycy3LLQAgAzUFKwf2PPIYFJ3i15zO0VM65RX7pM37pkxOcIIhg9yBCAURijJeczulO8Msv0KEE0FyyYpTZsqRkowQkZhat5k0ead2tcBJdCK2RVZ+dm7KKjgRxkwScGVOUTtzTkUPfucWa85Z6GBubhFWKRgA+fy1dadG7MnNCET720+tR7yrX7STAxezisKQRd5PS+ToPOy4pIXltDLaAE4ouYBmZGaAaEPrdTiLgf+uDTbgh2y+4uP0pnFVmSxFVlsRRZbEWGRDQiymswLZ+waDdaZVF+2Tecj9nWRXiGTvNai+QxIYfAl25X5+iKbfMFSnOzTUjKoRfs3IeV3V4dLWgUxhfR9kUVfQ/rmYY3A2TVJQQVhGMNq91wzJm6VruqaErR/hW1kSiRl1iXbCdCR1q0N/y8p27be+QT2zIZ7Xl1+BXBc1viFf4TXNy2dAJGvevYtvKTtklrfLSetr4BNQlZDP29pzmb6sMkg6fwnaNW2+9C6hFkKKpQzC+9Lao1CejXJyty+3Et/Jbkjd5nNl4wK8pImvPwoG4q8kMLoL/+RpXptTqv8EvgrkptG8sqs4Cu3oDNt1d5/tWtvQCf5EMEm8JCbZM0lAU1u0ZW7gIvO+CTLv/sit7uHQ5q2B55xj1lOfM97BkahUbvtekEqrf5uc7jf5YRXjcEkHEvbLknydFEuJUoWaX701fDXoTEjAV+HXFs0qxWPRTtIIIzr82Lga1nAZlr/Ido8x9wceKxJk2MbtRaxMQOxYdOkgLvhMd1ZUvMsKbsn2LNx/nqB0a7Et5d296HlQs4B2IY10MhmZ1JXrlgMSe0yWX/Nj6QY1iGYCIZLF/ito7jTwBu7T7LRx4oeZj00Ao1ZkrFVLJUQnjT8aKwX0pvsZzKAj9G26+pyE9xz+wX8Mxk0wuT+aZYkZT2SZ5ySxZn0JoPJDECUrU72LEl7WXfIYMtke1CESTuIaRYwfOGZ5RD0i+IK9AtzKxCv6wWBgXNuBhXK4SUkkNDszOkSEM8lsJYU085c9MvK9XXnW+EOwCQs2m87mDJ0ZHmAJSMs2uMfT9Ew5KVfl2yb5BeMJ5sPVESHJTdDm8HOVOs30GSMAEvWS9KuP8GqkkDPAi4MP7KfZ/hqJk9ZlYq8dWVs0nyhUO5svhIJx9fOk4xv+kXzfBag4Fk8AFPzQx/ierY0wf35xX/hlqX9F6FSstFuQcqPSHrrS0/+NfRBhnAOAy5XfRl35CmvpNuDSYOdl0JVycS37002sLzrvg7lRouqA5NUN4eKFGaojuurw8tU3Z8zBXhoq6B9qKdA6tsJtoj0JoNJzh+AUp3W9f7UTtdoZEsFcaVj1fxvDdg6ra68c93BTnUH+SCBu4aaIxRcJE66XeW66RfQarbx5Aq8zlcRiNX07YBaERHJHQk3EsKIAFtseG1oI5IzUZahyksCcYViJHu/6IkusbHV5I7U6gst27cGVyWD5A/A1rPiQsDyWYLAWnddZ0jY7iPJed0DeTmTXCMnLYnfF0jW7F2mLZcY5C0ZhfGujB5ewhgVWQ0/C9brsWbAMyGOq8AYhaa1o+XAgzPpkdH6kSvzj/qtguNb3W5kFUz/gIuuD4il7YQhZJ6lXbpQI38bHns77NvbLbrbW5S+yyzJM76DnQl2RrweeV0NKQ/1ztjnd4tiREgvRI4V/WxEMT4BuvnRjruHT4Hq3H4VQbk91u8OyyLsLdvlgOHEpAJWAinorf2ob203idazUTVa9pPT7r8KzTodajQaAfNDAwRFCx3fwGhCFWr0oL0hOqWOwPWbjhC1AD4weiSWpIYQkPq7NHgE1AO3E/ZNjYFgV7+yTKP7ws9G7+wkjeCtl4UEde+7NVK70Bvd0xu+FyJvMnWjEIXmyhpPk1ZdKZAgMCMH2dH5YoA95jzfYHKLluUlGB7f2AJjtj2vBhUQVIfTjUKMAeBeO4pXA7wX0+MPGs8uh5i4i6w3gF6GiWcXTyPYJvjaG6D6WMzKWcOVOdmROZ1RHknEXojfRtbMd4D5efa2i1GC+nF81vje6DHv/nx3rAG4r2Fkawz2282sgRAIgAiNuzg3Loky6WIAmfDCtAYeU6PTZNOklcYbtdgCqIfmDVkQgTSGYFSDJhhfaEYYFmfNYY3tTJjDyZX5NE5hLlAUwvjK1vpdWr9LA/6oOflzbU0ZVrkaPJ6aekIuAjhbjZ3ML3wZbCJwVIyRqPla4HHa4Q8epzoVw65TafZE5WESnTQJ3fjOLhjEbT87uw3ANLuDvQi3kEbS6Idm1FwEIsyzBjHnFagk8+96c1isMusf0UomeS5ifzpZKlBpvv2ivTt/w0dHPkkvxSg04QJN2oXEI7Rc1Y1qtg+coyWMnv85+W5h0IXYpjaumiPoZqITl/GJAzck4oCGSLkxvSIQxgJC7Ucywat4gy2xBjKH3txQhDn04CbTCqnIH5iEID9N4WeFAkunEdp4S9d50U24pjUcaY1mOEY1kjHiE4VHMUarAKKMx7p1uiFgIDUVxxB+FskIWTZ5zVLoH2uMbewCv5AOZmnN5oLUGBMpzo5EQjZjIQxp7ctoTYN2YBXXJiNL0PVgUdePY9uvH0+zObftRGBv0Ow2em/0IxEt2CAOxFVn4ghiIKvRjoQy0NjJvNvJgs0SGXnriTZhTZ0MMjefNog43nLt2hSrBhEOW0ZZCRhRSFpBkRUNXZgqpOrtu9q/e2PeA+jhVFPFoURQbB1e7k3IA4oCC/Efwj+QlGoMpIqC7ERUIowDoEkTelOgIVEOvze7moOJFKBwRlGSfoTmgoDwe1xyVaMyHxjiLgPhv6IrZqXEVy7ojFhLgreITx5Egomh7m3BJEBXOlNxH5EIwEAxZgLJEIOmCdN+GPEgDhS1pS/ISGcgLByR37HpFw43BSC+C+AvsTYCgYfmgVCvmkxj0QM12ULEBVOpphEXdrYRDnDJqKbpn5obO6FmNEZyjFziE6iLBlpA8xyF3uhm/kr8rBwmVwZNuf48dEYTXu63IRz9JUxx7K5xMo/ByMqELtEEO5K5UjOHhZOCeJEm+gNyY0ynzEkO89A9CHa3qO0BhUHn4TCM+tvS2uAv2odqRIp3GAwEIQmaRphMAW4k33CtuuGhOUtB8Fh8JXbaEo2DpSzuv6rJjJNG40wQsESg265scxC+TC3KMqmpOKJ0HyIOEBtjNimiYMJfJCJkoAU6Bxlrwa/e6MrLj7K7+RI2hcjMzTjPvpP6c4l4FIwmd0oDs/HmzkRtnAXJvf4ZuXGcTPnL0entSlEq0YTgF4LUQQAfKvM6rTlwKGcwBRN3MQIS5IAsWp4tuP7tf/6dCbpnP/J3wggTR1JbIt1jJDAujqfdWLSjiwW4ySEVP13aD8XLWXA0Ey8uYiMavAwmwLp46DMNOQ/REAxEkeuWH1PTxOsFV2eZ7dJ3XAnHy32syeNQqnAhZEWOYVJjeAnSItUQSBMtGMpX1m0yrmJx9QXFtIajKJWkwc6rwV1XnoGmsVfgLA91Me6y+QBt2cLroom+0Yj10uSFkyWc1mTXG0LyNKE38BpRo03NhE5Uby7LGl3io2YN0rMRmJdt9nZ0G/uRo0jWwIvgnAXSA/OF9TBcGh0lg0Y1T8ISNCxxlWM+OhuykwVoVLW5oEWncY9aN4KFVZooVazE94j6tzNollp5c+uPwzfWW6bkINz/gsvg6i4122aRf5tBET9nzMc0S7oOYL14TNcbOE1M/J0ur9lYUCdDWkKYDubCGhgPCGS4grToJD/ADrhCwUqpweRd2Ri8mBAPJspzkTUA/dBc9rNy3lJTWV2imFcHpWqEdGkapEcgQc4G1ZPRaefMMzTtG43z7UxprfEQGoyVuEzPLrgiWPEOYdfUvUHSRXxm1ROquQGJajAzb9tPw0ecQLqkRv/EagSvaWRYLmM6uhKqwyXEEtLwkWuFC7XvVyd/NGd66B//Yw0BlHm4nZwNtGh8C3WJC836g6+zaB5N4GQkafx1B8vxldUedQkh3tSbIq60kv+DMsGiWlj57uNQIrGbkR3kFrkJnXYiYLcmyoGYtWru5bckbXH/fPnXYFAa5kZq/4J2Da7+tC+ZD8G76P4N7ofHmY045TeUSXhxIhMRLiMjDhwCT0or0Ug9STEqYI7UW/t7bNxAliOLP8OkRmfE6srLAnuKJNZowWi07EU9xY5NJcMBI4ZCGZUKGCFaLQEZjZj1r9J+sDxjbOKeB5kOU1Mo1Byy5TkwgbQkZa29LPMxERlWOxNvUBucnZcmkj2RfQlWoyB9hQZBrfxDseBDco9VqGK8utsdZRTxE6NQBvo6NoNHEKYdKEO2pPV8Sb/f133jkycB+03uAIOqFWeznAlteFq+T57nmYi0GYVK5vx7y/nz6nmXs0W7nzat/N2k6cBSTphya2U1Xs6I1eRua5P0CCSvR1OrOxr1IddgzMv0Gs5FVItMDNli2rUzLMP0cKt+Pa0xqNlRcCEmZZkXqNRMfkZEmfHpz43uya8Fy728YAW0UhsyL+I+lp/R0yy+t4cVdezBvj/9Zd/Lc61GuVIzBqb2eo6ZH2vtvEVsJykZ66LFf4hbs4gh+Z5o973778saQ++NoG0PX+O5oG3cx1r/tL/nYXL972FmRs386nj+2YtSyKAI/GvD3OSCLBqlNUVVaVlitXUiozkf3YfOOax2XY6izpYlMgM6l3trh5WdiHuI38l1EYntbYbM5SA9EqRoo7E6jB75osm4qYbRosYrKheJsfmv7By1Vw62a9miUD25o76Pe0tWKDJwiN3a61K0T5OxuIMSkCUGc/q9haXJJ/QKlYt9Sh6IfGJv/dOGp4XqtTIGY3eyVJ3lYatpdSujbcbb5MzOnjMSuMm0KzmJFVdOPojM6cnxreebxfPazf5YY5+/NWfbbyv7XOssqF9mOfOVXBz0kP0Nm5L5YdyboD7QxihXodRFOMLa6u37fGnLUYu2es3VwOIwL1sjlu6GYBGMJM41+ilE2JYn2yhmlSHmL2E47OJL9s/acGhqN8vkUImxP/vaaM83kKWROlbyNGKzDeaTg1GflMl57Llm4re0PE+UNaQGJLoNlGuMxxnlUXv3FqdNKEacbwC3sK9lXmMgCyMt4jk1DZvlPITXkrWrBe8Otz2MKM7BjqPtzwO04WpnQ790iKwLUNttlmsJRnCYfve03tr814beVve0z/n6ex72U2L70taKPRcNKladA6WbKrkbTNjTPgSH41zMDx2PPTgKK04VDtSQbAxoSdTCvcTLvmrrdW/kVYrdr7fkXK4PlU5GOmRfZXSqwXI5YKAteRLG31v/tOFp7ftW7LpkfoNcCnaOPAp1YqesL/PR22DUgwCSUZDN2kzxXm8hHH1/CqjMlrmRIeglPIKXo7W7HWOfd2obmUgohtyrZVa6HzpBdhF2IsNcezYlJ/e0/mmDZVAg/mds+l3KeIrFvs/cViKpJ/s5WHuxr09RjCB/fWLPLJcS3g7+QkudTsmGktS+AODS/kzEvrcZgrP5XtQDrn1aMipOW5wsSzAi+6/pdnETBZpCtVzLYTUPxX1v6lm0zQv4Q2woUYWnViwlWQaG+S/+n+WLBS0jNRQiOodxKS0i+0McR/thJj/DziArcxYyF24XzBcZcawQ1EbjO51xFIq+qhyY5VFo4RLWPpRE81LJwWv/yOZEsgTWUje6CaYC+0V8WHe1bDVox9kJhz8ApxAPxg/l6GQDDa6WgbHzJ3EvCoxkOMi3aMKMt1zO9EZtAqzWC8NNKxLJeIB70rPe+qd9uIn2n3aHEAYVSMR6YCmnccj6zjFDgT7B8AD5GsKvl1sCGXcyNz0vcz7HRRD0JnMjXqPWHx47ARnphKWUzliKRVTIyQQ77viztzomzCQ9uvD+E9mZMxKZMuZhWRZtNGfVTCg8rS74sRxMZyi0/mk7K3lIShN/Fi8ZzY9czRCPWhHvXg5l9RCCBXhMEZfV/GA7pV4F6gJ88pZnIQBJq97wcRC5WTQkmt1Ru3DdZ+sx88/2UJHPZ0ZvfqQUdYI/jCQByLR4YY2nFWlYwcXesi48z1f6wPx+Zd+FgNV2vCtWoS18Uu+0eGmeCIUFqsUQIgSF/IzGaXEZLYy3YoxODoKzaiUoZ6cFxeqXCpULEIXyzZZW6B3/2wm/nWwkIRGXHgHVBvs9X9mZ+wHYYR0t0CGkf5y7ZUJAZCQeegewLi0hNy2U33mm5mRycEu0LRCENABviN+QvJW1C4Iat+kdA/EOtTI0329ocN7OiOejQAB51pAMh2G6DuWPsWP6DjKFeN++V0BlwqzkOhxPS0dmx1kShESCfdWhyQSxE3keAJjCJwbSWSVnqHzrcFzGiuik5UJcT4NY6uu383cm/HYsY7IUtPTp5A7nD8P9dHx6gL191VKH2oLuHWuHabJN8XT8b0c/QRrd7mMd7pP7YKm8iv2veufvDOA88lO1d74d7gdTto7rwwO002x1Vm9fLUsio2QpES/obOBYNtHQjpRXvM7OUKBhnaqNNwGwtYBUfwlpkz6mEOvEBFLsfTnL5Qlky4f5kQJvoRIqwgE55CXm000XBnkuD1KgOssK5Py6PUmS4+ixFWEOb6hgEdsVIK8PbA6WyggrjhRAXC/LY5TRyicohcKK/XZIarBPZI1Bt2ytYfUhJuoHMDpiChR3a6JcPUhMvC0EsOJyrdC7kKK0hMQz5rU54JT77fydIU0RSKCStijFqPBKkU+xaqjRbZaLyDiXclmOIeAWgb0bcyg8GwzQvlyIBAuG3VcmZLdSIotz779Ksv8qCahVDmaloMiZf1bH74Rt6chsUGVUZBxvIOOyy1TFHm7v0XTrBKv5iQ0Y5wReekw94eEs4n4FkPMhwp0pETy0KMVi1l5o7uMJsqfZomFCiwJvVrbNFBJq7x0C6iLw1GkcBPEMivaO/+38fQWaFOun0PGAdJMMOmTNtOWX4SDWz/ZM7RiTFXcDGeGmOW55BjRIdSkvXYd8suAaYT5RBet8YUSJwm0hpEi4mviVJvwkHWe1K8KS5jwEHvscCjUGC3wKc8w2G4AP0qJWotNYXHWuBKU5nZwGCnD6ieKfHtKu2/l5UCQ/0TvZKnbkN4J13s6qeoR8iSwLf5zle09gSk340kFleFDlZCnup/N3Jvx2cg9oGwTO6QZeghnfsGiBPUieZp4ygMKLEoVyjtOB5+ZAnNsC2qZ12n66Axf7dpkxl3+6NUeHOpRL3J7O+cC5pJUTP+qdVnsUGuRX4TmUMtYeC7Eosv8YWDJODQoDs9abAnEZOXCmBZVJSpBTD+RJqyGVtQLpUq/DkW+u985LQKWHTi2IzMBqyh9zoxYsttKa3glP52shY4xNAtNJWSkEInpMtI0nZ4NSWgM+Dh3nfYk39w4ILuA+gW6lYzMzjwSbatPerWKH9S2PZCU3VI1YBc4HT71bqNmV5Kbfzt6hXQ8xw8J7yPnK7WuoLvYORkOmnk6xJbAOeYlrK97zgoiAwNi8FZ4nwSuqzUlthmJxYzl+qtiLHCz46QLF9zOSROgsjGzhaOtc7rfzdyb8dqzApvO8jtsAbmO85SH3QQQQKntYkYyZ07e08vRtV4f50sxbeJkCFYNx7LiPv+ZCdf1X7nXCNH2pxaIc69sIeeoMNSIyTlSEL4t4F0Nzi57EIiguLt4SYdSRE/Pk/axiA57dXw9YJrxmMUAA86sFi9bOTrvTKl96LxsiI6tqsVb3tXH3KKvFSQloJN6KEZrSvOOMx1wNM3GOXIBMEThKeNqgHjb0sLpyQ1IG7Tqmqv6Jj1pk1nqY/bFdVGUYMIqaDWbFemGmrls+eLSY1QQkjwdvGXqL1yaLWybtjJifSKQBiqfn/3od6xhMfVBP6iDHafGO3KFMsbiifnYOb+BWwYcVasoNWLClZirCSo/bGaJoBil8nX37oRcOqwWZ/SlLF+06bRFL+RDRs2mlJ1IfrOY7m6+iAMOtVACm3iPpMPiX25tF1aQWbW1WhVFhRnbuZ/KnQY/FTcL0MlTUUwRBZKu6DpeGT8St4wjqn/XUxOuopf4mM/0W52oUsMqbh3KbTRGlXLQ60ohNPmG0Oq4NQH4xG1v+XHkPvPTVtHr1+rmGMCat11aeeFajdliQN1i+SRhAbgvITFTLU7tXh9DzCrrulZuLKLzVH39aqR0j7Jsl/gMFWPrxYZfY2rvN1ku9VpmKysCv9fgUG71PLbp7iLJOHwhJn+R+LuIaZoMEa49tH8AsA5VEn85cLT4ltm4Yi2S8G3vqvV4NAiI8sM6AVcMKl596nl0udArXE4OyKDb5NeJM/okvWYTs6f13DoAwy69fVBTri5siSkMGlfSL5dDfxFPJn0slqGFQL/QnJ0VOmX8ZSHkH27/ZMsKsea6EkXg9LV+H7BaFCPlq3zGUyaJML8EP8/JJ+opGCBOI4+FS6AkTpN6jwgAQUA/3QAYZtWyVtN612X+1p6WDgciaf+JG0U+/vfD05FroiXUaVDu1UjslKfh12yjEhsoFHiaaM4bJqsDOW1poOEK7BBNDTMViNFehIlYmAFb11+PbQ26O2SjdkenXfnvy43kEZ0t3S85bp5KVzNdMlK6KGUglSJz2BBZZVt043h+854SbZ9Ysz2zkDOfvf3siXlQGqfdR7/tEcw7z4E+PDHLi3pZZTr+oYCuhx4dr+On/6F13Mie7S0spEwQHjKPFj397mQiPp55SfxuDqP5FCtr8g8WTes/+ovf+Oxf+errLKZ43WUb9xITwOqPFeE5LxBMGmWIbSTZTrgFuaSO59JG6W2bXUSncfmecNHTMH4vsnOF1kYHvMRzL3gq3S0+1p827V94TVS8723kyuqe3yjfqZZvvL5ul9Zt9d/Gpxu62ZSRmXhHtfhvbfrXj7B7XPDfB6Sfmwqh+e2GQMoXLKidbyXr2aDWxK2U8VL5qTqsUpA7vmxoN7czh5i8/+K2ve5GqvahmrZBRzZV6BXQ9DWIVnrejqGb9vbNboh97Qhan3HWL6Ibsn1APYQ0o5uODF6HACrGR3yAoa9ESzZiefBettBDI0xV3LKm72tiEknopKe9MgBjdbygETfjrhv+6hEgKGU8CF1Y0+kR0xH6A61boKcd2vVln+etpI9hTLaTReM/H/UYlemQAvnHaG1Tmba2SyAhhtWyr/aoo1ux7XIHlWYdJNil6Mh2PG7aIlkUOPvkviKCuhRH+QV2BGRMKDm0kFvAHiWbvzq5KxAPcmlt3x/6/s6tdamfNXRP9ATuTQM3pt1v4HwqkA6uR0gEEMIFbq7yywE+zH8YLFGLW3goko3CA6B6WMLrFm7e+8E8iHJRA6saooJF9fU1Chy5zQw5KSpCl5dBwPQ6vNIQqT53kq/3mqQSc9qXYO1my57x/gyMQFX9zr4tXtN857Y0XnLcWKq+c8T6QNPeWfjVeEGrC5FZHs3vpociHTKH4t9xe7gz8b9b3/2Z9/29+rV6O0DC5o8OLiDElkfjKaW+UaZcU2YK1J3l69CB1H9qJ7kEIXTO00P1+5fKpKnmIdfePTxcHmbdDBsAK0qjyttXERe6b0ecE3p9attKx2+89xJBPXkHoLrHJCDXLPZ5OE8yOtHSLUPLByPCAbDNzhnV/vCtB+Bg8BcUnGmJpmacrU9O7V1gJ5tD9uvLlbCA6FShiUXf/65orhBVZHZdrb7v2O9+8soDn03AOK9d8iBlRwn+EYDaAifgs78xEY6veH2evnBRNHZkrmKbjRQ6rXa0U1ImK8v6G9ol/OOBvN/fSKdd0E7m5ItoYe8Zhc4bhzYEZzorJfJmMGdaoTnJ5BADWP2+2mYsrT2iOtzwSaEgX5GURybiMlz5dXus4jRZZvkFeHH7H68eQntqsJEmzmCxx/del7kgOuqevhASP8WuZSwqIQi/mwBpunWh3T2Au96/bo/QLM8XrEkXL7HjnSaaezcR9eR0ixPzm7Qb5Ja0Fr/dD4/xlSPIrS9u6pf2lafydEDOZIntdyx1Hd4T2qu9sil/5XzPkW128Og3yo1EJUp68okt5607AnDzw//TD0yeYPAUULPc48KuXZWKJhBjYaljSwq2sbIKyiqkXNlufmDQUioCRdDdxT/qPYzLD+Wc5BUhkyY3mGGmWxyq30RbKp1nB2SqMea1p68bR4lGiJz59wqmtB33RnsyweFGjBWKpJaN05s/+BfuPLHhEdSv9Ovsesuj91V5NWm2iqXN/7KFMNlB0ha3O3Z79EpVg/9uECMrR7CW1gF2eZOyq78XKZtopQLbnauzKvQdevr4Rb0x/Fg6z9rtGkSz9FCjiGX4nATqhH1wslAxgN8ogzZ7sdUKfrL61WFyR8iYLP8oXHIyfVHcWgyyYfMC+pjtZ1XGPDVKHsciWBYpUZT8pQz2/iZziq6d/J00yzI+K0uR4D8+skf5WA76K6/0lOvs/DgRhHVGbp66UV1aCX+21OOF4sn4GuwVDjEiemGWZTQtMmR3ZHkOiqQkvCwzaLl5dYC0ssrR5m/O+pb1b7eWsKHzenYdujjaF11MRGP3b/lZ96UYvu/rbq4SJmuWkLd1ztU1mrzUKRmUg5MKdhf7k8HiR6IIuv0UgzkXPThWclc1clnJziyz/rstlGfhvajK1NBmKP0bA1hPAHzMPfPY6bvvjg7ePiTZsRLC/Wz7v8ORBeO/Ikity+ddu5qeXNpF81br3g6OfekIJv1vWDo5eoj/LV5U9CLePwWIKrbh+tznIibI8+VP7QbUkwvfZe8K8Vr8zzRsBQw3jJGBQqG5ITBne4XS52WtzlP383XoR08fImBVbhboJXFhN5qpl8RYBdPWXwGs7UOKfnugmIPR/DsL/HmTtK5t/3gPutSeXtFULIyIPVfO7Mw+8U+22l9uG84ck0m1F8nIheF2C7P8dsKWApPjn1f/BCLJM/2GKX7reD+yby3Vg7quF9Vdi/Nn+XycA/mJGnhrw1eqzeKvgz19bjJlibfmLkO7Xn/vWXN0ULOgZJgu/U41w+u/cU9k9wlz6CKg24l0jS0b3nfREs6ggFmvoSyILQkeTyzd/B7jj/w7+3zfhfw8yseJKXiZZzXAM+xFeicLSgczKbASOu/134P/3IPzvweOgtdHFCP72tuubu8mPyjKTZiIOrF2Vq6Y8921cn/LJTti0TYk8/DI1s7x/LpjHfmcKg39p13e2185kk8P/AUrqYkahTAAA").split(","));function _v(t){return Rv(t.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}function Rv(t){let e=t.indexOf("1");if(e===-1)return[t];{let r=t.substr(0,e),i=Rv(t.substr(e+1));return pe(i.map(o=>[r+"l"+o,r+"i"+o]))}}var JI=l(()=>Nv(Ov())),Pc=3;function Nv(t){let e=new on,r=[];for(let i of t)i.length<Pc?r.push(i):e.add(i.slice(0,Pc),i);return{trie:e,small:r}}function QI(t,e){let r=tx(Pd(t.toLowerCase().normalize())),{small:i,trie:o}=e==null?JI():Nv(e);for(let n of[r.replace(/[^a-z]/gi,""),..._v(r)]){let s=i.find(a=>n.includes(a));if(s!=null)return s;for(let a=0;a<n.length-(Pc-1);a++){let m=o.get(n.substr(a,Pc));if(m!=null){let c=n.substr(a),h=m.find(x=>c.startsWith(x));if(h!=null)return h}}}}function $I(t){return QI(t)!=null}function em(t){let e=10,r="";do r=t();while(e-- >0&&$I(r.replace(/[^a-z]/gi,"")));return r}var Cv=BigInt(0);function ih(t,e,r=0){if(!isFinite(e)||t<=1)return[];let i=[];if(e===0)i.push(0);else for(;e>0;)i.push(e%t),e=Math.floor(e/t);for(;i.length<r;)i.push(0);return i.reverse()}var mn=class{constructor(e,r,i=Vr){this.name=e;this.numerals=r;this.decodePreparser=i;this.base=r.length}digitsToNumerals(e){return e.map(r=>this.numerals[r]).join("")}encode(e,r=0){if(!isFinite(e))return"";let i=e<0;return i&&(e=Math.abs(e),r--),(i?"-":"")+this.digitsToNumerals(ih(this.base,e,r))}encodeBigInt(e){if(typeof e!="bigint")throw new Error("bad input");if(e===Cv)return this.numerals[0];let r=[],i=BigInt(this.base),o=e;for(;o>Cv;)r.push(Number(o%i)),o=o/i;return this.digitsToNumerals(r.reverse())}encodeBuffer(e){if(e==null||e.length===0)return"";let r=[0];for(let i of e)for(r.forEach((o,n)=>{i+=o<<8,r[n]=i%this.base,i=Math.floor(i/this.base)});i>0;)r.push(i%this.base),i=Math.floor(i/this.base);return this.digitsToNumerals(r.reverse())}decode(e){return p(this.decodeBigInt(e),r=>{if(r>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(r)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(e==null||P(e))return;e=xe(this.decodePreparser)?this.decodePreparser(e):e;let r=e[0]==="-";r&&(e=e.slice(1));let i=BigInt(this.base),o=BigInt(0);for(let n of e){let s=this.numerals.indexOf(n);if(s<0)return;o=o*i+BigInt(s)}return r?BigInt(-1)*o:o}randomChars(e){return this.encodeBuffer((0,Bv.randomBytes)(e+3)).slice(1,e+1)}safeRandomChars(e){return em(()=>this.randomChars(e))}randomUid(e=20,r=5,i="-"){return en(this.randomChars(e),r).join(i)}safeRandomUid(e,r=5,i="-"){return em(()=>this.randomUid(e,r,i))}tokenEql(e,r,i){let o=this.normalizeToken(e),n=this.normalizeToken(r);return o.length>=i&&o===n}normalizeToken(e){return this.decodePreparser(e.trim()).split("").filter(r=>this.numerals.includes(r)).join("")}},HG=new mn("hex","0123456789abcdef",t=>t.toLowerCase()),un=new mn("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),YI=new mn("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",t=>t.toLowerCase()),ds=new mn("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",t=>t.toLowerCase()),Ec=new mn("TokenRadix","0123456789abcdefhjkmnpqrtuvwxy",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9")),GG=new mn("AlphaRadix","abcdefghjkmnpqrtuvwxyz"),KG=new mn("NumericRadix","0123456789",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9"));function Dc(t,e){let r=t.toUpperCase().normalize(),i=e.toUpperCase().normalize();return Gi(()=>r===i?1:void 0,()=>P(t)!==P(e)?0:void 0,()=>t.length===1&&e.length===1?0:void 0,()=>{let o=Vv(r),n=Vv(i),s=XI(o,n).length;return 2*s/(o.length+n.length)})}function Vv(t){return t==null||t.length===0?[]:t.slice(0,-1).split("").map((e,r)=>e+t[r+1])}function XI(t,e){let r=Ad(t,e),i=[];return r.forEach(o=>{let n=Math.min(Er(t,s=>s===o),Er(e,s=>s===o));Te(n,()=>i.push(o))}),i}function Uv(t){let e=t+`
`;return R?e.replace(vo,`\r
`):e}function Xi(...t){return pe(t.map(e=>d(e).split(vo)))}var Qv=M(require("fs")),rm=M(require("fs-extra")),hs=M(require("path"));var za=M(require("fs-extra")),ah=M(require("path"));var oh=M(require("crypto")),zv=M(require("fs"));var Wv=192;async function Ac(t,e){let r=oh.default.createHash("sha512"),i=0,o=w(e?.msbits,Wv)/8;return await le(t,n=>new Promise((s,a)=>{let m=zv.default.createReadStream(n,{autoClose:!0});m.on("error",c=>a(c)),m.on("data",c=>{i+=c.length,e?.observer?.onProgress(i),r.update(c)}),m.on("end",()=>s())})),r.digest().slice(0,o)}function ZI(t,e=Wv){return oh.default.createHash("sha512").update(t).digest().slice(0,e/8)}function jr(t,e=9,r=un,i=224){return r.encodeBuffer(ZI(t,i)).substring(0,e)}function cn(t,e=24,r=ds,i=224){return jr(t,e,r,i)}var jv=M(require("fs")),tm=M(require("fs-extra")),Hv=M(require("util")),Ua=M(require("zlib"));function ek({message:t,cause:e,retriable:r,ignorable:i,fatal:o,doNotSend:n}){let s=[t];K(He(fe(e),"Error: "),m=>s.push(m));let a=rx(z(s)).join(": ");return o=o||a.includes(ge),r=(r||a.includes(Pa))&&!a.includes(Gt),n=n||!a.includes(Ao),i=i||a.includes(jl),uc(cc(a),o?ge:void 0,n?Si:void 0,i&&!o?jl:void 0,!r&&!o?Gt:void 0,r&&!o?Pa:void 0)}var ae=class extends Error{constructor({cause:e,message:r,retriable:i=!0,ignorable:o=!1,fatal:n=!1,doNotSend:s=!1}){super(ek({message:r,cause:e,retriable:i,ignorable:o,fatal:n,doNotSend:s}));this.cause=e,e!=null&&(this.stack=e.stack),this.retriable=i,this.fatal=n}};var qv=M(require("stream"));var nh=class extends qv.Writable{constructor(e){super(e);this.deferred=new Jt("WritableToBuffer");this._buf=[];this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",r=>{this.deferred.reject(r)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,r,i){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,r)),i()}};var tk=l(()=>f("zcat"));async function Gv(t,e){try{return b(Fc(t,e),d)}catch(r){tk().warn("zcat failed to read "+t,r);return}}async function sh(t,e,r){if((await(0,tm.stat)(t)).size===0)return;let o=[],n=[(0,jv.createReadStream)(t,g({autoClose:!0},r)).on("error",s=>o.push(s))];if(t.toLowerCase().endsWith(".gz")?n.push((0,Ua.createGunzip)().on("error",s=>o.push(s))):t.toLowerCase().endsWith(".br")&&n.push((0,Ua.createBrotliDecompress)().on("error",s=>o.push(s))),n.push(e),await cs(n),L(o))throw new ae({message:"zReadFile("+t+") failed",cause:o[0]})}async function Fc(t,e){if((await(0,tm.stat)(t)).size===0)return Buffer.from([]);let i=new nh;return await sh(t,i,e),await i.buffer}async function Kv(t){return JSON.parse((await Fc(t)).toString())}var rk=(0,Hv.promisify)(Ua.gzip);async function Jv(t,e){let r=I(e),i=await rk(r);return(0,tm.outputFile)(t,i)}var lh="readdircache",mh=l(async()=>{let t=(0,ah.join)(u.cacheDir.valueOrDefault,lh);return await(0,za.mkdirp)(t),t},E);async function ik(t){return(0,ah.join)(await mh(),...en(cn(t)+".json.gz",2,3))}var uh=l(()=>f("Readdir"));function ch(t){return t!=null&&T(t.basename)&&hd(t.isFile)&&hd(t.isDirectory)}B(()=>{j(()=>Lc.prior()?.clear()),ar(t=>{t==null?Lc.prior()?.clear():Lc.prior()?.deleteIf(e=>e.startsWith(t))})});var Lc=l(()=>new Yi({maxSize:500,timeoutMs:H,clearEveryMs:E}));async function ph(t){let e=await Lc().getOrSetAsync(t,()=>ok(t));if(e==null)throw new Error("readdir() timeout for "+t);return e}async function ok(t){let e=await ik(t);try{let o=(await(0,za.stat)(e)).mtimeMs;if(Date.now()-o<u.readdirCacheSeconds.valueOrDefault*v){let n;if(await Be(async()=>(n=await Kv(e),n!=null&&Array.isArray(n)&&n.every(ch)),{timeoutMs:H-v,timeBetweenMs:250}))return n}}catch(o){o.code!=="ENOENT"&&uh().debug("Failed to read from readdir cache",o)}let r=await Ca((0,za.readdir)(t,{withFileTypes:!0})),i=Zw(r.result.map(o=>({basename:o.name,isFile:o.isFile(),isDirectory:o.isDirectory()})),o=>o.basename);if(r.elapsedMs>=500)try{await Jv(e,i),uh().debug("Wrote readdir cache for slow directory",{nativePath:t,elapsedMs:r.elapsedMs})}catch(o){uh().debug("Failed to write to readdir cache",o)}return i}var im=class{constructor(e,r){this.base=e;ch(r)?(this.isFile=r.isFile,this.isDirectory=r.isDirectory):(this.isFile=r.isFile(),this.isDirectory=r.isDirectory()),r instanceof Qv.Stats&&(this.size=r.size,this.mtimeMs=r.mtimeMs)}},$v=l(()=>f("DirectoryEntry")),br=class{constructor(e,r){this.dir=e;this.dirent=r;this.nativePath=(0,hs.join)(this.dir,r.base),this.ext=Mi(r.base).ext}static async for(e){let r=Mi(e);try{let i=await(0,rm.stat)(e);return new br(r.dir,new im(r.base,i))}catch{return}}async join(...e){return br.for((0,hs.join)(this.nativePath,...e))}get base(){return this.dirent.base}get name(){return gr(this.base,this.ext)}get pathnames(){return this.nativePath.split(hs.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}get isRoot(){return this.dir===(0,hs.parse)(this.dir).dir}parent(){let e=Mi(this.dir);return e.dir===this.dir?this:new br(e.dir,{base:e.base,isFile:!1,isDirectory:!0,mtimeMs:void 0,size:void 0})}async childNames(){try{return this.isDirectory()?(await ph(this.nativePath)).map(e=>e.basename):void 0}catch(e){$v().warn("childNames() failed to readdir("+this.nativePath+")",e);return}}async children(){try{return this.isDirectory()?(await ph(this.nativePath)).map(r=>new br(this.nativePath,new im(r.basename,r))):void 0}catch(e){$v().warn("children() failed to readdir("+this.nativePath+")",e);return}}async visitDescendantFiles(e){for(let r of D(await this.children()))await(r.isFile()?e(r):r.isDirectory()?r.visitDescendantFiles(e):void 0)}async filterDescendantFiles(e){let r=[];return await this.visitDescendantFiles(async i=>{await e(i)===!0&&r.push(i)}),r}stat(){return(0,rm.stat)(this.nativePath).catch(()=>{})}async size(){return ye(this.dirent.size,()=>b(this.stat(),e=>e.size))}async mtimeMs(){return ye(this.dirent.mtimeMs,()=>b(this.stat(),e=>e.mtimeMs))}unlink_(){return(0,rm.unlink)(this.nativePath)}};var nk=64,om=class extends Ce{constructor(){super(nk);B(()=>ar(e=>this.clearFromPath(e))),B(()=>j(()=>this.clear())),this.on("expire",(e,r)=>r?.clear())}clearFromPath(e){P(e)?this.clear():this.visit((r,i)=>{r.startsWith(e)&&i.clear()})}};var Yv=M(require("stream"));var gs=class extends Yv.Transform{constructor(){super({objectMode:!1,autoDestroy:!0})}async _transform(e,r,i){let o=(d(this._prior)+d(e)).split(vo),n=o.pop();this._prior=n===""?void 0:n;for(let s of o)this.push(s)||await nt(1);i()}_flush(e){this._prior!=null&&this.push(this._prior),this._prior=void 0,e()}};var kc=M(require("timers"));function fh(t){return t!=null&&T(t.path)&&T(t.op)&&Pt(0,100,t.pct)}var dh="progress";function nm(t){fh(t)&&me.emit(dh,g(g({},t),{pct:Ye(re(0,100,t.pct))}))}function Ic(t){me.on(dh,t)}function Xv(t){return me.removeListener(dh,t)}function ys(t,e,r=!1){let i=r?Date.now()+e:0,o=0,n=(...s)=>{let a=Date.now();if(a>=i)return i=a+e,o++,t(...s)};return n.count=()=>o,n}var Oc=500,pn=class{constructor(e,r,i=Oc){this.context=e;this.total=r;this.throttleMs=i;this.start=Date.now();this.emit=ys(()=>{nm(g(g({},this.context),{pct:this.pct,elapsedMs:this.elapsedMs}))},this.throttleMs,!0)}incrProgress(e){this.onProgress(e+w(this.current,0))}onProgress(e){this.current=re(0,this.total,w(e,w(this.current,0)+1)),this.emit()}get pct(){return Ye(100*w(this.current,0)/this.total)}get elapsedMs(){return Date.now()-this.start}},bs=class{constructor(e,r,i,o=Oc){this.ctx=e;this.total=r;this.progress=i;this.throttleMs=o;this.start=Date.now();this.onInterval=ys(()=>b(this.progress(),n=>this.emit(n)),this.throttleMs),this.timer=(0,kc.setInterval)(()=>this.onInterval(),Oc)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){p(e,r=>nm(g(g({},this.ctx),{pct:100*re(0,this.total,r)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>Oc&&this.emit(this.total),this.end()}end(){p(this.timer,e=>(0,kc.clearInterval)(e)),this.timer=void 0}};var ws=M(require("path")),tT=M(require("process"));var Zv=M(require("fs")),hh=M(require("path"));function eT(t){let e=[];for(;t!==(0,hh.dirname)(t);)t=(0,hh.dirname)(t),e.push(t);return e}function sk(t){try{return(0,Zv.readdirSync)(t)}catch(e){return[]}}function Rc(t,e){let r=sk(t);return e.every(i=>r.includes(i))}var gh=l(()=>(0,ws.dirname)(process.execPath)),Hr;(function(c){c.Root=l(()=>{let h=["icc","migrations","public","views"],x=[];Ne()&&x.push("/ps/app"),si&&x.push((0,ws.join)(gh(),"resources"),(0,ws.join)(gh(),"..","Resources")),x.push(...z([gh(),(0,tT.cwd)(),__dirname])),$u(x);for(let S of x){if(Rc(S,h))return S;for(let F of eT(S).slice(0,4)){if(Rc(F,h))return F;let U=(0,ws.join)(S,"node_modules","photostructure");if(Rc(U,h))return U}}throw new Error("Failed to find project root. Looked in "+x)});let e=h=>l(()=>(0,ws.join)(c.Root(),h));c.Bin=e("bin"),c.ICC=e("icc"),c.Migrations=e("migrations"),c.Public=e("public"),c.Tools=e("tools"),c.Views=e("views");async function m(h=c.Root()){return de?new RegExp(`^\\/Volumes\\/${Yn}[^\\/]*\\/${Yn}.app\\/`,"i").exec(h)!=null:!1}c.isInDMG=m})(Hr||(Hr={}));function fn(t,e,r){let i=new _c(e,r,!0);return i.read(t),i.done}var _c=class{constructor(e,r,i=!0){this.sep=e;this.onData=r;this.filterBlanks=i;this.incompleteChunk="";this.done=new _e}onChunk(e){if(e==null)return;let i=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=i.pop(),i.forEach(o=>{(!this.filterBlanks||T(o))&&this.onData(o)})}clear(){this.onChunk(""),T(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",r=>this.onChunk(r)),e.on("end",()=>{this.clear(),this.done.resolve()}),this}};var iT=R?"wip-":".",yh=new om,ui=class{constructor(e,r){this.dirent=r;this.bflog=l(()=>f("BaseFile("+this.nativePath+")"));this._childDirectoryEntries=l(()=>b(this.directoryEntry(),e=>e.children()));this.stat=l(()=>this.trap("stat",()=>rt.default.stat(this.nativePath).catch(()=>{})),ui.attrTTL);this.statSync=l(()=>this.trapSync("statSync",()=>et(()=>Ir.default.statSync(this.nativePath))),ui.attrTTL);this.shaResult=l(async()=>{let e=await this.size();if(e===0||e==null)return;let r=e>5*Ki?new pn({op:"Computing SHA of",path:this.nativePath},e):void 0,i=await mi(()=>this.trap("sha",()=>Ac([this.nativePath],{observer:r}))),o=p(i.result,n=>n.toString("base64"));return{elapsedMs:i.elapsedMs,buffer:i.result,b64:o}},ui.attrTTL);if(r!=null)this.nativePath=r.nativePath,this.dir=r.dir,this.base=r.base,this.name=r.name,this.ext=r.ext;else{this.nativePath=Wr(e);let i=Mi(this.nativePath);this.dir=i.dir,this.base=i.base,this.name=i.name,this.ext=i.ext}this.posixPath=ai(this.nativePath),yh.set(e,this)}toJSON(){return{nativePath:this.nativePath}}[rT.inspect.custom](){return this.toJSON()}static async withFastestAccess(e){let r=A(e),i=await Promise.all(r.map(o=>o.shaMs()));return r[wd(i)]}static forPosix(e){return e instanceof ui?e:this.for(e.split("/").join(dn.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(e instanceof ui)return e;let i=yh.get(e);if(i!=null)return i;let o=Wr(e);return yh.getOrSet(o,()=>new ui(o,r))}static clear(e){zr(e)}for(e,r){return ui.for(e,r)}clear(){return this.dirent=void 0,this._childDirectoryEntries.unset(),this.stat.unset(),this.statSync.unset(),this.shaResult.unset(),this}clearThisAndParent(){return zr(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return e==null?!1:e instanceof ui?this.nativePath===e.nativePath:this.nativePath===ui.for(e).nativePath}get isUNC(){return $d(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return yc(e,this)}async directoryEntry(){return this.dirent==null&&(this.dirent=await b(this.stat(),e=>new br(this.dir,new im(this.base,e)))),this.dirent}async childDirectoryEntries(e){let r=await this._childDirectoryEntries();return r==null||e==null||N(r)?r:await Qi(r,e)}_directoryEntryChild(e){return this.for((0,dn.join)(this.nativePath,e.base),e)}childNames(){return b(this.childDirectoryEntries(),e=>e.map(r=>r.base))}async children(e){return(await this.childDirectoryEntries(e))?.map(r=>this._directoryEntryChild(r))}async childFiles(e){let r=[];for(let i of D(await this.childDirectoryEntries()))if(i.isFile()){let o=this._directoryEntryChild(i);(e==null||await e(o))&&r.push(o)}return r}async childDirectories(e){return b(this.childDirectoryEntries(),r=>ms(r.filter(i=>i.isDirectory()).map(async i=>Dv(this._directoryEntryChild(i),e))))}childrenSync(){return w(this.trapSync("childrenSync",()=>Ir.default.readdirSync(this.nativePath).map(e=>this.join(e))),[])}async hasChildren(e){let r=await this.childNames();return L(e)?Nu(r,e):L(r)}async hasNoChildren(){return await this.isFile()||N(await this.childNames())}async visitDescendants(e){return b(this.children(),async r=>{for(let i of r)await i.visitDescendants(e),await e(i)})}async descendants(e){let r=[];for(let o of D(await this.childFiles()))await e(o)&&r.push(o);let i=await this.childDirectories();if(i!=null)return await Ar({name:"descendants",laters:i.map(o=>()=>b(o.descendants(e),n=>r.push(...n)))}),r}async ancestorWithChildren(e){return await this.hasChildren(e)?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}async siblings(e){let r=this.parent();return(await this.siblingDirectoryEntries(e))?.map(i=>r._directoryEntryChild(i))}async siblingDirectoryEntries(e){return this.parent().childDirectoryEntries(async r=>r.base!==this.base&&(e==null||await e(r)))}async selfAndSiblings(){return this.parent().children()}async firstExistingSelfOrAncestor(){return this.isRoot||await this.exists()?this:this.parent().firstExistingSelfOrAncestor()}get pathnames(){return this.nativePath.split(dn.sep).filter(e=>e!=null&&e!=="")}get pathnamesWithoutDrive(){return R?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(R?1:0)}get isRoot(){return this.pathnames.length===(R?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return e!=null&&(this.nativePath===e.nativePath||_u(e.pathnames,this.pathnames))}isDescendantOf(e){return e!=null&&e.isAncestorOf(this)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){let e=this.parent();return this.isRoot?[]:[...e.parents(),e]}async normalize(){return this.isUNC?this:await this.exists()||this.isRoot?this:b(this.parent().normalize(),async e=>{let r=await e.childNames();if(L(r)){for(let o of r)if(o===this.base)return e.join(o);let i=this.base.normalize();for(let o of r)if(o.normalize()===i)return e.join(o);if(de||R){for(let o of r)if(ot(o,this.base))return e.join(o)}}})}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return N(e)||Dr(["."],e)?this:mv(e[0])?this.for((0,dn.join)(...e)):this.for((0,dn.join)(this.nativePath,...e))}joinYMD(e=new Date){return lw(e?.getFullYear(),e?.getMonth(),e?.getDate(),(r,i,o)=>this.join(d(r),Ht(i+1),Ht(o)))}child(...e){if(N(e))return this;let r=pe(e.map(i=>i.split(dn.sep))).filter(i=>i!=="..");return this.join(...r)}async trap(e,r,i="warn"){try{return await Ge("fs."+e,r)}catch(o){this.bflog().log(i,`trap: ${e}() failed: ${o}`);return}}async trapOr(e,r,i="warn"){try{return this.bflog().trace(`trapOr ${e}()`),await r(),!0}catch(o){return this.bflog().log(i,`trapOr: ${e}() failed: ${o}`),!1}}trapSync(e,r){try{return this.bflog().trace(`trapSync ${e}()`),r()}catch(i){this.bflog().warn(`trapSync: ${e}() failed: ${i}`);return}}async exists(){return this.dirent!=null||await Hx(this.stat())}existsSync(){return this.dirent!=null||this.statSync()!=null}async notExists(){return Et(this.exists())}mtime(){return b(this.stat(),e=>e.mtime)}mtimeMs(){return b(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return b(this.stat(),e=>Wi(e.mtime))}async lastModifiedUtc(){return b(this.stat(),e=>e.mtime.toUTCString())}statTimes(){return b(this.stat(),e=>G([e.birthtimeMs,e.mtimeMs,e.ctimeMs].filter(r=>r!=null&&r!==0)))}maxStatMs(){return b(this.statTimes(),Xu)}maxStatDate(){return b(this.maxStatMs(),e=>new Date(e))}minStatMs(){return b(this.statTimes(),ux)}minStatDate(){return b(this.minStatMs(),e=>new Date(e))}size(){return b(this.stat(),e=>e.size)}async access(e){try{return await rt.default.access(this.nativePath,e),!0}catch{return!1}}isExecutable(){return this.access(Ir.default.constants.R_OK|(R?0:Ir.default.constants.X_OK))}isReadable(){return this.access(Ir.default.constants.R_OK)}isNotReadable(){return Et(this.isReadable())}isReadWritable(){return this.access(Ir.default.constants.R_OK|Ir.default.constants.W_OK)}isNotReadWritable(){return Et(this.isReadWritable())}isHiddenPosix(){return this.base.startsWith(".")}async isEmpty(e=0){if(await this.isDirectory())return L(await this.childNames());{let r=await this.size();return r==null||r<=e}}isNonEmpty(e=1){return Et(this.isEmpty(e))}async isNonEmptyFile(e=1){return await this.isFile()&&await this.isNonEmpty(e)}async modifiedGTE(e){return b(this.mtime(),r=>Wi(r)>=Wi(e))}async modifiedCloseTo(e,r){return b(this.mtimeMs(),i=>Math.abs(i-e)<=r)}async isRecent(e){let r=await this.maxStatMs();return r!=null&&r>Date.now()-e}async modifiedGT(e){if(e!=null)return b(this.mtime(),r=>Wi(r)>Wi(e))}async isDirectory(){return this.dirent!=null?this.dirent.isDirectory():he(this.stat(),e=>e.isDirectory(),()=>!1)}async isNotDirectory(){return Et(this.isDirectory())}isDirectorySync(){return this.dirent!=null?this.dirent.isDirectory():Z(this.statSync(),e=>e.isDirectory(),()=>!1)}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile(){return this.dirent!=null?this.dirent.isFile():this.stat().then(e=>W(e).map(r=>r.isFile()).getOrElse(()=>!1))}isFileSync(){return this.dirent!=null?this.dirent.isFile():W(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>rt.default.rmdir(this.nativePath),e)}async mkdirp_(){try{await rt.default.mkdirp(this.nativePath)}catch(e){if(e.code!=="EEXIST")throw e}if(await Be(()=>this.clear().isDirectory(),{timeoutMs:2*v,timeBetweenMs:200})===!1)throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return await this.clear().isDirectory()||this.isRoot?this:this.trap("mkdirp",async()=>this.mkdirp_())}mkdirpSync_(){return rt.default.mkdirpSync(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",()=>this.mkdirpSync_())}sha(){return b(this.shaResult(),e=>e.b64)}shaMs(){return b(this.shaResult(),e=>e.elapsedMs)}async writeStream_(e,r){return await cs(A([e,p(r?.onProgress,i=>new Qd(i)),rt.default.createWriteStream(this.nativePath,r)])),this.clearThisAndParent()}async writeJsonMaybe(e,r={}){return this.trap("writeJsonMaybe",()=>this.writeJSON_(e,r))}async writeJSON_(e,r={}){return await this.parent().mkdirp(),await rt.default.writeFile(this.nativePath,I(e,r.replacer,r.spaces),g({flag:"w"},r)),this.clearThisAndParent()}readJson(e="warn"){return this.trap("readJson",()=>lr(async()=>await this.isNonEmptyFile()?rt.default.readJson(this.nativePath):void 0,{maxRetries:1,onRetryWaitUntil:()=>gt(e==="warn"?250:25),errorIsRetriable:r=>r.errno!==-2}),e)}readJsonSync(){return this.trapSync("readJsonSync",()=>rt.default.readJsonSync(this.nativePath))}readFileSync_(){return rt.default.readFileSync(this.nativePath)}readFile_(){return rt.default.readFile(this.nativePath)}readFile(e="warn"){return this.trap("readFile",()=>this.readFile_(),e)}async zReadFile_(e){return Fc(this.nativePath,e)}async zcat(e){return this.trap("zcat",()=>b(this.zReadFile_(e),d))}async zCopyFile(e,r){return this.trap("zCopyFile",async()=>(await e.parent().mkdirp(),await sh(this.nativePath,Ir.default.createWriteStream(e.nativePath),r),e))}readLines(){return b(this.readFile(),e=>Xi(e.toString()))}readFileSync(){return et(()=>p(Ir.default.readFileSync(this.nativePath),d))}writeTxt_(e){return this.writeFile_(Uv(e))}async writeFile_(e){return await this.parent().mkdirp(),await rt.default.writeFile(this.nativePath,e),this.clearThisAndParent()}wip(e=iT){return this.sibling(e+this.base)}async unwip_(e=iT){let r=this.sibling(He(this.base,e));return this.mv_(r,{overwrite:!0})}async dest(e){let r=e.clear();return T(this.ext)&&P(r.ext)||await r.isDirectory()?r.join(this.base):r}copyFile_(e){return Ge("fs.copyFile",async()=>{let r=(await this.dest(e)).clear();if(this.nativePath===r.nativePath)return this;if(await r.parent().mkdirp()==null)return this.bflog().throw("Cannot mkdirp "+r.dir);try{return await this._copyFile(r)}catch(o){if(Ux(o))throw o;return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:r.nativePath,error:o}),await this._nativeCopyFile(r)}finally{this.clearThisAndParent()}})}async _copyFile(e){let r,i,o=e;try{let n=await ye(this.stat(),()=>this.clear().stat());if(n==null)return this.bflog().throw("Can't copy missing files"+Gt);if(n.size===0)await e.touch(n.mtime,n.atime);else{if(u.verifyFileCopies.valueOrDefault&&await this.sha()==null)return this.bflog().throw("Can't copy file without SHA"+Gt);i=e.wip();let s=rt.default.copyFile(this.nativePath,i.nativePath);n.size>5*Ki&&(r=new bs({op:"Copying",path:this.nativePath,dest:e.nativePath},n.size,()=>i.clear().size())),await s;let a=await Be(async()=>n.size===await i.clear().size(),{timeoutMs:H});if(u.verifyFileCopies.valueOrDefault){let m=a&&await Be(()=>Xn(this.sha(),i.clear().sha()),{timeoutMs:H});if(!m)return this.bflog().throw("copyFile_() failed",{sizeMatches:a,shaMatches:m})}if(!a)return this.bflog().throw("copyFile_() failed",{expectedSize:n.size,actualSize:await i.clear().size()});if(o=await i.unwip_(),o==null)return this.bflog().throw("copyFile_("+e+") failed: .unwip() was null");await rt.default.utimes(o.nativePath,n.atime,n.mtime)}try{await rt.default.chmod(o.nativePath,n.mode)}catch(s){this.bflog().debug(`copyFile_(${o.nativePath}) warning: couldn't chmod to ${n.mode}: ${s}`)}return this.bflog().debug(`copyFile_(${e.nativePath}): success`),Ud(this.nativePath,e.nativePath),e}catch(n){throw this.bflog().warn(`copyFile_(${i?.nativePath}) failed: ${n}`),await i?.unlink(),await e.unlink(),n}finally{p(r,n=>n.end())}}async copyTimeoutMs(){return he(this.size(),e=>Math.max(H,e*gc),()=>H)}async _nativeCopyFile(e){let r;try{if(await e.parent().mkdirp()==null)return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});let i=await this.stat(),o=p(i,n=>n.size);return i==null||o==null?this.bflog().throw("Can't copy missing files"):(o>5*Ki&&(r=new bs({op:"Copying",path:this.nativePath,dest:e.nativePath},o,()=>e.clear().size())),R?await De.instance().execute(`Copy-Item -LiteralPath ${vs(this.nativePath)} -Destination ${vs(e.nativePath)}`,n=>n):await ue("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:await this.copyTimeoutMs()}),Ud(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(i){return this.bflog().throw("_nativeCopyFile("+e+"): "+i)}finally{p(r,i=>i.end())}}async touch(e=Date.now(),r){return this.trap("touch",()=>b(this.ensureFile(),()=>this.utimes(e,r)))}async utimes(e,r){let i=w(e,Date.now()),o=w(r,i);return this.trap("utimes",()=>rt.default.utimes(this.nativePath,Wi(o),Wi(i)).then(()=>this.clearThisAndParent()))}async unlink(e="warn"){return this.trap("unlink",async()=>(await rt.default.unlink(this.nativePath),this.clearThisAndParent()),e)}async rmrf(e="info"){return this.trap("rmrf",async()=>(this.bflog().log(e,"rmrf()"),await rt.default.remove(this.nativePath),this.clearThisAndParent()))}async unlock(){return de&&await this.clear().exists()&&await ue("chflags",["nouchg",this.nativePath],{timeout:H}),this}async renameWithNameSuffix_(e){return b(this.withNameSuffix(e).ensureNew_({emptyIsNew:!0}),r=>r.unlink("debug").then(()=>this.mv_(r)))}async mv_(e,r={overwrite:!1}){let i=await this.dest(e);if(this.nativePath===i.nativePath)return this.bflog().warn("mv(): no-op",new Error("internal error")),this;await i.parent().mkdirp(),this.bflog().debug("mv",i);try{await rt.default.move(this.nativePath,i.nativePath,r)}catch(o){this.bflog().warn("mv() try #1 failed. Calling unlock() and waiting for source to be non-empty.",o),await Promise.all([this.unlock(),i.unlock()]),await Be(()=>this.clear().isNonEmptyFile(),{timeoutMs:7*v}),await rt.default.move(this.nativePath,i.nativePath,r)}return await i.unlock(),this.clearThisAndParent(),i.clearThisAndParent()}async pipeTo(e,r){return this.trap("pipeTo("+e+")",async()=>{let i=await this.sibling(e).ensureNew_();return await cs([Ir.default.createReadStream(this.nativePath),r,Ir.default.createWriteStream(i.nativePath)]),await this.unlink(),i})}async gunzip(){return this.pipeTo(gr(this.base,".gz"),(0,xs.createGunzip)())}async gzip(){return this.pipeTo(this.base+".gz",(0,xs.createGzip)())}async compressBrotli(){return this.pipeTo(this.base+".br",(0,xs.createBrotliCompress)())}ensureFile(){return this.trap("ensureFile",()=>rt.default.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync_(){return rt.default.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return qr(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get baseWithoutCountWithParent(){return this.parent().base+"/"+this.baseWithoutCount}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}async ensureNewNativePath(e){return bc(g({nativePath:this.nativePath},e))}ensureNew_(e={}){return this.ensureNewNativePath(e).then(r=>this.for(r))}async renameYMDHMS_(e){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");let r=xw(await ye(this.mtime(),()=>new Date)),i=Z(e,o=>this.parent().join(o),()=>this.parent());return this.mv_(i.join(this.name+"-"+r+this.ext),{overwrite:!0})}async saveIfNewOrDelete(e){if(await this.clear().isEmpty()){await this.unlink("trace");return}let r=await this.siblingWithSameContents();if(r!=null)return await this.unlink(),r;let i=await this.sibling(e).ensureNew_();return this.mv_(i)}async chmod(e){return await rt.default.chmod(this.nativePath,e),this.clear()}zreadline(){return Ir.default.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe((0,xs.createGunzip)()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)}).pipe(new gs)}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return Ge("fs.childWithSameContents",async()=>{if(await this.notExists()||!await this.isDirectory())return;let r=await e.size(),i=await this.children(),o=[];for(let s of D(i))await s.size()===r&&!e.eql(s)&&o.push(s);if(N(o))return;let n=await e.sha();for(let s of o.sort((a,m)=>Dc(a.base,m.base)).reverse())if(await s.sha()===n)return s})}async applyWip(e,r=0,i=15*v){let o=this.wip();try{if(await o.parent().mkdirp(),(await o.clear().isRecent(i)||await this.clear().isRecent(i))&&(this.bflog().info("applyWip(): recent WIP exists. Waiting for a bit to see if someone else will do my work."),await Be(()=>this.clear().isNonEmpty(r),{timeoutMs:i*2,timeBetweenMs:500}))){this.bflog().info("applyWip(): yay, someone else did my work.");return}await this.touch(),await o.unlink("trace");let n=await e(o);if(await Be(()=>o.clear().isNonEmptyFile(),{timeoutMs:v}))return await o.unwip_(),n;throw new Error("applyWip(): empty after apply for "+this)}catch(n){throw await o.unlink(),await this.unlink(),n}}async applyIfEmpty_(e,r=0){return await this.clear().isNonEmpty(r)?this.bflog().debug("applyIfEmpty(): non-empty"):(this.bflog().debug("applyIfEmpty(): empty, applying..."),await this.applyWip(e,r)),this.touch()}firstMatchingLine(e){let r=new Jt("firstMatchingLine("+this+")"),i=Ir.default.createReadStream(this.nativePath,{flags:"r"});return i.on("error",o=>{o.errno===-2||o.code==="ENOENT"?(r.maybeResolve(void 0),i.close()):r.maybeReject(o)}),i.on("close",()=>r.maybeResolve(void 0)),fn(i,vo,o=>{let n=e.exec(o);n!=null&&(r.maybeResolve(n),i.close())}),r.promise}contemporary(e,r){return Aa(this.statTimes(),e.statTimes(),(i,o)=>{for(let n of i)for(let s of o)if(pw(n,s,r))return!0;return!1},()=>!1)}},ce=ui;ce.attrTTL=3*E,ce.projectRoot=l(()=>{let e=Hr.Root();if(e==null)throw new Error("Cannot find project path");return ui.for(e)});function Nc(t){let e=A(t).filter(([r,i])=>r!=null&&i!=null);return new Map(e)}function sm(t,e){return Nc(A(t).map(e))}async function oT(t,e){if(t==null)return new Map;let r=await Promise.all(A(D(t)).map(i=>e(i)));return Nc(r)}var Ts=M(require("process"));function Ei(t){return d(t).replace(/[-.,\\^$*+?()|[\]{}]/g,"\\$&")}function nT(t,e){let r=[];for(let i of t)try{new RegExp(i),r.push(i)}catch{r.push(Ei(i))}return new RegExp(r.join("|"),e)}var sT=class{constructor(e){this.h=e;this.text=w(e.text,d(e)),this.greedyLeft=w(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}},bh=l(()=>f("Fixed"));function Io(t,e,r=!0){return new aT(t,e,r).entries}var aT=class{constructor(e,r,i=!0){this.warnIfMissingHeaders=i;let o=r.split(/[\r\n]{1,2}/);this.headerRow=o[0],this.rows=o.slice(1);let n=Math.max(...this.rows.map(s=>s.length));this.col2blanks=new Map(Te(n,s=>[s,Er(this.rows,a=>P(a[s]))])),this.headers=this.extractHeaders(e.map(s=>new sT(s))),this.entries=this.rows.map(s=>this.headers.map(a=>a.toEntry(s))).map(s=>mt(s)).filter(s=>St(s).some(T))}extractHeaders(e){let r=this.headerRow;ie(e,s=>-s.text.length),e.forEach(s=>{let a=new RegExp(`\\b${Ei(s.text)}\\b`,"i"),m=a.exec(r);m==null?this.warnIfMissingHeaders&&bh().warn("extractHeaders(): Failed to find header!",{re:a,headerLine:r}):(s.indexOf=m.index,r=Qw(r,m.index,s.text.length," "))});let i=e.filter(s=>s.indexOf!=null),o=ie(i,s=>s.indexOf);o.forEach((s,a)=>{let m=s.indexOf,c=o[a-1],h=a===0?0:c.indexOf+c.text.length-1,[x,S]=s.greedyLeft?[h,m]:[m,h];s.leftIdx=p(this.firstBlankColumn(x,S),F=>F+1),a===0&&s.leftIdx==null&&(s.leftIdx=0),s.leftIdx==null&&bh().warn("no blank column for "+s.text+" between "+m+" and "+h)}),vt(o,s=>s.leftIdx!=null),o.slice(0,-1).forEach((s,a)=>{let m=o[a+1];s.rightIdx=m.leftIdx-1});let n=D(mx(e.map(s=>s.text),o.map(s=>s.text)));return n.length>0&&bh().warn("Missing headers",{missingHeaders:n}),o}firstBlankColumn(e,r){return xo(e,r).find(i=>this.col2blanks.get(i)===this.rows.length)}};var Bc=()=>"wmic",lT=()=>"fsutil";var mT=()=>"ping";var lk=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;function uT(t){let e=lk.exec(t);if(e==null)return;let r=e.slice(1,8).map(x=>V(x));if(!Fu(r))return;let[i,o,n,s,a,m,c]=r,h=V(e[8],{defaultValue:0});return new Date(Date.UTC(i,o-1,n,s,a,m,c/1e3)-h*E)}var mk=/Date\((\d+)\)/;function cT(t){return W(t).flatMap(e=>mk.exec(e)).flatMap(e=>e[1]).flatMap(V).filter(e=>Pt(0,Date.now()+lt,e)).map(e=>new Date(e)).get()}var uk=l(()=>f("Ps"));function ck(t){return t!=null&&k(t.pid)&&t.start!=null&&T(t.cmd)}async function pT(t){return b(am([t]),e=>D(e).find(r=>r.pid===t))}async function fT(t){return N(t)||Ru([Ts.default.pid],t)?D(t):b(am(t),e=>e.map(r=>r.pid))}async function am(t){let e=D(t).filter(k);if(N(e))throw new Error("Invalid pids: "+I(t));return Sx(b(R?pk(e):fk(e),r=>r.filter(i=>ck(i)&&e.includes(i.pid))),r=>uk().debug("pidInfo()",{pids:e,result:r}))}function dk(t){return t.map(e=>({pid:e.Id,start:cT(e.StartTime),cmd:e.ProcessName}))}var hk="Get-Process",gk="| Select-Object -Property Id,ProcessName,StartTime";function dT(t){return G([...t.filter(k),Ts.default.pid]).join(",")}async function pk(t){if(C()||De.instance().ended)return yk(t);let e=[hk,"-Id",dT(t),"-ErrorAction SilentlyContinue",gk].join(" ");return b(De.instance().executeJsonToA(e),r=>dk(r))}var hT={maxBuffer:1024*1024,timeout:15*v,ignoreExitCode:!0,ignoreStderr:!0},gT=["CommandLine","CreationDate","ProcessId"];async function yk(t){let e=["process"];if(L(t)){let o=G([...t.filter(k),Ts.default.pid]).map(n=>`ProcessId=${n}`).join(" or ");e.push("where",o)}e.push("get",gT.join(","));let r=await Ke(Bc(),e,hT),i=Dw(Io(gT,r.result).map(o=>({pid:V(o.ProcessId,{defaultValue:-1}),start:uT(o.CreationDate),cmd:d(o.CommandLine)})));return i.find(o=>o.pid===Ts.default.pid)||i.push({pid:Ts.default.pid,start:new Date(qi),cmd:"node "+Ts.default.title}),i}function bk(t){return Io(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],t).map(e=>({pid:V(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:d(e.COMMAND)}))}async function fk(t){let e=await Ke("ps",["-p",dT(t),"-wwwo","pid,lstart,command"],g(g({},hT),{ignoreExitCode:!0}));return bk(e.result)}var yT=M(require("path")),bT=M(require("process"));function ci(){return oi(bT.env.PS_CONFIG_DIR,()=>(0,yT.resolve)(_a(),wi().toLowerCase()))}var Zi=l(()=>f("Pids")),wk=10*v;function xT(t,e){if(t==null||e==null)return!1;let r=p(e.start,o=>o.getTime()),i=t.startTime;return k(r)&&k(i)&&Math.abs(r-i)<wk}async function xk(t,e){return t==null||e==null||t.name!==d(e.pid)?!1:xT(await t.readJson(),e)}function vT(t,e=!1){let r=["/PID",d(V(t)),"/T"];e&&r.push("/F"),wT.default.execFile("taskkill",r)}async function vk(t,e=!1){if(C()||De.instance().ended)return vT(t,e);try{let r=A(["Stop-Process","-Id",V(t),e?"-Force":void 0]).join(" ");await De.instance().execute(r,Vr)}catch(r){Zi().warn("killWin(): pwsh error, using TASKKILL: "+r),vT(t,e)}}async function Tk(t,e=!1){try{lm.default.kill(t,e?"SIGKILL":"SIGTERM")}catch(r){if(!String(r).includes("ESRCH"))throw r}}function Cc(t,e=!1,r=!0){if(t===lm.default.pid||t===lm.default.ppid)throw new Error("cannot self-terminate");return e&&r&&hn.instance().onKill(t),R?vk(t,e):Tk(t,e)}async function Vc(t){return await pT(t)!=null}var wh=class{constructor(e=ce.for(ci()).join("pids")){this.pidsDir=e;this.p=new tt;this.recentPids=new Ce(10*v);this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",async()=>{let r=w(e.everything,!1),i=w(e.force,R),o=await this.pidfiles(),n=await oT(o,S=>b(S.readJson(),F=>[F.pid,F])),s=G(pe(D(n.values()).map(S=>[S.pid,S.ppid])));if(N(s))return Zi().debug("killOldProcs(): no pidfiles"),[];let a=await am(s);if(Zi().debug("killOldProcs()",{pids:s,allEntries:a}),a==null){J("Pids.killOldProcs(): failed to get process information");return}let m=new Set(a.map(S=>S.pid)),c=a.filter(S=>n.has(S.pid)),h=ie(A(c.map(S=>p(n.get(S.pid),F=>xT(F,S)?g(g({},F),S):void 0))),S=>S.pid).filter(S=>lm.default.pid!==S.pid),x=r?h:h.filter(S=>!m.has(S.ppid)||!m.has(S.pid)||k(S.timeoutTime)&&Date.now()>=S.timeoutTime||e.everythingBefore!=null&&S.startTime<e.everythingBefore);Zi().debug("killOldProcs()",{trackedEntries:c,victims:x,pidfiles:D(n.values())});for(let S of x)Zi().debug("killOldProcs(): killing",{entry:S}),Cc(S.pid,i,!1);return await this.vacuumPids(),ie(x,S=>S.pid)})}async addPid(e,r,i=!1){if(e==null)throw new Error("undefined info");let o=e.pid;if(!k(o))throw new Error("undefined pid");let n=e.ppid+":"+e.pid;return i&&this.recentPids.delete(n),this.recentPids.getOrSet(n,async()=>{let s=this.pidsDir.join(e.pid+".json"),a=W(et(()=>Mi(e.cmd).base)).filter(T).getOrElse(()=>e.cmd),m=r.getTime(),c=se(e.maxAgeMs,x=>m+x),h=g(g({},e),{cmd:a,startTime:m,timeoutTime:c});return await s.writeJsonMaybe(h)==null?Zi().throw("Failed to write to "+s,{info:e,force:i}):(Zi().debug("addPid() wrote "+s,h),s)})}pidfiles(){return this.pidsDir.clear().children(e=>e.ext===".json"&&V(e.name)!=null)}async onKill(e){let r=this.pidsDir.join(e+".json");return b(r.clear().readJson(),i=>this.addPid(g(g({},i),{maxAgeMs:1}),ww(E),!0).catch(o=>{Zi().info("onKill(): failed to rewrite pidfile: "+o,{pid:e})}))}async vacuumPids(){let e=await this.pidfiles(),r=D(e).map(o=>V(o.name)).filter(k);if(N(r))return;let i=await am(r);if(i==null){J("Failed to get pidInfo for pids "+r);return}Zi().debug("vacuumPids",{pids:r,pidfiles:D(e).map(o=>o.base),entries:i});for(let o of e){let n=i.find(s=>d(s.pid)===o.name);(n==null||!await xk(o,n))&&(Zi().debug("vacuumPids(): Removing old pidfile "+o.base,{psEntry:n,pidfile:await o.readFile().then(d).catch(s=>"(failed to read file: "+s+")")}),await o.unlink())}}},hn=wh;hn.instance=l(()=>new wh);function Uc(t,e){return hn.instance().addPid(t,e)}var fQ=l(()=>{let t=[{everything:!1,force:!1,intervalMs:5*E},{everything:!1,force:!0,intervalMs:17*E}].map(e=>Ur(()=>hn.instance().killOldProcs(e),e.intervalMs));return new we("ProcCleaner",()=>(t.map(clearInterval),hn.instance().killOldProcs()),Q.predb)});var mm=Se("AboveNormal","Normal","BelowNormal","Idle"),xh=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19});var Di=class{constructor(e){this.ttlMs=e;this.expireListeners=[];this.delegate=new Map;this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,r=this.ttlMs){return this.delegate.set(e,Date.now()+(r-this.ttlMs)),this}addIfMissing(e,r){let i=this.delegate.get(e);if(i==null||this.isEntryExpired(e,i))return this.add(e),r()}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(let[r,i]of this.delegate)this.isEntryExpired(r,i)||e(r,r,this)}has(e){return!this.isEntryExpired(e,this.delegate.get(e))}values(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield i)}return r()}entries(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield[i,i])}return r()}toA(){return this.vacuum(),[...this.delegate.keys()]}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}on(e,r){this.expireListeners.push(r)}isEntryExpired(e,r){return kt(r==null||r+this.ttlMs<=Date.now(),i=>{r!=null&&i&&(this.expireListeners.forEach(o=>o(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,r)=>{this.isEntryExpired(r,e)})}};var TT=l(()=>f("Renice"));B(()=>j(()=>vh.prior()?.clear()));var vh=l(()=>new Di(E));async function zc(t){if(vh().has(t))return;vh().add(t);let e=u.processPriority.valueOrDefault;return se(t,async()=>{try{await(R?Sk(t,e):Mk(t,w(xh[e],xh.BelowNormal))),TT().info("Renice pid "+t+" to "+e)}catch(r){TT().info("Failed to renice pid "+t+"",r);return}})}async function Sk(t,e){return se(t,r=>mm.mapValid(e,i=>De.instance().execute(`(Get-Process -Id ${t}).PriorityClass = "${e}"`,o=>o)))}async function Mk(t,e=19){return Ke("renice",[e,"-p",t].map(d),{timeout:10*v,isIgnorableError:()=>!0,ignoreExitCode:!0,maxRetries:0})}var Mh=M(require("process"));var MT=M(require("process"));var eo=class{constructor(e){this.a=e}async _map(e,r){let i=this.a!=null?await this.a():void 0,o=Th(i)?await i.get():i;return o!=null?e(o):r()}async isDefined(){return this._map(()=>!0,()=>!1)}async isEmpty(){return this._map(()=>!1,()=>!0)}async get(){return this._map(e=>e,()=>{})}async getRequired(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}async exists(e){return this._map(e,()=>!1)}map(e){return new eo(async()=>this._map(e,()=>{}))}flatMap(e){return new eo(async()=>this._map(e,()=>{}))}filter(e){return new eo(async()=>this._map(async r=>await e(r)?r:void 0,()=>{}))}catch(e){return new eo(()=>this.get().catch(async r=>e(r)))}forEach(e){return new eo(async()=>{let r=await this.get();return await p(r,e),r})}async getOrElse(e){return w(await this.get(),e)}orElse(e){return new eo(async()=>{let r=await this.get(),i=r??await e();return Th(i)?i.get():i})}};function Th(t){return t instanceof eo}function Dt(t){return Th(t)?t:new eo(()=>t)}var ST;(function(r){r.and=async(...i)=>{for(let o of i)if(!O(await o()))return!1;return!0},r.or=async(...i)=>{for(let o of i)if(O(await o()))return!0;return!1}})(ST||(ST={}));async function $t(...t){if(t!=null)for(let e of t){if(e==null)continue;let r=await e();if(r!=null)return r}}var PT="en",Wc=l(async()=>Sh(await $t(()=>ET(),()=>R?Pk():void 0,()=>de?Ek():void 0,()=>Fa?Dk():void 0)));function ET(t=MT.default.env){return Lu(t.LC_ALL,t.LC_MESSAGES,t.LANG,t.LANGUAGE)}var Ak=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function Sh(t){if(P(t)||ot("c",t)||ot("posix",t))return PT;{let e=Ak.exec(t);return e==null?PT:A([e[1],e[2]]).join("-")}}function Pk(){return b(De.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),t=>t.Name)}var DT={timeout:10*v};function Ek(){return Dt(ue("defaults",["read","-globalDomain","AppleLocale"],DT)).flatMap(Sh).get()}var Fk=/^([a-z_]+)\s*=\s*"(.+)"$/i;function Dk(){return Dt(ue("locale",[],DT)).flatMap(t=>t.split(`
`).map(e=>p(e.match(Fk),r=>[r[1],r[2]]))).flatMap(mt).flatMap(ET).flatMap(Sh).get()}function AT(){return{LANG:"C",LC_ALL:"C"}}var Lk=l(()=>new Set(St(u).map(t=>t.key)));function LT(){let t=Lk();return Aw(Fw(Mh.default.env,e=>e==="NODE_ENV"||t.has(e)))}var IT=l(()=>um().filter(t=>t.hasValue()));function Ik(){IT.unset()}var kT=l(()=>{try{return new RegExp(u.sensitiveEnvRegExp.valueOrDefault,"i")}catch(t){return console.error(`Invalid setting for "sensitiveEnvRegExp": ${t}. Using default value.`),new RegExp(u.sensitiveEnvRegExp.defaultValue,"i")}});B(()=>{u.sensitiveEnvRegExp.addListener(()=>{kT.unset(),OT.unset()});for(let t of um())t.addListener(Ik)});var OT=l(()=>{let t=kT();return rc(Mh.default.env,(e,r)=>t.exec(e)!=null?void 0:r)});function kk(){return IT().reduce((t,e)=>e.maybeAddToEnv(t),g(g({NODE_ENV:$o},Ne()?{PS_IS_DOCKER:"1"}:{}),si?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}))}function Ph(t){let e=w(t,{}),r=w(e.forceCLocale,!0);return g(g({},jt(e,"forceCLocale")),{env:Ok(e.env,r),detached:!1,shell:!1})}function Ok(t,e){let r=xi(g(g(g(g(g({},OT()),{PATH:FT()}),e?AT():{}),kk()),w(t,{})));return u.logStdout.deleteFromEnv(r),u.tailLogs.deleteFromEnv(r),r}var Yt=l(()=>f("ChildProcess"));function qc(t){return Mt(t,"pid","killed","connected","exitCode","signalCode")}function RT(t,e){return Be(()=>Et(Vc(t)),{timeoutMs:e})}async function cm(t,e=30*v){if(t==null)return!1;let r=t.pid;if(Yt().debug("endProcess("+r+")",{killed:t.killed,connected:t.connected}),r<=0)return Yt().warn("endProcess(): asked to end invalid pid",qc(t)),!1;if(r===Dh.default.pid)return Yt().warn("endProcess(): asked to end MY pid",qc(t)),!1;await gt(250),await Zx(t);{let i=t.kill();Yt().debug("endProcess("+r+")",{killResult:i,childGotSigterm:t.killed}),i||await Cc(r).catch(o=>{Yt().warn("endProcess(): kill("+r+",false) failed: "+o)})}if(et(()=>t.unref()),$n())return!0;if(await RT(r,e))return Yt().debug("endProcess(): exitted",qc(t)),!0;{hn.instance().onKill(r);let i=t.kill("SIGKILL");Yt().warn("endProcess("+r+") had to resort to SIGKILL",{killResult:i}),i||await Cc(r,!0).catch(o=>{Yt().warn("endProcess(): kill("+r+",true) failed: "+o)})}return RT(r,5e3)}function Rk(t,e){return t!=="renice"&&t!=="which"&&t!=="where"&&[t,...e].every(r=>!r.endsWith("web.js")&&!r.endsWith("db.js")&&!r.includes("sqlite3"))}function _T(t,e,r,i){let o=new Date,n=!1;t.on("exit",()=>n=!0);let s=Rk(e,r);return wa(async()=>{if(n)return;await Be(()=>k(t.pid),{timeoutMs:5*v});let a=t.pid;if(k(a))return s&&await zc(a),Uc({pid:a,cmd:e,maxAgeMs:i,ppid:Dh.default.pid},o);Yt().info("newProc(): not writing pidfile, child_process has no pid",{cmd:e,cp:qc(t)})},R?500:250),t}function pm(t,e,r,i){let o=Ph(i);return Yt().debug("spawn()",{command:t,args:e,maxAgeMs:r,opts:o}),_T(Eh.default.spawn(t,e,o),t,e,r)}function gn(t,e,r,i){let o=Ph(i);return _T(Eh.default.execFile(t,e,o),t,e,r)}async function Ke(t,e,r){return lr(()=>_k(t,e,r),{timeoutMs:r.timeout,maxRetries:w(r.maxRetries,3),onRetryWaitUntil:i=>nt(100*i),errorIsRetriable:i=>Yt().tap({msg:"stdoutResult.errorIsRetriable()",result:Sv(i,/EPERM/),meta:{error:i,cmd:t,args:e}})})}async function _k(t,e,r){let i=w(r.quiet,!1),o=w(r.ignoreStderr,!1),n=w(r.ignoreExitCode,!1),s=[];Yt().debug("stdoutResult(): execFile",{cmd:t,args:e});let a=await gn(t,e,r.timeout,jt(r,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(r.disconnect===!0)return a.disconnect(),{result:"",pid:a.pid};let m=I({cmd:t,args:e}),c=new Jt(m);setTimeout(()=>{c.pending&&Yt().warn("stdoutResult(): SLOW COMMAND",{cmd:t,args:e})},r.timeout/3).unref(),c.setTimeout(r.timeout);let h=(x,S)=>{if(Kt(S)||xe(r.isIgnorableError)&&r.isIgnorableError(S)){Yt().debug("stdoutResult(): ignorable error for "+x,{cmd:t,args:e,opts:r,error:S});return}a.pid!=null&&cm(a),i||Yt().warn("stdoutResult(): "+x,{cmd:t,args:e,opts:r,error:S}),c.pending&&c.reject(S)};try{a.on("error",x=>h("on(error)",x)),a.on("close",x=>{let S=Date.now()-c.start,F=x!==0?"warn":"debug",U=s.join("");i||Yt().log(F,"stdoutResult(): on(close)",{cmd:t,code:x,args:e,elapsedMs:S,result:Xw(U,160,160)}),!n&&x!==0?c.reject(new Error("non-zero exit code: "+I({code:x,cmd:t,args:e}))):c.resolve({result:U,code:na(x),pid:a.pid})}),$i(a.stdin),a.stdout?.on("data",x=>{x!=null&&s.push(x)}),a.stderr?.on("error",x=>h("stderr(error)",x)),a.stderr?.on("data",x=>o?Yt().warn("stdoutResult(): stderr(data): "+d(x)):h("stderr(data)",x))}catch(x){h("try/catch",x)}return await c.promise}function ue(t,e,r){return Ke(t,e,r).then(i=>i.result)}var Ss=class extends we{constructor(e,r,i=Q.service,o=!1){super(e,()=>this.t.end(),i,()=>this.t.ended,e==="sync-file"?H:v);this.name=e;this.t=r;r.on("childStart",n=>{this.logger.info("Started child process "+e+":"+n.pid),zc(n.pid).catch(s=>this.onError("renice failed for "+e,s)),o&&n.on("exit",()=>cm(n,5*v)),Uc({pid:n.pid,ppid:NT.default.pid,cmd:e,maxAgeMs:r.options.maxProcAgeMillis+E},new Date).catch(s=>this.onError("addPid failed for "+e,s))}),r.on("startError",n=>{this.lastStartError=n,this.onError("failed to start",n)}),r.on("taskError",(n,s)=>{this.lastTaskError=n,this.onError("failed to run "+p(s,a=>a.command),n)}),r.on("internalError",n=>{this.lastInternalError=n,this.onError("internal error",n)}),r.on("endError",n=>{this.logger.error("observeBatchCluster.endError()",n)})}onError(e,r){!this.t.ended&&!C()&&!Kt(r)?J(this.name+": "+e,r):this.logger.warn("onError() (ending or ignorable): "+e,r)}};var jc=24;function Ms(t,e=2){if(e<=0)return t;if(t!=null)return Du(t)?t:Array.isArray(t)?Ah(t):ri(t)?t:mc(t)?g(g({},t),{stack:Hd(t.stack)}):Au(t)?rc(t,(r,i)=>Ms(i,e-1)):t}function Ah(t,e=Ms){if(t!=null)return t.length<=jc?t.map(e):[...t.slice(0,jc).map(e),`\u2026 (${t.length} total items)`]}var Ut=Se("error","warn","info","debug","trace"),BT=mt(Ut.values.map((t,e)=>[t,e]));function fm(t){return BT[t]??BT.trace}var Nk=l(()=>Ut.values.filter(t=>t!==Ut.trace)),Bk=48,Fh=l(()=>mt(Nk().map(t=>[t,new ts(Bk)])));function CT(){St(Fh()).forEach(t=>t.clear())}function VT(t){Fh()[t.l]?.push(t)}function UT(){let t=[];for(let e of St(Fh()))t.push(...e.toA());return ie(t,e=>e.ts)}function Wa(t,e){return t>=e?"error":t>=e/2?"warn":t>=e/4?"info":"debug"}var Ck=/^[a-z]*/i,dm=class{constructor(e,r){this.context=e;this.loggers=r;this.error=(e,r)=>{this.log("error",e,r)};this.warn=(e,r)=>{this.log("warn",e,r)};this.info=(e,r)=>{this.log("info",e,r)};this.debug=(e,r)=>{this.log("debug",e,r)};this.trace=(e,r)=>{this.log("trace",e,r)};this.filterContext=Z(Ck.exec(d(this.context)),i=>i[0],()=>this.context)}addContext(e){return new dm(this.context+e,this.loggers)}throw(e,r){let i=Ji(e)||r?.fatal,n=!(r?.retriable===!1)&&ls(e),s=Kt(e)||r?.ignorable;r=r==null?void 0:Ms(jt(r,"fatal","retriable","ignorable"));let a=new ae({cause:Sa(e),message:z([this.context,r==null?void 0:I(r)]).join(" "),fatal:i,retriable:n,ignorable:s});throw this.log(s===!0?"warn":"error",yr(e),r),a}tap(e){return this.log(w(e.level,"debug"),e.msg,g({result:e.result},e.meta)),e.result}log(e,r,i){if(i=Ms(i),yn().enabled(e,this.context))for(let o of this.loggers())o.log(e,this.context,r,i);else e!=="trace"&&VT({ts:Date.now(),l:e,ctx:this.context,msg:r,meta:i})}async flush(){for(let e of this.loggers())await e.flush()}async end(){for(let e of this.loggers())await e.end()}};var Vk=10*E,zT="{ready}",WT=" | ConvertTo-Json -Compress";function vs(t){let e=t.replace(/['`"ââ#]/g,r=>"`"+r).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v");return'"'+e+'"'}function Uk(){return[`function prompt {"${zT}"}`,...fr(u.powerShellCulture.valueOrDefault,t=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${t}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${t}'`],[])].join(";")}B(()=>j(()=>De.instance.prior()?.clearMockResults()));var Lh=class{constructor(){this.name="PowerShell";this.logger=f("PowerShell");this.mockResults=new Map;this.bco=new Ss("PowerShell",new Hc.BatchCluster({processFactory:()=>gn("powershell",u.powerShellArgs.values,Vk),logger:()=>f("PowerShell"),versionCommand:Uk(),pass:zT,fail:"Error",exitCommand:"exit",maxProcs:bt()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:H,cleanupChildProcs:!1}),Q.postdb),this.pwsh=this.bco.t}get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return b(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,r){this.pushMockResult(Vt(e,WT),r)}pushMockResult(e,r){this.mockResults.set(e,r)}clearMockResults(){this.mockResults.clear()}async execute(e,r){if(this.pwsh.ended||C()){this.logger.warn("execute() failed (ended)",{cmd:e});return}if(ne&&this.mockResults.has(e)){let i=this.mockResults.get(e);return r(i.stdout,i.stderr,i.passed)}try{this.logger.debug("execute()",{cmd:e});let i=await mi(()=>this.pwsh.enqueueTask(new Hc.Task(e,(o,n,s)=>r(p(o,a=>He(a,e)),n,s))));return this.logger.log(Wa(i.elapsedMs,7*v),"execute()",{cmd:e,elapsedMs:i.elapsedMs}),i.result}catch(i){this.logger.warn("execute() failed: "+i,{cmd:e});return}}async executeJson(e){let r=await this.execute(Vt(e,WT),(i,o,n)=>({stdout:i,stderr:o,passed:n}));if(r==null){this.logger.warn("executeJson(): null result",{cmd:e});return}if(P(r.stdout)||T(r.stderr)||!r.passed){this.logger.warn("executeJson(): failed result",g({cmd:e},r));return}try{return JSON.parse(r.stdout)}catch(i){let o=r.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:sr(r.stdout),after:sr(o)}),JSON.parse(o)}}async executeJsonToA(e){return b(this.executeJson(e),r=>Array.isArray(r)?r:[r])}},De=Lh;De.instance=l(()=>{if(!R)throw new Error("PowerShell isn't available on this platform");return new Lh});async function zk(){return R?De.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}var jT=l(async()=>{if(R){let t=await zk();if(T(t))return t}return Gc()}),Gc=l(()=>(0,qT.resolve)(Pi(),"Pictures"));var HT=["7artisans","Bower","Canon","Carl Zeiss","Cosina","Fuji","Fujifilm","Goerz","Hasselblad","Hirox","Hoya","Konica","Leica","Leidolf","Lensbaby","Meike","Meopta","Minolta","Neewer","Nikon","Olympus","Opteka","Panasonic","Pentacon","Pentax","Ricoh","Rodenstock","Rokinon","Ross","Samsung","Samyang","Seiko","Sigma","Silor","Soligor","Sony","Sunpak","Tamron","Tiffen","Tokina","Topcon","Venus","Voigtl\xE4nder","Wray","Yongnuo","Zhong Yi","Zuiko"];var hm=["EXIF","EXV","MIE","XMP"];var GT=M(require("path")),ko=M(require("process"));function Ih(t){return d(t).replace(/([A-Z])([a-z])/g,(e,r,i)=>"_"+r.toLowerCase()+i).replace(/[A-Z]+|[0-9]+/g,e=>"_"+e).replace(/^_/,"")}function Wk(t){return"PS_"+Ih(t).toUpperCase()}var S7=W(g({},ko.env)).map(t=>hr?Object.freeze(t):t).get(),y=Se("Paths","Logging","Networking","Processes","Tools","Updates","Desktops","Volumes","Db","HealthChecks","Filters","Previews","Reporting","Deduping","Sidecars","Sync","Tagging","Web","Subscriptions"),gm=Object.freeze([y.Db,y.HealthChecks,y.Filters,y.Previews,y.Reporting,y.Deduping,y.Sidecars,y.Sync,y.Tagging,y.Web,y.Subscriptions]),kh=Object.freeze(y.values.filter(t=>!gm.includes(t))),Oo=t=>T(t)&&t!=="undefined"?d(t).trim():void 0,Gr=class{constructor(e){this.opts=e;this._persist=!1;this.listeners=[]}hasValue(){return this._value!=null}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){let r=w(e,ko.env);for(let i of[this.key,...D(this.opts.envAliases)]){let o=p(r[i],n=>this.opts.fromEnv(n));if(o!=null)return o}}importFromEnv(e=ko.env){if(!this._persist)return p(this.readFromEnv(e),r=>this.setValue(r))}importFromFile(e){if(!(this.hasValue()&&!this._persist))return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){vt(this.listeners,r=>r===e)}onChange(){let e=this.value;this.listeners.forEach(r=>r(e))}get name(){return this._name}_setName(e){if(this._name!=null)throw new Error("cannot set name twice");this._name=e,this._key=Wk(e),this.importFromEnv()}get persist(){return this._persist}get key(){return this._key}get category(){return this.opts.category}get categoryType(){return gm.includes(this.category)?"library":"system"}get transient(){return this.opts.transient===!0}get advanced(){return Z(this.opts.advanced,e=>e(),()=>!0)}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}maybeSetValue(e){e!=null&&(this.value=e)}set valueAndEnv(e){this.value=e,this.addToEnv(ko.env,e)}get envValueOrDefault(){return this.opts.toEnv(this.valueOrDefault)}set tmpValue(e){this._persist=!1,this.addToEnv(ko.env,e),this.setValue(e)}set tmpValueIfUnset(e){this.isUnset()&&(this.tmpValue=e)}setValue(e){let r=this._value,i=this.opts.toEnv(e),o=this.opts.fromEnv(i);return this._value=o,Dr(r,this._value)||this.onChange(),this._value}get defaultValue(){return Cr(this.opts.defaultValue)}get exampleValue(){return W(this.opts.exampleValue).flatMap(e=>e()).filter(T).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return this.value!=null?this.value:this.defaultValue}maybeAddToEnv(e,r){let i=w(e,ko.env);return this.hasValue()&&(i[this.key]=Oo(this.opts.toEnv(w(r,this.valueOrDefault)))),i}addToEnv(e,r){let i=w(e,ko.env);return i[this.key]=Oo(this.opts.toEnv(w(r,this.valueOrDefault))),i}deleteFromEnv(e){let r=w(e,ko.env);return delete r[this.key],p(this.opts.envAliases,i=>i.forEach(o=>{delete r[o]})),r}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),f("Settings."+this.name).info(".unset()"),this}addToJSON(){return{}}toJSON(){return{key:this.key,value:this.value,defaultValue:this.opts.defaultValue}}},bn=class extends Gr{constructor(e){super(g({toEnv:Oo,fromEnv:Oo,defaultValue:void 0},e))}hasValue(){return T(this.value)}};function KT(t){return t==null?void 0:t.trim()}var st=class extends Gr{constructor(e){super(g({toEnv:KT,fromEnv:KT},e))}hasValue(){return T(this.value)}};function Oh(t,e){let r=d(t).toLowerCase();return e.find(i=>i.toLowerCase()===r)}var Ro=class extends Gr{constructor(e){super(g({toEnv:i=>Oh(i,e.validValues),fromEnv:i=>Oh(i,e.validValues)},e));if(this.validValues=e.validValues,this.defaultValue!=null&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}};function qk(t){return K(d(t).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return pe(JSON.parse(e)).map(d)}catch{}for(let r of["\xA6",GT.delimiter])if(e.includes(r))return e.split(r);return[e]})}function JT(t){return sa(t)?void 0:Me(qk(t),ym)}function jk(t){return Me(ym(t),I)}function ym(t){return G(ma(t))}var Ie=class extends Gr{constructor(e){super(g({defaultValue:[],fromEnv:JT,toEnv:jk},e))}push(...e){this.value=ym([...this.valueOrDefault,...e])}get values(){return ym(this.valueOrDefault)}set values(e){this.value=ym(e)}removeValueFromEnv(e){p(this.value,r=>this.tmpValue=r.filter(i=>i!==e))}};function Hk(t,e){return QT(JT(t),e)}function QT(t,e){if(t==null)return;let r=[];for(let i of t){let o=Oh(i,e);o!=null&&r.push(o)}return r}var Rh=class extends Gr{constructor(e){super(g({fromEnv:r=>Hk(r,e.validValues),toEnv:r=>p(r,i=>I(G(i)))},e));this.validValues=e.validValues}asValidValues(e){return QT(e,this.validValues)}addToJSON(){return{validValues:this.validValues}}},Ve=class extends Gr{constructor(e){super(g(g({},e),{toEnv:Oo,fromEnv:V}))}};var Kc=class extends Gr{constructor(e){super(g(g({},e),{toEnv:Oo,fromEnv:ni}))}},zt=class extends Gr{constructor(e){super(g(g({},e),{toEnv:Oo,fromEnv:r=>W(r).flatMap(parseInt).map(i=>re(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},Ps=class extends Gr{constructor(e){super(g(g({},e),{toEnv:Oo,fromEnv:r=>W(r).flatMap(parseFloat).map(i=>re(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},_=class extends Gr{constructor(e){super(g(g({},e),{toEnv:Oo,fromEnv:vw}))}};var ja=require("process"),YT=Object.freeze(["/usr/local/sbin","/usr/local/bin","/opt/local/sbin","/opt/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),Jc=l(()=>hr),wr=()=>!Jc(),Gk=Object.freeze(R?[...fr(ja.env.SYSTEMROOT,t=>[t,(0,qa.join)(ja.env.SYSTEMROOT,"System32"),(0,qa.join)(ja.env.SYSTEMROOT,"System32","webm")],()=>[]),"C:\\cygwin64\\bin"]:YT),u={copyAssetsToLibrary:new _({category:y.Paths,description:`Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page's "May PhotoStructure organize your photos and videos?" section. Read more about this setting here: <https://photostructure.com/getting-started/automatic-library-organization/>.`,defaultValue:!0,advanced:()=>!1}),libraryPath:new bn({envAliases:["PS_LIBRARY","PS_LIBRARY_DIR"],category:y.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>wr()?"/home/test/Pictures":Ne()?"/ps/library":Gc(),defaultValue:()=>Ne()&&!wr()?"/ps/library":void 0,advanced:()=>!1}),previewsDir:new st({category:y.Paths,description:`This is the directory that PhotoStructure uses to store preview images. This defaults to the ".photostructure/previews" directory inside your PhotoStructure library. Absolute paths here are supported, but if you keep your library and previews directory separated, take care when you open your library on different computers, as this setting needs to be adjusted for those computers as well.
NOTE: "originalDirs" is recommended instead of this setting; If you get "previewsDir" wrong, your library won't work. If you get "originalsDir" wrong, you just break full-screen zoom and non-transcoded videos.`,defaultValue:()=>".photostructure/previews"}),originalsDir:new st({category:y.Paths,description:`This is the directory that PhotoStructure uses to store original images when "copyAssetsToLibrary" is enabled. Absolute paths are supported. Relative paths are evaluated from your libraryPath. This setting defaults to ".", which is the same as your PhotoStructure library directory.
If you open your PhotoStructure library on a different computer, and that computer doesn't have access to your originals volume, full-screen zoom won't work, and non-transcoded videos will not play.
This system setting needs to be set appropriately on different computers (it won't be set automatically!)
If you have a large library and want to use an SSD, we recommend you set your libraryPath to your SSD, and use this setting to store your originals on a larger volume, rather than using the "previewsDir" setting.`,defaultValue:()=>"."}),forceOpen:new _({category:y.Paths,description:"DANGEROUS: if set, all previously-existing library locks will be removed. This should only be necessary if the prior PhotoStructure process was not shut down gracefully.",defaultValue:!1,transient:!0}),scanAllDrives:new _({category:y.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new _({category:y.Paths,description:"Deprecated, and will be removed in the next version. If set, PhotoStructure will automatically add your pictures directory to your `scanPaths` setting.",defaultValue:!1,advanced:()=>!1}),scanPaths:new Ie({category:y.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1,exampleValue:()=>wr()?["/path/one","/path/two"]:[Gc()]}),cacheDir:new st({category:y.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free. Note that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory.",exampleValue:()=>wr()?"/tmp/ps_cache_dir":Yd(),defaultValue:()=>Yd()}),neverIgnored:new Ie({category:y.Paths,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),pidfile:new bn({envAliases:["PIDFILE"],category:y.Paths,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),scanLibraryFirst:new _({category:y.Paths,description:"Should PhotoStructure scan your library before all other paths are synchronized?",defaultValue:!1}),scanLibraryLast:new _({category:y.Paths,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!0}),logLevel:new st({envAliases:["PS_LOG","LOG"],category:y.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc').",defaultValue:()=>Jc()?"error":"info"}),logDir:new st({category:y.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>yv(),exampleValue:()=>wr()?"/var/log/photostructure":void 0}),logCompression:new _({category:y.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>Jc()}),logElapsedMs:new _({category:y.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new _({category:y.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new bn({category:y.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new _({envAliases:["LOG_STDOUT","PS_STDOUT"],category:y.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new _({category:y.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new _({category:y.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR is set, this defaults to false. See <https://no-color.org/>.",defaultValue:()=>P(ja.env.NO_COLOR)}),logSql:new _({category:y.Logging,description:"Log SQL queries to the default log level. *This is really chatty* and impacts performance. Normally these log messages are completely disabled.",defaultValue:()=>!1}),localhost:new st({category:y.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). See <https://letsencrypt.org/docs/certificates-for-localhost/> and <https://photostructure.com/faq/troubleshooting/#windows-firewall-issues>.',defaultValue:()=>"127.0.0.1"}),httpPort:new Ve({category:y.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),trustProxy:new st({category:y.Networking,description:`Support for PhotoStructure instances running behind a reverse proxy. See <http://expressjs.com/en/guide/behind-proxies.html>. This setting should either be "false" (don't trust any proxies), "loopback", (only trust localhost), a single subnet (like "127.0.0.0/8"), or a comma-delimited set of subnets.`,defaultValue:"false"}),exposeNetworkWithoutAuth:new _({category:y.Networking,description:`Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.
**Don't enable this unless you know what you are doing**.`,defaultValue:()=>Ne()&&!wr()}),rpcPort:new Ve({category:y.Networking,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),exiftoolProcsPerChild:new zt({category:y.Processes,description:"Each PhotoStructure process spins up an ExifTool when needed. Note that the `web`, `sync`, and `sync-file` services all use exiftool, so the total number of exiftool processes can be many times larger than this value.",min:1,max:8,defaultValue:2}),sensitiveEnvRegExp:new st({category:y.Processes,description:'PhotoStructure spawns a number of processes (including "exiftool" and "ffmpeg"), and passes through environment variables, mostly to ensure locale and TZ settings are correct. To prevent environment values that contain sensitive information, like API access tokens, from either being logged, or being accessed by external tools, all environment variables whose key matches this setting will be removed. This regex is applied case-insensitively.',defaultValue:"key|secret|pass|_user|aws_"}),bounceMinutes:new Ve({category:y.Processes,description:"PhotoStructure will bounce the web and sync processes periodically. Set to 0 to disable.",defaultValue:60*(wr()?5:de?2:5)}),setupTimeoutMs:new Ve({category:y.Processes,description:"To prevent unhealthy services running as zombies, they self-terminate if the setup processes are not complete within this amount of time. Note that only the environment variable value is used for this setting.",defaultValue:35*v}),probationMs:new Ve({category:y.Processes,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*E}),minTimeBetweenServiceRestartsMs:new Ve({category:y.Processes,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*v}),fatalErrorRatePerMinute:new Ve({category:y.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),minDiskFreeGb:new Ve({category:y.Processes,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new zt({category:y.Processes,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new Ro({category:y.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>mm.BelowNormal,validValues:mm.values}),maxMemoryMb:new zt({category:y.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.",defaultValue:500,min:256,max:8e3}),maxRssMemoryMb:new zt({category:y.Processes,description:"PhotoStructure will restart services if their' resident set size consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:250,max:8e3}),maxTasksPerProcess:new zt({category:y.Processes,description:"PhotoStructure will recycle sync-file processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>wr()?10:200,min:1,max:5e3}),pollIntervalMs:new Ve({category:y.Processes,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>Jc()?E:5*v}),inspect:new _({category:y.Processes,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,transient:!0,advanced:()=>!0}),ignoreUnhealthyVolumes:new _({category:y.Volumes,description:"When true, PhotoStructure ignores volumes that are not healthy (due to needing filesystem checks, or remote filesystems that are not available).",defaultValue:!0}),validateMountpoints:new _({category:y.Volumes,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist.",defaultValue:!0}),readVolumeUuidFiles:new _({category:y.Volumes,description:`When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume UUID, which can help with cross-host library portability. Set this to false if you don't want PhotoStructure to read these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),writeVolumeUuidFiles:new _({category:y.Volumes,description:`When true, PhotoStructure (tries to) write ".uuid" files into the root directory of volumes, which enables cross-host library portability. Set this to false if you don't want PhotoStructure to try to write these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),forceLocalDbReplica:new _({category:y.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:()=>Ne()&&!wr()}),dbBackupsCount:new Ve({category:y.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",defaultValue:20}),maxBusyDbMs:new Ve({category:y.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 2 minutes, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>2*E}),dbTimeoutMs:new Ve({category:y.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",defaultValue:()=>v}),dbBackupIntervalMinutes:new Ps({category:y.Db,description:"How many minutes should elapse between backing of your library database? Note that PhotoStructure vacuums and optimizes the database before a backup is taken. You want this period to be frequent enough such that data loss isn't too painful. Note that backups can cause the webserver to be momentarily unresponsive. Default is every hour.",min:wr()?.5:1,max:60*12,defaultValue:()=>wr()?.5:30}),dbCacheSizeMb:new Ve({category:y.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:192}),dbBatchSelectSize:new zt({category:y.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",defaultValue:128,min:1,max:900}),dbBatchUpsertSize:new zt({category:y.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",defaultValue:16,min:1,max:500}),healthCheckExiftool:new _({category:y.HealthChecks,description:"When true, PhotoStructure verifies ExifTool is available and a valid version.",defaultValue:!0}),healthCheckLibraryIsWritable:new _({category:y.HealthChecks,description:"When true, PhotoStructure verifies the library directory exists, and is writable.",defaultValue:!0}),healthCheckVolumes:new _({category:y.HealthChecks,description:"When true, PhotoStructure verifies volumes as part of periodic health checks.",defaultValue:!0}),healthCheckFreeSpace:new _({category:y.HealthChecks,description:"When true, PhotoStructure verifies that the library and cache volumes have sufficient free space.",defaultValue:!0}),healthCheckDb:new _({category:y.HealthChecks,description:"When true, PhotoStructure verifies that the library database can be read from and written to.",defaultValue:!0}),enableSIMD:new _({category:y.Tools,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to false on macOS due to instability on that platform.",defaultValue:()=>!(wr()||de)}),enableVipsCache:new _({category:y.Tools,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations? This defaults to false to reduce memory consumption.",defaultValue:()=>!1}),showFileInFolderUsesThunar:new _({category:y.Tools,description:`If we're on Linux, should we use Thunar (via dbus) to "show file in folder"?`,defaultValue:!1}),showFileInFolderUsesFileUri:new _({category:y.Tools,description:"Does the showFileInFolderCommand expect a file: URI to the file? If this is false, the native path will be appended instead.",exampleValue:()=>!0,defaultValue:()=>ut}),showFileInFolderCommand:new Ie({category:y.Tools,description:`If set, the first argument will be used as a command (or path to command), and the subsequent arguments (if present) will be used as arguments. The native path to the file or the file: URI will be appended, based on the value given to the "showFileInFolderUsesFileUri" setting. If this is set to an empty array, the default tool for your platform will be used instead: "nautilus -s" on linux, "open -R" on mac, and "explorer /select" on Windows.
This is provided to support Linux desktops that don't use Gnome.`,defaultValue:[]}),dcraw_emuPath:new st({category:y.Tools,description:'This should be the absolute, native path to the "dcraw_emu" binary on this system. If this is set to "dcraw_emu", PhotoStructure will search your $PATH. See <https://www.libraw.org/docs/Samples-LibRaw.html>.',defaultValue:"dcraw_emu"}),ffmpegPath:new st({category:y.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc. See <https://photostructure.com/getting-started/video-support/>.',defaultValue:"ffmpeg"}),ffmpegTranscodeArgs:new Ie({category:y.Tools,description:`The following are the default arguments added to transcode requests made to ffmpeg (when ffmpeg is available). The following arguments will proceed the command: "-loglevel error -threads T -i INPUT_FILE_PATH" (where T is replaced by ~half the available CPU threads, and INPUT_FILE_PATH is the full native pathname to the source video). The following arguments will follow the arguments in this setting: "-b:v VIDEO_BITRATE_KBPS OUTPUT_FILE_PATH".
CAUTION: this is an advanced setting. Editing this may cause videos that require transcoding to not be imported, or not be viewable on all browsers and platforms. See <https://forum.photostructure.com/t/hardware-accelerated-encoding-transcoding/166> for more details.`,defaultValue:["-c:a","aac","-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high"]}),heifConvertPath:new st({category:y.Tools,description:'This should be the absolute, native path to the "heif-convert" binary on this system. If this is set to "heif-convert", PhotoStructure will search your $PATH. See <https://photostructure.com/getting-started/heif-support/>.',defaultValue:"heif-convert"}),powerShellArgs:new Ie({category:y.Tools,description:`The following are the default arguments added to spin up PowerShell on Windows devices.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1> for all arguments that PowerShell.exe accepts.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-5.1> for a description of Bypass.
See <https://forum.photostructure.com/t/eliminate-powershell-profile-and-execution-policy-related-errors/184> for more details about why this needs to be configurable.
(Versions prior to v1.0.0 only specified "-NoLogo").`,defaultValue:["-NoLogo","-NoProfile","-ExecutionPolicy","Bypass"]}),powerShellCulture:new st({category:y.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),toolPaths:new Ie({category:y.Tools,description:`These paths are appended to the PATH to ensure PhotoStructure can find and run external tools like ffmpeg. Use your operating system's separator to separate paths (":" for mac and linux, ";" for windows).`,defaultValue:()=>Po("SETTINGS_IO_TEST")?YT:Gk}),vlcPath:new st({category:y.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),openAtLogin:new _({category:y.Desktops,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!si}),updateChannel:new Ro({category:y.Desktops,description:'TL:DR; keep this on "latest." This setting only applies to PhotoStructure for Desktops, and controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds have not been thoroughly tested. Please only consider changing this if customer support asks you to, and that you have recent backups of your system.',defaultValue:()=>wv(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new _({category:y.Desktops,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new Ve({category:y.Desktops,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:60*24}),autoHideMenuBar:new _({category:y.Desktops,description:"If true, PhotoStructure for Desktops on Windows and Linux will auto hide the menu bar unless the Alt key is pressed.",defaultValue:!1}),email:new bn({category:y.Reporting,description:"If set, this email will be used for license subscriptions and added to error reports, so we can contact you to help debug the issue. It is not required. Setting a value here does not subscribe you to any marketing emails.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new _({category:y.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new Ve({category:y.Reporting,description:`Set this to zero to remove all bugs in PhotoStructure.
HUR HUR #DADJOKE
If your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.`,defaultValue:3}),minStreamCorrPct:new zt({category:y.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),hiddenHomeTags:new Ie({category:y.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", and "Keyword").',defaultValue:()=>["Type"]}),placeholderThumbs:new _({category:y.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),cspReportOnly:new _({category:y.Web,description:"Only report CSP violations. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>.",defaultValue:()=>!1}),cspDirective:new bn({category:y.Web,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src>.",exampleValue:()=>"https://myphotos.example.com"}),readdirCacheSeconds:new Ve({category:y.Sync,description:"readdir() can take a long time over slow network shares and when directories are very large. This setting controls how long to cache readdir results that are slow (which take >= .5 seconds). Set to 0 to disable readdir() caching.",defaultValue:300}),verifyFileCopies:new _({category:y.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new st({category:y.Sync,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:`If you chose to copy assets into your library, they will be copied into <originals directory>/<result of this pattern>/<original imagename>.
- See the originalsDir system setting for what your <originals directory> is (it defaults to your library root directory).
- Please encode this path with forward-slashes, even if you're on Windows.
- If you want to add a static path, escape the pathname with single quotes (like "'photos'/y/MM/dd").
- This will always be interpreted as a relative path from your PhotoStructure library.
- See <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.`,defaultValue:"y/y-MM-dd"}),transcodeVideos:new _({category:y.Sync,description:"Should videos that are not in a browser-supported format be transcoded during import? Note that this is a plus-only feature. FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),transcodeBitrateQVGA:new Ve({category:y.Sync,description:"What max bitrate should PhotoStructure encode QVGA (320 \xD7 240) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:800}),transcodeBitrateUHD:new Ve({category:y.Sync,description:"What max bitrate should PhotoStructure encode UHD (3840\u2009\xD7\u20092160) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:18e3}),doNotTranscodeMimetypes:new Ie({category:y.Sync,description:`Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "['video/quicktime','video/mp4']").`,defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),doNotTranscodeVideoCodecs:new Ie({category:y.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following video codecs. The video codec may be stored in the "VideoCodec", "CompressorID", or "CompressorName" tags.',defaultValue:()=>["avc1"]}),doNotTranscodeAudioCodecs:new Ie({category:y.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following audio codecs. The audio codec is stored in the "AudioCodec" tag.',defaultValue:()=>["mp4a","sowt"]}),statTimeoutSeconds:new zt({category:y.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new _({category:y.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncIntervalHours:new Ve({category:y.Sync,description:`This value controls both how often the sync process discovers new or changed files for any given volume.
Note that this value is the duration between the last completion time and when the next sync should be scheduled.
WARNING: Setting this value to a small value will mean PhotoStructure is constantly scanning your disks, which will add wear and tear and possibly reduce the lifespan of your storage media.
Note that setting this to a zero or negative value will disable automatic scheduling of the sync process.`,defaultValue:24}),rebuild:new _({category:y.Sync,description:"When set, all files in your library will be re-imported (caution: slow!).",defaultValue:!1,transient:!0}),forceSync:new _({category:y.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),skipModelUpdates:new _({category:y.Sync,description:"When set, skip any pending library database updates.",defaultValue:!1,transient:!0}),exitWhenDone:new _({category:y.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),matchSidecarsCaseInsensitively:new _({category:y.Sidecars,description:`If set to true, PhotoStructure will look for sidecar files that match file basenames (with or without the file extension), regardless of case (for example: "IMAGE.XMP" will be a sidecar for "image.jpg").
If set to false, sidecars must match case (so only "image.jpg.xmp" and "image.xmp" will match for "image.jpg").
This defaults to false just to be conservative, but true should be fine in normal cases.`,defaultValue:!1}),defaultSidecarType:new Ro({category:y.Sidecars,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:hm}),writeMetadataToSidecarsIfImage:new _({category:y.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to images into sidecars. If set to false, PhotoStructure will overwrite original images with metadata changes.",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new _({category:y.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to videos into sidecars. If set to false, PhotoStructure will overwrite original videos with metadata changes. This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new _({category:y.Sync,description:'Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents. If this is set to false, the original file will be retained in the same directory. "image.jpg" will be stored as "image_original.jpg".',defaultValue:!1}),fuzzyDateParsing:new _({category:y.Sync,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),fuzzyYearParsing:new _({category:y.Sync,description:`When enabled, PhotoStructure will use directories starting with a number that looks year-like (four digits, 1826-the present) to infer the captured-at time, if all other date parsers have failed. Note that setting this to true "forces" the "fuzzyDateParsing" setting to be true.
To elaborate: PhotoStructure first looks for metadata with a date, then looks for an ISO-compliant YMD timestamp in the filename or path, and then, if "fuzzyDateParsing" or this setting is enabled, a YMD or YM datestamp, and then finally, if this setting is enabled, it looks for a directory that begins with a number that is between 1826-2020.`,defaultValue:!1}),minValidYear:new Ve({category:y.Sync,description:"If PhotoStructure encounters a year that is less than this value, it will consider it invalid and look elsewhere for dates. The default value, 1826, is the first year a photograph was captured, as per <https://en.wikipedia.org/wiki/History_of_photography>. If you have paintings or other imagery from before this time, you'll want to make this value less than the earliest image in your library.",defaultValue:1826}),useStatToInferDates:new _({category:y.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in the file "birthtime" (on Windows), or the lesser value of "mtime" and "ctime" (on macOS and Linux). Note that these values are not very reliable, as file transfers and backups frequently don't retain these values correctly.`,defaultValue:!0}),usePathsToInferDates:new _({category:y.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.`,defaultValue:!0}),useLibraryPathsToInferDates:new _({category:y.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths *for files that are in your PhotoStructure library. This defaults to false, as prior versions of PhotoStructure may have placed files into incorrect datestamped directories.`,defaultValue:!1}),maxDuplicatePathElements:new Ve({category:y.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),skipAssetFileUpdates:new _({category:y.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),skipAssetUpdates:new _({category:y.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new _({category:y.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>wr()?!0:(0,$T.cpus)().length>=8}),excludeNoMediaAssetsOnRebuild:new _({category:y.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),strictDeduping:new _({category:y.Deduping,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true.',defaultValue:!1}),useImageHashes:new _({category:y.Deduping,description:"Building image hashes slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing. If you set this from false to true, and you'd previously imported new assets, you may want to rebuild your library to re-aggregate your assets.",defaultValue:!0}),includeSharpDominantColor:new _({category:y.Deduping,description:"PhotoStructure's image library, sharp, computes the dominant color using a 4096-bin 3D histogram. This doubles image hashing time, but the most-dominant color might be more accurate.",defaultValue:!1}),minExposureSettingsCoeffPct:new zt({category:y.Deduping,description:"This is the minimum similarity coefficient between exposure setting values two images must be to be considered equivalent. Many cameras actually report different exposure setting values between JPG and RAW: values within 90% of each other should avoid false-positives.",defaultValue:()=>90,max:100,min:0}),minImageCoeffPct:new zt({category:y.Deduping,description:"This is the minimum image hash similarity coefficient for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image similarity. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minImageGreyscaleCoeffPct:new zt({category:y.Deduping,description:"This is the minimum image hash similarity coefficient for greyscale images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>93,max:100,min:0}),minColorCoeffPct:new zt({category:y.Deduping,description:"This is the minimum similarity coefficient found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 50% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minMeanCoeffPct:new zt({category:y.Deduping,description:"If the average of image and color similarity coefficients exceeds this score, the image will be considered a match.",defaultValue:()=>65,max:100,min:0}),fuzzyDateImageCoeffWeight:new Ps({category:y.Deduping,description:'Image similar, by default, is somewhat lax to ensure JPG+RAW and downsampled or edited images are matched together. This is OK when dates must match, and the date is exactly correct. When dates are manually set to something "fuzzy", with perhaps only the year, month, and day, or is inferred by siblings, we need to be more discriminate with image contents to prevent incorrectly grouping photos from that day into a single asset. This value is multiplied with minImageCorrPct and minColorCorrPct to make them more stringent. For example, by default, the minImageCorrPct is 80%, and when the dates are manually set, and this weight is 1.2, the minImageCorrPct for manually-set-date files will be 90%.',defaultValue:()=>1.4,max:2,min:.5}),greyscaleColorThreshold:new zt({category:y.Deduping,description:"When looking at each pixel in L*a*b* space, a greyscale image is expected to have a* and b* values around 0. If the absolute value of every a* and b* value is under this setting's value, the image will be considered to be greyscale. A value of 0 will force all images to be considered non-greyscale.",defaultValue:5,max:128,min:0}),modeCorrCieDiffWeight:new Ps({category:y.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to the CIE94 color delta e. Smaller values apply a larger discount to color deltas.",defaultValue:()=>.6,max:2,min:0}),modeCorrIndexDiffWeight:new Ps({category:y.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to difference between the color indexes. Smaller values apply a larger discount to index differences.",defaultValue:()=>.6,max:2,min:0}),gpsErrorMeters:new Ve({category:y.Deduping,description:`What's the maximum number of meters between GPS fixpoints that should be considered equivalent locations? Note that JPG+RAW pairs from smartphones frequently have different GPS locations due to one being recorded from a rough WiFi fix, and another from aGPS.
GPS position error is ~10-100m. Cellular position error is ~500-750m.`,defaultValue:500}),lensMakes:new Ie({category:y.Deduping,description:"Used to match lensId when Google Takeout has stripped metadata.",defaultValue:()=>HT}),variantSortCriteria:new Ie({category:y.Previews,description:'How should PhotoStructure pick the "best" asset file variant for a given asset? You may reorder the default fields. Only "resolution", "fileSize", "mtime", "schemeIdx", "isCover", "count", and "isBrowserSupported" are understood: other field names will be ignored. Details about these fields are here: <https://photostructure.com/faq/what-do-you-mean-by-dedupe/#how-does-photostructure-pick-which-file-to-show>.',defaultValue:["resolution","mtime","schemeIdx","isCover","count","isBrowserSupported","fileSize"]}),variantSortCriteriaPower:new Ps({category:y.Deduping,description:'Larger variant sort criteria, "resolution" and "fileSize", are scaled to ignore smaller (irrelevant) differences. Scalars are raised to this power to reduce them, so a value of 1 means the criterion is unchanged from the "raw" value.',defaultValue:()=>.15,max:1,min:1e-6}),jpegQuality:new zt({category:y.Previews,description:"JPEG output quality for previews. Smaller values produce smaller images with lower quality. The default value of 85 strikes a balance that has almost no noticeable compression artifacts, yet still compresses images reasonably well. Values less than ~50-70 can produce noticeable artifacts (depending on the image).",defaultValue:()=>85,max:100,min:10}),dcrawEmuArgs:new Ie({category:y.Previews,description:`What options do you want to pass to dcraw_emu? Note that "-T -o 1 -j -Z -" will always be added (as we need TIFF, sRGB, raw pixels send to stdout). The "-h" arg will be added if the preview image needed is less than half the resolution of the original.
Run "dcraw_emu" with no arguments to get usage help.
"-q 1" sets interpolation quality to "0".
"-H 2" turns on highlight blending.
"-w" uses the camera-set white balance.
Note: changing these values can dramatically (> 10x!) increase the time it takes to render RAW images.`,defaultValue:["-q","0","-w"]}),iccProfileMappings:new Ie({category:y.Previews,description:`Maps an original image profile to a filename stored in the "icc" directory. See that directory's _info.md for more information about this settings.`,defaultValue:["Display P3:DisplayP3Compat-v2-magic.icc","Adobe RGB:AdobeCompat-v2.icc"]}),squareThumbStrategy:new Ro({category:y.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>.',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new Kc({category:y.Previews,description:`When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.
Note that if a video is shorter than this value, the frame will be captured from the middle of the video.`,defaultValue:1.5}),sharpen:new _({category:y.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new _({category:y.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new Rh({category:y.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:Cu(kd,["uhd8k","uhd5k","qqvga"]),validValues:kd}),embeddedPreviews:new Ie({category:y.Previews,description:`For larger source images that are greater than 15MP, what embedded image preview tags should be used when present? Using these embedded images speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["PreviewImage","PreviewTIFF","JpgFromRaw"]}),embeddedThumbnails:new Ie({category:y.Previews,description:`Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["ThumbnailImage","ThumbnailTIFF"]}),skipPreviews:new _({category:y.Previews,description:"No previews will be built. The UI will be broken if this is set.",defaultValue:!1}),requireMakeModel:new _({category:y.Filters,description:"Normally PhotoStructure requires images to have EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),minImageDimension:new Ve({category:y.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new Ve({category:y.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minVideoDurationSec:new Kc({category:y.Filters,description:"What's the minimum number of seconds for a video to be imported?",defaultValue:2}),minAssetFileSizeBytes:new Ve({envAliases:["PS_MIN_ASSET_SIZE_BYTES","PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:y.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*Rd}),maxAssetFileSizeBytes:new Ve({envAliases:["PS_MAX_ASSET_SIZE_BYTES","PS_MAX_ASSET_SIZE","PS_MAX_FILE_SIZE_BYTES"],category:y.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library).",defaultValue:.5*Eo}),validateJpegImages:new _({category:y.Filters,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateRawImages:new _({category:y.Filters,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateVideos:new _({category:y.Filters,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!wr()}),validationErrorBlocklist:new Ie({category:y.Filters,description:`If any of the following patterns match a validation error found in a photo or video, the file will be considered corrupt and not be imported into your library.
Note the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message, so, for example, a value of "caution" will ignore any error message that contains the string "caution".`,defaultValue:()=>["Cannot determine format of input stream","corrupt","error","failed","invalid","not a .+ file","nothing was written into output file","partial file","Premature end of .+ file"]}),tagCamera:new _({category:y.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new _({category:y.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new _({category:y.Tagging,description:`Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you'll need to "Rebuild" your library to make the setting take effect).`,defaultValue:!0}),tagYMD:new Ro({category:y.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["y","ym","ymd",""]}),tagDateFromStat:new _({category:y.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!wr()}),tagKeywordsFromPath:new _({category:y.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new _({category:y.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new st({category:y.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new st({category:y.Tagging,description:`PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "Objects\u2283Tools\u2283Hammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don't want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.`,defaultValue:"/|>\u2283"}),tagFileType:new _({category:y.Tagging,envAliases:["PS_TAG_TYPE"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0}),tagWhoSynonyms:new Ie({category:y.Tagging,description:'List hierarchical tags that PhotoStructure should interpret to be face names. Digicam uses "People". This is matched case-insensitively.',defaultValue:()=>["People","Face","Faces"]}),tagJsonFaces:new _({category:y.Tagging,description:'Google Takeout provides .json sidecars that may contain the names of the people (or pets) found in the image. Should PhotoStructure import these tags under "Who"?.',defaultValue:!0}),tagFaceRegions:new _({category:y.Tagging,description:'Picasa and other software supports embedding face names within "RegionInfo" metadata. If this setting is enabled, PhotoStructure will import these tags under "Who".',defaultValue:!0}),tagWhoNames:new Ie({category:y.Tagging,description:`This is a list of tags that will be examined for strings or string arrays. All values associated to these fields will be interpreted as names. Note that "dotted notation" is supported.
Set this value to an empty array to disable scanning for person names.`,defaultValue:["People","PersonInImage","PersonInImageWDetails.PersonName","PersonInImageName"]}),tagNamesFormatter:new Ro({category:y.Tagging,description:`How should PhotoStructure format the "Who" tags for assets whose files are tagged with "people" strings?
"as-is" will tag names directly to "Who", so, "Who/Albert Einstein".
"family/given" will tag "Who/Einstein/Albert" (for regions that provide given names first). The default is "as-is," because discerning given and family names aren't reliably inferable.
See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"as-is",validValues:["as-is","family/given"]}),tagNamesDefaultFamily:new st({category:y.Tagging,description:'If a name is missing a family name, if this value is not blank, it will be provided as a default. If this value is blank, the name tag will be Who/given. Note that this setting is only used if "tagNamesFormatter" is set to "family/given".',defaultValue:"-"}),tagNamesCapitalizedAsFamily:new _({category:y.Tagging,description:"Assume uppercased names are family names (this is common practice in geneology).",defaultValue:!0}),tagNamesOrder:new Ro({category:y.Tagging,description:`How should PhotoStructure parse people's names? Note that this setting is only used if "tagNamesFormatter" is set to "family/given". See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"western",validValues:["western","eastern"]}),tagNamesSurnamePrefixes:new Ie({category:y.Tagging,description:'List all family name prefixes to be considered part of the family name. These are matched case-insensitively. This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>["A","D\u2019","Da","De la","De las","De","Del","Della","Den","Des","Di","Du","La","Las","Le","Li","Lo","Mc","Mac","op de","ten","ter","Van \u2018t","van der","van","von der","von","z","zu"]}),tagNamesSurnames:new Ie({category:y.Tagging,description:`List all family names you expect in tags that are not single words that are found at the end of a tagged name. Hyphenated family names (like "Ocasio-Cortez") do not need to be listed here: only compound family names, and if your language doesn't separate family names with whitespace. In the latter case, either include all family names, or include all givenNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesGiven:new Ie({category:y.Tagging,description:`List all given names you expect in tags that are not single words. Hyphenated given names (like "Rose-Ann") do not need to be listed here. If your language doesn't separate family names and given names with whitespace, either include all given names, or include all familyNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesFamilySurrounds:new Ie({category:y.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added as a family name. As an example, if you use the default "()", then "Michelle LaVaughn (Robinson) Obama" will be name tagged with both "Who/Robinson/Michelle LaVaughn" and "Who/Obama/Michell LaVaugn". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["()"]}),tagNamesGivenSurrounds:new Ie({category:y.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added to the end of the given name with the surrounds retained. As an example, if you use the defaults of "[]" and double-quotes, then "Joe "Joey" Smith" will be name tagged with Who/Smith/Joe "Joey". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["[]",'""']}),tagNamesLexical:new _({category:y.Tagging,description:'Assume any name with a comma is in "lexical name order", which is always "lastname, given name(s)". If the given name is found to be "sr.", "senior", "jr.", or "junior", the name will be considered to be in western order ($givenNames $familyName, $modifier), and the $modifier will be added to the $givenNames. If this is set to false, commas are ignored.',defaultValue:!0}),excludedRootTags:new Ie({category:y.Tagging,description:"Keywords starting with the given roots will be omitted from your PhotoStructure library.",defaultValue:()=>["http:","https:"]}),tagDisplayNameFS:new st({category:y.Tagging,description:`What should PhotoStructure call the "root" tag for browsing by filesystem paths? Note that this value is only for the UI, and will update the "_displayName" of the /fs/ tag: this value won't change the URL path from be "/tag/fs/.../". Reasonable options that have been suggested include "Folder", "Directory", "Drive", "File", "Path", "Volume", or "Computer".`,defaultValue:"Folder"}),tagAlbums:new _({category:y.Tagging,description:'Should PhotoStructure look for $tagJsonAlbumFilename (by default, "metadata.json") files in the same directory as asset files for album titles?',defaultValue:!0}),tagAlbumFilenames:new Ie({category:y.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the file that PhotoStructure should look for with album metadata? This can be JSON, XMP, MIE, or EXIF encoded.`,defaultValue:["metadata.json"]}),tagAlbumTitle:new st({category:y.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.title"}),tagAlbumTitleHierarchies:new _({category:y.Tagging,description:'If true, album titles will be split as hierarchical keywords. If false, album titles will not be split, and all albums will be under the "Albums" root tag.',defaultValue:!1}),tagAlbumDescription:new st({category:y.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.description"}),tagAlbumDate:new st({category:y.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.date"}),tagAlbumsExcluded:new Ie({category:y.Tagging,description:'For "metadata.json" albums, some are automatically generated. If the title or description includes any given string, it will be ignored.',defaultValue:["Album for automatically uploaded content"]}),pickPlanOnWelcome:new _({category:y.Subscriptions,description:'If set to true, the welcome page flow will redirect to https://account.photostructure.com/plans to have you pick between "plus" and "lite". If set to false, the welcome page will continue directly to the settings page with a "lite" license. You can still upgrade to a paid plan later from the main menu or the about page, even if this is false.',defaultValue:!0}),autoRefreshLicense:new _({category:y.Subscriptions,description:`PhotoStructure uses cryptographically signed licenses to locally store your current plan subscription status. These licenses are only valid for the current subscription period, and must be refreshed when your subscription renews or converts from a free trial to a paid subscription. To minimize the hassle of license renewals, PhotoStructure can automatically renew expired licenses in the background.
If the current license has expired and this value is true, PhotoStructure will make one secure POST request to https://account.photostructure.com/ that contains several lossy one-way hashes of current system metadata. We hash all identifying metadata to only 15 characters to alleviate any privacy concerns. If your plan subscription is active, a new license will be added to your library.
Set this to false and set the "reportErrors" setting to false if you don't want PhotoStructure "phoning home" for any reason.
Note that if this is disabled, license renewals will require manual intervention: click "Upgrade" from the main menu, pick your plan, authenticate, and the license will automatically refresh.`,defaultValue:!0}),license:new bn({category:y.Subscriptions,description:`Subscription licenses are normally saved automatically into both your library and system configuration directories. This setting just provides users with an alternative way to provide a license, if it's more convenient. Any value provided to this setting will be considered in addition to existing license files when PhotoStructure is trying to find the "best" license available.`})};for(let[t,e]of Xe(u))e._setName(t);function Kk(t){let e=(P(t)?"":t).split(qa.delimiter);if(R&&P(ja.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return e.push(...u.toolPaths.valueOrDefault),G(e).filter(T).join(qa.delimiter)}var FT=l(()=>Kk(ja.env.PATH)),um=l(()=>{let t=St(u).filter(e=>!e.transient);return ie(t,e=>[e.categoryType==="system"?0:1,y.indexOf(e.category),e.advanced,e.name])}),XT=l(()=>um().filter(t=>kh.includes(t.category))),ZT=l(()=>um().filter(t=>gm.includes(t.category)));var eS;(function(o){o.highlight=()=>!1,o.silent=!1,o.enabled=()=>!o.silent,o.defaultLevelIndex=fm("trace")})(eS||(eS={}));var Jk=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i,tS=class{constructor(e){this.silent=!1;this.contexts=[];this.setup(e)}setup(e){this.contexts.length=0;let r=fm(u.logLevel.defaultValue),i=T(e)?e:u.logLevel.valueOrDefault;z(i.split(",")).forEach(o=>{let n=Jk.exec(o.trim());if(n==null)ne||console.error("LogFilterImpl: Ignoring '"+o+"' from "+e);else{let s=d(n[1]).toLowerCase(),a=fm(n[2]);P(s)?r=a:this.contexts.push({prefix:s,levelIndex:a})}}),this.defaultLevelIndex=r}contextOverride(e){if(this.contexts.length===0&&P(e))return;let r=d(e).toLowerCase();return this.contexts.find(i=>r.startsWith(i.prefix))}enabled(e,r){if(this.silent)return!1;let i=fm(e);if(i<=this.defaultLevelIndex)return!0;let o=this.contextOverride(r);return o!=null&&i<=o.levelIndex}highlight(e){let r=this.contextOverride(e);return r!=null&&r.levelIndex>=this.defaultLevelIndex}},Qc;function yn(){return Qc==null&&(Qc=new tS,u.logLevel.addListener(()=>Qc.setup())),Qc}var rS=l(()=>Ut.values[yn().defaultLevelIndex],5*v);function wn(t,e){return yn().enabled(t)?e():void 0}var Es=class{constructor(e){this.valueOf=e;this.store=[]}get length(){return this.store.length}add(e){if(e==null)return;let r=this.valueOf(e);if(r!=null){if(this.store.length===0){this.store.push(e);return}if(yi(r,this.valueOf(this.store[0]))){this.store.unshift(e);return}for(let i=this.store.length-1;i>=0;i--)if(Ci(this.valueOf(e),this.valueOf(this.store[i]))){this.store.splice(i+1,0,e);return}this.store.unshift(e)}}shiftLt(e){if(this.length===0)return[];let r=0;if(yi(this.valueOf(Vu(this.store)),e))r=this.store.length;else for(;yi(this.valueOf(this.store[r]),e);)r++;return r===0?[]:this.splice(0,r)}splice(e,r){return this.store.splice(e,r)}};var aS=M(require("process"));var oS=M(require("util"));var iS=M(require("luxon"));var Qk=Date.now();function $c(t){let e=u.logElapsedMs.valueOrDefault?iS.Duration.fromMillis(t-Qk).toFormat("hhhh:mm:ss.SSS"):new Date(t).toISOString();return u.logColor.valueOrDefault?u.logElapsedMs.valueOrDefault?pa(e):fa(e):e}var xn=ne?250:750;var _h=class{constructor(e={}){this.logLevels={trace:"trace",debug:fa("debug"),info:Gu("info "),error:Sw("error"),warn:Mw("warn ")};this.inspectOptions=g(g({},_h.defaultInspectOptions()),e),ne&&(this.inspectOptions.breakLength=255)}formatMeta(e){if(e==null)return;let r=Ms(e);return r==null?void 0:(0,oS.inspect)(r,this.inspectOptions)}formatLogEntry(e){let r=yn().highlight(e.ctx)?pa:ju;return z([$c(e.ts),nS(w(e.from,()=>this.inspectOptions.processName())),this.logLevels[e.l],r(e.ctx),e.msg,this.formatMeta(e.meta)]).map(i=>d(i)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:Kr(),ctx:r,msg:i,meta:o})}},Yc=_h;Yc.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:jc+1,processName:Kr});var sS=M(require("util"));var Nh=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e;this.paddedLogLevels=mt(Ut.values.map(e=>[e,Jw(e,5," ")]))}formatLogEntry(e){return z([$c(e.ts),Kr(),this.paddedLogLevels[e.l],ji(e.ctx),ji(e.msg),p(e.meta,r=>(0,sS.inspect)(r,this.inspectOptions))]).map(r=>d(r)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:Kr(),ctx:r,msg:i,meta:o})}};var $k=l(()=>{u.logColor.addListener(()=>bm.unset())}),bm=l(()=>(aS.env.NO_COLOR!=null&&(u.logColor.tmpValue=!1),$k(),u.logColor.valueOrDefault?new Yc({processName:()=>""}):new Nh));function Ha(t){return t?.ts}var lS=!1;function Bh(t){lS=t}var mS=new Es(Ha);function Xc(...t){for(let e of t)lS?mS.add(e):console.log(bm().formatLogEntry(e))}function Ch(t=xn*2){return mS.shiftLt(Date.now()-t)}var Vh=class{log(e,r,i,o){Xc({ts:Date.now(),l:e,from:Kr(),ctx:r,msg:i,meta:o})}enabled(e,r){return yn().enabled(e,r)}async flush(){}end(){}},Ds=Vh;Ds.instance=l(()=>new Vh);var cS=M(require("path")),pS=M(require("timers"));function Zc(t){try{if(T(t))return JSON.parse(t)}catch{}}function uS(t,e){try{if(T(t))return e(JSON.parse(t))}catch{}}var Yk=require("fs");var ep=class{constructor(e,r={}){this.logDir=e;this.ended=!1;this.mutex=new tt;this._linesSinceRotate=0;this.pendingWrites=[];this._startIndex=0;this.endTimeoutMs=15*v;this.end=l(async()=>(this.ended=!0,p(this.flushInterval,pS.clearInterval),this.flushInterval=void 0,await this.flush(),this.mutex.serial("close",()=>this._closeCurrent())));this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",()=>this._flush());this.shouldRotate=()=>this._stream==null||this._linesSinceRotate>=this.opts.maxLinesPerFile;this.name="LogWriter("+e+")",this.opts=g({maxLinesPerFile:25e4,errorLogger:Ds.instance(),flushEveryMs:xn,processName:Kr},r),this.flushInterval=Ur(()=>this.maybeFlush(),this.opts.flushEveryMs),yx(this)}log(e,r,i,o){if(this.ended&&e==="error")this.opts.errorLogger.log(e,r,i,o);else{let n={ts:Date.now(),l:e,ctx:r,msg:i};o!=null&&(n.meta=o),e==="error"&&(this.writeRecentLogEntries(),this.flush()),this.pendingWrites.push(I(n)+`
`)}}writeRecentLogEntries(){this.pendingWrites.push(...UT().map(e=>I(e)+`
`)),CT()}async flush(){await this.mutex.serial("flush",()=>this._flush())}async _flush(){let e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this._rotate();let r=this._stream;if(r==null){this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");return}let i=this.opts.maxLinesPerFile-this._linesSinceRotate,o=e.splice(0,i);this._linesSinceRotate+=o.length,r.write(o.join(""))}}errback(e){return r=>this.opts.errorLogger.log("error","Caught error from "+e,r)}async _rotate(){await this._closeCurrent(),this._currentFile=await bc({nativePath:(0,cS.join)(this.logDir,zu(new Date),ji(this.opts.processName())+".log"),emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=Yk.createWriteStream(this._currentFile).on("error",this.errback("file write stream"))}async _closeCurrent(){let e=this._stream;this._stream=void 0,this._linesSinceRotate=0;let r=this._currentFile;this._currentFile=void 0,await $i(e),u.logCompression.valueOrDefault&&(await nt(this.opts.flushEveryMs),await p(r,cv))}};async function fS(t,e){let r=qr(t.name);return b(Gv(t.nativePath,e),i=>A(z(Xi(i)).map(o=>uS(o,n=>g(g({},n),{from:r})))))}var Uh=l(()=>[Ds.instance()]);function vc(){return Uh().find(t=>t instanceof ep)}function wm(){let t=u.logDir.valueOrDefault,e=vc();(e==null||e.logDir!==t)&&(yt(e),e=new ep(t));let r=[e];(u.logStdout.valueOrDefault||u.tailLogs.valueOrDefault)&&r.push(Ds.instance()),Uh.set(r)}function tp(){return vc()?.writeRecentLogEntries()}function f(t){return new dm(t,Uh)}var Ga=Se("main","web","sync","sync-file","info","test","logcat","logtail","list","billing");function hS(t){let e=Ga.indexOf(t);return e<0?Ga.length+1:e}var Xk=["main","test"],Zk=["main","web","test","info"],eO=["sync","sync-file"];function rp(t){switch(t){case"main":case"web":return E;case"sync":case"sync-file":default:return 10*v}}var Ai="";function Xt(){if(P(Ai))throw Error("serviceName() is unset");return Ai}function ip(t){if(!ne&&t!==Ai&&Ai!=="")throw new Error("Cannot set service name twice");Ai=t,Kr.unset(),wm()}var tO=l(()=>[{re:/sync-file|billing/,f:Gu},{re:/sync/,f:ju},{re:/web/,f:qu},{re:/db/,f:Hu},{re:/main/,f:pa},{re:/info/,f:Pw},{re:/test/,f:Wu}]),Kr=l(()=>z([Ai,d(dS.pid)]).join("-"));function nS(t){let e=tO().find(r=>t.match(r.re));return e!=null?Ew(e.f(t)):t}function Lr(){return Ai===Ga.main}function op(){return Ai===Ga.web}function vn(){return Xk.includes(Xt())}function xm(){return!vn()&&Ai!=="info"}function rO(){return Ai==="sync"}function vm(){return Ai==="sync-file"}function np(){return Zk.includes(Xt())}function gS(){return eO.includes(Xt())}var yS=l(()=>rO()||ne&&!vm());var bS=M(require("process"));var iO=new Date().getFullYear(),oO=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.

Copyright \xA9 2017-${iO}, PhotoStructure Inc.

Running this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,wS={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",list:"List all paths in a Library.",logcat:"Chronologically sort and pretty-print PhotoStructure logfiles.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."};function xS(t){return t.on("--help",()=>{console.log(`
`+To(oO,{maxLineLen:bS.stdout.columns??78,prefix:""}).join(`
`)+`
`)})}var zh=class{constructor(e,r,i){this.serviceName=e;this.args=r;this.additionalDescription=i;this.plugins=[];ip(e)}add(...e){return this.plugins.push(...e),this}async parse(){let e=xS(vS.program.description(wS[this.serviceName]+fr(this.additionalDescription,i=>`

`+i,()=>"")));p(this.args,i=>{e=e.arguments(i)});for(let i of this.plugins)e=i.beforeParse(e);e.version(wt,"--version","Output the version number (spoiler: it's "+wt+")"),e.parse(TS.default.argv);let r=e.opts();for(let i of this.plugins)await i.afterParse(r);return e}};var SS=M(require("process"));function Ka(t){return O(SS.default.env.__is_daemon)||O(t?.daemon)||!P(t?.pidfile)}var Wh={beforeParse:(t,e=!1)=>(t.option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.'),e||t.option("--info|--verbose",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.'),t.option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.').option("--color","Enable ASCII terminal colors",!0).option("--no-color","Disable ASCII terminal colors"),t),afterParse:t=>{p(t.color,o=>u.logColor.tmpValue=o);let e=O(t.warn),r=O(t.info)||O(t.verbose),i=O(t.debug);e&&(u.logLevel.tmpValue="warn"),r&&(u.logLevel.tmpValue="info"),i&&(u.logLevel.tmpValue="debug"),!Ka(t)&&(e||r||i)&&(u.logStdout.tmpValue=!0)}};var MS={beforeParse:t=>{let e=!0;return t.option("--info",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--verbose",'Verbose logging from all processes. Shortcut for "--info --tail". Caution: noisy during imports!').option("--tail","Emit log messages from both this process and all other concurrently running PhotoStructure processes on this host to stdout. This can be really helpful in seeing how PhotoStructure's processes are coordinating work. Caution: very noisy especially during imports. Sets PS_TAIL_LOGS to true. Ignored if daemonized."),Wh.beforeParse(t,e),t.option("--force-open,--forceOpen","DANGEROUS: removes all previously-existing library locks. This should only be necessary if the prior PhotoStructure process was not shut down gracefully."),t},afterParse:t=>{if(Wh.afterParse(t),O(t.elapsed)&&(u.logElapsedMs.tmpValue=t.elapsed),Ka(t))u.logStdout.tmpValue=!1,u.tailLogs.tmpValue=!1;else{let e=O(t.verbose);e&&u.logLevel.isUnset()&&(u.logLevel.tmpValue="info"),(O(t.tail)||e)&&(u.tailLogs.tmpValue=!0),O(t.forceOpen)&&(u.forceOpen.tmpValue=!0)}}};var PS="--exit-when-done";var ES={beforeParse:t=>t.option(PS+",--exitWhenDone","Exit after jobs are completed. Defaults to false unless paths are specified on the command line."),afterParse:t=>{O(t.exitWhenDone)&&(u.exitWhenDone.tmpValue=!0)}};var zM=M(require("fs-extra"));var VM=M(require("path"));var nO=[[["360"],"GoPro 360 video (QuickTime-based)"],[["3FR"],"Hasselblad RAW (TIFF-based)"],[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["AVIF"],"AV1 Image File Format (QuickTime-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["CZI"],"Zeiss Integrated Software RAW (ZISRAW)"],[["DCP"],"DNG Camera Profile (DNG-like)"],[["DCR"],"Kodak Digital Camera RAW (TIFF-based)"],[["DNG"],"Digital Negative (TIFF-based)"],[["DV"],"Digital Video"],[["ERF"],"Epson RAW Format (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["FFF"],"Hasselblad Flexible File Format (TIFF-based)"],[["FFF"],"FLIR Systems thermal image File Format"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HDP","WDP","JXR"],"Windows HD Photo / Media Photo / JPEG XR (TIFF-based)"],[["HDR"],"Radiance RGBE High Dynamic-Range"],[["HEIC","HEIF","HIF"],"High Efficiency Image Format (QuickTime-based)"],[["IIQ"],"Phase One Intelligent Image Quality RAW (TIFF-based)"],[["INSP"],"Insta360 Picture (JPEG-based)"],[["INSV"],"Insta360 Video (QuickTime-based)"],[["J2C","J2K","JPC"],"JPEG 2000 codestream"],[["JP2","JPF","JPM","JPX"],"JPEG 2000 image [Compound/Extended]"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PEF"],"Pentax (RAW) Electronic Format (TIFF-based)"],[["PNG","JNG","MNG"],"Portable/JPEG/Multiple-image Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Kyocera Contax N Digital RAW"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["X3F"],"Sigma/Foveon RAW"],[["XMP"],"Extensible Metadata Platform sidecar file"]],We=Se("RawImage","Sharp","Video","Sidecar","AssetFile","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser"),sO=l(()=>{let t=new on,e=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"];for(let s of e)t.add(s,We.RawImage);let r=A(["GIF","JPEG","PNG","PPM","TIFF","WEBP"]);for(let s of r)t.add(s,We.Sharp);let i=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"];for(let s of i)t.add(s,We.Video);let o=[...r,"HEIC",...e,...i];for(let s of o)t.add(s,We.AssetFile);for(let s of hm)t.add(s,We.Sidecar);for(let s of[...o,...hm])t.add(s,We.Exif);for(let s of["GIF","JPEG","MP4","PNG","WEBM","WEBP"])t.add(s,We.SupportedByCurrentBrowser);for(let s of["GIF","JPEG","MP4","PNG"])t.add(s,We.SupportedByOldBrowser);let n=nO.map(s=>s[0]);for(let s of t.keys()){let a=n.find(m=>m.includes(s));if(a!=null&&a.length>0){let m=t.get(s);for(let c of a)t.has(c)||t.set(c,m)}}return t});function As(t){return p(aO(t),e=>sO().get(e))}var lO=/\.?([a-z0-9]{2,4})$/i;function aO(t){return p(lO.exec(d(t)),e=>e[1].toUpperCase())}function Ja(t,e){return Z(As(t),r=>r.includes(e),()=>!1)}function Fi(t){return Ja(t,We.Video)}function Tm(t){return Ja(t,We.Sidecar)}function DS(t){return Ja(t,We.Exif)}function AS(t){return Ja(t,We.SupportedByCurrentBrowser)}function qh(t,e){let r=mO(e);return r===""?t:t+"?"+r}function mO(t){if(t==null)return"";let e=Xe(t).filter(([,r])=>r!=null);return N(e)?"":e.map(r=>r.map(d).map(encodeURIComponent).join("=")).join("&")}var to="pslib",_o="psfile",pi="psnet";var sp=M(require("dns"));function Li(t,e){let r=0,i=new Yi(e),o=n=>(r++,i.getOrSetAsync(I(n),async()=>t(n)));return o.clear=n=>{if(n==null)i.clear();else{let s=I(n);i.deleteIf(a=>s===a)}},o.size=()=>i.size,o.callCount=()=>r,o}var uO=Li(async t=>{let e=R?await mT():"ping";return ue(e,[R?"-n":"-c","1",t],{timeout:5*v})},{maxSize:255,timeoutMs:Fr,clearEveryMs:10*E}),jh=new RegExp("\\b"+Te(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),VX=Li(async t=>W(await uO(t).catch(e=>{console.warn("failed to ping: "+e)})).filter(T).flatMap(e=>jh.exec(d(e))).map(e=>e[0]).get(),{maxSize:255,timeoutMs:Fr,clearEveryMs:10*E});var cO=new RegExp("^"+jh.source+"$"),pO=Li(async t=>{let e=cO.exec(t)==null?t:await FS(t);return d(e).toLowerCase().normalize()},{maxSize:128,timeoutMs:Fr}),fO=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function Hh(t){return fO.exec(t)!=null}function LS(t){let e=t.split(".").map(r=>V(r)).filter(r=>Pt(0,255,r));return e.length===4?e:void 0}var IS=Li(async t=>{if(!P(t)){if(LS(t)!=null)return[t];try{return await sp.promises.resolve4(t)}catch(e){ap().warn("No name found for "+t);return}}},{maxSize:256,timeoutMs:Fr,clearEveryMs:10*E}),ap=l(()=>f("nslookup"));B(()=>j(()=>FS.clear()));var FS=Li(async t=>{try{let e=await Ee(()=>Hh(t)?t.startsWith("127.")?["localhost"]:["127.0.0.1"]:LS(t)!=null?sp.promises.reverse(t):sp.promises.resolve4(t),5*v);if(e==null)return ap().info("nslookup("+t+"): timeout"),t;let r=e.find(T);return r??(ap().warn("No name found for "+t),t)}catch(e){return ap().warn("Failed to look up "+t+", using name.",e),t}},{maxSize:256,timeoutMs:Fr,clearEveryMs:10*E});async function kS(t,e){return P(t)||P(e)?!1:ot(t,e)||Hh(t)&&Hh(e)?!0:Aa(IS(t),IS(e),(r,i)=>r.some(o=>i.includes(o)),()=>!1)}var dO=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;async function hO(){let t=await ue("mount",[],{timeout:H});return A(t.split(`
`).map(e=>p(dO.exec(e),r=>{let[i,o,n]=r.slice(1),s=n.split(",").map(a=>a.trim());return{filesystem:i,mountpoint:o,options:s}})))}var OS=l(async()=>Qi(await hO(),async t=>t.options.includes("nobrowse")||t.options.includes("quarantine")||await gO(t.mountpoint)).then(t=>t.map(e=>e.filesystem)),Rt);async function gO(t){let e=ce.for(t),r=await he(await e.childNames(),i=>i.filter(o=>!o.startsWith(".")).map(o=>o.toLowerCase()).sort(),()=>[]);return Dr(r,["applications","photostructure.app"])}function Gh(t){return V(t,{defaultValue:0})*1024}var yO=["devfs"],bO=["udev","tmpfs","devtmpfs","shm"],wO=de?yO:bO,xO=["/boot/efi","/dev/shm"];async function Fs(t,e){let r=de?await OS():[],i=["-k","-P"];t&&i.push("-l"),T(e)&&i.push(e);let o=await ue("df",i,{timeout:H,ignoreStderr:!0,ignoreExitCode:!0});return Io(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],o).map(s=>({filesystem:s.Filesystem,size:Gh(s["1024-blocks"]),used:Gh(s.Used),available:Gh(s.Available),mountpoint:s["Mounted on"]})).filter(s=>{let a=d(s.filesystem),m=d(s.mountpoint);return T(m)&&!xO.includes(m)&&T(a)&&!r.includes(a)&&!wO.includes(a)})}var Ls=l(async()=>{if(!ut||Ne())return!1;try{return(await Ke(lp,["version"],{timeout:H,ignoreStderr:!0})).code===0}catch(t){return!1}}),lp="gio",RS=["mount","--monitor","--anonymous"],vO=l(()=>f("Gio.gioVolumes()")),Qa=l(()=>Ee(async()=>{let t=await SO(),e=(await Gl(t.map(async r=>{let i=await Fs(!1,r.nativePath).catch(n=>{vO().warn("Failed to df "+r+": "+n)}),o=p(i,n=>n[0]);return p(o,n=>n.mountpoint=r.nativePath),o}))).filter(r=>r.size>0);return Promise.all(e.map(async r=>he(TO(r.mountpoint),i=>(r.remoteHost=i.remoteHost,r.remoteShare=i.remoteShare,r.label=i.displayName,r.remote=!0,r),()=>r)))},Rt,()=>f("Gio.gioVolumes").warn("timed out after "+Rt+"ms")),us),MO=f("Gio.getRemoteInfo()"),TO=Li(async t=>{try{let e=(await ue(lp,["info",t],{timeout:H})).split(/[\n\r]+/),r=K(e.find(i=>i.startsWith("uri: ")),i=>new URL(He(i,"uri: ")));return{displayName:p(e.find(i=>i.startsWith("display name: ")),i=>He(i,"display name: ")),remoteHost:p(r,i=>i.hostname),remoteShare:W(r).flatMap(i=>i.pathname).flatMap(i=>He(i,"/")).flatMap(i=>gr(i,"/")).flatMap(decodeURIComponent).filter(T).get()}}catch(e){MO.warn("gio info failed",{mountpoint:t,err:e});return}},{maxSize:255,timeoutMs:Fr,clearEveryMs:10*E}),mp=l(async()=>b(ce.for("/proc/mounts").readLines(),t=>t.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1])),us);async function SO(){return await Ls()?Gl(await b(mp(),t=>t.map(e=>ce.for(e).clear().childDirectories()))):[]}var Is=M(require("luxon"));function _S(t,e,r){return t!=null&&e!=null&&Math.abs(t.getTime()-e.getTime())<=r}function up(t,e=2500){return t==null?!1:ua(t)?_S(t,new Date,e):Math.abs(t-Date.now())<e}function Kh(t,e=5*v){return k(t)&&Date.now()-t<=e}function NS(t=new Date){return[t.getFullYear(),Ht(t.getMonth()+1),Ht(t.getDate()),"-",Ht(t.getHours()),Ht(t.getMinutes()),Ht(t.getSeconds())].join("")}function Jh(t=new Date){return[t.getUTCFullYear(),Ht(t.getUTCMonth()+1),Ht(t.getUTCDate()),"-",Ht(t.getUTCHours()),Ht(t.getUTCMinutes()),Ht(t.getUTCSeconds())].join("")}function Qh(t){return Is.Duration.fromMillis(t).toFormat("m:s.S")}function $h(t){return W(t).filter(T).map(e=>Is.DateTime.fromISO(e)).filter(e=>e.isValid).map(e=>e.toMillis()).get()}function BS(t){return p(PO(t),e=>e*100+cp(t.millisecond))}function PO(t){return t==null||!t.isValid?void 0:V(t.toFormat("yMMddHHmmss"))}function cp(t){return Math.floor(t/10)}function Yh(t,e){if(t==null||t<0)return;let r=t,i=()=>{let x=r%100;return r=Math.floor(r/100),x},o=10*i(),n=i(),s=i(),a=i(),m=i(),c=i();return{year:r,month:c,day:m,hour:a,minute:s,second:n,millisecond:o,zone:p(e,x=>Is.Info.normalizeZone(x))}}function pp(t,e){return p(Yh(t,e),r=>Is.DateTime.fromObject(r))}function CS(t,e){return p(pp(t,e),r=>r.toMillis())}function fp(t){let e=new Date(t);return V([e.getFullYear(),...[e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),cp(e.getUTCMilliseconds())].map(Ht)].join(""))}function dp(t){return new Xh(g({name:A([t.cmd,...t.args]).join(" "),childFactory:()=>pm(t.cmd,t.args,30*E),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},t))}var Xh=class{constructor(e){this.startMs=Date.now();this._stopped=!1;this.logger=l(()=>f("WatchedChild("+A([this.name,this.pid]).join(":")+")"));this.startRate=new li(2*E);this.mutex=new tt;this._ended=!1;this.onError=async(e,r)=>{let i=Ji(e)||Ji(r),o=new ae({message:e+p(r,fe),cause:mc(r)?r:void 0}),n=Kt(o),s={src:e,fatal:i,ignorable:n,errToS:fe(r)};if(this.logger().log(n?"warn":"error","onError()",s),this._ended||n)return;if(this.lastError=o,J(e,o),i)return this.end();if(this.opts.onError(e,r))return this.logger().warn("onError requested restart",s),this._restart()};this.name=e.name,this.opts=g({dataSep:`
`,maxErrorsPerMinute:3,endableRank:Q.first,exitCommand:"",restartOnExit:!0},e),this.endTimeoutMs=rp(this.name),ns(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}async end(){return this._ended=!0,this._stop()}get proc(){return this.cp}get pid(){return p(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return Z(this.pid,e=>Vc(e),async()=>!1)}notRunning(){return Et(this.running())}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}async _stop(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});let e=this.cp;return this.cp=void 0,e==null?!0:this.stopChild(e)}async stopChild(e){return await W(this.opts.exitCommand).filter(T).flatMap(r=>W(e).flatMap(i=>i.stdin).filter(i=>i.writable).forEach(i=>et(()=>i.write(r+`
`))).map($i).get()),cm(e,this.endTimeoutMs)}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:bo(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){if(this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),this._ended||C())return!1;if(!e&&this.startRate.msSinceLastEvent<u.minTimeBetweenServiceRestartsMs.valueOrDefault){this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:u.minTimeBetweenServiceRestartsMs.valueOrDefault});return}return this.mutex.serial(`WatchedChild(${this.name}).restart`,async()=>(await this._stop(),this._stopped=!1,this._start()))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,async()=>(this._stopped=!1,this._start()))}async _restart(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,async()=>(await this._stop(),this._stopped||this._ended?!1:this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),Kh(this.startMs,u.probationMs.valueOrDefault)&&J("Can't restart "+this.name+", failure rate is too high."+ge,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),this.opts.onRestart?.(),this._start())))}async _start(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended||await this.running())return!1;this.startRate.onEvent();let e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);let r="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:i,desc:o})=>{p(i,n=>n.on("error",s=>this.onError(r+o+".on(error)",s)))}),p(this.cp.stdout,i=>fn(i,this.opts.dataSep,o=>{this.logger().trace("onDataChunked()",o),this.opts.onStdout(o)})),p(this.cp.stderr,i=>i.on("data",o=>{d(o).includes("Error: Cannot find module")&&J("Failed to start "+this.name+ge,new Error(sr(o,256))),this.opts.onStderr?.(o)===!0&&this.onError(r+".stderr.on(data)",o)})),this.cp.on("exit",async(i,o)=>{this.logger().info("onExit",{code:i,signal:o,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?(await this._restart(),this.logger().info("onExit(): finished setting up new child "+this.pid)):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending "+this.pid),this.end())}),!0}};var Zh=M(require("timers"));function hp(t,e){e=Math.ceil(e);let r,i=[],o=(...n)=>{i=n,p(r,Zh.clearTimeout),r=wa(()=>t(...i),e)};return o.reset=()=>{p(r,Zh.clearTimeout),r=void 0},o.now=()=>{o.reset(),t()},o}var EO=f("Mountpoints.localMountpointSetup()");async function VS(){let t=await b(Fs(!1),e=>z(e.map(r=>r.mountpoint)));if(t!=null&&await Ls())try{await b(Qa(),e=>t.push(...e.map(r=>r.mountpoint)))}catch(e){EO.warn("Failed to fetch gio volumes",e)}return p(t,e=>e.filter(r=>!r.startsWith("/snap/")&&r!=="/dev"))}var DO=/\s([A-Z]:\\)/g,US=async()=>Dt(De.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(t=>t.map(e=>e.Root)).filter(L).orElse(()=>AO()).map(t=>t.sort()).getRequired(),AO=async()=>{let t=(await ue(await lT(),["fsinfo","drives"],{timeout:10*v})).trim(),e=[],r;for(;(r=DO.exec(t))!==null;)e.push(r[1]);return e};var FO=()=>R?US():VS(),zS;function WS(t){zS=t,LO()}var LO=l(async()=>{vn()?B(async()=>{let t=f("Mountpoints.localMountpointSetup()");de&&(t.info("Setting up Mac diskutil activity watcher"),xt.setTTL(us),qS()),ut&&(await Ls()&&(t.info("Setting up Linux gio mount monitor"),xt.setTTL(us),jS()),await IO()&&(t.info("Setting up Linux findmnt mount monitor"),xt.setTTL(us),HS()))},30*v).unref():await hc([yt(qS.clear()),yt(jS.clear()),yt(HS.clear())])}),xt=l(async()=>(await lr(()=>$t(zS,FO),{maxRetries:3,onRetryWaitUntil:r=>nt(r*1500)}).catch(r=>{J("mountpoints() failed",r)}))?.sort(),Rt);B(()=>j(()=>xt.unset()));var qS=l(()=>dp({cmd:"diskutil",args:["activity"],onStdout:hp(()=>xt.unset(),1.5*v)})),jS=l(()=>dp({cmd:lp,args:RS,onStdout:hp(()=>{Qa.unset(),mp.unset(),xt.unset()},1.5*v)})),IO=l(async()=>{if(!ut)return!1;try{return(await Ke("findmnt",["--version"],{timeout:H,ignoreStderr:!0})).code===0}catch(t){return!1}}),HS=l(()=>dp({cmd:"findmnt",args:["--poll"],onStdout:hp(()=>{mp.unset(),xt.unset()},1.5*v)}));function Jr(t,e){let r=Lv("vol."+t,()=>lr(e,{maxRetries:2,timeoutMs:H,errorIsRetriable:i=>Kt(i)}),$x);return xt.onChange(()=>r.unset()),B(()=>j(()=>r.unset())),r}var kO=Jr("localMountpoints",()=>b(Fs(!0),t=>t.map(e=>e.mountpoint))),GS=Jr("dfPosix",async()=>{let t=await Fs(!1);if(t!=null)return await b(kO(),e=>{t.forEach(r=>{r.remote=!e.includes(r.mountpoint)})}),await Ls()&&await b(Qa(),e=>t.push(...e)),t});async function KS(t,e){if(!R)throw new Error("wtf");return await b(w(e,()=>OO()),r=>{let i=sm(r,o=>[o.mountpoint,o]);t.forEach(o=>{p(i.get(o.mountpoint),n=>{o.remote=!0,o.remoteHost=n.host,o.remoteShare=n.share,o.ok=n.ok})})}),t}var JS=["LocalName","RemoteName","Status"],RO=["NETUSE","get",JS.join(",")],QS=/^\\\\(.+?)\\(.+)$/,$S=/^[a-z]:\\?$/i;async function NO(){let t=await De.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return t==null?_O():A(t.filter(e=>T(e.LocalName)).map(e=>p(eg(e.RemoteName),({host:r,share:i})=>p($S.exec(d(e.LocalName)),o=>({mountpoint:Vt(o[0],"\\"),host:r,share:i,ok:e.Status==="OK"&&e.ConnectionState==="Connected"})))))}function eg(t){if(!P(t))return W(t).flatMap(e=>QS.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>W(t).flatMap(e=>et(()=>new URL(e))).filter(e=>T(e.hostname)).map(e=>({host:e.hostname,share:W(e.pathname).filter(T).getOrElse(()=>"/")}))).get()}async function _O(){let t=Bc(),e=await ue(t,RO,{timeout:15*v}),r=Io(JS,e);return A(r.map(i=>p(QS.exec(d(i.RemoteName)),o=>p($S.exec(d(i.LocalName)),n=>({mountpoint:Vt(n[0],"\\"),host:o[1],share:o[2],ok:i.Status==="OK"})))))}var OO=Jr("netInfoWin",NO);var YS=l(()=>f("DfWin")),XS=Jr("dfWin",async()=>(await BO()).filter(e=>e.ok!==!1&&k(e.size))),CO="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free";function VO(t){return T(t.Root)&&t.Free!=null&&t.Used!=null?g({mountpoint:t.Root,label:t.Description,size:t.Used+t.Free,used:t.Used,available:t.Free,remote:T(t.DisplayRoot)},p(eg(t.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))):void 0}var UO="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus,UniqueId",zO=/\{([-a-z0-9]{7,})\}/i;function WO(t){return YS().tap({msg:"uniqueId2uuid",result:p(zO.exec(d(t)),e=>e[1]),meta:{s:t}})}function qO(t){if(t.DriveLetter==null||t.DriveLetter==="null"||t.FileSystemLabel==="System Reserved")return;let e=t.Size!=null&&t.SizeRemaining!=null&&T(t.DriveLetter)&&(ud(t.HealthStatus,r=>ot(r,"Healthy"))||ud(t.OperationalStatus,r=>ot(r,"OK")));return{mountpoint:t.DriveLetter+":\\",filesystem:t.FileSystem,label:t.FileSystemLabel,uuid:WO(t.UniqueId),size:t.Size,used:t.Size-t.SizeRemaining,available:t.SizeRemaining,remote:!1,ok:e}}async function BO(){let t=await le(De.instance().executeJsonToA(CO).catch(o=>(J("volumeInfoWin(): LocalAndNetCmd failed",o),[])),o=>gd(VO(o))),e=await le(De.instance().executeJsonToA(UO).catch(o=>(J("_localAndNet(): LocalCmd failed",o),[])),o=>gd(qO(o))),r=G([...t,...e].filter(o=>o.ok===!1).map(o=>o.mountpoint)),i=dr(G([...t,...e].map(o=>o.mountpoint)).filter(o=>!r.includes(o)));return YS().info("volumeInfoWin()",{getPsDrive:t,getVolumes:e,mountpoints:i,unhealthy:r}),i.map(o=>g(g({},t.find(n=>o===n.mountpoint)),e.find(n=>o===n.mountpoint)))}async function ZS(t){return b(jO(),e=>t.map(r=>Z(e.get(r.mountpoint),i=>g(g({},r),i),()=>r)))}var jO=Jr("mnt2uuidMac",async()=>{let e=(await ue("diskutil",["info","-all"],{timeout:H})).split(/^\s*\*{8,12}\s*$/m);return sm(e,r=>{let i=sm(r.split(/\s*\n+\s*/),a=>{let[m,c]=a.split(":").map(h=>h.trim());return tn(["not applicable","no file system"],c)?void 0:[m.toLowerCase(),c]}),o=i.get("mount point"),n=i.get("volume name"),s=i.get("volume uuid");return P(o)?void 0:[o,{label:n,uuid:s}]})});function gp({input:t,lowerCaseKeys:e}){let r={},i;for(let o of Xi(t).filter(n=>n.match(/^\s*#/)==null)){let n=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+|#.*?)/gim;for(;(i=n.exec(o))!=null;){let[,s,a,m]=i;r[e?s.toLowerCase():s]=Yw(m,a,a)}}return r}var HO=l(()=>f("LocalVolumesPosix"));async function eM(t){return b(await GO(),e=>Td(G([...e.filter(i=>!i.ignorable).map(i=>i.mountpoint),...t.map(i=>i.mountpoint)])).map(i=>g(g({},t.find(o=>o.mountpoint===i)),e.find(o=>o.mountpoint===i))))}var GO=Jr("localVolumeInfoPosix",async()=>{let t=await ue("lsblk",["-P","-b","--output","mountpoint,label,fsused,fsavail,uuid"],{timeout:H}),e=Xi(t).map(i=>gp({input:i,lowerCaseKeys:!0})).filter(i=>i!=null),r=await Da(e,async i=>{let o=P(i.mountpoint)||i.mountpoint.startsWith("/snap/")||i.mountpoint==="/boot"||i.mountpoint.startsWith("/boot/")||!await av(i.mountpoint);return Gn(V(i.fsused),V(i.fsavail),(n,s)=>g({mountpoint:i.mountpoint,label:i.label,uuid:i.uuid,ignorable:o,used:n,available:s,size:n+s},Ne()?void 0:{remote:!1}))});return HO().tap({msg:"lsblk",result:r})});var KO=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i,JO=/^([^:\s]+):(\/.+)$/;async function tM(t){return t.filter(e=>e.remote).forEach(e=>{Z(KO.exec(d(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]},()=>p(JO.exec(d(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]}))}),t}async function rM(t,e){try{return await(e.timeoutMs==null?t():Ee(t,e.timeoutMs,()=>J(e.message+": timeout",void 0,e.context)))}catch(r){J(e.message,r,e.context);return}}var iM=M(require("crypto"));function QO(){let t=(0,iM.randomBytes)(16);t[6]=t[6]&15|64;let e=t.toString("hex");return[e.slice(0,8),e.slice(8,12),e.slice(12,16),e.slice(16,20),e.slice(20)].join("-")}function yp(){return em(QO)}var kre=l(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/);var Sm=l(()=>f("VolumeUUID")),oM=Rt/2,tg=new Map;B(()=>{j(()=>tg.clear()),xt.onChange(()=>tg.clear())});async function nM(t){await Ar({name:"addVolumeUUIDs",laters:t.map(e=>()=>$O(e))})}async function $O(t){if(O(t.ignorable)){Sm().debug("volumeUUID(): ignorable is true for "+t.mountpoint);return}if(bi(t.ok)){Sm().debug("volumeUUID(): remoteOK is false for "+t.mountpoint);return}await b(Pr(tg,t.mountpoint,()=>Na(()=>rM(()=>YO(t),{message:"readVolumeUUID("+t.mountpoint+")"}),oM)),e=>t.uuid=e)}async function YO(t){let e=X.for(t.mountpoint).join(".uuid");if(u.readVolumeUuidFiles.valueOrDefault){let r=await Na(()=>Dt(e.readFile("debug")).map(i=>i.toString().trim()).filter(T).get(),oM);if(r!=null&&r.length>6)return Sm().debug("Serving UUID from .uuid",{uuid:r,mountpoint:t.mountpoint}),r}if(t.mountpoint==="/")return t.uuid;if(u.writeVolumeUuidFiles.valueOrDefault){let r=oi(t.uuid,yp);if(await e.parent().isReadWritable())try{return await e.writeTxt_(r),Sm().info("volumeUUID(): Saved new UUID for "+t.mountpoint,{uuid:r}),r}catch(i){Sm().warn("volumeUUID(): Failed to save new UUID for "+t.mountpoint,i)}}return t.uuid}var Mm=l(()=>f("Volumes"));async function XO(){let t=await Ee(R?XS():GS(),Rt,()=>J("Timed out getting local volume metadata"));if(t==null){Mm().warn("df failed");return}let e=u.validateMountpoints.valueOrDefault?A(await Ar({name:"nonRpcVolumes: filter unhealthy volumes",laters:t.map(o=>async()=>{try{if(await ln(o.mountpoint,La/2))return o;Mm().info("validateMountpoints(): "+o.mountpoint+" is not a directory")}catch(n){Mm().info("validateMountpoints(): failed to stat "+o.mountpoint,n)}})})):t;e.some(o=>o.remote&&P(o.remoteHost))&&await Ee(R?KS(e):tM(e),10*v).catch(o=>{J("Failed to get remote volume info",o)});let r=w(await(R?e:de?ZS(e):eM(e)),e);vt(r,o=>!O(o.ignorable)),u.ignoreUnhealthyVolumes.valueOrDefault&&vt(r,o=>!bi(o.ok));for(let o of r)o.remote=O(o.remote),K(o.remoteHost,n=>o.remoteHost=n.toLowerCase().normalize().trim());for(let o of r)P(o.label)&&delete o.label;Mm().debug("nonRpcVolumes(): before addVolumeUUIDs",r),await nM(r);let i=ie(r,o=>o.mountpoint);return Mm().debug("_volumes(): final result",{sorted:i}),Object.freeze(i)}var sM;function aM(t){sM=t}var lM=[],ZO=async()=>{try{let t=await $t(sM,XO);return Me(t,e=>{let r=e.map(i=>i.mountpoint).sort();Dr(lM,r)||(kx(),lM=r)}),t}catch(t){J("volumes() failed",t);return}},Wt=Jr("volumes",ZO),kie=l(()=>R?W(ze("SystemDrive")).filter(T).orElse(()=>"C:").map(t=>Vt(t,"\\")).get():"/");async function $a(t){return b(Wt(),e=>rg(e,t))}function rg(t,e){let r=t.filter(i=>sn(e,i.mountpoint));return dt(r,i=>Vl(i.mountpoint,e))}var vp=M(require("path"));function bp(t,e){let r=0,i=new Ce(e.maxSize,e.ttlMs),o=n=>(r++,i.getOrSet(I(n),()=>t(n)));return o.clear=n=>n==null?i.clear():i.delete(I(n)),o.size=()=>i.size,o.callCount=()=>r,o}var wp=M(require("path")),mM=M(require("punycode")),uM=M(require("util"));var te;(function(t){t[t.Null=0]="Null",t[t.Backspace=8]="Backspace",t[t.Tab=9]="Tab",t[t.LineFeed=10]="LineFeed",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.ExclamationMark=33]="ExclamationMark",t[t.DoubleQuote=34]="DoubleQuote",t[t.Hash=35]="Hash",t[t.DollarSign=36]="DollarSign",t[t.PercentSign=37]="PercentSign",t[t.Ampersand=38]="Ampersand",t[t.SingleQuote=39]="SingleQuote",t[t.OpenParen=40]="OpenParen",t[t.CloseParen=41]="CloseParen",t[t.Asterisk=42]="Asterisk",t[t.Plus=43]="Plus",t[t.Comma=44]="Comma",t[t.Dash=45]="Dash",t[t.Period=46]="Period",t[t.Slash=47]="Slash",t[t.Digit0=48]="Digit0",t[t.Digit1=49]="Digit1",t[t.Digit2=50]="Digit2",t[t.Digit3=51]="Digit3",t[t.Digit4=52]="Digit4",t[t.Digit5=53]="Digit5",t[t.Digit6=54]="Digit6",t[t.Digit7=55]="Digit7",t[t.Digit8=56]="Digit8",t[t.Digit9=57]="Digit9",t[t.Colon=58]="Colon",t[t.Semicolon=59]="Semicolon",t[t.LessThan=60]="LessThan",t[t.Equals=61]="Equals",t[t.GreaterThan=62]="GreaterThan",t[t.QuestionMark=63]="QuestionMark",t[t.AtSign=64]="AtSign",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.OpenSquareBracket=91]="OpenSquareBracket",t[t.Backslash=92]="Backslash",t[t.CloseSquareBracket=93]="CloseSquareBracket",t[t.Caret=94]="Caret",t[t.Underline=95]="Underline",t[t.BackTick=96]="BackTick",t[t.a=97]="a",t[t.b=98]="b",t[t.c=99]="c",t[t.d=100]="d",t[t.e=101]="e",t[t.f=102]="f",t[t.g=103]="g",t[t.h=104]="h",t[t.i=105]="i",t[t.j=106]="j",t[t.k=107]="k",t[t.l=108]="l",t[t.m=109]="m",t[t.n=110]="n",t[t.o=111]="o",t[t.p=112]="p",t[t.q=113]="q",t[t.r=114]="r",t[t.s=115]="s",t[t.t=116]="t",t[t.u=117]="u",t[t.v=118]="v",t[t.w=119]="w",t[t.x=120]="x",t[t.y=121]="y",t[t.z=122]="z",t[t.OpenCurlyBrace=123]="OpenCurlyBrace",t[t.Pipe=124]="Pipe",t[t.CloseCurlyBrace=125]="CloseCurlyBrace",t[t.Tilde=126]="Tilde",t[t.U_Combining_Grave_Accent=768]="U_Combining_Grave_Accent",t[t.U_Combining_Acute_Accent=769]="U_Combining_Acute_Accent",t[t.U_Combining_Circumflex_Accent=770]="U_Combining_Circumflex_Accent",t[t.U_Combining_Tilde=771]="U_Combining_Tilde",t[t.U_Combining_Macron=772]="U_Combining_Macron",t[t.U_Combining_Overline=773]="U_Combining_Overline",t[t.U_Combining_Breve=774]="U_Combining_Breve",t[t.U_Combining_Dot_Above=775]="U_Combining_Dot_Above",t[t.U_Combining_Diaeresis=776]="U_Combining_Diaeresis",t[t.U_Combining_Hook_Above=777]="U_Combining_Hook_Above",t[t.U_Combining_Ring_Above=778]="U_Combining_Ring_Above",t[t.U_Combining_Double_Acute_Accent=779]="U_Combining_Double_Acute_Accent",t[t.U_Combining_Caron=780]="U_Combining_Caron",t[t.U_Combining_Vertical_Line_Above=781]="U_Combining_Vertical_Line_Above",t[t.U_Combining_Double_Vertical_Line_Above=782]="U_Combining_Double_Vertical_Line_Above",t[t.U_Combining_Double_Grave_Accent=783]="U_Combining_Double_Grave_Accent",t[t.U_Combining_Candrabindu=784]="U_Combining_Candrabindu",t[t.U_Combining_Inverted_Breve=785]="U_Combining_Inverted_Breve",t[t.U_Combining_Turned_Comma_Above=786]="U_Combining_Turned_Comma_Above",t[t.U_Combining_Comma_Above=787]="U_Combining_Comma_Above",t[t.U_Combining_Reversed_Comma_Above=788]="U_Combining_Reversed_Comma_Above",t[t.U_Combining_Comma_Above_Right=789]="U_Combining_Comma_Above_Right",t[t.U_Combining_Grave_Accent_Below=790]="U_Combining_Grave_Accent_Below",t[t.U_Combining_Acute_Accent_Below=791]="U_Combining_Acute_Accent_Below",t[t.U_Combining_Left_Tack_Below=792]="U_Combining_Left_Tack_Below",t[t.U_Combining_Right_Tack_Below=793]="U_Combining_Right_Tack_Below",t[t.U_Combining_Left_Angle_Above=794]="U_Combining_Left_Angle_Above",t[t.U_Combining_Horn=795]="U_Combining_Horn",t[t.U_Combining_Left_Half_Ring_Below=796]="U_Combining_Left_Half_Ring_Below",t[t.U_Combining_Up_Tack_Below=797]="U_Combining_Up_Tack_Below",t[t.U_Combining_Down_Tack_Below=798]="U_Combining_Down_Tack_Below",t[t.U_Combining_Plus_Sign_Below=799]="U_Combining_Plus_Sign_Below",t[t.U_Combining_Minus_Sign_Below=800]="U_Combining_Minus_Sign_Below",t[t.U_Combining_Palatalized_Hook_Below=801]="U_Combining_Palatalized_Hook_Below",t[t.U_Combining_Retroflex_Hook_Below=802]="U_Combining_Retroflex_Hook_Below",t[t.U_Combining_Dot_Below=803]="U_Combining_Dot_Below",t[t.U_Combining_Diaeresis_Below=804]="U_Combining_Diaeresis_Below",t[t.U_Combining_Ring_Below=805]="U_Combining_Ring_Below",t[t.U_Combining_Comma_Below=806]="U_Combining_Comma_Below",t[t.U_Combining_Cedilla=807]="U_Combining_Cedilla",t[t.U_Combining_Ogonek=808]="U_Combining_Ogonek",t[t.U_Combining_Vertical_Line_Below=809]="U_Combining_Vertical_Line_Below",t[t.U_Combining_Bridge_Below=810]="U_Combining_Bridge_Below",t[t.U_Combining_Inverted_Double_Arch_Below=811]="U_Combining_Inverted_Double_Arch_Below",t[t.U_Combining_Caron_Below=812]="U_Combining_Caron_Below",t[t.U_Combining_Circumflex_Accent_Below=813]="U_Combining_Circumflex_Accent_Below",t[t.U_Combining_Breve_Below=814]="U_Combining_Breve_Below",t[t.U_Combining_Inverted_Breve_Below=815]="U_Combining_Inverted_Breve_Below",t[t.U_Combining_Tilde_Below=816]="U_Combining_Tilde_Below",t[t.U_Combining_Macron_Below=817]="U_Combining_Macron_Below",t[t.U_Combining_Low_Line=818]="U_Combining_Low_Line",t[t.U_Combining_Double_Low_Line=819]="U_Combining_Double_Low_Line",t[t.U_Combining_Tilde_Overlay=820]="U_Combining_Tilde_Overlay",t[t.U_Combining_Short_Stroke_Overlay=821]="U_Combining_Short_Stroke_Overlay",t[t.U_Combining_Long_Stroke_Overlay=822]="U_Combining_Long_Stroke_Overlay",t[t.U_Combining_Short_Solidus_Overlay=823]="U_Combining_Short_Solidus_Overlay",t[t.U_Combining_Long_Solidus_Overlay=824]="U_Combining_Long_Solidus_Overlay",t[t.U_Combining_Right_Half_Ring_Below=825]="U_Combining_Right_Half_Ring_Below",t[t.U_Combining_Inverted_Bridge_Below=826]="U_Combining_Inverted_Bridge_Below",t[t.U_Combining_Square_Below=827]="U_Combining_Square_Below",t[t.U_Combining_Seagull_Below=828]="U_Combining_Seagull_Below",t[t.U_Combining_X_Above=829]="U_Combining_X_Above",t[t.U_Combining_Vertical_Tilde=830]="U_Combining_Vertical_Tilde",t[t.U_Combining_Double_Overline=831]="U_Combining_Double_Overline",t[t.U_Combining_Grave_Tone_Mark=832]="U_Combining_Grave_Tone_Mark",t[t.U_Combining_Acute_Tone_Mark=833]="U_Combining_Acute_Tone_Mark",t[t.U_Combining_Greek_Perispomeni=834]="U_Combining_Greek_Perispomeni",t[t.U_Combining_Greek_Koronis=835]="U_Combining_Greek_Koronis",t[t.U_Combining_Greek_Dialytika_Tonos=836]="U_Combining_Greek_Dialytika_Tonos",t[t.U_Combining_Greek_Ypogegrammeni=837]="U_Combining_Greek_Ypogegrammeni",t[t.U_Combining_Bridge_Above=838]="U_Combining_Bridge_Above",t[t.U_Combining_Equals_Sign_Below=839]="U_Combining_Equals_Sign_Below",t[t.U_Combining_Double_Vertical_Line_Below=840]="U_Combining_Double_Vertical_Line_Below",t[t.U_Combining_Left_Angle_Below=841]="U_Combining_Left_Angle_Below",t[t.U_Combining_Not_Tilde_Above=842]="U_Combining_Not_Tilde_Above",t[t.U_Combining_Homothetic_Above=843]="U_Combining_Homothetic_Above",t[t.U_Combining_Almost_Equal_To_Above=844]="U_Combining_Almost_Equal_To_Above",t[t.U_Combining_Left_Right_Arrow_Below=845]="U_Combining_Left_Right_Arrow_Below",t[t.U_Combining_Upwards_Arrow_Below=846]="U_Combining_Upwards_Arrow_Below",t[t.U_Combining_Grapheme_Joiner=847]="U_Combining_Grapheme_Joiner",t[t.U_Combining_Right_Arrowhead_Above=848]="U_Combining_Right_Arrowhead_Above",t[t.U_Combining_Left_Half_Ring_Above=849]="U_Combining_Left_Half_Ring_Above",t[t.U_Combining_Fermata=850]="U_Combining_Fermata",t[t.U_Combining_X_Below=851]="U_Combining_X_Below",t[t.U_Combining_Left_Arrowhead_Below=852]="U_Combining_Left_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_Below=853]="U_Combining_Right_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below=854]="U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below",t[t.U_Combining_Right_Half_Ring_Above=855]="U_Combining_Right_Half_Ring_Above",t[t.U_Combining_Dot_Above_Right=856]="U_Combining_Dot_Above_Right",t[t.U_Combining_Asterisk_Below=857]="U_Combining_Asterisk_Below",t[t.U_Combining_Double_Ring_Below=858]="U_Combining_Double_Ring_Below",t[t.U_Combining_Zigzag_Above=859]="U_Combining_Zigzag_Above",t[t.U_Combining_Double_Breve_Below=860]="U_Combining_Double_Breve_Below",t[t.U_Combining_Double_Breve=861]="U_Combining_Double_Breve",t[t.U_Combining_Double_Macron=862]="U_Combining_Double_Macron",t[t.U_Combining_Double_Macron_Below=863]="U_Combining_Double_Macron_Below",t[t.U_Combining_Double_Tilde=864]="U_Combining_Double_Tilde",t[t.U_Combining_Double_Inverted_Breve=865]="U_Combining_Double_Inverted_Breve",t[t.U_Combining_Double_Rightwards_Arrow_Below=866]="U_Combining_Double_Rightwards_Arrow_Below",t[t.U_Combining_Latin_Small_Letter_A=867]="U_Combining_Latin_Small_Letter_A",t[t.U_Combining_Latin_Small_Letter_E=868]="U_Combining_Latin_Small_Letter_E",t[t.U_Combining_Latin_Small_Letter_I=869]="U_Combining_Latin_Small_Letter_I",t[t.U_Combining_Latin_Small_Letter_O=870]="U_Combining_Latin_Small_Letter_O",t[t.U_Combining_Latin_Small_Letter_U=871]="U_Combining_Latin_Small_Letter_U",t[t.U_Combining_Latin_Small_Letter_C=872]="U_Combining_Latin_Small_Letter_C",t[t.U_Combining_Latin_Small_Letter_D=873]="U_Combining_Latin_Small_Letter_D",t[t.U_Combining_Latin_Small_Letter_H=874]="U_Combining_Latin_Small_Letter_H",t[t.U_Combining_Latin_Small_Letter_M=875]="U_Combining_Latin_Small_Letter_M",t[t.U_Combining_Latin_Small_Letter_R=876]="U_Combining_Latin_Small_Letter_R",t[t.U_Combining_Latin_Small_Letter_T=877]="U_Combining_Latin_Small_Letter_T",t[t.U_Combining_Latin_Small_Letter_V=878]="U_Combining_Latin_Small_Letter_V",t[t.U_Combining_Latin_Small_Letter_X=879]="U_Combining_Latin_Small_Letter_X",t[t.LINE_SEPARATOR=8232]="LINE_SEPARATOR",t[t.PARAGRAPH_SEPARATOR=8233]="PARAGRAPH_SEPARATOR",t[t.NEXT_LINE=133]="NEXT_LINE",t[t.U_CIRCUMFLEX=94]="U_CIRCUMFLEX",t[t.U_GRAVE_ACCENT=96]="U_GRAVE_ACCENT",t[t.U_DIAERESIS=168]="U_DIAERESIS",t[t.U_MACRON=175]="U_MACRON",t[t.U_ACUTE_ACCENT=180]="U_ACUTE_ACCENT",t[t.U_CEDILLA=184]="U_CEDILLA",t[t.U_MODIFIER_LETTER_LEFT_ARROWHEAD=706]="U_MODIFIER_LETTER_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_RIGHT_ARROWHEAD=707]="U_MODIFIER_LETTER_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_UP_ARROWHEAD=708]="U_MODIFIER_LETTER_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_DOWN_ARROWHEAD=709]="U_MODIFIER_LETTER_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING=722]="U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING",t[t.U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING=723]="U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING",t[t.U_MODIFIER_LETTER_UP_TACK=724]="U_MODIFIER_LETTER_UP_TACK",t[t.U_MODIFIER_LETTER_DOWN_TACK=725]="U_MODIFIER_LETTER_DOWN_TACK",t[t.U_MODIFIER_LETTER_PLUS_SIGN=726]="U_MODIFIER_LETTER_PLUS_SIGN",t[t.U_MODIFIER_LETTER_MINUS_SIGN=727]="U_MODIFIER_LETTER_MINUS_SIGN",t[t.U_BREVE=728]="U_BREVE",t[t.U_DOT_ABOVE=729]="U_DOT_ABOVE",t[t.U_RING_ABOVE=730]="U_RING_ABOVE",t[t.U_OGONEK=731]="U_OGONEK",t[t.U_SMALL_TILDE=732]="U_SMALL_TILDE",t[t.U_DOUBLE_ACUTE_ACCENT=733]="U_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_RHOTIC_HOOK=734]="U_MODIFIER_LETTER_RHOTIC_HOOK",t[t.U_MODIFIER_LETTER_CROSS_ACCENT=735]="U_MODIFIER_LETTER_CROSS_ACCENT",t[t.U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR=741]="U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_HIGH_TONE_BAR=742]="U_MODIFIER_LETTER_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_MID_TONE_BAR=743]="U_MODIFIER_LETTER_MID_TONE_BAR",t[t.U_MODIFIER_LETTER_LOW_TONE_BAR=744]="U_MODIFIER_LETTER_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR=745]="U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK=746]="U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK=747]="U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_UNASPIRATED=749]="U_MODIFIER_LETTER_UNASPIRATED",t[t.U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD=751]="U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_UP_ARROWHEAD=752]="U_MODIFIER_LETTER_LOW_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD=753]="U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD=754]="U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RING=755]="U_MODIFIER_LETTER_LOW_RING",t[t.U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT=756]="U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT=757]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT=758]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_LOW_TILDE=759]="U_MODIFIER_LETTER_LOW_TILDE",t[t.U_MODIFIER_LETTER_RAISED_COLON=760]="U_MODIFIER_LETTER_RAISED_COLON",t[t.U_MODIFIER_LETTER_BEGIN_HIGH_TONE=761]="U_MODIFIER_LETTER_BEGIN_HIGH_TONE",t[t.U_MODIFIER_LETTER_END_HIGH_TONE=762]="U_MODIFIER_LETTER_END_HIGH_TONE",t[t.U_MODIFIER_LETTER_BEGIN_LOW_TONE=763]="U_MODIFIER_LETTER_BEGIN_LOW_TONE",t[t.U_MODIFIER_LETTER_END_LOW_TONE=764]="U_MODIFIER_LETTER_END_LOW_TONE",t[t.U_MODIFIER_LETTER_SHELF=765]="U_MODIFIER_LETTER_SHELF",t[t.U_MODIFIER_LETTER_OPEN_SHELF=766]="U_MODIFIER_LETTER_OPEN_SHELF",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROW=767]="U_MODIFIER_LETTER_LOW_LEFT_ARROW",t[t.U_GREEK_LOWER_NUMERAL_SIGN=885]="U_GREEK_LOWER_NUMERAL_SIGN",t[t.U_GREEK_TONOS=900]="U_GREEK_TONOS",t[t.U_GREEK_DIALYTIKA_TONOS=901]="U_GREEK_DIALYTIKA_TONOS",t[t.U_GREEK_KORONIS=8125]="U_GREEK_KORONIS",t[t.U_GREEK_PSILI=8127]="U_GREEK_PSILI",t[t.U_GREEK_PERISPOMENI=8128]="U_GREEK_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_PERISPOMENI=8129]="U_GREEK_DIALYTIKA_AND_PERISPOMENI",t[t.U_GREEK_PSILI_AND_VARIA=8141]="U_GREEK_PSILI_AND_VARIA",t[t.U_GREEK_PSILI_AND_OXIA=8142]="U_GREEK_PSILI_AND_OXIA",t[t.U_GREEK_PSILI_AND_PERISPOMENI=8143]="U_GREEK_PSILI_AND_PERISPOMENI",t[t.U_GREEK_DASIA_AND_VARIA=8157]="U_GREEK_DASIA_AND_VARIA",t[t.U_GREEK_DASIA_AND_OXIA=8158]="U_GREEK_DASIA_AND_OXIA",t[t.U_GREEK_DASIA_AND_PERISPOMENI=8159]="U_GREEK_DASIA_AND_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_VARIA=8173]="U_GREEK_DIALYTIKA_AND_VARIA",t[t.U_GREEK_DIALYTIKA_AND_OXIA=8174]="U_GREEK_DIALYTIKA_AND_OXIA",t[t.U_GREEK_VARIA=8175]="U_GREEK_VARIA",t[t.U_GREEK_OXIA=8189]="U_GREEK_OXIA",t[t.U_GREEK_DASIA=8190]="U_GREEK_DASIA",t[t.U_OVERLINE=8254]="U_OVERLINE",t[t.UTF8_BOM=65279]="UTF8_BOM"})(te||(te={}));var eR=/^\w[\w\d+.-]*$/,tR=/^\//,rR=/^\/\//;function iR(t,e){if(!t.scheme&&e===!0)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${t.authority}", path: "${t.path}", query: "${t.query}", fragment: "${t.fragment}"}`);if(t.scheme&&!eR.test(t.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(t.path){if(t.authority){if(!tR.test(t.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(rR.test(t.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}}function oR(t,e){return!t&&!e?"file":t}function nR(t,e){switch(t){case"https":case"http":case"file":e?e[0]!==mr&&(e=mr+e):e=mr;break}return e}var qe="",mr="/",sR=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,ke=class{static isUri(e){return e instanceof ke?!0:e==null?!1:typeof e.authority=="string"&&typeof e.fragment=="string"&&typeof e.path=="string"&&typeof e.query=="string"&&typeof e.scheme=="string"&&typeof e.fsPath=="function"&&typeof e.with=="function"&&typeof e.toString=="function"}constructor(e,r,i,o,n,s=!1){typeof e=="object"?(this.scheme=e.scheme||qe,this.authority=e.authority||qe,this.path=e.path||qe,this.query=e.query||qe,this.fragment=e.fragment||qe):(this.scheme=oR(e,s),this.authority=w(r,qe),this.path=nR(this.scheme,w(i,qe)),this.query=w(o,qe),this.fragment=w(n,qe),iR(this,s))}get fsPath(){return ig(this,!1)}with(e){if(e==null)return this;let{scheme:r,authority:i,path:o,query:n,fragment:s}=e;return r===void 0?r=this.scheme:r===null&&(r=qe),i===void 0?i=this.authority:i===null&&(i=qe),o===void 0?o=this.path:o===null&&(o=qe),n===void 0?n=this.query:n===null&&(n=qe),s===void 0?s=this.fragment:s===null&&(s=qe),r===this.scheme&&i===this.authority&&o===this.path&&n===this.query&&s===this.fragment?this:new Ya(r,i,o,n,s)}static parse(e,r=!1){let i=sR.exec(e);if(!i)return new Ya(qe,qe,qe,qe,qe);let o=i[2]||qe,n=xp(i[4]||qe),s=(i[5]||qe).split("/").map(xp).join("/"),a=o==="psfile"&&s.startsWith("//")?s.slice(1):s,m=xp(i[7]||qe),c=xp(i[9]||qe);return new Ya(o,n,a,m,c,r)}static file(e){let r=qe;if(R&&(e=e.replace(/\\/g,mr)),e[0]===mr&&e[1]===mr){let i=e.indexOf(mr,2);i===-1?(r=e.substring(2),e=mr):(r=e.substring(2,i),e=e.substring(i)||mr)}return new Ya("file",r,e,qe,qe)}static from(e){return new Ya(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...r){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let i;return R&&e.scheme==="file"?i=ke.file(wp.win32.join(ig(e,!0),...r)).path:i=wp.posix.join(e.path,...r),e.with({path:i})}isRootPath(){return this.path==null||this.path===mr}get pathBase(){return this.isRootPath()?"":p(this.path,e=>Rw(e.split(mr),T))}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(mr))})}join(...e){return this.with({path:Vt(this.path,mr)+e.join(mr)})}toString(e=!1){return og(this,e)}toJSON(){return this}[uM.inspect.custom](){return this.toString()}},aR=Jx?1:void 0,Ya=class extends ke{constructor(){super(...arguments);this._formatted=null;this._fsPath=null}get fsPath(){return this._fsPath==null&&(this._fsPath=ig(this,!1)),this._fsPath}toString(e=!1){return e?og(this,!0):(this._formatted==null&&(this._formatted=og(this,!1)),this._formatted)}toJSON(){let e={$mid:1};return this._fsPath!=null&&(e.fsPath=this._fsPath,e._sep=aR),this._formatted!=null&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),this.query&&(e.query=this.query),this.fragment&&(e.fragment=this.fragment),e}},cM={[te.Colon]:"%3A",[te.Slash]:"%2F",[te.QuestionMark]:"%3F",[te.Hash]:"%23",[te.OpenSquareBracket]:"%5B",[te.CloseSquareBracket]:"%5D",[te.AtSign]:"%40",[te.ExclamationMark]:"%21",[te.DollarSign]:"%24",[te.Ampersand]:"%26",[te.SingleQuote]:"%27",[te.OpenParen]:"%28",[te.CloseParen]:"%29",[te.Asterisk]:"%2A",[te.Plus]:"%2B",[te.Comma]:"%2C",[te.Semicolon]:"%3B",[te.Equals]:"%3D",[te.Space]:"%20"};function pM(t,e){let r,i=-1;for(let o=0;o<t.length;o++){let n=t.charCodeAt(o);if(n>=te.a&&n<=te.z||n>=te.A&&n<=te.Z||n>=te.Digit0&&n<=te.Digit9||n===te.Dash||n===te.Period||n===te.Underline||n===te.Tilde||e&&n===te.Slash)i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r!==void 0&&(r+=t.charAt(o));else{r===void 0&&(r=t.substr(0,o));let s=cM[n];s!==void 0?(i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r+=s):i===-1&&(i=o)}}return i!==-1&&(r+=encodeURIComponent(t.substring(i))),r!==void 0?r:t}function lR(t){let e;for(let r=0;r<t.length;r++){let i=t.charCodeAt(r);i===te.Hash||i===te.QuestionMark?(e===void 0&&(e=t.substr(0,r)),e+=cM[i]):e!==void 0&&(e+=t[r])}return e!==void 0?e:t}function ig(t,e){let r;return t.authority&&t.path.length>1&&t.scheme==="file"?r=`//${t.authority}${t.path}`:t.path.charCodeAt(0)===te.Slash&&(t.path.charCodeAt(1)>=te.A&&t.path.charCodeAt(1)<=te.Z||t.path.charCodeAt(1)>=te.a&&t.path.charCodeAt(1)<=te.z)&&t.path.charCodeAt(2)===te.Colon?e?r=t.path.substr(1):r=t.path[1].toLowerCase()+t.path.substr(2):r=t.path,R&&(r=r.replace(/\//g,"\\")),r}function og(t,e){let r=e?lR:pM,i="",{scheme:o,query:n,fragment:s}=t,{authority:a,path:m}=t;if(o&&(i+=o,i+=":"),(a||o==="file")&&(i+=mr,i+=mr),a){let c=a.indexOf("@");if(c!==-1){let h=a.substr(0,c);a=a.substr(c+1),c=h.indexOf(":"),c===-1?i+=r(h,!1):(i+=r(h.substr(0,c),!1),i+=":",i+=r(h.substr(c+1),!1)),i+="@"}c=a.indexOf(":"),c===-1?i+=r(a,!1):(i+=r(a.substr(0,c),!1),i+=a.substr(c))}if(m){if(m.length>=3&&m.charCodeAt(0)===te.Slash&&m.charCodeAt(2)===te.Colon){let c=m.charCodeAt(1);c>=te.A&&c<=te.Z&&(m=`/${String.fromCharCode(c+32)}:${m.substr(3)}`)}else if(m.length>=2&&m.charCodeAt(1)===te.Colon){let c=m.charCodeAt(0);c>=te.A&&c<=te.Z&&(m=`${String.fromCharCode(c+32)}:${m.substr(2)}`)}i+=r(m,!0)}return n&&(i+="?",i+=r(n,!1)),s&&(i+="#",i+=e?s:pM(s,!1)),i}function fM(t){try{return decodeURIComponent(t)}catch{return t.length>3?t.substr(0,3)+fM(t.substr(3)):t}}var dM=/(%[0-9A-Za-z][0-9A-Za-z])+/g;function xp(t){return t.startsWith("xn--")?(0,mM.toUnicode)(t):t.match(dM)?t.replace(dM,e=>fM(e)):t}function Pm(t){return ke.isUri(t)?t:ke.parse(t)}var Em=bp(t=>K(t,jr),{maxSize:128,ttlMs:E});B(()=>{j(()=>ng.unset()),Wt.onChange(()=>ng.unset())});var ng=l(async()=>b(Wt(),t=>Nc(t.map(e=>[Em(e.uuid),e.mountpoint]))));function hM(t,e){if(P(t)||e==null||P(e.uuid))return;let r=ai(t),i=ai(e.mountpoint);if(!r.normalize().startsWith(i.normalize()))return;let o=Ui(r.slice(i.length),"/");return ke.from({scheme:_o,authority:Em(e.uuid),path:o})}function sg(t,e){return(0,vp.join)(t,...e.split("/").slice(1))}async function gM(t,e){if(t.scheme!==_o)throw new Error("invalid URI: "+t+" (bad scheme)");if(P(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=e!=null&&e.includes(vp.sep);if(r){let o=await $a(e);if(o?.uuid!=null&&Em(o.uuid)===t.authority)return sg(e,t.path)}let i=await b(ng(),o=>o.get(t.authority));if(T(i))return sg(i,t.path);if(r)return sg(e,t.path)}var yM=M(require("path"));var bM=ke.from({scheme:to,path:""});function wM(t){let e=u.libraryPath.value;if(P(e)||P(t)||!t.startsWith(e))return;let r="/"+yc({nativePath:e},{nativePath:t});return ke.from({scheme:to,path:r})}function xM(t){if(t.scheme!==to)throw new Error("invalid URI: "+t+" (bad scheme)");let e=u.libraryPath.value;if(P(e))throw new Error("invalid URI: "+t+" (no library set)");return(0,yM.join)(e,...t.path.split("/"))}var ks=M(require("path"));function vM(t,e){if(!P(t)){if(e!=null&&e.remote===!0&&T(e.remoteHost)&&T(e.remoteShare))return ke.from({scheme:pi,authority:e.remoteHost,path:ks.posix.join("/"+e.remoteShare,He(ai(t),ai(e.mountpoint)))});if(t.startsWith("\\\\"))return ke.file(t).with({scheme:pi})}}async function TM(t,e){if(t.scheme!==pi)throw new Error("invalid URI: "+t+" (bad scheme)");if(P(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=t.path.split("/").slice(1),i=r[0];if(P(i))throw new Error("invalid URI: "+t+" (missing share)");if(R)return`\\\\${t.authority}\\${r.join(ks.sep)}`;let o=r.slice(1),n=await Wt();for(let s of D(n))if(!!s.remote&&ot(s.remoteShare,i)&&await kS(t.authority,s.remoteHost))return(0,ks.join)(s.mountpoint,...o);if(await ln(e))return(0,ks.join)(e,...o)}var mR=["http:","https:","file:",_o,pi].map(t=>t+"//");function SM(t){let e=d(t).toLowerCase();return mR.some(r=>e.startsWith(r))}var uR=l(()=>f("UriNormalization"));function MM(t){try{return ke.parse(t).toString()}catch(e){return uR().warn("Failed to normalize invalid URI",{uri:t,err:e}),t}}function cR(t,e){try{if(t==null||e==null)return!1;let r=ke.parse(t),i=ke.parse(e);return r.scheme===i.scheme&&r.authority===i.authority&&r.path.normalize()===i.path.normalize()}catch{return!1}}async function PM(t,e){try{if(t==null||e==null)return!1;if(yo(t,e))return!0;let r=t.toString(),i=e.toString();return cR(r,i)?!0:await Aa(Os(r),Os(i),(o,n)=>o.normalize()===n.normalize(),()=>!1)}catch{return!1}}var EM=l(()=>f("FileURI"));async function No(t,e){if(t==null||P(t))return EM().throw("empty nativePath passed to nativePath2uri()",{retriable:!1});let r=l(()=>ye(e,()=>$a(t)));return $t(()=>wM(t),async()=>hM(t,await r()),async()=>vM(t,await r()),()=>ke.file(t))}function pR(t){try{return ke.isUri(t)?t:ke.parse(t,!0)}catch(e){EM().warn("bad URI",{uri:t,err:e});return}}async function Os(t,e){if(P(t))return;let r=pR(t);if(r!=null)switch(r.scheme){case"file":return r.fsPath;case _o:return gM(r,e);case pi:return TM(r,e);case to:return xM(r);default:throw new Error("unsupported URI: "+t)}}async function fR(t){let e=await De.instance().executeJsonToA(["Get-Item -Force -LiteralPath",vs(t.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return W(e).flatMap(r=>r[0]).flatMap(r=>r.Mode).filter(T).flatMap(r=>r.includes("h")||r.includes("s")).getOrElse(()=>!1)}async function dR(t){try{let e=await ue("stat",["-f","%f",t.nativePath],{timeout:10*v}),r=V(e);return r!=null?(r&32768)>0:!1}catch(e){return!1}}function Tp(t){return t.base.startsWith(".")?!0:R?fR(t):de?dR(t):!1}function AM(t,e,r){let i={};try{for(let o of t)for(let n of Tt(o)){let s=o[n]();if(i[n]=w(s,!1),s===!0)return s}return!1}finally{DM(r,e,i)}}function DM(t,e,r){let i=r==null?"warn":"debug";t.log(i,e,r)}async function FM(t,e,r){let i={};try{for(let o of t)for(let n of Tt(o)){let s=await o[n]();if(i[n]=s,s)return s}return!1}finally{DM(r,e,i)}}var ag=class{constructor(){this.store=new Map}add(e,r){Pr(this.store,e,()=>new Set).add(r)}delete(e,r){p(this.store.get(e),i=>{i.delete(r),i.size===0&&this.store.delete(e)})}find(e){return rn(e.findIndex((r,i)=>this.store.get(r)?.has(e[i+1])),r=>e.slice(r,r+2))}has(e){return this.find(e)!=null}};var hR=l(()=>f("NeverIgnoredPaths")),gR=l(()=>{u.neverIgnored.addListener(()=>{Dm.clear(),zr(),hR().info("Settings.neverIgnored changed",u.neverIgnored.value)}),u.scanPaths.addListener(()=>{Dm.clear(),zr()}),j(()=>Dm.clear())}),Dm=l(()=>(gR(),new Set(z([...u.scanPaths.values,...u.neverIgnored.values]))));function Xa(t){return Dm().has(t)||Dm().has(t.toLowerCase())}function lg(...t){u.neverIgnored.push(...z(t).map(rv))}function LM(t){return Xa(t)?{pathIsNeverIgnored:()=>!1}:void 0}var IM=M(require("path"));var yR=/^\.?NoMedia$/i,kM="NoMedia";function OM(t){return[t,t.toLowerCase(),t.toUpperCase()]}var bR=Object.freeze([...OM("."+kM),...OM(kM)]);function Sp(t){return yR.exec(t)!=null}var Mp=new Yi({maxSize:1024,timeoutMs:Rt,clearEveryMs:E});B(()=>j(()=>Mp.clear()));B(()=>ar(t=>{t==null?Mp.clear():Mp.deleteIf(e=>e.startsWith(t))}));var Pp=l(()=>f("hasNoMedia()"));async function ro(t){return t==null?!1:Xa(t.nativePath)?Pp().tap({msg:t+" is never ignored",result:!1}):t instanceof ce?ro(await t.directoryEntry()):Sp(t.base)?Pp().tap({msg:t+" basename is NoMedia",result:!0}):an(t.nativePath).some(Sp)?Pp().tap({msg:t+" parent path is NoMedia",result:!0}):await t.isDirectory()&&await Mp.getOrSetAsync(t.nativePath,async()=>{for(let r of bR)if(await lv((0,IM.join)(t.nativePath,r)))return Pp().tap({msg:t+" is a directory and has a noMedia child, "+r,result:!0});return!1})===!0?!0:t.isRoot?!1:b(t.parent(),ro)}function RM(t){let e=u.maxDuplicatePathElements.valueOrDefault;for(let r of new Set(t))if(Er(t,i=>i===r)>e)return!0;return!1}var Ue=class{constructor(e){this.apply=e}static lift(e){return new Ue(e)}static and(...e){return new Ue(async r=>{for(let i of e)if(!await i.apply(r))return!1;return!0})}static or(...e){return new Ue(async r=>{for(let i of e)if(await i.apply(r))return!0;return!1})}static logged(e,...r){return Uw(r,i=>Xe(i).map(([o,n])=>n.asAsync().logged(e,o)))}static andLogged(e,...r){return this.and(...this.logged(e,...r))}static orLogged(e,...r){return this.or(...this.logged(e,...r))}static async andExplain(e,r){let i=[],o=[];for(let n of r)for(let[s,a]of Xe(n))(await a.apply(e)?i:o).push(s);return{accepted:i,rejected:o}}asAsync(){return this}and(...e){return Ue.and(this,...e)}not(){return new Ue(e=>Et(this.apply(e)))}or(e){return new Ue(async r=>await this.apply(r)||await e.apply(r))}async filter(e){return Zl(e,r=>this.apply(r))}logged(e,r){return new Ue(async o=>{let n=await this.apply(o);return e.log(n?"debug":"info",[fa(r),n?qu("ACCEPT"):Wu("REJECT"),sr(o)].join(" ")),n})}};var wR=f("Snap"),NM=Ue.lift(async t=>{if(!await _M())return!1;let r=an(t.nativePath).indexOf("snap");return r<0?!1:D(await xR()).includes(an[r+1])}),_M=l(async()=>{if(!ut||Ne())return!1;try{return await ue("snap",["--version"],{timeout:10*v,quiet:!0,maxRetries:0}),!0}catch{return!1}}),xR=l(async()=>{if(!await _M())return[];try{return await Io(["Name","Version"],await ue("snap",["list"],{timeout:10*v})).map(t=>t.Name)}catch(t){return wR.warn("snap failed",t),[]}},30*v);var BM=class{constructor(e=ne){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize()));this.ignorableDirectories=new Set(["#snapshot","__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Support","Applications","arangodb","cache","caches","CacheClip","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iMovie Cache","iTunes Cache","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","SteamApps","System Volume Information","System32","temp","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase()));this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/resources\/media\/face/i,/\/facetile[-_]/i,/\/.*?\.photos?library\/(?!(masters?|originals)\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i];this.systemDirs=G(z([_a(),ze("APPDATA"),ze("SYSTEMROOT"),ze("ProgramFiles"),ze("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize()));this.ignorableSubdirs=new ag;ut&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);let r=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",r),this.addIgnorableSubdirs("cygwin",r),this.addIgnorableSubdirs("cygwin64",r),this.addIgnorableSubdirs("local",r),this.addIgnorableSubdirs("Windows",["Boot","Containers","Cursors","Fonts","Help","Installer","Logs","Microsoft.NET","SoftwareDistribution","System","System32","SysWOW64","Temp"]),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...r]),this.addIgnorableSubdirs("lfs",["objects"]),this.addIgnorableSubdirs("var",["cache","crash","games","lib","local","lock","log","mail","run","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);let i=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",i),this.addIgnorableSubdirs("Perl64",i),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(ze("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("temp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),R&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,r){if(P(e))return;let i=e.toLowerCase().normalize();z(r).forEach(o=>this.ignorableSubdirs.add(i,o.toLowerCase().normalize()))}ignorablePathPredicates(e){let r=LM(e);if(r!=null)return r;let i=e.toLowerCase().normalize(),o=z(an(i));return{hiddenPosix:()=>o.some(n=>n.startsWith(".")),systemDir:()=>this.systemDirs.some(n=>i.startsWith(n)),ignorableRoot:()=>this.ignorableRootDirectories.has(o[0]),ignorableDirectory:()=>o.some(n=>this.ignorableDirectories.has(n)),ignorablePath:()=>this.ignorableSubdirs.has(o),ignorablePattern:()=>{let n=ai(e);return this.ignorableDirectoryPatterns.some(s=>s.test(n))}}}ignorablePath(e){return AM([this.ignorablePathPredicates(e)],e,f("ignorablePath()"))}},CM=l(()=>new BM);function vR(t){return g(g({},CM().ignorablePathPredicates(t)),{notExists:()=>X.for(t).notExists()})}function Am(t){return CM().ignorablePath(t)}function Ep(t){return Am(t.nativePath)}function TR(t){let e=t.nativePath.toLowerCase().normalize();return Xa(t.nativePath)||Xa(e)?{pathIsNeverIgnored:()=>!1}:g(g({},vR(t.nativePath)),{snapDirectory:async()=>ut&&await NM.apply(t),noMedia:async()=>await ro(t)===!0,hidden:()=>Tp(t),seemsRecursive:()=>RM(t.pathnames),mountpoint:async()=>he(xt(),r=>r.includes(t.nativePath),()=>!1)})}async function Dp(t){return FM([TR(t)],t.nativePath,f("ignorableDirectory()"))}var UM=new om;var X=class extends ce{constructor(e,r){super(e,r);this.nativePath=e;this.pflog=l(()=>f("PosixFile("+this.nativePath+")"));this.uriObject=l(()=>No(this.nativePath));this.uri=l(()=>b(this.uriObject(),d));this.fileuri=l(()=>ke.file(this.nativePath).toString());this.mountpoint=l(()=>R&&this.nativePath.startsWith("\\\\")?this.for(this.nativePath.split("\\").slice(0,4).join("\\")):b(xt(),e=>this.bestMountpoint(e.map(r=>this.for(r)))));this.etag=l(()=>b(this.stat(),e=>[e.size,e.mtime.getTime()].map(r=>un.encode(r)).join("-")));this.isMountpoint=l(async()=>await this.isDirectory()&&await he(xt(),e=>e.includes(this.nativePath),()=>!1));this.sidecars=l(async()=>{if(this.isSidecar())return[];let e=await this.parent().childDirectoryEntries(i=>i.base!==this.base&&Tm(i.ext)&&(i.name===this.name||i.name===this.base||(u.matchSidecarsCaseInsensitively.valueOrDefault?ot(i.name,this.name)||ot(i.name,this.base):!1)||qr(i.name)===qr(this.name)||(u.matchSidecarsCaseInsensitively.valueOrDefault?ot(qr(i.name),qr(this.name)):!1)));if(e==null)return[];let r=e.map(i=>this.parent()._directoryEntryChild(i));return Kl(r,i=>i.maxStatMs())});this.shaWithSidecars=l(async()=>{let e=[this,...await this.sidecars()].map(i=>i.nativePath);return(await Ac(dr(e))).toString("base64")},ce.attrTTL)}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(P(e))throw new Error("unexpectedly empty path");if(e instanceof X)return e;if(e instanceof ce)return this.for(e.nativePath,r);if(SM(e))throw new Error("use forUri");let i=UM.get(e);if(i!=null)return i;let o=Wr(e);return UM.getOrSet(o,()=>new X(o,r))}static forPosix(e){return this.for(e.replace(/\//g,VM.sep))}static forUri(e,r){return b(Os(e,r),i=>this.for(i))}for(e,r){return X.for(e,r)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.sidecars.unset(),this}bestMountpoint(e){return dt(e.filter(r=>sn(this.nativePath,r.toString())).map(r=>X.for(r)),r=>W(Vl(this.pathnames,r.pathnames)).filter(i=>i>=r.pathnames.length).get())}async isDeleted(e){if(e=await oi(e,()=>this.uri()),this.isUNC)return this.pflog().tap({result:void 0,msg:"isDeleted(): UNC not supported"});if(await this.exists())return this.pflog().tap({result:!1,msg:"isDeleted(): file exists"});if(e==null)return this.pflog().tap({result:void 0,level:"warn",msg:"isDeleted(): missing URI"});if(e=Pm(e),e.isRootPath())return this.pflog().tap({result:void 0,msg:"isDeleted(): uri isRootPath",meta:{uri:e}});if(d(e.pathBase).normalize()!==this.base.normalize())return this.pflog().tap({level:"warn",result:void 0,msg:"isDeleted(): uri isn't correct",meta:{uri:e,expectedBase:this.base,uriBase:e.pathBase}});let r=await this.parent().isDeleted(e.parent());return r==null?this.pflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{uri:e}}):this.pflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted, which means I am deleted.",meta:{parentDeleted:r,uri:e}})}async httpHeaders(){return{ETag:await this.etag(),"Last-Modified":await this.lastModifiedUtc()}}async hide(){let e=await(R?ue("attrib",["+h",this.nativePath],{timeout:10*v}).catch(r=>r):de?ue("chflags",["hidden",this.nativePath],{timeout:10*v}).catch(r=>r):"");if(T(e)){this.pflog().warn("hide("+this.nativePath+") failed: "+e);return}else return this.clear()}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}async mkNoMedia_(){if(await this.isFile())throw new Error("mkNoMedia(): "+this+" is a file.");await this.mkdirp_();let e=this.join(".NoMedia");await e.isNotDirectory()&&await e.isEmpty()&&(await e.writeTxt_(["This directory's contents are excluded from PhotoStructure libraries.","","See <https://photostructure.com/nomedia/> for details."].join(`
`)),zr(this.nativePath))}async mkNoMedia(){try{return await this.mkNoMedia_(),this}catch(e){this.pflog().warn("Could not add .NoMedia file to "+this,e);return}}hasNoMedia(){return ro(this)}ignorableCheap(){return Am(this.nativePath)}async ignorable(){return await this.isDirectory()?Dp(this):Ep(this)}hidden(){return Tp(this)}isSidecar(){return Tm(this.ext)}async sidecar(){return Dt(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+Ui(u.defaultSidecarType.valueOrDefault,".").toLowerCase()))}async jsonSidecars(){let e=await this.siblings(r=>ot(r.ext,".json")&&(r.name===this.name||r.name===this.base||qr(r.name)===qr(this.name)));return this.pflog().tap({msg:"jsonSidecars()",result:e==null?void 0:await Kl(e,r=>r.maxStatMs())})}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",async()=>{let e=await this.mtimeMs(),r=await this.sidecars(),i=await Promise.all(D(r).map(n=>n.mtimeMs())),o=[e,...i].filter(k);return Me(o,n=>Math.floor(Math.max(...n)))})}thisOrSidecareMaxMtimeSec(){return b(this.thisOrSidecareMaxMtimeMs(),e=>Wi(e))}};var SR=l(()=>{u.cacheDir.addListener(()=>io.unset())}),io=l(()=>{try{SR();let t=X.for(u.cacheDir.valueOrDefault);return t.mkNoMedia_(),t}catch(t){throw J("Failed to set up cacheDir"+ge,t),t}},E);var kr=11,Or=3;var WM=l(()=>f("StatsDbDir"));async function MR(){return he(io().clear().children(),t=>t.filter(e=>e.name.startsWith(mg)),()=>[])}var mg="sync-state-";async function Fm(t=!0){let e=[];e.push(["Asset version",Or]),e.push(["Asset file version",kr]),e.push(["Library path",u.libraryPath.value]);let r=jr(I(e),10,Ec),i=io().join(mg+r);return t&&(await(0,zM.mkdirp)(i.nativePath),await i.join("README.txt").applyIfEmpty_(o=>o.writeTxt_(`This folder holds state for library synchronization of

${u.libraryPath.value}

If you delete or modify the contents of this directory, you will need to
restart PhotoStructure. The next sync will rescan all your drives.

If you have any questions, please visit <https://photostructure.com/support/>.

`+e.map(([n,s])=>`${n}: ${s}`).join(`
`)).catch(n=>{WM().warn("Failed to write README to "+i,n)})),WM().info("Set up statsDbDir dir "+i)),i}async function PR(t){let e=w(t,await Fm());if(!e.name.startsWith(mg))throw new Error("Refusing to remove directory "+e);await e.rmrf()}async function Ap(){for(let t of await MR())await PR(t)}var qM={beforeParse:t=>t.option("--force","Deletes prior cached directory metadata to force directory contents to be re-scanned"),afterParse:async t=>{O(t.force)&&(u.forceSync.tmpValue=!0,await Ap())}};var jM={beforeParse:t=>t.option("--no-filter,--noFilter","Disables import filters. All paths will try to be imported, even if they are too small or are missing tags."),afterParse:async t=>{O(t.noFilter)&&(u.minAssetFileSizeBytes.tmpValue=0,u.requireMakeModel.tmpValue=!1,u.minImageDimension.tmpValue=0,u.minVideoDimension.tmpValue=0)}};var HM={beforeParse:t=>t.option("--rebuild","Rebuild your library by re-importing all your photos and videos (slow!)"),afterParse:async t=>{O(t.rebuild)&&(u.rebuild.tmpValue=!0)}};var GM={beforeParse:t=>t.option("--skip-updates,--skipUpdates","DANGEROUS: If you want to immediately import specific files or directories and skip any pending library maintenance tasks (like library rebuilds), use this argument. Note that asset aggregation may be incorrect after using this command if there are updates pending."),afterParse:t=>{O(t.skipUpdates)&&(u.skipModelUpdates.tmpValue=!0)}};var fL=M(require("batch-cluster")),Rb=M(require("process"));var fg=M(require("process")),ER=M(require("timers"));function Fp(t){return t!=null&&L(t.warn)||ug(t)}function ug(t){return t!=null&&L(t.bad)||cg(t)}function cg(t){return t!=null&&L(t.fail)}function pg(t){return{ok:D(t.ok),warn:D(t.warn),bad:D(t.bad),fail:D(t.fail)}}function Lp(...t){t=A(t);function e(r){return G(A(pe(t.map(r))))}return{ok:e(r=>r.ok),warn:e(r=>r.warn),bad:e(r=>r.bad),fail:e(r=>r.fail)}}var dg="--exit",DR=l(()=>f("ChildService"));async function KM(t){let e=Vt(t,".js"),r=ce.projectRoot(),i=ce.for((0,fg.cwd)()),o=Lo?[r.join("bin",e),r.join("app.asar",e)]:[i.join("dist","library",e),i.join("lib","library",e)];o.push(i.join("dist","app",e));let n=Zn(o,async s=>await s.isNonEmpty(101)?s:void 0);return DR().tap({msg:"pathToService()",level:"info",result:n,meta:{cmd:e,isPacked:Lo,dirs:o.map(d)}})}var AR=0;function FR(t){switch(t){case"web":return 9223;case"sync":return 9224;case"sync-file":return 9225+AR++%20;default:return 9222}}function JM(t){let e=[];return u.inspect.valueOrDefault&&e.push("--inspect="+FR(t)),e}var Ii=class extends we{constructor(e){super(e.name,()=>{p(this.timer,clearInterval),this.timer=void 0},w(e.rank,Q.first),()=>Z(e._isEnded,r=>r(),()=>!1),e.endTimeoutMs);this.setup(e)}async setup(e){k(e.initialDelayMs)&&await nt(e.initialDelayMs),!this.ended&&(this.timer=Ur(e.callback,Math.round(e.intervalMs),...D(e.args)))}};var Ip=class extends Ii{constructor(e,r,i,o=!0){super({name:"TmpfileCleanup",intervalMs:re(10*v,15*E,r/5),callback:()=>this.cleanup()});this.root=e;this.maxAgeMs=r;this.filter=i;this.scheduleCleanup=o;this.mutex=new tt;this.lastCleanupFinishTs=0}async cleanup(e=this.maxAgeMs){return this.ended||Date.now()-this.lastCleanupFinishTs<10*v?void 0:this.mutex.maybeRun("cleanup",()=>this._cleanup(e))}async _cleanup(e){let r=await this.root();if(r==null)return[];let i=Date.now()-e,o=[];await r.clear().visitDescendants(async s=>{let a=await s.maxStatMs();await s.isFile()&&a!=null&&!(s.parent().eql(r)&&Sp(s.base))&&await this.filter(s)&&a<i&&(o.push(s),await s.unlink().catch(m=>this.logger.warn("Failed to unlink "+s,m)))});let n=o.length;return this.logger.info("Removed "+n+" files."),await r.clear().visitDescendants(async s=>{if(s.clear(),await s.isDirectory()&&!await s.hasNoChildren()){let a=await s.childDirectoryEntries();L(a)&&a.map(h=>h.nativePath).every(h=>o.some(x=>x.nativePath===h))&&await Be(()=>s.rmdir(),{timeoutMs:7*v})&&o.push(s)}await s.isDirectory()&&await s.hasNoChildren()&&(o.push(s),await s.rmdir().catch(a=>this.logger.warn("Failed to rmdir "+s,a)))}),this.logger.info("Pruned "+(o.length-n)+" empty directories."),this.lastCleanupFinishTs=Date.now(),o}};var mA=M(require("file-type")),uA=M(require("fs-extra")),cA=M(require("path"));var eA=M(require("exiftool-vendored")),tA=M(require("path"));var hg=M(require("os"));async function gg(t){let e=R?"where":"which";try{let r=await Ke(e,[t],{timeout:H,ignoreExitCode:!0,ignoreStderr:!0});return r.code===0&&T(r.result)?r.result.trim().split(`
`)[0]?.trim():void 0}catch{return}}async function yg(t){return t!=null&&await t.exists()?t.nativePath:void 0}async function kp(t,e){let r=p(Hr.Tools(),o=>ce.for(o));if(si&&(r==null||await r.isNotDirectory()))throw new Error("Cannot find project path for tools"+ge);function i(o){return r?.join(Qx+"-"+o,w(e,t),t+(R?".exe":""))}return $t(()=>yg(i(hg.default.arch())),()=>hg.default.arch()==="x64"?yg(i("ia32")):void 0,()=>LR(t))}async function LR(t){return $t(()=>gg(t),()=>yg(ce.for(Hr.Bin())?.join(t)),()=>{throw new Error("Cannot find path for "+t)})}var QM=l(()=>kp("dcraw_emu","libraw")),$M=l(()=>kp("raw-identify","libraw")),bg=l(()=>kp("jpegtran")),YM=l(()=>kp("sqlite3"));var Op=new Ce(512);j(()=>Op.clear());ar(t=>t==null?Op.clear():Op.delete(t));var XM=l(()=>f("RawInfo"));async function Rp(t){return Op.getOrSet(t.nativePath,async()=>{try{let e=await $M(),r=await ue(e,["-s",t.nativePath],{timeout:La});return K(r,IR)}catch(e){XM().warn("raw-identify failed",{file:t.nativePath,error:fe(e)});return}})}function IR(t){let[e,r,i,o,n]=t.split("	");return XM().tap({msg:"parseRawInfoOutput()",result:Gn(V(o),V(n),(s,a)=>({Filename:e,Make:r,Model:i,ImageSize:{width:s,height:a}})),meta:{input:t}})}var aD=M(require("os"));function kR(t,e,r=.5){return(1-r)*t+r*e}function Lm(t,e,r){let i=e.x-t.x,n=(r-t.x)/i;return kR(t.y,e.y,n)}function xr(t){return T(t)&&(t.startsWith("video/")||t==="application/mp4"||t==="application/ogg")}function Za(t){return p(t,e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(k))}function wg(t){return oe(t)&&[0,90,180,270].includes(t)}function xg(t){let e=p(t,r=>Ye(r+Math.ceil(-r/360)*360));return wg(e)?e:void 0}function ZM(t){let e=xg(t);return e===90||e===270}function Tn(t){return p(t,e=>Gi(()=>eP(e.Orientation),()=>eP(e.CameraOrientation),()=>xg(e.Rotation)))}var OR=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function eP(t){return p(t,e=>OR.get(e))}var wme=new Map([[0,1],[90,6],[180,3],[270,8]]);function tP(t){return t!=null&&k(t.width)&&k(t.height)}function Qr(t){return`${t.width} \xD7 ${t.height}`}function rP(t){return Tx(t.width*t.height)}function vg(t){return{width:t.height,height:t.width}}function iP(t,e){return ZM(e)?vg(t):t}function oP(t){return t.width/t.height<1}function Rr(t){return nc(t.width*t.height)}var RR=l(()=>f("SizeInfo"));function _s(t,e,r){let i=Ze([r?.ImageSize,{width:t.ImageWidth,height:t.ImageHeight}],s=>tP(s)?s:void 0);if(RR().debug("extractSizeInfo()",{filename:t.FileName,mimetype:t.MIMEType,rawInfo:r,fileDimensions:i}),i==null)return;let o=iP(i,e),n=ve(o.width/o.height,5);return{ImageHeight:o.height,ImageWidth:o.width,aspectRatio:n,dimensions:o,rotation:e,fileDimensions:i}}var _R=E,Tg=15*E,NR=10,BR={p0:{x:.8*je,y:4*v},p1:{x:20*je,y:12*v}},Sg={p0:{x:11*je,y:12*v},p1:{x:26*je,y:24*v}},nP={p0:{x:7*je,y:45*v},p1:{x:32*je,y:90*v}};function sP(t){return Fi(t.ext)?Math.max(w(se(t.durationMs,e=>e*NR),0),Lm(nP.p0,nP.p1,t.bytes)):0}function aP(t){return b(CR(t),e=>e.result)}function CR(t){return b(VR(t),UR)}function VR(t){return b(t.size(),async e=>({bytes:e,ext:t.ext,durationMs:Fi(t.ext)?await b(ct(t),r=>se(r.Duration,i=>i*v)):void 0}))}function lP(t){return Lm(Sg.p0,Sg.p1,re(11*je,100*je,w(t,0)))}function UR(t){let e=re(.5*je,64*Eo,t.bytes),r=5*v,i=H,o=2*e*gc,n=S=>Lm(S.p0,S.p1,re(.5*je,50*je,e)),s=n(BR),m=As(t.ext)?.includes(We.RawImage)===!0?n(Sg):0,c=sP(t),h=u.validateVideos.valueOrDefault?c:0;return{result:re(_R,Tg,Math.round(r+i+o+s+m+c+h)),dbMs:r,tagMs:i,copyMs:o,thumbMs:s,rawDecodeMs:m,transcodeMs:c,validateMs:h}}var _p=new Ce(256);B(()=>j(()=>_p.clear()));B(()=>va((t,e)=>{_p.getOrSet(t,()=>[]).push(e),_p.getOrSet(e,()=>[]).push(t)}));function zR(t){return[t.toString(),...D(_p.get(t.toString()))]}function mP(t,e,r){for(let o of zR(t)){let n=r.get(o);if(n!=null)return n}let i=e(t);return r.set(t.toString(),i),i}var Np=Se("plus","lite");var uP=`
Hello, and thank you for using PhotoStructure!

The files in this folder support your PhotoStructure Library, including

  * a database with the filepaths to your photos and movies
  * previews and thumbnails of your photos and movies
  * content metadata about these assets, like ratings and sharing information
  * albums that both you and PhotoStructure Curators have assembled

Moving or deleting any files here will cause problems using your library.

If you have any questions, please visit <https://photostructure.com/support/>.

Sincerely,

Your Friendly Neighborhood PhotoStructure, v${wt}`;function qt(t=u.libraryPath.value){return K(t,e=>X.for(e).join(".photostructure"))}function Ns(t=u.libraryPath.value){return K(t,e=>X.for(e).join(u.originalsDir.valueOrDefault))}async function Bp(t){let e=qt(t);if(e==null)throw new Error("empty dataDir");if(await e.mkdirp()==null)throw new Error("Could not mkdirp "+e);await e.mkNoMedia();let r=e.join("README.txt");return await r.size()!==uP.length&&await r.writeTxt_(uP),e}var WR=require("https");async function cP(t,e={}){return e.headers==null&&(e.headers={}),P(e.headers["user-agent"])&&(e.headers["user-agent"]=wi+" v"+wt),new Promise((r,i)=>{let o=WR.request(t.toString(),e);o.setTimeout(w(e.timeout,H),()=>{i(new ae({message:"Timeout fetching <"+t+">",doNotSend:!0,retriable:!0}))}),o.on("response",n=>{let s=[];n.setEncoding("utf8"),n.on("data",a=>s.push(a)),n.on("end",()=>{r({ok:Pt(200,399,n.statusCode),headers:n.headers,body:s.join(""),statusCode:n.statusCode,statusMessage:n.statusMessage})})}).on("error",n=>{i(n)}),p(e.body,n=>o.write(n)),o.end()})}var pP=M(require("zlib"));var fue=l(()=>JSON.parse(Mc("H4sIAAAAAAAAA6tWylWyUqrKyUxS0lEqADKTivJLcjJdUpPzcwuKUouLgyvzkoFSeUCptKL8XCCzDKQqsTjVzATISQRySvKDS4oy89KB3Bwgt7QkzUKpFgCQWYV5WQAAAA==")));function oo(t){return JSON.parse((0,pP.brotliDecompressSync)(Buffer.from(t,"base64")).toString("utf8"))}var Eg=M(require("os"));var fP=M(require("fs/promises"));var qR=l(()=>f("ReadFile"));async function Mg(t){try{return await(0,fP.readFile)(t)}catch(e){qR().info(".readFileMaybe("+t+")",e);return}}var Pg=class{constructor(e,r,i){this.file=e;this.mkObject=r;this.onWrite=i;this.prior=l(()=>this.file.readJson("debug"))}async read(){let e=await this.prior();return f("JsonFileStore").debug("prior "+this.file,e),e??b(this.mkObject(),r=>this.write(r))}async write(e){try{return await this.file.writeJSON_(e,{spaces:2}),await this.prior.set(Promise.resolve(e)),f("JsonFileStore").info("wrote to "+this.file,e),this.onWrite!=null&&await this.onWrite(this.file,e),e}catch(r){throw new ae({cause:r,message:"Failed to write to "+this.file})}}};function jR(){return Ec.safeRandomUid(16,4)}var dP=class extends Pg{constructor(e,r){super(e.join("."+r+"-uid.json"),()=>({uid:jR(),version:wt,type:this.type,createdAt:Date.now()}),i=>i.hide());this.rootDir=e;this.type=r;this.read_=l(()=>he(this.read(),e=>e.uid,()=>"missing!").catch(e=>{throw new ae({cause:e,fatal:!0,message:"Failed to read "+this.rootDir})}))}},Cp=l(()=>p(qt(),t=>new dP(t,"library")));B(()=>{j(()=>{Cp.unset()}),u.libraryPath.addListener(()=>Cp.unset())});var hP=M(require("os"));var HR=/^(?:[0:]+|[f:]+)$/i,gP=l(()=>G(pe(St((0,hP.networkInterfaces)()).map(t=>D(t).map(e=>e.mac))).filter(t=>T(t)&&HR.exec(t)==null)));var GR=l(()=>oo("G7kAIIzUYs0Z7qRuS32pmsUk/UyD8OFBrsHUYemDqh3/zMuNBya1K0GYBazpDR8puUeR5pOPDwrAyLrH9L4GAhPQPWicizajRNayvHKU52siIpE9GddV7bjtHChhuc6wwPIkg/x4NH0P")),fi=Se("cu","lc","lm","mp","wm","li","cm","ma","vl");function yP(t){return ie(G(t.filter(KR)),e=>[fi.indexOf(e.split(":")[0]),e])}function bP(t){return GR()[t]}var wP=15;async function no(t,e){try{let r=d(await e);return P(r)||r.match(/^[\s0:_\/-]*$/)!=null?void 0:t+":"+jr(r.trim(),wP,un)}catch(r){f("toUID").warn("failed",{pfx:t,err:r});return}}var JR=l(()=>new RegExp(`^(${fi.values.join("|")}):[0-9a-zA-Z]{${wP}}$`));function KR(t){return t!=null&&JR().exec(t)!=null}var Bo=l(()=>oo("GwkBABwHdoyzjXCwzccdzUv9+g11VQzlNQjNotPVt0S2zHa8CLMs19auq91f4APvhhMIPZZ0m49e3qooFMQq6ej4jJBRUbv5BmSQzUeTCzW5mdaimgkX4ZqrHjPAjQ8XSSsp+cYQ79EXELnYMzlJwyYHVTq/nMkq900q5+mx2ayLgl3s6O7FgGooQh++7vpBI+Qpw3dCNqYDIfr6zPvUur259BmFMDQjV/hviADXURsBk2HJBesB")),Vp=l(()=>f(Bo().n));async function QR(){return no(fi.li,await Cp()?.read_())}function $R(){return no(fi.cm,(0,Eg.cpus)()[0].model)}function YR(){return gP().map(t=>no(fi.ma,t))}async function XR(){return D(await Wt()).map(t=>no(fi.vl,t.uuid))}async function ZR(){let t=await ue(Bo().c,["-1"],{timeout:5*v});return Vp().tap({msg:Bo().c,result:t.match(/serial.*=\s*([a-z0-9-]{12,})/i)?.[1]})}async function e_(){try{return K(await ZR(),t=>no(fi.lc,t+":"+(0,Eg.cpus)()[0].model))}catch(t){Vp().info(Bo().c+" failed",t);return}}async function r_(){try{let t=await t_();return no(fi.mp,t)}catch(t){Vp().info("ioreg failed",t);return}}async function t_(){return(await ue(Bo().i,Bo().ia,{timeout:5*v})).match(/uuid" = "([a-z0-9-]{12,})"/i)?.[1]}async function i_(){return(await De.instance().executeJson(Bo().w))?.MachineGuid}async function o_(){let t=await i_();return no(fi.wm,t)}var n_=l(async()=>Ne()?[]:ut?[no(fi.lm,Mg(Bo().lv)),no(fi.lm,Mg(Bo().le)),e_()]:de?[r_()]:R?[o_()]:[]);async function Up(){let t=await Promise.all([QR,$R,XR,YR,n_].map(async e=>{try{return await Ee(e(),5*v)}catch(r){return Vp().warn(r)}}));return yP(G(await Gl(t)))}var el=class{constructor(e,r,i,o){this.s=e;this._l=r;this._sids=i;this.meta={src:o}}get l(){return this._l}get ok(){if(this._l==null)return!1;let e=bd(this._sids,this._l.uids),r=G(e.map(s=>s.split(":")[0])),i=A(r.map(s=>bP(s))),o=i.length>=this._l.mat,n=Pt(this._l.iat?.getTime(),this._l.exp?.getTime()+lt,Date.now());return this.meta[Ae().o]=n,this.meta[Ae().u]=o,this.meta[Ae().m]=i,n&&o}cmpVal(){return[this.ok,-Np.indexOf(this.l?.[Ae().T]),this.l?.exp?.getTime()??1,this.meta.matchedSchemes]}cmp(e){return Bt(this.cmpVal(),e.cmpVal())}};var zp=l(()=>f("writeLicense"));async function vP(t){let e=await Dg(t,"candidate");if(e==null)return zp().error("!ok",t);await xP(e,qt()?.join(Ae().d)),await xP(e,ce.for(ci()).join(Ae().d)),tl.unset()}async function s_(t){return(await le(t.childFiles(),async e=>Dg((await e.readFile())?.toString().trim(),e.nativePath))).filter(e=>e.ok&&e instanceof el)}async function xP(t,e){if(e==null)return;if((await s_(e)).some(i=>i.cmp(t)>=0)){zp().info("saveIfBetter(): no-op for "+e);return}else{let i=e.join(jr(t.s)+".txt");return await i.writeFile_(t.s).then(()=>(zp().info("saveIfBetter(): wrote to "+i),i)).catch(o=>{zp().error("saveIfBetter(): failed to save license to "+e,o)})}}var Co=l(()=>f(so().l)),so=l(()=>oo("G9YAwIzTFfOihHWPgG6m/h0h65IqCersIGkdlq6+6ra6+PjQ8mHlRTkDg6UJJqPJEIU6WaIUNodfF2xPB7iLWJDlIN8z6xhOKyn4qqHpZlh6qCZUoQghd4BVMkz3A0IIevFn+7UO7uM+VGJb/MeZXfHngpQWZzk=")),TP=l(async()=>{let t=so().s+": ";try{if(!u[so().s].valueOrDefault)return Co().debug(t+"no-op (settings disabled)");let e=(await tl()).filter(n=>n.l!=null&&T(n.s)),r=new Date,i=e.find(n=>n.ok&&r<n.l.exp);if(i!=null)return Co().debug(t+"no-op: ",i);let o=await ce.for(ci()).join(so().s).mkdirp_();for(let n of e){if(P(n.s)||n.l==null||r<n.l.exp)continue;let s=n.l.uids.find(a=>a.startsWith("cu:"));if(s==null){Co().debug(t+"skipping (no cu)",n);continue}await o.join(cn(n.s,14)+".txt").applyIfEmpty_(async a=>{await a_(s),await a.writeJSON_({l:n.l,at:Date.now()}),Co().warn(t+"requested",n)})}}catch(e){Co().warn(t+"failed",e)}},15*E);async function a_(t){try{let e=await Up();if(N(e))return Co().warn("no-op: empty sids");let r=I({uids:[...e,t]}),i=g(g({},so().r),{body:r}),o=await cP(so().u,i);Co().info(so().u,{req:i,response:o}),o.ok?await vP(JSON.parse(o.body)?.[so().a]):Co().warn(so().u,{req:i,response:o})}catch(e){Co().warn(so().u,e)}}var FE=M(AE());var il=l(()=>oo("G9AAICwK7KZhK2gx/dEjjDHuEVVxShG2PVDGAcBqBqP3binicrOwzdRXMfMKd00dlj6bnSYcBaK1S8KWhAGGv73Zu73eMMKnXGoKt4NsAefjf3tdIWcHCM4FdbL+J+haq7GA2/ps1jHled6Oe+3j+k+BBQbgzzJmnLDvnTnXr11NbkL3X+vvWdyYILH9urnb+EV39HOm4Y5Hcrfqyt5i5iCfpGaVUqOnNfYDdeWC8wV2OWE=")),zpe=l(()=>{try{return require(il().c)[il().m](il().o)}catch(t){J(il().m+ge,t)}});function LE(t){return FE.V2[il().w](t,il().o)}var Ae=l(()=>oo("GwwBABwHdkzj5qg5WDnubFuq7NaxSKjiobwK4iGSLDp98J87fqD679bWgnaVtCVBQAEFBJm7aiN4y7puJw8PPz+CHDoAhk5Fd0AhTjKYPbo8F5freFUJHhQHc2xp4qfyoqKKAmGb7IkFZwkajH7uJCR829lmguhEXw/iusqUQE4nk7LeJyad4wmdptoVln0otnUOO3UHnEyjrxtXUr7B")),IE=l(()=>f(Ae().l));async function $N(t){let e=await LE(Ui(d(t).trim(),Ae().p)),r=$h(e[Ae().i]);if(r==null)throw new Error("bad "+Ae().i+": "+e[Ae().i]+" ("+t+")");let i=$h(e[Ae().r]);if(i==null)throw new Error("bad "+Ae().r+": "+e[Ae().r]+" ("+t+")");return e[Ae().a]=e[Ae().a]>=0?e[Ae().a]:2,e[Ae().i]=new Date(r),e[Ae().r]=new Date(i),e[Ae().b]=d(e.uids).split(","),e}async function Vg(t,e){try{return new el(t,await $N(t),await Up(),e)}catch(r){return IE().tap({msg:Ae().v,result:{s:t,ok:!1,meta:{err:r}}})}}async function Dg(t,e){if(P(t))return;let r=await Vg(t,e);return O(r?.ok)&&r instanceof el?r:void 0}var tl=l(async()=>{let t=A([qt()?.join(Ae().d),ce.for(ci()).join(Ae().d)]),e=pe(await Da(t,o=>o.childFiles())),r=pe(await Da(e,async o=>K(D(await o.readLines()).map(n=>n.trim()).join(""),n=>Vg(n,o.nativePath))));await K(u[Ae().L].value,async o=>r.push(await Vg(o,"Settings")));let i=YN(r);return B(TP),IE().tap({msg:Ae().d+"()",result:i})});async function YN(t){return ie(t,e=>[!e.ok,Np.indexOf(e.l?.[Ae().T]),-(e.l?.exp?.getTime()??1)])}B(()=>tl[Ae().n]=()=>null);function XN(){return b(tl(),t=>t[0]?.ok?t[0]:void 0)}async function ZN(){return Dt(XN()).flatMap(t=>t.l?.[Ae().T]).getOrElse(()=>Ae().f)}async function ol(){try{return await ZN()===Ae().f}catch{return!0}}var e1=R?"NUL":"/dev/null",t1=l(()=>f("jpegtran"));async function kE(t){let e=await bg();try{await Ke(e,["-outfile",e1,t.nativePath],{timeout:30*v,isIgnorableError:Rm})}catch(r){throw new ae({cause:r,doNotSend:!0,fatal:!1,retriable:!1})}}async function OE(t,e){let r=t.wip();t1().info("rotateInPlace("+t+")",e),await r1(t,r,e),await r.unwip_(),zr(t.nativePath)}async function r1(t,e,r){let i=await bg();if(!wg(r))throw new Error("refusing to rotate("+t+", "+r+")");await ue(i,["-copy","all","-trim","-rotate",r.toFixed(0),"-outfile",e.nativePath,t.nativePath],{timeout:E})}var i1=/^\(?Binary data (\d+).*use -b option to extract\)?$/i,Kp=class{constructor(e){this.binaryDataBytes=e}};function RE(t){if(typeof t!="string")return;let e=t.match(i1);return e==null?void 0:new Kp(V(e[1],{defaultValue:0}))}var o1=["image/gif","image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"];function Jp(t){return o1.includes(d(t).toLowerCase())}var n1=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);function En(t){return n1.has(d(t).toLowerCase())}function Qp(t,e){return qn(t.width,e.width)&&qn(t.height,e.height)}function _E(t,e){return jn(t.width,e.width)&&jn(t.height,e.height)}function Oi(t){return b(nl(t.nativePath),e=>({width:e.ImageWidth,height:e.ImageHeight}))}var NE=l(()=>f("HeifConvert"));B(()=>j(()=>$p.unset()));var $p=l(async()=>gg(u.heifConvertPath.valueOrDefault));async function s1(){let t=await $p();return NE().tap({msg:"isHeifConvertSupported()",result:T(t),meta:{heifConvertPath:t}})}async function BE(t){if(!!await s1())return b(ao(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await Ke(u.heifConvertPath.valueOrDefault,["-q",String(u.jpegQuality.valueOrDefault),t.nativePath,r.nativePath],{timeout:H})}catch(i){NE().warn("heif2jpeg(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var CE=l(()=>f("sips")),VE=l(async()=>{try{return await ue("command",["-v","sips"],{timeout:Fr})}catch(t){let e=ce.for("/usr/bin/sips");if(await e.isExecutable())return e.nativePath;CE().info("sips is missing from $PATH",t);return}});async function UE(t){return b(ao(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await Ke("sips",["-s","format","jpeg","-s","formatOptions",String(u.jpegQuality.valueOrDefault),t.nativePath,"--out",r.nativePath],{timeout:H})}catch(i){CE().warn("sips(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var a1=l(()=>f("Heif")),zE=l(async()=>{try{if(de)try{let e=await VE();if(!P(e))return{ok:!0,msg:e}}catch(e){a1().error("Failed to find the sips tool (either in PATH or /usr/bin).",e)}let t=await $p();return{ok:T(t),msg:oi(t,u.heifConvertPath.valueOrDefault+": not installed")}}catch(t){return{ok:!1,msg:fs(t)}}});async function Yp(){return(await zE()).ok}B(()=>j(()=>zE.unset()));var l1=/^image\/hei[fc]$/i;function Cs(t){return l1.exec(d(t))!=null}async function WE(t,e,r,i=1e3){let o=await Be(()=>L(t.listeners(e)),{timeoutMs:i});return o&&t.emit(e,r),o}var jE=M(require("util"));function qE(t,e){let r=t.width/t.height,i=e.width/e.height;if(r>=i){let o=Math.min(e.width,t.width);return{width:o,height:Math.ceil(o/r)}}else{let o=Math.min(e.height,t.height);return{width:Math.ceil(e.height*r),height:o}}}var er=Se("fit","sq");var m1=Se("cover","contain","fill","inside","outside"),Dn;(function(o){let t=l(()=>f("Reducers.Square"));o.name=er.sq,o.fit="cover";function i(n,s){let a=_E(n,s)?g(g({},n),{fit:m1.cover}):void 0;return t().tap({msg:"reduce()",result:a,meta:{max:n,input:s}})}o.reduce=i})(Dn||(Dn={}));var $r;(function(o){let t=l(()=>f("Reducers.Fit"));o.name=er.fit,o.fit="inside";function i(n,s){if(Qp(s,n)){t().trace(`reduce(): input ${Qr(s)} is too small for ${Qr(n)}`);return}return qE(s,n)}o.reduce=i})($r||($r={}));var Yde=require("sharp"),ur=class{constructor(e,r,i,o,n=!0){this.name=e;this.maxWidth=r;this.maxHeight=i;this.reducer=o;this.rotational=n;this.megapixels=l(()=>nc(this.maxWidth*this.maxHeight));this.max={width:r,height:i},ur._Sizes.push(this)}static sq(){return this._Sizes.filter(e=>e.reducer===Dn)}static largestSq(){return dt(this.sq(),e=>e.megapixels())}static fit(){let e=u.previewResolutions.valueOrDefault;return this._Sizes.filter(r=>r.reducer===$r&&e.includes(r.name))}static largestFit(){return dt(this.fit(),e=>e.megapixels())}[jE.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"\xD7"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&oP(e)?vg(this.max):this.max,e)}resize(e,r){return r=r.resize(g(g({},e),{fit:this.reducer.fit,withoutEnlargement:!0})),r}toJpeg({path:e,sh:r,outputSize:i}){return(Rr(i)<2||u.sharpen.valueOrDefault)&&(r=r.sharpen()),r.jpeg({quality:u.jpegQuality.valueOrDefault,progressive:u.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}},Je=ur;Je._Sizes=[],Je.UHD8k=new ur("uhd8k",7680,4320,$r,!1),Je.UHD5k=new ur("uhd5k",5120,2880,$r,!1),Je.UHD=new ur("uhd4k",4096,2160,$r),Je.QHD=new ur("qhd",3120,1440,$r),Je.FHD=new ur("fhd",1920,1080,$r),Je.HD=new ur("hd",1280,720,$r),Je.WVGA=new ur("wvga",720,480,$r),Je.QVGA=new ur("qvga",320,240,$r),Je.QQVGA=new ur("qqvga",160,120,$r),Je.S480=new ur("s480",480,480,Dn),Je.S240=new ur("s240",240,240,Dn),Je.S120=new ur("s120",120,120,Dn),Je.S60=new ur("s60",60,60,Dn);var Xp=f("libraw");var u1=["-T"],c1=["-Z","-"],p1=["-o","1"],f1=["-t","0","-j"];async function HE(t){let e=Date.now(),r=await Oi(t);if(r==null)return Xp.throw("Cannot decode RAW "+t+": no EXIF dimensions."+Si+Gt);let i=Je.largestFit().outputSize(r),o=[];i!=null&&4*Rr(i)<Rr(r)&&(Xp.debug("Large original source: using -h"),o.push("-h"));let n=await QM(),s=[...u1,...c1,...p1,...o,...f1,...u.dcrawEmuArgs.values,t.nativePath],a=5*E,m={encoding:"buffer",timeout:a,maxBuffer:250*je};Xp.debug("dcraw_emu()",{cmd:n,args:s,opts:m});let c=await gn(n,s,a,m),h=async F=>{await WE(c.stdout,"error","Problem from "+t+": "+Mv(F,t.nativePath))||Xp.error("No listeners for error when reading "+t,F),c.kill("SIGINT")};c.on("error",h),c.stderr.on("data",h);let x=lP(await t.size())/7,S=new bs({path:t.nativePath,op:"Converting raw image"},x,()=>Date.now()-e);return c.on("close",()=>S.end()),c.stdout}var Ug=require("sharp"),Vs=f("SharpReadable");async function h1(t,e,r,i){let o=e?.[r];if(!(o instanceof Kp))return;let n=i.width*i.height*.1;if(o.binaryDataBytes==null||o.binaryDataBytes<n){Vs.debug("imgFromExif(): rejecting (too small) "+r,{minBytes:n,val:o});return}let s=await d1(t,r),a=await p(s,Oi);return Vs.tap({msg:"imgFromExif()",meta:{src:t.baseWithGrandparent,tag:r,dim:a,minDim:i},result:a!=null&&Qp(i,a)?s:void 0})}var g1=l(()=>{Ug.simd(u.enableSIMD.valueOrDefault),Ug.cache(u.enableVipsCache.valueOrDefault),Ug.concurrency(qd())});function Us(t,e,r=!1){return Ge(`img.sharpReadable${t.ext.toUpperCase()}`,()=>y1(t,e,r))}async function y1(t,e,r=!1){g1();let o=await ct(t,!r),n=o?.MIMEType;if(o==null||P(n))throw new Error(t+" is not supported (missing mimetype)");if(Cs(n)&&!await Yp()){Vs.warn("sharpReadable(): HEIF file, but heif support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}if(xr(n)&&!await Bm()){Vs.warn("sharpReadable(): video file, but video support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}let s=[],a=Tn(o),m=_s(o,a,En(n)?await Rp(t):void 0);if(m!=null){let x=w(e,{width:m.dimensions.width*.95,height:m.dimensions.height*.95});if(Rr(x)>15&&(r||a==null||a===0)&&!xr(n)){let F=u.embeddedPreviews.valueOrDefault;e!=null&&Rr(e)<1&&F.unshift(...u.embeddedThumbnails.values),s.push(...F.map(U=>()=>h1(t,o,U,x)))}}Cs(n)&&(de&&s.push(()=>UE(t)),s.push(()=>BE(t))),Jp(n)&&s.push(async()=>t),m!=null&&En(n)&&s.push(()=>(Vs.info("sharpReadable() -> dcraw()",{src:t.nativePath,minDim:e}),KE({src:t,desc:"dcraw",suffix:".tiff",f:()=>HE(t)}))),n.startsWith("video/")&&s.push(()=>lr(()=>Nm(t,n),{maxRetries:1}));let c=[],h=await Gx(s,x=>{Vs.warn("strategy failed for "+t+": "+x),c.push(x)});if(h==null)throw w(c[0],new Error("Cannot read "+t+" ("+n+")"));return h}function d1(t,e){let r=e.toLowerCase().endsWith("tiff")?".tiff":".jpg";return b(ao(t,e,r),i=>i.applyIfEmpty_(async o=>{try{return await GE(e,t.nativePath,o.nativePath)}catch(n){Vs.warn("Failed to extract embedded "+e+" from "+t.nativePath+": "+n);return}}))}var b1=require("sharp"),zg=l(()=>f("ValidFile")),Zp=l(()=>new Ce(1024,E));B(()=>j(()=>Zp.prior()?.clear()));B(()=>ar(t=>W(t).forEach(e=>{Zp.prior()?.delete(e)}).orElse(()=>{Zp.prior()?.clear()})));var w1=l(()=>nT(u.validationErrorBlocklist.values,"i"));function Rm(t){return zg().tap({msg:"isIgnorableValidationError",result:w1().exec(fe(t))==null})}async function QE(t){if(await ol()||!u.validateJpegImages.valueOrDefault&&!u.validateVideos.valueOrDefault){zg().debug("no validation for "+t,{validateJpegImages:u.validateJpegImages.valueOrDefault,validateVideos:u.validateVideos.valueOrDefault});return}return mP(t,x1,Zp())}async function x1(t){let e=X.for(t);try{let r=await Rs(e);if(r==null)throw new Error("Cannot validate, no mimetype");if(xr(r))u.validateVideos.valueOrDefault&&(zg().debug("validating "+e),await JE(e,r));else if(r.startsWith("image/")){if(r==="image/jpeg"){if(u.validateJpegImages.valueOrDefault)return await kE(e)}else if(u.validateRawImages.valueOrDefault){let i=await Us(e);if(i==null)throw new Error("Cannot read");await b1(i.nativePath,{failOnError:!0}).tiff().toBuffer()}}else throw new Error("Unsupported mimetype, "+r)}catch(r){throw new ae({cause:r,message:"invalid file "+e,retriable:!1,doNotSend:!0,ignorable:!0})}}var $E=l(()=>f("ffmpeg")),v1=l(()=>re(1,8,Ye(bt()/2))),T1=/ffmpeg version (\S+)/i,Cm=l(async()=>{try{let t=await Ke(u.ffmpegPath.valueOrDefault,["-version"],{timeout:H,ignoreStderr:!0,isIgnorableError:()=>!0}),e=T1.exec(t.result)?.[1];return $E().info("ffmpegVersion",{version:e,code:t.code,stdout:t.result.split(`
`,1)[0]}),t.code===0&&T(e)?e:void 0}catch(t){return}}),YE=l(()=>he(Cm(),t=>"version "+t,()=>"(not found)"));B(()=>j(()=>Cm.unset()));async function XE(){return ye(Cm.prior(),()=>Cm.refresh())}async function ef(){return await Cm()!=null}async function ZE(t){return await t.dest.exists()&&await t.dest.isEmpty()&&await t.dest.unlink(),Ke(u.ffmpegPath.valueOrDefault,A(["-loglevel","error","-i",t.src.nativePath,...ga(t.startAtSec,e=>["-ss",e.toFixed(1)])??[],"-vframes","1","-f","singlejpeg","-y",t.dest.nativePath]),{timeout:E,isIgnorableError:Rm})}async function eD(t){return $E().tap({msg:"ffmpegValidVideo",meta:{src:t.nativePath},result:await Ke(u.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",d(v1()),"-i",t.nativePath,"-f","null","-"],{timeout:w(await aP(t),2*E),isIgnorableError:Rm,ignoreExitCode:!0,quiet:!1})})}var tD=M(require("path"));var sl=l(()=>f("vlc"));function rD(){return he(al().catch(()=>{}),t=>"version "+t.version,()=>"(not found)")}var S1=/VLC (?:version|media player) ([0-9.]+)/i,iD=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"],al=l(()=>M1());B(()=>j(()=>al.unset()));async function oD(){return ye(al.prior(),()=>al.refresh())}async function nD(){return!Jd&&await he(al(),t=>t.version!=null,()=>!1)}function P1(){return b(al(),t=>t.version==null?void 0:t.path)}async function E1(t){return b(Ke(t,[...iD,"--version"],{timeout:H,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),e=>W(e.result).filter(T).map(r=>r.trim()).flatMap(r=>S1.exec(r)).flatMap(r=>r[1]).get())}function D1(t){return b(De.instance().execute(`(Get-Item -path ${vs(t)}).VersionInfo.FileVersion`,e=>e).catch(e=>{sl().warn("Failed to run vlcInfoWin: "+t+": "+e)}),e=>na(e.trim()))}async function M1(){let t=[];function e(...r){t.push(X.for((0,tD.join)(...r)))}if((!R||u.vlcPath.hasValue())&&t.push(u.vlcPath.valueOrDefault),de){let r="/Applications/VLC.app/Contents/MacOS/VLC";K(ze("HOME"),i=>e(i+r)),e(r)}if(R){let r=["VideoLAN","VLC","vlc.exe"];K(ze("LOCALAPPDATA"),i=>{e(i,"Apps",...r)}),K(ze("ProgramFiles"),i=>{e(i,...r)}),K(ze("ProgramFiles(x86)"),i=>{e(i,...r)})}for(let r of t)try{if(r instanceof X&&await r.clear().notExists())continue;let i=r.toString(),o=await(R?D1(i):E1(i));if(P(o)){sl().info("vlcInfo(): no VLC version found for "+r);continue}else return kt({path:i,version:o},n=>sl().info("vlcInfo()",n))}catch(i){sl().warn("vlcInfo(): err:"+i,{path:r})}}async function sD(t){let e=await P1();if(P(e))return sl().throw("vlcFrame(): empty vlcPath",g(g({},t),{ignorable:!0}));let r=He(t.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(r))return sl().throw("vlcFrame(): Invalid destination extension"+Gt,{format:r,args:t});let i=t.startAtSec??0,o=i+1,n=await Ke(e,A([...iD,"--avcodec-hw=none","--video-filter=scene","--scene-format="+r,"--scene-replace","--scene-ratio=500","--scene-path="+t.dest.dir,"--scene-prefix="+t.dest.name,"--start-time="+i.toFixed(1),"--stop-time="+o.toFixed(1),t.src.nativePath,"vlc://quit"]),{timeout:E,ignoreStderr:!0});if(t.dest.clear(),k(n.code))throw new Error("vlc failed: "+I(n));return n}var mD=l(async()=>(0,aD.totalmem)()>16*Nd&&bt()>5&&await ef()?2:1);async function A1(t){return await $t(()=>O(t?.ignoreffmpeg)&&!hr?void 0:b(XE(),e=>({ok:!0,msg:"FFmpeg "+e})),()=>O(t?.ignorevlc)?void 0:b(oD(),e=>({ok:!0,msg:"VLC "+e.version})),()=>({ok:!1,msg:"(no video tools were found)"}))}var Bm=l(async()=>(await A1()).ok);B(()=>j(()=>Bm.unset()));async function Nm(t,e,r){if(!xr(e))return;let i=O(r?.useVlc)?!1:O(await ye(r?.useFfmpeg,()=>ef())),o=!i&&O(await ye(r?.useVlc,()=>nD()));if(!i&&!o)return;let n=f("img/Video.extractVideoFrame("+t+")"),s=await ao(t,"frame",".jpg");n.debug("extractVideoFrame",{dest:s.nativePath,mimetype:e});let a=await t.mtimeMs();if(a==null)return n.throw("null mtime");let m=await ct(t);if(m==null)return n.throw("no tags");let c=Tn(m);n.debug("video orientation:"+c);let h=_s(m,c)?.dimensions,x=await s.stat(),S=x==null?void 0:await Oi(s);if(x!=null&&x.mtimeMs>a&&S!=null&&(h==null||S.height===h.height&&S.width===h.width))return n.debug("prior dest, "+s+" seems reasonable",{srcDim:h,destDim:S}),s;let F=Za(m),U=Math.min(F??0,u.videoFrameAtSec.valueOrDefault);return n.info("extracted metadata",{startAtSec:U,duration:F}),await s.applyWip(async Fe=>{let or=g({src:t,dest:Fe,startAtSec:U},h);await(i?ZE(or):sD(or)),await lD(Fe),o&&c!=null&&c!==0&&(n.info("rotating in place..."+Fe,{rot:c}),await OE(Fe,c))}),s}async function JE(t,e){let r=f("img/Video.validVideo("+t+")");if(await Nm(t,e)==null&&r.throw("Could not extract a video frame"),await ef())return eD(t)}var zD=M(require("luxon"));var At=M(require("exiftool-vendored")),pt=M(require("luxon"));var uD=M(require("luxon"));var Wg=14,F1=l(()=>uD.DateTime.local().offset,ft);function cD(t){return t==null||Math.abs(t)>Wg*60?!1:t===0?F1()===0:!0}var qg=M(require("exiftool-vendored"));var L1=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/,Nr=class{constructor(e,r,i,o=0,n=1){this.start=e;this.middle=r;this.end=i;this.index=o;this.splits=n;this.toISOString=this.toString.bind(this);this.year=zo(this.middle),this.month=Uo(this.middle),this.day=Vo(this.middle)}static fromISO(e){e=d(e).trim();let r=L1.exec(e);if(r==null)return;let i=qg.ExifDateTime.fromISO(r[1]),o=qg.ExifDateTime.fromISO(r[2]),n=V(r[3]),s=V(r[4]);return this.for(i,o,n,s)}static for(e,r,i=0,o=1){if(!vr(e)||!vr(r))return;let n=lo(e),s=lo(r);if(n==null||s==null)return;o=re(1,1e3,V(o,{defaultValue:1})),i=re(0,o-1,V(i,{defaultValue:0}));let a=p(n.toDateTime().until(s.toDateTime()).divideEqually(o+1)[i],m=>m.end);if(a!=null)return new Nr(n,lo(a,w(n.zone,s.zone)),s,i,o)}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return w(this.start.zone,this.end.zone)}get hasTimes(){return _r(this.start)&&_r(this.end)}toString(e=!0){return`${Vm(this.start,e)}/${Vm(this.end,e)}`+(this.index===0&&this.splits===1?"":`/${this.index}/${this.splits}`)}includes(e){if(e==null)return!1;let r=lo(e);return r!=null?this.interval().contains(r.toDateTime()):this.year===zo(e)&&this.month===Uo(e)&&this.day===Vo(e)}};function tf(t,e=2){return t==null?"":vi(t,e,"0")}function vr(t){if(t==null||typeof t=="string"||t===0)return!1;let e=di(t);return e==null||e===0||!pD(zo(t),Uo(t),Vo(t))?!1:_r(t)?Z(I1(t),r=>r.isValid,()=>!1):!0}function ll(t,e){return vr(t)?e(t):void 0}var fD=l(()=>u.minValidYear.valueOrDefault,ft),jg=l(()=>new Date(Date.now()+lt).getFullYear(),ft),dD=l(()=>new Date(Date.now()+lt).getMonth()+1,ft);B(()=>j(()=>{fD.unset(),jg.unset(),dD.unset()}));function k1(t){return Pt(fD(),jg(),t)}function O1(t,e){return Ci(e,jg())&&Rl(t,dD())?!1:Pt(1,12,t)}function R1(t,e,r){return r!=null&&pt.DateTime.fromObject({year:t,month:e,day:r}).isValid}function pD(t,e,r){return k1(t)&&(e==null||O1(e,t)&&(r==null||R1(t,e,r)))}var ml=class{constructor(e,r,i){this.year=e;this.month=r;this.day=i}static for(e,r,i){return pD(e,r,i)?new ml(e,r,i):void 0}static localToday(){return Hg(new Date)}toString(){return A([this.year,this.month,this.day]).map(e=>tf(e)).join("-")}toISOString(){return this.toString()}toDateTime(){return pt.DateTime.fromObject(this)}},hD=class{constructor(e,r,i,o,n){this.monthsToMonth=e;this.re=r;this.yearIndex=i;this.monthIndex=o;this.dayIndex=n}apply(e){let r=this.re.exec(e);if(r!=null){let i=parseInt(r[this.yearIndex],10),o=this.month(r),n=this.dayIndex==null?void 0:parseInt(r[this.dayIndex],10);return ml.for(i,o,n)}else return}month(e){if(this.monthIndex==null)return;let r=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(r)?this.monthsToMonth.get(r):V(r)}},Wo="((?:19|20)[0-9]{2})",gD="(1[0-2]|0[1-9])",_1="(1[0-2]|0?[1-9])",yD="([1-3][0-9]|0[1-9])",rf="([1-3][0-9]|0?[1-9])",N1="(1[0-9]|2[0-3]|0[0-9])",bD="([0-5][0-9])",B1=bD,C1=bD,of="([-\\.\\,:_/ |])",nf=of+"?",V1="(?:(\\.[0-9]+))?",wD="(?:(Z|UTC)|(?:([+-])([01][0-9]):?([0-5][0-9])))",U1=new RegExp("\\d\\d\\s*"+wD,"i");function Gg(t){return p(U1.exec(t),e=>xD(e.slice(1)))}function xD(t,e){if(N(t))return e;let[r,i]=t.splice(0,2),[o,n]=t.splice(0,2).map(s=>V(s));return tn(["z","utc"],r)?0:Ow([i,o,n])?e:(i==="-"?-1:1)*(o*60+n)}function Kg(t){return K(t,e=>cx([()=>At.ExifDateTime.fromEXIF(e),()=>z1(e)],r=>vr(r)))}var W1=l(()=>f("FuzzyDate"));function vD(t,e=!1){if(!P(t))for(let{desc:r,f:i}of[{desc:"DateInterval.fromISO",f:()=>Nr.fromISO(t)},{desc:"parseDateTime",f:()=>Kg(t)},{desc:"DateTime.fromFormat(macOS)",f:()=>pt.DateTime.fromFormat(t,"y-M-d 'at' H.m.s")},{desc:"DateTime.fromFormat(gnome)",f:()=>pt.DateTime.fromFormat(t,"y-M-d H-m-s")},{desc:"DateTime.fromFormat(yMMdd_HHmmss)",f:()=>pt.DateTime.fromFormat(t,"yMMdd_HHmmss")},{desc:"ExifDate.fromEXIF",f:()=>At.ExifDate.fromEXIF(t)},{desc:"fuzzyDate.parseYMD",f:()=>ul().parseYMD(t)},{desc:"new Date()",f:()=>e?new Date(t):void 0}]){let o=i();if(vr(o)){let n=Gg(t);return n!=null&&(o.tzoffsetMinutes=n),W1().tap({msg:"parseDated()",result:o,meta:{s:t,desc:r,tzoffsetMinutes:n}})}}}var TD=class{constructor(e){this.locale=e;this.monthsToMonth=new Map;this.ymdPatterns=[];this.ymPatterns=[];this.yPatterns=[];this.setup()}parseYMD(e){return Ze(this.ymdPatterns,r=>r.apply(e))}addParser(e,r,i,o){let n=new hD(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),r,i,o);o!=null&&i!=null?this.ymdPatterns.push(n):u.fuzzyYearParsing.valueOrDefault&&o==null&&i!=null?this.ymPatterns.push(n):u.fuzzyYearParsing.valueOrDefault&&o==null&&i==null&&this.yPatterns.push(n)}setup(){let e=["short","long"];for(let i of G([this.locale,"en-US"]))for(let o of e){let n=new Intl.DateTimeFormat(i,{month:o});Te(12,s=>{let a=n.format(new Date(2017,s));this.monthsToMonth.set(a.toLowerCase(),s+1)})}let r="("+dr([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(Wo+of+_1+"\\2"+rf,1,3,4),this.addParser(Wo+nf+gD+"\\2"+yD,1,3,4),this.addParser(Wo+nf+r+"\\2"+rf,1,3,4),this.addParser(r+nf+rf+",?\\2"+Wo,4,1,3),this.addParser(rf+nf+r+",?\\2"+Wo,4,3,1),u.fuzzyDateParsing.valueOrDefault&&(this.addParser(r+of+Wo,3,1),this.addParser(Wo+of+r,1,3)),this.addParser(Wo,1)}extractDateFromPath(e){if(!u.usePathsToInferDates.valueOrDefault)return;j1.forEach(i=>{_u(e,i)&&e.splice(0,i.length)}),e=e.filter(i=>T(i)&&e[0].match(q1)==null);let r=[...e].reverse();return Gi(()=>Ze(r,i=>this.parseYMD(i)),()=>this.parseYMD(r.slice(0,4).join(" ")),()=>this.parseYMD(e.slice(0,4).join(" ")),...u.fuzzyDateParsing.valueOrDefault?[()=>Ze(this.ymPatterns,i=>Ze(r,o=>i.apply(o))),()=>Ze(this.ymPatterns,i=>i.apply(e.join(" "))),()=>Ze(this.yPatterns,i=>Ze(r.slice(1),o=>i.apply(o)))]:[])}},q1=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P_?)\d+)$/i,H1=l(()=>{u.fuzzyDateParsing.addListener(()=>ul.unset()),u.fuzzyYearParsing.addListener(()=>ul.unset()),u.usePathsToInferDates.addListener(()=>ul.unset())}),ul=l(()=>(H1(),new TD(void 0))),j1=[];function SD(t){return ul().extractDateFromPath(t)}function Jg(t){return ul().parseYMD(t)}function MD(t){return t!=null&&(t instanceof ml||t instanceof At.ExifDate||t instanceof At.ExifDateTime||t instanceof Date||t instanceof Nr||t instanceof pt.DateTime||Fu([t.year,t.month,t.day]))}function zo(t){return p(t,e=>e instanceof Date?e.getFullYear():e.year)}function Uo(t){return p(t,e=>e instanceof Date?e.getMonth()+1:e.month)}function Vo(t){return p(t,e=>e instanceof Date?e.getDate():e.day)}function G1(t){return _r(t)?t instanceof Date?t.getHours():t.hour:void 0}function PD(t){return _r(t)?t instanceof Date?t.getMinutes():t.minute:void 0}function ED(t){return _r(t)?t instanceof Date?t.getSeconds():t.second:void 0}function DD(t){return _r(t)?t instanceof Date?t.getMilliseconds():t.millisecond:void 0}function AD(t){return _r(t)&&(k(PD(t))||k(ED(t))||k(DD(t)))}function K1(t,e=!0){if(t==null)return;if(t===0)return e?"UTC":"";let r=t<0?"-":"+",i=Ye(t/15)*15,o=Math.abs(i),n=Math.floor(o/60),s=Math.floor(Math.abs(o%60));return`${e?"UTC":""}${r}${tf(n)}:${tf(s)}`}function An(t){return t instanceof At.ExifDateTime?t.hasZone&&cD(t.tzoffsetMinutes):t instanceof pt.DateTime?t.zone!=null&&t.zone.type!=="local":!1}function Qg(t){return t instanceof pt.DateTime?p(t.zone,e=>e.name):t instanceof At.ExifDateTime?t.zone:void 0}function z1(t,e=J1){let r=e.exec(t);if(r==null)return;let i=[...r.slice(1)],[o,n,s,a,m,c]=i.splice(0,6).map(U=>V(U));if(o==null||n==null||s==null||!u.fuzzyDateParsing.valueOrDefault&&(a==null||m==null))return;let h=re(0,999,ni(i.shift(),{defaultValue:0})*1e3),x=xD(i),S=K1(x),F=pt.DateTime.fromObject({year:o,month:n,day:s,hour:a,minute:m,second:c,millisecond:h,zone:S});return F.isValid?lo(F,S):void 0}var Q1="[-:_ ]?",J1=new RegExp([Wo,gD,yD,N1,B1,C1,V1].join(Q1)+wD+"?","i");function I1(t){if(t instanceof pt.DateTime)return t;if(t instanceof At.ExifDateTime)return t.toDateTime();if(t instanceof Nr)return t.middle.toDateTime();if(t instanceof Date)return pt.DateTime.fromJSDate(t)}function lo(t,e){if(t==null||!_r(t))return;if(t instanceof pt.DateTime)return At.ExifDateTime.fromDateTime(t);let r=di(t);if(r==null)return;let i=P(e)?An(t)?Qg(t):void 0:e,o=K(i,s=>$1(r,s));if(e!=null&&o==null)return;let n=p(zo(t),s=>p(Uo(t),a=>p(Vo(t),m=>p(G1(t),c=>new At.ExifDateTime(s,a,m,c,w(PD(t),0),w(ED(t),0),DD(t),o,t.rawValue)))));return vr(n)?n:void 0}function FD(t){if(t==null)return;if(typeof t=="number")return new Date(t);if(t instanceof Date)return t;if(t instanceof pt.DateTime)return t.toJSDate();if(t.toDate!=null)return t.toDate();if(k(t.year)&&k(t.month)&&k(t.day))return new Date(t.year,w(t.month,1)-1,t.day,12);let e=d(t);if(T(e))return p(Y1(e),FD)}function di(t){if(!(t==null||It(t)))return oe(t)?t:t instanceof Date?t.getTime():t instanceof pt.DateTime?t.toMillis():p(FD(t),e=>e.getTime())}function $g(t){if(!(t==null||It(t)))return oe(t)?fp(t):t instanceof At.ExifDateTime||t instanceof pt.DateTime?X1(t):t instanceof Date?fp(t.getTime()):p(di(t),fp)}function X1(t){return parseInt([t.year,t.month,t.day,t.hour,t.minute,t.second].map(e=>Ht(e)).join("")+"00")+cp(t.millisecond??0)}function LD(t){return p(t,e=>e instanceof At.ExifDateTime?e.tzoffsetMinutes:e instanceof pt.DateTime?e.offset:void 0)}function Yg(t){return p(t,e=>e instanceof pt.DateTime||e instanceof At.ExifDateTime||e instanceof Date?0:e instanceof At.ExifDate?lt:e instanceof Nr?e.intervalMs:void 0)}function Vm(t,e=!0){if(t==null)return;if(t instanceof Nr)return t.toString(e);let r=oe(t)?new Date(t):t;return _r(r)?p(lo(r),i=>i.toISOString({includeOffset:e})):Z1(r)}function Y1(t,e){return typeof t!="string"||P(t)?void 0:W(At.ExifDateTime.fromISO(t,e)).orElse(()=>At.ExifDate.fromISO(t)).orElse(()=>At.ExifTime.fromEXIF(t)).get()}function Z1(t,e="-"){return A([zo(t),Uo(t),Vo(t)]).map(r=>tf(r)).join(e)}function Hg(t){return p(t,e=>p(zo(e),r=>new ml(r,Uo(e),Vo(e))))}function ID(t,e){return jn(Xg(t,e),lt)}function Xg(t,e){let[r,i]=[t,e].map(di);return r==null||i==null?void 0:r-i}function _r(t){return t instanceof Date||t instanceof At.ExifDateTime||t instanceof pt.DateTime}function $1(t,e){let r=pt.Info.normalizeZone(e);return r.isValid?r.offset(t):void 0}function kD(t,e){return t instanceof pt.DateTime?t.setZone(e,{keepLocalTime:!0}):lo(t,e)}var qo=class{static lift(e){return new class extends qo{apply(r){return e(r)}}}and(e){return qo.lift(r=>this.apply(r)&&e.apply(r))}or(e){return qo.lift(r=>this.apply(r)||e.apply(r))}filter(e){return e.filter(r=>this.apply(r))}asAsync(){return Ue.lift(e=>Promise.resolve(this.apply(e)))}},vbe=qo.lift(Vi),Tbe=qo.lift(()=>!0);function Um(t){return qo.lift(e=>Ja(e?.ext,t))}var Abe=Um(We.SupportedByCurrentBrowser),Fbe=Um(We.Video),sf=Um(We.AssetFile);var mo=l(()=>f("TagInference"));async function OD(t,e){if(T(e.Make)&&T(e.Model))return;if(P(e.Make)&&(d(e.HandlerDescription)+d(e.CompressorName)).includes("GoPro")){e.Make="GoPro";return}let r=uo(t),i=await Zg(t);if(i==null)return;let o=A(pe(es(i.younger,i.older))).slice(0,50).filter(n=>Dc(uo(n),r)>.7).slice(0,10);mo().info("inferMakeAndModel("+t+"): looking at nearby siblings",o.map(n=>n.base));for(let n of o){let s=await ct(n);if(s!=null&&Qu(s.Make,s.Model)){mo().info("inferMakeAndModel("+t+")",{sibling:n.base,Make:s.Make,Model:s.Model}),e.Make=s.Make,e.Model=s.Model;return}}}async function RD(t){return b(eB(t),({before:e,after:r,index:i,slots:o})=>{if(!ID(e.date,r.date)){mo().debug("inferCapturedAtFromSiblings(): rejecting, not same day",{file:t.nativePath,before:d(e),after:d(r)});return}return p(Nr.for(e.date,r.date,i,o),n=>({date:n,src:`before:${e.src},after:${r.src}`}))})}async function _D(t,e=7){return Zn(D(t).slice(0,e),(r,i)=>b(ct(r),o=>b(af(o),n=>g(g({},n),{index:i}))))}async function tB(t,e=7){return Zn(t.slice(0,e),(r,i)=>b(ct(r),o=>b(af(o),n=>W(n).filter(s=>An(s.date)).flatMap(s=>Qg(s.date)).map(s=>({zoneName:s,index:i})).get())))}B(()=>j(()=>ND.prior()?.clear()));var ND=l(()=>new Ce(1024));function eB(t){return ND().getOrSet(t.nativePath,async()=>{let e=await Zg(t),r=await _D(e?.younger),i=await _D(e?.older);return r==null||i==null?void 0:{before:r,after:i,index:r.index,slots:r.index+i.index+1}})}B(()=>j(()=>BD.prior()?.clear()));var BD=l(()=>new Ce(2048,E));function uo(t){let e=It(t)?t:t.name;return BD().getOrSet(e,()=>(p(/(?:burst)(.{8,})$/i.exec(e),r=>e=r[1]),p(/^(?:(?:dsc[0f]?|img|mov|mvi|mvimg|vid|gpfr|gopro?|gp|gf|p)(?:[-_ ])?)(\S.+)$/i.exec(e),r=>e=r[1]),e.replace(/\s*-?\s*copy( \(?\d+\)?)?\s*$/i,"").replace(/\s*\((another |\d+[a-z]{2} )?copy\)\s*$/i,"").replace(/^[-\s_0]+/,"").replace(/[\s-_][\d\s]{0,2}$/,"").replace(/_cover$/i,"").toLowerCase().normalize()))}var rB=Um(We.AssetFile);async function Zg(t,e=7){let r=await t.parent().childDirectoryEntries(h=>h.isFile()&&!h.name.startsWith(".")&&!Tm(h.ext)&&rB.apply(h));if(r==null){mo().info("nearestSiblings(): can't readdir parent, "+t.parent());return}let i=await t.statTimes();if(N(i)){mo().info("nearestSiblings(): statTimes() missing from "+t);return}let o=ie(r,h=>uo(h)),n=o.findIndex(h=>h.base===t.base);if(n<0){mo().warn("nearestSiblings(): can't find self in siblings: "+t);return}let[s,a]=[o.slice(n-e*2,n),o.slice(n+1,n+1+e*2)],m=[],c=[];for(;L(s)&&m.length<e;){let h=X.forDirectoryEntry(s.pop());await CD(t,h)&&m.push(h)}for(;L(a)&&c.length<e;){let h=X.forDirectoryEntry(a.shift());await CD(t,h)&&c.push(h)}return{younger:m,older:c}}function CD(t,e,r=2*lt){let i=Xg(Jg(t.base),Jg(e.base));return i!=null&&Math.abs(i)>r?!1:t.contemporary(e,r)}async function VD(t){let e=await Zg(t),r=Ww(D(e?.younger),D(e?.older)).slice(0,10);return mo().tap({msg:"nearestSiblingTzOffset("+t+")",result:await b(tB(r),i=>i.zoneName),meta:{zipped:r}})}async function UD(t){let e=Kg(uo(t)),r=p(e,di);if(e==null||r==null){mo().debug("extractStatBname() bname isn't dated",{bname:uo(t),fromName:e,fromNameMs:r});return}let i=await t.stat();if(i==null){mo().debug("extractStatBname() no stat",{fromName:e,fromNameMs:r});return}return mo().tap({msg:"extractStatBname()",result:Ze(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],o=>Math.abs(i[o]-r)<Wg?{src:o,date:e}:void 0),meta:{fromName:e,fromNameMs:r,stat:i}})}var iB=l(()=>f("CapturedAt"));function oB(t){return d(t).toLowerCase().startsWith("tags")}var cl=class{constructor(e,r,i,o,n){this.nativePath=e;this.date=r;this.src=i;this.mtime=o;this.precisionMs=n;this.toISOString=l(()=>Vm(this.date))}spread(e){let r=g(g({},this),e);return new cl(r.nativePath,r.date,r.src,r.mtime)}toLocal(){return $g(this.date)}toOffset(){return LD(this.date)}get isFromTags(){return oB(this.src)}toPrecisionMs(){return w(this.precisionMs,()=>Yg(this.date))}toString(){return I({nativePath:this.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return An(this.date)}hasTime(){return _r(this.date)}};async function sB(t,e,r,i){let o=await r;if(!!vr(o))return An(o)?o:e!=null&&e.tz!=null&&zD.Info.isValidIANAZone(e.tz)?kD(o,e.tz):i?o:nB(t,o)}async function nB(t,e){if(!vr(e))return;if(An(e))return e;let r=await VD(t);if(r!=null){let i=lo(e,r);if(vr(i))return i}return e}function aB(t,e){return t==null||e||!u.usePathsToInferDates.valueOrDefault||!u.useLibraryPathsToInferDates.valueOrDefault&&sn(t.nativePath,u.libraryPath.value)}async function WD(t,e,r){let i=await t.mtime(),o=async(n,s)=>b(s,a=>b(sB(t,e,a.date,r),m=>new cl(t.nativePath,m,z([n,a.src]).join(":"),i,a.precisionMs)));return $t(()=>o("tags",af(e)),()=>o("bname+stat",UD(t)),()=>r?void 0:o("siblings",RD(t)),()=>r||!u.usePathsToInferDates.valueOrDefault?void 0:o("bname",p(vD(uo(t)),n=>({date:n,src:"",precisionMs:Xu([Yg(n),v])}))),()=>aB(t,r)?void 0:o("path",p(SD(t.pathnamesWithoutDrive),n=>({src:"",date:n}))),()=>u.useStatToInferDates.valueOrDefault?o("stat",b(t.minStatDate(),n=>({src:"",date:n}))):void 0)}var qD=["SubSecDateTimeOriginal","SubSecCreateDate","SubSecTimeDigitized","SubSecMediaCreateDate","DateTimeOriginal","OriginalCreateDateTime","CreateDate","DateTimeCreated","DateCreated","DateTimeDigitized","MediaCreateDate","DateTime","SubSecTime","ModifyDate","photoTakenTime"];function jD(t,e){return ll(t[e],r=>({src:e,date:r}))}function af(t){if(t==null)return;let e=A(qD.map(i=>({date:t[i],src:i,ts:p(di(t[i]),o=>Math.floor(o/1e3))}))),r=e.filter(i=>vr(i.date)&&i.ts!=null);return wn(Ut.debug,()=>{iB().debug("capturedAtFromTags()",{rawArr:e,validArr:r})}),Gi(()=>dt(r,i=>p($g(i.ts),o=>[-Math.floor(o/1e8),_r(i.date)?1:0,AD(i.date)?1:0,An(i.date)?1:0,-qD.indexOf(i.src)])),()=>jD(t,"DateTimeUTC"),()=>jD(t,"GPSDateTime"))}var lB=f("ExposureSettings");function HD(t){let e={focalLength:t.FocalLength,iso:Ed(t.ISO,t.ISOSpeed,t.SonyISO),aperture:Ed(t.FNumber,t.Fnumber,t.ApertureValue,t.SonyFNumber),shutterSpeed:aa(t.ExposureTime,t.ShutterSpeed,t.SonyExposureTime)};return lB.debug("extracted from "+t.FileName,{exposureSettings:e}),Ul(e)}function GD(t,e){let r=Math.pow(2,e),i=[];for(;t>0;)i.unshift(t%r),t=Math.floor(t/r);return i}function lf(t){t.dims.forEach(r=>r.value=re(r.min,r.max,r.value));let e=0;for(let r=0;r<t.bitDepth;r++){e*=2;let i=r%t.dims.length,o=t.dims[i],n=Ot([o.min,o.max]);o.value>n?(e+=1,o.min=n):o.max=n}return e}function ey(t,e){if(e.bitDepth>52||e.bitDepth<0)return;let r=mB(t);for(let i=0;i<e.bitDepth;i++){let o=i%e.dims.length,n=e.dims[o],s=Ot([n.min,n.max]);r.includes(e.bitDepth-i-1)?n.min=s:n.max=s}return e.dims.map(i=>Ot([i.min,i.max]))}function mB(t){return t.toString(2).split("").reverse().map((e,r)=>e==="1"?r:-1).filter(e=>e!==-1)}var uB=30;function cB(t){return Math.floor(t/5)*5}function ty(t){return oe(t)&&t!==0&&Pt(-90,90,t)}function ry(t){return oe(t)&&t!==0&&Pt(-180,180,t)}function pB(t,e){return ty(t)&&ry(e)}function KD(t,e){return fB(t,e,30)}function fB(t,e,r=uB){return pB(t,e)?lf({dims:[{min:-180,value:e,max:180},{min:-90,value:t,max:90}],bitDepth:cB(r)}):void 0}function iy(t){return la(t?.timestamp,e=>ll(new Date(e*1e3),r=>r))}async function oy(t){return b(t.readJson("info"),e=>xi({Title:md(e.title),Description:md(e.description),GPSLatitude:Ze([e?.geoData?.latitude,e?.geoData?.latitude],r=>ty(r)?r:void 0),GPSLongitude:Ze([e?.geoData?.longitude,e?.geoData?.longitude],r=>ry(r)?r:void 0),GPSAltitude:Ze([e?.geoData?.altitude,e?.geoData?.altitude],r=>oe(r)?r:void 0),favorited:e.favorited==null?void 0:O(e.favorited),peopleNames:Me([...D(e.people),...D(e.person)],r=>z(r.map(i=>i.name))),creationTime:iy(e.creationTime),modificationTime:iy(e.modificationTime),photoTakenTime:iy(e.photoTakenTime),imageViews:la(e.imageViews,r=>r)}))}function ny(t,e,r=""){let i=t.replace(e,r);return i===t?t:ny(i,e,r)}var dB=["BenQ","GoPro","HTC","LG","NEC","OnePlus","Sony","TrueHDR"],hB=new Map(dB.map(t=>[t.toLowerCase(),t]));function gB(t){let e=t.trim(),r=hB.get(e.toLowerCase());return r??(e.length<4?e:e.toLowerCase().replace(/(?:^|\s|-)\S/g,i=>i.toUpperCase()))}var JD=class{constructor(){this.ignorables=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|");this.ignorableSep="[\\s\\.,_-]*";this.IgnorableMakePatterns=new RegExp(`${this.ignorableSep}(?:${this.ignorables})${this.ignorableSep}$`,"i");this.IgnorableModelPatterns=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i];this.samsungPatterns=[[/^PL150 /,"PL150"],[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-G98[01]/,"Galaxy S20"],[/^SM-G98[56]/,"Galaxy S20+"],[/^SM-G988/,"Galaxy S20 Ultra"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]];this.lgPatterns=[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]];this.onePlusPatterns=[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]];this.CommonNamesByMake={Samsung:this.samsungPatterns,LG:this.lgPatterns,OnePlus:this.onePlusPatterns}}},sy=l(()=>new JD);function zm(t){return K(t,e=>(e=Md(e),e=ny(e,sy().IgnorableMakePatterns),e=e.replace(/\s+app on Apple iDevice$/i,""),e=e.replace(/\bLGE\b/,"LG"),e=gB(e),e))}var yB=/<(.+?)[,/].+>/;function QD(t,e){if(P(t)||P(e))return;let r=Md(e);if(t==="Samsung"){let o=yB.exec(r);o!=null&&(r=o[1])}let i=p(sy().CommonNamesByMake[t],o=>o.find(([n])=>r.match(n)!=null));if(i!=null)return i[1].trim();t==="Sony"&&(r=r.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"\u03B1").replace(/7CL/i,"7c").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V").replace(/M6$/," VI").replace(/M7$/," VII").replace(/M8$/," VIII").replace(/M9$/," IX").replace(/M10$/," X").replace(/M11$/," XI")),t==="Olympus"&&(r=Z(/^(.+?\d)mark(i.+?)$/i.exec(r),o=>`${o[1]} Mark ${o[2]}`,()=>r)),t==="Canon"&&(r=r.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel"));for(let o of sy().IgnorableModelPatterns)r=ny(r,o).trim();return r=r.replace(new RegExp(`^${Ei(t)}\\s+`,"i"),""),t.match(/^HP|Hewlett.Packard$/i)!=null&&r.match(/^hp\b/i)!=null&&(r=r.slice(2).trim()),r}var bB=/\b(n\/a|unknown)\b/i;function wB(t){return t.filter(e=>T(e)&&bB.exec(e)==null)}var $D=l(()=>f("LensMakeModel"));function mf(t){let e=zm(t.LensMake),r=zm(t.Make),i=wB([e,t.LensMake,r,t.Make]),o=a=>(a=XD(a),i.reduce((m,c)=>Zu(m,c).trim(),a)),n=Ze([t.LensInfo,t.LensSpec,t.LensModel,t.LensID],YD),s=A([t.LensID,t.LensModel,t.LensSpec,t.LensInfo]);$D().debug("extractLensMakeModel",{lensMake:e,lensInfo:n,lensModels:s});for(let a of s){let m=YD(a)!=null;if($D().debug("extractLensMakeModel",{lensModel:a,hasLengthAndAperture:m}),!!m){if(T(e))return{lensMake:e,lensModel:o(a),lensInfo:n};if(a.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:o(a),lensInfo:n};for(let c of z([e,r,...u.lensMakes.values]))if(a.toLowerCase().includes(c.toLowerCase()))return i.unshift(c),{lensMake:c,lensModel:o(a),lensInfo:n}}}}function YD(t){if(P(t)||d(t).toLowerCase().includes("unknown"))return;let e=xB(t.replace(/\b(AF-S|DG|Digital|DI|DX|E|ED|HSM|LM|OIS|Pro|R|XF)\b/gi,"")),r=/[\d.-]+mm/.exec(e)?.[0],i=/f\/[\d.-]+/.exec(e)?.[0];if(!(r==="0mm"||i==="f/0"))return oa(r,i,(o,n)=>`${o} ${n}`)}function XD(t,e=3){return t.replace(/\d+\.\d+/g,r=>Z(ni(r),i=>String(ve(i,e)),r))}function xB(t){return XD(t).replace(/(\d) - (\d)/g,(e,r,i)=>`${r}-${i}`).replace(/(\d)\s+mm\b/,(e,r)=>r+"mm").replace(/\s+f\/?(\d)/i,(e,r)=>" f/"+r)}function ZD(t){let e=G(["OLYMPUS DIGITAL CAMERA",t.originalMake,t.originalModel,t.Model,t.Make,t.CameraID]).map(i=>K(i,o=>o.trim().toLowerCase().normalize())),r=(...i)=>{for(let o of i){let n=d(t[o]).trim();if(T(n)&&!e.includes(n.toLowerCase().normalize()))return n}};return xi({title:r("XPTitle","Title","ObjectName"),description:r("XPSubject","Description","ImageDescription","Caption-Abstract")})}var co=l(()=>f("ExifTags")),vB=!1;function TB(){return u.exiftoolProcsPerChild.value??(bt()>4?3:2)}var ay=l(()=>new Ss("ExifTool",new eA.ExifTool({logger:()=>f("ExifTool"),maxProcs:TB(),maxIdleMsPerProcess:5*E,maxTasksPerProcess:u.maxTasksPerProcess.valueOrDefault,cleanupChildProcs:!1}),Q.service,!0).t);function Wm(){let t=ay();return t.ended?ay.refresh():t}function rA(){return p(ay.prior(),t=>t.ended?void 0:Ee(t.version(),H,()=>{throw new Error("ExifTool timed out")}))}va((t,e)=>b(iA(t),r=>{let i=X.for(e);return uf.getOrSetAsync(i.nativePath,()=>Promise.resolve(g(g({},r),{SourceFile:i.nativePath,FileName:i.base,Directory:i.dir})))}));function GE(t,e,r){return Wm().extractBinaryTag(t,e,r)}var uf=new Yi({maxSize:128,timeoutMs:E}),cf=new Yi({maxSize:128,timeoutMs:E});function oA(){uf.clear(),cf.clear()}B(()=>j(oA));ar(t=>{P(t)?oA():(uf.deleteIf(e=>e.startsWith(t)),cf.deleteIf(e=>e.startsWith(t)))});var nA=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];async function sA(t,e){let r=i=>b(ct(i,!1),o=>jt(o,...nA));return await Xn(t.clear().sha(),e.clear().sha())||await Xn(r(t),r(e))}async function qm(t){if(t==null)return;let e=X.for(t);if(!(await e.isEmpty()||await e.isNotReadable()))return Ge("tags.readTags",async()=>b(ct(e),r=>SB(e,r)))}async function iA(t){return uf.get(String(t))}async function Rs(t){if(P(t))return;let e=X.for(t);return $t(()=>b(cf.get(e.nativePath),r=>r.MIMEType),()=>b(iA(e),r=>r.MIMEType),()=>b(_m(e.nativePath),r=>r.mime==="image/tiff"?void 0:r.mime),()=>DS(e.ext)?b(ct(e,!1),r=>r.MIMEType):void 0)}async function nl(t,e){let r=X.for(t),i=e==null||P(e.ImageHeight)?await ct(r):e;if(i==null)return;let o=w(Tn(e),()=>Tn(i)),n=En(i.MIMEType)?await Rp(r).catch(a=>{co().warn("Failed to read raw info",{file:r.nativePath,err:fe(a)})}):void 0,s=_s(i,o,n);if(s!=null)return s;if(xr(i.MIMEType))return b(Nm(r,i.MIMEType),a=>nl(a,i))}async function lD(t){await Wm().deleteAllTags(t.nativePath),await t.sibling(t.base+"_original").unlink("trace")}async function ct(t,e=!0){let r=X.for(t);if(!!await r.isFile())return Ge("tags.readRawTags",async()=>{let i=await aA(r.nativePath);if(i==null||!e)return i;let o=Ea(r.jsonSidecars(),oy),n=Ea(r.sidecars(),a=>aA(a.nativePath)),s=g({},i);for(let[a,m]of[...await o,...await n]){let c=jt(a,...nA);L(St(c))?((s.sidecars??(s.sidecars=[])).push(m.base),ba(s,c),co().debug("readRawTags() sidecar had values",{sidecar:m.base,safeTags:c})):co().debug("readRawTags() sidecar was empty",{sidecar:m.base})}return s})}var ly=new _e,my=new _e;R||(ly.resolve(),my.resolve());async function aA(t){return cf.getOrSetAsync(t,async()=>{co().debug("_readRawTags("+t+") not cached, reading now.");let e=ly.pending;e?ly.resolve():await my.promise;let r=Fi((0,tA.extname)(t))?[]:void 0,i=await Ge("exiftool.read()",()=>Ee(Ca(Wm().read(t,r).catch(o=>{co().info("Failed to read "+t,o)})),H));return e&&my.resolve(),p(i,o=>(co().debug("_readRawTags("+t+") in "+o.elapsedMs+"ms"),p(o.result,n=>{for(let a of Tt(n)){let m=n[a];if(typeof m=="string"){let c=RE(m);c!=null&&(n[a]=c)}}let s=z([n.Error,...w(n.errors,[]),n.Warning].map(d));return L(s)&&(n.problems=s),n.exiftoolMs=o.elapsedMs,vB&&(n.instance=yp()),n})))})}async function SB(t,e){if(e==null)return;let r=e.MIMEType,i=t.nativePath;if(P(r)){co().debug("No mimetype for "+t);return}let o=t.nativePath.startsWith(u.cacheDir.valueOrDefault)||t.pathnames.includes(".photostructure");o||await OD(t,e);let n=e;n.originalMake=e.Make,n.originalModel=e.Model,e.Make=zm(e.Make),e.Model=QD(e.Make,e.Model);let s=mf(e),a=await WD(t,e,o);if(a==null){co().info("No capturedAt for "+t);return}let m=HD(e),c=await nl(t,e);if(c==null){co().info("No size info for "+i);return}let h=r.startsWith("video/")?Za(e):void 0,x=g(g(g(g({mimetype:r,exposureSettings:m},ZD(n)),s),c),{duration:h,capturedAt:a,tz:e.tz});return co().debug("parsedTags",g(g({nativePath:i},x),{capturedAt:p(a,S=>({date:S.date,src:S.src}))})),g(g({},n),x)}var Fn=M(require("fs-extra"));async function lA(t,e=0,r){let i=-1;try{let o=await w(r,()=>b((0,Fn.stat)(t),s=>s.size-e)),n=Buffer.alloc(o);return i=await(0,Fn.open)(t,"r"),await(0,Fn.read)(i,n,0,o,e)}finally{await rn(i,Fn.close)}}B(()=>{j(()=>pf.prior()?.clear()),ar(t=>t==null?pf.prior()?.clear():pf.prior()?.delete(t))});var pf=l(()=>new Ce(512,3*E));async function _m(t){return pf().getOrSet(t,async()=>{let{buffer:e}=await lA(t,0,248);return Dt((0,mA.fromBuffer)(e)).filter(r=>r.mime!=="image/tiff").orElse(()=>Dt(dc((0,uA.stat)(t))).filter(r=>r).flatMap(()=>Wm().readRaw(t,["-mimetype"])).flatMap(r=>r.MIMEType).filter(T).map(r=>({ext:MB(t),mime:r})).get()).get()})}function MB(t){return He((0,cA.extname)(t),".")}var tTe=require("sharp"),PB=l(()=>f("ImgCache")),uy="imgcache";async function zs(){return io().join(uy).mkdirp_().catch(t=>{J("Failed to create imgCache directory"+ge,t)})}async function ao(t,e,r){let i=await t.stat();if(i==null)throw new Error(`cachedImgFile(${t}): unreadable`);let o=await zs();if(o==null)throw new Error("imgcache dir is missing");let n=await _m(t.nativePath);if(n==null)throw new Error("Cannot read filetype for "+t);let s=cn(I({basename:t.base.toLowerCase(),mimetype:n.mime,size:i.size}));r=Ui(r,".");let a=o.join(...en(s.slice(0,24),2,3),e+r);if(await a.parent().mkdirp()==null)throw new Error("Cannot make dest dir, "+a.parent());return PB().debug("cachedImgFile("+t.baseWithGrandparent+")",{desc:e,ext:r,result:a}),a}async function KE({src:t,desc:e,suffix:r,f:i}){try{return await b(ao(t,e,r),o=>o.applyIfEmpty_(async n=>b(i(),s=>n.writeStream_(s))))}catch(o){throw new ae({cause:o,message:"readableToFile() failed"})}}async function ff(t,e){let r=Date.now(),i=0,o=r+u.maxBusyDbMs.valueOrDefault;for(;Date.now()<o;)try{return await t()}catch(n){if(!Hl(n)||Date.now()>=o)throw n;e?.(),await gt(Ct(500,1500)*++i)}throw new Error("handleDbRetries(): timeout after "+u.maxBusyDbMs.valueOrDefault+"ms")}function df(t,e=25){let r;for(let i=0;i<e;i++)try{return t()}catch(o){if(r=o,!Hl(o))throw o}throw r}var EB=l(()=>f("Broadcaster")),cy;(function(e){e.broadcast=async(r,i)=>(EB().warn("broadcast sent to no-op",{event:r,args:i}),!1)})(cy||(cy={}));var py=cy;var hf=py;function pA(t){hf=t}function fA(t){hf===py&&(hf=t)}function jm(t,e){hf.broadcast(t,e)}var dA=M(require("fs-extra")),gf=M(require("os")),fy=M(require("process"));var DB=l(async()=>{if(u.forceOpen.valueOrDefault){let t=qt();t!=null&&await Na(async()=>Promise.all(D(await hA(t)).map(e=>e.unlink())),7*v)}}),gA=ft;function AB(t){return p(t,e=>e.join("opened-by"))}function hA(t){return AB(t)?.clear().children(r=>r.ext===".json")}async function yA(){return Z(qt(),async t=>yd(yf(t),dy(),"hostname","pid"),async()=>!1)}var dy=l(async()=>({hostname:(0,gf.hostname)(),pid:fy.pid})),yf=Li(t=>FB(t),{maxSize:3,timeoutMs:H,clearEveryMs:Ct(7*v,H)});async function FB(t){await DB();let e=!vm(),r=f("currentLibraryLockOwner("+t+")"),i=(0,gf.hostname)(),o=await hA(t);if(N(o)){r.warn("no opened-by files found.");return}let n=await ms(o.map(async ee=>{let nr=await ee.readJson();if(e&&nr==null&&await ee.modifiedCloseTo(Date.now(),H)!==!0){r.warn("unlinking old empty json file: "+ee),await ee.unlink("debug");return}else return g({file:ee},nr)}));r.debug("read",{jsons:n});let s=Date.now()-gA,[a,m]=da(n,ee=>ee.updatedAt>s);e&&L(m)&&(r.debug("Unlinking expired opened-by files:",{minUpdatedAt:s,staleJsons:m}),await Promise.all(m.map(ee=>ee.file?.unlink("debug"))));let[c,h]=da(a,ee=>ee.hostname===i),x=c.map(ee=>ee.pid),S=w(await fT(x),x),[F,U]=da(c,ee=>S.includes(ee.pid));e&&L(U)&&(r.debug("Unlinking zombie opened-by files:",U),await Promise.all(U.map(ee=>ee.file?.unlink())));let Fe=[...F,...h];if(N(Fe)){r.debug("No valid opened-by files.");return}let or=Xo(Fe,ee=>ee.createdAt),$e=Fe.filter(ee=>ee.systemUID===or.systemUID),$=Xo($e,ee=>[hS(ee.serviceName),w(ee.createdAt,()=>Date.now())]);return r.tap({msg:"currentLibraryLockOwner",level:"info",result:$})}j(()=>yf.clear());var hy=class extends we{constructor(e){super("OpenedByIO()",()=>this.onEnd(),Q.postdb);this.ldd=e;this.createdAt=Date.now();this.watchers=[];this.intervalMs=gA/4;this.file=l(()=>this.dir.join(cn((0,gf.hostname)(),7)+"-"+fy.pid+".json"));this.json=l(async()=>g({serviceName:Xt(),createdAt:this.createdAt,updatedAt:Date.now()},await dy()),this.intervalMs/2);this.write_=l(async()=>{let e=await this.json();await this.file().writeJSON_(e),yf.clear()},this.intervalMs/2);this.setup=l(async()=>{if(await this.write_(),Lr())for(let e of this.file().selfAndParents(4))try{let r=(0,dA.watch)(e.nativePath,{persistent:!1,recursive:!1},()=>this.lockOwner.refresh()).on("error",i=>(this.logger.warn("watch().on(error):",i),this.lockOwner.refresh()));this.watchers.push(r)}catch(r){this.logger.warn("Failed to set up watch",{f:e.nativePath,err:r})}});this.lockOwner=l(async()=>{if(!C())return await this.setup(),yf(this.ldd)},7*v);this.dir=e.join("opened-by"),this.timer=Ur(()=>this.write_(),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write_.unset()}refresh_(){return this.clear(),this.write_()}async onEnd(){this.watchers.forEach(e=>e.close()),this.watchers.length=0,p(this.timer,clearInterval),this.timer=void 0,await this.file().unlink()}async deleteAllLocks(e=!1){e?await this.dir.rmrf():await this.dir.visitDescendants(r=>r.eql(this.file())?void 0:r.unlink())}async isLockOwner(){return yd(this.lockOwner(),dy(),"hostname","pid")}async throwIfUnavailable(e){this.logger.debug("throwIfAvailable()",{from:e});let r=await this.lockOwner();if(this.logger.debug("throwIfAvailable()",{from:e,lockOwner:r}),r==null)return;let i=await this.json();if(this.logger.debug("throwIfAvailable()",{from:e,json:i}),r!=null&&r.hostname!==i.hostname)throw this.logger.warn("library is unavailable",{lockOwner:r,json:i}),new Error(`Library is already opened by ${r.hostname} (${r.serviceName}:${r.pid}) ${e}`+(op()?"":ge)+Si+Gt)}};var TA=M(require("net"));var vA=M(require("process"));var bA=M(require("os")),wA=M(require("process"));var LB=0,IB=l(()=>jr((0,bA.hostname)()+String.fromCharCode(31)+wA.pid)+"-");function bf(){return IB()+ds.encode(++LB)}var xA=M(require("util"));var gy=class{constructor(e,r,i,o){this.id=e;this.method=r;this.params=i;this.timer=o;this.start=Date.now();this.name="rpc.RequestResponse("+r+")#"+e,this.d=new Jt(this.name)}[xA.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),p(this.d.settledMs,r=>this.timer.push(this.method,r)))}reject(e){return this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}};var kB=(ne?7:30)*v,OB=ne?500:5*v,RB={requestTTL:kB,retriesPerRequest:5,delayBetweenRetries:OB,maxPendingRequests:10},_B=0,yy=class extends we{constructor(e,r,i={}){super("rpc.Client("+e+"#"+_B+++")",()=>this.onEnd(),Q.first);this.streamFactory=r;this.mkStreamRate=new li(E);this.pending=new Map;this.times=new Va;this.changeListeners=[()=>this.mkStreamRate.onEvent()];this.stream=l(async()=>{try{if(this.flapping)return this.onError("stream() is restarting too frequently (epm: "+this.mkStreamRate.eventsPerMinute+")");let e=await this.streamFactory();return e==null?this.onError("streamFactory() returned null"):(this.changeListeners.forEach(r=>r()),e.on("end",r=>this.onFinish("on(end)",r)),e.on("close",r=>this.onFinish("on(close)",r)),e.on("error",r=>this.onError("stream error",r)),fn(e,`
`,r=>this.onData(r)),e)}catch(e){return this.onError("streamFactory rejection",e)}});this.ping=l(()=>this.request("ping",{serviceName:Xt(),pid:vA.pid}),250);this.opts=g(g({},RB),i),this.stream()}onEnd(){return this.logger.info("end()",{ending:C(),timings:this.times.report(),pendingSize:this.pending.size}),this.pending.clear(),this.close()}addChangeListener(e){this.changeListeners.push(e)}get flapping(){return this.logger.tap({level:ne?"debug":"trace",msg:"flapping()",result:this.mkStreamRate.msSinceLastEvent<this.opts.delayBetweenRetries||bo(this.mkStreamRate.eventsPerMinute,3),meta:{msSinceLastStream:this.mkStreamRate.msSinceLastEvent,mkStreamRatePerMin:this.mkStreamRate.eventsPerMinute}})}broadcast(e,r){return this.request("broadcast",{event:e,args:r})}sendRecentLogs(){return this.request("sendRecentLogs")}async ready(){return this.ended?(this.logger.debug("ready(): false (ended)"),!1):await this.stream()!=null}async request(e,r){if(this.ended){if(C())return;throw new Error("client is ending")}if(P(e))throw new Error("method cannot be blank");return this.submit(e,r)}async submit(e,r){let i=await this.stream();if(i==null)return this.onError("submit("+e+"): stream is closed");let o=bf(),n=new gy(o,e,r,this.times);return n.setTimeout(this.opts.requestTTL),this.pending.set(o,n),n.d.finally(()=>this.pending.delete(o)),this.logger.log(ne?"debug":"trace","sending request",{id:o,method:e,params:r}),i.write(I({id:o,method:e,params:r})+`
`),n.response}close(){return this.logger.info("close()",{ended:this.ended}),b(this.stream.clear(),$i)}onData(e){if(!P(e))try{this.logger.log(ne?"debug":"trace","onData()",{req:e});let r=JSON.parse(e);if(P(r.sid))throw new Error("response is missing server id");if(this.sid!==r.sid&&(this.sid!=null&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:r.sid}),me.emit("rpcServerChange")),this.sid=r.sid,C()))return;if(r.id==null)if(T(r.event)){this.logger.trace("re-broadcasting event",r),me.emit(r.event,r.args);return}else throw new Error("missing request id from response");let i=this.pending.get(r.id);this.pending.delete(r.id),i==null?this.logger.warn("unknown or stale request ID",{resp:r,pendingIds:[...this.pending.keys()]}):r.error!=null?(i.reject(r.error),this.logger.warn("Rejected",{resp:r,rr:i})):(i.resolve(r.result),this.logger.debug("Resolved",r.result))}catch(r){this.logger.warn("invalid input: "+e,r)}}async onError(e,r){return this.logger.warn(e+" onError(): "+p(r,i=>w(i.stack,i))),this.restart()}async restart(){if(this.logger.info("restart()",{ended:this.ended,flapping:this.flapping}),await this.close(),this.ended||C()){this.logger.warn("restart(): Ending. Rejecting new connection.");return}if(this.flapping){this.logger.warn("restart(): Too many recent errors, we'll try reconnecting again in a bit",{errPerMin:this.mkStreamRate.eventsPerMinute});return}let e=await this.stream();if(e!=null){let r=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+r.length+" jobs now."),r.forEach(i=>i.reject("restarting"+Pa)),e}else{this.logger.warn("restart(): stream() returned null");return}}onFinish(e,r){if(this.ended)return;let i=r==null||r===!1;return this.logger.info("onFinish",{source:e,error:r,restarting:i}),i?this.restart():this.onError(e,r)}};var by=f("RpcClient");function NB(t){let e=new _e,r=new TA.default.Socket;return r.on("error",i=>e.reject(i)),r.connect(t,"localhost",()=>{by.debug("Connected to "+t),e.resolve()}),e.then(()=>r)}var In=l(()=>{if(vn())return;let t=u.rpcPort.valueOrDefault;by.debug("Creating new RPC client to "+t);let e=new yy("db@localhost:"+t,()=>NB(t));return e.addChangeListener(()=>Ln.unset()),e}),Ln=l(async()=>{try{if(vn())return!1;let t=await Ee(p(In(),e=>e.ping()),v);return T(t)}catch(t){return by.warn("rpcClientReady(): ping failed",t),!1}},E);var wf,pl=l(()=>f("Vacuum"));function Hm(t){return t==null||t.schema==="models"?O(wf):!1}var SA=async t=>{typeof t!="boolean"&&pl().throw("invalid setVacuuming argument",{value:t}),pl().debug("setVacuuming()",{value:t}),wf=t};_x(SA);async function MA(){return b(In()?.request("isVacuuming"),t=>(pl().info("checkRemoteVacuuming() received RPC value",{value:t}),p(t,SA)))}async function wy(t){if(!await yA()){pl().info("withVacuumEvent(): no-op, I'm not the lock owner.");return}pl().info("db vacuum starting...");try{return wf=!0,jm("vacuuming",!0),await t()}finally{wf=!1,jm("vacuuming",!1),pl().info("db vacuum finished.")}}var Gm=l(()=>f("Transactions")),BB=E,PA=10,xf=!1;async function cr(t,e,r=!1,i=!1){if(t.db==null)throw new Error("tx(): null db");try{return r&&(xf=!0),!i&&Hm(t)&&await Be(()=>!Hm(t),{timeoutMs:BB})==null&&Gm().throw("Timeout while waiting for external vacuum to complete"),await lr(async()=>t.inTransaction?e(t.db):ff(()=>t.db.transaction(()=>e(t.db)).deferred(),t.onRetry),{maxRetries:PA,errorIsRetriable:async o=>r||xf?!1:(Gm().warn("errorIsRetriable()",o),Hl(o)||Vx(o)?(t.closeDb(),Gm().warn("Trying to reopen the db "+t.dbfile),!0):!1),timeoutMs:u.maxBusyDbMs.valueOrDefault/10,onRetryWaitUntil:o=>{let n=Ct(10,u.maxBusyDbMs.valueOrDefault/(PA-o));return Gm().warn("onRetryWaitUntil()",{retryCount:o,delayMs:n}),gt(n)}})}catch(o){if(r||xf)return;throw Gm().warn("tx(): raised",o),o}finally{r&&(xf=!1)}}var Km=M(require("luxon"));function EA(t,e,r=Km.DateTime.DATETIME_MED){return ll(t,i=>(K(e,o=>i=i.setLocale(o)),i.toLocaleString(r)))}var CB=/(\.\d\d\d)\d+/;function VB(t){if(!P(t))return W(Km.DateTime.fromISO(t.replace(CB,(e,r)=>r),{setZone:!0})).filter(e=>e.isValid).orElse(()=>p(Nr.fromISO(t),e=>e.middle.toDateTime())).get()}var UB=new Map;function DA(t,e="en-US"){return Pr(UB,e,()=>new Intl.DateTimeFormat(e,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(di(t))}function AA(t){return p(VB(t),BS)}var zB=/^\d{1,4}-\d{2}-\d{2}$/;function FA(t){return K(t,e=>Gi(()=>p(Nr.fromISO(e),r=>r.intervalMs),()=>W(e.match(zB)).flatMap(()=>Km.DateTime.fromISO(e)).filter(vr).map(()=>lt).get(),()=>W(Km.DateTime.fromISO(e)).filter(vr).map(()=>0).get()))}function jo(t){let e=t;return e==null?void 0:k(e)?e:bo(e.id,-20)?e.id:k(e.assetId)?e.assetId:ku(e.tagId)?e.tagId:void 0}function LA(t,e){return Wn(jo(t),jo(e),(r,i)=>r===i,()=>!1)}var vf=class{constructor(e,r=""){this.query="";if(this.query=r,this.assetId=jo(e),this.assetId==null)throw new Error("internal error: null asset id "+I({id:e}))}static onNewPage(){this.pageImageCount=0}get unset(){return this.assetId==null||this.assetId<=0}assetUrl(){return this.unset?"":`/asset/${this.assetId}${this.query}`}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,r){return`/img/${this.assetId}/${e}/${r}${this.query}`}imgActualLink(e){return`/img/${A([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e,r="m"){return g(g({},this.imgAttrs("sq",vx,e)),{sizes:r==="s"?"80px":r==="m"?"160px":"320px"})}imgAttrs(e,r,i,o){if(this.unset)return{src:"/images/clear-64.png"};let n=Math.min(...r),s={width:d(n)},a=this.imgLink(e,n);vf.pageImageCount++,i=w(i,()=>vf.pageImageCount>72),i?(s.src="/images/clear-64.png",s["data-src"]=a):s.src=a,e===er.sq&&(s.height=d(n));let m=r.map(c=>IA(this.imgLink(e,c),c));return p(o,c=>m.push(IA(this.imgActualLink(),c.width))),s[(i?"data-":"")+"srcSet"]=m.join(","),s}},kn=vf;kn.pageImageCount=0;function IA(t,e){return t+" "+e+"w"}var kA=128,OA=8;var Oe=Object.freeze({When:"When",Who:"Who",Where:"Where",What:"What",Camera:"Camera",Lens:"Lens",Albums:"Albums",Keywords:"Keywords",Type:"Type",FS:"fs"}),MMe=[Oe.When,Oe.Camera,Oe.Lens,Oe.Type,Oe.FS];var RA=l(async()=>new Intl.DateTimeFormat(await Wc(),{month:"short"})),_A=l(async()=>{let t=await RA();return xo(0,12,e=>t.format(new Date(2016,e,1))).map(e=>gr(e,"."))});j(()=>{RA.unset(),_A.unset()});function WB(t){return 1e4-t}function qB(t){return 13-t}function NA(t){return 13-t}function jB(t){return 33-t}function HB(t){return se(t,e=>({name:d(e),ordinal:WB(e)}))}async function xy(t){if(!!Pt(1,12,t))return p((await _A())[t-1],e=>({name:String(t),displayName:e,ordinal:qB(t)}))}function GB(t){return se(t,e=>({name:d(e),ordinal:jB(e)}))}async function BA(t){let e=d(u.tagYMD.valueOrDefault).toLowerCase();if(t==null||e===""||e==="off"||e.startsWith("disable"))return;let r=[Oe.When];if(e.startsWith("y")){let i=p(zo(t),HB);if(i==null)return;r.push(i)}if(e.startsWith("ym")){let i=await p(Uo(t),xy);if(i==null)return r;r.push(i)}if(e.startsWith("ymd")){let i=p(Vo(t),GB);if(i==null)return r;r.push(i)}return r}var sPe=l(()=>f("Names"));var EPe=f("WhoTagger");var Ho=String.fromCharCode(31),Tf="Library",VA=[{name:Oe.When,ordinal:1},{name:Oe.Albums,ordinal:2},{name:Oe.FS,ordinal:3},{name:Oe.Who,ordinal:4},{name:Oe.Camera,ordinal:5},{name:Oe.Lens,ordinal:6},{name:Oe.Keywords,ordinal:7},{name:Oe.Type,ordinal:8}];function CA(t){return p(t,e=>w(e.name,d(e)))}function KB(t){return t.map(CA)}function Yr(t,e=Ho){return KB(t).join(e)+(e===Ho?e:"")}function UA(t){return Vu(On(t))}function On(t,e=Ho){return d(t).split(e).filter(T)}function zA(t){return Yr(On(t))}var $A=M(require("util"));var vy=l(()=>f("AssetFileSorter")),JB=[pi,"file",_o,to];function QB(t){return p(t,e=>Gn(e.width,e.height,(r,i)=>WA(r*i)))}function WA(t){return Math.round(Math.pow(t,u.variantSortCriteriaPower.valueOrDefault))}function $B(t){return Math.round(t/(2*E))}function qA(t){for(let i of G(t.map(o=>o.sha))){let o=t.filter(s=>s.sha===i),n=Math.max(...A(o.map(s=>s.mtime)));o.forEach(s=>s.mtime=n)}let e=A(t.map(i=>p(YB(i),o=>p(XB(o),n=>({f:i,crit:n,pojo:o}))))),r=ie(e,({crit:i})=>i);return Me(r,i=>i.map(o=>o.f))}function YB(t){let e=QB(t),r=ke.parse(t.uri);if(P(r.scheme)||P(r.path)||t.mtime==null){vy().debug("assetFileSortCriteriaPojo(): skipping",{af:t,parsedURI:r});return}let i=JB.indexOf(r.scheme);if(i===-1){vy().debug("assetFileSortCriteriaPojo(): skipping",{af:t,schemeIdx:i,parsedURI:r});return}let o=iv(r.path),n=o.base.toLowerCase().includes("cover"),s=AS(o.ext),a=w(sv(o.name),0),m=$B(t.mtime),c=wo(t.fileSize,WA),h={resolution:e,mtime:m,schemeIdx:i,fileSize:c,isCover:n,count:a,isBrowserSupported:s},x={};for(let S of u.variantSortCriteria.values)p(h[S],F=>x[S]=F);return x.uri=t.uri,x}function XB(t){let e=St(t);if(e.some(r=>r==null)){vy().debug("pojoToCriteria(): skipping",{pojo:t});return}else return e}function jA(t,e,r){let o=Je.fit().map(a=>[a.outputSize(t),a]).filter(([a])=>a!=null),n=t;function s(a,m){let c=Rr(n)/Rr(a),x=m===0&&(r!=="image/jpeg"||k(e))||c>3||Rr(a)-Rr(n)>2.5;return x&&(n=a),x}return o.filter(([a],m)=>s(a,m))}function HA(t){return t==="qhd"?"wvga":t==="uhd"?"uhd4k":t}function GA(t,e){return Nu(z(t).map(HA),z(e).map(HA))}var KA=M(require("sharp"));var ZB=l(()=>f("Sharp"));async function JA(t){try{let{data:e,info:r}=await t.raw().toBuffer({resolveWithObject:!0});return eC(e,r)}catch(e){return ZB().info("Failed to buffer-clone sharp",e),t.clone()}}function eC(t,e){return(0,KA.default)(t,{raw:e})}var xEe=require("sharp"),tC=l(async()=>{let t=X.for(Hr.ICC()),e={};for(let r of u.iccProfileMappings.valueOrDefault){let[i,o]=r.split(":"),n=t.join(o);await n.isNonEmptyFile()?e[i]=n.nativePath:f("SharpColorspace").warn(" iccProfileMappings has an invalid ICC profile filename: "+o)}return Object.freeze(e)});async function QA(t,e){let o=(await ct(t,!1))?.ProfileDescription;if(!P(o)){let n=await tC();for(let s of Tt(n))if(o.includes(s))return e.withMetadata({icc:n[s]})}return e.toColorspace("srgb")}var rC=require("sharp"),Ty=class{constructor(e,r){this.ap=e;this.assetFiles=r;this.badShas=new Di(2*E);this.logger=f("AssetPreviewBuilder("+e.assetId+")")}[$A.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build_(e){return Ge("img.AssetPreviewBuilder.build()",async()=>{let r=A(await qA(await this.assetFiles));for(this.logger.info("build_(): asset file candidates:",r.map(i=>i.uri).reverse());L(r);){let i=r.pop(),o=await X.forUri(i.uri);if(o==null)continue;let n=await o.sha();if(!(n==null||this.badShas.has(n)))try{return await this._build(o,i,e)}catch(s){this.badShas.add(n),this.logger.warn("Failed to set shown file to "+i,fe(s))}}return this.logger.throw("none of the files are valid",{ignorable:!0,retriable:!1})})}async _build(e,r,i){this.logger.info("_build("+e+")",{uri:r.uri}),O(i.validate)&&await QE(e);let o=await e.size(),n=await e.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:o,mtime:n,best:r}),o==null||n==null)return this.logger.throw("build(): missing stat info for best file",{ignorable:!0,best:r});if(r.width==null||r.height==null||r.mimetype==null||r.sha==null)return this.logger.throw("IE build(): missing fields for best file "+e,{ignorable:!0,best:r});let s=jA(r,r.rotation,r.mimetype),a=g(g({assetFileId:r.id},Mt(r,"assetId","uri","width","height","mimetype","sha","rotation")),{path:e.nativePath,mtime:n,filesize:o,fitSizes:s.map(([,$])=>$.name).join(",")});if(i.force!==!0&&!u.forceSync.valueOrDefault){let $=await this.ap.readInfo.refresh();if($!=null){if($.assetId!==a.assetId)throw new Error("IE build(): Mismatched asset IDs for "+r+": "+I({priorInfo:$,info:a}));let ee=$.fitSizes.split(","),nr=a.fitSizes.split(",");if($.sha!=null&&$.sha===a.sha&&$.rotation===a.rotation&&GA(ee,nr)){let Br=Cu(ee,nr);if(L(Br)){this.logger.info("build(): removing previews that aren't required anymore.",{leftovers:Br});for(let Mr of Br){let Bi=s.find(([,zn])=>zn.name===Mr);if(Bi==null)this.logger.warn("build(): Failed to clean up: missing fit size",{fitsize:Bi,fits:s});else{let zn=this.ap.fileForWidth(Bi[1].reducer.name,Bi[0].width);this.logger.debug("build(): unlinking unwanted preview "+zn,{fitsize:Bi}),await zn.unlink("warn")}}}return this.logger.debug("build(): SHA and rotation match, and previews exist.",{info:a,priorInfo:$}),await this.ap.writeInfo(a),a}}}let m=new pn({path:e.nativePath,op:"Building previews for"},Je.sq().length+Je.fit().length);if(this.logger.debug("Rebuilding all previews from "+r.uri,{assetId:r.assetId,best:r,info:a}),await this.ap.parent.mkdirp()==null)throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+r);let c=await this.ap.existingFiles(),h=await Us(e,Je.largestFit().max);if(h==null)throw new ae({message:"AssetPreviewBuilder.build(): "+r.uri+", "+e.nativePath+", is not readable by sharp.",retriable:!1});let x=await QA(e,rC(h.nativePath));r.mimetype.startsWith("image/")&&!Cs(r.mimetype)&&r.rotation!=null&&r.rotation!==0&&(x.rotate(r.rotation),this.logger.debug("build(): rotating "+r.rotation+"\xB0")),h.name.toLowerCase().includes("thumbnail")&&et(()=>x.trim(1));let S=[],F,U,Fe=Je.largestSq(),or=Xo(s,([$,ee])=>p(Fe.outputSize($),()=>ee.megapixels()))?.[1].name,$e=Mt(r,"width","height");{let $=x.clone(),ee=$e;for(let[nr,Br]of s){let Mr=Date.now(),Bi=ee,zn=this.ap.fileForWidth(Br.reducer.name,nr.width).wip();$=Br.resize(nr,$),ee=nr,Br.name===or&&(U=$.clone(),F=nr),await Br.toJpeg({path:zn.nativePath,sh:$,outputSize:nr}),m.onProgress(),this.logger.debug("resize("+Br.name+") "+Qr(Bi)+" -> "+Qr(nr)+" in "+(Date.now()-Mr)+" ms"),S.push(zn)}}{U==null?(this.logger.debug("square resize(): resorting to ",{origDim:$e,bestFitNameForSq:or}),U=x,F=$e):this.logger.debug("square resize(): using to ",{sqDim:F,bestFitNameForSq:or});let $=!1;for(let ee of Je.sq()){let nr=Date.now(),Br=F,Mr=ee.outputSize(w(F,$e));if(Mr==null){this.logger.debug("skipping square output for "+ee.max);continue}$||(Mr.position=u.squareThumbStrategy.valueOrDefault,$=!0),this.logger.debug("Applying ",{outputSize:Mr});let Bi=this.ap.fileForWidth(ee.reducer.name,Mr.width).wip();ee.resize(Mr,U),Mr.position!=null&&(this.logger.debug("Cloning square crop to make position consistent",{outputSize:Mr}),U=await JA(U)),F=Mr,await ee.toJpeg({path:Bi.nativePath,sh:U,outputSize:Mr}),m.onProgress(),S.push(Bi),this.logger.debug("resize("+ee.name+") "+Qr(Br)+" -> "+Qr(Mr)+" in "+(Date.now()-nr)+" ms")}}try{await Promise.all(c.map($=>$.unlink())),await Promise.all(S.map($=>$.unwip_())),await this.ap.writeInfo(a),this.logger.debug("Previews unwipped and info written",{info:a})}catch($){throw await le(S,ee=>ee.unlink()),new ae({cause:$,fatal:!1,message:"Failed to create previews from "+e})}return a}};var iC=f("extractPreviewInfo");function Jm(t,e){let r=e.posixPathFrom(t).replace(/\//g,"").split("-"),i=V(r[0]),o=r[1],n=er.validOrElse(o,void 0),s=ox(r[2]);if(k(i))return{file:e,assetId:i,reducer:n,width:s};iC.warn("Failed to extract preview info",{file:e,previewsRoot:t,arr:r,assetId:i,reducer:n,width:s})}async function YA(t,e){return oa(e.assetId,e.width,(r,i)=>b(Oi(e.file),o=>{let n=rP(o),s=gr(t,ov(t));return{size:n,basename:`${s}-${n}${e.file.ext}`,title:Sy(e.file,n,"image",o),description:`Download ${n}`,details:`(${Qr(o)} ${e.file.ext})`,href:new kn(r).imgLink(er.fit,i)}}))}function Sy(t,e,r,i){return`Download ${e} ${t.ext} ${r} (${Qr(i)})`}var ADe=new Va,My=class{constructor(e,r,i){this.previewsRoot=e;this.alp=i;this.readInfo=l(()=>this.infoJson().readJson("debug"));this.logger=f("AssetPreviews(assetId:"+jo(r)+")"),this.assetId=jo(r),this.urls=new kn(r);let o=vi(this.assetId,8,"0"),n=en(o,3);this.basename=n.pop()+"-",this.parent=e.join(...n)}existingFiles(){return ye(this.parent.childFiles(e=>e.base.startsWith(this.basename)),()=>[])}existingJpgs(){return ye(this.parent.childFiles(e=>e.base.startsWith(this.basename)&&e.ext===".jpg"),()=>[])}async previews(){let e=await this.existingFiles();return Kl(A(e.map(r=>Jm(this.previewsRoot,r))),r=>r?.file.size())}async deleteAll(){this.parent.clear();let e=await this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return await Promise.all(e.map(r=>r.unlink())),e}file(e){return this.parent.join(this.basename+e)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(e){return this.readInfo.unset(),this.infoJson().writeJsonMaybe(e,{spaces:2})}fileForWidth(e,r){return this.file(e+"-w"+r+".jpg")}filesForReducer(e){let r=this.basename+e+"-";return this.existingFiles().then(i=>i.filter(o=>o.base.startsWith(r)))}async smallestFileForReducer(e){return Xo(await this.filesForReducer(e),r=>w(p(Jm(this.previewsRoot,r),i=>i.width),0))}async largestFileForReducer(e){return dt(await this.filesForReducer(e),r=>w(p(Jm(this.previewsRoot,r),i=>i.width),0))}async widths(e){let r=await this.filesForReducer(e);return dr(A(r.map(i=>p(Jm(this.previewsRoot,i),o=>o.width))))}async posterLink(){let e=await this.widths(er.fit);return this.urls.imgLink(er.fit,Math.max(...e))}async imgAttrs(e,r=!1,i=!0){if(!r&&e===er.sq)return this.urls.sqImgAttrs(i);{let o=e===er.fit?await this.readInfo():void 0;return this.urls.imgAttrs(e,await this.widths(e),i,o)}}};var Py=class{constructor(e,r){this.root=e;this.alp=r;this.id2ap=new Ce(512)}async build_(e){return this.apb(e.assetId,e.assetFiles).build_(e)}apb(e,r){return new Ty(this.ap(e),r)}ap(e){let r=d(jo(e)),i=this.id2ap.get(r);if(i!=null&&LA(e,i.assetId))return i;{let o=new My(this.root,e,this.alp);return oe(e)||this.id2ap.set(r,o),o}}clearAssetId(e){this.id2ap.delete(d(e))}};var XA=M(require("@iarna/toml"));var Qm=f("SettingsIO"),ZA="settings.toml";function Ey(){return X.for(ci()).join(ZA)}function Sf(t){return Ze([t,u.libraryPath.value],e=>K(e,r=>p(qt(r),i=>i.join(ZA))))}async function oC(){O(u.scanMyPictures.value)&&(u.scanMyPictures.value=!1,u.scanPaths.push(await jT()))}async function fl(t=Ey()){let e=await ye(eF(t),()=>[]);return await oC(),Xr.unset(),e}async function rF(){return tF(Ey())}async function iF(t){return p(Sf(t),e=>tF(e))}var Xr=l(()=>nC(),Fr);B(()=>{j(()=>Xr.unset()),u.libraryPath.addListener(()=>Xr.unset())});function nC(t){let e=Sf(t);return Qm.tap({msg:"_libraryHasSettings",result:w(e?.clear().existsSync(),!1),level:"info",meta:{libraryPath:t,settings:u.libraryPath.value,librarySettingsFile:e?.nativePath}})}var sC=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;async function tF(t){return b(t.firstMatchingLine(sC),e=>e[1])}var oF={maxLineLen:78,prefix:"# "};async function nF(t,e){let r=await t.clear().isNonEmpty(),i=r?await t.wip():t;await aC(i,e,t),Qm.info("maybeWriteFile(): wrote settings",{dest:i,file:t,nonDefaults:e.filter(o=>o.hasValue()).map(o=>({name:o.name,value:o.value}))}),r&&(await Et(Xn(Mf(i),Mf(t)))&&(Qm.info("Archiving prior, different contents",{dest:i,file:t}),await t.renameYMDHMS_("old")),await i.unwip_())}var lC=l(()=>wt);async function aC(t,e,r){let i=w(await Mf(r),{}),o=pe(["","Hello!","",`These are ${e[0].categoryType} settings for PhotoStructure.`,""," - Please shut down PhotoStructure before editing this file.",""," - PhotoStructure has TWO settings files!",""," - Most settings have reasonable defaults, which are provided after the",'   description. Remove the "#" from the beginning of the line to override',"   the default.",""," - See <https://photostructure.com/getting-started/advanced-settings/>","   for more details","","Thanks for using PhotoStructure! Visit <https://photostructure.com/support> or email <support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+lC()].map(s=>To(s,oF)));o.push("","");let n="";e.forEach(s=>{let a=`${ec(s.categoryType)}.${s.category.toLowerCase()}`;a!==n&&(n=a,o.push("",ha("#",78),"#","# Settings for "+a+":","#","",""));let m="# +"+ha("-",s.name.length+4)+"+",c=Xe(g(g({env:s.key},Me(s.opts.envAliases,F=>({"env aliases":F}))),s.addToJSON())).map(([F,U])=>`${F}: ${I(U)}`).join(", ");o.push(...To([m,"|  "+s.name+"  |",m,"",`${s.opts.description.replace(/\n/g,`

`)}`,`(${c})`,""].join(`
`),oF));let h=i[s.name],x={},S=s.valueToPersist(h);S!=null?(x[s.name]=S,o.push(...sF(x))):(x[s.name]=s.exampleValue,o.push(...sF(x).map(F=>"# "+F))),o.push("","")}),await t.writeTxt_(`
`+o.map(s=>s.trimRight()).join(`
`)+`

`),Ox()}function sF(t){return Xi(...Xe(t).map(([e,r])=>e+" = "+I(r,void 0,2)))}async function Pf(t=Ey()){return nF(t,XT())}async function Ef(t){return p(Sf(t),e=>eF(e))}async function aF(t){await Bp(aa(t,u.libraryPath.value));let e=Sf(t);return Qm.warn("writeLibrarySettings("+e+")"),await p(e,r=>nF(r,ZT())),Xr.unset(),e}async function Mf(t){return b(t.readFile(),e=>Qm.tap({msg:`read(${t})`,result:XA.default.parse(Sd(e.toString()))}))}async function eF(t){let e=f("SettingsIO.importFileSettings("+t.nativePath+")");try{let r=await Mf(t);if(r==null){if(await t.isNonEmpty())throw new Error("Failed to read "+t);return[]}let i=new Map(Xe(u).filter(([,n])=>n instanceof Gr&&!n.transient).map(([n,s])=>[n.toLowerCase(),s])),o=A(Xe(r).map(([n,s])=>{let a=i.get(d(n).toLowerCase());return a==null?e.warn("Failed to import (no setting with this name)",{key:n}):a.importFromFile(s),a}));return e.info("loaded",{tomlMap:r,imported:o.map(n=>Mt(n,"name","value","persist"))}),o}catch(r){e.error("Cannot read"+yr(r));return}}var fAe=l(()=>new Set([u.logLevel,u.httpPort,u.rpcPort,u.license].map(t=>t.key)));var lF=M(require("process"));var mC=require("net"),Zr=f("rpc.Server"),uC=({params:t,conn:e})=>(K(t.serviceName,r=>{P(e.serviceName)&&(e.serviceName=r)}),se(t.pid,r=>{P(e.pid)&&(e.pid=r)}),`pong to ${e.serviceName}@${e.pid} from ${Xt()}@${lF.pid} at ${new Date}`),mF=class{constructor(e){this.socket=e}toString(){return P(this.serviceName)?ka(this.socket):`${this.serviceName}:${this.pid}`}},Dy=class{constructor(e,r=!0){this.port=e;this.unref=r;this._ended=!1;this._ready=new _e;this.connections=[];this.onPause=()=>this.broadcast("pause");this.onResume=()=>this.broadcast("resume");this.handlers=new Map;this.sid=l(()=>un.randomChars(12));this.start=ys(async()=>{if(!this.ended)return Zr.debug("start("+this.port+")"),this.server=mC.createServer(this.onConnect.bind(this)),this.server.on("listening",()=>{Zr.info("listening on "+this.port),this._ready.resolve()}),this.server.on("error",async e=>{Zr.warn("error, rejecting ready"),this._ready.reject(),await this.onError("createServer"+ge,e)}),this.server.listen(this.port,u.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise},5e3);this.end=l(async()=>{this._ended=!0,me.removeListener("pause",this.onPause),me.removeListener("resume",this.onResume),await this.closeAllConnections(),await Xx(this.server)});this.name="Server:"+e,this.addHandler("ping",uC),this.addSimpleHandler("broadcast",i=>(me.emit(i.event,i.args),this.broadcast(i.event,i.args))),sc(this.onPause),xa(this.onResume),Id(this),pA(this)}get connectionCount(){return this.connections.length}async serialize(e){return I(g({sid:this.sid()},e))+`
`}addHandler(e,r){let i=this.handlers.get(e);i!=null&&Zr.warn("addHandler(): overwriting",{method:e,prior:i,newHandler:r}),this.handlers.set(e,r)}addSimpleHandler(e,r){this.addHandler(e,({params:i})=>r(i))}addSimpleHandlers(e){Xe(e).forEach(([r,i])=>this.addSimpleHandler(r,i))}get ended(){return this._ended||C()}get ready(){return this._ready.promise}closeAllConnections(){let e=this.connections.map(r=>$i(r.socket));return this.connections.length=0,Promise.all(e)}broadcast(e,r){return this.sendAll({event:e,args:r})}async sendAll(e,r="write"){let i=await this.serialize(e),o=[...this.connections],n=o.length;Zr.debug("sendAll()",{pojo:e,method:r});for(let s of o)try{s.socket.writableEnded?n--:s.socket[r](i,()=>n--)}catch{n--}return Be(()=>n<=0,{timeoutMs:v})}onConnect(e){Zr.info("Connection from "+ka(e)),this.unref&&e.unref();let r=new mF(e);this.connections.push(r),e.on("end",()=>{Zr.info("Closing connection from "+ka(e)),vt(this.connections,i=>i.socket!==e)}),e.on("error",async i=>{Zr.warn("on error from "+ka(e)+": "+i),await this.onError("socket",i),e.end()});try{fn(e,`
`,i=>this.onRequest(i,r))}catch(i){Zr.warn("Caught error from "+ka(e)+": "+i),e.end()}}async onRequest(e,r){if(Zr.debug("onRequest()",e),P(e))return;let i="missing",o="missing";try{let n=JSON.parse(e);return K(n.id,s=>i=s),K(n.method,s=>o=s),await Ge("rpc."+o,()=>this.handle(i,o,n.params,r))}catch(n){Zr.warn("invalid request",{line:e,error:n}),r.socket.write(await this.serialize({id:i,error:w(n.message,()=>d(n))}))}}async handle(e,r,i,o){let n=this.handlers.get(r);if(n==null)throw Zr.warn("bad handler request",{method:r,params:i,supported:Tt(this.handlers)}),new Error("No handler for "+r);let{elapsedMs:s,result:a}=await mi(()=>n({id:e,method:r,params:i,conn:o}));Zr.log(Wa(s,v),"handle()",{method:r,conn:d(o),elapsedMs:s,id:e,params:i,result:a}),o.socket.write(await this.serialize({id:e,result:a}))}async onError(e,r){this.ended||J(e,r)}};var $m=!1;function _t(){return $m}function Ay(){$m||($m=!0,Ax())}function Fy(){$m&&($m=!1,Cd(),Fx())}var eu=M(require("process"));var Ly=M(require("process"));function Iy(){let t=(0,Ly.memoryUsage)();return Hi([t.external,t.heapUsed,t.arrayBuffers])}function uF(){return ve(Iy()/je,2)}function ky(){return(0,Ly.memoryUsage)().rss}function cF(){return ve(ky()/je,2)}var cC=l(()=>new we("memoryCheck on exit",()=>{let t=f("PromiseTimer"),e=pF();t.log(Fp(e)?"warn":"info","memory use on exit:",e)},Q.service));function pF(){cC();let t=[],e=[],r=[];function i(o,n,s){if(!k(o))return J("memoryCheck(): invalid bytesUsed. "+I({bytesUsed:o,desc:s})+Ma);let a=o/je,m=`used by ${Xt()} (${ss(o,2)})`;a>=n?r.push(`${s} ${m} is high`):a>=n*.8?e.push(`${s} ${m} is high`):t.push(`${s} ${m} is OK`)}return i(Iy(),u.maxMemoryMb.valueOrDefault,"Used memory"),i(ky(),u.maxRssMemoryMb.valueOrDefault,"RSS memory"),{ok:t,warn:e,bad:r}}function fF(){return!ne&&!u.scanAllDrives.valueOrDefault&&N(u.scanPaths.values)?{warn:["Nothing to scan: scanAllDrives is false and scanPaths is empty."]}:{}}async function Ym(){try{return Lp(await Ws(),pF())}catch(t){return pg({fail:[oi(fe(t),"healthChecks failed")]})}}async function dF(){if(_t()||C())return!0;let t=await Ym();return t==null||L(t.fail)||L(t.bad)||L(t.warn)}var PF=M(require("util"));var hF=M(require("knex"));var po=(0,hF.default)({client:"sqlite3",useNullAsDefault:!0});var pC=".sqlite3";function qs(t,e){return t.join(e,"db"+pC)}var gF,Rn=()=>gF;function yF(t){gF=t}function bF(){return p(qt(),t=>qs(t,"models"))}var Oy=new Map;function Ry(t){Oy.set(t.$ctor,t)}var fC=([t,e])=>t!=null&&e!=null;function wF(t,e){if(e==null)throw new Error("json is null");if(t!=null&&T(t.$ctor)&&!Oy.has(t.$ctor)&&Ry(t),e instanceof t)return e;let r=W(e.$ctor).flatMap(o=>Oy.get(o)).getOrElse(()=>t);if(e instanceof r)return e;let i=new r;return e==null?i:Go(i,e,G([t.tableName+".",r.tableName+"."]))}function Go(t,e,r=[]){let i=t.class();return Tt(e).filter(n=>n!=="$ctor").filter(n=>e[n]!=null).map(n=>{let s=e[n];return r.forEach(a=>n=He(n,a)),So(i.booleanFields,n)?[n,O(s)]:[n,s]}).filter(fC).forEach(([n,s])=>t[n]=s),t}function xF(t){return t===null||So(["number","string"],typeof t)}function _y(t){return t!=null&&Array.isArray(t)?t.every(_y):Xe(t).every(([,e])=>xF(e))}function vF(t){return Yo(t,(e,r)=>{if(!e.startsWith("$")){if(typeof r=="boolean")return[e,r?1:0];if(xF(r))return[e,r];if(MD(r))return[e,di(r)]}})}function dC(t){return t!=null&&It(t.sql)&&(t.bindings==null||_y(t.bindings))}function Df(t){if(t==null)throw new Error("null sql");if(dC(t))return t;if(It(t))return{sql:t};if(xe(t.toSQL))return jt(t.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+I(t))}function TF(t){return t.replace(/\s*--.*?\n/g,"").split(";").map(e=>e.replace(/\s+/g," ").trim()).filter(T)}var SF=ne?25:1e3,MF=l(()=>f("DbRequest")),Xm=class{constructor(e,r){this.db=e;this.tableName=r;this.cachedStatements=new Ce(256)}qb(){return po(this.tableName)}prep(e,r,i=!1){let o=Df(r);try{let n=this.cachedStatements.getOrSet((i===!0?"pluck:":"")+o.sql,()=>{let s=e.prepare(o.sql);return i===!0?s.pluck():s});return n.database.open?{sq:o,stmt:n}:(this.cachedStatements.clear(),this.prep(e,r,i))}catch(n){return MF().throw("prep() failed",{error:n,sqlQuery:o,retriable:!1})}}async wrap({q:e,pluck:r,m:i}){try{return await cr(this.db(),o=>{let{sq:n,stmt:s}=this.prep(o,e,r),a=s[i].bind(s);return n.bindings==null?a():a(n.bindings)})}catch(o){if(String(o.message).includes("AdvisoryLock"))throw o;MF().throw(o,g({method:i},Df(e)))}}run(e){return this.wrap({q:e,m:"run"})}async runScript(e,r=""){let i=Fv("runScript()");for(let o of e){if(P(o)||o.trim().startsWith("--"))continue;await this.run({sql:o});let n=Cl(sr(o,60),r,"");i.elapsed(n)}}mapRun(e){return cr(this.db(),r=>e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return Z(o.bindings,s=>n.run(s),()=>n.run())}))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}updateOrIgnore(e){let r=Df(e(this.qb()));return r.sql=r.sql.replace(/update /i,"UPDATE OR IGNORE "),this.wrap({q:r,m:"run"})}first(e){return this.wrap({q:e,m:"get"})}firstf(e){return this.wrap({q:e(this.qb()),m:"get"})}mapAll(e){return cr(this.db(),r=>pe(e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return Z(o.bindings,s=>n.all(s),()=>n.all())})))}all(e){return this.wrap({q:e,m:"all"})}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}async batched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(SF),m:"all"}),L(r)&&await e.onResults(r);while(L(r)&&!C())}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}async pluckBatched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(SF),pluck:!0,m:"all"}),L(r)&&await e.onResults(r);while(L(r))}};var Ny=class{constructor(e,r){this.model=e;this.db=r;this.columnNames=l(()=>df(()=>this.db().pragma(`table_info(${this.tableName})`).map(e=>e.name)));this.logger=f(`ModelOps(${e.tableName})`),Ry(e),this.dbl=new Xm(this.db,e.tableName)}get dbOpen(){return Z(this.db(),e=>e.open,()=>!1)}get tableName(){return this.model.tableName}query(){return this.model.query()}async toDbValued(e){let r=this.model.fromJSON(e),i=vF(r);return Mt(i,...await this.columnNames())}run(e){return this.dbl.run(e)}fromJSON(e){return b(e,r=>this.model.fromJSON(r))}async fromJSONs(e){return(await ms(e)).map(o=>this.model.fromJSON(o))}first(e){return this.fromJSON(this.dbl.first(e))}firstf(e){return this.first(e(this.query()))}all(e=this.query()){return this.fromJSONs(this.dbl.all(e))}allf(e){return this.all(e(this.query()))}findOne(e){return this.fromJSON(this.dbl.first(e))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e,r){return this.findOneBy(g(g({},r),{id:e}))}async findByIds(e){let r=await cr(this.db(),async()=>le(Zo(D(e).filter(k),u.dbBatchSelectSize.valueOrDefault),i=>this.dbl.all(this.query().whereIn("id",i))));return ie(await this.fromJSONs(pe(r)),i=>e.indexOf(i.id))}findBy(e){return this.all(this.model.queryBy(e))}findWhereIn(e,r){return this.all(this.model.query().whereIn(e,r))}rows(e){return this.count(w(e,()=>this.model.query()))}count(e){return ye(this.dbl.pluckFirst(e.count()),()=>0)}countf(e){return this.count(e(this.query()))}async insert(e){return cr(this.model.db(),()=>le(e,r=>this.insertOne(r)))}async upsertOne(e){return this.modelSupportsUpsert?(await this.upsert([e]))[0]:e.id==null?this.insertOne(e):this.updateOne(e)}async insertOne(e){if(e.id!=null)throw new Error("insert called for "+I(e)+Gt);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames()),o=await this.dbl.runf(s=>s.insert(i)),n=await ya(V(o.lastInsertRowid),s=>this.findById(s),()=>{this.logger.throw("internal error: lastInsertedRowId was non-numeric",{runInfo:o})});return e instanceof this.model&&Go(e,n),n}async updateOne(e){if(e.id==null)throw new Error("update called for "+I(e)+Gt);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames());return await this.dbl.runf(o=>o.where({id:e.id}).update(i)),r}get ucn(){return this.model.uniqueColumnName}get ucnFieldNames(){return w(this.ucn,"id").split(",")}get modelSupportsUpsert(){return this.ucn!=null&&this.ucn!=="id"}get ucnConstraint(){return`(${this.ucn})`}onConflictClause(e){let r=[...this.ucn.split(","),"id","createdAt"],i=e.filter(n=>!r.includes(n)).sort().map(n=>`${n}=excluded.${n}`).join(","),o=["ON CONFLICT",this.ucnConstraint];return P(i)?o.push("DO NOTHING"):o.push("DO UPDATE SET",i),o.join(" ")}async upsertDbJson(e){let r=this.query().insert(e).toSQL(),i=new Set;for(let n of e)for(let s of Tt(n))i.add(s);let o={sql:`${r.sql} ${this.onConflictClause([...i.values()])}`,bindings:r.bindings};await this.run(o)}pickModelUcn(e){return Mt(e,...this.ucnFieldNames)}async reload(e){return await le(e,async r=>b(this.findOneBy(this.pickModelUcn(r)),i=>Go(r,i))),e}async upsert(e,r=!1){if(this.modelSupportsUpsert){let i=await this.columnNames(),o=await cr(this.db(),async()=>Wx(D(e),u.dbBatchUpsertSize.valueOrDefault,async n=>{let s=n.map(a=>this.model.fromJSON(a));return s.forEach(a=>a.$beforeUpsert()),await this.upsertDbJson(s.map(a=>a.$toDbJSON(i))),s}));return r?o:this.reload(o)}else return cr(this.db(),()=>le(e,i=>this.upsertOne(i)))}async delete(e){return Me(e.filter(k),r=>this.run(this.model.query().delete().whereIn("id",r)))}async batched(e){let r=u.dbBatchSelectSize.valueOrDefault,i,o;do i=await this.allf(n=>(n=e.qb(n),o!=null&&(n=n.andWhere("id",">",o)),n.orderBy("id","asc").limit(r))),L(i)&&(o=Math.max(...i.map(n=>n.id)),await e.onResults(i));while(L(i))}};var Ko=class{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return this._logger==null&&(this._logger=f(this.tableName)),this._logger}static query(){return po(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static ops(){return this._ops==null&&(this._ops=new Ny(this,this.db)),this._ops}static get dbl(){return this.ops().dbl}static async txOp(e){return cr(this.db(),()=>e(this.ops()))}static async tx(e,r=!1){return cr(this.db(),()=>e(this.dbl),r)}static rows(){return this.ops().rows()}static truncate(){if(hr)throw new Error("rejecting attempt to truncate in prod");return this.dbl.run("DELETE FROM "+this.tableName)}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return d(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${w(this.id,this[this.class().uniqueColumnName])})`}logger(){return f(d(this.valueOf()))}[PF.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return wF(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}$toShallowJSON(){return this.$_toJSON(O)}$toDbJSON(e){let r=this.$_toJSON(Tw,!1);return T(e)?Mt(r,...e):r}toJSON(){return this.$_toJSON(O)}$_toJSON(e,r=!0){let i=this.class();return Yo(this,(o,n)=>{if(!(n==null||!ri(n)))return So(i.booleanFields,o)?[o,e(n)]:[o,n]},r?{$ctor:i.$ctor}:{})}upsert(e){return e!=null&&Go(this,e),this.class().ops().upsertOne(this)}$beforeUpsert(){}async reload(){return b(this.class().ops().findById(this.id),e=>Go(this,e))}delete(){return p(this.id,e=>this.class().ops().delete([e]))}};Ko.schema="models",Ko.db=Rn;var tr=class extends Ko{static touch(e){return Me(D(e).filter(k),r=>this.dbl.runf(i=>i.whereIn("id",r).update("updatedAt",Date.now())))}toID(){return"updateCount"in this&&(this.updateCount=ya(this.updateCount,e=>e,1)),dl(this)}get createdAtDate(){return se(this.createdAt,e=>new Date(e))}get updatedAtDate(){return se(this.updatedAt,e=>new Date(e))}$beforeUpsert(){if(this.createdAt==null&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this){let e=this;e.updateCount=ya(e.updateCount,r=>r+1,1)}}};function dl(t){return p(t,e=>({id:e.id,v:hw(e.updateCount,0)}))}var Af=class extends tr{static ping(e="ping"){return Af.ops().upsertOne({name:e})}static async assertPing(e){let r=Date.now();try{if(Af.db()==null)throw new Error("db is undefined");let i=await this.ping(e);if(this.logger().debug("assertPing()",{heartbeat:i}),Math.abs(r-i.updatedAt)>20*v)throw new Error("Heartbeat.updatedAt wasn't updated")}catch(i){throw new ae({cause:i,message:"Failed to write to the library database"})}}},Zm=Af;Zm.tableName="Heartbeat",Zm.uniqueColumnName="name";var hC=0;function EF(){return Date.now()<=hC}var hl=f("LibraryHealthChecks"),Ws=l(()=>gC(),15*v);function By(){DF.unset(),Ws.unset()}function AF(){return By(),Ws.refresh()}B(()=>{u.libraryPath.addListener(By),lc(AF),Rx(AF),ac(By)});async function gC(){if(EF())return{ok:["Library health checks are paused"]};if(!u.libraryPath.hasValue()&&!Xr())return{ok:["Library isn't set up yet"]};let t=Tr.instance();if(t==null)return Xr()?{fail:["Missing library at "+u.libraryPath.value]}:{};if(t.isPendingSetup){t.ready.then(()=>Ws.unset());let a=Date.now()-t.start;return a<H?{ok:["Library is setting up..."]}:a<3*E?{warn:["Library is taking a long time to set up..."]}:{fail:["Library took too long time to set up."]}}else try{await t.ready}catch(a){return{fail:["Library setup failed: "+fs(a)]}}let e=[],r=[],i=[],o=[],n=[],s=async a=>{try{return await a()}catch(m){n.push(m),hl.warn("trap(): failed to run "+a.name+": "+yr(m)),o.push(fs(m));return}};if(await s(()=>t.openedBy().throwIfUnavailable("(library health check)")),u.healthCheckExiftool.valueOrDefault&&await s(()=>rA()),u.healthCheckLibraryIsWritable.valueOrDefault&&await s(()=>DF().catch(a=>{throw new ae({cause:a,message:"Cannot write to "+Ns(),fatal:!0})})),R)try{let a=await De.instance().version();P(a)&&o.push("PowerShell isn't working (can't get version).")}catch(a){n.push(a),o.push(`PowerShell isn't working (${fs(a)}).`)}if(u.healthCheckFreeSpace.valueOrDefault||u.healthCheckVolumes.valueOrDefault){let a=await s(()=>Wt());if(N(a))o.push("Failed to scan system volumes."+ge);else if(u.healthCheckFreeSpace.valueOrDefault)for(let m of await t.requiredFiles())try{let c=await m.file();if(c==null)continue;if(c.clear(),m.isDir&&!await c.isDirectory())o.push(`${m.desc}, ${c}, is missing`+ge);else if(L(a)){let h=rg(a,c.nativePath);hl.debug("checkDir()",{dir:c.nativePath,desc:m.desc,bestVolume:h,vols:a.map(x=>x.mountpoint)}),h==null?c.isUNC?r.push(`${m.desc}, ${c}: cannot be monitored for sufficient free space. Consider using a mapped network drive instead.`):o.push(`${m.desc}, ${c}, doesn't seem to have a mountpoint (?!)`):h.available<u.minDiskFreeGb.valueOrDefault*Eo&&r.push(`Only ${ss(h.available)} are available on ${h.mountpoint}.`)}}catch(c){n.push(c),o.push("Failed to check "+m.desc+": "+fs(c))}}return N(o)&&N(r)&&e.push("Library and support directories are OK"),T(eu.env.TEST_FAIL)&&o.unshift(...eu.env.TEST_FAIL.split(",")),T(eu.env.TEST_WARN)&&r.unshift(...eu.env.TEST_WARN.split(",")),u.healthCheckDb.valueOrDefault&&await s(()=>Zm.assertPing()),o.map(a=>J(a+Ma)),Lp({ok:e,warn:r,bad:i,fail:o},fF())}var DF=l(async()=>yC(Ns()),ft);async function yC(t){if(t==null)return hl.throw("copyExampleImageToLibraryDir(): undefined rootDir");let e=D(await ce.for(Hr.Public()).join("images").children()).find(o=>o.name.startsWith("splash"));if(e==null)return hl.throw("copyExampleImageToLibraryDir(): missing validation image");t=ce.for(t);let r=t.join(".tmp-"+Bl(6)),i=r.join("write-test"+e.ext);try{await e.copyFile_(i);let o=await e.sha(),n=await i.sha();if(o!==n)return hl.throw("Failed to copy sample file to library. Is "+t+" writable?",{ignorable:!0});hl.debug(`Library root directory, ${t}, is writable`)}finally{await r.rmrf("debug")}}var bC=l(()=>f("RpcServiceHandlers")),FF=l(()=>({libraryPath:()=>u.libraryPath.value,healthChecks:()=>Ws(),isVacuuming:()=>bC().tap({msg:"isVacuuming",result:Hm()}),mountpoints:()=>xt(),volumes:()=>Wt(),paused:()=>_t()}));var LF=l(()=>f("RpcServer")),IF=l(async()=>{if(!await vn())return;LF().info("Setting up RPC...");let t=u.rpcPort.valueOrDefault,e=!0,r=new Dy(t,e);return r.addSimpleHandlers(FF()),await r.start(),LF().info("RPC service serving port "+r.port),r});var kF={broadcast:(t,e)=>he(IF(),r=>r.broadcast(t,e),()=>b(In(),r=>r.broadcast(t,e)))};var wIe=`
SELECT
  al1.name,
  al1.lockId
FROM
  AdvisoryLock AS al1
  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name
  AND al1.createdAt > al2.createdAt
WHERE
  al2.createdAt IS NULL
`.replace(/\s+/," "),Cy=class extends Ko{static vacuum(e=30*E){return this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async currentAcquiredLocks(){return this.dbl.pluckAllf(e=>e.select("name").where({acquired:1}))}static async allLocks(){return this.dbl.pluckAllf(e=>e.select("name"))}static async withLocks({lockNames:e,f:r,timeoutMs:i}){let o=Date.now(),n={},s=bf();this.logger().debug("withLocks()",{lockNames:e,lockId:s});let a=n.locks=e.map(c=>({name:c,lockId:s,acquired:0,createdAt:Date.now()}));await this.tx(c=>c.runf(h=>h.insert(a)));let m=l(()=>this.logger().warn("long wait time for",e));try{let c=await Be(async()=>{let h=!0,x=await this.tx(S=>S.runf(F=>F.where({lockId:s}).update({acquired:1})),h);return x==null&&!up(o,5*v)&&m(),x!=null},{timeoutMs:i,timeBetweenMs:Ct(5,500)});if(this.logger().info("withLocks()",{lockNames:e,acquired:c}),c){n.acquireMs=Date.now()-o;let h=await mi(async()=>r(s));n.result=h.result,n.runMs=h.elapsedMs}}finally{let c=await mi(()=>Cy.tx(h=>h.runf(x=>x.where({lockId:s}).delete())));n.releaseMs=c.elapsedMs,n.released=!0}return n}},gl=Cy;gl.tableName="AdvisoryLock",gl.uniqueColumnName="name,lockId";var wC=(t,e)=>gl.withLocks({lockNames:t,f:e,timeoutMs:E}).then(r=>r.result),OF={withAdvisoryLocks:wC};function RF(t,e){return t.map((r,i)=>r*e[i])}function _F(t,e){return t.map((r,i)=>{if(r.length!==e.length)throw new Error("misshaped matrix on row "+i);return Hi(r.map((o,n)=>o*e[n]))})}var xC=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]];function Ff(t){return TC(vC(t))}function SC(t){return[t[0],t[1],t[2]].map(e=>re(0,255,e))}function vC(t){let e=SC(t).map(r=>r/255).map(r=>r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92);return _F(xC,e)}var Vy={X:.95047,Y:1,Z:1.08883},MC=216/24389,PC=24389/27;function TC(t){let[e,r,i]=RF(t,[1/Vy.X,1/Vy.Y,1/Vy.Z]).map(o=>o>MC?Math.pow(o,1/3):(PC*o+16)/116);return[116*r-16,500*(e-r),200*(r-i)]}function tu(t,e){return lf({dims:[{value:t[0],min:0,max:100},{value:t[1],min:-80,max:80},{value:t[2],min:-80,max:80}],bitDepth:e})}function NF(t,e){return ey(t,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:e})}var Lf=require("sharp"),ru=12,_n=7;var EC=f("ImageHash"),DC=250,yl=new Ce(DC);j(()=>yl.clear());ar(t=>T(t)?yl.delete(t):yl.clear());va((t,e)=>p(yl.get(t),r=>yl.getOrSet(e,()=>r)));var If=8,BF={width:96,height:96};function AC(t){return kv(BigInt("0b0"+t.map(e=>e===1?1:0).join("")))}function FC(t){let e=[[],[],[]];for(let r=0;r<t.length;r+=3){let i=Ff([t[r],t[r+1],t[r+2]]);e[0].push(i[0]),e[1].push(i[1]),e[2].push(i[2])}return e}function LC(t){let e=u.greyscaleColorThreshold.valueOrDefault;for(let r of t)if(Math.abs(r[1])>e||Math.abs(r[2])>e)return!1;return!0}function CF(t){return 1<2?Ot(t):Ot([Ot(t),Ld(t)])}async function IC(t){let e=f("ImageHash("+t+")");try{let i=await Us(t,BF,!0);if(i==null){e.warn("Cannot build readable stream");return}if(await Oi(t)==null){e.warn("Can't extract dimensions");return}let n=Lf(i.nativePath).removeAlpha();i.isDescendantOf(await zs())&&yi(await i.size(),2*je)&&(n=n.trim(4)),n=n.resize(g(g({},BF),{fit:Lf.fit.fill,kernel:Lf.kernel.lanczos3,fastShrinkOnLoad:!0,withoutEnlargement:!0}));let{data:s,info:a}=await n.raw().toBuffer({resolveWithObject:!0}),m=Jn(0,s.length,3,$=>Ff([s[$],s[$+1],s[$+2]])),c=LC(m),h=Fd(m.map($=>tu($,ru)),_n);if(!c&&u.includeSharpDominantColor.valueOrDefault){let $=await Ge(`img.imageHash.stats ${t.ext.toUpperCase()}`,()=>n.stats()),ee=tu(Ff([$.dominant.r,$.dominant.g,$.dominant.b]),ru);h=G([ee,...h]).slice(0,_n)}let x=Lf(s,{raw:g(g({},a),{channels:3})}).resize({width:If,height:If}),{data:S}=await x.raw().toBuffer({resolveWithObject:!0}),F=FC(S),U=c?[CF(F[0]),0,0]:Te(3,$=>CF(F[$])),or=(c?[F[0]]:F).map(($,ee)=>{let nr=U[ee];return $.map(Br=>Br>=nr?1:0)});if(c){let $=Te(If*If,()=>0);or.push($,$)}return{meanHash:AC(pe(or)),isGreyscale:c,modes:h}}catch(r){e.warn("Failed to imageHash("+t.nativePath+")",r);return}}async function VF(t){return yl.getOrSet(t.nativePath,()=>mi(()=>Ge(`img.imageHash${t.ext.toUpperCase()}`,()=>IC(t))).then(({elapsedMs:e,result:r})=>EC.tap({level:Wa(e,4*v),msg:"imageHash()",result:r,meta:{file:t.nativePath,elapsedMs:e}})))}var fo=l(()=>f("Migrations")),kC=new RegExp(`^(${Ei(pi)}://.*?/)(.*)$`),OC=t=>W(t).filter(It).flatMap(e=>kC.exec(e)).map(e=>e[1].toLowerCase()+e[2]).getOrElse(()=>t);function RC(t,e=ru){return GD(t,e).map(r=>NF(r,e))}function _C(t,e){return se(t,()=>p(RC(t,6)[e],r=>tu(r,ru)))}function NC(t){return t.endsWith(Ho)?t:t+Ho}function UF(t,e){N(e)&&fo().warn("mergeTags(): empty tagIds",{tagIds:e});function r(x){return t.prepare(x).run()}let i=new Map(t.prepare("SELECT id, _path FROM Tag WHERE id IN ("+e.join(",")+")").all().map(({id:x,_path:S})=>[x,S])),o=ie(e.map(x=>{let S=i.get(x);return{id:x,path:S,base:UA(S)}}),x=>[x.base,x.path]);o.reverse(),fo().info("mergeTags()",{arr:o});let n=o[0],s=n.id;if(N(o)||!k(s)){fo().warn("mergeTags(): empty array, or missing winner",{arr:o,winner:n,winnerId:s});return}let a=o.slice(1);if(L(a)){let x=a.map(S=>S.id).join(",");r(`UPDATE OR IGNORE AssetTag SET tagId = ${s} WHERE tagId in (${x})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${x})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${x})`),r(`DELETE FROM AssetTag WHERE tagId in (${x})`),r(`DELETE FROM Tag WHERE id in (${x})`)}let m=t.prepare("select _path from Tag where id = :id").get({id:s})._path,c=On(m),h=t.prepare("SELECT id, _path FROM Tag WHERE id = :winnerId OR _path LIKE :like COLLATE NOCASE").all({winnerId:s,like:Vt(m,Ho)+"%",winnerPath:m});for(let x of h){let S=Yr([...c,...On(Zu(x._path,m))]);x._path!==S&&(fo().info("mergeTags(): repairing tag path",{ea:x,newPath:S}),t.prepare("UPDATE OR IGNORE Tag SET _path = :path, updatedAt = :updatedAt WHERE id = :id").run({id:x.id,updatedAt:Date.now(),path:S}))}return fo().tap({msg:"mergeTags()",level:"info",result:{winner:n,losers:a},meta:{tagIds:e,winnerPath:m}})}function zF(t){let e=t.prepare(["SELECT","rtrim(_path, char(31)) as path,","count(*) AS cnt,","group_concat(id) AS ids","FROM Tag","GROUP BY path","COLLATE NOCASE","HAVING cnt > 1"].join(" ")).all();for(let r of e)r.ids=A(d(r.ids).split(",").map(i=>V(i)));return Kn(e,r=>r.path).reverse(),fo().tap({msg:"dedupeTags()",result:e.map(r=>UF(t,r.ids)),meta:{rows:e}})}var Uy={lowercase_psnet_hostname:t=>{t.function("lowercase_psnet_hostname",{deterministic:!0},OC),t.transaction(()=>{t.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),t.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),t.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")})()},force_stable_channel:async()=>{try{await fl();let t=u.updateChannel.value;t!=="stable"&&(u.updateChannel.value="stable",await Pf(),fo().info("force_stable_channel(): reset updateChannel",{priorValue:t}))}catch(t){fo().error("force_stable_channel(): failed: "+t)}},numeric_captured_at:t=>{t.function("isoToLocal",{deterministic:!0},AA),t.function("isoToOffsetMinutes",{deterministic:!0},Gg),t.function("isoToPrecisionMs",{deterministic:!0},FA),t.transaction(()=>{t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),t.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),t.exec("DROP INDEX asset_captured_at_geohash_idx"),t.exec("DROP INDEX assetfile_exifuid_idx"),t.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")})()},spread_modes:t=>{t.function("plucklabmodeb6",{deterministic:!0},_C),t.transaction(()=>{Te(_n,e=>t.exec(`ALTER TABLE AssetFile ADD COLUMN mode${e} integer`)),t.exec("UPDATE AssetFile SET "+Te(_n,e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`).join(", "))})()},normalize_asset_file_uris:t=>{t.function("normalizeURI",{deterministic:!0},MM),t.transaction(()=>{let e=t.prepare("SELECT normalizeURI(uri) AS nuri, count(*) AS cnt, GROUP_CONCAT(id) AS ids FROM AssetFile GROUP BY nuri HAVING cnt > 1").all(),r=[];for(let i of e){let o=d(i.ids).split(","),n=t.prepare("SELECT id, shown, version, updatedAt FROM AssetFile WHERE id in ("+o.join(",")+")").all(),s=dt(n,m=>[m.shown,m.version,m.updatedAt]),a=n.filter(m=>m.id!==s.id);r.push(...a.map(m=>m.id))}for(let i of Zo(r,256))t.exec("DELETE FROM AssetFile WHERE id in ("+i.join(",")+")");t.exec("UPDATE AssetFile SET uri = normalizeURI(uri)")})()},dedupe_tag_paths:t=>{t.transaction(()=>zF(t))()},suffix_tag_paths:t=>(t.function("tag_path_suffix",{deterministic:!0},NC),t.transaction(()=>{zF(t),t.exec("UPDATE Tag SET _path = tag_path_suffix(_path)")})()),normalize_tag_paths:t=>{let e=t.prepare("SELECT id, _path FROM Tag WHERE _path LIKE '%' || char(31) || char(31) || '%'").all();fo().info("normalize_tag_paths():",{badTags:e});for(let r of e){let i=zA(r._path);UF(t,A([r.id,...t.prepare("SELECT id FROM Tag WHERE _path = ?").pluck().all(i)]))}},drop_tc_tables:t=>{let e=/^(ct|taf|tag_counts)_[a-z0-9]{6}$/i,r=t.prepare("SELECT name FROM sqlite_master WHERE type='table'").pluck().all(),i=r.filter(o=>e.exec(o)!=null);fo().info("drop_tc_tables()",{tables:r,victims:i});for(let o of i)t.exec("DROP TABLE "+o)}};var BC=`
CREATE TABLE IF NOT EXISTS migrations (
  id integer NOT NULL PRIMARY KEY, 
  name varchar(255) NOT NULL, 
  migration_time integer NOT NULL 
)
`;function CC(t){return t.name.includes("_nofk")}var zy=class{constructor(e,r,i){this.migrationsDir=e;this.db=r;this.fsMigrations=l(()=>this.migrationsDir.children(e=>e.ext===".sql"));this.migrationsInDatabase=l(()=>this.db.prepare("SELECT name from migrations").pluck().all());this.assertKnownMigrations=l(()=>{if(!Lo)return;let e=this.migrationsInDatabase().filter(r=>{let[i,o,n]=[r.slice(0,4),r.slice(4,6),r.slice(6,8)].map(a=>V(a)),s=new Date(i,o-1,n);return this.logger.debug("migration filter",{migrationName:r,migrationDate:s,gitDate:Zd}),Zd.getTime()<s.getTime()});if(L(e))throw new ae({fatal:!0,doNotSend:!0,message:"PhotoStructure is not forward-compatible with newer libraries. Please upgrade to open this library",cause:new Error("Unknown migrations: "+e.join(","))})});this.logger=f("Migration("+I({schema:e.base,db:i.nativePath})+")"),r.exec(BC),this.addMigrationStmt=r.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}async apply(e){this.assertKnownMigrations();let r=await this.fsMigrations();if(r==null)throw new Error("no migration files found for "+this.migrationsDir);let i=[],o=this.migrationsInDatabase();for(let n of r)o.includes(n.name)?this.logger.debug("latest(): already applied "+n.base):(await p(e,s=>s(n)),await Ee(this.applyMigration(n),5*E,()=>{throw new ae({fatal:!0,ignorable:!1,message:"Migration "+n.name+" timed out."})}),i.push(n.base));return this.logger.info("up to latest!",{appliedMigrations:i}),i}async applyMigration(e){Dx(e.name);try{let r=Date.now(),i=(await e.readLines()).filter(s=>P(s)||s.trim().startsWith("--")),o=Uy[e.name.replace(/^[\d_-]+/,"")],n=xe(o);if(N(i)&&n)throw new ae({message:"empty migration "+e.name,fatal:!0});return n?await o.bind(Uy)(this.db):await this.applySqlMigration(e),this.logger.debug("applyMigration() completed",{elapsedMs:Date.now()-r,codeMigration:n,migration:e.baseWithParent}),this.db.transaction(()=>{this.addMigrationStmt.run(e.name,Date.now())})()}catch(r){return this.logger.throw("Failed to apply migration "+e.baseWithParent,yr(r))}}async applySqlMigration(e){let r=CC(e);try{let i=d(await e.readFile());if(P(i)){this.logger.error("Empty migration: "+e);return}r&&this.db.pragma("foreign_keys = OFF");for(let o of z(i.split(";")))try{this.db.exec(o)}catch(n){throw new ae({cause:n,fatal:!0,message:`Failed to apply: ${o}`})}if(r){let o=this.db.pragma("foreign_key_check");if(L(o))throw this.logger.error("foreign_key_check failed",o),new Error("Foreign key checks failed during migration "+e.name)}}finally{r&&this.db.pragma("foreign_keys = ON")}}};var qy=M(require("path"));var Wy=M(require("fs-extra"));function kf(t){try{return W(t).filter(T).flatMap(Wy.statSync).flatMap(e=>Number(e.size)).get()}catch{return}}var VC=require("better-sqlite3");function iu(t,e=u.dbTimeoutMs.valueOrDefault){let r;if(u.logSql.valueOrDefault){let i=f("SQLite("+t.split(qy.sep).slice(-2).join(qy.sep)+")"),o=rS();r=n=>i.log(o,n.replace(/\s{2,}/g," "))}return p(kf(t),i=>{u.dbCacheSizeMb.tmpValue=Math.max(u.dbCacheSizeMb.valueOrDefault,Math.ceil(1.1*i/Ki)),f("mkdb("+t+")").info("Dynamically setting dbCacheSize to "+u.dbCacheSizeMb.value,{dbFileSize:i})}),UC(new VC(t,{fileMustExist:!1,readonly:!1,timeout:e,verbose:r}))}function UC(t){let e=['encoding = "UTF-8"',"threads = "+re(1,4,bt()),"foreign_keys = ON","page_size = "+16*_d,"trusted_schema = 0","cache_size = -"+u.dbCacheSizeMb.valueOrDefault*Ki/1024,"locking_mode = NORMAL","journal_mode = WAL","busy_timeout = "+u.dbTimeoutMs.valueOrDefault,"synchronous = NORMAL","auto_vacuum = NONE"];return df(()=>{for(let r of e)t.pragma(r)}),t}var WF=["-wal","-journal"];var mOe=l(()=>f("SQLiteFiles"));function bl(t){return[t,...WF.map(e=>t.sibling(t.base+e))].filter(e=>e.clear().existsSync())}function qF(t,e,r=u.dbTimeoutMs.valueOrDefault){let i=iu(d(t),r);try{return e(i)}finally{i.close()}}async function jF(t,e,r=u.dbTimeoutMs.valueOrDefault){let i=iu(d(t),r);try{return await e(i)}finally{i.close()}}var _Oe=require("better-sqlite3"),Nn=f("SQLite");async function HF(t,e){try{await e.parent().mkdirp_();let r=new pn({path:d(t),op:"Backing up"},100);await jF(t,i=>i.backup(d(e),{progress({totalPages:o,remainingPages:n}){return r.onProgress((o-n)/o*100),100}}),H)}catch(r){throw new ae({cause:r,fatal:!0,message:`Could not back up db ${t} -> ${e}`})}}var zC=[{integrity_check:"ok"}];function GF(t){try{let e=t.pragma("integrity_check");if(yo(e,zC))return Nn.info("verifyDb("+t.name+"): OK"),!0;throw new Error(I(e))}catch(e){throw new ae({cause:e,fatal:!0,retriable:!1,message:"verifyDb("+t.name+") failed"})}}function KF(t){try{return GF(t)}catch{return!1}}function jy(t){return qF(t,GF,H)}var JF=["wal_checkpoint(RESTART)","optimize"];function QF(t){Nn.warn("optimizeDb() starting...",t.name);for(let e of JF)t.pragma(e);Nn.warn("optimizeDb() finished.")}async function $F(t,e="recover",r=!0){let o=(await t.parent().join(e).mkdirpSync_()).join(t.base);Nn.info(`repairDbFile_(${t} -> ${o})`);try{let n=await YM(),s=3*je+await t.size()*1.25,a=10*s,m=new pn({path:d(t),op:"Repairing db"},s),c=new _e,h=gn(n,[t.nativePath,"."+e],5*E,{encoding:"buffer",maxBuffer:a});h.stdout.on("error",F=>J("sqlite "+e+" failed for "+t,new ae({cause:F,fatal:r})));let x=gn(n,[o.nativePath],5*E,{encoding:"buffer",maxBuffer:a});x.on("exit",()=>c.resolve()),h.stdout.on("end",()=>{x.stdin.end(JF.map(F=>"PRAGMA "+F+";").join(`
`))}),h.stdout.on("data",F=>{let U=F.length;m.incrProgress(U),x.stdin.write(F)}),await c,await jy(o),Nn.info(`repairDbFile_(): ${o} is valid, finishing repair.`);let S=await le(bl(t),F=>F.renameYMDHMS_("needed-repair"));return await le(bl(o),F=>F.mv_(t.parent())),S.find(F=>F.ext===".db"||F.ext.startsWith(".sqlite"))}catch(n){return Nn.throw("failed to recover DB via dump and restore. Please see <https://photostructure.com/faq/restore-db-from-backup/> "+ge,n)}}async function YF(t){if(await t.notExists())return;let e=await t.parent().join("version-backup").mkdirp(),r=await e?.childWithSameContents(t);if(e==null||r!=null)return r;let i=e.join(NS()+"-"+t.base);return await Hy(t,i),i}async function Hy(t,e){Nn.info("coldDbBackup(): copying "+t+" to "+e);let r=bl(t).filter(i=>!i.eql(t));await t.copyFile_(e),await le(r,i=>i.copyFile_(e)).catch(i=>Nn.warn("Failed to copy aux db files",i))}var ou=class extends we{constructor(e,r,i=()=>{}){super("Db("+e+")",()=>this.closeDb(),Q.db);this.schema=e;this._dataDir=r;this._onMigration=i;this.endTimeoutMs=E;this.migrate=l(async()=>{let e=this.dbfile;if(this.db==null||e==null)throw new Error("Cannot migrate database: missing db");await this.maybeRepair();let r=l(async()=>(this._onMigration(),YF(e))),i=new zy(ce.for(Hr.Migrations()).join(this.schema),this.db,e);return{appliedMigrations:await i.apply(r),migration:i}});this.onRetry=l(()=>this.closeDb(),u.maxBusyDbMs.valueOrDefault/4)}get datadir(){return w(this._dataDir,qt())}get dbfile(){return qs(this.datadir,this.schema)}get open(){return this._db!=null&&this._db.open}get inTransaction(){return this.open&&this._db?.inTransaction===!0}prepare(e){return this.db.prepare(e)}pragma(e,r){return this.db.pragma(e,r)}get db(){let e=this._db==null;if(!this.open){this.logger.info("setting up new db connection to "+this.dbfile,{priorWasNull:e});try{this.dbfile.parent().mkdirpSync_(),this._db=iu(this.dbfile.nativePath);let r=this._db.pragma("quick_check",{simple:!0});if(r!=="ok")throw new Error("Quick integrity check failed: "+r+ge)}catch(r){throw new ae({cause:r,fatal:!0,message:"Failed to set up "+this.dbfile})}}return this._db}closeDb(){try{this._db?.open===!0&&(this.logger.info("closing db",this._db),this._db?.close())}catch(e){this.logger.warn("closeDb(): .close() failed",e)}this._db=void 0}async maybeRepair(){let e=!0;try{e=KF(this.db)}catch{e=!1}e||(this.logger.warn("maybeRepair(): database failed validation. Trying to restore with dump/load."),await this.repair_())}async vacuum(){await wy(()=>this._vacuum())}async _vacuum(){try{await ff(()=>{QF(this.db),this.db.exec("VACUUM")},this.onRetry)}catch(e){this.logger.warn("vacuum(): vacuum failed, trying to recover by dump-load",e),await this.repair_()}}async repair_(){this.logger.warn("repair_(): Attemping restore of "+this.dbfile),this.closeDb(),await wy(()=>$F(this.dbfile)),this.logger.info("repair_(): Database restoration was successful!")}};var Gy=class{constructor(e,r,i,o=Jh()){this.seq=e;this.set=r;this.name=i;this.stamp=o}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return this.fromBasename(e.base)}static fromBasename(e){return p(this.parseRe.exec(e),r=>new Gy(parseInt(r[2],10),parseInt(r[3],10),r[4],r[1]))}},nu=Gy;nu.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;var wl=class{constructor(e,r,i){this.dir=e;this.sets=r;this.seq=i;this.mods=l(()=>Te(this.sets,e=>Math.pow(2,e)).reverse())}static async for(e,r){return new wl(e,r,w(await wl.maxSeq(e),-1))}static async maxSeq(e){return is([...D(await b(e.childNames(),r=>r.map(i=>nu.fromBasename(i)?.seq)))])}set(e){return this.sets-this.mods().findIndex(r=>e%r==0)}next(e){let r=++this.seq;return new nu(r,this.set(r),e)}async hanoiFiles(){let e=await this.dir.clear().childNames();return A(e?.map(r=>nu.fromBasename(r)))}async validHanoiFiles(e){let r=await ye(e,()=>this.hanoiFiles()),i=ql(r,n=>n.set),o=[];for(let n of i.keys())p(dt(i.get(n),s=>s.seq),s=>o.push(s));return o}async staleHanoiFiles(e){let r=await ye(e,()=>this.hanoiFiles()),o=(await this.validHanoiFiles(e)).map(n=>n.seq);return r.filter(n=>!o.includes(n.seq))}async staleFiles(){return this.staleHanoiFiles().then(e=>e.map(r=>r.toFile(this.dir)))}};var Of=M(require("process"));function su(){return Of.stdout==null||Of.stdout.destroyed||Of.stdout.writableEnded}function Ky(t,...e){su()||console.log(t,...e)}var ERe=1*ft;var Jy=class extends Ii{constructor(e,r,i,o,n,s=()=>{},a=()=>{}){super({name:"DbBackup("+i+")",callback:()=>this.backup(),intervalMs:u.dbBackupIntervalMinutes.valueOrDefault*E,rank:Q.predb});this.db=e;this.isLockOwner=r;this.srcDbFile=i;this.backupsDir=o;this.replaceDir=n;this.beforeBackup=s;this.onBackupFinished=a;this.endTimeoutMs=E;this.mutex=new tt;this.hanoi=l(()=>wl.for(this.backupsDir,u.dbBackupsCount.valueOrDefault));$n()||this.onEnds.push(async()=>{await this.mutex.serial("DbBackup.end()",async()=>{Lr()&&Ky("Verifying & backing up "+e.dbfile+"..."),await this._backup(!0),Lr()&&Ky("PhotoStructure library db has been backed up to "+o+".")})})}backup(){return this.mutex.maybeRun("DbBackup.backup()",()=>this._backup())}async _backup(e=this.ended){if(!await this.isLockOwner()){this.logger.info("backup(): not lock owner, no-op.");return}if(!e&&!this.db.open){this.logger.warn("backup(): db is already closed.",this.db.name);return}if(await this.srcDbFile.clear().isEmpty()){this.logger.warn("backup(): db is missing.",this.srcDbFile.nativePath);return}try{this.logger.info("backup(): beforeBackup...",{srcDb:this.srcDbFile.nativePath,backupsDir:this.backupsDir.nativePath}),await this.beforeBackup(),e&&this.db.open&&(this.logger.info("backup(): closing db before backup..."),await this.db.closeDb());let r=this.srcDbFile.parent().join("backup",this.srcDbFile.base);this.logger.info("backup(): starting backup to "+r),await HF(this.srcDbFile,r),this.logger.info("backup(): backup taken. Verifying "+r),await jy(r),this.replaceDir!=null&&(this.logger.info("backup(): Copying to "+this.replaceDir),await Hy(r,this.replaceDir));let i=await bl(r),o=await this.hanoi(),s=o.next("").toFilename();this.logger.info("backup(): Rotating files to "+this.backupsDir.join(s));for(let a of i)await a.mv_(this.backupsDir.join(s+a.base),{overwrite:!0});for(let a of await o.staleFiles())this.logger.info("backup(): removing stale backup "+a),await a.unlink();this.logger.info("backup(): finished successfully"),await this.onBackupFinished()}catch(r){this.logger.throw(r,{from:"DbBackup._backup() failed",fatal:!0,srcDb:this.srcDbFile.nativePath})}}};var XF=l(async()=>{let t=io().join("local-db");return await t.join("README.txt").writeTxt_(`
This folder is only used when your library is on a remote filesystem.

You will corrupt your library if you remove this directory while PhotoStructure is
running.

If you have any questions, please visit <https://photostructure.com/support/>.`),t});var Qy=4,$y=8,Yy=Qy**$y;function ZF(){return Ct(0,Yy)}function Rf(t,e,r){let[i,o,n,s,a]=WC(t),m=e,c=`(${i}*${m}*${m}+${o}*${m})%${r}`,h=`(${n}*${m}+${s})%${r}`;return`((${c})*(${h})+${a})%${r}`}var qC=[[353868013,472882027,479001599,517294153],[1012573,1230587,1355297,1572751],[756065159,812182027,899809343,989450477],[3959297,4514113,4823201,5133127],[573259391,666101999,694847533,746151647],[2275327,2770513,3073703,3511973],[173313197,182557181,203457869,222230231],[6054613,6189107,7752103,9852103]],e0=[1012573,1101689,1183811,1196089,1230587,1355297,1419641,1483733,1572751,2275327,2770513,3010349,3073703,3118691,3174823,3511973,3959297,4514113,4690451,4823201,5133127,5375327,6019889,6054613,6189107,7752103,7752103,9852103];function jC(t){return ih(Qy,t,$y).map((r,i)=>qC[i][r])}var WC=bp(t=>{let[e,r,i,o,n,s,a,m]=jC(t%Yy),c=[e/r,i/o,n/s,a/m].map(h=>ve(h,7));return c.push(e0[t%e0.length]),c},{maxSize:128,ttlMs:E});var Xy=class{constructor(e){this.id=e}nextAssetBatch(e){let r={};return p(e,i=>r.capturedAtLt=i.getTime()),qh(`/tag-gallery/${this.id}`,r)}};var hi=class extends Ko{$pk(){return[w(this.assetId,()=>p(this.asset,e=>e.id)),w(this.tagId,()=>p(this.tag,e=>e.id))].join(":")}static addTagsToAsset(e,r){let i=pd(e);if(i==null){this.logger().warn("addTagsToAsset(): got null assetId");return}let o=A(r.map(pd));if(N(o)){this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:r});return}let n="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+o.map(s=>`(${i},${s})`).join(",");return this.dbl.run(n)}static removeTagsFromAsset(e,r){r=A(r);let i=this.query().whereIn("tagId",r).andWhere({assetId:e}).delete();return this.dbl.run(i)}};hi.tableName="AssetTag",hi.uniqueColumnName="assetId,tagId";function _f(t){return{id:t.id,at:t.capturedAtLocal}}var Zy=class{constructor(e,r,i,o){this.tags=e;this.before=r;this.after=i;this.limit=o;this.logger=()=>f("TaggedAssetStream("+this.toString()+")");this.logger().info("new",this.toJSON())}vacuum(){Kn(this.before,e=>[-e.capturedAtLocal,-e.id]),zw(this.before,this.limit),Kn(this.after,e=>[-e.capturedAtLocal,-e.id]),Yu(this.after,this.limit)}toString(){return this.tags.map(e=>e.path.join("/")).join(",")}valueOf(){return this.toString()}get length(){return D(this.before).length+D(this.after).length}leftPad(e){return[...Te(this.limit-e.length,r=>({id:-(r+1),v:0})),...e]}rightPad(e){return[...e,...Te(this.limit-e.length,r=>({id:-(r+this.limit+1),v:0}))]}toJSON(){return{tags:this.tags.map(e=>e.toString()),assetIdsAfter:this.after.map(_f),assetIdsBefore:this.before.map(_f)}}mergeWith(e){Bu(this.tags,e.tags,r=>r.path),Bu(this.before,e.before,r=>r.id),Bu(this.after,e.after,r=>r.id),this.logger().debug("mergeWith() complete",{tas:e.toJSON(),tags:this.tags.map(r=>r.path),beforeIds:this.before.map(_f),afterIds:this.after.map(_f)})}async toApi(){return this.vacuum(),this.logger().tap({msg:"toApi()",result:{tags:await le(this.tags,e=>e.toApiTag()),assetIdsAfter:this.leftPad(this.after.map(e=>e.toID())),assetIdsBefore:this.rightPad(this.before.map(e=>e.toID()))}})}streamCoeff(e){return this.logger().tap({msg:"streamCoeff",meta:{this:this.tags.map(r=>r.path),tas:e.tags.map(r=>r.path)},result:Bw([...this.before,...this.after],[...e.before,...e.after],r=>r.id)})}};function t0(t){let e=u.minStreamCorrPct.valueOrDefault/100,r=[],i=t.filter(o=>o.length>5);for(let o of i){let n=dt(r,s=>dw(s.streamCoeff(o),e));n==null?r.push(o):n.mergeWith(o)}return r}function r0(t){return t.orderByRaw("COALESCE(ordinal, _path) COLLATE NOCASE")}j(()=>Re.clear());async function i0(t){let e=await t;return e!=null&&Re.cacheTag(e),e}var be=class extends tr{constructor(){super(...arguments);this.urls=l(()=>new Xy(this.id));this.displayPath=l(async()=>{let e=await this.getParent();return[...e==null?[]:await e?.displayPath(),this.displayName]});this.descendantIds=l(async()=>be.dbl.pluckAll({sql:zi("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT id ","FROM descendants","WHERE id <> :tagId"),bindings:{tagId:this.id}}),7*v);this.ancestorIds=l(async()=>this.parentId===0||this.parentId==null?[]:be.dbl.pluckAll({sql:zi(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT id","FROM Tag","WHERE Tag.id in ancestors","  AND Tag.id <> :tagId","ORDER BY _path DESC"].join(" ")),bindings:{tagId:this.id}}))}static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this.recentTagsByPath.clear(),this.tagById.clear()}static cacheTags(e){return e.map(r=>this.cacheTag(r))}static cacheTag(e){return e!=null&&this.recentTagsByPath.set(e._path,Promise.resolve(e)),e?.id!=null&&this.tagById.set(e.id,Promise.resolve(e)),e}static newTag(e){let r=new be;r._path=Yr(e);let i=e[e.length-1];return i!=null&&Au(i)&&(p(i.displayName,o=>r._displayName=o),p(i.ordinal,o=>r.ordinal=o),p(i.description,o=>r.description=o),p(i.releasedAt,o=>r.releasedAt=o)),r}static findByIdOrPath(e,r){return e===0?be.root():k(e)?this.findById(e):this.findByPath(r)}static findById(e){return e===0?be.root():be.tagById.getOrSet(e,()=>i0(this.ops().findById(e)))}static async findByPath(e){let r=Yr(e);return P(r)?be.root():be.recentTagsByPath.getOrSet(r,()=>b(this.ops().firstf(i=>i.where("_path","like",r)),i=>be.cacheTag(i)))}static getPagedAssets(e,r){let i=new be;return i.id=e,i.getPagedAssetIds(r)}static async findOrCreate(e){if(N(e))throw new Error("empty tagPath");let r=Yr(e,"/"),i=await this.findByPath(e);if(this.logger().debug("_findOrCreate("+r+")",{prior:i}),i!=null)return i;let o=this.newTag(e),n=o.depth<=1?void 0:await this.findOrCreate(e.slice(0,-1));p(n,a=>o.parentId=a.id);let s=await i0(this.ops().upsertOne(o));return this.logger().debug("_findOrCreate("+r+") upserted",{newTag:o,result:s,parent:n}),s}clear(){return this.parent=void 0,this.root=void 0,this.children=void 0,this.ancestors=void 0,this.assets=void 0,this.relatedAssets=void 0,this.ancestorIds.unset(),this.descendantIds.unset(),this}siblingPath(e){return Yr([...this.parentPath,e])}async changeName(e){return this.changePath(this.siblingPath(e))}maybeUpsertDisplayName(e){return P(e)||e===this._displayName?void 0:this.upsert({_displayName:e})}async changePath(e,r=!0){let i=this._path,o=await be.findByPath(On(e));this.logger().info("changePath(): ",{priorPath:i,newPath:e,existingSibling:o});try{o==null?(await be.tx(async()=>{await be.dbl.runf(n=>n.where("_path","LIKE",i+"%").update({updatedAt:Date.now(),_path:po.raw("REPLACE(_path, ?, ?)",[i,e])}))}),this._path=e):(e=o._path,this.logger().info("changePath(): replacing with sibling",e),await hi.dbl.updateOrIgnore(n=>n.where({tagId:this.id}).update({tagId:o.id})),await hi.dbl.runf(n=>n.where({tagId:this.id}).delete()),await le(this.getChildren(),n=>n.changePath(Yr([...o.path,n.name]),!1)),await be.dbl.runf(n=>n.where({parentId:this.id}).update({parentId:o.id})),await this.delete())}finally{r&&be.clear()}}get name(){let e=this.path;return e[e.length-1]}get path(){return On(this._path)}get displayName(){return T(this._displayName)?this._displayName:this.name}get isRoot(){return this.id===0}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}get sortBy(){return[this.ordinal==null?2**51:this.ordinal,this.path.map(e=>e.toLowerCase())]}$childrenQuery(){return r0(be.query().where({parentId:this.id}))}$assetsQuery(){return it.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],p(this.parent,r=>r.setAncestors(e.slice(0,-1)))}async toApiPathElements(){return le(this.getAncestorsAndSelf(),e=>({tagPath:e.path,displayName:e.displayName}))}async toApiTag(){return{tagId:this.id,tagPath:this.path,displayPath:await this.displayPath(),description:this.description,assetCount:this.assetCount,assetFileCount:this.assetFileCount}}toStringId(){return"Tag("+this.path.join("/")+")"}async getParent(){if(!this.isRoot)return this.parentId!=null&&this.parent==null?this.parent=await be.findById(this.parentId):this.parent}async getPagedChildren(e){if(this.id===0){let o=w(e.offset,0),n=o+w(e.limit,this.children.length);return[...this.children].slice(o,n)}let r=this.$childrenQuery();se(e.offset,o=>{r.offset(o)}),se(e.limit,o=>void r.limit(o));let i=await be.ops().all(r);for(let o of i)be.cacheTag(o);return i}async getDescendants(){return be.ops().all({sql:zi("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN descendants","  AND Tag.id <> :tagId"),bindings:{tagId:this.id}})}async getChildrenCount(){return this.children!=null?this.children.length:be.dbl.pluckFirstf(e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count())}async getChildren(){return this.children=await be.ops().all(this.$childrenQuery()),this.children.forEach(e=>{e.parent=this}),this.children}link(){return"/tag/"+this.path.map(encodeURIComponent).join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}async getAncestors(){if(this.ancestors==null){let e=qw(this.parentPath).map(o=>Yr(o)),r=await Promise.all(e.map(o=>be.recentTagsByPath.get(o)));if(r.every(o=>o!=null))return this.ancestors=r;let i=be.query().whereIn("_path",e).orderBy("_path");this.ancestors=await be.ops().all(i),be.cacheTags(this.ancestors),this.parent=w(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}async getAncestorsAndSelf(){return[...await this.getAncestors(),this]}async _getAncestors(){return this.parentId===0||this.parentId==null?[]:be.ops().all({sql:zi(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN ancestors","  AND Tag.id <> :tagId","ORDER BY Tag._path DESC"].join(" ")),bindings:{tagId:this.id}})}getPagedAssetIds(e){let r=this.$assetsQuery().select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal"),i="desc";return rn(e.capturedAtLt,o=>{r=r.where("capturedAtLocal","<",o)}),rn(e.capturedAtGt,o=>{r=r.where("capturedAtLocal",">",o),i="asc"}),rn(e.limit,o=>{r=r.limit(o)}),r=r.orderBy("capturedAtLocal",i),it.dbl.all(r)}getAssets(){let e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return it.ops().all(e)}async assetCountDesc(e){let r=this.assetCount;return(r==null||e==null||e.length===r||e.length===0?"":Ti(e.length)+" of ")+as(r,"asset")}$assetStreamQuery(e,r,i){let o=this.path[0]===Oe.When?it.shownUnhidden():this.$assetsQuery();return o=o.distinct().where("capturedAtLocal",i,e.capturedAtLocal).andWhereNot("Asset.id",e.id).limit(i==="="?r*2:r),i==="="?o.orderByRaw(`ABS(Asset.id-${e.id})`):o.orderBy([{column:"capturedAtLocal",order:i===">"?"asc":"desc"},"Asset.id"])}async getAssetStream(e,r){r=k(r)?r:OA;let[i,o,n]=await le(["<","=",">"],s=>it.ops().all(this.$assetStreamQuery(e,r,s)));for(let s of o)s.id<e.id?i.push(s):n.push(s);return new Zy([this],i,n.reverse(),r)}async getRelatedAssetIds(e,r=kA){let i=Math.max(256,await HC()),o=await hi.dbl.allf(n=>n.select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal").distinct().join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).andWhere("Asset.excluded",0).andWhere("Asset.hidden",0).orderByRaw(Rf(e+w(this.id,0),"Asset.id",i)).limit(r));return this.logger().debug(this.path+": Found "+o.length+" related assets",o),o}get attrs(){return{href:this.link(),title:this.name}}},Re=be;Re.tableName="Tag",Re.uniqueColumnName="_path",Re.recentTagsByPath=new Ce(256),Re.tagById=new Ce(256,E),Re.cmp=(e,r)=>Bt([w(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[w(r.ordinal,Number.MAX_SAFE_INTEGER),...r.path]),Re.root=l(async()=>{let e=new be;return e.id=0,e._path=Ho,e.parentId=void 0,e.children=(await be.roots()).filter(r=>!tn(u.hiddenHomeTags.valueOrDefault,r.name)),e.ancestors=[],e.assetCount=await it.shownAssetCounts(),e.upsert=()=>{throw new Error("upsert not supported on root")},e},7*v),Re._upsertDefaultRoots=l(()=>be.ops().upsert(VA.map(e=>({_path:Yr([e.name]),ordinal:e.ordinal})))),Re.roots=l(async()=>{await be._upsertDefaultRoots();let e=await be.ops().all(r0(be.query().whereNull("parentId")));return e.forEach(r=>{r.parentId=void 0,r.ancestors=[],be.cacheTag(r)}),e});var HC=l(()=>it.dbl.pluckFirstf(t=>t.count()),E);var GC=`'${Oe.When}' || char(31)`,KC=GC+" || '%' || char(31)",o0=KC+" || '%' || char(31)",JC=o0+" || '%' || char(31)",n0=l(()=>f("DateTagNormalizer"));async function QC(){return Re.ops().allf(t=>t.whereNotNull("ordinal").andWhereRaw("_path LIKE "+o0+" AND _path NOT LIKE "+JC).limit(200*12))}async function s0(){await Re.tx(async()=>le(QC(),$C))}async function $C(t){let e=await se(t.ordinal,r=>xy(NA(r)));e==null?n0().warn("failed to fix tag (no monthTagRef)",{t}):e.name!==t.name&&(n0().info("Fixing month name",{tagRef:e,tag:t}),await t.changeName(e.name)),await t.maybeUpsertDisplayName(e?.displayName)}var a0=M(require("os")),l0=M(require("process"));var Ri=Se("rebuildLibrary","forceRestartSync","enqueueAssetFileUpdates","enqueueAssetUpdates","applyNewTagger"),eb=class extends tr{static incomplete(){return this.ops().allf(e=>e.whereIn("id",r=>r.table(eb.tableName).min("id").whereNull("completedAt")))}static async getFirstPendingOp(e){return this.logger().tap({msg:"getFirstPendingOp",level:"info",result:await this.ops().firstf(r=>{let i=r.whereNull("completedAt").orderBy("createdAt","asc");return e!=null?i.andWhere(e):i}),meta:{pojo:e}})}static markOpCompleted(e){return P(e?.name)?this.logger().throw("markOpCompleted(): bad query",{query:e}):this.dbl.runf(r=>r.whereNull("completedAt").andWhere(e).update({completedAt:Date.now()}))}static async applyOnce(e,r,i=Vr){let o=await this.ops().firstf(a=>i(a.whereNotNull("completedAt").andWhere(e)));if(o!=null){this.logger().info("applyOnce(): already done",{prior:o});return}let n=await this.ops().insertOne(e),s=await r(n);return C()||await n.upsert({completedAt:Date.now()}),s}},Sr=eb;Sr.tableName="Operation",Sr.uniqueColumnName="id";var js=Se("lastScannedDirectory","scannedDirectoryCount","completedDirectoryScan","enqueuedStaleFiles","processedImageCount","processedVideoCount"),Bn=class extends tr{};Bn.tableName="ProgressMeta",Bn.uniqueColumnName="progressId,name";var m0=l(()=>v*(bt()<=3?3:1.5)),YC=zi(`
SELECT
  p1.uri as uri,
  p1.lastUpdatedAt as lastUpdatedAt,
  p1.lastCompletedAt as lastCompletedAt,
  min(p2.createdAt) AS lastStartedAt
FROM
  (
    SELECT
      uri,
      max(updatedAt) AS lastUpdatedAt,
      max(completedAt) AS lastCompletedAt
    FROM
      Progress
    WHERE
      createdAt > :minCreatedAt
    GROUP BY
      uri
  ) AS p1
  JOIN Progress AS p2
    ON 
      p2.uri = p1.uri AND 
      p2.createdAt > :minCreatedAt AND
      (p2.createdAt > ifnull(p1.lastCompletedAt, 0) OR p2.completedAt = lastCompletedAt)
GROUP BY
  1,2,3
`),XC=zi(`
SELECT
  *
FROM
  ProgressMeta
WHERE
  id IN (
    SELECT
      max(pm.id)
    FROM
      ProgressMeta pm
      JOIN Progress p ON pm.progressId = p.id
      AND p.createdAt > :minCreatedAt
    WHERE
      p.uri = :uri
      AND p.hostname = :hostname
    GROUP BY
      p.uri,
      pm.name
  )
`),Nf=class extends tr{static async vacuum(e=90*lt){await Bn.dbl.runf(r=>r.whereIn("progressId",i=>i.table("Progress").select("id").where("createdAt","<=",Date.now()-e)).delete()),await this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async minCreatedAt(){let e=await Sr.getFirstPendingOp({name:Ri.forceRestartSync});return Nf.logger().tap({msg:"minCreatedAt",level:"info",result:w(e?.createdAt,0),meta:{op:e}})}static async times(){let e=await this.minCreatedAt();return this.dbl.all({sql:YC,bindings:{minCreatedAt:e}})}static async saveSyncState(e){return le(D(await e.progress()),r=>(r.state==="done"&&r.completedAt==null&&(this.logger().warn("caller saved done sync state without setting completedAt",Sc()),r.completedAt=Date.now()),r.id==null?this.logger().throw(e.name+" returned an unsaved Progress",r):r.upsert()))}static async insertNew(e,r){return this.ops().insertOne({uri:e,volume:r,pid:l0.pid,hostname:(0,a0.hostname)()})}toSyncState(){return{id:this.id,uri:this.uri,volume:this.volume,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return w(K(this.dekJSON,()=>z(JSON.parse(this.dekJSON))),()=>[])}set dek(e){this.dekJSON=I(z(e))}assignFromPojo(e){return Go(this,e)}getThisMeta(){return Bn.ops().allf(e=>e.where({progressId:this.id}).orderBy("createdAt"))}async getMeta(){return Bn.ops().all({sql:XC,bindings:{minCreatedAt:await Nf.minCreatedAt(),uri:this.uri,hostname:this.hostname}})}setMeta(e,r){return Bn.ops().upsertOne({progressId:this.id,name:e,value:r})}async getMetaAsRecord(){return mt((await this.getMeta()).map(e=>[e.name,e.value]))}},Ft=Nf;Ft.tableName="Progress";var Hs=M(require("path"));var jNe=Ue.lift(t=>t.isFile()),HNe=Ue.lift(t=>t.isReadable());function au(t){return Ue.lift(async e=>he(ct(e,!1),t,()=>!1))}function u0(t){return au(e=>Qu(...t.map(r=>e[r])))}var ZC=Ue.lift(async t=>{let e=await Rs(t);if(e==null||!e.startsWith("image/")&&!e.startsWith("video/"))return!1;let r=e.startsWith("video/")?u.minVideoDimension.valueOrDefault:u.minImageDimension.valueOrDefault;return he(nl(t),i=>Hn(i.ImageWidth,r)&&Hn(i.ImageHeight,r),()=>!1)}),eV=Ue.lift(async t=>{let e=await Rs(t);if(e==null)return!1;if(!e.startsWith("video/"))return!0;let r=await ct(t,!1);return r==null?!1:Hn(Za(r),u.minVideoDurationSec.valueOrDefault)}),tV=u0(["MIMEType"]),rV=u0(["Make","Model"]),iV=au(t=>V(t.Rating,{defaultValue:0})>=0),GNe=au(t=>So(["image/jpeg","image/png"],d(t.MIMEType))),oV=au(t=>d(t.MIMEType).startsWith("image/")),nV=au(t=>d(t.MIMEType).startsWith("video/")),sV=oV.and(rV).or(nV);async function aV(t){return!P(t)&&(Jp(t)||En(t)||xr(t)&&await Bm()||Cs(t)&&await Yp())}var lV=Ue.lift(async t=>he(Rs(t.nativePath),aV,()=>!1)),tb=Ue.lift(async t=>!Am(t.nativePath)),c0=Ue.lift(async t=>Et(ro(t))),p0=Ue.lift(async t=>he(t.size(),e=>Pt(u.minAssetFileSizeBytes.valueOrDefault,u.maxAssetFileSizeBytes.valueOrDefault,e),()=>!1)),f0=Ue.andLogged(f("fileFilterNoStat"),{exifExtFilter:sf},{notHiddenCheap:tb}),KNe=Ue.andLogged(f("fileFilterCheap"),{exifExtFilter:sf},{notHiddenCheap:tb},{noMediaFilter:c0},{fileSizeFilter:p0}),mV=l(()=>A([{exifExtFilter:sf},{fileSizeFilter:p0},{notHiddenCheap:tb},{noMediaFilter:c0},{hasMimeType:tV},{supportedMimeTypeFilter:lV},u.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:sV}:void 0,{notRejected:iV},{minDimensionsFilter:ZC},u.minVideoDurationSec.valueOrDefault>0?{minVideoDurationFilter:eV}:void 0])),d0=l(()=>Ue.andLogged(f("fileFilterExpensive"),...mV())),JNe=Ue.lift(async t=>P(t.ext)),QNe=Ue.lift(async t=>t.isDirectory());function rb(t,e){for(let r of e){let i=t[r];if(T(i))return r+":"+d(i).trim()}}function h0(t){return rb(t,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"])}function g0(t){{let e=rb(t,["LensSerialNumber","LensID"]);if(e!=null)return e}return p(mf(t),({lensMake:e,lensModel:r})=>`${e.toLowerCase()}/${r.toLowerCase()}`)}function y0(t){return rb(t,["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"])}var b0=[{ms:bw,s:"year",p:"years"},{ms:30.4*lt,s:"month",p:"months"},{ms:Uu,s:"week",p:"weeks"},{ms:lt,s:"day",p:"days"},{ms:ft,s:"hour",p:"hours"},{ms:E,s:"minute",p:"minutes"},{ms:v,s:"second",p:"seconds"}];function lu(t,e=2,r){if(!ku(t))return oe(t)?"-"+lu(Math.abs(t),e):"";let i=b0.findIndex(s=>s.ms<=t);if(i===-1)return"";let o=t,n=A(b0.slice(i,i+e).map(s=>{if(!(s.ms>o)){let a=Math.floor(o/s.ms);return o-=a*s.ms,{i:a,s:as(a,s.s,s.p)}}}));return N(n)?"":n.map(s=>s.s).join(", ")+Z(r,s=>" "+(n[n.length-1].i!==1?s.singular:s.plural),"")}var L1e=l(()=>f("FilePathTagger"));function ib(t){let e=Pm(t),r=e.scheme===to?Tf:e.authority,i=e.path.split("/").slice(0,-1);return z([Oe.FS,r,...i])}async function w0(t,e){return it.addTags(t,e.map(ib))}var ob=class extends tr{constructor(){super(...arguments);this.posixFile=l(()=>X.forUri(this.uri,this.mountpoint))}static async recentAssetIdsByUriRoot(e,r,i=64){let o=Date.now()-r,n=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",o).andWhere("Asset.shown",1).andWhere("Asset.hidden",0);return T(e)&&(n=n.andWhere("AssetFile.uri","like",e+"%")),n=n.orderBy("AssetFile.updatedAt","desc").limit(i),this.logger().debug("recentAssetIdsByUriRoot",n.toSQL()),this.dbl.pluckAll(n)}static assetCountByMimetype(e){let r=this.query().select(po.raw("mimetype, count(*) as count")).join("Asset","Asset.id","AssetFile.assetId").where("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0);return T(e)&&(r=r.andWhere("uri","like",e+"%")),r=r.groupBy("mimetype").orderBy("mimetype"),this.dbl.all(r)}static async assetCountByMimetypeRoot(e){let r=await this.assetCountByMimetype(e);return dr(G(r.map(o=>o.mimetype.split("/")[0]))).map(o=>({mimetypeRoot:o,count:Ou(r,n=>n.mimetype.startsWith(o+"/")?n.count:0)}))}static children(e,r){let i=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${Ei(e)}/[^/]+$}`);return this.ops().all(Z(r,o=>o(i),()=>i))}get capturedAtDateTime(){return pp(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return EA(this.capturedAtDateTime,e)}static outdatedQuery(e){let r=this.query().where("version","<",kr).orderBy("id");return N(e)?r:r.andWhere(i=>i.whereIn("mountpoint",e).orWhereNull("mountpoint"))}static async nextOutdated(e=Vr){return this.ops().findOne(e(this.outdatedQuery(await xt())))}static async outdatedCount(e=Vr){let r=this.outdatedQuery(await xt());return this.dbl.pluckFirst(e(r.count("id")))}static async setShown(e,r){if(this.logger().info("setShown()",{assetId:e,assetFileId:r}),!k(e)||!k(r))throw new Error("setShown(): invalid IDs: "+I({assetId:e,assetFileId:r}));await this.dbl.runf(n=>n.update("shown",0).where("assetId",e));let i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),o={assetId:e,assetFileId:r,updatedAt:Date.now()};return this.dbl.run({sql:i,bindings:o})}static async findByAsset(e,r){let i=this.query().select("AssetFile.*");return p(xi(e),o=>i.join("Asset","Asset.id","AssetFile.assetId").where(Yo(o,(n,s)=>["Asset."+n,s]))),p(xi(r),o=>i.where(Yo(o,(n,s)=>["AssetFile."+n,s]))),this.ops().all(i)}get modes(){return A(Te(_n,e=>this["mode"+e]))}set modes(e){Te(_n,r=>this["mode"+r]=e[r])}async matchesFile(e){if(this.version==null||this.version<kr||u.forceSync.valueOrDefault)return!1;let r=await this.fileFields(e);return px(r,this)}fileFields(e){return Dt(e).orElse(()=>this.posixFile()).filter(r=>r.exists()).flatMap(async r=>({uri:await r.uri(),fileSize:await r.size(),mtime:await r.thisOrSidecareMaxMtimeMs()})).filter(Ku).get()}isVersionUpToDate(){return Ci(this.version,kr)}async siblingCount(){return ob.dbl.pluckFirstf(e=>e.count().where({assetId:this.assetId}).andWhereNot({id:this.id}))}async upsertIfNeeded(){let e=u.forceSync.valueOrDefault;if(await this.matchesFile()&&k(this.id)&&!e)return this.upsert();if(await this.isFileDeleted()){this.deleted=!0,await this.delete();return}if(!await this.notExists())return b(this.updateFromFile(),()=>this.upsert())}async maybeUpdateStats(e){return b(this.fileFields(e),r=>ba(this,r))}async updateFromFile(e){let r=Date.now(),i=this.logger().addContext(".updateFromFile()");if(i.debug("before",this),this.id!=null&&await this.matchesFile(e)){i.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");return}if(e!=null&&await this.setFile(e),e==null&&(e=await this.posixFile()),e==null||await e.notExists()){i.info("no-op, "+e+" is missing");return}if(this.mountpoint==null&&await b(e.mountpoint(),x=>this.mountpoint=x.nativePath),await this.maybeUpdateStats(e)==null){i.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});return}let o=e.sha(),n={},s=await qm(e);if(s==null){i.error("missing tags for "+e);return}if(P(s.MIMEType)){i.error("missing MIMEType for "+e);return}n.mimetype=s.MIMEType;let a=s.capturedAt,m=a.toLocal();if(m==null)return i.throw("bad CapturedAt",a);n.capturedAtLocal=m,n.capturedAtOffset=a.toOffset(),n.capturedAtPrecisionMs=a.toPrecisionMs(),n.capturedAtSrc=a.src,p(s.exposureSettings,x=>{n.focalLength=x.focalLength,n.aperture=x.aperture,n.shutterSpeed=x.shutterSpeed,n.iso=x.iso});let c=s.dimensions;if(n.width=c.width,n.height=c.height,n.rotation=s.rotation,n.make=s.Make,n.model=s.Model,n.cameraId=h0(s),n.imageId=p(y0(s),d),n.lensId=g0(s),n.geohash=KD(s.GPSLatitude,s.GPSLongitude),n.durationMs=p(s.duration,x=>Math.round(x*1e3)),n.fps=p(ni(s.VideoFrameRate),Ye),n.sha=await o,n.sha==null){i.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri});return}(u.useImageHashes.valueOrDefault||u.strictDeduping.valueOrDefault)&&await b(VF(e),x=>{n.meanHash=x.meanHash,n.modes=x.modes}),ba(this,n),this.version=kr;let h=Date.now()-r;return i.log(h>v?"info":"debug","after ("+h+"ms)",this),this}async updateFromShaSibling(e){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:e.sha==null||!e.isVersionUpToDate()||this.sha!=null&&e.sha!==this.sha?this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e}):(ba(this,jt(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt")),this)}async getAsset(){return this.assetId==null||this.asset!=null?this.asset:this.asset=await it.ops().findById(this.assetId)}async exists(){return he(this.posixFile(),e=>e.exists(),()=>!1)}async notExists(){return Et(this.exists())}async isFileDeleted(){return he(this.posixFile(),e=>e.isDeleted(this.uri),()=>!1)}async isFiltered(){return Dt(this.posixFile()).filter(e=>e.exists()).flatMap(e=>d0().apply(e)).map(e=>!e).getOrElse(()=>!1)}async hasNoMedia(){return he(this.posixFile(),e=>e.hasNoMedia(),()=>!1)}async setFile(e){let r=await e.uri();if(r==null)return this.logger().throw("setFile(): no URI for "+e);let i=await e.mountpoint();if(i==null)return this.logger().throw("setFile(): no mountpoint for "+e);if(this.uri!=null&&!await PM(r,this.uri))return this.logger().throw("setFile(): cannot reassign non-equivalent URI",{prior:this.uri,new:r,file:e.nativePath});if(await e.uriObject()==null)throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);return this.uri=r,this.mountpoint=i.nativePath,this.posixFile.set(Promise.resolve(e)),r}nativePath(){return b(this.posixFile(),e=>e.nativePath)}toCapturedAt(){return p(pp(this.capturedAtLocal,this.capturedAtOffset),e=>b(this.posixFile(),r=>new cl(r.nativePath,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}async downloadables(e,r){try{let i=await this.posixFile();if(i==null)return[];let o=e.ap(this.assetId),n=[];if(await i.isNonEmpty()&&n.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:Sy(i,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:i.base,description:"Download original",details:`(${Qr(this)} ${i.ext})`}),this.isVideo||!(O(this.shown)||this.sha===r))return n;let a=A(await Promise.all([...await o.previews()].reverse().filter(m=>m.reducer===er.fit).map(m=>YA(i.base,m))));return n.push(...Mo(a,m=>m.size)),n}catch(i){return J("AssetFile.downloadables failed",i,{context:this}),[]}}async pathInfo(){try{let e=ke.parse(this.uri),r=await Os(e,this.mountpoint);if(r==null){this.logger().warn("pathInfo(): failed to build nativePath",{uri:this.uri});return}let i=e.fsPath,o=gr(r,i).split(Hs.sep),n=o.pop(),s=i.split(Hs.sep),a=ib(e),m=await Re.findByPath(a);if(m==null){this.logger().warn("pathInfo(): failed to find existing Tag",{tagPath:a});return}let c=await m.toApiPathElements();this.logger().info("pathInfo()",{uri:this.uri,fsPath:i,nativePath:r,mountpointParent:o,pathAfterMountpointParent:s,mountpointName:n,tag_path:m.path,pathElements:c}),c.shift(),P(n)?c.shift():c[0].displayName=n,s.splice(0,c.length);let h={nativePath:r,nativePathPrefixWbr:ex(o.join(Hs.sep)+Hs.sep),pathElements:c,nativePathSuffix:s.join(Hs.sep),pathSep:Hs.sep,exists:await this.exists()};return this.logger().info("pathInfo()",{result:h}),h}catch(e){this.logger().warn("pathInfo(): failed",e);return}}async toApi(e,r){return b(this.pathInfo(),async i=>Ul(g(g({assetId:this.assetId,assetFileId:this.id},i),{mimetype:this.mimetype,shown:O(this.shown),width:this.width,height:this.height,rotation:w(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:await this.downloadables(e,r),createdAtLocale:x0(this.createdAt),updatedAtLocale:x0(this.updatedAt)})))}get isVideo(){return xr(this.mimetype)}},Le=ob;Le.tableName="AssetFile",Le.uniqueColumnName="uri",Le.booleanFields=["shown"];function x0(t){return p(t,e=>lu(Date.now()-e,1)+" ago")}var Gs=l(()=>f("TagSql")),nb,sb=l(()=>new Xm(Rn,"Tag")),xl=l(async()=>{if(hr&&Date.now()-qi<20*v)return;await cV();let t=await sb().pluckFirst({sql:"SELECT MAX(rowid) FROM AssetTag"});Gs().info("updateTagCounts()",{newMax:t,lastMax:nb}),t!==nb&&(nb=t,await Ge("db.updateTagCounts",()=>uV()))},7*v);function pV(t=Bl(6)){let e=`temp.ct_${t}`,r=`temp.taf_${t}`,i=`temp.tag_counts_${t}`;return TF(`
CREATE TABLE ${e} AS
SELECT
  DISTINCT t.id AS parentId,
  kid.id AS childId
FROM
  Tag t
  JOIN Tag kid ON kid._path LIKE (t._path || '%');

CREATE INDEX ${e}_idx ON ${e.replace(/^temp\./,"")}(parentId, childId);

CREATE TABLE ${r} AS
SELECT
  DISTINCT AssetTag.tagId as tagId,
  Asset.id AS assetId,
  AssetFile.id AS assetFileId
FROM
  AssetTag
  JOIN Asset ON AssetTag.assetId = Asset.id
  JOIN AssetFile ON AssetFile.assetId = Asset.id
WHERE
  Asset.hidden = 0
  AND Asset.excluded = 0
  AND Asset.shown = 1;

CREATE INDEX ${r}_idx ON ${r.replace(/^temp\./,"")}(tagId, assetId, assetFileId);

CREATE TABLE ${i} AS
SELECT
  parentId AS tagId,
  count(DISTINCT assetId) AS ac,
  count(DISTINCT assetFileId) AS afc
FROM
  ${e}
  JOIN ${r} ON childId = tagId
GROUP BY
  1;

CREATE INDEX ${i}_idx ON ${i.replace(/^temp\./,"")}(tagId, ac, afc);

-- Update used tags:

UPDATE Tag SET 
  assetCount = NULL,
  assetFileCount = NULL;

UPDATE Tag
SET
  assetCount = ac,
  assetFileCount = afc
FROM ${i}
WHERE tagId = id;

-- Clean up:

DROP INDEX IF EXISTS ${e}_idx;
DROP INDEX IF EXISTS ${r}_idx;
DROP INDEX IF EXISTS ${i}_idx;
DROP TABLE ${e};
DROP TABLE ${r};
DROP TABLE ${i};
`)}async function uV(){sb().db()==null&&Gs().throw("updateTagCounts(): modelDb is unset",{retriable:!1});try{let t=Bl(6),e="_"+t,r=await Ca(sb().runScript(pV(t),e)),i=re(7*v,5*E,r.elapsedMs*20);Gs().info("Updated tag counts",{elapsedMs:r.elapsedMs,newTTL:i}),xl.setTTL(i),await fV()}catch(t){Gs().warn("Failed to update tag counts",t)}}async function fV(t=Date.now()-10*E){let e=[-1];for(let r of xo(0,5)){let i=await dV(t);if(N(i)||yo(e,i))return;e=i}}async function dV(t){let e=await Re.dbl.pluckAllf(r=>r.select("Tag.id").leftOuterJoin("AssetTag","AssetTag.tagId","Tag.id").leftOuterJoin(po.raw("Tag AS child ON child.parentId = Tag.id")).whereNull("AssetTag.assetId").andWhere(i=>i.whereNull("child.id")).andWhere(i=>i.whereNull("Tag.assetCount")).andWhere("Tag.createdAt","<",t).orderBy("Tag._path","asc"));Gs().debug("vacuumLeafTags()",{candidates:e});for(let r of e)try{await Re.dbl.runf(i=>i.where({id:r}).delete())}catch(i){Gs().info("vacuumLeafTags(): failed to delete",{tagId:r,err:i})}return Gs().info("vacuumLeafTags() complete.",{candidates:e}),e}async function cV(){let t=f("updateTagMountpoints()"),e=await Re.findByPath([Oe.FS]);if(e==null){t.info("No root filesystem tag");return}await e.maybeUpsertDisplayName(u.tagDisplayNameFS.valueOrDefault);let r=await Wt();if(r==null){t.warn("no-op: volumes() returned null");return}for(let i of await e.getChildren()){if(i.name===Tf){i.ordinal!==1&&await i.upsert({ordinal:1});continue}let o,n=r.find(s=>T(s.uuid)&&Em(s.uuid)===i.name);n!=null?o=oi(n.label,n.mountpoint):o=await Le.dbl.pluckFirstf(s=>s.select("mountpoint").where("uri","LIKE","psfile://"+i.name+"/%").limit(1)),o!=null?(await i.maybeUpsertDisplayName(o),t.info("updated tag",{id:i.id,path:i.path,displayName:o}),Re.clear()):t.debug("cannot update tag: no current volume.",{id:i.id,path:i.path})}}var mu=class{constructor(e,r,i){this.dataDir=e;this.isLockOwner=r;this.localDbDir=i;this.endTimeoutMs=E;this.end=l(()=>p(this.backup.value,e=>e.end()));this.setup=l(async()=>{try{await this._setup(),this.logger.info("ModelDb reading from "+this.db.value?.dbfile)}catch(e){this.db.reject(e),this.backup.reject(e),this.logger.throw(e,{fatal:!0,from:"ModelDbJanitor.setup"})}});this.beforeBackup=async()=>{C()||!ne&&Lr()&&await cr(Rn(),async()=>{await gl.vacuum(),await Ft.vacuum(),await xl()})};this.onBackupFinished=async()=>{!C()};this.onMigration=l(async()=>{this.logger.info("onMigration: removing prior stats db to clear prior work queues"),await b(Fm(!1),r=>r.rmrf("info"))});this.backupAndMigrate=async()=>Lr()||await this.isLockOwner();this.name="ModelDbJanitor("+e+")",this.logger=f(this.name),this.db=new Jt(this.name+".db"),this.backup=new Jt(this.name+".backup"),this.srcDbFile=qs(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),gx(this),this.setup()}static async for(e,r,i=XF){let o=new mu(e,r,i);return await o.setup(),o}get ended(){return this.end.prior()!=null}async _setup(){if(u.forceLocalDbReplica.valueOrDefault||await b($a(this.srcDbFile.nativePath),r=>r.remote)===!0){let r=await this.localDbDir();return this.localDbReplica=qs(r,"models"),this.logger.info("Library on remote drive. Using local db replica.",{src:this.srcDbFile.nativePath,local:this.localDbReplica}),await this.backupAndMigrate()&&(this.logger.info("Setting up local model db replica...."),await this.localDbReplica.parent().rmrf("info"),await this.srcDbFile.clear().exists()&&(await this.srcDbFile.copyFile_(this.localDbReplica),await this.localDbReplica.chmod(420)),this.logger.info("Local model db replica set up at "+this.localDbReplica)),this._finishSetup(r,this.srcDbFile.parent())}else return this._finishSetup(this.dataDir)}async _finishSetup(e,r){let i=await this.backupDir.mkdirp();if(i==null)throw new Error("Failed to create models DB backup dir "+this.backupDir);let o=new ou("models",e,this.onMigration),n=await this.backupAndMigrate();n?(await o.migrate(),this.backup.resolve(new Jy(o,this.backupAndMigrate,o.dbfile,i,r,this.beforeBackup,this.onBackupFinished))):this.backup.resolve(void 0),yF(o),this.db.resolve(o),n&&(await s0(),await xl()),this.logger.info("Finished setup",{primaryDbDir:e,replaceDbDir:r,backupDir:i})}};var v0=l(()=>{WS(xm()?hV:void 0),aM(xm()?gV:void 0)}),hV=async()=>await Ln()?p(In(),t=>t.request("mountpoints")):void 0,gV=async()=>await Ln()?p(In(),t=>t.request("volumes")):void 0;var T0;function S0(){return T0}function M0(t){T0=t}async function P0(t){let e=new ou("stats",t);return yS()&&(await e.migrate(),new Ii({name:"statsDbJanitor vacuum",callback:()=>e.vacuum(),intervalMs:ne?20*v:5*E,rank:Q.service})),M0(e),e}function yV(t){return t.toDateTime().toFormat(u.assetSubdirectoryDatestampFormat.valueOrDefault).split("/")}var ab=class{constructor(e,r){this.root=e;this.copyAssets=r;this.logger=f("AssetFileRepository")}directoryForDate(e){return this.root.join(...yV(e))}async importFile(e){let r=this.copyAssets();if(this.logger.debug("importFile()",{file:e,copyAssets:r}),!r||await ol())return e;if(await e.isDescendantOf(this.root))return this.logger.debug("no-op: "+e+" already contained by "+this.root),e;this.logger.debug("importing "+e);let i=await qm(e);if(i==null)throw new Error(e.nativePath+" has no tags (so, no createdAt)");let o=p(i.capturedAt,x=>Hg(x.date));if(o==null)throw new Error(e.nativePath+" has no capturedAt");if(o.year==null||o.month==null||o.day==null)return this.logger.warn("Insufficient capturedAt precision to copy "+e+" into library.",{capturedAt:i.capturedAt}),e;let n=this.directoryForDate(o);if(await n.mkdirp()==null)throw new Error("Cannot create destination directory, "+n.nativePath+" for "+e.nativePath);let s=await n.children(),a=await e.size(),m=await Zl(s,x=>x.size().then(S=>S===a)),c=await e.sha();if(m.length>0){let x=await Zl(m,S=>S.sha().then(F=>F===c));if(x.length>0){let S=x[0];return this.logger.info(e+" matches "+S),this.handleSidecars(e,S)}}let h=await n.join(e.base).ensureNew_();return this.logger.info("Copying...",{src:e.nativePath,dest:h.nativePath}),await e.copyFile_(h),this.handleSidecars(e,h)}async handleSidecars(e,r){let i=w(await e.sidecars(),[]);for(let o of i)await this.handleSidecar(o,r);return L(i)&&zr(r.nativePath),r}async handleSidecar(e,r){for(let o of w(await r.sidecars(),[]))if(await sA(e,o)){this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:o,dest:r});return}let i=await r.parent().join(r.name+e.ext).ensureNew_({emptyIsNew:!0});return e.copyFile_(i)}};var Tr=class extends we{constructor(e){super(`Library(${e})`,()=>this.onEnd(),Q.predb);this.start=Date.now();this._ready=new _e;this.setup=l(async()=>{let e=()=>{if(this.ended||C())throw new Error};try{if(this.logger.debug("setup() started"),!Xr()){if(!np())throw new Error("Cannot run "+Xt()+" without a library"+ge+Si);this.logger.warn("Library settings don't exist yet. Skipping setup.");return}await this.openedBy().throwIfUnavailable("(library setup)"),e(),await Bp(this.rootDir),await Ef(this.rootDir.nativePath);let r=this.originalsDir();if(r==null||await r.mkdirp()==null||!await r.isReadWritable())throw new Error(`Invalid value for ${u.originalsDir.key}: ${r} must be readable and writable.`);await this.statsDbDir(),await zs(),e(),fA(kF),xm()&&await Ln()&&(await MA(),v0()),e(),await this.modelDb(),e(),gS()&&await this.statsDb()}catch(r){!this.ended&&!C()&&(J("Library.setup() failed"+(op()?"":ge),r),this._ready.reject(r))}finally{this._ready.pending&&(this.logger.info("Library.setup() finished."),this._ready.resolve())}});this.openedBy=l(()=>new hy(this.dataDir));this.statsDbDir=l(()=>Fm());this.previews=l(()=>new Py(this.rootDir.join(u.previewsDir.valueOrDefault),OF));this.originalsDir=l(()=>Ns(this.rootDir));this.assetFileRepository=l(()=>new ab(this.originalsDir(),()=>u.copyAssetsToLibrary.valueOrDefault));this.modelDbJanitor=l(async()=>mu.for(this.dataDir,()=>this.openedBy().isLockOwner()));this.modelDb=l(async()=>(await this.modelDbJanitor()).db.promise);this.statsDb=l(async()=>P0(await this.statsDbDir()));this.statsDbFile=l(()=>this.statsDb().then(e=>e.dbfile));this.onEnd=l(async()=>{for(let{ea:e,t:r}of[{ea:this.statsDb,t:H},{ea:this.modelDbJanitor,t:E},{ea:this.openedBy,t:H}])await p(await e.clear(),i=>yt(i,r));this.logger.info("onEnd(): finished.")});this.rootDir=X.for(e),this.dataDir=qt(this.rootDir),this.logger.info("new()")}static libraryPathChanged(){let e=p(u.libraryPath.value,Wr),r=p(this.priorInstance,i=>i.rootDir.nativePath);return e!==r}static instance(){let e=this.libraryPathChanged(),r=O(this.priorInstance?.ended),i;return(e||r)&&(i=yt(this.priorInstance,E),this.priorInstance=void 0),this.priorInstance==null&&Xr()&&(this.priorInstance=K(u.libraryPath.value,o=>kt(new Tr(o),async n=>(await i,n.setup())))),this.priorInstance}static instanceRequired(){let e=Tr.instance();if(e==null)throw new Error("Library is undefined"+ge);return e}get isPendingSetup(){return this._ready.pending}get ready(){return this._ready.promise}async requiredFiles(){let e=[];return await ln(u.cacheDir.valueOrDefault)&&e.push({desc:"Cache directory",isDir:!0,file:()=>io()}),this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library model DB",isDir:!1,file:()=>b(this.modelDbJanitor(),r=>r.srcDbFile)},{desc:"Library model DB (local replica)",isDir:!1,file:()=>b(this.modelDbJanitor(),r=>r.localDbReplica)}),e}};var Nt=class extends tr{constructor(){super(...arguments);this.attrs={};this.urls=l(()=>new kn(this.toID()))}static shownUnhidden(e){return w(e,()=>Nt.query()).andWhere({shown:1,hidden:0,excluded:0})}static shownCount(){return this.ops().countf(e=>e.where({shown:1,excluded:0}))}static outdatedQuery(){return this.query().where("version","<",Or).andWhere({shown:1,excluded:0})}static deletePreviews(e){return Tr.instance().previews().ap(e).deleteAll()}static async delete(e){this.logger().warn("Deleting asset "+e),await hi.dbl.runf(r=>r.delete().where({assetId:e})),await Le.dbl.runf(r=>r.delete().where({assetId:e})),await Nt.dbl.runf(r=>r.delete().where({id:e})),await Nt.deletePreviews(e)}static async exclude(e){return this.logger().info("Excluding asset "+e),{dbResult:await Nt.dbl.runf(r=>r.update({excluded:1}).where({id:e})),deletedPreviews:await Nt.deletePreviews(e)}}static nextOutdated(e=Vr){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=Vr){return this.dbl.pluckFirst(e(this.outdatedQuery()).count())}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static async addTags(e,r){let i=Mo(r.filter(L),o=>Yr(o));return this.logger().debug("addTags()",{assetId:e,tagPaths:r,uniqTagPaths:i}),N(i)?void 0:Nt.tx(async()=>{let n=(await le(i,s=>Re.findOrCreate(s))).map(s=>s.id);return hi.addTagsToAsset(e,n)})}static async removeTags(e,r){if(N(r))return;let i=await le(r,o=>Re.findByPath(o));return this.logger().info("removeTags()",{assetId:e,tags:i.map(o=>Mt(o,"id","path")),tagPaths:r}),hi.removeTagsFromAsset(e,A(i.map(o=>o.id)))}static unshownAssetIds(){return this.dbl.pluckAll(`
        SELECT DISTINCT af1.assetId
        FROM AssetFile af1
          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 
            ON af1.assetId = af2.assetId
        WHERE af2.assetId IS NULL`)}static archive(e){return this.tx(async()=>{await Nt.ops().findById(e)!=null&&(await hi.dbl.runf(i=>i.where({assetId:e}).delete()),await Le.dbl.runf(i=>i.where({assetId:e}).delete()),await Nt.dbl.runf(i=>i.where({id:e}).delete()))})}get capturedAt(){return Yh(this.capturedAtLocal)}get capturedAtMs(){return CS(this.capturedAtLocal)}markUnshownAndUpsert(){return this.shown=!1,this.version=Or,this.upsert()}markShownAndUpsert(){return this.shown=!0,this.excluded==null&&(this.excluded=!1),this.version=Or,this.upsert()}toAssetId(){return{assetId:this.id,capturedAtLocal:this.capturedAtLocal}}renderCaption(e){return p(this.capturedAtMs,r=>"Taken "+DA(r,e))}async whenApiTag(){return Dt(this.capturedAt).flatMap(e=>BA(e)).flatMap(e=>Re.findOrCreate(e)).flatMap(e=>e.toApiTag()).get()}addTagPaths(e){return Nt.addTags(this.id,e)}async findAssetFileByUri(e){return await this.getFiles(),this.files.find(r=>r.uri===e)}async addAssetFile(e){return await this.findAssetFileByUri(e.uri)==null&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}static getTags(e){return Re.ops().all(Re.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}async getTags(){return this.tags==null&&(this.tags=await Nt.getTags(this.id)),this.tags}static getTagPaths(e){let r=Re.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return Re.dbl.pluckAll(r)}async tagPaths(){return(await this.getTags()).map(r=>r.path.join("/")).sort()}async getStreams(e){if(this.streams==null){let r=await this.getTags();this.logger().info("getStreams(): fetched tags "+r,{limit:e});let i=await le(r,o=>o.getAssetStream(this,e));this.streams=t0(A(i));for(let o of this.streams)for(let n of o.tags)await n.getAncestors()}return this.streams}async getBeforeAfterId(){let e=await Nt.dbl.all(Nt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id"));this.afterId=p(e.find(r=>r.id>this.id),dl),this.beforeId=p(e.reverse().find(r=>r.id<this.id),dl),await ye(this.beforeId,()=>this.getBeforeId()),await ye(this.afterId,()=>this.getAfterId())}async getBeforeId(){return b(Nt.dbl.first(Nt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}])),e=>this.beforeId=dl(e))}async getAfterId(){return b(Nt.dbl.first(Nt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}])),e=>this.afterId=dl(e))}async getTagPaths(){return(await this.getTags()).map(r=>r.path)}async getFiles(){if(this.files!=null)return this.files;if(this.id==null)return this.files=[];let e=await Le.ops().findBy({assetId:this.id});return this.files=ie(e,r=>[!O(r.shown),-r.mtime])}async setShown(e){return Le.setShown(this.id,e)}async getShown(){if(this.files!=null){let e=this.files.find(r=>O(r.shown));if(e!=null)return e}return b(Le.ops().findOneBy({assetId:this.id,shown:1}),e=>kt(e,r=>r.asset=this))}async getCapturedAts(){return le(this.getFiles(),e=>e.toCapturedAt())}link(){return"/asset/"+this.id}sqAttrs(e=!0){return g(g(g({},this.urls().sqImgAttrs(e)),{title:this.renderCaption()}),this.attrs)}async getImgAttrs(e,r,i=!1){if(this.imgAttrs==null&&(this.imgAttrs=new Map),this.imgAttrs.get(r)==null){let o=e.ap(this.toID());await b(o.readInfo(),async s=>{s.mimetype.startsWith("video/")&&(this.poster=await o.posterLink())});let n=!0;this.imgAttrs.set(r,await o.imgAttrs(r,n,i))}return this.imgAttrs.get(r)}async fitAttrs(e){return g(g({},await this.getImgAttrs(e,er.fit)),this.attrs)}isVideo(){if(this.files==null)throw new Error(".video called before getFiles()");return this.files.some(e=>e.isVideo)}videoAttrs(){return g({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(this.existingFiles==null)throw new Error(".videoSources called before getExistingFiles()");let e=this.existingFiles.filter(i=>i.isVideo).map(i=>({src:this.urls().videoLink(i.id),type:i.mimetype})),r=Mo(e,i=>i.type);if(r.every(i=>i.type!=="video/mp4")){let i=this.existingFiles[0];r.unshift({src:this.urls().videoLink(i.id)+".mp4",type:"video/mp4"})}return r}async getPosixFiles(){let e=await this.getFiles();return A(await Promise.all(e.map(r=>r.posixFile())))}async getExistingAssetFiles(){return this.existingFiles==null&&(this.existingFiles=await Qi(await this.getFiles(),e=>he(e.posixFile(),r=>r.exists(),()=>!1))),this.existingFiles}async findOrCreateByFile(e){let r=await e.uri();if(r==null)return;let i=D(await Le.findByAsset({id:this.id},{uri:r}))[0];return w(i,async()=>{let o=new Le;return o.asset=this,o.assetId=this.id,await o.setFile(e),o})}clear(){return this.existingFiles=void 0,this.files=void 0,this.imgAttrs=void 0,this.streams=void 0,this.tags=void 0,this}async setHidden(e){return this.hidden=e,this.upsert()}},it=Nt;it.tableName="Asset",it.uniqueColumnName="id",it.booleanFields=["shown","hidden","excluded"],it.shownAssetCounts=l(()=>Nt.dbl.pluckFirst({sql:zi("SELECT","  COUNT(DISTINCT Asset.id)","FROM Asset","WHERE","  Asset.shown = 1","  AND Asset.excluded = 0","  AND hidden = 0")}),7*v);function E0(){return cr(Rn(),async()=>{await it.dbl.runf(t=>t.update({version:0})),await Le.dbl.runf(t=>t.update({version:0})),await Sr.dbl.runf(t=>t.where({name:Ri.enqueueAssetFileUpdates,version:kr}).orWhere({name:Ri.enqueueAssetUpdates,version:Or}).delete())})}var at=M(require("process"));var D0=M(require("fs")),lb=M(require("fs-extra")),uu=M(require("path")),cu=M(require("process")),vl=M(require("timers"));var mb=class extends we{constructor(){super("LogTail",()=>this.onEnd(),Q.logger);this.watchers=new Map;this.file2pos=new Map;this.lastReadFiles=new Di(5*v);this.mutex=new tt;this.setup=l(async()=>{await fl();let e=u.logDir.valueOrDefault;ne&&console.log("tailing "+e+"..."),await(0,lb.mkdirp)(e),this.root=await br.for(e),await this.scan(!0)});this.ignorableFilename=uu.sep+Xt()+"-"+cu.pid+"-",!cu.stdout.writableFinished&&(Bh(!0),this.flushTimeout=(0,vl.setInterval)(()=>this.flush(),xn/2),this.scanTimeout=(0,vl.setInterval)(()=>this.scan(),E),cu.stdout.on("end",()=>this.end()),this.setup())}async flush(){this.write(Ch())}readable(e){return e.endsWith(".log")&&!e.includes(this.ignorableFilename)}watchDir(e){C()||this.ended||Pr(this.watchers,e,()=>{wn(Ut.debug,()=>console.log("LogTail(): watching "+e));try{return(0,D0.watch)(e,(r,i)=>this.watchListener(r,(0,uu.join)(e,i)))}catch(r){wn(Ut.warn,()=>console.error("LogTail(): failed to read "+e,r));return}})}async scan(e=!1){if(!(C()||this.ended)&&(await this.root.visitDescendantFiles(async r=>{!this.readable(r.nativePath)||(e&&await b(r.size(),i=>this.file2pos.set(r.nativePath,i)),up(await r.mtimeMs())&&this.watchDir(r.dir))}),!(C()||this.ended))){try{let r=(0,uu.join)(this.root.nativePath,zu(new Date));await(0,lb.mkdirp)(r),this.watchDir(r)}catch(r){wn(Ut.warn,()=>console.error("LogTail(): Failed to create the current log dir",r))}C()||this.ended||e&&console.log("LogTail(): Tailing "+this.root+"/**/*.log...")}}async onEnd(){Bh(!1),p(this.flushTimeout,vl.clearInterval),this.flushTimeout=void 0,p(this.scanTimeout,vl.clearInterval),this.scanTimeout=void 0;for(let e of this.watchers.values())e.close();this.watchers.clear();for(let e of this.lastReadFiles)await this.watchListener("onEnd",e);try{this.write(Ch(-1))}catch{}}write(e){for(let r of e)console.log(bm().formatLogEntry(r))}async watchListener(e,r){!this.readable(r)||await this.mutex.serialByName(r,async()=>{try{let i=await br.for(r);if(i==null){wn(Ut.warn,()=>console.error("watchListener: missing file",{event:e,filename:r}));return}let o=await i.size();if(o==null||o<=0)return;let n=w(this.file2pos.get(i.nativePath),()=>0);if(Ci(n,o))return;await b(fS(i,{start:n,end:o}),s=>Xc(...s)),this.lastReadFiles.add(i.nativePath),this.file2pos.set(i.nativePath,o)}catch(i){wn(Ut.warn,()=>console.error("Failed to read "+r+": "+yr(i)))}})}},Bf=mb;Bf.instance=l(()=>su()?void 0:new mb);var ub=class{constructor(){this.arr=[];this.iterIdx=0}get size(){return this.arr.length}count(e){return Er(this.arr,e)}unshift(...e){this.arr.splice(this.iterIdx,0,...e)}push(...e){this.unshift(...e),this.incrIdx(e.length)}remove(e){return this.filterInPlace(r=>r!==e)}filterInPlace(e){let r=!1;return vt(this.arr,(i,o,n)=>{let s=e(i,o,n);return s||(r=!0,o<this.iterIdx&&this.iterIdx--),s}),this.incrIdx(0),r}next(e=()=>!0){if(this.size===0)return{value:void 0,done:!0};for(let r=0;r<this.size;r++){let i=this.arr[this.iterIdx];if(this.incrIdx(),i!=null&&e(i))return{value:i,done:!1}}return{value:void 0,done:!0}}toA(e=()=>!0){if(N(this.arr))return[];let r=[];for(let i=0;i<this.size;i++){let o=this.arr[(this.iterIdx+i)%this.arr.length];e(o)&&r.push(o)}return r}incrIdx(e=1){this.iterIdx=this.arr.length===0?0:(this.iterIdx+e)%this.arr.length}};xa(()=>Tl());Ex(()=>B(Tl));var bV=new tt,cb=new tt,Ks=new ub,KUe=new Ii({name:"Idle",callback:Tl,intervalMs:7*v,initialDelayMs:20*v}),pb=async()=>!1;function A0(t){pb=t}async function F0(){return _t()||C()||Ks.size===0||cb.pendingCount>=bt()||await pb()}var wV=bt()>4?250:750;async function Tl(){return await F0()?void 0:bV.maybeRun("runOnIdle",async()=>{if(await F0())return;let{value:t}=Ks.next(e=>e.runnable);t!=null&&cb.push(t.name,async()=>t.onIdle()).finally(()=>Tl),Ks.size>0&&B(Tl,wV)})}function Cf(t){Ks.push(t),B(Tl)}function Sl(t){return Ks.filterInPlace(e=>e.name!==t)}async function Vf(){return{doNotRun:{isPaused:_t(),ending:C(),doNotRunImpl:await pb()},idleListeners:Ks.toA().map(t=>t?.name),runnableIdleListeners:Ks.toA(t=>t?.runnable).map(t=>t?.name),pendingWorkItems:cb.pendingNames()}}var Y0=M(require("@sentry/node"));var pu=l(()=>f("EventStore")),L0=7;function Uf(t){return jt(t,"breadcrumbs")}var fb=class{constructor(){this.root=ce.for(ci()).join("events")}datedRoot(e=new Date){return this.root.joinYMD(e)}rmrf(){return this.root.rmrf()}msg2file(e){return this.datedRoot(new Date(e.timestamp*v)).join(jr(e.message,8,ds)+".json")}async eventsFrom(e=new Date){return D(await this.datedRoot(e).childFiles(r=>r.ext===".json"&&!r.isHiddenPosix()))}async eventQuotaExceeded(e){let r=d(e).includes(Ao)||d(e.message).includes(Ao),i=await this.eventCount(),o=u.maxErrorsPerDay.valueOrDefault+(r?L0:0);return i>=o}async eventCount(e=new Date){return(await this.eventsFrom(e)).length}async maybeSendEvent(e){if(C())return pu().error("maybeSendEvent(): REJECT: we're ending.",{event:Uf(e)}),null;try{let r=pc(e.message),i=await this.eventCount(),o=u.maxErrorsPerDay.valueOrDefault+(r?L0:0);return i>=o?(pu().error("maybeSendEvent(): REJECT: too many events sent in the last day.",{recentEventCount:i,pleaseSend:r,maxErrorsPerDay:o,event:Uf(e)}),null):await this.writeEvent(e)==null?(pu().error("maybeSendEvent(): REJECT: event was already sent in the last day.",{event:Uf(e)}),null):(pu().error("maybeSendEvent(): ACCEPT",{event:Uf(e),pleaseSend:r,recentEventCount:i,maxErrorsPerDay:o}),e)}catch(r){return pu().error("maybeSendEvent(): Failed to determine if we should squelch the event. Failing closed.",r),null}}async writeEvent(e){let r=this.msg2file(e);return b(r.ensureNew_({maxVersions:u.maxErrorsPerDay.valueOrDefault,emptyIsNew:!1}).catch(()=>{}),i=>i.writeJsonMaybe(e))}},Ml=fb;Ml.instance=l(()=>new fb);var Js=l(()=>Po("ENABLE_SENTRY")||hr&&Lo&&u.reportErrors.valueOrDefault);u.reportErrors.addListener(()=>Js.clear());var du=M(require("@sentry/node")),hu=M(C0()),Hf=M(require("os")),Gf=M(require("process"));var db=class{constructor(e,r){this.maxLength=e;this.toValue=r;this.sortedArray=new Es(r)}toArray(){return this.sortedArray.store}vacuum(){return this.sortedArray.length>this.maxLength&&Yu(this.sortedArray.store,this.maxLength),this.toArray()}get min(){return this.sortedArray.length>=this.maxLength?this.toValue(this.sortedArray[0]):void 0}add(...e){let r=this.min;for(let i of e)if(i!=null){let o=this.toValue(i);o!=null&&(aw(o,r)||this.sortedArray.add(i))}this.sortedArray.length>=2*this.maxLength&&this.vacuum()}};var V0=M(require("fs")),jf=M(require("zlib"));var U0=2048,AV=U0/4,hb=class{constructor(e,r){this.f=e;this.lines=new Es(Ha);this._hasFirstLine=!1;this._ended=!1;this._paused=!1;this._errors=!1;this.from=qr(e.name),this.fileStream=(0,V0.createReadStream)(e.nativePath,{autoClose:!0}),this.stream=(e.ext.toLowerCase().endsWith(".gz")?this.fileStream.pipe((0,jf.createGunzip)()):e.ext.toLowerCase().endsWith(".br")?this.fileStream.pipe((0,jf.createBrotliDecompress)()):this.fileStream).pipe(new gs).on("error",i=>{r(i),this._errors=!0}),this.stream.on("data",this.onData.bind(this)),this.stream.on("end",()=>{this._ended=!0})}onData(e){let r=Zc(e);r!=null&&(this.lines.add(g(g({},r),{from:this.from})),this._hasFirstLine=!0),this.lines.length>U0&&!this._paused&&(this.fileStream.pause(),this._paused=!0)}toString(){return"LogReader("+this.f.nativePath+")"}hasFirstLine(){return this._hasFirstLine}hasErrors(){return this._errors}ended(){return this._ended&&this.lines.length===0}peek(){return this.lines.store[0]}shift(){let e=this.lines.store.shift();return e!=null&&this.lines.length<AV&&this._paused&&(this.fileStream.resume(),this._paused=!1),e}};function FV(t=10*E){let e=Date.now()-t;return b(br.for(u.logDir.valueOrDefault),r=>r.filterDescendantFiles(async i=>[".log",".log.gz"].includes(i.ext)&&Ci(await i.mtimeMs(),e)))}async function z0(t=50){await tp();let e=mt(Ut.values.map(n=>[n,new db(t,Ha)])),r=Date.now()-ft,i=f("allRecentLogEntries()");return await b(FV(),n=>Ar({name:"allRecentLogEntries()",laters:n.map(s=>async()=>{try{let a=[],m=new hb(s,c=>a.push(c));for(await Be(()=>m.hasFirstLine(),{timeoutMs:10*v});!m.ended()&&!m.hasErrors();){let c=m.shift();c==null?await gt(5):c.ts>r&&e[c.l]?.add(c)}L(a)&&(i.warn("Read error(s) for "+s,a),a.some(c=>c.code==="Z_BUF_ERROR"||fe(c).includes("unexpected end of file"))&&yi(await s.mtimeMs(),Date.now()-E)&&(i.warn("Unlinking corrupt logfile "+s),await s.unlink_()))}catch(a){i.warn("Failed to read entries from "+s,a)}})})),pe(St(e).map(n=>n.vacuum())).sort((n,s)=>Bt(n.ts,s.ts))}var W0=M(require("child_process")),q0=M(require("fs")),ho=M(require("os"));var gb=l(()=>f("os")),j0=l(()=>[LV(),"on",(0,ho.arch)()].join(" "));function LV(){switch((0,ho.platform)()){case"linux":return IV();case"darwin":return kV();case"win32":return OV();default:return fu()}}function fu(){return(0,ho.platform)()+" "+(0,ho.release)()}function IV(){try{let t=(0,q0.readFileSync)("/etc/os-release").toString(),e=gp({input:t,lowerCaseKeys:!0});if(T(e.pretty_name))return e.pretty_name;let r=w(e.version,e.version_id);return Wn(e.name,r,(i,o)=>i+" "+o,fu)}catch(t){return gb().warn("Failed to fetch /etc/os-release",t),fu()}}function H0(t){return t.split(".").slice(0,2).join(".")}var RV={"10.6":"Snow Leopard","10.7":"Lion","10.8":"Mountain Lion","10.9":"Mavericks","10.10":"Yosemite","10.11":"El Capitan","10.12":"Sierra","10.13":"High Sierra","10.14":"Mojave","10.15":"Catalina","11.1":"Big Sur"},G0=l(()=>(0,W0.execSync)("sw_vers -productVersion").toString().trim());function _V(t=G0()){return RV[H0(t)]}function kV(t=G0()){try{return fr(_V(t),e=>`macOS ${e} (${t})`,fu)}catch(e){return gb().warn("osNameMac(): unknown release",e),fu()}}var NV={"10.0":"10","6.3":"8.1","6.2":"8","6.1":"7","6.0":"Vista","5.2":"Server 2003","5.1":"XP","5.0":"2000","4.9":"ME","4.1":"98","4.0":"95"};function OV(t=(0,ho.release)()){let e=NV[H0(t)];return e!=null?`Windows ${e} (${t})`:(gb().warn("osNameWin(): unknown release: "+t),`Windows (${t})`)}var K0=l(()=>Vw((0,ho.cpus)().map(t=>t.model)).map(t=>`${t.count} \xD7 ${t.t}`).join(", "),E);var Kf=f("Sentry"),BV=100;async function J0(t){try{return Js()?(du.default.init({dsn:si?"https://0652cdd351054fe9853ff944b1f54e2c@sentry.io/289071":"https://408e2f8d62c3494d8ed663d9e488d67a@sentry.io/1828379",shutdownTimeout:rp(t.name),release:bv,environment:$o,maxBreadcrumbs:BV,integrations:()=>[],beforeSend:CV().beforeSend,onFatalError:e=>J("sentry.onFatalError",e)}),!0):!1}catch(e){return Kf.warn("Failed to set up sentry: "+e),!1}}function Q0(t,e){Js()&&(e!=null&&!fc(e)?du.default.captureException(Pv(e,t)):fc(t)||du.default.captureMessage(t))}var CV=l(()=>new $0),$0=class{constructor(){this.eventStore=Ml.instance();this.beforeSend=async(e,r)=>{if(!Js())return Kf.warn("Sentry.beforeSend(): not sending event",e),null;if(await this.eventStore.eventQuotaExceeded(e))return Kf.warn("Sentry.beforeSend(): event quota exceeded",e),null;let i=VV(e,r);if(fc(i))return Kf.info("Sentry.beforeSend(): event not sendable. vetoing",{event:e,hint:r,msg:i}),null;P(e.message)&&(e.message=sr(i,256));let o=await yb(e);return this.eventStore.maybeSendEvent(o)};ac(Q0),Lx(Q0),new we("EventFilter",()=>this.end(),Q.first)}end(){return p(du.default.getCurrentHub().getClient(),e=>e.close(5*v))}};function VV(t,e){return G(ma([t.message,...D(UV(t.exception?.values)),fe(e?.originalException)])).join(": ")}function UV(t){return Me(t,e=>z(e.map(zV)))}function zV(t){return Me(z([t?.type,t?.value].filter(e=>d(e).toLowerCase()!=="error")),e=>e.join(": "))}async function yb(t){let e=u.email.value;T(e)&&(t.user==null&&(t.user={}),t.user.email=e),N(t.breadcrumbs)&&(t.breadcrumbs=await bb());let r=w(t.extra,{});return r.pid=Gf.default.pid,r.serviceName=Xt(),r.serviceEnding=C(),r.runtimeMs=Date.now()-qi,r.version=wt,r.os=j0(),r.isDocker=Ne(),r.nodeVersion=Gf.default.versions.node,r.locale=await Wc(),r.cpus=K0(),r.memoryUsageMb=uF(),r.memoryUsageRssMb=cF(),r.systemMemory=ss((0,Hf.freemem)())+" / "+ss((0,Hf.totalmem)()),r.ffmpeg=await YE(),r.vlc=await rD(),r.argv=I(Gf.default.argv),t.extra=r,g({timestamp:Date.now()/v},t)}async function bb(){await jm("writeRecentLogEntries"),await gt(xn*3);let t=await z0();return A(t.map(WV))}function WV(t){return p(qV(t.l),e=>({timestamp:t.ts/v,level:e,category:w(t.from,Kr()),message:ji(t.ctx+": "+t.msg),data:typeof t.meta=="object"?t.meta:{value:It(t.meta)?ji(t.meta):t.meta}}))}function qV(t){switch(t){case"error":return hu.Severity.Error;case"warn":return hu.Severity.Warning;case"info":return hu.Severity.Info;case"debug":return hu.Severity.Debug;default:return}}function jV(){return"User requested recent logs at "+new Date().toISOString()+Ao}async function X0(){let t=jV(),e=await yb({message:t,breadcrumbs:await bb()});return Js()?Y0.default.captureEvent(e):await Ml.instance().writeEvent(e),e}var wb=M(require("process"));function _i(t,e=vm()){su()||(f("stdoutWrite").debug("()",{obj:t,ready:e}),wb.stdout.write(I(t)+`
`),e&&wb.stdout.write(xb+`
`))}var xb=I({ready:!0});var HV=l(()=>{Nx(()=>tp()),xa(()=>Fy()),sc(()=>Ay())}),vb=class{constructor(e){this.opts=e;this._exitted=!1;this._ready=new _e;this.jobs=new tt;this.onFatalHandlers=[];this.inputHandlers=new Map;this.setup=l(async()=>{this.logger.info("setup()");let e=()=>!this._exitted&&!C();try{K(ze("PS_FATAL_"+this.name),i=>{throw new ae({fatal:!0,message:i})}),K(ze("PS_CRASH_"+this.name),i=>{B(()=>{throw new ae({message:i})},5*v)});{let i=wi()+(this.name===Ga.main?"":` ${this.name}`),o=at.default;try{o.title=i}catch{}}if(await fl(),Xr()&&await Ef(),await this.setupErrorHandling(),this.logStartup(),Lr()&&(await this.maybeUpgradeSystemSettings(),await this.maybeUpgradeLibrarySettings()),HV(),A0(dF),await this.stdinReadline(),e()){let i=Tr.instance();if(i==null&&!np())throw new Error("Cannot start, library path is unset"+ge);i!=null&&await i.ready}Ln();let r=!e();this.logger.debug("setup done.",{reject:r}),r?this._ready.reject():this._ready.resolve()}catch(r){console.error(yr(r)),this._ready.reject(r),this.exit({reason:uc(this.name+" setup failed: "+fe(r),ge),status:14,waitForJobs:!1})}});this.stdinReadline=l(()=>{let e=at.default.stdin.pipe(new gs);return e.on("data",r=>this.onLine(d(r))),e});ip(this.name=this.opts.name),wm(),u.logDir.addListener(()=>wm()),u.tailLogs.valueOrDefault&&Bf.instance(),this.logger=f("Service("+this.name+")"),this.addDefaultInputHandlers(),this.jobs.push("Service.setupOrTimeout",()=>this.setupOrTimeout())}async setupOrTimeout(){{let r=await Ee(this.setup().then(()=>!0),u.setupTimeoutMs.valueOrDefault);if(O(r))return}let e=kf(bF()?.nativePath);if(e!=null){let r=e/10,i=r-(Date.now()-qi);i>0&&this.logger.warn("Startup is taking a while, but the database looks like it's large, so we're going to wait for another "+Qh(i),{dbFileSize:e,timeoutMs:r,setupTimeoutMs:u.setupTimeoutMs.valueOrDefault});let o=await Ee(this.setup().then(()=>!0),i);if(O(o))return}return this.exit({reason:"Setup timed out after "+Qh(Date.now()-qi)+`.
Please visit https://photostructure.com/troubleshooting for help.`,status:13,waitForJobs:!1})}get ready(){return this._ready.promise}get isReady(){return this._ready.resolved}get exitted(){return this._exitted}onFatal(e){this.onFatalHandlers.push(e)}logStartup(){this.logger.info("setup()",g({version:wt,start:qi,argv:at.default.argv,arch:at.default.arch,platform:at.default.platform,isDocker:Ne(),isPacked:Lo,isElectron:si,versions:at.default.versions,settings:{logLevel:u.logLevel.valueOrDefault,httpPort:u.httpPort.valueOrDefault,rpcPort:u.rpcPort.valueOrDefault,libraryPath:u.libraryPath.valueOrDefault}},LT()))}async maybeUpgradeSystemSettings(){wt!==await rF()&&await Pf()}async maybeUpgradeLibrarySettings(){Xr()&&wt!==await iF()&&await aF()}async setupErrorHandling(){if(me.on("fatal",({message:e,error:r})=>this.exit({reason:e+p(r,i=>": "+fe(i)),status:12,waitForJobs:!1})),this.setInputHandler("--send-recent-logs",()=>X0()),at.default.on("unhandledRejection",e=>p(e,r=>J("unhandledRejection",r))),at.default.on("uncaughtException",e=>p(e,r=>J("uncaughtException",r))),at.default.on("SIGINT",()=>this.exit({reason:"SIGINT",status:0,waitForJobs:!1})),at.default.on("SIGTERM",()=>this.exit({reason:"SIGTERM",status:0,waitForJobs:!1})),at.default.on("SIGCHLD",(...e)=>this.logger.debug("Received SIGCHLD",e)),at.default.on("disconnect",()=>this.exit({reason:"disconnect",status:0,waitForJobs:!1})),Ka()||Lr()&&Ne())this.logger.info("setupErrorHandling(): not adding stdin/stdout/stderr close handlers: we're daemonized or in docker.");else{let e=!0;at.default.stdin.on("close",()=>this.exit({reason:"stdin.close",status:0,waitForJobs:e})),at.default.stdin.on("error",r=>this.logger.warn("stdin.error: "+r)),at.default.stdin.on("disconnect",()=>this.exit({reason:"stdin.disconnect",status:0,waitForJobs:e})),at.default.stdout.on("disconnect",()=>this.exit({reason:"stdout.disconnect",status:0,waitForJobs:e})),at.default.stdout.on("error",r=>this.logger.warn("stdout.error: "+r)),at.default.stderr.on("disconnect",()=>this.exit({reason:"stderr.disconnect",status:0,waitForJobs:e})),at.default.stderr.on("error",r=>this.logger.warn("stderr.error: "+r))}await J0(this)}async exit({reason:e,status:r,waitForJobs:i}){if(this._exitted=!0,this.logger.info("exit()",{status:r,reason:e,waitForJobs:i,ending:C()}),i&&(await gt(250),await Be(()=>(this.logger.info("exit(): waiting for enqueued jobs to complete...",{pendingNames:this.jobs.pendingNames()}),this.jobs.settled),{timeoutMs:void 0,timeBetweenMs:v}),this.logger.info("exit(): enqueued jobs finished.")),r!==0){await Promise.all(this.onFatalHandlers.map(n=>n(e)));let o={fatal:!0,exit:!0,status:r,pid:at.default.pid,ppid:at.default.ppid};o.error=e,et(()=>_i(o,!1))}return await xx(),at.default.exit(r)}setInputHandler(e,r){this.inputHandlers.set(e.trim().toLowerCase(),r)}addDefaultInputHandlers(){this.setInputHandler("--version",async()=>{_i({version:wt})}),this.setInputHandler("--status",async()=>{let e=await Ym();return this.logger.debug("--status",e),_i({healthChecks:e})}),this.setInputHandler("--quit",()=>B(()=>this.exit({reason:"--quit from stdin",status:0,waitForJobs:!0}))),this.setInputHandler(dg,()=>B(()=>this.exit({reason:dg+" from stdin",status:0,waitForJobs:!0}))),this.setInputHandler("--pause",()=>(Ay(),_i({paused:_t()},!1))),this.setInputHandler("--resume",()=>(Fy(),_i({paused:_t()},!1)))}onLine(e){return this.logger.debug("onLine()",{line:e,ending:this._exitted||C()}),this.jobs.serial("Service.onLine("+e+")",async()=>{if(await this.setup(),e.trim().startsWith("--")){let r=e.split(" ",1)[0],i=this.inputHandlers.get(r);i==null?(this.logger.error("onLine(): unknown command",{line:e}),console.warn("unknown command "+e)):await i(e.substr(r.length).trim())}else try{await p(this.opts.stdinReceiver,r=>r(e))}catch(r){this.logger.error("onLine(): failed to process",{line:e,error:r})}})}};var Z0=M(require("batch-cluster"));function gu(t){return t!=null&&T(t.path)&&T(t.error)}function Jf(t){return t!=null&&!gu(t)&&T(t.path)&&k(t.assetId)&&k(t.assetFileId)}var Tb=class extends Z0.Task{constructor(e){super(I({file:e}),r=>this.parse(r));this.nativePath=e;this.name=`ImportTask(${e})`}toString(){return this.name}parse(e){for(let r of z(d(e).split(`
`)).reverse()){let i=JSON.parse(r);if(gu(i)||Jf(i))return i}return{path:this.nativePath,error:"INTERNAL ERROR: no result found in input"}}};var eL=M(require("batch-cluster"));function Sb(t){return t!=null&&k(t.id)&&T(t.error)}function Qf(t){return!Sb(t)&&t!=null&&k(t.id)}var Mb=class extends eL.Task{constructor(e){super(I(e),r=>this.parse(r));this.cmd=e;this.name=`UpdateTask(${I(e)})`,this.id=Lu(e.updateAssetId,e.updateAssetFileId,e.updateAssetPreviewId)}toString(){return this.name}parse(e){for(let r of z(d(e).split(`
`)).reverse()){let i=Zc(r);if(Sb(i)||Qf(i))return i}return{id:this.id,error:"INTERNAL ERROR: no result found in input: "+e}}};var $s=class{constructor(){this.remainingMs=new ht(10);this.logger=f("ETA")}push(e){se(e,r=>this.remainingMs.push(r))}clear(){this.remainingMs.clear()}avg(){return Ot(A([this.remainingMs.weightedSampleAvg,this.remainingMs.sampleMode]))}fmtEstimate(e=1){return se(this.avg(),r=>{let i=r*e;if(i<E)return"less than a minute remains";if(i<Uu&&qn(this.remainingMs.sampleStdDev,r/5))return"about "+lu(i,1,{plural:"remains",singular:"remain"});this.logger.debug("Skipping remaining, avgMillisRemaining is too wiggly",g({avg:i},this.remainingMs.stats()))})}};var Eqe=Se("processing","paused","done");var $f="rebuilding://";var Pb=class extends we{constructor(e){super("TagAssetsWithFiles",()=>null,Q.first);this.priorProgress=e;this.start=Date.now();this._eta=new $s;this._done=new _e;this._progress=l(()=>ye(this.priorProgress,()=>Ft.insertNew($f,"\u{1F504}")));this._done.observeQuietly(Sr.applyOnce({name:"applyNewTagger",value:Oe.FS,version:1},()=>this._run()))}done(){return!this._done.pending}donePromise(){return this._done.promise}async progress(){if(this.done())return(await this._progress()).assignFromPojo({state:"done",hed:"Finished rebuilding your library \u{1F389}",dek:[],completePct:100,incompletePct:0,scanningPct:0});if(this.eta()==null||this.doneCount==null||this.todoCount==null)return;let r=await this._progress(),i=this.doneCount/(this.todoCount+this.doneCount),o=ve(100*i,2),n=this._eta.fmtEstimate(),s=`Adding ${Oe.FS} tags to your library`+fr(n,a=>", "+a,"\u2026");return r.assignFromPojo({state:"processing",hed:s,dek:[`Tagged ${Ti(this.doneCount)} URIs, ${Ti(this.todoCount)} remain.`],completePct:o,incompletePct:100-o,scanningPct:0})}eta(){if(this.todoCount==null||this.doneCount==null||this.todoCount===0)return;let i=(Date.now()-this.start)/this.doneCount*this.todoCount;return this._eta.push(i),this._eta.avg()}async _run(){return this.todoCount=await Le.dbl.pluckFirstf(e=>tL(e.countDistinct("AssetFile.id"))),this.doneCount=0,Le.dbl.batched({onResults:async e=>{for(let r of ql(e,i=>i.assetId).values()){if(C())return;await w0(r[0].assetId,r.map(i=>i.uri)),this.doneCount+=r.length,this.todoCount-=r.length}await gt(5)},qb:(e,r)=>(e=tL(e.select({assetId:"AssetFile.assetId",assetFileId:"AssetFile.id",uri:"AssetFile.uri"})),L(r)&&(e=e.andWhere("AssetFile.id",">",is(r.map(i=>i.assetFileId)))),e)})}};function tL(t){return t.from("AssetFile").join("Asset","Asset.id","AssetFile.assetId").where("Asset.shown",1).andWhere("Asset.excluded",0).andWhere("Asset.hidden",0)}var oL=M(require("events"));var Ys=class extends tr{};Ys.schema="stats",Ys.db=S0;var rr=class extends Ys{};rr.tableName="QueueItem",rr.uniqueColumnName="queueId,contents";function GV(t){return`assetFileUpdates:${kr}:${t}`}function rL(t){return He(t,GV(""))}function iL(t){return`assetUpdates:${Or}:${t}`}var Cn=class extends Ys{static itemCountForQueues(e){return ye(rr.dbl.pluckFirstf(r=>r.countDistinct("QueueItem.id").join("Queue","Queue.id","QueueItem.queueId").whereIn("Queue.name",e)),()=>0)}itemCount(){return rr.dbl.pluckFirstf(e=>e.where({queueId:this.id}).count())}async upsertWorkItemsQuietly(e){await rr.ops().upsert(e.map(r=>g({queueId:this.id},r)),!0)}upsertWorkItems(e){let r=e.map(i=>g({queueId:this.id},i));return this.logger().info("upserting into queue "+this.name,e),rr.ops().upsert(r)}};Cn.tableName="Queue",Cn.uniqueColumnName="name";var Jo=class extends we{constructor(e,r,i,o=!1,n){super(`WorkQueue(${e.sort().join(",")})`,()=>Sl(this.name),Q.first);this.queueNames=e;this._itemIsReady=r;this._processItem=i;this._singleThreaded=o;this._currentWorkQueueLength=n;this.processRate=new li(2*E);this.ee=new oL.EventEmitter;this._queueIsEmpty=!1;this.nextMutex=new tt;this.workItems=new tt;this.recentlyProcessed=new ps(10*v);this.queues=l(()=>Cn.ops().upsert(this.queueNames.map(e=>({name:e}))));this.queueIds=l(()=>this.queues().then(e=>e.map(r=>r.id)));this.pendingWorkCount=l(async()=>{let e=await this.queueIds(),r=await rr.dbl.pluckFirstf(i=>i.whereIn("queueId",e).count());return this._queueIsEmpty=r===0,r},v);this._maxQueueSize=this._singleThreaded?1:jd(),this.resume()}on(e,r){this.ee.addListener(e,r)}resume(){return Cf(this),this}pause(){return Sl(this.name),this}async donePromise(){await Be(async()=>(await this.pendingWorkCount.refresh(),this.done()),{timeoutMs:void 0,timeBetweenMs:2*v})}done(){return this.ended||this._queueIsEmpty&&this.nextMutex.settled&&this.workItems.settled}get runnable(){return!_t()&&!C()&&!this.done()&&!this.ended&&!this._queueIsEmpty&&this.currentWorkCount()<this._maxQueueSize}async enqueueWork(e,r){if(L(e)){let i=await this.queues();await w(p(r,n=>i.find(s=>s.name===n)),i[0]).upsertWorkItemsQuietly(e),this.logger.debug("enqueueWork()",{items:e})}this._queueIsEmpty=!1,this.pendingWorkCount.unset(),B(()=>Vd())}async dequeue(e){await e.delete(),this.pendingWorkCount.unset(),this._queueIsEmpty=!1}get recentFileProgress(){return p(this.recentlyProcessed.shiftOrFirst(),e=>"Processed "+e)}currentQueueItems(){return this.workItems.pendingNames()}doneCount(){return this.processRate.eventCount}async todoCount(){return this.workItems.pendingCount+await this.pendingWorkCount()}currentWorkCount(){return this._singleThreaded?this.workItems.pendingCount:Math.max(this.workItems.pendingCount,this._currentWorkQueueLength())}async percents(){let e=this.doneCount(),r=await this.todoCount(),i=ve(100*(e/(r+e)),2);return{done:e,todo:r,completePct:i,incompletePct:100-i}}currentQueueItemIds(){return this.currentQueueItems().map(e=>e.id)}async onIdle(){return this.next()}async peek(e=this._maxQueueSize*3,r){let i=await this.queueIds(),o=rr.query().whereIn("queueId",i).whereNotIn("id",this.currentQueueItemIds()).limit(e);return r&&(o=o.orderByRaw(Rf(ZF(),"id",500))),rr.ops().all(o)}async next(){return this.runnable?this.nextMutex.maybeRun(this.name+".next()",()=>this._next()):void 0}async _next(e=!1){if(!this.runnable)return;let r=await this.peek(this._maxQueueSize*3,e);if(r.length===0){this.logger.info("_next(): peek was currently empty"),this._queueIsEmpty=!0;return}let i=this._maxQueueSize-this.currentWorkCount();for(this.logger.debug("_next()",{random:e,workSlotsRemaining:i,eligibleItemCount:r.length});!_t()&&!C()&&!this.ended&&i>0&&L(r);){let o=r.shift();if(await this._itemIsReady(o)){this._queueIsEmpty=!1,i--;let n=A(["q."+this.constructor.name+".process",o.type]).join(".");this.logger.info("starting "+o.contents,{workSlotsRemaining:i}),this.workItems.push(o,async()=>{try{this.processRate.onEvent(),await Ge(n,()=>this._processItem(o),(s,a)=>this.logger.info("finished processing",g({elapsed:a},o))),this.ee.emit("processed",o)}catch(s){this.logger.warn("failed processing",o)}finally{await this.dequeue(o),B(Vd,2)}})}}!e&&i>0&&await this._next(!0)}};function nL(t,e){return t.upsertWorkItemsQuietly(e.map(r=>({contents:d(r)})))}async function Eb(){return[...await le(Wt(),async e=>No(e.mountpoint,e)),bM].map(d)}async function sL(){return le(Eb(),KV)}async function KV(t){let e=f("enqueueAssetFileUpdatesForUri("+t+")"),r=await Cn.ops().upsertOne({name:rL(t)});await Sr.applyOnce({name:Ri.enqueueAssetFileUpdates,version:kr,value:t},()=>(e.info("starting",{queue:r.name}),Le.dbl.pluckBatched({onResults:async o=>nL(r,o),qb:(o,n)=>(o=o.select("id").orderBy("id","asc").where("version","<",kr).andWhere("uri","like",t+"%"),L(n)&&(o=o.andWhere("id",">",is(n))),o)})));let i=await r.itemCount();return e.info("Added outdated assetFiles:",{queue:r.name,assetFileCount:i}),i>0?r.name:void 0}async function aL(){let t=await Eb();return it.dbl.pluckFirstf(e=>e.count("Asset.id").distinct().leftJoin("AssetFile","AssetFile.assetId","Asset.id").where("Asset.version","<",Or).andWhere(r=>t.forEach(i=>r.where("AssetFile.uri","like",i+"%"))))}async function Yf(){return le(Eb(),JV)}async function JV(t){let e=f("enqueueAssetUpdatesForUri("+t+")"),r=await Cn.ops().upsertOne({name:iL(t)});await Sr.applyOnce({name:Ri.enqueueAssetUpdates,version:Or,value:t},()=>(e.info("starting",{queue:r}),it.dbl.pluckBatched({onResults:o=>nL(r,o),qb:(o,n)=>(o=o.select("Asset.id").distinct().leftJoin("AssetFile","AssetFile.assetId","Asset.id").orderBy("Asset.id","asc").where("Asset.version","<",Or).andWhere("AssetFile.uri","like",t+"%"),L(n)&&(o=o.andWhere("Asset.id",">",is(n))),o)})));let i=await r.itemCount();return e.info("Added outdated assets:",{queue:r.name,assetCount:i}),i>0?r.name:void 0}var yu=class extends Jo{constructor(e,r,i){super(e,()=>!0,o=>this.processItem(o),!1,i);this.assetFileUpdater=r;this.donePromise().then(()=>this.end())}static async for(e,r){return await Yf(),u.skipAssetFileUpdates.valueOrDefault?void 0:b(sL(),i=>new yu(i,e,r))}async processItem(e){let r=await this.assetFileUpdater(V(e.contents));p(r?.nativePath,i=>this.recentlyProcessed.push(i))}};var QV="AssetPreview",Db=class extends Jo{constructor(e,r){super([QV],()=>!0,i=>this.processItem(i),!1,r);this.repairAssetPreviews=e}async processItem(e){let r=V(e.contents);this.logger.info("processItem",{assetId:r,qi:e});let i=await this.repairAssetPreviews(r,!1);p(i?.path,o=>this.recentlyProcessed.push(o))}};var bu=class extends Jo{constructor(e,r,i){super(e,()=>!0,o=>this.processItem(o),!0,i);this.assetUpdater=r;this.donePromise().then(()=>this.end())}static async for(e,r){return u.skipAssetUpdates.valueOrDefault?void 0:b(Yf(),i=>new bu(i,e,r))}async processItem(e){let r=await this.assetUpdater(V(e.contents));p(r?.nativePath,i=>this.recentlyProcessed.push(i))}};var Ab=class extends we{constructor(e){super("ModelDbUpdater",()=>this.onEnd(),Q.first);this.opts=e;this.name="ModelDbUpdater";this._done=new _e;this.eta=new $s;this.updatedAssetIds=new Set;this._progress=l(()=>Ft.insertNew($f,"\u{1F504}"));this.saveSyncProgress=l(()=>Ft.saveSyncState(this),v);this._outdatedAssetCount=l(()=>aL());this.assetUpdater=async e=>{let r=await this.opts.assetUpdater(e);return this.updatedAssetIds.add(e),this.logger.info("ModelDbUpdater.assetUpdater("+e+")",{result:r}),Qf(r)&&(O(r.skipped)||await this.pq.enqueueWork([{contents:d(e)}]),await Me(r?.assetIdsToUpdate,async i=>{let o=i.filter(n=>!this.updatedAssetIds.has(n));await it.dbl.runf(n=>n.whereIn("id",o).update({version:0})),this.aq==null||this.aq.ended?this.logger.warn("non-empty assetIdsToUpdate, and AssetQueue is null/ended"):await this.aq.enqueueWork(o.map(n=>({contents:d(n)})))})),r};this.run()}async run(){try{if(this.ended||C()||(await Tr.instanceRequired().ready,this.afq=await yu.for(this.opts.assetFileUpdater,this.opts.currentWorkQueueLength),this.logger.info("Starting asset file updates",{afqName:this.afq?.name,afqEnded:this.afq?.ended,afqRunnable:this.afq?.runnable,idleStats:await Vf()}),await this.afq?.donePromise(),this.logger.info("Completed asset file updates",{afqName:this.afq?.name,afqEnded:this.afq?.ended,afqRunnable:this.afq?.runnable,idleStats:await Vf()}),await this.afq?.end(),this.eta.clear(),await this.saveSyncProgress(),this.ended||C()))return;this.pq=new Db(this.opts.assetPreviewUpdater,this.opts.currentWorkQueueLength),this.aq=await bu.for(this.assetUpdater,this.opts.currentWorkQueueLength),this.logger.info("Starting asset updates",{aqName:this.aq?.name,aqEnded:this.aq?.ended,aqRunnable:this.aq?.runnable,idleStats:await Vf()}),await this.aq?.donePromise(),await this.saveSyncProgress(),await this.aq?.end(),await this.pq?.donePromise(),await this.pq?.end(),await this.saveSyncProgress.refresh(),this.logger.info("run(): finished"),this.ended||(this._done.resolve(),await Ft.saveSyncState(this))}catch(e){J("ModelDbUpdater.run() failed",e),this._done.reject(e)}}outdatedAssetCount(){return Z(this.aq,e=>e.pendingWorkCount(),()=>this._outdatedAssetCount())}async onEnd(){await wx(this.afq,this.pq,this.aq),this.afq=this.pq=this.aq=void 0}isNoOp(){return!k(this.afq?.doneCount())&&!k(this.pq?.doneCount())&&!k(this.aq?.doneCount())}done(){return!this._done.pending}donePromise(){return this._done.promise}async progress(){if(this.ended||this.isNoOp())return;let e=await this._progress();if(this.done())return[e.assignFromPojo({state:"done",hed:"Finished rebuilding your library \u{1F389}",dek:[],completePct:100,incompletePct:0,scanningPct:0})];let r=0,i=this.afq;if(i!=null&&!i.done()){let o=await i.todoCount();await se(i.processRate.msPerEvent,async m=>{this.eta.push((await this.outdatedAssetCount()+o)*m)});let{completePct:n}=await i.percents(),s=this.eta.fmtEstimate(),a="Rebuilding your library"+fr(s,m=>", "+m,"\u2026");return[e.assignFromPojo({state:"processing",hed:a,dek:z([i.recentFileProgress,`Updating file metadata (${Ti(o)} remain)`]),completePct:0,incompletePct:n,scanningPct:r})]}else if(this.aq!=null&&this.pq!=null){let o=await this.aq.todoCount();this.eta.push(o*w(this.aq.processRate.msPerEvent,v));let n=o,s=this.aq.doneCount(),a=s/(n+s),m=ve(100*a,2),c=this.eta.fmtEstimate(),h="Rebuilding your library"+fr(c,x=>", "+x,"\u2026");return e.assignFromPojo({state:"processing",hed:h,dek:G([this.pq.recentFileProgress,this.aq.recentFileProgress,`Refreshing assets and previews (${Ti(o)} remain)`]),completePct:m,incompletePct:100-m,scanningPct:r})}}};var Fb=class extends Ii{constructor(e){super({name:"ProgressUpdater",callback:()=>C()||_t()?void 0:b(this.sync(),async r=>{await Ft.saveSyncState(r),await xl()}),intervalMs:m0()});this.sync=e}};var wu=class extends we{constructor(){super(...arguments);this.doneLatch=new _e}done(){return!this.doneLatch.pending}donePromise(){return this.doneLatch.promise}};function $V(t){if(t.isDirectory())return 0;let e=D(As(t.ext));return e.includes(We.Sharp)?1:e.includes(We.RawImage)?2:e.includes(We.Video)?3:4}function YV(t){return[$V(t),t.base]}function lL(t){return ie(t,e=>YV(e))}var Lb={done:!0},Dl={done:!1},xu=class{constructor(e,r,i){this.dir=e;this.ctx=r;this.parent=i;this.pendingChildDirs=[];this._done=!1;this.setupChildren=l(async()=>{if(await ro(this.dir)===!0)this.logger.info("skipping .nomedia dir, "+this.dir);else{let e=await this.dir.children(),r=lL(D(e)).filter(n=>this.ctx.startAtNativePath!=null&&n.isDirectory()&&n.nativePath<this.ctx.startAtNativePath&&!sn(this.ctx.startAtNativePath,n.nativePath)?(this.logger.info("skipping child that is before "+this.ctx.startAtNativePath,n.nativePath),!1):!Ep(n)),[i,o]=da(r,n=>n.isDirectory());this.pendingChildDirs.push(...i),await this.ctx.fileHandler(await f0.filter(o))}});this.nextChain=[this.maybeTimeout,this.setupChildren,this.maybeTimeout,this.maybeDelegateToChild,this.maybeTimeout,this.maybeCompleteResult].map(e=>async r=>await e.bind(this)(r));this.name="stats.DirectoryIterator("+e+")",this.logger=f(this.name)}get isRoot(){return this.parent==null}root(){return this.parent==null?this:this.parent.root()}done(){return this._done}async next(e){if(this.ctx.ended)return Dl;let r=Date.now(),i=await lr(()=>Zn(this.nextChain,o=>this.ctx.ended?Dl:o(e)),{maxRetries:this.ctx.maxRetries,onRetryWaitUntil:()=>nt(Ct(500,Rt/this.ctx.maxRetries))});return i==null?Dl:(this._done=i.done===!0,this.logger.debug("next()",{result:i,ttr:e-r,elapsed:Date.now()-r}),i)}canContinue(e){return!this._done&&!_t()&&Date.now()<e}maybeTimeout(e){return this._done?Lb:this.canContinue(e)?void 0:Dl}async maybeDelegateToChild(e){for(;this.canContinue(e)&&(this.childDelegate!=null||L(this.pendingChildDirs));){if(this.ctx.ended)return Dl;if(this.childDelegate==null){let i=this.pendingChildDirs.shift();await Dp(i)||(this.childDelegate=new xu(i,this.ctx,this))}let r=this.childDelegate;if(r!=null){let i=u.statTimeoutSeconds.valueOrDefault*v-this.dir.pathnames.length*100,o=await Ee(r.next(e),i,()=>(this.logger.warn("Failed to descend into "+r.dir+": TIMEOUT after "+i),Lb));(o==null||o.done===!0)&&(this.childDelegate=void 0)}}}async maybeCompleteResult(){return this.childDelegate!=null||L(this.pendingChildDirs)?(this.logger.warn("maybeCompleteResult, not done (?!)",Mt(this,"result","pendingChildren","childDelegate","pendingChildDirs")),Dl):(await this.ctx.directoryListener(this.dir),Lb)}};var XV=l(()=>ne?R?100:25:500),Ib=class extends wu{constructor(e,r,i,o,n=2){super("DirectoryWalker("+e.nativePath+")",()=>{Sl(this.name)},Q.first);this.root=e;this.fileHandler=r;this.directoryListener=i;this.maxRetries=n;this.mutex=new tt;o!=null&&(this.root.nativePath.startsWith(o)?this.startAtNativePath=o:this.logger.error("bad startAtNativePath: ignoring.")),this.iterator=new xu(e,this),Cf(this)}get runnable(){return!this.ended&&this.doneLatch.pending}onIdle(){return this.run()}run(){return this.mutex.oneRunAtATime(this.name+".run()",()=>this._run())}async _run(){if(this.ended||this.doneLatch.resolved)return;(await this.iterator.next(Date.now()+XV())).done&&(this.logger.info("run(): completed iteration"),Sl(this.name),this.doneLatch.resolve())}};var uL=M(require("path"));async function mL(t,e=!1){let r=[];for(let o of Zo(t,256)){let n=[];for(let m of o)n.push({file:m,uri:await No(m.nativePath)});let s=await Le.ops().allf(m=>m.whereIn("uri",n.map(c=>c.uri.toString()))),a=[];await Ar({name:"precheckFiles",laters:s.map(m=>async()=>{let c=n.find(x=>x.uri.toString()===m.uri),h=X.for(c.file.nativePath,c.file);await m.matchesFile(h)&&a.push({path:c.file.nativePath,assetId:m.assetId,assetFileId:m.id})})}),e&&await Le.touch(a.map(m=>m.assetFileId)),r.push(...a)}let i=r.map(o=>o.path);return{fresh:r,stale:t.filter(o=>!i.includes(o.nativePath))}}function cL(t){let e=A(As(t));return e.includes(We.Video)?"video":e.includes(We.RawImage)?"raw":"image"}var Zf=class extends Jo{constructor(e,r,i,o,n){super([Zf.queueNameForUri(r)],s=>this.itemIsReady(s),s=>this.processItem(s),!1,n);this.root=e;this.uri=r;this.importer=i;this.maxConcurrentVideos=o;this._processedImages=0;this._processedVideo=0;this._imageProcessTimeMs=new ht(50);this._videoProcessTimeMs=new ht(50);this.recentProgress=new ps(15*v);this.recentlyRetried=new Di(30*E);this.processMs=new ht;this.assetProcessRate=new li(5*E);this._lastOpProgress=0;this.fileListener=async e=>{this.logger.debug("fileListener()",{possibleAssetPaths:Ah(e,n=>n.nativePath)});let r=!0,{fresh:i,stale:o}=await Ge("precheckFiles",()=>mL(e,r));this.logger.debug("fileListener()",{fresh:i,stale:o}),!N(o)&&await this.enqueueWork(o.map(n=>({contents:n.nativePath,type:cL(n.ext)})))};this.progressCallback=s=>{this.logger.debug("progressCallback()",s),this.hasPath(s.path)&&(this.recentProgress.push(`${s.op} ${s.path}: ${s.pct.toFixed(0)}%`),this._lastOpProgress=Date.now())},Ic(this.progressCallback),this.onEnds.push(()=>Xv(this.progressCallback))}static queueNameForUri(e){return"afq:"+e}static async for(e,r,i){return new Zf(e,await e.uri(),r,await mD(),i)}get lastOpProgress(){return this._lastOpProgress}get currentPaths(){return this.currentQueueItems().map(e=>e.contents)}get currentBaseFiles(){return this.currentPaths.map(e=>ce.for(e))}hasPath(e){for(let r of this.currentPaths)if(e===r)return!0;return!1}get currentVideoJobCount(){return Er(this.currentPaths,e=>Fi((0,uL.extname)(e)))}get currentVideoJobCapacity(){return re(0,this.maxConcurrentVideos,this.maxConcurrentVideos-this.currentVideoJobCount)}get preventAdditionalVideoJobs(){return this.currentVideoJobCount>=this.maxConcurrentVideos}get processedCount(){return this._processedImages+this._processedVideo}get processedImageCount(){return this._processedImages}get processedVideoCount(){return this._processedVideo}get avgImageProcessingTime(){return this._imageProcessTimeMs.p84}get avgVideoProcessingTime(){return this._videoProcessTimeMs.p84}async stats(){return{pendingCount:await this.pendingCount(),processedImageCount:this.processedImageCount,processedVideoCount:this.processedVideoCount,avgImageProcessingTime:this.avgImageProcessingTime,avgVideoProcessingTime:this.avgVideoProcessingTime}}currentCounterState(){return{processedImageCount:this.processedImageCount,processedVideoCount:this.processedVideoCount}}itemQuery(e){return rr.query().whereIn("queueId",e)}async pendingCount(){return rr.dbl.pluckFirst(this.itemQuery(await this.queueIds()).count("id"))}async pendingImagesCount(){return rr.dbl.pluckFirst(this.itemQuery(await this.queueIds()).andWhere("type","!=","video").count("id"))}async pendingVideoCount(){return rr.dbl.pluckFirst(this.itemQuery(await this.queueIds()).andWhere("type","=","video").count("id"))}get recentFileProgress(){return w(this.recentProgress.shift(),()=>p(this.recentlyProcessed.shiftOrFirst(),e=>"Processed "+e))}async enqueueOrTouchAssetFiles(e){let r=[],i=[];await Ar({name:"enqueueOrTouchAssetFiles",laters:e.map(o=>async()=>{let n=await o.posixFile();n!=null&&(await o.matchesFile()===!0?r.push(o.id):i.push({contents:n.nativePath,type:cL(n.ext)}))})}),await Le.touch(r),await this.enqueueWork(i),this.logger.info("enqueueOrTouchAssetFiles()",{freshAssetFileIds:r,stale:i})}async handleError(e,r){this.logger.warn("handleError()",{qi:e,err:r}),ls(r)&&!this.recentlyRetried.has(e.contents)&&await b(br.for(e.contents),i=>(this.recentlyRetried.add(e.contents),this.logger.info("Re-enqueuing "+i),this.fileListener([i])))}onFileDone(e,r){this.logger.debug("onFileDone("+e.contents+", "+r+" ms)");let i=ZV(e);Fi(i.ext)?this._processedVideo++:this._processedImages++,r>0&&(Fi(i.ext)?this._videoProcessTimeMs.push(r):this._imageProcessTimeMs.push(r))}async itemIsReady(e){if(e.type==="video"&&this.currentVideoJobCapacity<=0)return!1;let i=ce.for(e.contents);return!G(this.currentBaseFiles.map(uo)).includes(uo(i))}async processItem(e){let r=Date.now();try{let i=await this.importer(e.contents);Jf(i)?await this.onFileDone(e,Date.now()-r):gu(i)&&await this.handleError(e,Sa(i.error))}catch(i){return this.handleError(e,i)}finally{this.assetProcessRate.onEvent(),this.processMs.push(Date.now()-r),this.recentlyProcessed.push(e.contents)}}},Xf=Zf;Xf.MaxErrors=2;function ZV(t){return X.for(t.contents)}var Xs=class extends wu{constructor(e,r,i,o,n,s){super("DirectorySync("+e+")",()=>this.onEnd(),Q.first);this.root=e;this.rootUri=r;this.fileHandler=i;this.assetFileQueue=o;this.assetFileUpdater=n;this.currentWorkQueueLength=s;this.start=Date.now();this._isScanning=!0;this._staleEnqueued=!1;this.eta=new $s;this.recentlyScannedDirs=new ts(10);this.scannedDirsCount=0;this.processedImageCount=0;this.processedVideoCount=0;this.onProcessed=e=>{Fi(e.contents)?this.processedVideoCount++:this.processedImageCount++};this._progress=l(()=>Ft.insertNew(this.rootUri,this.root.nativePath));this.priorMeta=l(async()=>(await this._progress()).getMetaAsRecord());this.saveSyncProgress=l(()=>Ft.saveSyncState(this),ne?100:v);this.saveLastScannedDirectory=l(async()=>{let e=await this._progress();await e.setMeta(js.scannedDirectoryCount,this.scannedDirsCount.toString());let r=this.recentlyScannedDirs.item(-1);r!=null&&await e.setMeta(js.lastScannedDirectory,r)},ne?50:500);this.directoryListener=e=>K(e?.nativePath,r=>(this.scannedDirsCount++,this.recentlyScannedDirs.push(r),this.logger.debug("directoryListener()",{scannedDirsCount:this.scannedDirsCount,dir:e.nativePath}),this.saveLastScannedDirectory()));this.earliestStartTime=l(async()=>{let r=(await Ft.times()).find(i=>i.uri===this.rootUri);return w(r?.lastStartedAt,Date.now())});this.staleAssetFileCount=l(async()=>{if(this._staleEnqueued)return 0;let e=await this.earliestStartTime();return Le.dbl.pluckFirstf(r=>r.where("uri","LIKE",this.rootUri+"%").andWhere("updatedAt","<",e))},20*v);this.setup=l(async()=>{let e=await this.priorMeta(),r=await this.earliestStartTime();if(this.logger.info("setup()",{priorMeta:e,earliestStartTime:r}),p(e.lastScannedDirectory,i=>this.recentlyScannedDirs.push(i)),se(e.processedImageCount,i=>this.processedImageCount+=i),se(e.processedVideoCount,i=>this.processedVideoCount+=i),await this.maybeRunDirectorySync(),this.logger.info("setup() setting isScanning to false."),this._isScanning=!1,await this.maybeEnqueueStaleAssetFiles(),await this.assetFileQueue.donePromise().catch(i=>{J("assetFileQueue donePromise failed",i)}),!this.ended){await this.doneLatch.resolve();let i=await this.progress();this.logger.info("DONE! Marking Progress as complete:"),await i.upsert({completedAt:Date.now()})}});this.assetFileQueue.on("processed",this.onProcessed),this.doneLatch.observe(this.setup())}static async for({root:e,uri:r,fileHandler:i,assetFileUpdater:o,currentWorkQueueLength:n}){let s=await ye(r,()=>e.uri()),a=await e.directoryEntry();if(s==null||a==null){f("DirectorySync").warn("Cannot make DirectorySync for "+e,{rootUri:s,rootDE:a});return}let m=await Xf.for(e,i,n);return new Xs(e,s,i,m,o,n)}async onEnd(){await yt(this.directoryWalker),await yt(this.assetFileQueue),await this.saveSyncProgress.refresh()}async maybeRunDirectorySync(){let e=await this.priorMeta();if(e.completedDirectoryScan!=null){this.logger.info("setup() skipping scan: prior sync finished.");return}let r=await this._progress();this.scannedDirsCount=w(V(e.scannedDirectoryCount),0),this.directoryWalker=new Ib(await this.root.directoryEntry(),this.assetFileQueue.fileListener,this.directoryListener,e.lastScannedDirectory),this.logger.info("maybeRunDirectorySync() started directoryWalker",{lastScannedDirectory:e.lastScannedDirectory}),await this.directoryWalker.donePromise().catch(i=>{J("directoryCounter donePromise failed",i)}),this.logger.info("maybeRunDirectorySync() completed directoryWalker",{scannedDirsCount:this.scannedDirsCount}),await r.setMeta(js.completedDirectoryScan,"true")}async maybeEnqueueStaleAssetFiles(){if(!u.forceSync.valueOrDefault&&(await this.priorMeta())?.enqueuedStaleFiles!=null)this.logger.info("setup() skipping scan: prior sync finished.");else{let e=await this._progress(),r=await this.earliestStartTime();this.logger.info("maybeEnqueueStaleAssetFiles() starting enqueue",{assetFileQueuePendingCount:await this.assetFileQueue.pendingCount()}),await Le.ops().batched({onResults:async i=>this.assetFileQueue.enqueueOrTouchAssetFiles(i),qb:i=>i.where("uri","LIKE",this.rootUri+"%").andWhere("updatedAt","<",r)}),this.logger.info("maybeEnqueueStaleAssetFiles() finished enqueue",{assetFileQueuePendingCount:await this.assetFileQueue.pendingCount()}),await e.setMeta(js.enqueuedStaleFiles,"true")}this.staleAssetFileCount.unset(),this._staleEnqueued=!0}processedCount(){return this.processedImageCount+this.processedVideoCount}pendingCount(){return this.assetFileQueue.pendingCount()}get isScanning(){return this._isScanning}async estimatedScannedPct(){if(!this.isScanning)return 100;let e=100/-(this.scannedDirsCount/500+1)+100;return ve(e,4)}async progress(){let e=this.done(),r=_t()||C(),i=this.done()?"done":r?"paused":"processing",o=[];!e&&!r&&(K(this.assetFileQueue.recentFileProgress,c=>o.push(c)),this.isScanning&&o.push("Scanning "+aa(this.recentlyScannedDirs.shiftOrFirst(),this.root.nativePath)));let n=[];this.processedImageCount+this.processedVideoCount>0&&n.push("Processed",as(this.processedImageCount,"photo"),"and",as(this.processedVideoCount,"video")+".");let s=await this.pendingCount();!e&&s>0&&n.push(this.isScanning?"At least":"",Ti(s),"remain to be processed"),o.push(z(n).join(" "));let a=[];a.push(ec(i)),e||p(this.eta.fmtEstimate(),c=>a.push(c));let m=await this._progress();return this.processedImageCount>1&&await m.setMeta(js.processedImageCount,String(this.processedImageCount)),this.processedVideoCount>1&&await m.setMeta(js.processedVideoCount,String(this.processedVideoCount)),this.logger.tap({msg:".progress()",result:m.assignFromPojo(g({state:i,hed:a.join(", "),dek:o},await this.percents()))})}async percents(){if(this.done())return{completePct:100,incompletePct:0,scanningPct:0};let e=await this.estimatedScannedPct(),r=100-e,i=await this.processedCount(),o=await this.pendingCount(),n=o===0&&i===0?0:ve(e*(i/(o+i)),4),s=100-(n+r),a={completePct:n,incompletePct:s,scanningPct:r};if(this.logger.debug("percents(): ",{scannedPct:e,processed:i,pending:o,p:a}),Hi([a.completePct,a.incompletePct,a.scanningPct])!==100&&this.logger.warn("percents(): BUGGED",{p:a,processed:i,pending:o,scannedPct:e,scanningPct:r,incompletePct:s,completePct:n}),e===100&&i>7){let m=this.assetFileQueue,c=0,h=await m.pendingImagesCount(),x=await m.pendingVideoCount();{let S=m.avgImageProcessingTime;h>0&&S!=null&&(c+=h*S)}{let S=m.avgVideoProcessingTime;x>0&&S!=null&&(c+=x*S)}{let S=c>0?c/nn():void 0,F=m.assetProcessRate.eventCount>5?p(m.assetProcessRate.msPerEvent,U=>(h+x)*U):void 0;this.logger.info("ETAs",g({eta1:S,eta2:F,msPerAssetProcessed:m.assetProcessRate.msPerEvent},m.stats())),p(Ot(A([S,F])),U=>this.eta.push(Ye(U)))}}return a}};var Zs=l(()=>f("SyncPaths")),kb=new Di(10*E);async function eU(){return le(Wt(),t=>t.ignorable!==!1&&k(t.size)?b(No(t.mountpoint,t),e=>({nativePath:t.mountpoint,uri:e.toString()})):void 0)}function tU(t){return b(t.uri(),e=>({nativePath:t.nativePath,uri:e}))}function rU(t){return b(No(t),e=>({nativePath:t,uri:e.toString()}))}async function iU(){return le(u.scanPaths.values,rU)}async function oU(){let t=[];t.push(...await iU()),u.scanAllDrives.valueOrDefault&&t.push(...await eU());let e=await he(Ns(),tU,()=>Zs().throw("libraryOriginalsDir was null",u.libraryPath.value));u.scanLibraryFirst.valueOrDefault&&t.unshift(e),u.scanLibraryLast.valueOrDefault&&t.push(e),$u(t,i=>i.nativePath);let r=await Qi(t,i=>!kb.has(i.nativePath)&&ln(i.nativePath));return Zs().info("pathsToSync",r),r}async function nU(){let t=await oU(),e=await Ft.times();return t.map(r=>g(g({},e.find(i=>i.uri===r.uri)),r))}async function pL(){let t=await nU();return sU(t)}async function sU(t){let e=await Sr.getFirstPendingOp({name:Ri.forceRestartSync}),r=w(e?.createdAt,Date.now()-u.syncIntervalHours.valueOrDefault*ft),i=e==null&&u.syncIntervalHours.valueOrDefault<=0?[]:t.filter(o=>!bo(o.lastCompletedAt,r));Zs().info("bestStable()",{arr:t,staleCompletedAt:r,notCompletedRecently:i.map(o=>o.nativePath)});{let o=Date.now()-30*lt,n=i.filter(s=>!bo(s.lastCompletedAt,o))[0];if(n!=null)return Zs().info("bestStable()",{notCompleted:n}),n}Zs().info("bestStable(): all paths have been completed at least once in the last month (yay)");{let o=dt(i,n=>w(n.lastUpdatedAt,Date.now()));if(o!=null)return Zs().info("bestStable()",{mostRecentlyUpdated:o}),o}Zs().info("bestPathToSync(): all paths have been recently completed (yay). Marking sync as complete."),await Sr.markOpCompleted({name:Ri.forceRestartSync})}var ed=class extends we{constructor(e,r,i){super("SyncRunner",()=>this.endCurrentSync(),Q.first);this.fileHandler=e;this.assetFileUpdater=r;this.currentWorkQueueLength=i;this._doneLatch=new _e;this.maybeSetupNextSync()}async progress(){return b(this.currentSync,e=>e.progress())}done(){return this._doneLatch.settled}donePromise(){return this._doneLatch.promise}endCurrentSync(){let e=this.currentSync;return this.currentSync=void 0,this.currentSyncUri=void 0,yt(e)}async setSyncPath(e){if(this.ended)return;Xs.for({root:X.for(e.nativePath),uri:e.uri.toString(),fileHandler:this.fileHandler,assetFileUpdater:this.assetFileUpdater,currentWorkQueueLength:this.currentWorkQueueLength}).then(async i=>{this.currentSync=i,this.currentSyncUri=i==null?void 0:e,i!=null?(this.logger.info("setSyncPath(): waiting for completion...",e),await i.donePromise(),this.logger.info("setSyncPath(): done",e)):(kb.add(e.nativePath),this.logger.warn("setSyncPath(): no-op (CHECK ME!)",e))}).catch(i=>{this.logger.warn("setSyncPath(): caught",i)}).then(()=>this.maybeSetupNextSync())}async maybeSetupNextSync(){if(this.ended||this._doneLatch.resolved)return;let e=await pL();if(e==null)return this._doneLatch.resolve(),this.endCurrentSync();if(this.currentSyncUri?.nativePath!==e.nativePath)return this.setSyncPath(e)}};var Ob=class{constructor(e,r){this.root=e;this._ended=!1;this.uri=l(()=>ye(this.root.uri(),()=>"file:///"+this.root.posixPath));this._progress=l(async()=>Ft.insertNew(await this.uri(),this.volume));this.name="FileSync("+e+")",this.sync=new Jt(this.name).observe(r)}get ended(){return this._ended}end(){this._ended=!0}done(){return this.sync.settled}donePromise(){return this.sync.promise}get volume(){return this.root.nativePath}async progress(){return(await this._progress()).assignFromPojo({state:this.sync.pending?"processing":"done"})}};var aU=l(()=>f("Syncs"));async function lU(t,e,r,i){if(P(t))return;let o=X.for(t);if(await o.isNonEmptyFile())return new Ob(o,e(t));if(await o.isDirectory())return Xs.for({root:o,fileHandler:e,assetFileUpdater:r,currentWorkQueueLength:i});aU().warn("syncPaths(): Cannot import non-empty-file, non-dir: "+o)}var vu=class extends we{constructor(e,r){super(`Syncs(${e})`,()=>yt(this.currentSync),Q.first);this.laters=r;this._done=new _e;this.run=l(async()=>{try{for(let e of this.laters){let r=await e();r!=null&&(this.currentSync=r,await r.donePromise())}this._done.resolve()}catch(e){J("Syncs.run() failed",e),this._done.reject(e)}});this.run()}static forPaths(e,r,i,o){return new vu("import paths fs sync",D(e).map(n=>()=>lU(n,r,i,o)))}done(){return!this._done.pending}donePromise(){return this._done.promise}async progress(){return p(this.currentSync,e=>e.progress())}};var mU=f("SyncService"),_b=class{constructor(e=Rb.default.argv.slice(2),r=me){this.importPaths=e;this.ee=r;this.logger=f("SyncService");this.progressUpdater=l(()=>new Fb(()=>this.sync()));this.processCount=0;this.processFile=async e=>{try{return await this.enqueueTask(new Tb(e))}catch(r){return mU.warn("Failed to process "+e,r),{path:e,error:r}}};this.setup=l(async()=>{if(await jx(this.service.ready)){this.logger.warn("setup(): service.ready was rejected, exitting.");return}lg(...D(this.importPaths)),u.forceSync.valueOrDefault&&(this.logger.info("setup(): --force: clearing cache directories "),await Ap());let e=Tr.instanceRequired();this.logger.info("setup(): library is at "+e.rootDir),await e.ready,u.rebuild.valueOrDefault&&(this.logger.info("setup(): --rebuild: setting all assets to require updates..."),await E0()),this.syncFileCluster=await this.mkSyncFileCluster(),await this.sync(),await this.progressUpdater(),this.service.setInputHandler("--status",()=>this.status()),this.service.setInputHandler("--cancel-sync",()=>this.cancelSync()),Rb.default.on("SIGUSR1",()=>this.cancelSync()),ne&&L(this.importPaths)&&Ic(i=>console.log(I(i)));let r=!1;me.on("repairAsset",i=>this.repairAsset(i?.assetId,w(i?.force,!0),r)),me.on("repairAssetFile",i=>this.repairAssetFile(i?.assetFileId,w(i?.force,!0))),lc(()=>this.maybeRestartSyncOnVolumeChange())});this.taskDataChunkers=new Map;this.mkSyncFileCluster=l(async()=>{this.taskDataChunkers.clear();let e=await KM("sync-file");if(e==null)return this.logger.throw("Could not find sync-file");this.logger.info("syncFileCluster(): sync-file found at "+e);let r=Tg*2,i=new fL.BatchCluster({processFactory:()=>(this.logger.info("Spawning new sync-file",{execPath:process.execPath,syncFile:e.nativePath,maxProcs:nn()}),pm(process.execPath,[...JM("sync-file"),e.nativePath],r)),maxProcs:nn()+1,maxIdleMsPerProcess:5*E,maxTasksPerProcess:u.maxTasksPerProcess.valueOrDefault,spawnTimeoutMillis:H,taskTimeoutMillis:void 0,endGracefulWaitTimeMillis:E,maxProcAgeMillis:r,versionCommand:"--version",pass:xb,fail:Gd,exitCommand:"--exit",cleanupChildProcs:!1});return i.on("taskData",(o,n)=>{o!=null&&n!=null&&this.taskDataChunkers.get(d(n))?.onChunk(o)}),new Ss("sync-file",i,Q.first)});this.currentWorkQueueLength=()=>Z(this.syncFileCluster,e=>e.t.busyProcs+e.t.pendingTasks,()=>0);this.setupStatsDb=l(()=>Tr.instanceRequired().statsDb());this.assetFileUpdater=e=>this.repairAssetFile(e,!1);this.modelDbUpdater=l(async()=>{if(u.skipModelUpdates.valueOrDefault){this.logger.info("modelDbUpdater: skipUpdates is set.");return}let e=new Ab({assetFileUpdater:this.assetFileUpdater,assetUpdater:r=>this.repairAsset(r,!1,!0),assetPreviewUpdater:r=>this.repairAssetPreviews(r,!1),currentWorkQueueLength:this.currentWorkQueueLength});return e.donePromise().then(async()=>{this.logger.info("modelDbUpdater completed."),this.sync.refresh()}),e.donePromise().catch(r=>{J("ModelDbUpdater failed",r),this.sync.refresh()}),e});this.directoryTaggerOp=l(()=>{let e=new Pb;return e.donePromise().then(async()=>{this.logger.info("directoryTaggerOp completed. Starting normal sync."),this.sync.refresh()}),e});this.maybeRestartSyncOnVolumeChange=ys(async()=>{let e=await this.sync.prior();e instanceof ed&&e.maybeSetupNextSync()},Rt);this.sync=l(async()=>{await this.setupStatsDb();{let r=await this.modelDbUpdater();if(r!=null&&!r.done())return r}{let r=this.directoryTaggerOp();if(!r.done())return r}let e=L(this.importPaths)?vu.forPaths(this.importPaths,this.processFile,this.assetFileUpdater,this.currentWorkQueueLength):new ed(this.processFile,this.assetFileUpdater,this.currentWorkQueueLength);return this.exitWhenDone&&gt(v).then(()=>p(e,r=>r.donePromise())).then(()=>gt(v)).catch(r=>this.service.exit({reason:"Error: "+r,status:12,waitForJobs:!1})).then(()=>this.service.exit({reason:"Finished",status:0,waitForJobs:!0})),e});vt(e,T),lg(...e),this.exitWhenDone=u.exitWhenDone.valueOrDefault||L(e),this.service=new vb({name:"sync"}),Ix(()=>this.service.exit({reason:"rpcServerChange",status:0,waitForJobs:!1})),this.setup().catch(i=>J("setup() failed",new ae({cause:i,fatal:!0}))),this.imgFileCleanup=new Ip(zs,5*E,i=>i.pathnames.includes(uy)),new Ip(async()=>X.for(await mh()),u.readdirCacheSeconds.valueOrDefault*v,i=>i.pathnames.includes(lh))}async done(){let e=await this.sync();return e==null||e.done()}onProcessed(){this.processCount++,this.processCount%50==0&&this.imgFileCleanup.cleanup()}async status(){try{let e=await this.sync.prior(),r=await Ym();(Fp(r)||ug(r)||cg(r))&&(this.logger.info("status(): healthcheck is sad, let's clean up tmpfiles",r),this.imgFileCleanup.cleanup(this.imgFileCleanup.maxAgeMs/2));let i={libraryPath:u.libraryPath.value,rpcPort:u.rpcPort.value,ending:C(),done:await this.done(),sync:p(e,o=>o.name),healthChecks:r,progress:await e?.progress()};_i(i)}catch(e){_i({error:e})}}async enqueueUpdateTask(e){let r=Date.now(),i=await this.enqueueTask(new Mb(e));return ne&&_i(g(g(g({},e),{elapsedMs:Date.now()-r}),i)),i}async enqueueTask(e){if(C())return;await this.setup();let r=await this.syncFileCluster?.t;return r==null?this.logger.throw("syncFileCluster is undefined"):lr(async()=>{if(C())return;let i=d(e);try{return this.taskDataChunkers.set(i,new _c(`
`,o=>this.onTaskData(o),!0)),await r.enqueueTask(e)}finally{this.onProcessed(),this.taskDataChunkers.delete(i)}},{maxRetries:2,errorIsRetriable:ls})}async repairAsset(e,r,i){return this.logger.info("Asked to repair asset ",{assetId:e,force:r,skipPreviews:i}),se(e,o=>this.enqueueUpdateTask({updateAssetId:o,force:r,skipPreviews:i}))}async repairAssetFile(e,r){return this.logger.info("Asked to repair assetFile",{assetFileId:e}),se(e,i=>this.enqueueUpdateTask({updateAssetFileId:i,force:r}))}async repairAssetPreviews(e,r){return this.logger.info("Asked to repair asset preview",{assetId:e}),se(e,i=>this.enqueueUpdateTask({updateAssetPreviewId:i,force:r}))}async cancelSync(){let e=await this.sync();e.done()?this.logger.info("cancelSync(): No sync to end."):(this.logger.info("cancelSync(): ending current sync..."),await e.end())}onTaskData(e){let r=w(et(()=>JSON.parse(e)),{});fh(r)&&(ne&&_i(r),nm(r))}async restartSync(){return await yt(this.sync.clear(),E),this.sync()}};try{KL().install()}catch{}async function HU(){let t=await new zh("sync","[files-or-directories...]",`If paths are provided on the command line, they should be fully-qualified.

* Paths to directories will be scanned recursively.
* Paths to files will be imported if they pass configured filters.

Note that sync will spawn 1 or more \`sync-file\` processes to work in parallel.

If a sync job is running, it can be cancelled by sending process signal SIGUSR1, or by sending \`--cancel-sync\` (followed by a newline) to stdin.`).add(qM,HM,jM,MS,GM,ES).parse();new _b(t.args)}HU();
//# sourceMappingURL=sync.js.map
