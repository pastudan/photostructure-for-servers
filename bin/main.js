#!/usr/bin/env node

/*
 * Copyright Â© 2021, PhotoStructure Inc.
 * By using this software, you accept all of the terms in <https://photostructure.com/eula>.
 * IF YOU DON'T ACCEPT THESE TERMS, DO NOT USE THIS SOFTWARE
 */

(()=>{var e={19739:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=19739,e.exports=t},74485:e=>{const t={PasetoNotSupported:"ERR_PASETO_NOT_SUPPORTED",PasetoDecryptionFailed:"ERR_PASETO_DECRYPTION_FAILED",PasetoInvalid:"ERR_PASETO_INVALID",PasetoVerificationFailed:"ERR_PASETO_VERIFICATION_FAILED",PasetoClaimInvalid:"ERR_PASETO_CLAIM_INVALID",PasetoWorkerFailure:"ERR_PASETO_WORKER_FAILURE"};class i extends Error{constructor(e){super(e),this.name=this.constructor.name,this.code=t[this.constructor.name],Error.captureStackTrace(this,this.constructor)}}e.exports.PasetoError=i,e.exports.PasetoNotSupported=class extends i{},e.exports.PasetoDecryptionFailed=class extends i{},e.exports.PasetoInvalid=class extends i{},e.exports.PasetoVerificationFailed=class extends i{},e.exports.PasetoClaimInvalid=class extends i{},e.exports.PasetoWorkerFailure=class extends i{}},79551:(e,t,i)=>{const{PasetoInvalid:n,PasetoNotSupported:r}=i(74485),{decode:s}=i(87536),a=i(91225);e.exports=(e,{parse:t=!0}={})=>{if("string"!=typeof e)throw new TypeError("token must be a string");const{0:i,1:o,2:l,3:u,length:c}=e.split(".");if(3!==c&&4!==c)throw new n("token value is not a PASETO formatted value");if("v1"!==i&&"v2"!==i)throw new r("unsupported PASETO version");if("local"!==o&&"public"!==o)throw new r("unsupported PASETO purpose");const d={footer:u?s(u):void 0,payload:void 0,version:i,purpose:o};if("local"===o)return d;const h="v1"===i?256:64;let p;try{p=s(l).slice(0,-h)}catch(e){throw new n("token value is not a PASETO formatted value")}return d.payload=t?a(p):p,d}},15880:(e,t,i)=>{const n=i(79551);e.exports={decode:n}},77308:(e,t,i)=>{const n=i(62705);e.exports=({audience:e,expiresIn:t,iat:i=!0,issuer:r,jti:s,kid:a,notBefore:o,now:l=new Date,subject:u},c)=>{if(!(l instanceof Date&&l.getTime()))throw new TypeError("options.now must be a valid Date object");const d=l.getTime();if(void 0!==i){if("boolean"!=typeof i)throw new TypeError("options.iat must be a boolean");i&&(c.iat=new Date(d))}if(void 0!==t){if("string"!=typeof t)throw new TypeError("options.expiresIn must be a string");c.exp=new Date(d+n(t))}if(void 0!==o){if("string"!=typeof o)throw new TypeError("options.notBefore must be a string");c.nbf=new Date(d+n(o))}if(void 0!==e){if("string"!=typeof e)throw new TypeError("options.audience must be a string");c.aud=e}if(void 0!==r){if("string"!=typeof r)throw new TypeError("options.issuer must be a string");c.iss=r}if(void 0!==u){if("string"!=typeof u)throw new TypeError("options.subject must be a string");c.sub=u}if(void 0!==a){if("string"!=typeof a)throw new TypeError("options.kid must be a string");c.kid=a}if(void 0!==s){if("string"!=typeof s)throw new TypeError("options.jti must be a string");c.jti=s}return c}},88277:(e,t,i)=>{const{PasetoClaimInvalid:n}=i(74485),r=i(62705);e.exports=({ignoreExp:e,ignoreNbf:t,ignoreIat:i,maxTokenAge:s,subject:a,issuer:o,clockTolerance:l,audience:u,now:c=new Date},d)=>{if(!(c instanceof Date&&c.getTime()))throw new TypeError("options.now must be a valid Date object");const h=c.getTime();if("iss"in d&&"string"!=typeof d.iss)throw new n("payload.iss must be a string");if(void 0!==o){if("string"!=typeof o)throw new TypeError("options.issuer must be a string");if(d.iss!==o)throw new n("issuer mismatch")}if("sub"in d&&"string"!=typeof d.sub)throw new n("payload.sub must be a string");if(void 0!==a){if("string"!=typeof a)throw new TypeError("options.subject must be a string");if(d.sub!==a)throw new n("subject mismatch")}if("aud"in d&&"string"!=typeof d.aud)throw new n("payload.aud must be a string");if(void 0!==u){if("string"!=typeof u)throw new TypeError("options.audience must be a string");if(d.aud!==u)throw new n("audience mismatch")}if(void 0!==l&&"string"!=typeof l)throw new TypeError("options.clockTolerance must be a string");const p=l?r(l):0;let m;if("iat"in d){if("string"!=typeof d.iat)throw new n("payload.iat must be a string");if(m=new Date(d.iat).getTime(),!m)throw new n("payload.iat must be a valid ISO8601 string");if(!i&&m>h+p)throw new n("token issued in the future")}if("nbf"in d){if("string"!=typeof d.nbf)throw new n("payload.nbf must be a string");const e=new Date(d.nbf).getTime();if(!e)throw new n("payload.nbf must be a valid ISO8601 string");if(!t&&e>h+p)throw new n("token is not active yet")}if("exp"in d){if("string"!=typeof d.exp)throw new n("payload.exp must be a string");const t=new Date(d.exp).getTime();if(!t)throw new n("payload.exp must be a valid ISO8601 string");if(!e&&t<=h-p)throw new n("token is expired")}if(void 0!==s){if("string"!=typeof s)throw new TypeError("options.maxTokenAge must be a string");if(!("iat"in d))throw new n("missing iat claim");if(m+r(s)<h+p)throw new n("maxTokenAge exceeded")}}},87536:e=>{Buffer.isEncoding("base64url")?e.exports.encode=e=>Buffer.from(e).toString("base64url"):e.exports.encode=e=>e.toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),e.exports.decode=e=>Buffer.from(e,"base64")},25054:(e,t,i)=>{const n=i(10315);e.exports=function(e){if(void 0===e)return Buffer.from("");if(Buffer.isBuffer(e))return e;if(n(e))return Buffer.from(JSON.stringify(e),"utf8");if("string"!=typeof e)throw new TypeError("options.footer must be a string, Buffer, or a plain object");return Buffer.from(e,"utf8")}},55589:(e,t,i)=>{const n=i(77308),r=i(10315);e.exports=(e,t)=>{if(Buffer.isBuffer(e)){if(0!==Object.keys(t).length)throw new TypeError("options cannot contain claims when payload is a Buffer");return e}if(!r(e))throw new TypeError("payload must be a Buffer or a plain object");return e=(e=>JSON.parse(JSON.stringify(e)))(e),e=n(t,e),Buffer.from(JSON.stringify(e),"utf-8")}},45112:(e,t,i)=>{const n=i(76417),r=i(31669),{PasetoWorkerFailure:s}=i(74485),a=i(97540);let o;if(n.hkdf){const e=r.promisify(n.hkdf);o=(t,i,n,r)=>e("sha384",t,n,r,i)}else o=(e,t,i,n)=>{const r=c.hmac("sha384",e,i),s=Buffer.from(n);let a,o=Buffer.from(""),l=Buffer.from("");for(let e=1;Buffer.byteLength(o)<t;++a){a=Buffer.from(String.fromCharCode(e));const t=Buffer.concat([l,s,a]);l=c.hmac("sha384",t,r),o=Buffer.concat([o,l])}return Buffer.from(o).slice(0,t)};const l=i(45018),u=i(156),c={async"aes-256-ctr-hmac-sha-384-encrypt"(e,t,i,n){let r=c.hmac("sha384",e,n);r=r.slice(0,32),t=Buffer.from(t);const s=r.slice(0,16),[u,d]=await Promise.all([o(i,32,s,"paseto-encryption-key"),o(i,32,s,"paseto-auth-key-for-aead")]),h=c.encrypt("aes-256-ctr",e,u,r.slice(16)),p=a("v1.local.",r,h,t),m=c.hmac("sha384",p,d);return l("v1.local.",[r,h,m],t)},async"aes-256-ctr-hmac-sha-384-decrypt"(e,t,i){const n=e.slice(0,32),r=e.slice(-48),s=e.slice(32,-48),l=n.slice(0,16),[d,h]=await Promise.all([o(i,32,l,"paseto-encryption-key"),o(i,32,l,"paseto-auth-key-for-aead")]),p=a("v1.local.",n,s,t),m=c.hmac("sha384",p,h),f=c.decrypt("aes-256-ctr",s,d,n.slice(16));return!(!u(r,m)||!f)&&f},hmac(e,t,i){const r=n.createHmac(e,i);return r.update(t),r.digest()},verify:(e,t,i,r)=>n.verify(e,t,i,r),sign:(e,t,i)=>n.sign(e,t,i),encrypt(e,t,i,r){const s=n.createCipheriv(e,i,r);return Buffer.concat([s.update(t),s.final()])},decrypt(e,t,i,r){const s=n.createDecipheriv(e,i,r);return Buffer.concat([s.update(t),s.final()])}};e.exports=c},10315:e=>{e.exports=e=>!!e&&e.constructor===Object},44071:(e,t,i)=>{const{PasetoNotSupported:n}=i(74485);e.exports=e=>{if(!Number.isSafeInteger(e))throw new n("message is too long for Node.js to safely process");const t=~~(e/4294967295),i=e%4294967295-t,r=Buffer.allocUnsafe(8);return r.writeUInt32LE(t,4),r.writeUInt32LE(i,0),r}},62705:e=>{const t=36e5,i=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;e.exports=e=>{const n=i.exec(e);if(!n)throw new TypeError(`invalid time period format ("${e}")`);const r=parseFloat(n[1]);switch(n[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(1e3*r);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(6e4*r);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(r*t);case"day":case"days":case"d":return Math.round(864e5*r);case"week":case"weeks":case"w":return Math.round(6048e5*r);case"year":case"years":case"yr":case"yrs":case"y":return Math.round(315576e5*r)}}},45018:(e,t,i)=>{const{encode:n}=i(87536);e.exports=function(e,t,i){return 0!==i.length?`${e}${n(Buffer.concat(t))}.${n(i)}`:`${e}${n(Buffer.concat(t))}`}},97540:(e,t,i)=>{const n=i(44071);e.exports=(...e)=>{let t=n(e.length);for(let i of e){i=Buffer.from(i,"utf8");const e=n(Buffer.byteLength(i));t=Buffer.concat([t,e,i])}return t}},91225:(e,t,i)=>{const{PasetoInvalid:n}=i(74485),{strict:r}=i(42357),s=i(10315);e.exports=e=>{try{const t=JSON.parse(e);return r(s(t)),t}catch(e){throw new n("All PASETO payloads MUST be a JSON object")}}},42447:(e,t,i)=>{const n=i(76417),{promisify:r}=i(31669),s=r(n.randomFill);e.exports=async function(e){const t=Buffer.allocUnsafe(e);return s(t)}},69946:(e,t,i)=>{const{sign:n}=i(45112),r=i(97540),s=i(45018);e.exports=async function(e,t,i,a,o,l){const u=r(e,t,i),c=await n(a,u,o);if(c.length!==l)throw new TypeError(`invalid ${e.slice(0,-1)} signing key bit length`);return s(e,[t,c],i)}},29744:(e,t,i)=>{const{createSecretKey:n,KeyObject:r}=i(76417);e.exports=function(e,t){if(t instanceof r||(t=n(t)),"secret"!==t.type||32!==t.symmetricKeySize)throw new TypeError(`${e} secret key must be 32 bytes long symmetric key`);return t}},156:(e,t,i)=>{const{timingSafeEqual:n}=i(76417),r=(e,t)=>{if(e.length===t)return e;const i=Buffer.alloc(t);return e.copy(i),i};e.exports=(e,t)=>{const i=Math.max(e.length,t.length);return n(r(e,i),r(t,i))}},80094:(e,t,i)=>{const{PasetoInvalid:n,PasetoVerificationFailed:r}=i(74485),{decode:s}=i(87536),{verify:a}=i(45112),o=i(97540);e.exports=async function(e,t,i,l,u){if("string"!=typeof t)throw new TypeError("token must be a string");if(t.substr(0,e.length)!==e)throw new n(`token is not a ${e.slice(0,-1)} token`);const{0:c,1:d,length:h}=t.substr(e.length).split(".");if(1!==h&&2!==h)throw new n("token value is not a PASETO formatted value");let p,m;try{m=s(c),p=s(d||"")}catch(e){throw new n("token value is not a PASETO formatted value")}const f=m.slice(0,-l),g=m.slice(-l),y=o(e,f,p);if(!await a(i,y,u,g))throw new r("invalid signature");return{m:f,footer:p.length?p:void 0}}},91144:(e,t,i)=>{const n=i(74485),r=i(37794),s=i(16582),{decode:a}=i(15880);e.exports={decode:a,V1:r,V2:s,errors:n}},34089:(e,t,i)=>{const{decode:n}=i(87536),{"aes-256-ctr-hmac-sha-384-decrypt":r}=i(45112),{PasetoDecryptionFailed:s,PasetoInvalid:a}=i(74485),o=i(88277),l=i(29744).bind(void 0,"v1.local"),u=i(91225),c="v1.local.";e.exports=async function(e,t,{complete:i=!1,buffer:d=!1,...h}={}){if("string"!=typeof e)throw new TypeError("token must be a string, got: "+typeof e);if(t=l(t),e.substr(0,c.length)!==c)throw new a("token is not a v1.local PASETO");const{0:p,1:m="",length:f}=e.substr(c.length).split(".");if(f>2)throw new a("token value is not a PASETO formatted value");const g=n(m),y=n(p),v=t.export(),w=await r(y,g,v);if(!w)throw new s("decryption failed");if(d){if(0!==Object.keys(h).length)throw new TypeError("options cannot contain claims when options.buffer is true");return i?{payload:w,footer:g.length?g:void 0,version:"v2",purpose:"local"}:w}const b=u(w);return o(h,b),i?{payload:b,footer:g.length?g:void 0,version:"v1",purpose:"local"}:b}},15490:(e,t,i)=>{const n=i(25054),r=i(29744).bind(void 0,"v1.local"),s=i(55589),a=i(42447),{"aes-256-ctr-hmac-sha-384-encrypt":o}=i(45112);e.exports=async function(e,t,{footer:i,nonce:l,...u}={}){const c=s(e,u);t=r(t);const d=n(i),h=t.export();return!l&&l||(l=await a(32)),o(c,d,h,l)}},37794:(e,t,i)=>{const n=i(54773),r=i(76331),s=i(15490),a=i(34089),o=i(17053);e.exports={sign:n,verify:r,encrypt:s,decrypt:a,generateKey:o}},17053:(e,t,i)=>{const n=i(76417),{promisify:r}=i(31669),{PasetoNotSupported:s}=i(74485),a=i(42447),o=r(n.generateKeyPair),l=["rsa",{modulusLength:2048}];e.exports=async function(e){switch(e){case"local":return n.createSecretKey(await a(32));case"public":{const{privateKey:e}=await o(...l);return e}default:throw new s("unsupported v1 purpose")}}},54773:(e,t,i)=>{const{constants:{RSA_PKCS1_PSS_PADDING:n,RSA_PSS_SALTLEN_DIGEST:r},createPrivateKey:s,KeyObject:a}=i(76417),o=i(25054),l=i(55589),u=i(69946);e.exports=async function(e,t,{footer:i,...c}={}){const d=l(e,c),h=o(i);return t=function(e){if(e instanceof a||(e=s(e)),"private"!==e.type||"rsa"!==e.asymmetricKeyType)throw new TypeError("v1.public signing key must be a private RSA key");return e}(t),u("v1.public.",d,h,"sha384",{key:t,padding:n,saltLength:r},256)}},76331:(e,t,i)=>{const{constants:{RSA_PKCS1_PSS_PADDING:n,RSA_PSS_SALTLEN_DIGEST:r},createPublicKey:s,KeyObject:a}=i(76417),o=i(88277),l=i(91225),u=i(80094);e.exports=async function(e,t,{complete:i=!1,buffer:c=!1,...d}={}){t=function(e){if(e instanceof a&&"private"!==e.type||(e=s(e)),"public"!==e.type||"rsa"!==e.asymmetricKeyType)throw new TypeError("v1.public verify key must be a public RSA key");return e}(t);const{m:h,footer:p}=await u("v1.public.",e,"sha384",256,{key:t,padding:n,saltLength:r});if(c)return i?{payload:h,footer:p,version:"v2",purpose:"public"}:h;const m=l(h);return o(d,m),i?{payload:m,footer:p,version:"v1",purpose:"public"}:m}},16582:(e,t,i)=>{const n=i(83985),r=i(49172),s=i(42421);e.exports={sign:n,verify:r,generateKey:s}},42421:(e,t,i)=>{const n=i(76417),{promisify:r}=i(31669),{PasetoNotSupported:s}=i(74485),a=r(n.generateKeyPair);e.exports=async function(e){switch(e){case"public":{const{privateKey:e}=await a("ed25519");return e}default:throw new s("unsupported v2 purpose")}}},83985:(e,t,i)=>{const{createPrivateKey:n,KeyObject:r}=i(76417),s=i(25054),a=i(55589),o=i(69946);e.exports=async function(e,t,{footer:i,...l}={}){const u=a(e,l);t=function(e){if(e instanceof r||(e=n(e)),"private"!==e.type||"ed25519"!==e.asymmetricKeyType)throw new TypeError("v2.public signing key must be a private ed25519 key");return e}(t);const c=s(i);return o("v2.public.",u,c,void 0,t,64)}},49172:(e,t,i)=>{const{createPublicKey:n,KeyObject:r}=i(76417),s=i(88277),a=i(91225),o=i(80094);e.exports=async function(e,t,{complete:i=!1,buffer:l=!1,...u}={}){t=function(e){if(e instanceof r&&"private"!==e.type||(e=n(e)),"public"!==e.type||"ed25519"!==e.asymmetricKeyType)throw new TypeError("v2.public verify key must be a public ed25519 key");return e}(t);const{m:c,footer:d}=await o("v2.public.",e,void 0,64,t);if(l)return i?{payload:c,footer:d,version:"v2",purpose:"public"}:c;const h=a(c);return s(u,h),i?{payload:h,footer:d,version:"v2",purpose:"public"}:h}},47977:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.appData=void 0;const n=i(35747),r=i(64298),s=i(85622),a=i(61765),o=i(11944),l=i(11448),u=i(7799),c=i(49379),d=i(76886),h=i(99312);t.appData=l.lazy((()=>{const e=[a.env.PS_CONFIG_DIR,h.isDocker()?"/ps/config":void 0];h.isWin&&(e.push(u.getEnv("APPDATA")),e.push(s.resolve(d.homeDir(),"AppData","Roaming"))),h.isMac&&e.push(s.resolve(d.homeDir(),"Library","Application Support")),!h.isMac&&h.isPosix&&e.push(u.getEnv("XDG_DATA_HOME"),u.getEnv("XDG_CONFIG_HOME"),s.resolve(d.homeDir(),".config"));const t=o.compactBlanks(e);for(const e of t)try{if(n.statSync(e).isDirectory())return e}catch{}for(const e of t)try{return r.mkdirpSync(e),e}catch{console.error("Failed to mkdirp "+e)}throw new Error("Cannot determine appData"+c.FatalErrorFlag)}))},9678:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppName=t.SimpleAppName=void 0;const n=i(11448),r=i(19658);t.SimpleAppName="PhotoStructure",t.AppName=n.lazy((()=>t.SimpleAppName+(r.isProd?"":`-${r.nodeEnv}`)))},13779:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.everyAsync=t.someAsync=t.clusterAsync=t.clusterStrictAsync=t.contextFilter=t.collectBatched=t.batches=t.reverse=t.greatestBy=t.leastBy=t.greatestIndexBy=t.leastIndexBy=t.greatestIndex=t.max=t.leastIndex=t.min=t.ancestry=t.unzip=t.flatZip=t.zip=t.contextAround=t.retainFirstN=t.retainLastN=t.flatMap=t.toMapEntries=t.mapCompact=t.uniqCount=t.partition=t.uniqInPlace=t.removeFirst=t.eqlContents=t.diceCoeff=t.intersection=t.diff=t.moveIndexToEnd=t.moveToEnd=t.remove=t.concat=t.findLastIndex=t.findLast=t.firstNonEmptyThunk=t.firstAsync=t.first=t.anyDefined=t.anyNotDefined=t.allNotBlank=t.allNotDefined=t.mapAll=t.mapAllDefined=t.allDefined=void 0,t.leftPadArray=t.dupes=t.firstIndexNearest=void 0;const n=i(31669),r=i(11944),s=i(39938),a=i(87748),o=i(66776),l=i(75556),u=i(61570),c=i(34601),d=i(8199),h=i(39784),p=i(84593);function m(e){return o.defined(e)&&e.every(o.defined)}function f(e,...t){const i=e.length;return r.filterInPlace(e,(e=>t.every((t=>!p.eql(e,t))))),i!==e.length}t.allDefined=m,t.mapAllDefined=function(e,t){return m(e)?t(e):void 0},t.mapAll=function(e,t){return m(e)?t(e):void 0},t.allNotDefined=function(e){return null==e||e.every((e=>null==e))},t.allNotBlank=function(...e){return null!=e&&e.every(s.notBlank)},t.anyNotDefined=function(e){return null==e||e.some((e=>null==e))},t.anyDefined=function(e){return null!=e&&e.some((e=>null!=e))},t.first=function(e,t){if(null!=e)for(const i of r.compact(e)){const e=t(i);if(null!=e)return e}},t.firstAsync=async function(e,t){if(null!=e){let i=-1;for(const n of e){i++;try{if(null==n)continue;const e=await t(n,i);if(null!=e)return e}catch(e){}}}},t.firstNonEmptyThunk=function(...e){for(const t of e){const e=t();if(r.isNotEmpty(e))return e}},t.findLast=function(e,t){for(let i=e.length-1;i>=0;i--)if(t(e[i]))return e[i]},t.findLastIndex=function(e,t){for(let i=e.length-1;i>=0;i--)if(t(e[i]))return i;return-1},t.concat=function(...e){const t=[];for(const i of e)if(Array.isArray(i))for(const e of i)null!=e&&t.push(e);else null!=i&&t.push(i);return t},t.remove=f,t.moveToEnd=function(e,t){return f(e,t),e.push(t),e},t.moveIndexToEnd=function(e,t){const i=e[t];if(null==i)return e;e.push(i);for(let i=t;i<e.length-1;i++)e[i]=e[i+1];return e.length=e.length-1,e};const g=e=>{if(d.isPrimitive(e))return e;if(Array.isArray(e))return a.stringify(e);if(c.isFunction(e.valueOf))return e.valueOf();throw new Error("Cannot get primitive value for "+n.inspect(e))};function y(e,t,i=g){const n=new Set(t.map(i));return e.filter((e=>n.has(i(e))))}function v(e){if(null==e||0===e.length)return[];const t=e[0],i=e.lastIndexOf(t);return[{t,count:i+1},...v(e.slice(i+1))]}function w(...e){const t=Math.max(...e.map((e=>e.length)));return l.times(t,(t=>e.map((e=>e[t]))))}function b(e){return M(e,(e=>e.valueOf()))}function S(e){return P(e,(e=>e.valueOf()))}function M(e,t){return E(e,t,((e,t)=>d.lt(e,t)))}function P(e,t){return E(e,t,((e,t)=>d.gt(e,t)))}function E(e,t,i){if(r.isEmpty(e))return-1;let n,s=-1;for(let r=0;r<e.length;r++){const a=e[r];if(null!=a){const e=t(a);null!=e&&(null!=n&&!0!==i(e,n)||(s=r,n=e))}}return s}function T(e,t){return t<=0&&(t=1),r.stepRange(0,e.length,t,(i=>e.slice(i,i+t)))}async function x(e,t,i=!1){const n=[];e:for(const r of e){for(const e of n)if(i){if(await C(e,(e=>t(r,e)))){e.push(r);continue e}}else if(await D(e,(e=>t(r,e)))){e.push(r);continue e}n.push([r])}return n}async function D(e,t){if(null!=e)for(let i=0;i<e.length;i++)if(await t(e[i],i))return!0;return!1}async function C(e,t){return r.isEmpty(e)||(await Promise.all(e.map(t))).every((e=>e))}t.diff=function(e,t,i=g){const n=new Set(t.map(i));return e.filter((e=>!n.has(i(e))))},t.intersection=y,t.diceCoeff=function(e,t,i=g){return r.isEmpty(e)&&r.isEmpty(t)?1:2*y(e,t,i).length/(e.length+t.length)},t.eqlContents=function(e,t){return w(r.sort(e),r.sort(t)).every((([e,t])=>e===t))},t.removeFirst=function(e,t){const i=e.findIndex(t);return i>=0?e.splice(i,1)[0]:void 0},t.uniqInPlace=function(e,t=(e=>a.stringify(e))){r.copyArrayTo(r.uniqBy(e,t),e)},t.partition=function(e,t){const i=[],n=[];return e.forEach(((e,r)=>(t(e,r)?i:n).push(e))),[i,n]},t.uniqCount=function(e){return v(e.sort())},t.mapCompact=function(e,t){return r.compact(r.compact(e).map(t))},t.toMapEntries=function(e,t){return new Map(e.map(t).filter(o.defined))},t.flatMap=function(e,t){return e.reduce(((e,i)=>e.concat(...r.compact(t(i)))),[])},t.retainLastN=function(e,t){return e.length>t&&e.splice(0,e.length-t),e},t.retainFirstN=function(e,t){return e.length=Math.min(e.length,t),e},t.contextAround=function(e,t,i,n){const r=e.findIndex(n);if(-1!==r)return{before:0===r?[]:e.slice(Math.max(0,r-t),r),after:r===e.length-1?[]:e.slice(r+1,Math.min(r+1+i,e.length))}},t.zip=w,t.flatZip=function(...e){const t=Math.max(...e.map((e=>e.length))),i=[];return l.times(t,(t=>e.map((e=>i.push(e[t]))))),i},t.unzip=function(e){return[e.map((([e])=>e)),e.map((([,e])=>e))]},t.ancestry=function(e){return l.times(e.length,(t=>e.slice(0,t+1)))},t.min=function(e){return e[b(e)]},t.leastIndex=b,t.max=function(e){return e[S(e)]},t.greatestIndex=S,t.leastIndexBy=M,t.greatestIndexBy=P,t.leastBy=function(e,t){return e[M(e,t)]},t.greatestBy=function(e,t){return e[P(e,t)]},t.reverse=function(e){const t=[];for(let i=e.length-1;i>=0;i--)t.push(e[i]);return t},t.batches=T,t.collectBatched=function(e,t,i){const n=[];for(const s of T(h.toA(e),t))n.push(...r.compact(i(r.compact(s))));return n},t.contextFilter=function(e,t){let i;return e.filter(((e,n)=>u.tap(t(e,n,i),(t=>{t&&(i=e)}))))},t.clusterStrictAsync=async function(e,t){return x(e,t,!0)},t.clusterAsync=x,t.someAsync=D,t.everyAsync=C,t.firstIndexNearest=function({arr:e,fromIndex:t,pred:i,maxDelta:n}){for(let r=1;r<Math.min(n+1,e.length);r++){{const n=t-r;if(n>=0&&!0===o.map(e[n],(e=>i(e,n))))return n}{const n=t+r;if(n<e.length&&i(e[n],n))return n}}},t.dupes=function(e){const t=new Map;for(const i of e)null!=i&&t.set(i,o.mapOr(t.get(i),(e=>e+1),1));return h.toA(t.entries()).filter((([,e])=>e>1))},t.leftPadArray=function(e,t,i){return e.length<t&&e.unshift(...l.times(t-e.length,(()=>i))),e}},13056:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BatchClusterObserver=void 0;const r=n(i(61765)),s=i(88491),a=i(66776),o=i(36079),l=i(95557),u=i(69317),c=i(10408),d=i(49379),h=i(92661),p=i(4437),m=i(53719);class f extends l.EndableWrapper{constructor(e,t,i=o.EndableRanks.service,n=!1){super(e,(()=>this.t.end()),i,(()=>this.t.ended),"sync-file"===e?m.CmdTimeoutMs:s.secondMs),this.name=e,this.t=t,t.on("childStart",(i=>{this.logger.info("Started child process "+e+":"+i.pid),p.renice(i.pid).catch((t=>this.onError("renice failed for "+e,t))),n&&i.on("exit",(()=>u.endProcess(i,5*s.secondMs))),h.addPid({pid:i.pid,ppid:r.default.pid,cmd:e,maxAgeMs:t.options.maxProcAgeMillis+s.minuteMs},new Date).catch((t=>this.onError("addPid failed for "+e,t)))})),t.on("startError",(e=>{this.lastStartError=e,this.onError("failed to start",e)})),t.on("taskError",((e,t)=>{this.lastTaskError=e,this.onError("failed to run "+a.map(t,(e=>e.command)),e)})),t.on("internalError",(e=>{this.lastInternalError=e,this.onError("internal error",e)})),t.on("endError",(e=>{this.logger.error("observeBatchCluster.endError()",e)}))}onError(e,t){this.t.ended||o.ending()||d.isIgnorableError(t)?this.logger.warn("onError() (ending or ignorable): "+e,t):c.onError(this.name+": "+e,t)}}t.BatchClusterObserver=f},96979:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedGreatestList=void 0;const n=i(8199),r=i(13779),s=i(25883);t.BoundedGreatestList=class{constructor(e,t){this.maxLength=e,this.toValue=t,this.sortedArray=new s.SortedArray(t)}toArray(){return this.sortedArray.store}vacuum(){return this.sortedArray.length>this.maxLength&&r.retainLastN(this.sortedArray.store,this.maxLength),this.toArray()}get min(){return this.sortedArray.length>=this.maxLength?this.toValue(this.sortedArray[0]):void 0}add(...e){const t=this.min;for(const i of e)if(null!=i){const e=this.toValue(i);null!=e&&(n.lte(e,t)||this.sortedArray.add(i))}this.sortedArray.length>=2*this.maxLength&&this.vacuum()}}},24945:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedList=void 0;const n=i(75556);class r{constructor(e){if(this.maxLength=e,this._length=0,this._firstIndex=0,e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...n.times(e,(()=>null)))}mapIndex(e,t){var i;return(e=null!==(i=Math.trunc(e))&&void 0!==i?i:0)<0&&(e+=this._length),e<0||e>this._length-1?void 0:t((e+this._firstIndex+this.maxLength)%this.maxLength)}item(e){return this.mapIndex(e,(e=>this.store[e]))}set(e,t){return this.mapIndex(e,(e=>this.store[e]=t))}get length(){return this._length}set length(e){this._length=n.clamp(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){const e=this;return function*(){for(let t=0;t<e.length;t++)yield e.mapIndex(t,(t=>e.store[t]))}()}push(...e){for(const t of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,(e=>{this.store[e]=t}));return this._length}pop(){return this.mapIndex(this._length-1,(e=>(this._length--,this.store[e])))}unshift(...e){for(const t of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,(e=>{this.store[e]=t,this._firstIndex=e}));return this._length}shift(){return this.mapIndex(0,(e=>(this._firstIndex++,this._length--,this.store[e])))}shiftOrFirst(){return this.length>1?this.shift():this.item(0)}every(e){for(let t=0;t<this._length;t++)if(!e(this.item(t),t))return!1;return!0}some(e){for(let t=0;t<this._length;t++)if(e(this.item(t),t))return!0;return!1}forEach(e){for(let t=0;t<this._length;t++)e(this.item(t),t)}map(e){const t=[];for(let i=0;i<this._length;i++)t.push(e(this.item(i),i));return t}reduce(e,t){let i=t;for(let t=0;t<this._length;t++)i=e(i,this.item(t),t);return i}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,(t=>{this.mapIndex(this._length-1-e,(e=>{const i=this.store[e];this.store[e]=this.store[t],this.store[t]=i}))}));return this}toA(){return[...this]}slice(e,t){return[...this].slice(e,t)}}t.BoundedList=r},71817:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bufferStartsWith=t.bufferToString=t.debom=void 0;const i=[{bom:[239,187,191],encoding:"utf8"},{bom:[255,254],encoding:"utf16le"}];function n(e){for(const{bom:t,encoding:n}of i)if(r(e,t))return e.slice(t.length).toString(n)}function r(e,t){return t.every(((t,i)=>e[i]===t))}t.debom=n,t.bufferToString=function(e){var t;return null!==(t=n(e))&&void 0!==t?t:e.toString()},t.bufferStartsWith=r},28801:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cacheDir=void 0;const n=i(88491),r=i(11448),s=i(10408),a=i(49379),o=i(98250),l=i(43414),u=r.lazy((()=>{l.Settings.cacheDir.addListener((()=>t.cacheDir.unset()))}));t.cacheDir=r.lazy((()=>{try{u();const e=o.PosixFile.for(l.Settings.cacheDir.valueOrDefault);return e.mkNoMedia_(),e}catch(e){throw s.onError("Failed to set up cacheDir"+a.FatalErrorFlag,e),e}}),n.minuteMs)},26302:(e,t)=>{"use strict";function i(e,t){return i=>`[${e}m${i}[${t}m`}Object.defineProperty(t,"__esModule",{value:!0}),t.bgWhite=t.bgCyanBright=t.bgMagentaBright=t.bgBlueBright=t.bgYellowBright=t.bgGreenBright=t.bgRedBright=t.bgDarkGrey=t.bgLightGrey=t.bgCyan=t.bgMagenta=t.bgBlue=t.bgYellow=t.bgGreen=t.bgRed=t.bgBlack=t.white=t.cyanBright=t.magentaBright=t.blueBright=t.yellowBright=t.greenBright=t.redBright=t.darkGrey=t.lightGrey=t.cyan=t.magenta=t.blue=t.yellow=t.green=t.red=t.black=void 0,t.black=i(30,39),t.red=i(31,39),t.green=i(32,39),t.yellow=i(33,39),t.blue=i(34,39),t.magenta=i(35,39),t.cyan=i(36,39),t.lightGrey=i(37,39),t.darkGrey=i(90,39),t.redBright=i(91,39),t.greenBright=i(92,39),t.yellowBright=i(93,39),t.blueBright=i(94,39),t.magentaBright=i(95,39),t.cyanBright=i(96,39),t.white=i(97,39),t.bgBlack=i(40,49),t.bgRed=i(41,49),t.bgGreen=i(42,49),t.bgYellow=i(43,49),t.bgBlue=i(44,49),t.bgMagenta=i(45,49),t.bgCyan=i(46,49),t.bgLightGrey=i(47,49),t.bgDarkGrey=i(100,49),t.bgRedBright=i(101,49),t.bgGreenBright=i(102,49),t.bgYellowBright=i(103,49),t.bgBlueBright=i(104,49),t.bgMagentaBright=i(105,49),t.bgCyanBright=i(106,49),t.bgWhite=i(107,49)},94383:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CountingSet=void 0;const n=i(11944),r=i(66776),s=i(75556),a=i(61570),o=i(60346);t.CountingSet=class{constructor(){this.m=new Map}incr(e,t=1){const i=this.get(e)+t;return 0===i?this.m.delete(e):this.m.set(e,i),this}get(e){return r.orElse(this.m.get(e),(()=>0))}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){const e=new o.Average(0);for(const t of this.keys()){if(!s.isNumber(t))return;e.push(t)}return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){const e=this.keyAvg();return n.sortBy([...this.entries()],(([t,i])=>[-i,s.mapNumericOr(e,(e=>Math.abs(t-e)),0)]))}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map((e=>e[0]))}get averageCounts(){return a.tap(new o.Average(this.size),(e=>[...this.m.values()].forEach((t=>e.push(t)))))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return n.sort([...this.keys()]).map((e=>e+" "+this.get(e))).join("\n")}}},93491:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.decuss=t.isCussy=t.getCuss=void 0;const n=i(11448),r=i(3236),s=i(7084),a=i(12651),o=i(91464),l=n.lazy((()=>u(r.CussWords())));function u(e){const t=new a.MultiMap,i=[];for(const n of e)n.length<3?i.push(n):t.add(n.slice(0,3),n);return{trie:t,small:i}}function c(e,t){const i=o.stripEmoji(o.stripDiacritics(e.toLowerCase().normalize())),{small:n,trie:r}=null==t?l():u(t);for(const e of[i.replace(/[^a-z]/gi,""),...s.unl33t(i)]){const t=n.find((t=>e.includes(t)));if(null!=t)return t;for(let t=0;t<e.length-2;t++){const i=r.get(e.substr(t,3));if(null!=i){const n=e.substr(t),r=i.find((e=>n.startsWith(e)));if(null!=r)return r}}}}function d(e){return null!=c(e)}t.getCuss=c,t.isCussy=d,t.decuss=function(e){let t=10,i="";do{i=e()}while(t-- >0&&d(i.replace(/[^a-z]/gi,"")));return i}},3236:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CussWords=void 0;const n=i(11448),r=i(48446);t.CussWords=n.lazy((()=>r.gz64decodeString("H4sIAAAAAAAAA1WcgZarLM+Fb8ibQkWlInhA2rFX/+8nOPN+/1qnAa1jEUKydxLP0oZPGj7n4OY6uENtyoMrTh8dV/Wr2msbXPsZ3Pc7jC4O4/gZxmkbRq/jOA1jzsPYDn2KPvcw3vswuTpMk9p4DdOhflY/H/okfX6GqUV9dHxPw6zrZh+HOfwM86Hjaxq8L4MvefDvOCxu1Sfp829Y5nNY/D4sYdFH7a6P7r1c57C6a1iDPnnWJw7rfQ6bjjf1t/YaXu4cXmHV5zu8Sht2/e3e+Bz6FH2uYf+4IWrsUc8Wz2uIGuex5OEIdTjyMiT9fQrnkPKozzSk6xhyOYbTNX3u4dSYTl17akynnvfU3Jz51Ocazn9lOEsazjbrE/S5h3//gj5tKG7Upw4lv4eiOS9vN9R5H6r/GeoW9LmGqntX/W79F4d6L8M1HsOl57s+19A0h+/5GD66zyev+pzDR+v4qX74XMvw8/Mz3GEe7tyGr5v02YevXwfn0jy4UMLgXk5LfEwrYpfYpQVJy60r6GnSXGrShvTV4XmqVw6URb/g6qhzFd259NCuoTEf/vbmi7t4KU5ZJL5SkblKV/zlJD7jMAZUKaw6DJeuCz/q5VEqlSdEWofx4pIW9W3jsF1SKjc5iRVROPxIwTZpgMRbQjowbW1F6Fw4dV3UXE2Jw4xm5qhz2fTxvCWk7VORikyNO7eUENcwuzVLHEk6Ss9XaWhAZcPuJZJ6L2nCHDmXpyrhERrpnE9dUqR/Eucwt2OU0Fjmt+Z0vnUDP2tU/kdicR4dLyh73RBfCenBMklJFz8h/Cy11/gWRrAwa0vQvCxBv7YEPcwS9IBLlNotKd3aG/ohCV2SpZKrn4KElHv1h5NIOgyn9o59m6Uxa9YqSLRhLbkOaxsR2oqbewUJjX5zZZb46NA79fzoJfwoESOCfaef3LIrElrLLXt6mpctH3xxcK7Qk+pJ7BJVW/XSPt4aX3y0m8L+8UM4tCghaRO+GPgrSH20hdXLGtorhzS8qp789daC7m5ESHN2F0cJqcXOQu0pa4ez8HvWqu4s/M5y7yzy3moYdtYjeg03opORP4vhuCXe6mU9auQGkTmVaBILPelfzFzStJli03McTsp/uIDQPEvIfLjkJaoOfVtkUXQrCWzLCxF1LmtbHnm/JaLO5eQQq4Sm5MjVhG7VFl3c+JbRH+2qQ3IaeOLJkzsOiW8YkpepTF47OfmPLvE/15BWKU3KGkuqy2dITQuVmtYtR81fPrRkuegSiVviyoMWRsaKJzrd6iVeTmLnnAZ5et1Agl6kl0zoWy9VOX15D+cmBZb4J9Mo3T156DNwF578DPI7Z0gc8rfhNKEbBBlpGVNZ03Bxnbb9yQY7s8eiau7PvGFjNc8nC3rmMiHoaRXOEnRYZAokdO7adNikrGfbEXres3H7VmW528XhxRf6tX//5HH+tXDILGuk0hQ/FO8viUJP+7JkGfXy1q6tTHt1UoE6yQRVr/mTWCVkE+smB1axTRXbJPHFpiNkFCpWr6LoNer2NWr/1kOmuR7aC/XgMMmCVHSjoms1y0nVU1a8aioRK0Jf/PObRNO3hW8LP3khmla1Ytck9ENNq1Wb1KLeSdd99e0lTyAhvbrcWiWkdRf7/PJObsb7BfGV0LNd/mwSmuLLt3G4Ns3BxQpeeUScCHnUq4Qs0fxwXXrKq3G/jwbUxnwPLeqx2qGRNia7VdmI1qZzeHtd/F5ljN5hLBLexGd4Z7mwNwbqfWmkHwYpsQ8ff8nvMacf5vQTXvo2SEU/rO+P/NjwwxT/ZC3yzV/cLgd5wPEevkE75RvDOHwPje+b9ZNffuPL/LlxbJMklhfJmdyQDcc3Y/bcfMgIubktOrM6qZXbPCAqsvld9Fo0F89N/SNqruVML3OpuMn01dPJ6gf9bTFnel0umLzlOh3X33pIOc91i0hZ5dGFaj5V3nbURSuy4FFnrtTK0G/63TEs+M1w4FGDOdLAWowxa5nHzBRK6sHlbzedzyt3kDEw56uxSX45b/fM5oWL18xIWp99oznakKusObLhqWfO1EuAsH0Tfnoyl82VSC+5FORq3664YrdJgSZfa5feZDCZce2y6ZI4/C14b7IgE94fCy2Z+ZaFlu+XbZqC9QPbHRlM6m7Ra26niFWd8sp98sY9M9ZG8MCgQY5gg8IIJTmPxZ3ynQG1X2GhqWDUJKVpU8U+CUHIHkzNmyzat1P7OlAEWjG7IgM/exeFEvwo2yUppDKHqG05h6JnnzPrNecsIDAXtwiGFMzfXL7atXNj9gQkZN29zafWQ27VT5qJwctvRYHnIofnZQ10XgZc8sIIetkrsEbUPCAzUjMg4KGVWtzlgB6XZluIQyZ/8VE6s9iKLLYii63IYisiGLKBPlaTeeGMXaPBOpPqy6zpfMS0LtIrZJLDWjSfASn4vWS7Ml9fZJMbWIqTaVpKBrBo/yakXO7q8Ear0KVAvi8y5mtI3zysESS7Jimo0AtjWO2ea8a6rdJVXVOC9q9gjayIpCy6ZDvBONK6teH6JWXW1jufIJ7ZIM+ry6+wjcsav6CPoPqmpRMW8lXPvoWXtF1S67vlpPUVpknIasDnLc3ZTB82GSSd/wSt2nYfWpcwS0EFcGZBfUmtUUivJlmZ25d76a8kd+Qui/mSUUFe0oSXH2U+kRdS8PzlP7JUr81plV/CfUVy00hemRV85RZ0pq3a+6927Q3UJPchxAQUcpMMuSR4yS26chdm0RmfZPR3X+Rx93BI0/bAM+4xy3/vec8gKDRqt10vNKXV320O97ucUKoxmIReadslSZ4uyptEySLNj74a9Do0ZiS465BXi2a14rFoBwl/cX1eDHctC7BM6z9Em+eYmwOKNWlybKPWIjZmIDZsmhRwNyimO0tqniVl94R4Ns5fL+DZlfj20u4+tFzIOYDYsAYa2exM6soViyGpXSbrr/mRFLk6hBCBb+kCunUAdxpuY/dJNvpY0cOsh0agMUsytoqlEriThh+N9UJ6k/1MBusx2nZdXW5Cem6/QH4mg0aY3D/NkqSsR/KMU7I4k95kMJnBhrLVyZ4laS/rDhlYmWwPiitpBzHNwoQvnLIcgn5RNIF+YW6F33W90C9Izs0AQjm8hAQNmp05XQLduQTMkmLamYt+Wbm+7nwryAGOhED7bQdOhg4qD2BkhEB7/OMpBoa89OuSbZP8Au9k80GJ6LDkZkAz2Jlq/QaQjBFMyXpJ2vUnMFUS1FmAhOFH9vMMX83kKatSkbeujE2aLwDKnc1XIqH32nmS8U2/aJ7PAgo8iwdban7ow1nPliZoP7/4L9yytP8iLEo22i1I+RFJb33pyb+GPsgQzmHA5aov44485ZV0e+BosPNSqCqZ+Pa9yQaWd93XodxoUXVgkurmUJHCDNVxfXV4mar7c6aADG0VtA/1FEh9O0EUkd5kMMn5Azyq07ren9rpGo1sqdCtdKya/60BW6fVlXeuO9ip7iAfJEjXAHOEfYu/SberXDf9AlDNNp5cQdb5KsKvmr4dPCsOIrkjoUVCGBFMiw2vDW1EcibKMlR5SdCtUIxk7xc90SUitprckVp9AWX71pCqZJD8AdN6VlzgVz5L6FfrrusMBNt9JDmveyAvZ5Jr5KQl8fvCx5q9y7TlEnm8JaMw3pXRw0sYoyKrQWchej3WDG4munEVyKKAtHa0HHhwJj0yWj9yZf5Rv1UgfKvbjaxC6B9w0fUBsbSdCITMs7RLF2rkb8Njb4d9e7tFd3uLzXeZJXnGd7Azwc6I0iOvqyHlod4Z+/xuUWQI6QXGsaKfjQDGJ8A0P9px9/ApsJzbr+Imt8f63WFZhL1luxwwnHBUwEogBb21H/Wt7SYxejaqRst+ctr9V6FZp0ONRiNgfmiAoGih4xsYTZRCjR60NwSm1BG4ftMRohbAB0aPhJHUEP1Rf5cGj4B64HbCvqkxEOzqV5ZpdF+o2eidnaQRvPWykKDufbdGahd6o3t6w/dC5E2mbhSi0FxZ42nSqisFEgRm5CA7Ol8MsMec5xtMboGyvATD4xtbYMy259WgAoLq0LlRiDEA3GtH8WqA9yJ5/EHj2eUQE3eR9QbQyzDx7KJoxNkEX3sDVB+LWTlruDInOzKnM8ojidML8dvImvkOMD/P3naRSVA/js8a3xs95t2f7441APc1jGyNwX67mTUQAgEQoXEX58YlUSZdDCATWZjWwGNqdJpsmrTSeKMWWwD10LwhC+KOxhCMatAE4wvNCMPirDmssZ0Jczi5Mp/GKcwFikIYX9lav0vrd2nAHzUnf66tKcMqV4PHU1NPyEUAZ6uxk/mFL4NNBI6KMRI1X4s5Tjv8weNUp2LYdSrNnqg8TKKTJqEb39kFg7jtZ2e3AZhmd7AX4RbSSBr90Iyai0CEedYg5rwClWT+XW8OC1Nm/SNQySTPRexPJ0sFKs23X7R352/46Mgn6aUYhSZcoEm7kFCElqu6Uc32gXO0hNHzPyffLQy6ENbUxlVzBN1MdOIyPnHghkQc0BApN6ZXBMJYQKj9SCZ4FW+wJdZA5tCbG4owhx7XZFohFfkDkxDkpyn8rFBg6TRCG2/pOi+6Cde0hiOt0QzHqEYyRnyi8CjGaBVAlPFYt043BAykpuIYws8iGSHLJq9ZCv1jjbGNXeAX0sEsrdlckBpjIsXZkUjIZiyEIa19Ga1p0A6s4tpkZIm3Hizq+nFs+/XjaTbntp3g6w2a3UbvjX4kogUbxIGQ6kwcQQxkNdqRUAYaO5l3O1mwWSIjbz3RJqypk0Hm5tMGEcdbrl2bYtUgwmHLKCsBIwpJKyiyoqELU4VUvX1X+3dvzHsAPZxqqjiUCIqtw8u9CXlAUWAh/kPkB5JSjYFUUZCdiEqEcQA0aUJvCjQkyuH3ZldzMJECFM4oStKP0FwQEH6PS65qVOYDQ9xlIPxXdMWslPjKBZ0Ra0nwFvHJgyAw4dO9LZgE6EpnKu4jEgEYKMZMIBli0DRh2g8jHsSBorb0BRnpDISFI+g7Nv3C4aYAxHcB/CXWRgzw0DwQ5VWTaSx6oCZbdLhgKtU0QsLONsIBLhnVNP1Tc2Mn1IzGSI6RS3wCddFAC2ieo9Ab3cxfiZ+Vw+TKoCnXn4fOaMLL/TZEor+EKY7dNU7mMRhZmdAlmmBHMldq5rBwUhAv0kR/QG6M6ZQ5yWEeugdx7ha1PaAw6DwchlF/W1ob/EX7UI1I8Q6DgSAkQdMIkynAjeQbrlU3PDRnKQgei6/ETluicbCUxf1XNZlx0micCQKWiHHblW0OwpepRVkmNRVHlO5DxAFiY8wmRRRM+IschAy0QOcgYy341RtdeflRdjdfwqYQmbkZ59l3sn4uEY+C0eROaWA23tyZqI2z+LjXPyM3jpMpfzk6vV0pSiWaEPxCfDoI4ENlXqc1Bw7lDKZg4i5GQIIckAXKs8XVv/3PvzPx9uxH/k4YYeJIakuQe4zExMXxtBuLdnSx2Dbpo+KnS/uheDkLjmZCxUVsRIOXwQRYFw99piHdIRqCgShy3fJjapp4veDqLLNd+o4r4Xi5jzV5HEoVLoSsyDFMagwvQVqkGgJpogVD+cq6TcZVLKS+oJjWcBSlkjTYeTW468oz0DT2CpzloS7GXTYfoC1beF000TcasV6avHCyhNOa7HpDNJ4m9AZeI2q0qZnQierNZVmjS3zUrEF6NmLyss3ejm5jP3IUyRp4EZyzQHpgvrAehkujo2TQqOZJWIKGJa5yzEdnQ3ayAI2qNhe06DTuUetGsLBKE6WKlfgeAf92Bs1SK29u/XH4xnrLlBxE+l9wGVzdpWbbLOhvMyji54z5mGZJ1wGsF4/pegOniYm/0+U1GwvqZEhLCNPBXFgD4wGBDFeQFp2kBtgBVyhYKTWYvCsbgxcT4sFEeS4SBqAfmst+Vs5baiqrSxTz6qBUjZAuTYP0CCTI2aB6MjrtnHmGpn2jcb6dKa01HkKDsRKX6YkFVwQr3iHsmro3SLqIz6x6QjU3IFENZuZt+2n4iBNIl9Ton1iN4DWNDMtlTEdXQnW4hFhCGj5yrXCh9v3q5I/mTA/943+sIYAyD7eTs4EWjW+hLnGhWX/wdRbNowmcjOSLv+5gOb6y2qMuIcSbelPElVZSf1AmWFQLK999HEokdjOyg9wiN6HTTgTs1kQ5ELNWzb38lqQt7p8v/xoMSsPcyOpf0K7B1Z/2JfMheBfdv8H98DizEaf8hjIJL05kIsJlZMSBQ+BJaSUaqScpRgXMkXprf4+NG8hyZPFnmNTojFhdeVlgT5GcGi0YjZa9qKfYsalkOGDEUCijUgEjRKslIKMRs/5V2g+WZ4xN3PMg02FqCoWaQ7Y8ByaQlnystZdlPiYiw2pn4g1qg7Pz0kSyJ7IvwcoTpK/QIKiVfygWfEjusQpVjFd3u6OMIn5iFMpAX8dm8AjCtANlyJa0ni/p9/u6b3zyJGC/yR1gULXibJYzoQ1Py/fJ8zwTkTajUMmcf285f14973K2aPfTppW/mzQdWMoJU26trMbLGbGa3G1tkh6B5PVoanVHoz7kGox5mV7DuYhqkYkhUUy7doZlmB5u1a+nNQY1O2otxKQs8wKVmsnPiCgzPv250T35tWC5lxesgFZqQ+ZF3MfyM3qaxff2sHqOPdj3p7/se3mu1ShXasbA1F7PMfNjrZ23iO0kJWNdtPgPcWsWMSTfE+2+d/99WWPovRG07eFrPBe0jftY65/29zxMrv89zMyomV8dzz97UQoZFIF/bZibXJBFo7SmqCotS6y2TmQ056P70DmH1a7LUdTZskRmQOdyb+2wihNxD/E7uS4isb3NkLkcpEeCFG00VofRI180GTfVMFrUeEXlIjE2/5Wdo+zKwXYtWxSqJ3fU93FvyQpFBg6xW3tJivZpMhZ3UP2xxGBOv7ewNPmEXpxysU/JA5FP7K1/2vC0UL1WxmDsTpaqszxsNa1uZbTNeJuc2dlzRgI3mXYlJ7HiyskHkTk9Ob71fLN4XrvZH2vs87fmbPttZZ9rnQX1yyxnvpKLgx6yv2FTMj+MexPUB9oY5SpUuQhHWFu9fZ8vbTnK0FavuRpYHOZla8TS3RAsgpHEuUY/hQjb8mQbxawyxPwlDIddfMn+WRsOTe1mmRyKMPZnXxvt+QayNFLHSp5GbLbBfHIw6pMyOY8910z8lpbnibKGlH9Et4FyjfE4ozxq797itAnFiPMN4Bb2tcxrDGRhpEU8p6Zhs5yH8FqydrXg3eG2hxHFOdhxtP15gDZc7Wzolw6RdQFqu81yLcEIDtPvntZbm//a0NvqnvY5X3/Pw35KbF/aWrHnokHFCnOgdFMld4MJe9qH4HCci/mh47EHR2HFKcCBGpKNAS2JWriXeNlXbb3ujbxKsfv1lpzL9aHIyUiH7KuMTjVYLgcMtCVPwvh76582PK1934pdl8xvkEvBzpFHoUTslPVlPnobjHoQQDIKslmbqdvrLYSj708BldkyNzIEvXpH8HK0drdj7PNOWSMTCcWQe7XMSvdDJ8guwk5kmGvPpuTkntY/bbAMCsT/jE2/SwVPsdj3mdtKJPVkPwdrL/b1KYoR5K9P7JnlUsLbwV9oKdEp2VCS2hcAXNqfidj3NkNwNt/recC1T0tGxWmLk2UJRmT/Nd0ubqJAU6iWazms5qG4700pi7Z5AX+IDSUK8NSKpSTLwDD/xf+zfLGgZaSGQkTnMC6lRWR/iONoP8zkZ9gZZGXOQubC7YL5IiOOFYLaaHynM45CvVeVA7M8Ci1cwtqHkmheKjl47R/ZnEiWwFpKRjfBVGC/iA/rrpatBu04O+HwB+AU4sH4oRydbKDB1TIwdv4k7kVtkQwH+RZNmPGWy5neqE2A1XphuGlFIhkPcE961lv/tA830f7T7hDCoPiIWA8s5TQOWd85ZijQJxgeIF9D+PVySyDjTuam52XO57gIgt5kbsRr1PrDYycgI52wlNIZS7GICjmZYMcdf/ZWx4SZpEcX3n8iO3NGIlPGPCzLoo3mrJAJhafVBT+Wg+kMhdY/bWclD0lp4s/iJaP5kasZ4lEr4t0roaweQrAAjynispofbKfUq0BdgE/e8iwEIGnVGz4OIjeLhkSzO2oXrvtsPWb+2R4q8vnM6M2PlKJO8IeRJACZFi+s8bQiDSu42FvWhef5Sh+Y36/suxCw2o53xSq0hSkT94uX5olQWKBaDCFCUMjPaJwWl9HCeCvG6OQgOKtWgnJ2WlCsfqlQuQBRKN9saYXe8b+d8NvJRhIScekRUG2w3/OVnbkfgB3W0QIdQvrHuVsmBERG4qF3AOvSEnLTQvmdZ2pOJge3RNsCQUgD8Ib4DclbRbsgqHGb3jEQ71ArQ/P9hgbn7Yx4PgoEkGcNyXAYputQ/hg7pu8gU4j37XsFVCbMSq7D8bR0ZHacJUFIJNhXHZpMEDuR5wGAKXxiIJ1VcobKtw7HZayITlouxPU0iKW+fjt/Z8JvxzImS0FLn07ucP4w3E/HpwfY21ctdagt6N6xdpgm2xRPx/929BOk0e0+1uE+uQ+WyqvY/6p3/s4AziM/VXvn2+F+MGXruD48QDvNVmf19tWyJDJKlhLxgs4GjmUTDe1IecXr7AwFGtap2ngTAFsLSPWXkDbpYwqxTkwgdd6Xs1yeQLZ8mB+p7RYqoRgckENeYj7ddGGQ5/IgBaqzrEDOr9uTJDmOHlsR5vCGChaxXQHy+sDmYKmMsOJIAcT1sjxGGa18glIorNhvh6QG+0TWGHTL1hpWH2KifgCjI6ZAXbcmytWDxMTbQgArLtdqvAspSktIPGNemwNOud/O3xnSFIEEKmmLUowKrxT5FKuGGt1muYiMcymX5RgCbhHYuzGHwrPBAO3LhUiwYNh9ZUJ2KyWyOPf+qyT7r5KAWuVgVgqKnPlndfxO2JaOzAZVRkXG8QYyLrtMVezh9h5Nt06wmp/YgHFO4KXH1BMeziLuVwA5HyLcmRLBQ4tSLGbtheY+niB7mi0aJrQo8GYV20whofbeIaAuAk+dxkEQz6Bo7/jfzt9XoEmxfgodD0g3yaBD1kxbfhkOYv1sz9SOMVldN5ARbprjlmdAg1SX8tJ1yCcLrhHmE1WwzhdGlKjZFkKKhKuJX2nCT9JxVrsiLGnOQ+Cxz6FQY7DApzDHbLMB+CAtaiU6jcVV50pQmtPJaaAAp58o/ukh7bqdnwdF8hO9k61iR34jWOftrKpHyJfIsvDHWb73BKbUhC8dVIYHVU6W4n46f2fCbyf3gLZB4Jxu4CWY8Q2LFtiD5GnmKQMovCNRKOc4HXhuDsS5LaBtWqftpztwsW+XGXP5p1tzdKhDucTt6ZwPnEtaOfGj3mm1R6FBfhWeQylj7bEQiyL7j4El49SgMDBrvakNl5EDZ1pQmaQEOfVAnrQaUlkrkC71Ohz55nrvvP9TeujUgsgMrKb8MTdqwWIrremd8HS+FjLG2CQwnZSVQiCix0TbeHI2KKU14OPQcd6XeHPvgOAC7hPoVjo2M/NIsKk27d0qdljf8khWckPViFXgfPDUu4WaXUlu+u3sHdr1EDMsvIecr9y+hupi72A0ZOrpFFsC65CXuLbiPe+GCAiMzVvNeRK8otCc1GYoFjeW46eAvcjBgp8uUHw/I0mEzsLIFo62zuV+O39nwm/HCmw6z+u4DeA2xlsech9EAKGyhxXJmDl9SytP33Z1mC/NvIWXKVAxGMeO+/hrLhTWf+VeJ0zTl1osyrG+jZCnzlAjIuNERfiyiHcxNLfoSSyC4uLiLRFGHTkxT17NKjbg2f31gGXCaxYDBDC/WrBo7ey0O63ypfeyITKyqhZrdV8bd4+yWpyUgEbihRihKc07znjM1TAT58gFyBSBo4SnDephQw+rKzckZdCuY6rqn/ioRWath9kf20VVhgGjqNlgVqwXZuq65YNHi1lNQPJ48IKht3htsrhl0s6I+YlEGqB4ev6v17GOwdQH9aQOcpwW78gdyhSLK+pn5/AGbhV8WKGm3IAFW2qmIqz0uJ0himaQwtfZtx964bBakNmfsnTRrtMWsZQPET2bVnoi9cFqvrP5Kgow3EoFYOo9kg6Df7m9WVRNatHWZlUYFWZk534mfxr0WNwkTC9DRT1FEES2qutwafhE3DqOoP5ZT028jlrqbzLTb3GuRgGrvHkot9kUUcpFqyON2OQTRqvj2gDkF7Ox5c+V98D7Xk2rV6+fawhj0npt5YlnNWqHBXmD5ZuEAeS2gMxEtTy1e3UIPa+g6165uYjCW/3xp5XaMcK+WeI/UIClHx92ia2922y91GuVqagM/FqPT7HR+9Siu4co6/SBkPRJ7ucirmE2SLD22PYBzDJQSfTpzNXiU2LrhrFIxruxp97r1SAgwgPrDFg1rHD5qefZ5UKncD0xKItik18jzuSf+JJFyJ7ef+cACLP8+kVFsb64KaI0ZFBJv1gO/U08lfy5VIIaBvVCf3JS5JT5l4GUd7D9my0jzJrnShiJN9PydchuUYiQr/YdQ5ksyvQS/DAvn6SvaIQwgTgeLoWeMEHqPSoMAAH1cA9kkFHLVknrXZv9V3taOhiIrPknbhT99NsLT0+uhZ5Yp0G1Uyu1U5KCX7eNQmyoXOBhojljmKwK7LylhYYjtEswMcRULEZzFSpiZQJgVX89vj3k5piN0h2Zfu23Jz+eR3C2dLfkvHUqWcl8zUTpqpiBVILEaU9gkWXVjeP9wXtOuHlmzfLMRs5w/v63J+JFZZB6H/W+TzTnMA/+9MggJ+5tmeX0iwq2Enp8uIaf/o/edSdzsru0lDJBcMA4Wvz4t5eJ8HjqKfW3MYjqX6SgzT9YPKn37C96779z4a+nu5zieZNl1E9MCG8yWozntEQ8YZAptpFkM+Ua4JY2kksfqbtldh2Vwu13xklDx/yxyM4ZXhcZ+B7DseytcLv0VHvavHvlFVH1srOdJ6N7eqt8o162+f6eWVq/2XcXn2rsbltGYubt0O63se1XO87ucc1zE5x+Yi6M6rcXBilTuKxyspWsZ49WE7tSxkPlq+a0SkHq8L6p0dDOHG7+8oPf+roXqdqLatYKGdVcqVdA19MgVuF5O4pq1t87uyX6sSdkccpdt4huyP4J9RDWgGI+PngRCqwQG/kNgrIWLdGM6cl30UoLgTxdcceSuquNTSipl5LyzgSI0f2GQtCEv274r0uIpJDxJHBhRaNPREfsB7huhZ5ybNebdZa/njaCPdVCGo33fNxvVKJHBuAbp71BZd7WKomMEFbLttqvimLNvscVWJ51mGSToifT8bhhi2hZ5OCT/4II6loY4R/UFZgxoeDQRmIBf5Bo9u7sqkQ8wK25dXfs/zu72qV21tw10R+wMwnUnH67hf+cQDqwGikdQAATuLXKKwv8NPthvEAhZu2tQDIKB4juYQmjW7x56wv/JMJBCaRujAoa2dfXJHToMjfkoKQEWVoODdfj8EpDqPLUSb7ab55KwGlfir2TJXvO+zc4AlHxN/e6eDv7ndPeeLd5a6HyyhnvA0lzb+lX4wWhJkxudTS7lx6KfMgUin/L7eXOwP9mff9v1vf/5tfq5QgNkzs6vIgYUxKJr5z2Rpl2SZEtWHuSp0cPUvehnegehNA1Qwvd71cun6qSh1h3//h0cZB5O2QArCCNKm9bTVzkvhl9TuD9qWUrHbv93kMM+eQVhO4Sm4xQs9zj6TTB7EhLtwglH4wMD8g2M2dY98e7EoSPwVNQfKIhlpZ5ujI1vXuFlWAO3a8rX84GolOBIhZ197+uuUJYkdVxufa2a7/zzSsLeD4N57ByzYeYESX8RwhmA5iIz/LOTDS26v1x9spJ0dSRuYJpOl7ksNrVSkGdqCjvb2if+IcD/nZzL51yTTeRmyuijbFnHDZnGN4cmOGsmMyXyZhhjeokl0cAYP3zZpu5uPKE5njLI4GGdEFeFpGMy3jp0+W1jtNokeUb5MXhd7x5DOmpzUqSNIvJEtd/XeqO5KB7+kpI8Bi/lrmkgCj0Yg6s4daJdvcE5nL/uj1KvzBTvC5RtMyOd55k6tlM3JfXIULMb95ukF/SWvBmPzTOX4Ykv7K0rVvaX5rG3wkxkymy17XccXRHaK/6zqb4lf8wQ77VxavTID8alSDlySu6lLfuBMzJA/9PPzx9gslTQMFyjwO/elkmlkiIga2GJS3cysomKKuYemGz9YlJQ6EIGEl3E/ek/zgmM5x/llOARJbcaI6RZnmschttoXyaFZytwpjXmrZuHC0eJXri0yec2nrQF+3JDIsXNVoglloySmf+7F+w/8OCR1S30q+z7yGL3l/t1aTVJpo698ceymQDRVfY6tzt2S9RCfYfTYigHM1eUgvY5UnGrvperGymnQJke67Grtx74OXrG/HG9GfhMGu/axTJ0k+BIp7hdxKgE/rBxULJAHajDNLsyV4n9MnqW4vFFSlvsvCjfMHB+El1ZzHIgskH7Gu6k1Ud99ggdRiLbFmgSFX2kzLU85vIKb56+nfSJMP8qChNjvfwzBrpbzXgq7jeX6Kz/95AENYRtXnqSnllJfjVXosTjifrZ7BbMMSI5IlZltm0wJTZke0xJJqa8LLAoO3i1QXWwiJLm7c571vau9VezorC59156OZoU3g9FYHRv+1v1Zdu9LKrv71KmKhZTtrSPVfbZPZao2BUBkIu3FnoTw6PF4ku6PJbBOJc9OxUwVnZzGUpN7fI8u+6XJaB/6EmU0uTofhjBGw9Afwx88Bnr+O2Pz54+5how0YE+7vl8w5PHoT3jiy5Ipd/7WZ+emkTyVetez84+qknlPC7Ze3g6CX6s3xV2YNw+xgsptCK63ebg5woy5M/tR9USyJ8n70nzGv1O9O8ETDUME4CBoXqhsSU4R1Ol5u9NkfZz9+tFzF9jIxZsVWom8CF1WSuWhZvEUBXfwm8tgMl/umJbgJC/+cg/O9B1r6y+ec94F57cklbtTAi8lA1vzvzwDvVbnu5bTh/SCLdViQvF4LXJcj+3wFbCkiKf179H4wgy/Qfpvil6/3AvrlcB+a+Wlh/Jcaf7b90AuAvZuSpAV+tPou3Cv78tcWYKdaWvwjpfv25b83VTcGCnmGy8DvVCKf/zj2V3SPMpY+AaiPeNbJkdN9JTzSLCmKxhr4ksiB0NLl883eAO/7v4P99E/73IBMrruRlktUMx7Af4ZUoLB3IrMxG4Ljbfwf+fw/C/x48DlobXYzgb2+7vrmb/KgsM2km4sDaVblqynPfxvUpn+yETduUyMMvUzPL++eCeex3pjD4l3Z9Z3vtTDY5/B+p8kBrn0wAAA==").split(",")))},64126:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=void 0;const n=i(78213),r=i(66776),s=i(46027);t.debounce=function(e,t){let i;t=Math.ceil(t);let a=[];const o=(...o)=>{a=o,r.map(i,n.clearTimeout),i=s.setUnrefTimeout((()=>e(...a)),t)};return o.reset=()=>{r.map(i,n.clearTimeout),i=void 0},o.now=()=>{o.reset(),e()},o}},42536:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultCacheDir=void 0;const n=i(11944),r=i(9678),s=i(7799),a=i(3955),o=i(76886),l=i(99312);t.defaultCacheDir=function(){if(l.isDocker()&&a.isDirectorySync("/ps/cache"))return"/ps/cache";if(l.isWin)for(const e of n.compactBlanks([s.getEnv("TEMP"),s.getEnv("LOCALAPPDATA")]))if(a.isDirectorySync(e))return a.resolve(e,r.AppName());if(l.isMac){const e=a.resolve(o.homeDir(),"Library","Caches");if(a.isDirectorySync(e))return a.resolve(e,r.AppName())}return a.resolve(o.homeDir(),".cache",r.AppName().toLowerCase())}},70403:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenElapsed=t.elapsedAsync=t.elapsed=t.Elapsed=void 0;const n=i(66776);t.Elapsed=class{constructor(e,t){this.l=e,this.listener=t,this.ts=Date.now()}elapsed(e){const t=Date.now(),i=t-this.ts;this.ts=t,n.map(this.listener,(t=>t(e,i))),i>2&&this.l.log(i>500?"warn":i>100?"info":"debug",e,{elapsedMs:i})}},t.elapsed=function(e){const t=Date.now(),i=e();return{elapsedMs:Date.now()-t,result:i}},t.elapsedAsync=async function(e){const t=Date.now(),i=await e();return{elapsedMs:Date.now()-t,result:i}},t.thenElapsed=async function(e){const t=Date.now(),i=await e;return{elapsedMs:Date.now()-t,result:i}}},7799:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEnvTrue=t.getEnv=void 0;const n=i(61765),r=i(61570),s=i(38625);function a(e){return r.firstValueCaseInsensitive(n.env,e)}t.getEnv=a,t.isEnvTrue=function(e){return s.isTrue(a(e))}},56533:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseEnvTokens=void 0;const n=i(51081),r=i(91464);t.parseEnvTokens=function({input:e,lowerCaseKeys:t}){const i={};let s;for(const a of n.splitLines(e).filter((e=>null==e.match(/^\s*#/)))){const e=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+|#.*?)/gim;for(;null!=(s=e.exec(a));){const[,e,n,a]=s;i[t?e.toLowerCase():e]=r.stripPreSuff(a,n,n)}}return i}},84593:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlAsyncPicked=t.eqlAsync=t.definedAndNotEql=t.definedAndEql=t.eql=void 0;const n=i(66776),r=i(61570),s=i(17764);function a(e,t){return s(e,t)}t.eql=a,t.definedAndEql=function(e,t){return null!=e&&null!=t&&a(e,t)},t.definedAndNotEql=function(e,t){return null!=e&&null!=t&&!a(e,t)},t.eqlAsync=async function(e,t){return n.map2Or(await e,await t,a,(()=>!1))},t.eqlAsyncPicked=async function(e,t,...i){return n.map2Or(await e,await t,((e,t)=>a(r.pick(e,...i),r.pick(t,...i))),(()=>!1))}},51498:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FifoCacheAsync=t.FifoCache=void 0;const n=i(31669),r=i(11944),s=i(66776),a=i(75556),o=i(82798),l=i(13317),u=i(46027),c=i(21142),d=i(8177);function h(e){return null==e?[]:Object.keys(e)}class p{constructor(e,t){if(this.maxSize=e,this.clearEveryMs=t,this.setsSinceLastSpill=0,this.expireListeners=[],e<1)throw new Error("maxSize must be positive");if(e>3e4)throw new Error("maxSize is too big");this.clear(),a.gt0(t)&&(this.clearInterval=u.setUnrefInterval((()=>{this.spill()}),a.round(t/2)))}spill(){var e;if(null!=this.priorCache&&null!=this.currentCache&&r.isNotEmpty(this.expireListeners))for(const e in this.priorCache)if(null==this.currentCache[e]){const t=this.priorCache[e];if(null!=t)for(const i of this.expireListeners)i(e,t)}this.priorCache=null!==(e=this.currentCache)&&void 0!==e?e:Object.create(null),this.currentCache=Object.create(null),this.setsSinceLastSpill=0}[n.inspect.custom](){return{...this.priorCache,...this.currentCache}}end(){null!=this.clearInterval&&clearInterval(this.clearInterval)}clear(){return this.visit(((e,t)=>{for(const i of this.expireListeners)i(e,t)})),this.currentCache=Object.create(null),this.priorCache=Object.create(null),this.setsSinceLastSpill=0,this}get size(){if(null==this.currentCache||null==this.priorCache)return 0;let e=0;for(const t of d.union(h(this.priorCache),h(this.currentCache)))this.has(t)&&e++;return e}has(e){return null!=this.currentCache[e]||null!=this.priorCache[e]}keys(){return r.uniq([...h(this.priorCache),...h(this.currentCache)]).filter((e=>{var t;return null!==(t=null!=this.currentCache[e])&&void 0!==t?t:this.priorCache[e]}))}delete(e){const t=this.currentCache[e];if(null!=t){this.currentCache[e]=void 0;for(const i of this.expireListeners)i(e,t)}const i=this.priorCache[e];if(null!=i&&(this.priorCache[e]=void 0,null==t))for(const t of this.expireListeners)t(e,i)}visit(e){var t;for(const i of d.union(h(this.priorCache),h(this.currentCache))){const n=null!==(t=this.currentCache[i])&&void 0!==t?t:this.priorCache[i];null!=n&&e(i,n)}}deleteIf(e){for(const t of this.keys()){const i=s.orElse(this.currentCache[t],this.priorCache[t]);null!=i&&e(t,i)&&this.delete(t)}}get(e){var t;return e=o.toS(e),null!==(t=this.currentCache[e])&&void 0!==t?t:this.priorCache[e]}set(e,t){e=o.toS(e),null==this.currentCache[e]&&(this.setsSinceLastSpill>=this.maxSize&&this.spill(),this.setsSinceLastSpill++),this.currentCache[e]=t}getOrSet(e,t){e=o.toS(e);const i=this.get(e);if(null!=i)return i;const n=t();return this.set(e,n),n}on(e,t){this.expireListeners.push(t)}}t.FifoCache=p,t.FifoCacheAsync=class{constructor(e){this.opts=e,this.uid=0,this.cacheSyncHits=0,this.cacheAsyncHits=0,this.cacheMisses=0,this.timeouts=0,this.cache=new p(e.maxSize,e.clearEveryMs)}get size(){return this.cache.size}stats(){return{size:this.size,cacheSyncHits:this.cacheSyncHits,cacheAsyncHits:this.cacheAsyncHits,cacheMisses:this.cacheMisses,timeouts:this.timeouts}}get(e){const t=this.cache.get(e);return null==t||null!=t.__uid?void 0:t}clear(){this.cache.clear(),this.cacheSyncHits=0,this.cacheAsyncHits=0,this.cacheMisses=0,this.timeouts=0}deleteIf(e){for(const t of this.cache.keys())e(t)&&this.cache.delete(t)}set(e,t){return this.cache.set(e,t),t}async getOrSetAsync(e,t,i=1){const n=o.toS(e);{const e=this.get(n);if(null!=e)return this.cacheSyncHits++,e}const r=this.uid++,s=Date.now(),a=this.cache.getOrSet(n,(()=>({__uid:r,__start:s})));if(a.__uid===r)return this.cacheMisses++,l.thenOrTimeout(t,this.opts.timeoutMs,(()=>{var e;this.timeouts++,(null===(e=this.cache.get(n))||void 0===e?void 0:e.__uid)===r&&this.cache.delete(n)}),(e=>{null==e?this.cache.delete(n):this.cache.set(n,e)}));{const e=a.__start;if(null!=e){const t=e+this.opts.timeoutMs-Date.now();if(t>0){const e=c.until((()=>this.get(n)),{timeoutMs:t});if(null!=e)return this.cacheAsyncHits++,e}}return i>0?this.getOrSetAsync(n,t,i-1):void 0}}}},31791:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.trueFilter=t.definedFilter=t.Filter=void 0;const n=i(66776),r=i(91419);class s{static lift(e){return new class extends s{apply(t){return e(t)}}}and(e){return s.lift((t=>this.apply(t)&&e.apply(t)))}or(e){return s.lift((t=>this.apply(t)||e.apply(t)))}filter(e){return e.filter((e=>this.apply(e)))}asAsync(){return r.AsyncFilter.lift((e=>Promise.resolve(this.apply(e))))}}t.Filter=s,t.definedFilter=s.lift(n.defined),t.trueFilter=s.lift((()=>!0))},82128:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fixed=t.parseFixed=void 0;const n=i(11944),r=i(39938),s=i(11448),a=i(66776),o=i(75556),l=i(61570),u=i(39784),c=i(82798),d=i(7162),h=i(1058),p=i(8177),m=i(91464);class f{constructor(e){this.h=e,this.text=a.orElse(e.text,c.toS(e)),this.greedyLeft=a.orElse(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}}const g=s.lazy((()=>d.mkLogger("Fixed")));t.parseFixed=function(e,t,i=!0){return new y(e,t,i).entries};class y{constructor(e,t,i=!0){this.warnIfMissingHeaders=i;const s=t.split(/[\r\n]{1,2}/);this.headerRow=s[0],this.rows=s.slice(1);const a=Math.max(...this.rows.map((e=>e.length)));this.col2blanks=new Map(o.times(a,(e=>[e,n.count(this.rows,(t=>r.blank(t[e])))]))),this.headers=this.extractHeaders(e.map((e=>new f(e)))),this.entries=this.rows.map((e=>this.headers.map((t=>t.toEntry(e))))).map((e=>l.fromEntries(e))).filter((e=>l.values(e).some(r.notBlank)))}extractHeaders(e){let t=this.headerRow;n.sortBy(e,(e=>-e.text.length)),e.forEach((e=>{const i=new RegExp(`\\b${h.escapeRegExp(e.text)}\\b`,"i"),n=i.exec(t);null==n?this.warnIfMissingHeaders&&g().warn("extractHeaders(): Failed to find header!",{re:i,headerLine:t}):(e.indexOf=n.index,t=m.padReplace(t,n.index,e.text.length," "))}));const i=e.filter((e=>null!=e.indexOf)),r=n.sortBy(i,(e=>e.indexOf));r.forEach(((e,t)=>{const i=e.indexOf,n=r[t-1],s=0===t?0:n.indexOf+n.text.length-1,[o,l]=e.greedyLeft?[s,i]:[i,s];e.leftIdx=a.map(this.firstBlankColumn(o,l),(e=>e+1)),0===t&&null==e.leftIdx&&(e.leftIdx=0),null==e.leftIdx&&g().warn("no blank column for "+e.text+" between "+i+" and "+s)})),n.filterInPlace(r,(e=>null!=e.leftIdx)),r.slice(0,-1).forEach(((e,t)=>{const i=r[t+1];e.rightIdx=i.leftIdx-1}));const s=u.toA(p.diff(e.map((e=>e.text)),r.map((e=>e.text))));return s.length>0&&g().warn("Missing headers",{missingHeaders:s}),r}firstBlankColumn(e,t){return n.range(e,t).find((e=>this.col2blanks.get(e)===this.rows.length))}}t.Fixed=y},85563:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.distanceMeters=t.geohashDistanceMeters=t.geoHashToLocation=t.ungeohash_num=t.ungeohash=t.geohashNumeric=t.geohashNumericShort=t.geohash=t.locationToGeohash=t.validLatLon=t.validLon=t.validLat=void 0;const n=i(66776),r=i(75556),s=i(70208),a=i(6231),o=i(70283);function l(e){return 5*Math.floor(e/5)}function u(e){return r.isNumber(e)&&0!==e&&o.within(-90,90,e)}function c(e){return r.isNumber(e)&&0!==e&&o.within(-180,180,e)}function d(e,t){return u(e)&&c(t)}function h(e,t,i=30){return n.map(p(e,t,l(i)),(e=>a.GeoRadix.encode(e)))}function p(e,t,i=30){return d(e,t)?s.bitZip({dims:[{min:-180,value:t,max:180},{min:-90,value:e,max:90}],bitDepth:l(i)}):void 0}function m(e,t=30){return n.map(s.bitUnzip(e,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:l(t)}),(e=>e.reverse()))}function f(e,t=30){const[i,n]=m(e,t);return{lat:i,lon:n}}function g(e,t){const i=e.lat*Math.PI/180,n=t.lat*Math.PI/180,r=(t.lat-e.lat)*Math.PI/180,s=(t.lon-e.lon)*Math.PI/180,a=Math.sin(r/2)*Math.sin(r/2)+Math.cos(i)*Math.cos(n)*Math.sin(s/2)*Math.sin(s/2);return 12742e3*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}t.validLat=u,t.validLon=c,t.validLatLon=d,t.locationToGeohash=function(e,t=30){return h(null==e?void 0:e.lat,null==e?void 0:e.lon,t)},t.geohash=h,t.geohashNumericShort=function(e,t){return p(e,t,30)},t.geohashNumeric=p,t.ungeohash=function(e,t=30){return n.map(a.GeoRadix.decode(e),(e=>m(e,t)))},t.ungeohash_num=m,t.geoHashToLocation=f,t.geohashDistanceMeters=function(e,t){if(null!=e&&null!=t)return e===t?0:g(f(e),f(t))},t.distanceMeters=g},76886:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.homeDir=void 0;const n=i(12087),r=i(85622),s=i(11944),a=i(11448),o=i(7799),l=i(3955),u=i(99312);t.homeDir=a.lazy((()=>{const e=[];u.isWin?e.push(o.getEnv("USERPROFILE")):e.push(o.getEnv("HOME"));for(const t of s.compactBlanks(e)){const e=r.resolve(t);if(l.isDirectorySync(e))return e}return n.homedir()}))},79378:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mapParsed=t.parseMaybe=void 0;const n=i(39938);t.parseMaybe=function(e){try{if(n.notBlank(e))return JSON.parse(e)}catch{}},t.mapParsed=function(e,t){try{if(n.notBlank(e))return t(JSON.parse(e))}catch{}}},7084:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unl33t=t.l33t=void 0;const n=i(11944),r=i(39938),s=i(11448),a=i(39784),o=i(12651);t.l33t=function(e){var t,i;let n="";const r=u();for(const s of e)n+=null!==(i=null===(t=r.get(s))||void 0===t?void 0:t[0])&&void 0!==i?i:s;return n};const l=s.lazy((()=>{const e=new o.MultiMap;for(const{l:t,a:i}of[{l:"0",a:["o"]},{l:"1",a:["i","l"]},{l:"2",a:["z"]},{l:"3",a:["e"]},{l:"4",a:["a"]},{l:"5",a:["s"]},{l:"6",a:["b"]},{l:"7",a:["t"]},{l:"8",a:["b"]},{l:"9",a:["g","q"]}])e.add(t,...i);return e})),u=s.lazy((()=>{const e=l().inverse();for(const t of e.values())t.sort();return e}));t.unl33t=function e(t){if(r.blank(t))return[""];const i=t.substring(0,1),s=[i,...a.toA(l().get(i))],o=e(t.substring(1));return n.flatten(o.map((e=>s.map((t=>t+e)))))}},92507:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.childProcLocale=t.localePosix=t.localeMac=t.localeWin=t.lc2locale=t.locale=t.defaultLocale=void 0;const r=n(i(61765)),s=i(11944),a=i(39938),o=i(88491),l=i(11448),u=i(66776),c=i(61570),d=i(54608),h=i(64975),p=i(46852),m=i(69317),f=i(99312),g=i(71663),y=i(91464);function v(e=r.default.env){return u.firstDefined(e.LC_ALL,e.LC_MESSAGES,e.LANG,e.LANGUAGE)}t.defaultLocale="en",t.locale=l.lazy((async()=>b(await h.firstDefinedLater((()=>v()),(()=>f.isWin?S():void 0),(()=>f.isMac?P():void 0),(()=>f.isPosix?T():void 0)))));const w=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function b(e){if(a.blank(e)||y.equalsIgnoreCase("c",e)||y.equalsIgnoreCase("posix",e))return t.defaultLocale;{const i=w.exec(e);return null==i?t.defaultLocale:s.compact([i[1],i[2]]).join("-")}}function S(){return p.thenMap(g.PowerShell.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),(e=>e.Name))}t.lc2locale=b,t.localeWin=S;const M={timeout:10*o.secondMs};function P(){return d.thenOpt(m.stdout("defaults",["read","-globalDomain","AppleLocale"],M)).flatMap(b).get()}t.localeMac=P;const E=/^([a-z_]+)\s*=\s*"(.+)"$/i;function T(){return d.thenOpt(m.stdout("locale",[],M)).flatMap((e=>e.split("\n").map((e=>u.map(e.match(E),(e=>[e[1],e[2]])))))).flatMap(c.fromEntries).flatMap(v).flatMap(b).get()}t.localePosix=T,t.childProcLocale=function(){return{LANG:"C",LC_ALL:"C"}}},17525:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultPosixLogDir=t.defaultLogDir=void 0;const n=i(85622),r=i(47977),s=i(9678),a=i(76886),o=i(99312);function l(){return n.resolve(r.appData(),s.SimpleAppName.toLowerCase(),"logs")}t.defaultLogDir=function(){return o.isDocker()?"/ps/logs":o.isMac?n.resolve(a.homeDir(),"Library","Logs",s.SimpleAppName.toLowerCase()):l()},t.defaultPosixLogDir=l},11935:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.orLoggedAsync=t.orLogged=void 0;const n=i(66776),r=i(61570);function s(e,t,i){const n=null==i?"warn":"debug";e.log(n,t,i)}t.orLogged=function(e,t,i){const a={};try{for(const t of e)for(const e of r.keys(t)){const i=t[e]();if(a[e]=n.orElse(i,!1),!0===i)return i}return!1}finally{s(i,t,a)}},t.orLoggedAsync=async function(e,t,i){const n={};try{for(const t of e)for(const e of r.keys(t)){const i=await t[e]();if(n[e]=i,i)return i}return!1}finally{s(i,t,n)}}},7162:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkLogger=t.writeRecentLogEntries=t.setupLogger=t.currentFileLogger=void 0;const n=i(11448),r=i(36079),s=i(74269),a=i(85296),o=i(81026),l=i(43414),u=n.lazy((()=>[s.ConsoleLogger.instance()]));function c(){return u().find((e=>e instanceof o.LogWriter))}t.currentFileLogger=c,t.setupLogger=function(){const e=l.Settings.logDir.valueOrDefault;let t=c();null!=t&&t.logDir===e||(r.end(t),t=new o.LogWriter(e));const i=[t];(l.Settings.logStdout.valueOrDefault||l.Settings.tailLogs.valueOrDefault)&&i.push(s.ConsoleLogger.instance()),u.set(i)},t.writeRecentLogEntries=function(){var e;return null===(e=c())||void 0===e?void 0:e.writeRecentLogEntries()},t.mkLogger=function(e){return new a.ContextualLogger(e,u)}},48783:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.inverse=t.getLike=t.pickKeys=t.filterInPlace=t.filter=t.toObj=t.toMapAsync=t.toMap=t.compactMap=t.flatMap=t.hasAll=void 0;const n=i(11944),r=i(66776),s=i(39784),a=i(13779);function o(e){const t=n.compact(e).filter((([e,t])=>null!=e&&null!=t));return new Map(t)}function l(e,t){return new Map([...e.entries()].filter((([e,i])=>t(e,i))))}t.hasAll=function(e,t){return t.every((t=>e.has(t)))},t.flatMap=function(e,t){return new Map(a.concat(...e.map((e=>t(e)))))},t.compactMap=o,t.toMap=function(e,t){return o(n.compact(e).map(t))},t.toMapAsync=async function(e,t){return null==e?new Map:o(await Promise.all(n.compact(s.toA(e)).map((e=>t(e)))))},t.toObj=function(e){const t={};for(const[i,n]of e)t[i]=n;return t},t.filter=l,t.filterInPlace=function(e,t){[...e.entries()].forEach((([i,n])=>t(i,n)||e.delete(i)))},t.pickKeys=function(e,t){return l(e,(e=>t.indexOf(e)>=0))},t.getLike=function(e,t){return r.map([...e.entries()].find((([e])=>t(e))),(([,e])=>e))},t.inverse=function(e){return new Map([...e.entries()].map((([e,t])=>[t,e])))}},81765:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoize=void 0;const n=i(87748),r=i(51498);t.memoize=function(e,t){let i=0;const s=new r.FifoCache(t.maxSize,t.ttlMs),a=t=>(i++,s.getOrSet(n.stringify(t),(()=>e(t))));return a.clear=e=>null==e?s.clear():s.delete(n.stringify(e)),a.size=()=>s.size,a.callCount=()=>i,a}},68114:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoryUsageRssMb=t.memoryUsageRssBytes=t.memoryUsageMb=t.memoryUsageBytes=void 0;const n=i(61765),r=i(75556),s=i(17078),a=i(6667);function o(){const e=n.memoryUsage();return a.sum([e.external,e.heapUsed,e.arrayBuffers])}function l(){return n.memoryUsage().rss}t.memoryUsageBytes=o,t.memoryUsageMb=function(){return r.sigFigs(o()/s.MB,2)},t.memoryUsageRssBytes=l,t.memoryUsageRssMb=function(){return r.sigFigs(l()/s.MB,2)}},12651:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupByValues=t.groupBy=t.MultiMap=void 0;const n=i(11944),r=i(21040),s=i(66776),a=i(39784),o=i(13779),l=i(6667);class u{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return l.sum([...this.store.values()].map((e=>e.length)))}add(e,...t){const i=r.getOrSet(this.store,e,(()=>[]));return i.push(...t),i}set(e,t){this.store.set(e,t)}delete(e,t){if(null==t)return this.store.delete(e);{const i=this.store.get(e);if(null==i)return!1;{const n=o.remove(i,t);return n&&0===i.length&&this.store.delete(e),n}}}clear(){return this.store.clear(),this}keys(){const e=this;return function*(){for(const[t,i]of e.store.entries())i.length>0&&(yield t)}()}values(){const e=this;return function*(){for(const[,t]of e.store.entries())t.length>0&&(yield t)}()}flatValues(){const e=this;return function*(){for(const[,t]of e.store.entries())if(t.length>0)for(const e of t)yield e}()}entriesArray(){return[...this.store.entries()].filter((([,e])=>n.isNotEmpty(e)))}entries(){const e=this;return function*(){for(const[t,i]of e.store.entries())i.length>0&&(yield[t,i])}()}tuples(){const e=this;return function*(){for(const[t,i]of e.store.entries())for(const e of a.toA(i))null!=e&&(yield[t,e])}()}filterInPlace(e){let t=!1;for(const[i,r]of this.store.entries()){const s=r.length;n.filterInPlace(r,(t=>e(i,t))),t=t||s!==r.length}return t}inverse(){const e=new u;for(const[t,i]of this.store.entries())for(const n of i)e.add(n,t);return e}}function c(e,t){const i=new u;return e.forEach((e=>s.map(t(e),(t=>i.add(t,e))))),i}t.MultiMap=u,t.groupBy=c,t.groupByValues=function(e,t){const i=c(e,t);return n.sortBy(a.toA(i.values()),(e=>t(e[0])))}},19658:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.start=t.setSingleSpecTests=t.isSingleSpecTests=t.isProd=t.isTest=t.isDev=t.nodeEnv=t._nodeEnv=void 0;const n=i(61765),r=i(82798),s=i(38625);function a(){switch(r.toS(n.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return n.argv.some((e=>e.endsWith("mocha")||e.endsWith(".spec.js")))?"test":"production"}}t._nodeEnv=a,t.nodeEnv=(()=>{const e=a();return n.env.NODE_ENV=e,e})(),t.isDev="development"===t.nodeEnv,t.isTest="test"===t.nodeEnv,t.isProd="production"===t.nodeEnv,t.isSingleSpecTests=function(){return t.isTest&&s.isTrue(n.env.SINGLE_SPEC_TESTS)},t.setSingleSpecTests=function(e){n.env.SINGLE_SPEC_TESTS=e?"true":"false"},t.start=Date.now()},70283:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.valuesToBigInt=t.hammRatioBinaryString=t.hammRatioBigInt=t.hammingDistanceBigInt=t.Array2D=t.assertPositive=t.extractFraction=t.extractInt=t.extractFloat=t.within=t.mapGt0Or=t.mapGt0f=t.mapGt0=t.mapGte0f=t.mapGte0Or=t.mapGte0=t.firstNonZero=t.firstGt0=void 0;const n=i(11944),r=i(39938),s=i(66776),a=i(75556),o=i(82798),l=i(91464);function u(e,t){return a.mapInt(e,(e=>e>=0?t(e):void 0))}function c(e,t){return a.mapInt(e,(e=>e>0?t(e):void 0))}t.firstGt0=function(...e){return e.find(a.gt0)},t.firstNonZero=function(...e){for(const t of n.flatten(e)){const e=a.toFloat(t);if(null!=e&&0!==e)return e}},t.mapGte0=u,t.mapGte0Or=function(e,t,i){return s.orElse(u(e,t),i)},t.mapGte0f=function(e,t){return a.mapNumeric(e,(e=>e>=0?t(e):void 0))},t.mapGt0=c,t.mapGt0f=function(e,t){return a.mapNumeric(e,(e=>e>0?t(e):void 0))},t.mapGt0Or=function(e,t,i){return s.orElse(c(e,t),i)},t.within=function(e,t,i){return!(null==i||!a.isNumber(i))&&([e,t]=[Math.min(e,t),Math.max(e,t)],a.gte(i,e)&&a.lte(i,t))};const d=/[+-]?[0-9\,\.]+/;function h(e){if(a.isNumber(e))return e;if(r.blank(e))return;const t=String(e);return s.map(d.exec(t),(e=>a.toFloat(t.substr(e.index))))}function p(e){return a.toInt(h(e))}function m(e,t){if(null==e||null==t)return;const i=[e,t].map((e=>e.toString(2))),n=Math.max(...i.map((e=>e.length)));return i.map((e=>l.leftPad(e,n,"0")))}function f(e,t){if(e===t)return 1;if(e.length!==t.length)throw new Error(`hammRatioBinaryString(${e}, ${t}): invalid lengths`);let i=0;for(let n=0;n<e.length;n++)e[n]===t[n]&&i++;return a.clamp(0,1,2*i/e.length-1)}t.extractFloat=h,t.extractInt=p,t.extractFraction=function(e){if(a.isNumber(e))return e;const t=o.toS(e);if(t.includes("/")){const e=t.split("/",2);return a.map2Numeric(p(e[0]),p(e[1]),((e,t)=>e/t))}return h(t)},t.assertPositive=function(e,t){if(null==t||t<=0)throw new Error(e+" must be positive")},t.Array2D=class{constructor(e){this.columns=e,this.store=[]}get(e,t){return e<0||t<0?0:s.orElse(this.store[e*this.columns+t],(()=>0))}set(e,t,i){this.store[e*this.columns+t]=i}},t.hammingDistanceBigInt=function(e,t){return s.map(m(e,t),(([e,t])=>n.count([...e],((e,i)=>e!==t.charAt(i)))))},t.hammRatioBigInt=function(e,t){return null==e||null==t?0:s.map(m(e,t),(([e,t])=>f(e,t)))},t.hammRatioBinaryString=f,t.valuesToBigInt=function(e,t){return n.isEmpty(e)?BigInt(0):BigInt("0b0"+e.map((e=>l.leftPad(e.toString(2),t-1,"0"))).join(""))}},2023:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.valpath=t.eqlSubset=t.mapEntries=t.pickMap=t.assignFields=t.assignMissingPrimitives=t.spread=t.primitiveEntries=t.hasKeys=t.ctor=t.identity=t.tryEach=t.Try=t.mapOrThrow=t.mapAnd=t.ornull=t.firstFieldLike=t.firstDefinedField=t.firstDefined=t.firstTrueThunk=t.firstThunk=t.definedThunks=void 0;const n=i(11944),r=i(39938),s=i(88491),a=i(66776),o=i(61570),l=i(8199),u=i(13779),c=i(84593),d=i(91464);function h(e,t){try{return e()}catch(e){return null!=t?t(e):void 0}}function p(e){return o.keys(e).filter((t=>l.isPrimitive(e[t])||s.isDate(e[t]))).map((t=>[t,e[t]]))}t.definedThunks=function(...e){return e.every((e=>a.defined(e())))},t.firstThunk=function(...e){for(const t of e){const e=t();if(null!=e)return e}},t.firstTrueThunk=function(e,t){for(const i of e){const e=i();if(null!=e&&(null==t||t(e)))return e}},t.firstDefined=function(...e){return e.find(a.defined)},t.firstDefinedField=function(e,...t){return a.map(t.find((t=>null!=e[t])),(t=>e[t]))},t.firstFieldLike=function(e,t){return u.first(o.keys(e),(i=>t(i,e[i])?e[i]:void 0))},t.ornull=function(e){return void 0===e?null:e},t.mapAnd=function(e,t){return null!=e&&t(e)},t.mapOrThrow=function(e,t,i){if(null!=e)return t(e);throw new Error(i)},t.Try=h,t.tryEach=function(e,t){[...e].forEach((e=>h((()=>t(e)))))},t.identity=function(e){return e},t.ctor=function(e){return a.map(e.constructor,(e=>e.name))},t.hasKeys=function(e){return Object.keys(e).some((t=>"string"==typeof t&&e.propertyIsEnumerable(t)))},t.primitiveEntries=p,t.spread=function(e,...t){return Object.assign({},e,...n.compact(t))},t.assignMissingPrimitives=function(e,t){if(null==t)return e;for(const[i,n]of p(t))null==e[i]&&(e[i]=n);return e},t.assignFields=function(e,t){if(null==t)return e;for(const[i,n]of o.entries(t))null!=n&&(e[i]=n);return e},t.pickMap=function(e,t,i){const n={};for(const r of t)n[r]=i(r,e[r]);return n},t.mapEntries=function(e,t){const i={};for(const n of o.keys(e)){const r=t(n,e[n]);null!=r&&(i[n]=r)}return i},t.eqlSubset=function(e,t){return null!=e&&o.keys(e).every((i=>c.eql(e[i],t[i])))},t.valpath=function e(t,i){if(null==i||null==t||r.blank(i))return t;if(Array.isArray(t))return n.compact(t.map((t=>e(t,i))));const s=i.indexOf("."),a=s<0?i:i.slice(0,s),l=s<0?void 0:i.slice(s+1),u=o.keys(t);if(u.includes(a))return e(t[a],l);const c=u.find((e=>d.equalsIgnoreCase(e,a)));return null!=c?e(t[c],l):void 0}},32330:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.baseVersion=t.channel=t.isBetaVersion=t.isAlphaVersion=void 0;const n=i(42041);t.isAlphaVersion=()=>n.version.includes("-alpha"),t.isBetaVersion=()=>n.version.includes("-beta"),t.channel=()=>t.isAlphaVersion()?"alpha":t.isBetaVersion()?"beta":"latest",t.baseVersion=()=>n.version.split("-")[0]},93813:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetVersion=t.AssetFileVersion=void 0,t.AssetFileVersion=11,t.AssetVersion=3},58517:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultPicturesDir=t.picturesDir=t.picturesDirWindows=void 0;const n=i(85622),r=i(39938),s=i(11448),a=i(76886),o=i(99312),l=i(71663);async function u(){return o.isWin?l.PowerShell.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}t.picturesDirWindows=u,t.picturesDir=s.lazy((async()=>{if(o.isWin){const e=await u();if(r.notBlank(e))return e}return t.defaultPicturesDir()})),t.defaultPicturesDir=s.lazy((()=>n.resolve(a.homeDir(),"Pictures")))},92661:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ProcCleaner=t.addPid=t.Pids=t.pidNotExists=t.pidExists=t.killPid=void 0;const r=n(i(63129)),s=n(i(61765)),a=i(11944),o=i(39938),l=i(88491),u=i(11448),c=i(66776),d=i(75556),h=i(98510),p=i(39784),m=i(82798),f=i(36079),g=i(95557),y=i(46852),v=i(70259),w=i(46027),b=i(10408),S=i(51498),M=i(98462),P=i(3955),E=i(7162),T=i(48783),x=i(70283),D=i(2023),C=i(99312),k=i(18),I=i(71663),F=i(15671),O=u.lazy((()=>E.mkLogger("Pids"))),A=10*l.secondMs;function _(e,t){if(null==e||null==t)return!1;const i=c.map(t.start,(e=>e.getTime())),n=e.startTime;return d.gt0(i)&&d.gt0(n)&&Math.abs(i-n)<A}async function L(e,t){return null!=e&&null!=t&&e.name===m.toS(t.pid)&&_(await e.readJson(),t)}function R(e,t=!1){const i=["/PID",m.toS(d.toInt(e)),"/T"];t&&i.push("/F"),r.default.execFile("taskkill",i)}function N(e,t=!1,i=!0){if(e===s.default.pid||e===s.default.ppid)throw new Error("cannot self-terminate");return t&&i&&j.instance().onKill(e),C.isWin?async function(e,t=!1){if(f.ending()||I.PowerShell.instance().ended)return R(e,t);try{const i=a.compact(["Stop-Process","-Id",d.toInt(e),t?"-Force":void 0]).join(" ");await I.PowerShell.instance().execute(i,D.identity)}catch(i){O().warn("killWin(): pwsh error, using TASKKILL: "+i),R(e,t)}}(e,t):async function(e,t=!1){try{s.default.kill(e,t?"SIGKILL":"SIGTERM")}catch(e){if(!String(e).includes("ESRCH"))throw e}}(e,t)}async function B(e){return null!=await k.pidInfo(e)}t.killPid=N,t.pidExists=B,t.pidNotExists=function(e){return y.thenNot(B(e))};class j{constructor(e=M.BaseFile.for(F.userData()).join("pids")){this.pidsDir=e,this.p=new v.Promises,this.recentPids=new S.FifoCache(10*l.secondMs),this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",(async()=>{const t=c.orElse(e.everything,!1),i=c.orElse(e.force,C.isWin),n=await this.pidfiles(),r=await T.toMapAsync(n,(e=>y.thenMap(e.readJson(),(e=>[e.pid,e])))),o=a.uniq(a.flatten(p.toA(r.values()).map((e=>[e.pid,e.ppid]))));if(a.isEmpty(o))return O().debug("killOldProcs(): no pidfiles"),[];const l=await k.pidInfos(o);if(O().debug("killOldProcs()",{pids:o,allEntries:l}),null==l)return void b.onError("Pids.killOldProcs(): failed to get process information");const u=new Set(l.map((e=>e.pid))),h=l.filter((e=>r.has(e.pid))),m=a.sortBy(a.compact(h.map((e=>c.map(r.get(e.pid),(t=>_(t,e)?{...t,...e}:void 0))))),(e=>e.pid)).filter((e=>s.default.pid!==e.pid)),f=t?m:m.filter((t=>!u.has(t.ppid)||!u.has(t.pid)||d.gt0(t.timeoutTime)&&Date.now()>=t.timeoutTime||null!=e.everythingBefore&&t.startTime<e.everythingBefore));O().debug("killOldProcs()",{trackedEntries:h,victims:f,pidfiles:p.toA(r.values())});for(const e of f)O().debug("killOldProcs(): killing",{entry:e}),N(e.pid,i,!1);return await this.vacuumPids(),a.sortBy(f,(e=>e.pid))}))}async addPid(e,t,i=!1){if(null==e)throw new Error("undefined info");const n=e.pid;if(!d.gt0(n))throw new Error("undefined pid");const r=e.ppid+":"+e.pid;return i&&this.recentPids.delete(r),this.recentPids.getOrSet(r,(async()=>{const n=this.pidsDir.join(e.pid+".json"),r=h.opt(D.Try((()=>P.parseNativePath(e.cmd).base))).filter(o.notBlank).getOrElse((()=>e.cmd)),s=t.getTime(),a=x.mapGt0(e.maxAgeMs,(e=>s+e)),l={...e,cmd:r,startTime:s,timeoutTime:a};return null==await n.writeJsonMaybe(l)?O().throw("Failed to write to "+n,{info:e,force:i}):(O().debug("addPid() wrote "+n,l),n)}))}pidfiles(){return this.pidsDir.clear().children((e=>".json"===e.ext&&null!=d.toInt(e.name)))}async onKill(e){const t=this.pidsDir.join(e+".json");return y.thenMap(t.clear().readJson(),(t=>this.addPid({...t,maxAgeMs:1},l.ago(l.minuteMs),!0).catch((t=>{O().info("onKill(): failed to rewrite pidfile: "+t,{pid:e})}))))}async vacuumPids(){const e=await this.pidfiles(),t=p.toA(e).map((e=>d.toInt(e.name))).filter(d.gt0);if(a.isEmpty(t))return;const i=await k.pidInfos(t);if(null!=i){O().debug("vacuumPids",{pids:t,pidfiles:p.toA(e).map((e=>e.base)),entries:i});for(const t of e){const e=i.find((e=>m.toS(e.pid)===t.name));null!=e&&await L(t,e)||(O().debug("vacuumPids(): Removing old pidfile "+t.base,{psEntry:e,pidfile:await t.readFile().then(m.toS).catch((e=>"(failed to read file: "+e+")"))}),await t.unlink())}}else b.onError("Failed to get pidInfo for pids "+t)}}t.Pids=j,j.instance=u.lazy((()=>new j)),t.addPid=function(e,t){return j.instance().addPid(e,t)},t.ProcCleaner=u.lazy((()=>{const e=[{everything:!1,force:!1,intervalMs:5*l.minuteMs},{everything:!1,force:!0,intervalMs:17*l.minuteMs}].map((e=>w.setUnrefInterval((()=>j.instance().killOldProcs(e)),e.intervalMs)));return new g.EndableWrapper("ProcCleaner",(()=>(e.map(clearInterval),j.instance().killOldProcs())),f.EndableRanks.predb)}))},99312:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.platformName=t.procDeviceModel=t.isRaspberryPi=t.isDocker=t.setIsDocker=t.isElectron=t.isMainElectron=t.PS_IS_DOCKER=t.ELECTRON_RUN_AS_NODE=t.isPosix=t.isLinuxSnap=t.isLinuxAppImage=t.isLinux_arm=t.isArm=t.isLinux_x64=t.isLinux=t.isMac=t.isWinPortable=t.isWin=t.isPacked=t.inspectFlag=void 0;const r=i(35747),s=i(12087),a=n(i(61765)),o=i(39938),l=i(38625),u=i(11448),c=i(66776),d=i(82798),h=i(7799),p=s.platform();t.inspectFlag=a.default.argv.includes("--inspect")||l.isTrue(a.default.env.NODE_INSPECT),t.isPacked=!d.toS(__filename).includes("Platform"),t.isWin="win32"===p||"cygwin"===p,t.isWinPortable=t.isWin&&o.notBlank(a.default.env.PORTABLE_EXECUTABLE_DIR),t.isMac="darwin"===p,t.isLinux="linux"===p,t.isLinux_x64=t.isLinux&&"x64"===s.arch(),t.isArm="arm"===s.arch(),t.isLinux_arm=t.isLinux&&t.isArm,t.isLinuxAppImage=t.isLinux&&(o.notBlank(a.default.env.APPIMAGE)||o.notBlank(a.default.env.APPDIR)),t.isLinuxSnap=t.isLinux&&o.notBlank(a.default.env.SNAP_USER_DATA),t.isPosix=t.isMac||t.isLinux,t.ELECTRON_RUN_AS_NODE="ELECTRON_RUN_AS_NODE",t.PS_IS_DOCKER="PS_IS_DOCKER",t.isMainElectron=null!=a.default.versions.electron,t.isElectron=t.isMainElectron||l.isTrue(a.default.env[t.ELECTRON_RUN_AS_NODE]),t.setIsDocker=function(e){e?a.default.env[t.PS_IS_DOCKER]="1":delete a.default.env[t.PS_IS_DOCKER]},t.isDocker=function(){return t.isLinux&&(h.isEnvTrue(t.PS_IS_DOCKER)||h.isEnvTrue("PS_DOCKER"))},t.isRaspberryPi=u.lazy((()=>t.isLinux_arm&&d.toS(t.procDeviceModel()).startsWith("Raspberry Pi"))),t.procDeviceModel=u.lazy((()=>{try{return t.isLinux?c.map(r.readFileSync("/proc/device-tree/model"),d.toS):void 0}catch{return}})),t.platformName=t.isWin?"win":t.isMac?"mac":t.isLinux?"linux":p},86725:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NiceLevel=t.PriorityClasses=void 0;const n=i(84253);t.PriorityClasses=n.strEnum("AboveNormal","Normal","BelowNormal","Idle"),t.NiceLevel=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19})},18:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.psWinWmic=t.pidInfos=t.notExistingPids=t.existingPids=t.pidInfo=t.ps=void 0;const r=n(i(61765)),s=i(11944),a=i(39938),o=i(88491),l=i(87748),u=i(11448),c=i(66776),d=i(75556),h=i(61570),p=i(26588),m=i(39784),f=i(82798),g=i(36079),y=i(46852),v=i(69317),w=i(82128),b=i(9288),S=i(7162),M=i(19658),P=i(99312),E=i(71663),T=i(3867),x=u.lazy((()=>S.mkLogger("Ps")));function D(e){return null!=e&&d.gt0(e.pid)&&null!=e.start&&a.notBlank(e.cmd)}async function C(e){return s.isEmpty(e)||s.arrayEql([r.default.pid],e)?m.toA(e):y.thenMap(k(e),(e=>e.map((e=>e.pid))))}async function k(e){const t=m.toA(e).filter(d.gt0);if(s.isEmpty(t))throw new Error("Invalid pids: "+l.stringify(e));return p.thenTap(y.thenMap(P.isWin?async function(e){if(g.ending()||E.PowerShell.instance().ended)return R(e);const t=[F,"-Id",A(e),"-ErrorAction SilentlyContinue",O].join(" ");return y.thenMap(E.PowerShell.instance().executeJsonToA(t),(e=>I(e)))}(t):async function(e){return N((await v.stdoutResult("ps",["-p",A(e),"-wwwo","pid,lstart,command"],{..._,ignoreExitCode:!0})).result)}(t),(e=>e.filter((e=>D(e)&&t.includes(e.pid))))),(e=>x().debug("pidInfo()",{pids:t,result:e})))}function I(e){return e.map((e=>({pid:e.Id,start:T.pwshJsonDate(e.StartTime),cmd:e.ProcessName})))}t.ps=async function(){const e=await(P.isWin?async function(){if(E.PowerShell.instance().ended)return R();const e=await E.PowerShell.instance().executeJsonToA([F,O].join(" "));return null==e?R():I(e)}():async function(){return N(await v.stdout("ps",["-ewwwo","pid,lstart,command"],_))}());return c.orElse(s.sortBy(e.filter(D),(e=>e.pid)),[])},t.pidInfo=async function(e){return y.thenMap(k([e]),(t=>m.toA(t).find((t=>t.pid===e))))},t.existingPids=C,t.notExistingPids=async function(e){return s.isEmpty(e)?[]:y.thenMap(C(e),(t=>{const i=[r.default.pid,...t];return e.filter((e=>!i.includes(e)))}))},t.pidInfos=k;const F="Get-Process",O="| Select-Object -Property Id,ProcessName,StartTime";function A(e){return s.uniq([...e.filter(d.gt0),r.default.pid]).join(",")}const _={maxBuffer:1048576,timeout:15*o.secondMs,ignoreExitCode:!0,ignoreStderr:!0},L=["CommandLine","CreationDate","ProcessId"];async function R(e){const t=["process"];if(s.isNotEmpty(e)){const i=s.uniq([...e.filter(d.gt0),r.default.pid]).map((e=>`ProcessId=${e}`)).join(" or ");t.push("where",i)}t.push("get",L.join(","));const i=await v.stdoutResult(b.wmic(),t,_),n=h.onlyReqValued(w.parseFixed(L,i.result).map((e=>({pid:d.toInt(e.ProcessId,{defaultValue:-1}),start:T.wmiDate(e.CreationDate),cmd:f.toS(e.CommandLine)}))));return n.find((e=>e.pid===r.default.pid))||n.push({pid:r.default.pid,start:new Date(M.start),cmd:"node "+r.default.title}),n}function N(e){return w.parseFixed(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],e).map((e=>({pid:d.toInt(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:f.toS(e.COMMAND)})))}t.psWinWmic=R},1058:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.joinPatterns=t.matchQuotes=t.escapeRegExp=t.captures=void 0;const n=i(82798);function r(e){return n.toS(e).replace(/[-.,\\^$*+?()|[\]{}]/g,"\\$&")}t.captures=function(e,t){const i=[];let n;for(;null!=(n=e.exec(t));)n.index===e.lastIndex?e.lastIndex++:i.push([n[1],n.index]);return i},t.escapeRegExp=r,t.matchQuotes=function(e){return e.replace(/[ââ']/g,"[ââ']").replace(/[ââââÂ«Â»ã"]/g,'[ââââÂ«Â»ã"]')},t.joinPatterns=function(e,t){const i=[];for(const t of e)try{new RegExp(t),i.push(t)}catch{i.push(r(t))}return new RegExp(i.join("|"),t)}},4437:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.renice=void 0;const n=i(88491),r=i(43947),s=i(11448),a=i(66776),o=i(82798),l=i(69317),u=i(79015),c=i(7162),d=i(70283),h=i(99312),p=i(86725),m=i(71663),f=i(43414),g=i(31329),y=s.lazy((()=>c.mkLogger("Renice")));r.later((()=>u.onClearCache((()=>{var e;return null===(e=v.prior())||void 0===e?void 0:e.clear()}))));const v=s.lazy((()=>new g.TTLSet(n.minuteMs)));t.renice=async function(e){if(v().has(e))return;v().add(e);const t=f.Settings.processPriority.valueOrDefault;return d.mapGt0(e,(async()=>{try{await(h.isWin?async function(e,t){return d.mapGt0(e,(i=>p.PriorityClasses.mapValid(t,(i=>m.PowerShell.instance().execute(`(Get-Process -Id ${e}).PriorityClass = "${t}"`,(e=>e))))))}(e,t):async function(e,t=19){return l.stdoutResult("renice",[t,"-p",e].map(o.toS),{timeout:10*n.secondMs,isIgnorableError:()=>!0,ignoreExitCode:!0,maxRetries:0})}(e,a.orElse(p.NiceLevel[t],p.NiceLevel.BelowNormal))),y().info("Renice pid "+e+" to "+t)}catch(t){return void y().info("Failed to renice pid "+e,t)}}))}},93138:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundRobin=void 0;const n=i(11944);t.RoundRobin=class{constructor(){this.arr=[],this.iterIdx=0}get size(){return this.arr.length}count(e){return n.count(this.arr,e)}unshift(...e){this.arr.splice(this.iterIdx,0,...e)}push(...e){this.unshift(...e),this.incrIdx(e.length)}remove(e){return this.filterInPlace((t=>t!==e))}filterInPlace(e){let t=!1;return n.filterInPlace(this.arr,((i,n,r)=>{const s=e(i,n,r);return s||(t=!0,n<this.iterIdx&&this.iterIdx--),s})),this.incrIdx(0),t}next(e=(()=>!0)){if(0===this.size)return{value:void 0,done:!0};for(let t=0;t<this.size;t++){const t=this.arr[this.iterIdx];if(this.incrIdx(),null!=t&&e(t))return{value:t,done:!1}}return{value:void 0,done:!0}}toA(e=(()=>!0)){if(n.isEmpty(this.arr))return[];const t=[];for(let i=0;i<this.size;i++){const n=this.arr[(this.iterIdx+i)%this.arr.length];e(n)&&t.push(n)}return t}incrIdx(e=1){this.iterIdx=0===this.arr.length?0:(this.iterIdx+e)%this.arr.length}}},55568:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isStatsDbMigrator=t.isStatsDbClient=t.isWelcomeService=t.isSyncFileService=t.isSyncService=t.isRpcClient=t.isRpcServer=t.isWebService=t.isMainService=t.colorProcessName=t.processName=t.maybeSetServiceName=t.setServiceName=t.serviceName=t.serviceShutdownTimeoutMs=t.title=t.StatsDbServices=t.WelcomeServices=t.DbRequiredServices=t.RpcServerServices=t.serviceNameIndex=t.ServiceNames=void 0;const n=i(61765),r=i(11944),s=i(39938),a=i(88491),o=i(11448),l=i(84253),u=i(82798),c=i(9678),d=i(26302),h=i(7162),p=i(19658);t.ServiceNames=l.strEnum("main","web","sync","sync-file","info","test","logcat","logtail","list","billing"),t.serviceNameIndex=function(e){const i=t.ServiceNames.indexOf(e);return i<0?t.ServiceNames.length+1:i},t.RpcServerServices=["main","test"],t.DbRequiredServices=["sync","sync-file","list"],t.WelcomeServices=r.diff(t.ServiceNames.values,t.DbRequiredServices),t.StatsDbServices=["sync","sync-file"],t.title=function(e){return c.AppName()+" "+e},t.serviceShutdownTimeoutMs=function(e){switch(e){case"main":case"web":return a.minuteMs;case"sync":case"sync-file":default:return 10*a.secondMs}};let m="";function f(){if(s.blank(m))throw Error("serviceName() is unset");return m}function g(e){if(!p.isTest&&e!==m&&""!==m)throw new Error("Cannot set service name twice");m=e,t.processName.unset(),h.setupLogger()}t.serviceName=f,t.setServiceName=g,t.maybeSetServiceName=function(e){if(!p.isTest)throw new Error("Only used by tests");s.blank(m)&&g(e)};const y=o.lazy((()=>[{re:/sync-file|billing/,f:d.cyan},{re:/sync/,f:d.blue},{re:/web/,f:d.green},{re:/db/,f:d.magenta},{re:/main/,f:d.yellow},{re:/info/,f:d.blueBright},{re:/test/,f:d.red}]));function v(){return t.RpcServerServices.includes(f())}function w(){return"sync"===m}function b(){return"sync-file"===m}t.processName=o.lazy((()=>r.compactBlanks([m,u.toS(n.pid)]).join("-"))),t.colorProcessName=function(e){const t=y().find((t=>e.match(t.re)));return null!=t?d.bgBlack(t.f(e)):e},t.isMainService=function(){return m===t.ServiceNames.main},t.isWebService=function(){return m===t.ServiceNames.web},t.isRpcServer=v,t.isRpcClient=function(){return!v()&&"info"!==m},t.isSyncService=w,t.isSyncFileService=b,t.isWelcomeService=function(){return t.WelcomeServices.includes(f())},t.isStatsDbClient=function(){return t.StatsDbServices.includes(f())},t.isStatsDbMigrator=o.lazy((()=>w()||p.isTest&&!b()))},8177:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.diff=t.intersection=t.union=t.getOrAdd=t.setEql=t.asSet=void 0;const n=i(39784);function r(e){return e instanceof Set?e:new Set(n.toA(e))}t.asSet=r,t.setEql=function(e,t){return n.toA(e.keys()).every((e=>t.has(e)))&&n.toA(t.keys()).every((t=>e.has(t)))},t.getOrAdd=function(e,t,i){if(null==t)throw new Error("null key");return e.has(t)?void 0:(e.add(t),i())},t.union=function(e,t){return new Set([...e,...t])},t.intersection=function(e,t){const i=r(t);return new Set([...e].filter((e=>i.has(e))))},t.diff=function(e,t){const i=r(t);return new Set([...e].filter((e=>!i.has(e))))}},70032:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SetSet=void 0;const n=i(21040),r=i(66776),s=i(70283);t.SetSet=class{constructor(){this.store=new Map}add(e,t){n.getOrSet(this.store,e,(()=>new Set)).add(t)}delete(e,t){r.map(this.store.get(e),(i=>{i.delete(t),0===i.size&&this.store.delete(e)}))}find(e){return s.mapGte0(e.findIndex(((t,i)=>{var n;return null===(n=this.store.get(t))||void 0===n?void 0:n.has(e[i+1])})),(t=>e.slice(t,t+2)))}has(e){return null!=this.find(e)}}},25883:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SortedArray=void 0;const n=i(11944),r=i(8199);t.SortedArray=class{constructor(e){this.valueOf=e,this.store=[]}get length(){return this.store.length}add(e){if(null==e)return;const t=this.valueOf(e);if(null!=t)if(0!==this.store.length)if(r.lt(t,this.valueOf(this.store[0])))this.store.unshift(e);else{for(let t=this.store.length-1;t>=0;t--)if(r.gte(this.valueOf(e),this.valueOf(this.store[t])))return void this.store.splice(t+1,0,e);this.store.unshift(e)}else this.store.push(e)}shiftLt(e){if(0===this.length)return[];let t=0;if(r.lt(this.valueOf(n.last(this.store)),e))t=this.store.length;else for(;r.lt(this.valueOf(this.store[t]),e);)t++;return 0===t?[]:this.splice(0,t)}splice(e,t){return this.store.splice(e,t)}}},97198:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.consoleLog=t.stdoutEnded=void 0;const n=i(61765);function r(){return null==n.stdout||n.stdout.destroyed||n.stdout.writableEnded}t.stdoutEnded=r,t.consoleLog=function(e,...t){r()||console.log(e,...t)}},91464:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uniqSubstr=t.stripEmoji=t.stripDiacritics=t.sortNatural=t.sortNaturalBy=t.splitKeep=t.joinEng=t.zipStrings=t.wbrPath=t.stripQuotes=t.dumbquote=t.stripAnsiEsc=t.longestPrefix=t.reverse=t.hasAnyIgnoreCase=t.firstSubstringIgnoreCase=t.startsWithIgnoreCase=t.sortByCaseInsensitive=t.sortIgnoreCase=t.uniqIgnoreCase=t.equalsIgnoreCase=t.compareIgnoreCase=t.capitalize=t.gist=t.stripPreSuff=t.stripSuffix=t.stripPrefixIgnoreCase=t.stripPrefix=t.spliceCapture=t.splitEvery=t.splitFirst=t.trim=t.maybeToS=t.count=t.contains=t.padReplace=t.pad2=t.rightPad=t.leftPad=t.padding=t.wrap=t.newlineRe=t.isString=t.ensureSuffix=t.ensurePrefix=t.ellipsize=void 0;const n=i(11944),r=i(39938),s=i(66776),a=i(75556),o=i(8199),l=i(44726),u=i(39784),c=i(82798),d=i(13779),h=i(62684);var p=i(44726);Object.defineProperty(t,"ellipsize",{enumerable:!0,get:function(){return p.ellipsize}}),Object.defineProperty(t,"ensurePrefix",{enumerable:!0,get:function(){return p.ensurePrefix}}),Object.defineProperty(t,"ensureSuffix",{enumerable:!0,get:function(){return p.ensureSuffix}}),Object.defineProperty(t,"isString",{enumerable:!0,get:function(){return p.isString}}),Object.defineProperty(t,"newlineRe",{enumerable:!0,get:function(){return p.newlineRe}}),Object.defineProperty(t,"wrap",{enumerable:!0,get:function(){return p.wrap}});const m={};function f(e,t){if(t<1)return"";for(null==m[e]&&(m[e]=e);t>m[e].length;)m[e]+=e;return m[e].substring(0,t)}function g(e,t,i){if(0===i.length)throw new Error("leftPad() given empty pad");if("number"==typeof e&&e<0)return"-"+g(String(-e),t-1,i);const n=String(e);return f(i,t-n.length)+n}function y(e,t){if(null==t)return e;const i=c.toS(e),n=c.toS(t);return n.length>0&&i.endsWith(n)?i.slice(0,-n.length):i}function v(e,t){return e.localeCompare(t,void 0,{sensitivity:"base"})}function w(e,t){if(null==e||null==t)return!1;const i=c.toS(e),n=c.toS(t);return i.length===n.length&&(i===n||i.toLowerCase()===n.toLowerCase()||0===i.localeCompare(n,void 0,{sensitivity:"base"})||0===v(i.normalize(),n.normalize()))}function b(e){return e.sort(v)}function S(e,t){return null!=e&&null!=t&&0!==t.length&&0!==e.length&&w(e.substring(0,t.length),t)}t.padding=f,t.leftPad=g,t.rightPad=function(e,t,i){if(0===i.length)throw new Error("rightPad() given empty pad");const n=String(e);return n+f(i,t-n.length)},t.pad2=function(e){return g(e,2,"0")},t.padReplace=function(e,t,i,n){return e.substr(0,t)+f(n,i)+e.substr(t+i)},t.contains=function(e,t,i){return c.toS(e).indexOf(c.toS(t),i)>-1},t.count=function e(t,i,n=0){if(null==i||0===i.length)return 0;const r=t.indexOf(i,n);return-1===r?0:1+e(t,i,r+i.length)},t.maybeToS=function(e){return null==e?void 0:String(e)},t.trim=function(e){return e.map(c.toS).filter((e=>r.notBlank(e)))},t.splitFirst=function(e,t){const i=e.indexOf(t);return-1===i?[e]:[e.slice(0,i),e.slice(i+t.length)]},t.splitEvery=function(e,t,i){const n=Math.min(Math.ceil(e.length/t),s.orElse(i,(()=>e.length)))-1;return n<=0?[e]:[...a.times(n,(i=>e.slice(i*t,(i+1)*t))),e.slice(n*t)]},t.spliceCapture=function(e,t){const i=t.exec(e);if(null==i||null==i[1])return;const n=i[0].indexOf(i[1])+i.index;return{captured:i[1],uncaptured:e.substring(0,n)+e.substring(n+i[1].length),unmatched:e.substring(0,i.index)+e.substring(i.index+i[0].length),matchedIndex:n}},t.stripPrefix=function(e,t){const i=c.toS(e),n=c.toS(t);return n.length>0&&i.startsWith(n)?i.slice(n.length):i},t.stripPrefixIgnoreCase=function(e,t){return S(e=c.toS(e),t=c.toS(t))?e.slice(t.length):e},t.stripSuffix=y,t.stripPreSuff=function(e,t,i){return null==t?y(e,i):(e=c.toS(e)).endsWith(i)&&e.startsWith(t)?e.slice(t.length,-i.length):e},t.gist=function(e,t=80,i=80){const n=c.toS(e),r=n.length-(t+i);return r<=0?n:n.slice(0,t).trim()+" â¦(+"+r+" chars)â¦"+n.slice(-i).trim()},t.capitalize=function(e){return e=c.toS(e),r.blank(e)?e:l.strslice(e,0,1).toLocaleUpperCase()+l.strslice(e,1)},t.compareIgnoreCase=v,t.equalsIgnoreCase=w,t.uniqIgnoreCase=function(e){return n.uniqBy2(e,w)},t.sortIgnoreCase=b,t.sortByCaseInsensitive=function(e,t){return u.toA(e).filter((e=>null!=e)).map(((e,i)=>({item:e,cmp:s.map(t(e,i),(e=>[e,i]))}))).filter((e=>null!=e.cmp)).sort(((e,t)=>{const i=v(e.cmp[0],t.cmp[0]);return 0!==i?i:o.cmp(e.cmp[1],t.cmp[1])})).map((e=>e.item))},t.startsWithIgnoreCase=S,t.firstSubstringIgnoreCase=function(e,t){if(n.isEmpty(e)||r.blank(t))return;for(const i of e)if(w(i,t))return{index:0,match:i};for(const i of e){const e=t.indexOf(i);if(e>=0)return{index:e,match:i}}const i=t.normalize();for(const t of e){{const e=i.indexOf(t);if(e>=0)return{index:e,match:t}}const e=t.normalize();{const t=i.indexOf(e);if(t>=0)return{index:t,match:e}}{const t=i.toLocaleLowerCase(),n=e.toLocaleLowerCase(),r=t.indexOf(n);if(r>=0)return{index:r,match:n}}}},t.hasAnyIgnoreCase=function(e,t){return!n.isEmpty(e)&&!r.blank(t)&&e.some((e=>w(t,e)))},t.reverse=function(e){return null==e?e:[...e].reverse().join("")},t.longestPrefix=function(e,t){return d.greatestBy(t.filter((t=>e.startsWith(t))),(e=>e.length))},t.stripAnsiEsc=function(e){return c.toS(e).replace(/\u001b\[[0-9;]+[a-z]/gi,"")};const M=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function P(e){return M.reduce(((e,[t,i])=>e.replace(t,i)),e).normalize()}t.dumbquote=P;const E=/^(['"]).+\1$/;function T(e,t){const i=[];let n,r=0;for(;null!=(n=t.exec(e));)n.index===t.lastIndex?t.lastIndex++:(t.lastIndex=n[0].length+n.index,i.push(e.substring(r,n.index)),i.push(e.substring(n.index,t.lastIndex)),r=t.lastIndex);return r<e.length&&i.push(e.substring(r)),i.filter((e=>e.length>0))}function x(e){return T(c.toS(e),/\d+(?:\.\d*)?/g).map((e=>s.orElse(a.toFloat(e.trim()),e)))}t.stripQuotes=function(e){return r.blank(e)||(e=c.toS(e).trim(),null!=E.exec(P(e))&&(e=e.slice(1,-1).trim())),e},t.wbrPath=function(e){return e.split(/(?<=[\\/_,:=-]+)/).map((e=>h.escape(e.normalize()))).join("<wbr>")},t.zipStrings=function(...e){let t="";const i=n.compactBlanks(e),r=Math.max(...i.map((e=>e.length)));for(let e=0;e<r;e++)for(let n=0;n<i.length;n++)s.map(i[n],(i=>s.map(i[e],(e=>t+=e))));return t},t.joinEng=function(e){return(e=n.compactBlanks(e)).length<2?e.join(""):e.slice(0,-1).join(", ")+" or "+e[e.length-1]},t.splitKeep=T,t.sortNaturalBy=x,t.sortNatural=function(e){return n.sortBy(e,(e=>x(e)))},t.stripDiacritics=function(e){return c.toS(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"")},t.stripEmoji=function(e){return c.toS(e).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")},t.uniqSubstr=function(e){const t=b(n.compactBlanks(e)),i=t.filter(((e,i)=>!S(t[i+1],e)));return n.sortBy(i,(t=>e.indexOf(t)))}},63774:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.camel2words=t.camel2snake=void 0;const n=i(82798);t.camel2snake=function(e){return n.toS(e).replace(/([A-Z])([a-z])/g,((e,t,i)=>"_"+t.toLowerCase()+i)).replace(/[A-Z]+|[0-9]+/g,(e=>"_"+e)).replace(/^_/,"")},t.camel2words=function(e){return n.toS(e).replace(/([A-Z])([a-z])/g,((e,t,i)=>" "+t.toLowerCase()+i)).replace(/[A-Z]+|[0-9]+/g,(e=>" "+e)).trim()}},2073:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.paddedPositionalDiff=t.positionalDiff=t.lcdiff=t.str=t.radixDiff=t.lnsDiff=t.nonUniqIntersection=t.bigrams=t.diceCoeff=t.hamming=t.lcs=t.commonSubstringRatio=void 0;const n=i(11944),r=i(39938),s=i(75556),a=i(82798),o=i(6231),l=i(70283),u=i(2023),c=i(8177),d=i(91464);function h(e,t){if(null==e)return t;if(null==t)return e;if((e=e.normalize())===(t=t.normalize())||t.includes(e))return e;if(e.includes(t))return t;const i=new l.Array2D(e.length);let n=0,r="";for(let s=0;s<e.length;s++)for(let a=0;a<t.length;a++)e[s]===t[a]&&(0===s||0===a?i.set(s,a,1):i.set(s,a,i.get(s-1,a-1)+1),i.get(s,a)>=n&&(n=i.get(s,a),r=e.substr(s-n+1,n)));return r}function p(e,t){if(null!=e&&null!=t)return e=e.normalize(),t=t.normalize(),e.length!==t.length?void 0:[...e].reduce(((e,i,n)=>i===t.charAt(n)?e:e+1),0)}function m(e,t){const i=e.toUpperCase().normalize(),n=t.toUpperCase().normalize();return u.firstThunk((()=>i===n?1:void 0),(()=>r.blank(e)!==r.blank(t)?0:void 0),(()=>1===e.length&&1===t.length?0:void 0),(()=>{const e=f(i),t=f(n);return 2*g(e,t).length/(e.length+t.length)}))}function f(e){if(null==e||0===e.length)return[];const t=[...e];return t.slice(0,-1).map(((e,i)=>e+t[i+1]))}function g(e,t){const i=c.intersection(e,t),r=[];return i.forEach((i=>{const a=Math.min(n.count(e,(e=>e===i)),n.count(t,(e=>e===i)));s.times(a,(()=>r.push(i)))})),r}function y(e,t,i){const r=n.commonPrefixLength(e,t);return i(e.substr(r))-i(t.substr(r))}function v(e){const t=n.compactBlanks(a.toS(e).split(/[^\d]+/));return n.sortBy(t,(e=>-e.length))[0]}function w(e,t){const[i,n]=[e,t].map(v).map((e=>r.blank(e)?"":e));return y(i,n,(e=>s.toInt(e,{defaultValue:0})))}t.commonSubstringRatio=function(e,t){return[e,t].some(r.blank)?0:h(e,t).length/Math.max(e.length,t.length)},t.lcs=h,t.hamming=p,t.diceCoeff=m,t.bigrams=f,t.nonUniqIntersection=g,t.lnsDiff=w;const b=/[^0-9a-z]+/gi;function S(e,t){const[i,n]=[e,t].map((e=>d.stripDiacritics(e).replace(b,"").toLowerCase()));return y(i,n,(e=>o.RadixAlphaNum.decode(e)))}function M(e,t){let i;for(let n=Math.max(e.length,t.length);n>=0;n--){const r=s.mapNumericOr(e.charCodeAt(n),(e=>e),256),a=s.mapNumericOr(t.charCodeAt(n),(e=>e),256),o=s.clamp(-256,256,r-a);i=null==i?o:(i+o)/2}return i}t.radixDiff=S,t.str=function(e,t){return{pref:n.commonPrefixLength(e,t),ham:p(e,t),dice:m(e,t),lns:w(e,t),radixDiff:S(e,t)}},t.lcdiff=function(e){return n.count([...e.normalize()],(e=>0!==e.toLowerCase().localeCompare(e)))},t.positionalDiff=M,t.paddedPositionalDiff=function(e,t,i=8){return M(d.leftPad(e,i," "),d.leftPad(t,i," "))}},55646:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLArray=void 0;const n=i(75556);class r{constructor(e,t){this.ttlMs=e,this.maxLength=t,this.times=[],this.a=[]}[Symbol.iterator](){this.vacuum();const e=[...this.a];return function*(){for(const t of e)yield t}()}push(...e){n.times(e.length,(()=>this.times.push(Date.now()))),this.a.push(...e),null!=this.maxLength&&this.vacuum()}pushUniq(...e){e.forEach((e=>{this.includes(e)||this.push(e)}))}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;if(null!=this.maxLength){const e=this.a.length-this.maxLength;this.times.splice(0,e),this.a.splice(0,e)}const e=Date.now()-this.ttlMs,t=this.times.findIndex((t=>t>e));-1===t?this.clear():t>0&&(this.times.splice(0,t),this.a.splice(0,t))}}t.TTLArray=r},31329:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLSet=void 0;const n=i(61570);class r{constructor(e){this.ttlMs=e,this.expireListeners=[],this.delegate=new Map,this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,t=this.ttlMs){return this.delegate.set(e,Date.now()+(t-this.ttlMs)),this}addIfMissing(e,t){const i=this.delegate.get(e);return null==i||this.isEntryExpired(e,i)?(this.add(e),t()):void 0}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(const[t,i]of this.delegate)this.isEntryExpired(t,i)||e(t,t,this)}has(e){return!this.isEntryExpired(e,this.delegate.get(e))}values(){const e=this;return function*(){for(const[t,i]of e.delegate.entries())e.isEntryExpired(t,i)||(yield t)}()}entries(){const e=this;return function*(){for(const[t,i]of e.delegate.entries())e.isEntryExpired(t,i)||(yield[t,t])}()}toA(){return this.vacuum(),[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}on(e,t){this.expireListeners.push(t)}isEntryExpired(e,t){return n.tap(null==t||t+this.ttlMs<=Date.now(),(i=>{null!=t&&i&&(this.expireListeners.forEach((t=>t(e))),this.delegate.delete(e))}))}vacuum(){this.delegate.forEach(((e,t)=>{this.isEntryExpired(t,e)}))}}t.TTLSet=r},6646:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.zoneSeemsLegit=t.localTzOffsetMinutes=t.MaxTzOffsetHours=void 0;const n=i(8223),r=i(88491),s=i(11448);t.MaxTzOffsetHours=14,t.localTzOffsetMinutes=s.lazy((()=>n.DateTime.local().offset),r.hourMs),t.zoneSeemsLegit=function(e){return!(null==e||Math.abs(e)>60*t.MaxTzOffsetHours||0===e&&0!==t.localTzOffsetMinutes())}},37086:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uid=void 0;const n=i(12087),r=i(61765),s=i(11448),a=i(59873),o=i(6231);let l=0;const u=s.lazy((()=>a.shortStringSha(n.hostname()+String.fromCharCode(31)+r.pid)+"-"));t.uid=function(){return u()+o.GeoRadix.encode(++l)}},15671:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.userData=void 0;const n=i(85622),r=i(61765),s=i(39938),a=i(47977),o=i(9678);t.userData=function(){return s.notBlankOr(r.env.PS_CONFIG_DIR,(()=>n.resolve(a.appData(),o.AppName())))}},42041:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gitDate=t.gitSha=t.release=t.version=void 0,t.version="1.0.0-alpha.3",t.release="1.0.0-alpha.3+20210411105726",t.gitSha="b3615a432c401bcd45852f6463bc46de618e7090",t.gitDate=new Date(1618163846e3),t.default={version:t.version,release:t.release,gitSha:t.gitSha,gitDate:t.gitDate}},3867:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pwshJsonDate=t.wmiDate=void 0;const n=i(88491),r=i(66776),s=i(75556),a=i(98510),o=i(70283),l=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;t.wmiDate=function(e){const t=l.exec(e);if(null==t)return;const i=t.slice(1,8).map((e=>s.toInt(e)));if(!r.allDefined(i))return;const[a,o,u,c,d,h,p]=i,m=s.toInt(t[8],{defaultValue:0});return new Date(Date.UTC(a,o-1,u,c,d,h,p/1e3)-m*n.minuteMs)};const u=/Date\((\d+)\)/;t.pwshJsonDate=function(e){return a.opt(e).flatMap((e=>u.exec(e))).flatMap((e=>e[1])).flatMap(s.toInt).filter((e=>o.within(0,Date.now()+n.dayMs,e))).map((e=>new Date(e))).get()}},91419:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncFilter=void 0;const n=i(61570),r=i(13779),s=i(26302),a=i(91464),o=i(52132),l=i(46852);class u{constructor(e){this.apply=e}static lift(e){return new u(e)}static and(...e){return new u((async t=>{for(const i of e)if(!await i.apply(t))return!1;return!0}))}static or(...e){return new u((async t=>{for(const i of e)if(await i.apply(t))return!0;return!1}))}static logged(e,...t){return r.flatMap(t,(t=>n.entries(t).map((([t,i])=>i.asAsync().logged(e,t)))))}static andLogged(e,...t){return this.and(...this.logged(e,...t))}static orLogged(e,...t){return this.or(...this.logged(e,...t))}static async andExplain(e,t){const i=[],r=[];for(const s of t)for(const[t,a]of n.entries(s))(await a.apply(e)?i:r).push(t);return{accepted:i,rejected:r}}asAsync(){return this}and(...e){return u.and(this,...e)}not(){return new u((e=>l.thenNot(this.apply(e))))}or(e){return new u((async t=>await this.apply(t)||await e.apply(t)))}async filter(e){return o.filter(e,(e=>this.apply(e)))}logged(e,t){return new u((async i=>{const n=await this.apply(i);return e.log(n?"debug":"info",[s.darkGrey(t),n?s.green("ACCEPT"):s.red("REJECT"),a.ellipsize(i)].join(" ")),n}))}}t.AsyncFilter=u},34996:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0;const n=i(78213),r=i(31669),s=i(16475),a=i(87748),o=i(66776),l=i(46234),u=i(49379),c=i(7162),d=i(91464),h=i(46027);class p{constructor(e){this.name=e,this.start=Date.now(),this.state=l.PromiseStates.pending,this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t})),this.logger=c.mkLogger("Deferred("+this.toString()+")")}toString(){return d.isString(this.name)?this.name:a.stringify(this.name)}[r.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then((e=>{this.resolve(e)})).catch((e=>{this.logger.warn("observeQuietly.reject()",e),this.resolve(void 0)})),this}observe(e){return e.then((e=>{this.maybeResolve(e)})).catch((e=>{this.maybeReject(e)})),this}setTimeout(e){return o.map(this.priorTimeout,n.clearTimeout),this.priorTimeout=h.setUnrefTimeout((()=>{if(this.pending){const e="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(e)}}),e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===l.PromiseStates.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==l.PromiseStates.pending}get resolved(){return this.state===l.PromiseStates.resolved}get rejected(){return this.state===l.PromiseStates.rejected}get settledMs(){return null==this.end?void 0:this.end-this.start}resolve(e){return this.settle((()=>{this.state=l.PromiseStates.resolved,this._value=e,this._resolve(e)}))}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(u.isIgnorableError(e)?"info":"warn",".reject()",e);const t=s.asError(e);return this.settle((()=>{this._error=t,this.state=l.PromiseStates.rejected,this._reject(t)}))}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch((t=>e(t)))}settle(e){if(this.state===l.PromiseStates.pending){o.map(this.priorTimeout,n.clearTimeout),e(),this.end=Date.now();const t=this.settledMs;if(this.resolved&&t>5e3){const e=t>5e3?"info":"debug";this.logger.log(e,"Completed in "+t+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}}t.Deferred=p},36079:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.endEndables=t.end=t.endAll=t.setEnding=t.ending=t.addEndable=t.addLoggerEndable=t.addPostDbEndable=t.addDbEndable=t.addPreDbEndable=t.addServiceEndable=t.addFirstEndable=t.EndableRanks=void 0;const n=i(11944),r=i(88491),s=i(11448),a=i(66776),o=i(84253),l=i(26302),u=i(7799),c=i(7162),d=i(12651),h=i(19658),p=i(70283),m=i(2023),f=i(13317),g=i(46027),y=s.lazy((()=>c.mkLogger(l.magenta("Endable")))),v=new d.MultiMap;g.setUnrefInterval((()=>P()),1*r.minuteMs);const w=5*r.secondMs;function b(e,i){return t.EndableRanks.validOrElse(e,(()=>{throw new Error("internal error: invalid rank "+e)})),v.add(e,i),i}t.EndableRanks=o.strEnum("first","service","predb","db","postdb","logger"),t.addFirstEndable=function(e){return b(t.EndableRanks.first,e)},t.addServiceEndable=function(e){return b(t.EndableRanks.service,e)},t.addPreDbEndable=function(e){return b(t.EndableRanks.predb,e)},t.addDbEndable=function(e){return b(t.EndableRanks.db,e)},t.addPostDbEndable=function(e){return b(t.EndableRanks.postdb,e)},t.addLoggerEndable=function(e){return b(t.EndableRanks.logger,e)},t.addEndable=b;let S=!1;async function M(e,t){const i=await e;if(null==i||i.ended)return;const n=h.isTest&&u.isEnvTrue("SINGLE_SPEC_TESTS")?100:p.firstGt0(t,i.endTimeoutMs,w);return y().debug(i.name+" ending...",{timeoutMs:n}),f.thenOrTimeout(i.end(),n,(()=>y().warn(i.name+".end() timed out")),(()=>y().debug(i.name+".end() completed"))).catch((e=>{m.Try((()=>y().warn(i.name+".end() rejected: "+e)))}))}function P(){v.filterInPlace(((e,t)=>!t.ended)),y().debug("vacuumEndables()",v.entriesArray().map((([e,t])=>[e,t.map((e=>e.name))])))}t.ending=function(){return S},t.setEnding=function(e){if(!h.isTest)throw new Error("cannot set ending");S=e},t.endAll=function(...e){return Promise.all(e.map((e=>M(e))))},t.end=M,t.endEndables=s.lazy((async()=>{const e=h.isSingleSpecTests()?250:void 0;y().info("endEndables()",{isTest:h.isTest,isSingleSpecTests:h.isSingleSpecTests()}),h.isTest||(S=!0),P();for(const i of t.EndableRanks.values){const t=a.orElse(v.get(i),[]);n.isNotEmpty(t)&&(y().debug("endEndables(): ending "+i),await Promise.all(t.map((t=>M(t,e)))))}}))},28807:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EndableInterval=void 0;const n=i(43947),r=i(66776),s=i(75556),a=i(39784),o=i(36079),l=i(95557),u=i(46027);class c extends l.EndableWrapper{constructor(e){super(e.name,(()=>{r.map(this.timer,clearInterval),this.timer=void 0}),r.orElse(e.rank,o.EndableRanks.first),(()=>r.mapOr(e._isEnded,(e=>e()),(()=>!1))),e.endTimeoutMs),this.setup(e)}async setup(e){s.gt0(e.initialDelayMs)&&await n.unrefDelay(e.initialDelayMs),this.ended||(this.timer=u.setUnrefInterval(e.callback,Math.round(e.intervalMs),...a.toA(e.args)))}}t.EndableInterval=c},95557:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EndableWrapper=void 0;const n=i(66776),r=i(7162),s=i(36079),a=i(46852);t.EndableWrapper=class{constructor(e,t,i,n,a){this.name=e,this._isEnded=n,this.endTimeoutMs=a,this.onEnds=[],this._ended=!1,this.logger=r.mkLogger(e),this.onEnds.push(t),s.addEndable(i,this)}get ended(){return n.mapOr(this._isEnded,(e=>e()),(()=>!1))||this._ended}end(){if(!this._ended)return this._ended=!0,a.awaitAll(this.onEnds.map((e=>e())))}}},64975:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstDefinedLater=t.laterPromise=t.Later=void 0;const n=i(38625);var r;(r=t.Later||(t.Later={})).and=async(...e)=>{for(const t of e)if(!n.isTrue(await t()))return!1;return!0},r.or=async(...e)=>{for(const t of e)if(n.isTrue(await t()))return!0;return!1},t.laterPromise=function(e){let t,i;return{promise:new Promise(((e,n)=>{t=e,i=n})),later:async()=>{try{const i=await e();return t(i),i}catch(e){throw i(e),e}}}},t.firstDefinedLater=async function(...e){if(null!=e)for(const t of e){if(null==t)continue;const e=await t();if(null!=e)return e}}},97503:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoizeAsync=void 0;const n=i(87748),r=i(51498);t.memoizeAsync=function(e,t){let i=0;const s=new r.FifoCacheAsync(t),a=t=>(i++,s.getOrSetAsync(n.stringify(t),(async()=>e(t))));return a.clear=e=>{if(null==e)s.clear();else{const t=n.stringify(e);s.deleteIf((e=>t===e))}},a.size=()=>s.size,a.callCount=()=>i,a}},52132:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.apply=t.filter=t.find=t.none=t.some=t.all=t.or=t.and=t.not=t.True=void 0;const n=i(11944),r=i(66776),s=i(46852);t.True=()=>!0,t.not=function(e){return t=>!e(t)},t.and=function(...e){return t=>{for(const i of e)if(!i(t))return!1;return!0}},t.or=function(...e){return t=>{for(const i of e)if(i(t))return!0;return!1}},t.all=function(e,t){for(const i of e)if(!t(i))return!1;return!0},t.some=function(e,t){for(const i of e)if(t(i))return!0;return!1},t.none=function(e,t){for(const i of e)if(t(i))return!1;return!0},t.find=function(e,t){for(const i of e)if(t(i))return i},t.filter=async function(e,t){return null==e||null==t?r.mapOr(e,n.compact,(()=>[])):s.filterAsync(e,t)},t.apply=async function(e,t){return null==e||null==t||await t(e)?e:void 0}},46852:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sortByAsync=t.thenGreatest=t.firstTruePromise=t.firstResolvedDefinedPromise=t.firstDefinedPromise=t.first=t.thenOrElse=t.thenAnd=t.thenMap2Or=t.thenMapOr=t.thenMap2=t.thenNot=t.thenFinally=t.tryAll=t.DefaultTryAllTimeoutMs=t.tryAsync=t.partitionAsync=t.filterAsync=t.mapAsync=t.thenCollectParallel=t.asyncFind=t.thenUniq=t.thenCompact=t.thenFlatten=t.awaitAll=t.allSerial=t.thenDefined=t.rejected=t.resolved=t.resolvedWithin=t.thenMapResolved=t.thenCollectBatched=t.thenMap=void 0;const n=i(11944),r=i(38625),s=i(88491),a=i(43947),o=i(66776),l=i(34601),u=i(26588),c=i(39784),d=i(13779),h=i(2023),p=i(70259),m=i(13317);var f=i(26588);async function g(e){try{return await e,!0}catch(e){return!1}}async function y(e,t,i){if(null==e)return[];const r=n.compact(await e);return n.isEmpty(r)?[]:(await p.withBoundedConcurrency({name:"thenCollectParallel",laters:r.map(((e,i)=>async()=>[await t(e,i),e])),maxConcurrent:i})).filter((([e,t])=>null!=e&&null!=t))}Object.defineProperty(t,"thenMap",{enumerable:!0,get:function(){return f.thenMap}}),t.thenCollectBatched=async function(e,t,i){const n=[];for(const r of d.batches(c.toA(await e),t)){const e=[];for(const t of r)if(null!=t){const i=await t;null!=i&&e.push(i)}for(const t of c.toA(await i(e)))null!=t&&n.push(t)}return n},t.thenMapResolved=async function(e,t){if(null==e)return Promise.resolve(void 0);try{return await u.thenMap(e,t)}catch(e){return}},t.resolvedWithin=function(e,t){return Promise.race([e.then((()=>!0)),a.unrefDelay(t).then((()=>!1))]).catch((()=>!1))},t.resolved=g,t.rejected=async function(e){return!await g(e)},t.thenDefined=async function(e){return null!=await e},t.allSerial=async function(e){const t=[];for(const i of n.compact(e))t.push(await i());return n.compact(t)},t.awaitAll=async function(e){const t=n.compact(e);n.isNotEmpty(t)&&await Promise.all(t)},t.thenFlatten=async function(e){const t=[];for(const i of c.toA(await e)){const e=await i;if(null!=e)if(Array.isArray(e))for(const i of e){const e=await i;null!=e&&t.push(e)}else t.push(e)}return t},t.thenCompact=async function(e){const t=n.compact(await e);return n.isEmpty(t)?[]:n.compact(await Promise.all(t))},t.thenUniq=async function(e){const t=[];for(const i of c.toA(await e)){const e=await i;null!=e&&t.push(e)}return n.uniq(t)},t.asyncFind=async function(e,t){for(const i of e)if(await t(i))return i},t.thenCollectParallel=y,t.mapAsync=async function(e,t,i){return(await y(e,t,i)).map((e=>e[0]))},t.filterAsync=async function(e,t,i){return(await y(n.compact(e),t,i)).filter((([e])=>e)).map((([,e])=>e))},t.partitionAsync=async function(e,t){const i=await y(e,t);return[i.filter((([e])=>r.isTrue(e))).map((([,e])=>e)),i.filter((([e])=>r.isFalse(e))).map((([,e])=>e))]},t.tryAsync=async function(e){try{return await e()}catch{return}},t.DefaultTryAllTimeoutMs=30*s.secondMs,t.tryAll=async function(e,i=(e=>console.error(e)),n=t.DefaultTryAllTimeoutMs){for(const t of e)try{await m.thenOrTimeout(t,n)}catch(e){i(e)}},t.thenFinally=async function(e,t=(()=>{}),i=(()=>{})){let n,r=null;try{n=await(l.isFunction(e)?e():e)}catch(e){r=e;try{await t(e)}catch{}}try{await i(null!=r?r:n)}catch{}if(null!=r)throw r;return n},t.thenNot=async function(e,t=!0){if(null==e)return t;const i=await e;return null==i?t:!r.isTrue(i)},t.thenMap2=async function(e,t,i){const n=await e;if(null==n)return;const r=await t;return null!=r?i(n,r):void 0},t.thenMapOr=async function(e,t,i){const n=await e;if(null==n)return i();const r=await t(n);return null==r?i():r},t.thenMap2Or=async function(e,t,i,n){const r=await e;if(null==r)return n();const s=await t;if(null==s)return n();const a=await i(r,s);return null==a?n():a},t.thenAnd=async function(e,t){return null!=e&&r.isTrue(await e)?t():void 0},t.thenOrElse=async function(e,t){return o.orElse(await e,t)},t.first=async function(e,t){if(null!=e){let i=-1;for(const n of e){i++;try{if(null==n)continue;const e=await t(n,i);if(null!=e)return e}catch{}}}},t.firstDefinedPromise=async function(e,t=h.identity){for(const i of e){const e=await i();if(null!=e){const i=await t(e);if(null!=i)return i}}},t.firstResolvedDefinedPromise=async function(e,t){for(const i of e)try{const e=await i();if(null!=e)return e}catch(e){t(e)}},t.firstTruePromise=async function(e,...t){for(const i of t)try{const t=await i();if(null!=t&&!0===await e(t))return t}catch(e){}},t.thenGreatest=async function(e,t){return o.map(d.greatestBy(await y(e,t),(e=>e[0])),(e=>e[1]))},t.sortByAsync=async function(e,t){return n.sortBy(await y(e,t),(e=>e[0])).map((e=>e[1]))}},7383:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timedLazy=t.timeReport=t.timeStats=t.time=t.mkElapsed=t.PromiseTimer=void 0;const n=i(11944),r=i(88491),s=i(11448),a=i(21040),o=i(75556),l=i(61570),u=i(98510),c=i(94383),d=i(70403),h=i(7162),p=i(60346),m=i(36079),f=i(95557);class g{constructor(){this.errors=new c.CountingSet,this.times=new Map}async time(e,t,i){const n=Date.now();try{const s=await t(),a=Date.now()-n;return null!=i&&i(s,a),this.push(e,a),a>2*r.secondMs&&h.mkLogger("time("+e+")").warn("slow",{elapsed:a}),s}catch(t){throw this.errors.incr(e),null!=i&&i(t,Date.now()-n),t}}get entriesBySumDesc(){return n.sortBy([...this.times.entries()],(([,e])=>-e.sum))}stats(e){const t=this.entriesBySumDesc.filter((([t])=>t.startsWith(e))),i=t.reduce(((e,t)=>p.Average.merge(t[1],e)),new p.Average),n=t.map((([e,t])=>[e,t.stats()]));return l.fromEntries([["merged",i.stats()],...n])}mkElapsed(e){return new d.Elapsed(e,((e,t)=>this.push(e,t)))}push(e,t){t>15&&a.getOrSet(this.times,e,(()=>new p.Average)).push(t)}weightedAvg(e){return u.opt(this.times.get(e)).map((e=>e.weightedSampleAvg)).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce(((e,[t,i])=>({...e,[t]:i.n})),{})}weightedAvgs(){return l.compactValues([...this.times.entries()].reduce(((e,[t,i])=>({...e,[t]:o.mapFinite(i.weightedSampleAvg,o.round)})),{}))}report(){return this.entriesBySumDesc.reduce(((e,[t,i])=>({...e,[t]:{sumSec:o.sigFigs(i.sum/r.secondMs,3),...l.omit(i.stats(),"sum")}})),{})}}t.PromiseTimer=g;const y=s.lazy((()=>l.tap(new g,(e=>new f.EndableWrapper("PromiseTimer",(()=>{const t=h.mkLogger("PromiseTimer");t.info("timings:\n",e.report()),n.mapNotEmpty(e.errorCounts(),(e=>t.warn("error counts:\n",e)))}),m.EndableRanks.service)))));function v(e,t,i){return y().time(e,t,i)}t.mkElapsed=function(e){return y().mkElapsed(h.mkLogger(e))},t.time=v,t.timeStats=function(e){return y().stats(e)},t.timeReport=function(){return y().report()},t.timedLazy=function(e,t,i){return s.lazy((async()=>v(e,t)),i)}},70259:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.withBoundedConcurrency=t.serially=t.maybeRun=t.oneRunAtATime=t.Promises=void 0;const n=i(11944),r=i(6314),s=i(75556),a=i(34601),o=i(60346),l=i(59387),u=i(34996);class c{constructor(){this._pushCount=0,this.lastPushTs=0,this._arr=[],this.nextSettledLatches=[],this.serialLatencyAvg=new o.Average,this.applyListeners=[]}get arr(){return n.filterInPlace(this._arr,(e=>e.pending)),this._arr}get pushCount(){return this._pushCount}onApply(e){this.applyListeners.push(e)}_emitApply(e){for(const t of this.applyListeners)t(e)}push(e,t){return this._emitApply(e),this._push(e,t)}_push(e,t){this._pushCount++,this.lastPushTs=Date.now();const i=a.isFunction(t)?t():t;return this.arr.push(new u.Deferred(e).observeQuietly(i).finally((()=>this.emitSettled()))),i}emitSettled(){for(const e of this.nextSettledLatches)e.resolve();this.nextSettledLatches.length=0}awaitNextSettled(){const e=new r.Latch;return this.nextSettledLatches.push(e),e}serial(e,t){const i=Date.now();return this._push(e,this.awaitAll().then((()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),t()))))}serialByName(e,t){const i=Date.now();return this._push(e,this.awaitAllByName(e).then((()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),t()))))}oneRunAtATime(e,t){return this.pending?this.awaitAll():this.serial(e,t)}maybeRun(e,t){return this.maybeRunConcurrent(e,t,1)}maybeRunConcurrent(e,t,i=l.maxCpus()){return this.pendingCount>=i?void 0:this.push(e,t)}get pendingCount(){return n.count(this._arr,(e=>e.pending))}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map((e=>e.name))}get settled(){return 0===this.arr.length}async awaitAll(){for(const e of[...this.arr])await e.promise}async awaitAllByName(e){for(const t of[...this.arr])t.name===e&&await t.promise}async pushAll({name:e,laters:t,maxConcurrent:i=l.maxCpus()}){i=s.clamp(1,2*l.maxCpus(),i);const n=[];for(const r of t){for(;this.pendingCount>=i;)await this.awaitNextSettled();n.push(this.push(e,r))}return Promise.all(n)}}t.Promises=c,t.oneRunAtATime=function(e,t){const i=new c;return()=>i.oneRunAtATime(e,t)},t.maybeRun=function(e,t){const i=new c;return()=>i.maybeRun(e,t)},t.serially=function(e,t){const i=new c;return()=>i.serial(e,t)},t.withBoundedConcurrency=async function({name:e,laters:t,maxConcurrent:i}){return(new c).pushAll({name:e,laters:t,maxConcurrent:i})}},46027:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setUnrefInterval=t.setUnrefTimeout=void 0;const n=i(78213),r=i(61570);t.setUnrefTimeout=function(e,t,...i){return r.tap(n.setTimeout(e,Math.round(t),...i),(e=>e.unref()))},t.setUnrefInterval=function(e,t,...i){return r.tap(n.setInterval(e,Math.round(t),...i),(e=>e.unref()))}},2234:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tryWithErrorHandling=void 0;const n=i(10408),r=i(13317);t.tryWithErrorHandling=async function(e,t){try{return await(null==t.timeoutMs?e():r.thenOrTimeout(e,t.timeoutMs,(()=>n.onError(t.message+": timeout",void 0,t.context))))}catch(e){return void n.onError(t.message,e,t.context)}}},13317:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenOrTimeout=void 0;const n=i(41135),r=i(43947);t.thenOrTimeout=async function(e,t,i=(()=>{}),s=(()=>{})){let a,o=!1,l=!1;return await Promise.race([n.asPromise(e).then((e=>l?void 0:(a=e,o=!0,e))),r.unrefDelay(t).then((()=>{o||(l=!0)}))]),o?await s(a):await i(),a}},21142:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.untilTrue=t.until=void 0;const n=i(38625),r=i(43947),s=i(66776),a=i(75556),o=i(34601),l=i(23175);async function u(e,{timeoutMs:t,timeBetweenMs:i,acceptable:u,timeoutResult:c,unref:d}){const h=null==t?void 0:t+Date.now();for(;null==h||Date.now()<h;){const t=Date.now(),c=await e();if(null!=c&&(o.isFunction(u)?u(c):!1!==c))return c;{const e=Date.now()-t,o=s.orElse(i,(()=>a.clamp(100,5e3,e*l.randomInt(4,10))));await(n.isFalse(d)?r.delay(o):r.unrefDelay(o))}}return c}t.until=u,t.untilTrue=async function(e,t){return u(e,{...t,acceptable:e=>n.isTrue(e),timeoutResult:!1})}},10347:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.childEnv=t.spawnOptions=t.childEnvSettings=t.sanitizedEnv=t.settingsForChildProcs=t.psenv=void 0;const r=n(i(61765)),s=i(43947),a=i(11448),o=i(66776),l=i(61570),u=i(92507),c=i(19658),d=i(2023),h=i(99312),p=i(43414),m=a.lazy((()=>new Set(l.values(p.Settings).map((e=>e.key)))));function f(){t.settingsForChildProcs.unset()}t.psenv=function(){const e=m();return l.sortedKeys(l.filter(r.default.env,(t=>"NODE_ENV"===t||e.has(t))))},t.settingsForChildProcs=a.lazy((()=>p.persistedSettings().filter((e=>e.hasValue()))));const g=a.lazy((()=>{try{return new RegExp(p.Settings.sensitiveEnvRegExp.valueOrDefault,"i")}catch(e){return console.error(`Invalid setting for "sensitiveEnvRegExp": ${e}. Using default value.`),new RegExp(p.Settings.sensitiveEnvRegExp.defaultValue,"i")}}));function y(){return t.settingsForChildProcs().reduce(((e,t)=>t.maybeAddToEnv(e)),{NODE_ENV:c.nodeEnv,...h.isDocker()?{PS_IS_DOCKER:"1"}:{},...h.isElectron?{ELECTRON_RUN_AS_NODE:"1"}:{}})}function v(e,i){const n=l.compactValues({...t.sanitizedEnv(),PATH:p.pathWithDefaults(),...i?u.childProcLocale():{},...y(),...o.orElse(e,{})});return p.Settings.logStdout.deleteFromEnv(n),p.Settings.tailLogs.deleteFromEnv(n),n}s.later((()=>{p.Settings.sensitiveEnvRegExp.addListener((()=>{g.unset(),t.sanitizedEnv.unset()}));for(const e of p.persistedSettings())e.addListener(f)})),t.sanitizedEnv=a.lazy((()=>{const e=g();return d.mapEntries(r.default.env,((t,i)=>null!=e.exec(t)?void 0:i))})),t.childEnvSettings=y,t.spawnOptions=function(e){const t=o.orElse(e,{}),i=o.orElse(t.forceCLocale,!0);return{...l.omit(t,"forceCLocale"),env:v(t.env,i),detached:!1,shell:!1}},t.childEnv=v},69317:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.execStdout=t.stdout=t.stdoutResult=t.execFile=t.spawn=t.niceable=t.endProcess=t.waitForExit=void 0;const r=n(i(63129)),s=n(i(61765)),a=i(92585),o=i(39938),l=i(88491),u=i(43947),c=i(87748),d=i(11448),h=i(66776),p=i(75556),m=i(61570),f=i(34601),g=i(82798),y=i(34996),v=i(46852),w=i(46027),b=i(21142),S=i(10408),M=i(49379),P=i(83837),E=i(95976),T=i(7162),x=i(19658),D=i(2023),C=i(92661),k=i(99312),I=i(4437),F=i(91464),O=i(10347),A=d.lazy((()=>T.mkLogger("ChildProcess")));function _(e){return m.pick(e,"pid","killed","connected","exitCode","signalCode")}function L(e,t){return b.untilTrue((()=>v.thenNot(C.pidExists(e))),{timeoutMs:t})}async function R(e,t=30*l.secondMs){if(null==e)return!1;const i=e.pid;if(A().debug("endProcess("+i+")",{killed:e.killed,connected:e.connected}),i<=0)return A().warn("endProcess(): asked to end invalid pid",_(e)),!1;if(i===s.default.pid)return A().warn("endProcess(): asked to end MY pid",_(e)),!1;await u.delay(250),await P.closeStreams(e);{const t=e.kill();A().debug("endProcess("+i+")",{killResult:t,childGotSigterm:e.killed}),t||await C.killPid(i).catch((e=>{A().warn("endProcess(): kill("+i+",false) failed: "+e)}))}if(D.Try((()=>e.unref())),x.isSingleSpecTests())return!0;if(await L(i,t))return A().debug("endProcess(): exitted",_(e)),!0;{C.Pids.instance().onKill(i);const t=e.kill("SIGKILL");A().warn("endProcess("+i+") had to resort to SIGKILL",{killResult:t}),t||await C.killPid(i,!0).catch((e=>{A().warn("endProcess(): kill("+i+",true) failed: "+e)}))}return L(i,5e3)}function N(e,t){return"renice"!==e&&"which"!==e&&"where"!==e&&[e,...t].every((e=>!e.endsWith("web.js")&&!e.endsWith("db.js")&&!e.includes("sqlite3")))}function B(e,t,i,n){const r=new Date;let a=!1;e.on("exit",(()=>a=!0));const o=N(t,i);return w.setUnrefTimeout((async()=>{if(a)return;await b.untilTrue((()=>p.gt0(e.pid)),{timeoutMs:5*l.secondMs});const i=e.pid;return p.gt0(i)?(o&&await I.renice(i),C.addPid({pid:i,cmd:t,maxAgeMs:n,ppid:s.default.pid},r)):void A().info("newProc(): not writing pidfile, child_process has no pid",{cmd:t,cp:_(e)})}),k.isWin?500:250),e}function j(e,t,i,n){const s=O.spawnOptions(n);return E.isLogged("trace",A().context)?A().debug("execFile()",{command:e,args:t,maxAgeMs:i,opts:s}):A().debug("execFile()",{command:e,args:t,maxAgeMs:i}),B(r.default.execFile(e,t,s),e,t,i)}async function z(e,t,i){return a.retryOnReject((()=>async function(e,t,i){var n,r,s;const a=h.orElse(i.quiet,!1),o=h.orElse(i.ignoreStderr,!1),l=h.orElse(i.ignoreExitCode,!1),u=[];A().debug("stdoutResult(): execFile",{cmd:e,args:t});const d=await j(e,t,i.timeout,m.omit(i,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(!0===i.disconnect)return d.disconnect(),{result:"",pid:d.pid};const p=c.stringify({cmd:e,args:t}),v=new y.Deferred(p);setTimeout((()=>{v.pending&&A().warn("stdoutResult(): SLOW COMMAND",{cmd:e,args:t})}),i.timeout/3).unref(),v.setTimeout(i.timeout);const w=(n,r)=>{M.isIgnorableError(r)||f.isFunction(i.isIgnorableError)&&i.isIgnorableError(r)?A().debug("stdoutResult(): ignorable error for "+n,{cmd:e,args:t,opts:i,error:r}):(null!=d.pid&&R(d),a||A().warn("stdoutResult(): "+n,{cmd:e,args:t,opts:i,error:r}),v.pending&&v.reject(r))};try{d.on("error",(e=>w("on(error)",e))),d.on("close",(i=>{const n=Date.now()-v.start,r=0!==i?"warn":"debug",s=u.join("");a||A().log(r,"stdoutResult(): on(close)",{cmd:e,code:i,args:t,elapsedMs:n,result:F.gist(s,160,160)}),l||0===i?v.resolve({result:s,code:h.denull(i),pid:d.pid}):v.reject(new Error("non-zero exit code: "+c.stringify({code:i,cmd:e,args:t})))})),P.endStream(d.stdin),null===(n=d.stdout)||void 0===n||n.on("data",(e=>{null!=e&&u.push(e)})),null===(r=d.stderr)||void 0===r||r.on("error",(e=>w("stderr(error)",e))),null===(s=d.stderr)||void 0===s||s.on("data",(e=>o?A().warn("stdoutResult(): stderr(data): "+g.toS(e)):w("stderr(data)",e)))}catch(e){w("try/catch",e)}return await v.promise}(e,t,i)),{timeoutMs:i.timeout,maxRetries:h.orElse(i.maxRetries,3),onRetryWaitUntil:e=>u.unrefDelay(100*e),errorIsRetriable:i=>A().tap({msg:"stdoutResult.errorIsRetriable()",result:S.errorContains(i,/EPERM/),meta:{error:i,cmd:e,args:t}})})}t.waitForExit=L,t.endProcess=R,t.niceable=N,t.spawn=function(e,t,i,n){const s=O.spawnOptions(n);return A().debug("spawn()",{command:e,args:t,maxAgeMs:i,opts:s}),B(r.default.spawn(e,t,s),e,t,i)},t.execFile=j,t.stdoutResult=z,t.stdout=function(e,t,i){return z(e,t,i).then((e=>e.result))},t.execStdout=function(e){return new Promise(((t,i)=>{r.default.exec(e,((e,n,r)=>null!=e?i(e):o.notBlank(r)?i(r):t(n)))}))}},95237:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChildService=t.nodeArgs=t.inspectPort=t.pathToService=t.ChildServiceExitCommand=void 0;const n=i(61765),r=i(78213),s=i(11944),a=i(39938),o=i(88491),l=i(11448),u=i(66776),c=i(61570),d=i(34601),h=i(39784),p=i(82798),m=i(13779),f=i(34996),g=i(36079),y=i(70259),v=i(46027),w=i(10408),b=i(49379),S=i(98462),M=i(7162),P=i(99312),E=i(43414),T=i(91464),x=i(53719),D=i(69317),C=i(1315),k=i(95298);t.ChildServiceExitCommand="--exit";const I=l.lazy((()=>M.mkLogger("ChildService")));async function F(e){const t=T.ensureSuffix(e,".js"),i=S.BaseFile.projectRoot(),r=S.BaseFile.for(n.cwd()),s=P.isPacked?[i.join("bin",t),i.join("app.asar",t)]:[r.join("dist","library",t),r.join("lib","library",t)];s.push(r.join("dist","app",t));const a=m.firstAsync(s,(async e=>await e.isNonEmpty(101)?e:void 0));return I().tap({msg:"pathToService()",level:"info",result:a,meta:{cmd:t,isPacked:P.isPacked,dirs:s.map(p.toS)}})}t.pathToService=F;let O=0;function A(e){switch(e){case"web":return 9223;case"sync":return 9224;case"sync-file":return 9225+O++%20;default:return 9222}}function _(e){const t=[];return E.Settings.inspect.valueOrDefault&&t.push("--inspect="+A(e)),t}t.inspectPort=A,t.nodeArgs=_;class L{constructor(e,i,r){this.cmd=i,this.opts=r,this.restartCount=0,this.healthCheck=y.serially("ChildService.healthCheck",(async()=>{if(g.ending()||this.ended)return;if(this.logger.debug("healthCheck(): running..."),d.isFunction(this.opts.healthy)&&!1===await this.opts.healthy())return void await this.restart();const e=this._lastStatus=new f.Deferred(this.name+" healthCheck at "+new Date).setTimeout(x.CmdTimeoutMs);e.promise.catch((e=>(w.onError("healthCheck for "+this.name+": failed",e),this.restart()))),await this.write("--status")||e.resolve(C.fullhc({fail:["write --status failed"]}));try{const t=await e.promise,i=C.errors(t);return s.isNotEmpty(i)?(this.logger.warn("healthCheck for "+this.name+": unhealthy"+b.DoNotSendErrorFlag+b.HealthCheckErrorFlag+", restarting ("+i.join(",")+")"),void await this.restart()):(this.logger.debug("healthCheck: all is well",t),t)}catch(e){return void this.logger.warn("healthCheck: failed",e)}})),this.name="ChildService("+e+")",this.logger=M.mkLogger(this.name);const a=[...h.toA(r.nodeArgs),i.nativePath];s.isNotEmpty(r.args)&&a.push(...r.args),this.spawnOpts=c.pick(this.opts,"argv0","cwd","detached","env","gid","shell","stdio","timeout","uid","windowsHide","windowsVerbatimArguments","forceCLocale"),this.spawnOpts.forceCLocale=!1,this.wc=new k.WatchedChild({name:e,childFactory:async()=>(this.restartCount>0&&null!=this.opts.onPreRestart&&await this.opts.onPreRestart(),this.restartCount++,D.spawn(n.execPath,a,-1,this.spawnOpts)),endableRank:g.EndableRanks.service,onStdout:this.onStdout.bind(this),onError:u.orElse(this.opts.onError,(()=>e=>!b.isIgnorableError(e))),ignoreStopErrors:!1,exitCommand:t.ChildServiceExitCommand,...r}),this.healthCheckTimer=v.setUnrefInterval((()=>this.healthCheck()),o.minuteMs),g.addFirstEndable(this)}static async mk(e,t={}){const i=u.orElse(t.pathToService,await F(e));if(a.blank(i))throw new Error("Failed to find path to "+e);return t.nodeArgs=[..._(e),...h.toA(t.nodeArgs)],new L(e,i,t)}get startMs(){return this.wc.startMs}async onStdout(e){if(!a.blank(e))try{const t=JSON.parse(e);if(a.notBlank(t.fatal))this.wc.onError(this.name+".onStdout()",t.error);else if(null!=t.healthChecks){const e=this._lastStatus;null!=e&&e.pending&&e.resolve({...t.healthChecks,ts:Date.now()})}else null!=this.opts.onData&&this.opts.onData(t)}catch(t){console.log(e)}}start(){return this.wc.start()}stop(){return this.wc.stop()}restart(e){return this.wc.restart(e)}get ended(){return this.wc.ended}async end(){return r.clearInterval(this.healthCheckTimer),this.wc.ended||await this.write("--quit"),this.wc.end()}get pid(){return this.wc.pid}get msSinceLastStart(){return this.wc.msSinceLastStart}running(){return this.wc.running()}notRunning(){return this.wc.notRunning()}async write(e,t=2){if(t<0)return this.logger.warn("write(): no more retries",{toStdin:e}),!1;try{const t=this.wc.proc;return null!=t&&null!=t.stdin&&t.stdin.writable?t.stdin.write(T.ensureSuffix(e,"\n")):(this.logger.warn("write(): childProc isn't open, ignoring",{toStdin:e}),!1)}catch(i){return this.logger.warn("write(): caught "+i),await this.wc.onError("onStdout()",i),this.write(e,t-1)}}}t.ChildService=L},1315:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.concatHealthChecks=t.uniqhc=t.fullhc=t.warnings=t.errors=t.hasFail=t.hasBad=t.hasWarn=void 0;const n=i(11944),r=i(39784);function s(e){return null!=e&&n.isNotEmpty(e.bad)||a(e)}function a(e){return null!=e&&n.isNotEmpty(e.fail)}t.hasWarn=function(e){return null!=e&&n.isNotEmpty(e.warn)||s(e)},t.hasBad=s,t.hasFail=a,t.errors=function(e){return n.uniq([...r.toA(null==e?void 0:e.bad),...r.toA(null==e?void 0:e.fail)])},t.warnings=function(e){return n.uniq([...r.toA(e.warn),...r.toA(e.bad),...r.toA(e.fail)])},t.fullhc=function(e){return{ok:r.toA(e.ok),warn:r.toA(e.warn),bad:r.toA(e.bad),fail:r.toA(e.fail)}},t.uniqhc=function(...e){const t=n.compact(e);return{ok:n.uniq(n.flatten(t.map((e=>e.ok)))),warn:n.uniq(n.flatten(t.map((e=>e.warn)))),bad:n.uniq(n.flatten(t.map((e=>e.bad)))),fail:n.uniq(n.flatten(t.map((e=>e.fail))))}},t.concatHealthChecks=function(...e){function t(t){return n.uniq(n.compact(n.flatten(e.map(t))))}return e=n.compact(e),{ok:t((e=>e.ok)),warn:t((e=>e.warn)),bad:t((e=>e.bad)),fail:t((e=>e.fail))}}},95298:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchedChild=t.mkBasicWatchedChild=void 0;const n=i(11944),r=i(39938),s=i(88491),a=i(16475),o=i(11448),l=i(66776),u=i(75556),c=i(98510),d=i(82798),h=i(36079),p=i(46852),m=i(70259),f=i(80294),g=i(10408),y=i(49379),v=i(79141),w=i(45512),b=i(83837),S=i(7162),M=i(69547),P=i(2023),E=i(92661),T=i(55568),x=i(43414),D=i(91464),C=i(69317);t.mkBasicWatchedChild=function(e){return new k({name:n.compact([e.cmd,...e.args]).join(" "),childFactory:()=>C.spawn(e.cmd,e.args,30*s.minuteMs),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0,...e})};class k{constructor(e){this.startMs=Date.now(),this._stopped=!1,this.logger=o.lazy((()=>S.mkLogger("WatchedChild("+n.compact([this.name,this.pid]).join(":")+")"))),this.startRate=new M.Rate(2*s.minuteMs),this.mutex=new m.Promises,this._ended=!1,this.onError=async(e,t)=>{const i=y.isFatalError(e)||y.isFatalError(t),n=new v.WrappedError({message:e+l.map(t,a.errorToS),cause:a.isError(t)?t:void 0}),r=y.isIgnorableError(n),s={src:e,fatal:i,ignorable:r,errToS:a.errorToS(t)};if(this.logger().log(r?"warn":"error","onError()",s),!this._ended&&!r)return this.lastError=n,g.onError(e,n),i?this.end():this.opts.onError(e,t)?(this.logger().warn("onError requested restart",s),this._restart()):void 0},this.name=e.name,this.opts={dataSep:"\n",maxErrorsPerMinute:3,endableRank:h.EndableRanks.first,exitCommand:"",restartOnExit:!0,...e},this.endTimeoutMs=T.serviceShutdownTimeoutMs(this.name),h.addEndable(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}async end(){return this._ended=!0,this._stop()}get proc(){return this.cp}get pid(){return l.map(this.cp,(e=>e.pid))}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return l.mapOr(this.pid,(e=>E.pidExists(e)),(async()=>!1))}notRunning(){return p.thenNot(this.running())}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,(()=>(this._stopped=!0,this._stop())))}async _stop(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});const e=this.cp;return this.cp=void 0,null==e||this.stopChild(e)}async stopChild(e){return await c.opt(this.opts.exitCommand).filter(r.notBlank).flatMap((t=>c.opt(e).flatMap((e=>e.stdin)).filter((e=>e.writable)).forEach((e=>P.Try((()=>e.write(t+"\n"))))).map(b.endStream).get())),C.endProcess(e,this.endTimeoutMs)}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:u.gt(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){return this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),!this._ended&&!h.ending()&&(!e&&this.startRate.msSinceLastEvent<x.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault?void this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:x.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault}):this.mutex.serial(`WatchedChild(${this.name}).restart`,(async()=>(await this._stop(),this._stopped=!1,this._start()))))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,(async()=>(this._stopped=!1,this._start())))}async _restart(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,(async()=>{var e,t;return await this._stop(),!this._stopped&&!this._ended&&(this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),f.isRecentMs(this.startMs,x.Settings.probationMs.valueOrDefault)&&g.onError("Can't restart "+this.name+", failure rate is too high."+y.FatalErrorFlag,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),null===(t=(e=this.opts).onRestart)||void 0===t||t.call(e),this._start()))}))}async _start(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended)return!1;if(await this.running())return!1;this.startRate.onEvent();const e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);const t="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach((({o:e,desc:i})=>{l.map(e,(e=>e.on("error",(e=>this.onError(t+i+".on(error)",e)))))})),l.map(this.cp.stdout,(e=>w.onDataChunked(e,this.opts.dataSep,(e=>{this.logger().trace("onDataChunked()",e),this.opts.onStdout(e)})))),l.map(this.cp.stderr,(e=>e.on("data",(e=>{var i,n;d.toS(e).includes("Error: Cannot find module")&&g.onError("Failed to start "+this.name+y.FatalErrorFlag,new Error(D.ellipsize(e,256))),!0===(null===(n=(i=this.opts).onStderr)||void 0===n?void 0:n.call(i,e))&&this.onError(t+".stderr.on(data)",e)})))),this.cp.on("exit",(async(e,t)=>{this.logger().info("onExit",{code:e,signal:t,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?(await this._restart(),this.logger().info("onExit(): finished setting up new child "+this.pid)):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending "+this.pid),this.end())})),!0}}t.WatchedChild=k},37980:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CLI=void 0;const n=i(70647),r=i(61765),s=i(55568),a=i(42041),o=i(39938),l=i(66776),u=i(99312),c=i(79682);t.CLI=class{constructor(e,t,i){this.serviceName=e,this.args=t,this.additionalDescription=i,this.plugins=[],s.setServiceName(e)}add(...e){return this.plugins.push(...e),this}async parse(){var e;let t=c.addFooter(n.program.description(c.CliDesc[this.serviceName]+o.mapNotBlankOr(this.additionalDescription,(e=>"\n\n"+e),(()=>""))));l.map(this.args,(e=>{t=t.arguments(e)}));for(const e of this.plugins)t=e.beforeParse(t);t.version(a.version,"--version","Output the version number (spoiler: it's "+a.version+")"),await t.parse(r.argv,{from:u.isMainElectron?"electron":"node"});const i=t.opts();for(const t of this.plugins)await(null===(e=t.afterParse)||void 0===e?void 0:e.call(t,i));return t}}},79682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addFooter=t.CliDesc=t.descriptionFooter=void 0;const n=i(61765),r=i(44726),s=(new Date).getFullYear();t.descriptionFooter=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.\n\nCopyright Â© 2017-${s}, PhotoStructure Inc.\n\nRunning this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,t.CliDesc={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",info:"Configuration, file metadata and import diagnostics tool.",list:"List paths in a Library.",logcat:"Chronologically sort and pretty-print PhotoStructure logfiles.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."},t.addFooter=function(e){return e.on("--help",(()=>{var e;console.log("\n"+r.wrap(t.descriptionFooter,{maxLineLen:null!==(e=n.stdout.columns)&&void 0!==e?e:78,prefix:""}).join("\n")+"\n")}))}},85297:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isDaemon=void 0;const r=n(i(61765)),s=i(38625),a=i(39938);t.isDaemon=function(e){return s.isTrue(r.default.env.__is_daemon)||s.isTrue(null==e?void 0:e.daemon)||!a.blank(null==e?void 0:e.pidfile)}},99641:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogArgs=void 0;const n=i(38625),r=i(43414),s=i(66776),a=i(85297);t.LogArgs={beforeParse:(e,t=!1)=>(e.option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.'),t||e.option("--info|--verbose",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.'),e.option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.').option("--color","Enable ASCII terminal colors",!0).option("--no-color","Disable ASCII terminal colors"),e),afterParse:e=>{s.map(e.color,(e=>r.Settings.logColor.tmpValue=e));const t=n.isTrue(e.warn),i=n.isTrue(e.info)||n.isTrue(e.verbose),o=n.isTrue(e.debug);t&&(r.Settings.logLevel.tmpValue="warn"),i&&(r.Settings.logLevel.tmpValue="info"),o&&(r.Settings.logLevel.tmpValue="debug"),!a.isDaemon(e)&&(t||i||o)&&(r.Settings.logStdout.tmpValue=!0)}}},80294:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localPlusMs=t.tsToLocal=t.localToTs=t.localToDateTime=t.localToDateObject=t.millisToCentiseconds=t.dateTimeToLocalSec=t.dateTimeToLocal=t.agoLocal=t.nowLocal=t.utcIsoToTs=t.isoNow=t.durationHMS=t.durationToPaddedHMS=t.fmtMs=t.filestampUTC=t.filestamp=t.isRecentMs=t.nowish=t.closeTo=t.msUntil=t.cmpDate=void 0;const n=i(8223),r=i(39938),s=i(88491),a=i(66776),o=i(75556),l=i(98510),u=i(8199),c=i(91464);function d(e,t,i){return null!=e&&null!=t&&Math.abs(e.getTime()-t.getTime())<=i}function h(e){return p(n.DateTime.local().plus(-e))}function p(e){return a.map(m(e),(t=>100*t+f(e.millisecond)))}function m(e){return null!=e&&e.isValid?o.toInt(e.toFormat("yMMddHHmmss")):void 0}function f(e){return Math.floor(e/10)}function g(e,t){if(null==e||e<0)return;let i=e;const r=()=>{const e=i%100;return i=Math.floor(i/100),e},s=10*r(),o=r(),l=r(),u=r(),c=r(),d=r();return{year:i,month:d,day:c,hour:u,minute:l,second:o,millisecond:s,zone:a.map(t,(e=>n.Info.normalizeZone(e)))}}function y(e,t){return a.map(g(e,t),(e=>n.DateTime.fromObject(e)))}t.cmpDate=function(e,t){const i=a.mapOr(e,(e=>e.getTime()),(()=>0)),n=a.mapOr(t,(e=>e.getTime()),(()=>0));return u.cmp(i,n)},t.msUntil=function(e){if(null==e)return 0;const t=e.getTime(),i=Date.now();return t<=i?0:t-i},t.closeTo=d,t.nowish=function(e,t=2500){return null!=e&&(s.isDate(e)?d(e,new Date,t):Math.abs(e-Date.now())<t)},t.isRecentMs=function(e,t=5*s.secondMs){return o.gt0(e)&&Date.now()-e<=t},t.filestamp=function(e=new Date){return[e.getFullYear(),c.pad2(e.getMonth()+1),c.pad2(e.getDate()),"-",c.pad2(e.getHours()),c.pad2(e.getMinutes()),c.pad2(e.getSeconds())].join("")},t.filestampUTC=function(e=new Date){return[e.getUTCFullYear(),c.pad2(e.getUTCMonth()+1),c.pad2(e.getUTCDate()),"-",c.pad2(e.getUTCHours()),c.pad2(e.getUTCMinutes()),c.pad2(e.getUTCSeconds())].join("")},t.fmtMs=function(e){return n.Duration.fromMillis(e).toFormat("m:ss.SSS")},t.durationToPaddedHMS=function(e){return n.Duration.fromMillis(e).toFormat("hhhh:mm:ss.SSS")},t.durationHMS=function(e){return n.Duration.fromMillis(o.round(e/s.secondMs)*s.secondMs).toFormat("h:mm:ss")},t.isoNow=function(){return(new Date).toISOString()},t.utcIsoToTs=function(e){return l.opt(e).filter(r.notBlank).map((e=>n.DateTime.fromISO(e))).filter((e=>e.isValid)).map((e=>e.toMillis())).get()},t.nowLocal=function(){return h(0)},t.agoLocal=h,t.dateTimeToLocal=p,t.dateTimeToLocalSec=m,t.millisToCentiseconds=f,t.localToDateObject=g,t.localToDateTime=y,t.localToTs=function(e,t){return a.map(y(e,t),(e=>e.toMillis()))},t.tsToLocal=function(e){const t=new Date(e);return o.toInt([t.getFullYear(),...[t.getMonth()+1,t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),f(t.getUTCMilliseconds())].map(c.pad2)].join(""))},t.localPlusMs=function(e,t){return p(y(e).plus(t))}},44665:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateInterval=void 0;const n=i(55883),r=i(66776),s=i(75556),a=i(82798),o=i(45161),l=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/;class u{constructor(e,t,i,n=0,r=1){this.start=e,this.middle=t,this.end=i,this.index=n,this.splits=r,this.toISOString=this.toString.bind(this),this.year=o.getYear(this.middle),this.month=o.getMonth(this.middle),this.day=o.getDay(this.middle)}static fromISO(e){e=a.toS(e).trim();const t=l.exec(e);if(null==t)return;const i=n.ExifDateTime.fromISO(t[1]),r=n.ExifDateTime.fromISO(t[2]),o=s.toInt(t[3]),u=s.toInt(t[4]);return this.for(i,r,o,u)}static for(e,t,i=0,n=1){if(!o.validDate(e)||!o.validDate(t))return;const a=o.toExifDateTime(e),l=o.toExifDateTime(t);if(null==a||null==l)return;n=s.clamp(1,1e3,s.toInt(n,{defaultValue:1})),i=s.clamp(0,n-1,s.toInt(i,{defaultValue:0}));const c=r.map(a.toDateTime().until(l.toDateTime()).divideEqually(n+1)[i],(e=>e.end));return null!=c?new u(a,o.toExifDateTime(c,r.orElse(a.zone,l.zone)),l,i,n):void 0}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return r.orElse(this.start.zone,this.end.zone)}get hasTimes(){return o.hasTime(this.start)&&o.hasTime(this.end)}toString(e=!0){return`${o.datedToISO(this.start,e)}/${o.datedToISO(this.end,e)}`+(0===this.index&&1===this.splits?"":`/${this.index}/${this.splits}`)}includes(e){if(null==e)return!1;const t=o.toExifDateTime(e);return null!=t?this.interval().contains(t.toDateTime()):this.year===o.getYear(e)&&this.month===o.getMonth(e)&&this.day===o.getDay(e)}}t.DateInterval=u},93125:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseJsonDate=t.isoToPrecisionMs=t.isoToLocal=t.fmtDateIso=t.fmtDateShort=t.isoToDateTime=t.fmtDateTime=t.recent=void 0;const n=i(8223),r=i(39938),s=i(88491),a=i(21040),o=i(66776),l=i(75556),u=i(98510),c=i(2023),d=i(91464),h=i(80294),p=i(44665),m=i(45161);function f(e,t,i=n.DateTime.DATETIME_MED){return m.mapValidDate(e,(e=>(r.mapNotBlank(t,(t=>e=e.setLocale(t))),e.toLocaleString(i))))}t.recent=function(e,t=5*s.secondMs){return h.isRecentMs(o.map(e,(e=>m.datedToMillis(e))),t)},t.fmtDateTime=f;const g=/(\.\d\d\d)\d+/;function y(e){if(!r.blank(e))return u.opt(n.DateTime.fromISO(e.replace(g,((e,t)=>t)),{setZone:!0})).filter((e=>e.isValid)).orElse((()=>o.map(p.DateInterval.fromISO(e),(e=>e.middle.toDateTime())))).get()}t.isoToDateTime=y;const v=new Map;t.fmtDateShort=function(e,t="en-US"){return a.getOrSet(v,t,(()=>new Intl.DateTimeFormat(t,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}))).format(m.datedToMillis(e))},t.fmtDateIso=function(e,t,i=n.DateTime.DATETIME_MED){return u.opt(n.DateTime.fromISO(e,{setZone:!0})).filter(m.validDate).orElse((()=>o.map(p.DateInterval.fromISO(e),(e=>e.middle.toDateTime())))).map((e=>f(e,t,i))).getOrElse((()=>e))},t.isoToLocal=function(e){return o.map(y(e),h.dateTimeToLocal)};const w=/^\d{1,4}-\d{2}-\d{2}$/;t.isoToPrecisionMs=function(e){return r.mapNotBlank(e,(e=>c.firstThunk((()=>o.map(p.DateInterval.fromISO(e),(e=>e.intervalMs))),(()=>u.opt(e.match(w)).flatMap((()=>n.DateTime.fromISO(e))).filter(m.validDate).map((()=>s.dayMs)).get()),(()=>u.opt(n.DateTime.fromISO(e)).filter(m.validDate).map((()=>0)).get()))))},t.parseJsonDate=function(e){var t;if(null==e)return;if(d.isString(e))return null===(t=y(e))||void 0===t?void 0:t.toJSDate();const i=null==e?void 0:e.timestamp,n=null==e?void 0:e.formatted,a=l.mapNumeric(i,(e=>new Date(e*s.secondMs)));if(r.notBlank(n)){const e=new Date(n);if(!h.closeTo(a,e,s.secondMs))return}return a}},45161:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasTime=t.dateBetween=t.gtDate=t.closeTo=t.diffMillis=t.sameDay=t.toFuzzyDate=t.datedToYMD=t.fromISO=t.datedToISO=t.datedToPrecisionMs=t.datedToOffsetMinutes=t.dtToLocal=t.dateToLocal=t.datedToLocal=t.datedToMillis=t.toDate=t.toExifDateTime=t.toDateTime=t.parseExifDateTime=t.getZoneName=t.hasZone=t.zoneOffsetToName=t.getSecMs=t.hasSeconds=t.getMillisecond=t.getSecond=t.getMinute=t.getHour=t.getDay=t.getMonth=t.getYear=t.isDated=t.parseYMD=t.extractDateFromPath=t.clearIgnorableSubpaths=t.addIgnorableSubpath=t.FuzzyDateParser=t.parseDated=t.parseDateTime=t.agoMs=t.dateTimeBetween=t.isoToOffsetMinutes=t.FuzzyDate=t.validYMD=t.validDay=t.validMonth=t.validYear=t.mapValidDate=t.validDate=void 0,t.setZone=t.zoneToOffset=void 0;const n=i(55883),r=i(8223),s=i(11944),a=i(39938),o=i(88491),l=i(43947),u=i(11448),c=i(66776),d=i(75556),h=i(98510),p=i(8199),m=i(82798),f=i(13779),g=i(79015),y=i(7162),v=i(70283),w=i(2023),b=i(43414),S=i(91464),M=i(6646),P=i(80294),E=i(44665);function T(e,t=2){return null==e?"":S.leftPad(e,t,"0")}function x(e){if(null==e||"string"==typeof e||0===e)return!1;const t=ve(e);return null!=t&&0!==t&&!!A(ne(e),re(e),se(e))&&(!Te(e)||c.mapOr(fe(e),(e=>e.isValid),(()=>!1)))}t.validDate=x,t.mapValidDate=function(e,t){return x(e)?t(e):void 0};const D=u.lazy((()=>b.Settings.minValidYear.valueOrDefault),o.hourMs),C=u.lazy((()=>new Date(Date.now()+o.dayMs).getFullYear()),o.hourMs),k=u.lazy((()=>new Date(Date.now()+o.dayMs).getMonth()+1),o.hourMs);function I(e){return v.within(D(),C(),e)}function F(e,t){return(!p.gte(t,C())||!p.gt(e,k()))&&v.within(1,12,e)}function O(e,t,i){return null!=i&&r.DateTime.fromObject({year:e,month:t,day:i}).isValid}function A(e,t,i){return I(e)&&(null==t||F(t,e)&&(null==i||O(e,t,i)))}l.later((()=>g.onClearCache((()=>{D.unset(),C.unset(),k.unset()})))),t.validYear=I,t.validMonth=F,t.validDay=O,t.validYMD=A;class _{constructor(e,t,i){this.year=e,this.month=t,this.day=i}static for(e,t,i){return A(e,t,i)?new _(e,t,i):void 0}static localToday(){return Pe(new Date)}toString(){return s.compact([this.year,this.month,this.day]).map((e=>T(e))).join("-")}toISOString(){return this.toString()}toDateTime(){return r.DateTime.fromObject(this)}following(){const e=this.toDateTime();return null!=this.day?e.plus({days:1}):null!=this.month?e.plus({months:1}):e.plus({years:1})}}t.FuzzyDate=_;class L{constructor(e,t,i,n,r){this.monthsToMonth=e,this.re=t,this.yearIndex=i,this.monthIndex=n,this.dayIndex=r}apply(e){const t=this.re.exec(e);if(null!=t){const e=d.toInt(t[this.yearIndex]),i=this.month(t),n=null==this.dayIndex?void 0:parseInt(t[this.dayIndex],10);return _.for(e,i,n)}}month(e){if(null==this.monthIndex)return;const t=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(t)?this.monthsToMonth.get(t):d.toInt(t)}}const R="((?:19|20)[0-9]{2})",N="(1[0-2]|0[1-9])",B="(1[0-2]|0?[1-9])",j="([1-3][0-9]|0[1-9])",z="([1-3][0-9]|0?[1-9])",V="([0-5][0-9])",W=V,q=V,U="([-\\.\\,:_/ |])",H=U+"?",G="(?:(Z|UTC)|(?:([+-])([01][0-9]):?([0-5][0-9])))",J=new RegExp("\\d\\d\\s*"+G,"i");function $(e){return c.map(J.exec(e),(e=>K(e.slice(1))))}function K(e,t){if(s.isEmpty(e))return t;const[i,n]=e.splice(0,2),[r,a]=e.splice(0,2).map((e=>d.toInt(e)));return S.hasAnyIgnoreCase(["z","utc"],i)?0:f.anyNotDefined([n,r,a])?t:("-"===n?-1:1)*(60*r+a)}function Q(e){return a.mapNotBlank(e,(e=>w.firstTrueThunk([()=>n.ExifDateTime.fromEXIF(e),()=>pe(e)],(e=>x(e)))))}t.isoToOffsetMinutes=$,t.dateTimeBetween=function(e,t){return e.until(t).divideEqually(2)[0].end},t.agoMs=function(e){return d.mapNumeric(ve(e),(e=>Date.now()-e))},t.parseDateTime=Q;const Y=u.lazy((()=>y.mkLogger("FuzzyDate")));t.parseDated=function(e,t=!1){if(!a.blank(e))for(const{desc:i,f:s}of[{desc:"DateInterval.fromISO",f:()=>E.DateInterval.fromISO(e)},{desc:"parseDateTime",f:()=>Q(e)},{desc:"DateTime.fromFormat(macOS)",f:()=>r.DateTime.fromFormat(e,"y-M-d 'at' H.m.s")},{desc:"DateTime.fromFormat(gnome)",f:()=>r.DateTime.fromFormat(e,"y-M-d H-m-s")},{desc:"DateTime.fromFormat(yMMdd_HHmmss)",f:()=>r.DateTime.fromFormat(e,"yMMdd_HHmmss")},{desc:"ExifDate.fromEXIF",f:()=>n.ExifDate.fromEXIF(e)},{desc:"fuzzyDate.parseYMD",f:()=>te().parseYMD(e)},{desc:"new Date()",f:()=>t?new Date(e):void 0}]){const t=s();if(x(t)){const n=$(e);return null!=n&&(t.tzoffsetMinutes=n),Y().tap({msg:"parseDated()",result:t,meta:{s:e,desc:i,tzoffsetMinutes:n}})}}};class X{constructor(e,t=b.Settings.fuzzyDateParsing.valueOrDefault,i=b.Settings.fuzzyYearParsing.valueOrDefault){this.locale=e,this.fuzzyDateParsing=t,this.fuzzyYearParsing=i,this.monthsToMonth=new Map,this.ymdPatterns=[],this.ymPatterns=[],this.yPatterns=[],this.allParsers=[],this.setup()}parse(e){return f.first(this.allParsers,(t=>t.apply(e)))}parseYMD(e){return f.first(this.ymdPatterns,(t=>t.apply(e)))}addParser(e,t,i,n){const r=new L(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),t,i,n);null!=n&&null!=i?this.ymdPatterns.push(r):this.fuzzyYearParsing&&null==n&&null!=i?this.ymPatterns.push(r):this.fuzzyYearParsing&&null==n&&null==i&&this.yPatterns.push(r)}setup(){for(const e of s.uniq([this.locale,"en-US"]))for(const t of["short","long"]){const i=new Intl.DateTimeFormat(e,{month:t});d.times(12,(e=>{const t=i.format(new Date(2017,e));this.monthsToMonth.set(t.toLowerCase(),e+1)}))}const e="("+s.sort([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(R+U+B+"\\2"+z,1,3,4),this.addParser(R+H+N+"\\2"+j,1,3,4),this.addParser(R+H+e+"\\2"+z,1,3,4),this.addParser(e+H+z+",?\\2"+R,4,1,3),this.addParser(z+H+e+",?\\2"+R,4,3,1),this.fuzzyDateParsing&&(this.addParser(R+U+B,1,3),this.addParser(e+U+R,3,1),this.addParser(R+U+e,1,3)),this.addParser(R,1),this.allParsers.push(...this.ymdPatterns,...this.ymPatterns,...this.yPatterns)}extractDateFromPath(e){if(!b.Settings.usePathsToInferDates.valueOrDefault)return;ie.forEach((t=>{s.startsWith(e,t)&&e.splice(0,t.length)})),e=e.filter((t=>a.notBlank(t)&&null==e[0].match(Z)));const t=[...e].reverse();return w.firstThunk((()=>f.first(t,(e=>this.parseYMD(e)))),(()=>this.parseYMD(t.slice(0,4).join(" "))),(()=>this.parseYMD(e.slice(0,4).join(" "))),...b.Settings.fuzzyDateParsing.valueOrDefault?[()=>f.first(this.ymPatterns,(e=>f.first(t,(t=>e.apply(t))))),()=>f.first(this.ymPatterns,(t=>t.apply(e.join(" ")))),()=>f.first(this.yPatterns,(e=>f.first(t.slice(1),(t=>e.apply(t)))))]:[])}}t.FuzzyDateParser=X;const Z=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P_?)\d+)$/i,ee=u.lazy((()=>{b.Settings.fuzzyDateParsing.addListener((()=>te.unset())),b.Settings.fuzzyYearParsing.addListener((()=>te.unset())),b.Settings.usePathsToInferDates.addListener((()=>te.unset()))})),te=u.lazy((()=>(ee(),new X(void 0)))),ie=[];function ne(e){return c.map(e,(e=>e instanceof Date?e.getFullYear():e.year))}function re(e){return c.map(e,(e=>e instanceof Date?e.getMonth()+1:e.month))}function se(e){return c.map(e,(e=>e instanceof Date?e.getDate():e.day))}function ae(e){return Te(e)?e instanceof Date?e.getHours():e.hour:void 0}function oe(e){return Te(e)?e instanceof Date?e.getMinutes():e.minute:void 0}function le(e){return Te(e)?e instanceof Date?e.getSeconds():e.second:void 0}function ue(e){return Te(e)?e instanceof Date?e.getMilliseconds():e.millisecond:void 0}function ce(e,t=!0){if(null==e)return;if(0===e)return t?"UTC":"";const i=e<0?"-":"+",n=15*d.round(e/15),r=Math.abs(n),s=Math.floor(r/60),a=Math.floor(Math.abs(r%60));return`${t?"UTC":""}${i}${T(s)}:${T(a)}`}function de(e){return e instanceof n.ExifDateTime?e.hasZone&&M.zoneSeemsLegit(e.tzoffsetMinutes):e instanceof r.DateTime&&null!=e.zone&&"local"!==e.zone.type}function he(e){return e instanceof r.DateTime?c.map(e.zone,(e=>e.name)):e instanceof n.ExifDateTime?e.zone:void 0}function pe(e,t=me){const i=t.exec(e);if(null==i)return;const n=[...i.slice(1)],[s,a,o,l,u,c]=n.splice(0,6).map((e=>d.toInt(e)));if(null==s||null==a||null==o)return;if(!b.Settings.fuzzyDateParsing.valueOrDefault&&(null==l||null==u))return;const h=d.clamp(0,999,1e3*d.toFloat(n.shift(),{defaultValue:0})),p=ce(K(n)),m=r.DateTime.fromObject({year:s,month:a,day:o,hour:l,minute:u,second:c,millisecond:h,zone:p});return m.isValid?ge(m,p):void 0}t.addIgnorableSubpath=function(e){ie.push(e)},t.clearIgnorableSubpaths=function(){ie.length=0},t.extractDateFromPath=function(e){return te().extractDateFromPath(e)},t.parseYMD=function(e){return te().parseYMD(e)},t.isDated=function(e){return null!=e&&(e instanceof _||e instanceof n.ExifDate||e instanceof n.ExifDateTime||e instanceof Date||e instanceof E.DateInterval||e instanceof r.DateTime||c.allDefined([e.year,e.month,e.day]))},t.getYear=ne,t.getMonth=re,t.getDay=se,t.getHour=ae,t.getMinute=oe,t.getSecond=le,t.getMillisecond=ue,t.hasSeconds=function(e){return Te(e)&&(d.gt0(oe(e))||d.gt0(le(e))||d.gt0(ue(e)))},t.getSecMs=function(e){return c.map(le(e),(t=>{const i=c.orElse(ue(e),0);let n=(t+i/1e3).toString();for(t<10&&(n="0"+n),0===i&&(n+=".");n.length<6;)n+="0";return n}))},t.zoneOffsetToName=ce,t.hasZone=de,t.getZoneName=he,t.parseExifDateTime=pe;const me=new RegExp([R,N,j,"(1[0-9]|2[0-3]|0[0-9])",W,q,"(?:(\\.[0-9]+))?"].join("[-:_ ]?")+G+"?","i");function fe(e){return e instanceof r.DateTime?e:e instanceof n.ExifDateTime?e.toDateTime():e instanceof E.DateInterval?e.middle.toDateTime():e instanceof Date?r.DateTime.fromJSDate(e):void 0}function ge(e,t){if(null==e||!Te(e))return;if(e instanceof r.DateTime)return n.ExifDateTime.fromDateTime(e);const i=ve(e);if(null==i)return;const s=a.blank(t)?de(e)?he(e):void 0:t,o=a.mapNotBlank(s,(e=>xe(i,e)));if(null!=t&&null==o)return;const l=c.map(ne(e),(t=>c.map(re(e),(i=>c.map(se(e),(r=>c.map(ae(e),(s=>new n.ExifDateTime(t,i,r,s,c.orElse(oe(e),0),c.orElse(le(e),0),ue(e),o,e.rawValue)))))))));return x(l)?l:void 0}function ye(e){if(null==e)return;if("number"==typeof e)return new Date(e);if(e instanceof Date)return e;if(e instanceof r.DateTime)return e.toJSDate();if(null!=e.toDate)return e.toDate();if(d.gt0(e.year)&&d.gt0(e.month)&&d.gt0(e.day))return new Date(e.year,c.orElse(e.month,1)-1,e.day,12);const t=m.toS(e);return a.notBlank(t)?c.map(Se(t),ye):void 0}function ve(e){if(null!=e&&!S.isString(e))return d.isNumber(e)?e:e instanceof Date?e.getTime():e instanceof r.DateTime?e.toMillis():c.map(ye(e),(e=>e.getTime()))}function we(e){var t,i;return 1e8*parseInt(m.toS(e.year)+S.pad2(null!==(t=e.month)&&void 0!==t?t:1)+S.pad2(null!==(i=e.day)&&void 0!==i?i:1))}function be(e){var t;return 100*parseInt(m.toS(e.year)+[e.month,e.day,e.hour,e.minute,e.second].map((e=>S.pad2(e))).join(""))+P.millisToCentiseconds(null!==(t=e.millisecond)&&void 0!==t?t:0)}function Se(e,t){return"string"!=typeof e||a.blank(e)?void 0:h.opt(n.ExifDateTime.fromISO(e,t)).orElse((()=>n.ExifDate.fromISO(e))).orElse((()=>n.ExifTime.fromEXIF(e))).get()}function Me(e,t="-"){return s.compact([ne(e),re(e),se(e)]).map((e=>T(e))).join(t)}function Pe(e){return c.map(e,(e=>c.map(ne(e),(t=>new _(t,re(e),se(e))))))}function Ee(e,t){const[i,n]=[e,t].map(ve);return null==i||null==n?void 0:i-n}function Te(e){return e instanceof Date||e instanceof n.ExifDateTime||e instanceof r.DateTime}function xe(e,t){const i=r.Info.normalizeZone(t);return i.isValid?i.offset(e):void 0}t.toDateTime=fe,t.toExifDateTime=ge,t.toDate=ye,t.datedToMillis=ve,t.datedToLocal=function(e){if(null!=e&&!S.isString(e))return d.isNumber(e)?P.tsToLocal(e):e instanceof _||e instanceof n.ExifDate?we(e):e instanceof n.ExifDateTime||e instanceof r.DateTime?be(e):e instanceof Date?P.tsToLocal(e.getTime()):c.map(ve(e),P.tsToLocal)},t.dateToLocal=we,t.dtToLocal=be,t.datedToOffsetMinutes=function(e){return c.map(e,(e=>e instanceof n.ExifDateTime?e.tzoffsetMinutes:e instanceof r.DateTime?e.offset:void 0))},t.datedToPrecisionMs=function(e){return c.map(e,(e=>e instanceof r.DateTime||e instanceof n.ExifDateTime||e instanceof Date?0:e instanceof n.ExifDate?o.dayMs:e instanceof E.DateInterval?e.intervalMs:void 0))},t.datedToISO=function(e,t=!0){if(null==e)return;if(e instanceof E.DateInterval)return e.toString(t);const i=d.isNumber(e)?new Date(e):e;return Te(i)?c.map(ge(i),(e=>e.toISOString({includeOffset:t}))):Me(i)},t.fromISO=Se,t.datedToYMD=Me,t.toFuzzyDate=Pe,t.sameDay=function(e,t){return d.lte(Ee(e,t),o.dayMs)},t.diffMillis=Ee,t.closeTo=function(e,t,i){return c.mapOr(Ee(e,t),(e=>Math.abs(e)<i),(()=>!1))},t.gtDate=function(e,t){const i=ve(e),n=ve(t);return null!=i&&null!=n&&i>n},t.dateBetween=function(e,t,i=1,n=1){if(null==ve(e)||null==ve(t))return;const[s,a]=[e,t].map((e=>ve(e))).sort(),o=(a-s)/(n+1),l=he(e),u=l===he(t)?l:void 0,c=r.DateTime.fromMillis(s+o*i,{zone:u});return[e,t].some((e=>!Te(e)))?Pe(c):c},t.hasTime=Te,t.zoneToOffset=xe,t.setZone=function(e,t){return e instanceof r.DateTime?e.setZone(t,{keepLocalTime:!0}):ge(e,t)}},10408:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addMessage=t.onError=t.cleanError=t.errorToHumanString=t.trimErrorMessage=t.stack=t.throws=t.isFatalErrorAllowed=t.errorContains=t.mapError=void 0;const n=i(11944),r=i(39938),s=i(38625),a=i(88491),o=i(16475),l=i(11448),u=i(66776),c=i(75556),d=i(82798),h=i(36079),p=i(79015),m=i(7162),f=i(69547),g=i(55568),y=i(43414),v=i(91464),w=i(82987),b=i(49379),S=Date.now(),M=l.lazy((()=>m.mkLogger("Error"))),P=new f.Rate(a.minuteMs),E=new f.Rate(a.minuteMs);function T(){const e=Date.now()>S+y.Settings.probationMs.valueOrDefault,t=c.lt(E.eventsPerMinute,y.Settings.fatalErrorRatePerMinute.valueOrDefault);return M().tap({level:"info",msg:"isFatalErrorAllowed()",result:g.isMainService()&&e&&t,meta:{mainService:g.isMainService(),postProbation:e,lowErrorRate:t,fatalErrorRatePerMin:E.eventsPerMinute,errorRatePerMin:P.eventsPerMinute,fatalErrorRatePerMinuteSetting:y.Settings.fatalErrorRatePerMinute.valueOrDefault}})}function x(){const e={};return Error.captureStackTrace(e,x),e.stack.split(/\n(?:\s*at\s+)?/).slice(1)}t.mapError=function(e,t){return e instanceof Error?t(e):void 0},t.errorContains=function(e,t){return null!=t.exec(o.errorToS(e))},t.isFatalErrorAllowed=T,t.throws=function(e){try{return e(),!1}catch{return!0}},t.stack=x;const D=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function C(e){let t=b.stripErrorFlags(v.stripAnsiEsc(e)),i=t;do{i=t,t=D.reduce(((e,t)=>e.replace(t,"")),t).trim()}while(i!==t);return n.compactBlanks(t.split(/\s+/).map((e=>{if(e.startsWith("E")){const i=w.describeError(e);return t.toLowerCase().includes(i.toLowerCase())?"":i+":"}return e}))).join(" ")}t.trimErrorMessage=C,t.errorToHumanString=function(e,t=256){const i=o.errorToS(e),n=b.extractErrorFlags(i);return v.ellipsize(C(i),t-n.length)+n},t.cleanError=function(e,t){return d.toS(e).split(/\r?\n/).map((e=>v.stripPrefix(e,t))).map((e=>e.replace(/: ?/,""))).filter(r.notBlank).join(", ")},t.onError=function(e,t,i){if(r.blank(e)&&null==t)return void M().warn("onError() with empty args",x());const n=o.errorToS(e)+o.errorToS(t)+o.errorToS(i),a=b.isFatalError(t)||b.isFatalError(n)||s.isTrue(null==i?void 0:i.fatal);if(!a&&b.isIgnorableError(n))return void M().info("onError(): (ignorable): "+o.errorToVerbose(t),{message:e,...i});u.map(m.currentFileLogger(),(e=>e.writeRecentLogEntries())),P.onEvent(),a&&E.onEvent();const l=!a||T()?"nonFatal":"fatal";M().log("fatal"===l?"error":"warn","onError(): "+o.errorToVerbose(t),{event:l,message:e,...u.orElse(i,{})}),h.ending()||p.eventEmitter.emit(l,{message:e,error:t})},t.addMessage=function(e,t){return null==e?new Error(t):(r.notBlank(t)&&(e.message.toLowerCase().includes(t.toLowerCase())||(e.message+=": "+t)),e)}},82987:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeError=void 0;const n=i(66776),r=i(82798),s=i(91464);t.describeError=function(e){const t=s.stripSuffix(r.toS(e).trim().toUpperCase(),":");return n.mapOr(a[t],(e=>e.description),(()=>e))};const a=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}})},49379:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isFatalError=t.FatalErrorRe=t.isDoNotSendError=t.isNonRetriableError=t.isRetriableError=t.isSqliteConstraintError=t.isSqliteDisconnectedError=t.isSqliteBusyError=t.isIgnorableError=t.isPleaseSendError=t.isHealthCheckError=t.hasErrorFlag=t.extractErrorFlags=t.stripErrorFlags=t.addErrorFlags=t.ErrorFlags=t.RetriableErrorFlag=t.DoNotSendErrorFlag=t.HealthCheckErrorFlag=t.PleaseSendErrorFlag=t.IgnorableErrorFlag=t.NonRetriableErrorFlag=t.FatalErrorFlag=void 0;const n=i(16475),r=i(36079),s=i(38625),a=i(82798);t.FatalErrorFlag="Â¹",t.NonRetriableErrorFlag="Â²",t.IgnorableErrorFlag="Â³",t.PleaseSendErrorFlag="â´",t.HealthCheckErrorFlag="âµ",t.DoNotSendErrorFlag="â¶",t.RetriableErrorFlag="â·",t.ErrorFlags=[t.FatalErrorFlag,t.NonRetriableErrorFlag,t.IgnorableErrorFlag,t.PleaseSendErrorFlag,t.HealthCheckErrorFlag,t.DoNotSendErrorFlag,t.RetriableErrorFlag],t.addErrorFlags=function(e,...t){return e+t.filter((t=>null!=t&&!e.includes(t))).join("")};const o=/[â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g;function l(e){return n.errorToS(e).includes(t.PleaseSendErrorFlag)}t.stripErrorFlags=function(e){return e.replace(o,"")},t.extractErrorFlags=function(e){return[...a.toS(e)].filter((e=>t.ErrorFlags.includes(e))).join("")},t.hasErrorFlag=function(e){return null!=e.match(o)},t.isHealthCheckError=function(e){return n.errorToS(e).includes(t.HealthCheckErrorFlag)},t.isPleaseSendError=l;const u=[t.IgnorableErrorFlag,"0 output files created","BatchCluster has ended, cannot enqueue","called while not idle","Can't set headers after they are sent","debugger attached","debugger listening on","diskutil: interrupted","ECONNRESET","end() called before task completed","EPIPE","for help","Format error in file","https://nodejs.org/en/docs/inspector","Invalid data found when processing input","Missing expected status message","net::ERR_","onExit(exit) called end()","This socket has been ended by the other party","Unexpected error while trimming","Warning"].map((e=>e.toLowerCase()));function c(e){if(null==e)return!0;const t=n.errorToS(e).toLowerCase(),i=u.some((e=>t.includes(e)));return r.ending()||!l(e)&&!f(e)&&i}t.isIgnorableError=c;const d=/SQLITE_BUSY|database is locked/i;function h(e){return null!=n.errorToS(e).match(/SQLITE_CONSTRAINT|constraint failed/i)}function p(e){return!(f(e)||n.errorToS(e).includes(t.NonRetriableErrorFlag)||h(e)||s.isFalse(e.retriable))}t.isSqliteBusyError=function(e){return"SQLITE_BUSY"===e.code||null!=n.errorToS(e).match(d)},t.isSqliteDisconnectedError=function(e){return null!=n.errorToS(e).match(/database .+ not open/i)},t.isSqliteConstraintError=h,t.isRetriableError=p,t.isNonRetriableError=function(e){return!p(e)},t.isDoNotSendError=function(e){if(l(e))return!1;if(s.isTrue(null==e?void 0:e.doNotSend))return!0;const t=n.errorToS(e).toLowerCase();return m.some((e=>t.includes(e)))||c(t)};const m=[t.DoNotSendErrorFlag,"Corrupt JPEG data","premature end of data segment","VipsJpeg"];function f(e){return null!=e&&(!!s.isTrue(e.fatal)||null!=t.FatalErrorRe.exec(n.errorToS(e)))}t.FatalErrorRe=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+t.FatalErrorFlag,"i"),t.isFatalError=f},79141:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WrappedError=void 0;const n=i(11944),r=i(39938),s=i(16475),a=i(91464),o=i(49379);class l extends Error{constructor({cause:e,message:t,retriable:i=!0,ignorable:l=!1,fatal:u=!1,doNotSend:c=!1}){super(function({message:e,cause:t,retriable:i,ignorable:l,fatal:u,doNotSend:c}){const d=[e];r.mapNotBlank(a.stripPrefix(s.errorToS(t),"Error: "),(e=>d.push(e)));const h=a.uniqSubstr(n.compactBlanks(d)).join(": ");return u=u||h.includes(o.FatalErrorFlag),i=(i||h.includes(o.RetriableErrorFlag))&&!h.includes(o.NonRetriableErrorFlag),c=c||!h.includes(o.PleaseSendErrorFlag),l=l||h.includes(o.IgnorableErrorFlag),o.addErrorFlags(o.stripErrorFlags(h),u?o.FatalErrorFlag:void 0,c?o.DoNotSendErrorFlag:void 0,l&&!u?o.IgnorableErrorFlag:void 0,i||u?void 0:o.NonRetriableErrorFlag,i&&!u?o.RetriableErrorFlag:void 0)}({message:t,cause:e,retriable:i,ignorable:l,fatal:u,doNotSend:c})),this.cause=e,null!=e&&(this.stack=e.stack),this.retriable=i,this.fatal=u}}t.WrappedError=l},67817:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.emitSafely=void 0;const n=i(11944),r=i(21142);t.emitSafely=async function(e,t,i,s=1e3){const a=await r.untilTrue((()=>n.isNotEmpty(e.listeners(t))),{timeoutMs:s});return a&&e.emit(t,i),a}},79015:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onWriteRecentLogEntries=t.emitWriteRecentLogEntries=t.onVacuuming=t.emitVacuuming=t.onSettingsChanged=t.emitSettingsChanged=t.onVolumesChanged=t.emitVolumesChanged=t.onReadyToUpdate=t.emitReadyToUpdate=t.readyToUpdate=t.onRpcServerChange=t.emitRpcServerChange=t.onNonFatal=t.onFatal=t.onFocus=t.emitFocus=t.onFileChanged=t.emitFileCopied=t.onFileCopied=t.emitFileChanged=t.onResume=t.emitResume=t.onPause=t.emitPause=t.onMigration=t.emitMigration=t.onIdle=t.emitIdle=t.onClearCache=t.emitClearCache=t.useProductionEventEmitter=t.useTestEventEmitter=t.eventEmitter=void 0;const n=i(28614),r=i(7162),s=i(11448),a=i(21371),o=s.lazy((()=>new a.TestEventEmitter)),l=s.lazy((()=>{const e=new n.EventEmitter({captureRejections:!0});return e.setMaxListeners(50),e}));t.eventEmitter=l(),t.useTestEventEmitter=function(){return t.eventEmitter=o()},t.useProductionEventEmitter=function(){return t.eventEmitter=l()},t.emitClearCache=function(){r.mkLogger("EventEmitter").info("emitClearCache()"),t.eventEmitter.emit("clearCache")},t.onClearCache=function(e){t.eventEmitter.on("clearCache",e)},t.emitIdle=function(){t.eventEmitter.emit("idle")},t.onIdle=function(e){t.eventEmitter.on("idle",e)},t.emitMigration=function(e){t.eventEmitter.emit("migration",e)},t.onMigration=function(e){t.eventEmitter.on("migration",e)},t.emitPause=function(){t.eventEmitter.emit("pause")},t.onPause=function(e){t.eventEmitter.on("pause",e)},t.emitResume=function(){t.eventEmitter.emit("resume")},t.onResume=function(e){t.eventEmitter.on("resume",e)},t.emitFileChanged=function(e){t.eventEmitter.emit("fileChanged",e)},t.onFileCopied=function(e){t.eventEmitter.on("fileCopied",e)},t.emitFileCopied=function(e,i){t.eventEmitter.emit("fileCopied",e,i)},t.onFileChanged=function(e){t.eventEmitter.on("fileChanged",e)},t.emitFocus=function(e,i){t.eventEmitter.emit("focus",e,i)},t.onFocus=function(e){t.eventEmitter.on("focus",e)},t.onFatal=function(e){t.eventEmitter.on("fatal",(({message:t,error:i})=>e(t,i)))},t.onNonFatal=function(e){t.eventEmitter.on("nonFatal",(({message:t,error:i})=>e(t,i)))},t.emitRpcServerChange=function(){t.eventEmitter.emit("rpcServerChange")},t.onRpcServerChange=function(e){t.eventEmitter.on("rpcServerChange",e)},t.readyToUpdate=!1,t.emitReadyToUpdate=function(){t.readyToUpdate=!0,t.eventEmitter.emit("readyToUpdate")},t.onReadyToUpdate=function(e){t.eventEmitter.on("readyToUpdate",e)},t.emitVolumesChanged=function(){t.eventEmitter.emit("volumesChanged")},t.onVolumesChanged=function(e){t.eventEmitter.on("volumesChanged",e)},t.emitSettingsChanged=function(){t.eventEmitter.emit("settingsChanged")},t.onSettingsChanged=function(e){t.eventEmitter.on("settingsChanged",e)},t.emitVacuuming=function(){t.eventEmitter.emit("settingsChanged")},t.onVacuuming=function(e){t.eventEmitter.on("vacuuming",e)},t.emitWriteRecentLogEntries=function(){t.eventEmitter.emit("writeRecentLogEntries")},t.onWriteRecentLogEntries=function(e){t.eventEmitter.on("writeRecentLogEntries",e)}},27601:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventStore=t.ExtraEventsForPlease=void 0;const n=i(88491),r=i(11448),s=i(61570),a=i(39784),o=i(82798),l=i(36079),u=i(46852),c=i(49379),d=i(98462),h=i(59873),p=i(7162),m=i(6231),f=i(43414),g=i(15671),y=r.lazy((()=>p.mkLogger("EventStore")));function v(e){return s.omit(e,"breadcrumbs")}t.ExtraEventsForPlease=7;class w{constructor(){this.root=d.BaseFile.for(g.userData()).join("events")}datedRoot(e=new Date){return this.root.joinYMD(e)}rmrf(){return this.root.rmrf()}msg2file(e){return this.datedRoot(new Date(e.timestamp*n.secondMs)).join(h.shortStringSha(e.message,8,m.GeoRadix)+".json")}async eventsFrom(e=new Date){return a.toA(await this.datedRoot(e).childFiles((e=>".json"===e.ext&&!e.isHiddenPosix())))}async eventQuotaExceeded(e){const i=o.toS(e).includes(c.PleaseSendErrorFlag)||o.toS(e.message).includes(c.PleaseSendErrorFlag);return await this.eventCount()>=f.Settings.maxErrorsPerDay.valueOrDefault+(i?t.ExtraEventsForPlease:0)}async eventCount(e=new Date){return(await this.eventsFrom(e)).length}async maybeSendEvent(e){if(l.ending())return y().error("maybeSendEvent(): REJECT: we're ending.",{event:v(e)}),null;try{const i=c.isPleaseSendError(e.message),n=await this.eventCount(),r=f.Settings.maxErrorsPerDay.valueOrDefault+(i?t.ExtraEventsForPlease:0);return n>=r?(y().error("maybeSendEvent(): REJECT: too many events sent in the last day.",{recentEventCount:n,pleaseSend:i,maxErrorsPerDay:r,event:v(e)}),null):null==await this.writeEvent(e)?(y().error("maybeSendEvent(): REJECT: event was already sent in the last day.",{event:v(e)}),null):(y().error("maybeSendEvent(): ACCEPT",{event:v(e),pleaseSend:i,recentEventCount:n,maxErrorsPerDay:r}),e)}catch(e){return y().error("maybeSendEvent(): Failed to determine if we should squelch the event. Failing closed.",e),null}}async writeEvent(e){const t=this.msg2file(e);return u.thenMap(t.ensureNew_({maxVersions:f.Settings.maxErrorsPerDay.valueOrDefault,emptyIsNew:!1}).catch((()=>{})),(t=>t.writeJsonMaybe(e)))}}t.EventStore=w,w.instance=r.lazy((()=>new w))},41663:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeProgressEvtListener=t.onProgressEvt=t.emitProgressEvt=t.isProgressEvt=void 0;const n=i(39938),r=i(75556),s=i(70283),a=i(79015);function o(e){return null!=e&&n.notBlank(e.path)&&n.notBlank(e.op)&&s.within(0,100,e.pct)}t.isProgressEvt=o;const l="progress";t.emitProgressEvt=function(e){o(e)&&a.eventEmitter.emit(l,{...e,pct:r.round(r.clamp(0,100,e.pct))})},t.onProgressEvt=function(e){a.eventEmitter.on(l,e)},t.removeProgressEvtListener=function(e){return a.eventEmitter.removeListener(l,e)}},21371:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestEventEmitter=void 0;const n=i(28614);class r extends n.EventEmitter{constructor(){super(...arguments),this.events=[]}emit(e,...t){return super.emit(e,...t),this.events.push({name:e,args:t}),!0}clear(){this.events.length=0}}t.TestEventEmitter=r},40786:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ancestorWithChildren=t.hasChildren=t.childrenSync=t.ancestors=void 0;const n=i(35747),r=i(85622);function s(e){const t=[];for(;e!==r.dirname(e);)e=r.dirname(e),t.push(e);return t}function a(e){try{return n.readdirSync(e)}catch(e){return[]}}function o(e,t){const i=a(e);return t.every((e=>i.includes(e)))}t.ancestors=s,t.childrenSync=a,t.hasChildren=o,t.ancestorWithChildren=function(e,t){return s(e).find((e=>o(e,t)))}},98462:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.execDir=t.BaseFile=t.WipPrefix=void 0;const r=n(i(35747)),s=n(i(64298)),a=i(85622),o=i(31669),l=i(78761),u=i(11944),c=i(92585),d=i(39938),h=i(88491),p=i(43947),m=i(87748),f=i(11448),g=i(66776),y=i(75556),v=i(98510),w=i(44726),b=i(39784),S=i(82798),M=i(17078),P=i(13779),E=i(34996),T=i(52132),x=i(46852),D=i(70259),C=i(7383),k=i(21142),I=i(69317),F=i(70403),O=i(84593),A=i(49379),_=i(79015),L=i(7162),R=i(6667),N=i(2023),B=i(99312),j=i(71663),z=i(43414),V=i(91464),W=i(2073),q=i(53719),U=i(51081),H=i(57400),G=i(21084),J=i(59873),$=i(94329),K=i(3955),Q=i(54953),Y=i(27175),X=i(45512),Z=i(83837),ee=i(95998);t.WipPrefix=B.isWin?"wip-":".";const te=new G.FileCache;class ie{constructor(e,t){if(this.dirent=t,this.bflog=f.lazy((()=>L.mkLogger("BaseFile("+this.nativePath+")"))),this._childDirectoryEntries=f.lazy((()=>x.thenMap(this.directoryEntry(),(e=>e.children())))),this.stat=f.lazy((()=>this.trap("stat",(()=>s.default.stat(this.nativePath).catch((()=>{}))))),ie.attrTTL),this.statSync=f.lazy((()=>this.trapSync("statSync",(()=>N.Try((()=>r.default.statSync(this.nativePath)))))),ie.attrTTL),this.shaResult=f.lazy((async()=>{const e=await this.size();if(0===e||null==e)return;const t=e>5*M.MiB?new Q.PushProgressObserver({op:"Computing SHA of",path:this.nativePath},e):void 0,i=await F.elapsedAsync((()=>this.trap("sha",(()=>J.fileSha([this.nativePath],{observer:t}))))),n=g.map(i.result,(e=>e.toString("base64")));return{elapsedMs:i.elapsedMs,buffer:i.result,b64:n}}),ie.attrTTL),null!=t)this.nativePath=t.nativePath,this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext;else{this.nativePath=K.resolve(e);const t=K.parseNativePath(this.nativePath);this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext}this.posixPath=K.native2posix(this.nativePath),te.set(e,this)}toJSON(){return{nativePath:this.nativePath}}[o.inspect.custom](){return this.toJSON()}static async withFastestAccess(e){const t=u.compact(e),i=await Promise.all(t.map((e=>e.shaMs())));return t[P.leastIndex(i)]}static forPosix(e){return e instanceof ie?e:this.for(e.split("/").join(a.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,t){if(e instanceof ie)return e;const i=te.get(e);if(null!=i)return i;const n=K.resolve(e);return te.getOrSet(n,(()=>new ie(n,t)))}static clear(e){_.emitFileChanged(e)}for(e,t){return ie.for(e,t)}clear(){return this.dirent=void 0,this._childDirectoryEntries.unset(),this.stat.unset(),this.statSync.unset(),this.shaResult.unset(),this}clearThisAndParent(){return _.emitFileChanged(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return null!=e&&(e instanceof ie?this.nativePath===e.nativePath:this.nativePath===ie.for(e).nativePath)}get isUNC(){return K.isUNC(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return K.posixPathFrom(e,this)}async directoryEntry(){return null==this.dirent&&(this.dirent=await x.thenMap(this.stat(),(e=>new H.DirectoryEntry(this.dir,new H.StatDirent(this.base,e))))),this.dirent}async childDirectoryEntries(e){const t=await this._childDirectoryEntries();return null==t||null==e||u.isEmpty(t)?t:await x.filterAsync(t,e)}_directoryEntryChild(e){return this.for(a.join(this.nativePath,e.base),e)}childNames(){return x.thenMap(this.childDirectoryEntries(),(e=>e.map((e=>e.base))))}async children(e){var t;return null===(t=await this.childDirectoryEntries(e))||void 0===t?void 0:t.map((e=>this._directoryEntryChild(e)))}async childFiles(e){const t=[];for(const i of b.toA(await this.childDirectoryEntries()))if(i.isFile()){const n=this._directoryEntryChild(i);(null==e||await e(n))&&t.push(n)}return t}async childDirectories(e){return x.thenMap(this.childDirectoryEntries(),(t=>x.thenCompact(t.filter((e=>e.isDirectory())).map((async t=>T.apply(this._directoryEntryChild(t),e))))))}childrenSync(){return g.orElse(this.trapSync("childrenSync",(()=>r.default.readdirSync(this.nativePath).map((e=>this.join(e))))),[])}async hasChildren(e){const t=await this.childNames();return u.isNotEmpty(e)?u.includesAll(t,e):u.isNotEmpty(t)}async hasNoChildren(){return await this.isFile()||u.isEmpty(await this.childNames())}async visitDescendants(e){return x.thenMap(this.children(),(async t=>{for(const i of t)await i.visitDescendants(e),await e(i)}))}async descendants(e){const t=[];for(const i of b.toA(await this.childFiles()))await e(i)&&t.push(i);const i=await this.childDirectories();if(null!=i)return await D.withBoundedConcurrency({name:"descendants",laters:i.map((i=>()=>x.thenMap(i.descendants(e),(e=>t.push(...e)))))}),t}async ancestorWithChildren(e){return await this.hasChildren(e)?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}async siblings(e){var t;const i=this.parent();return null===(t=await this.siblingDirectoryEntries(e))||void 0===t?void 0:t.map((e=>i._directoryEntryChild(e)))}async siblingDirectoryEntries(e){return this.parent().childDirectoryEntries((async t=>t.base!==this.base&&(null==e||await e(t))))}async selfAndSiblings(){return this.parent().children()}async firstExistingSelfOrAncestor(){return this.isRoot||await this.exists()?this:this.parent().firstExistingSelfOrAncestor()}get pathnames(){return this.nativePath.split(a.sep).filter((e=>null!=e&&""!==e))}get pathnamesWithoutDrive(){return B.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(B.isWin?1:0)}get isRoot(){return this.pathnames.length===(B.isWin?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return null!=e&&(this.nativePath===e.nativePath||u.startsWith(e.pathnames,this.pathnames))}isDescendantOf(e){return null!=e&&e.isAncestorOf(this)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){const e=this.parent();return this.isRoot?[]:[...e.parents(),e]}async normalize(){return this.isUNC||await this.exists()||this.isRoot?this:x.thenMap(this.parent().normalize(),(async e=>{const t=await e.childNames();if(u.isNotEmpty(t)){for(const i of t)if(i===this.base)return e.join(i);const i=this.base.normalize();for(const n of t)if(n.normalize()===i)return e.join(n);if(B.isMac||B.isWin)for(const i of t)if(V.equalsIgnoreCase(i,this.base))return e.join(i)}}))}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return u.isEmpty(e)||O.eql(["."],e)?this:K.isAbsolute(e[0])?this.for(a.join(...e)):this.for(a.join(this.nativePath,...e))}joinYMD(e=new Date){return g.map3(null==e?void 0:e.getFullYear(),null==e?void 0:e.getMonth(),null==e?void 0:e.getDate(),((e,t,i)=>this.join(S.toS(e),V.pad2(t+1),V.pad2(i))))}child(...e){if(u.isEmpty(e))return this;const t=u.flatten(e.map((e=>e.split(a.sep)))).filter((e=>".."!==e));return this.join(...t)}async trap(e,t,i="warn"){try{return await C.time("fs."+e,t)}catch(t){return void this.bflog().log(i,`trap: ${e}() failed: ${t}`)}}async trapOr(e,t,i="warn"){try{return this.bflog().trace(`trapOr ${e}()`),await t(),!0}catch(t){return this.bflog().log(i,`trapOr: ${e}() failed: ${t}`),!1}}trapSync(e,t){try{return this.bflog().trace(`trapSync ${e}()`),t()}catch(t){return void this.bflog().warn(`trapSync: ${e}() failed: ${t}`)}}async exists(){return null!=this.dirent||await x.thenDefined(this.stat())}existsSync(){return null!=this.dirent||null!=this.statSync()}async notExists(){return x.thenNot(this.exists())}mtime(){return x.thenMap(this.stat(),(e=>e.mtime))}mtimeMs(){return x.thenMap(this.stat(),(e=>Math.floor(e.mtimeMs)))}mtimeSec(){return x.thenMap(this.stat(),(e=>h.unixtime(e.mtime)))}async lastModifiedUtc(){return x.thenMap(this.stat(),(e=>e.mtime.toUTCString()))}statTimes(){return x.thenMap(this.stat(),(e=>u.uniq([e.birthtimeMs,e.mtimeMs,e.ctimeMs].filter((e=>null!=e&&0!==e)))))}maxStatMs(){return x.thenMap(this.statTimes(),P.max)}maxStatDate(){return x.thenMap(this.maxStatMs(),(e=>new Date(e)))}minStatMs(){return x.thenMap(this.statTimes(),R.min)}minStatDate(){return x.thenMap(this.minStatMs(),(e=>new Date(e)))}size(){return x.thenMap(this.stat(),(e=>e.size))}async access(e){try{return await s.default.access(this.nativePath,e),!0}catch{return!1}}isExecutable(){return this.access(r.default.constants.R_OK|(B.isWin?0:r.default.constants.X_OK))}isReadable(){return this.access(r.default.constants.R_OK)}isNotReadable(){return x.thenNot(this.isReadable())}isReadWritable(){return this.access(r.default.constants.R_OK|r.default.constants.W_OK)}isNotReadWritable(){return x.thenNot(this.isReadWritable())}isHiddenPosix(){return this.base.startsWith(".")}async isEmpty(e=0){if(await this.isDirectory())return u.isNotEmpty(await this.childNames());{const t=await this.size();return null==t||t<=e}}isNonEmpty(e=1){return x.thenNot(this.isEmpty(e))}async isNonEmptyFile(e=1){return await this.isFile()&&await this.isNonEmpty(e)}async modifiedGTE(e){return x.thenMap(this.mtime(),(t=>h.unixtime(t)>=h.unixtime(e)))}async modifiedCloseTo(e,t){return x.thenMap(this.mtimeMs(),(i=>Math.abs(i-e)<=t))}async isRecent(e){const t=await this.maxStatMs();return null!=t&&t>Date.now()-e}async modifiedGT(e){if(null!=e)return x.thenMap(this.mtime(),(t=>h.unixtime(t)>h.unixtime(e)))}async isDirectory(){return null!=this.dirent?this.dirent.isDirectory():x.thenMapOr(this.stat(),(e=>e.isDirectory()),(()=>!1))}async isNotDirectory(){return x.thenNot(this.isDirectory())}isDirectorySync(){return null!=this.dirent?this.dirent.isDirectory():g.mapOr(this.statSync(),(e=>e.isDirectory()),(()=>!1))}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile(){return null!=this.dirent?this.dirent.isFile():this.stat().then((e=>v.opt(e).map((e=>e.isFile())).getOrElse((()=>!1))))}isFileSync(){return null!=this.dirent?this.dirent.isFile():v.opt(this.statSync()).filter((e=>e.isFile())).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",(()=>s.default.rmdir(this.nativePath)),e)}async mkdirp_(){try{await s.default.mkdirp(this.nativePath)}catch(e){if("EEXIST"!==e.code)throw e}if(!1===await k.untilTrue((()=>this.clear().isDirectory()),{timeoutMs:2*h.secondMs,timeBetweenMs:200}))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return await this.clear().isDirectory()||this.isRoot?this:this.trap("mkdirp",(async()=>this.mkdirp_()))}mkdirpSync_(){return s.default.mkdirpSync(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",(()=>this.mkdirpSync_()))}sha(){return x.thenMap(this.shaResult(),(e=>e.b64))}shaMs(){return x.thenMap(this.shaResult(),(e=>e.elapsedMs))}async writeStream_(e,t){return await Z.pipelineAsync(u.compact([e,g.map(null==t?void 0:t.onProgress,(e=>new Z.ByteCounter(e))),s.default.createWriteStream(this.nativePath,t)])),this.clearThisAndParent()}async writeJsonMaybe(e,t={}){return this.trap("writeJsonMaybe",(()=>this.writeJSON_(e,t)))}async writeJSON_(e,t={}){return await this.parent().mkdirp(),await s.default.writeFile(this.nativePath,m.stringify(e,t.replacer,t.spaces),{flag:"w",...t}),this.clearThisAndParent()}readJson(e="warn"){return this.trap("readJson",(()=>c.retryOnReject((async()=>await this.isNonEmptyFile()?s.default.readJson(this.nativePath):void 0),{maxRetries:1,onRetryWaitUntil:()=>p.delay("warn"===e?250:25),errorIsRetriable:e=>-2!==e.errno})),e)}readJsonSync(){return this.trapSync("readJsonSync",(()=>s.default.readJsonSync(this.nativePath)))}readFileSync_(){return s.default.readFileSync(this.nativePath)}readFile_(){return s.default.readFile(this.nativePath)}readFile(e="warn"){return this.trap("readFile",(()=>this.readFile_()),e)}async zReadFile_(e){return ee.zCopyToBuffer_(this.nativePath,e)}async zcat(e){return this.trap("zcat",(()=>x.thenMap(this.zReadFile_(e),S.toS)))}async zCopyFile(e,t){return this.trap("zCopyFile",(async()=>(await e.parent().mkdirp(),await ee.zCopyTo_(this.nativePath,r.default.createWriteStream(e.nativePath),t),e)))}readLines(){return x.thenMap(this.readFile(),(e=>U.splitLines(e.toString())))}readFileSync(){return N.Try((()=>g.map(r.default.readFileSync(this.nativePath),S.toS)))}writeTxt_(e){return this.writeFile_(U.crlf(e))}async writeFile_(e){return await this.parent().mkdirp(),await s.default.writeFile(this.nativePath,e),this.clearThisAndParent()}wip(e=t.WipPrefix){return this.sibling(e+this.base)}async unwip_(e=t.WipPrefix){const i=this.sibling(V.stripPrefix(this.base,e));return this.mv_(i,{overwrite:!0})}async dest(e){const t=e.clear();return d.notBlank(this.ext)&&d.blank(t.ext)||await t.isDirectory()?t.join(this.base):t}copyFile_(e){return C.time("fs.copyFile",(async()=>{const t=(await this.dest(e)).clear();if(this.nativePath===t.nativePath)return this;if(null==await t.parent().mkdirp())return this.bflog().throw("Cannot mkdirp "+t.dir);try{return await this._copyFile(t)}catch(e){if(A.isNonRetriableError(e))throw e;return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:t.nativePath,error:e}),await this._nativeCopyFile(t)}finally{this.clearThisAndParent()}}))}async _copyFile(e){let t,i,n=e;try{const r=await x.thenOrElse(this.stat(),(()=>this.clear().stat()));if(null==r)return this.bflog().throw("Can't copy missing files"+A.NonRetriableErrorFlag);if(0===r.size)await e.touch(r.mtime,r.atime);else{if(z.Settings.verifyFileCopies.valueOrDefault&&null==await this.sha())return this.bflog().throw("Can't copy file without SHA"+A.NonRetriableErrorFlag);i=e.wip();const a=s.default.copyFile(this.nativePath,i.nativePath);r.size>5*M.MiB&&(t=new Q.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},r.size,(()=>i.clear().size()))),await a;const o=await k.untilTrue((async()=>r.size===await i.clear().size()),{timeoutMs:q.CmdTimeoutMs});if(z.Settings.verifyFileCopies.valueOrDefault){const e=o&&await k.untilTrue((()=>O.eqlAsync(this.sha(),i.clear().sha())),{timeoutMs:q.CmdTimeoutMs});if(!e)return this.bflog().throw("copyFile_() failed",{sizeMatches:o,shaMatches:e})}if(!o)return this.bflog().throw("copyFile_() failed",{expectedSize:r.size,actualSize:await i.clear().size()});if(n=await i.unwip_(),null==n)return this.bflog().throw("copyFile_("+e+") failed: .unwip() was null");await s.default.utimes(n.nativePath,r.atime,r.mtime)}try{await s.default.chmod(n.nativePath,r.mode)}catch(e){this.bflog().debug(`copyFile_(${n.nativePath}) warning: couldn't chmod to ${r.mode}: ${e}`)}return this.bflog().debug(`copyFile_(${e.nativePath}): success`),_.emitFileCopied(this.nativePath,e.nativePath),e}catch(t){throw this.bflog().warn(`copyFile_(${null==i?void 0:i.nativePath}) failed: ${t}`),await(null==i?void 0:i.unlink()),await e.unlink(),t}finally{g.map(t,(e=>e.end()))}}async copyTimeoutMs(){return x.thenMapOr(this.size(),(e=>Math.max(q.CmdTimeoutMs,e*q.MinIoRate)),(()=>q.CmdTimeoutMs))}async _nativeCopyFile(e){let t;try{if(null==await e.parent().mkdirp())return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});const i=await this.stat(),n=g.map(i,(e=>e.size));return null==i||null==n?this.bflog().throw("Can't copy missing files"):(n>5*M.MiB&&(t=new Q.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},n,(()=>e.clear().size()))),B.isWin?await j.PowerShell.instance().execute(`Copy-Item -LiteralPath ${j.pwshQuote(this.nativePath)} -Destination ${j.pwshQuote(e.nativePath)}`,(e=>e)):await I.stdout("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:await this.copyTimeoutMs()}),_.emitFileCopied(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(t){return this.bflog().throw("_nativeCopyFile("+e+"): "+t)}finally{g.map(t,(e=>e.end()))}}async touch(e=Date.now(),t){return this.trap("touch",(()=>x.thenMap(this.ensureFile(),(()=>this.utimes(e,t)))))}async utimes(e,t){const i=g.orElse(e,Date.now()),n=g.orElse(t,i);return this.trap("utimes",(()=>s.default.utimes(this.nativePath,h.unixtime(n),h.unixtime(i)).then((()=>this.clearThisAndParent()))))}async unlink(e="warn"){return this.trap("unlink",(async()=>(await s.default.unlink(this.nativePath),this.clearThisAndParent())),e)}async rmrf(e="info"){return this.trap("rmrf",(async()=>(this.bflog().log(e,"rmrf()"),await s.default.remove(this.nativePath),this.clearThisAndParent())))}async unlock(){return B.isMac&&await this.clear().exists()&&await I.stdout("chflags",["nouchg",this.nativePath],{timeout:q.CmdTimeoutMs}),this}async renameWithNameSuffix_(e){return x.thenMap(this.withNameSuffix(e).ensureNew_({emptyIsNew:!0}),(e=>e.unlink("debug").then((()=>this.mv_(e)))))}async mv_(e,t={overwrite:!1}){const i=await this.dest(e);if(this.nativePath===i.nativePath)return this.bflog().warn("mv(): no-op",new Error("internal error")),this;await i.parent().mkdirp(),this.bflog().debug("mv",i);try{await s.default.move(this.nativePath,i.nativePath,t)}catch(e){this.bflog().warn("mv() try #1 failed. Calling unlock() and waiting for source to be non-empty.",e),await Promise.all([this.unlock(),i.unlock()]),await k.untilTrue((()=>this.clear().isNonEmptyFile()),{timeoutMs:7*h.secondMs}),await s.default.move(this.nativePath,i.nativePath,t)}return await i.unlock(),this.clearThisAndParent(),i.clearThisAndParent()}async pipeTo(e,t){return this.trap("pipeTo("+e+")",(async()=>{const i=await this.sibling(e).ensureNew_();return await Z.pipelineAsync([r.default.createReadStream(this.nativePath),t,r.default.createWriteStream(i.nativePath)]),await this.unlink(),i}))}async gunzip(){return this.pipeTo(V.stripSuffix(this.base,".gz"),l.createGunzip())}async gzip(){return this.pipeTo(this.base+".gz",l.createGzip())}async compressBrotli(){return this.pipeTo(this.base+".br",l.createBrotliCompress())}ensureFile(){return this.trap("ensureFile",(()=>s.default.ensureFile(this.nativePath).then((()=>this.clearThisAndParent()))))}ensureFileSync_(){return s.default.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return K.nameWithoutCount(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get baseWithoutCountWithParent(){return this.parent().base+"/"+this.baseWithoutCount}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}async ensureNewNativePath(e){return K.ensureNewNativePath_({nativePath:this.nativePath,...e})}ensureNew_(e={}){return this.ensureNewNativePath(e).then((e=>this.for(e)))}async renameYMDHMS_(e){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");const t=h.fmtYMDHMS(await x.thenOrElse(this.mtime(),(()=>new Date))),i=g.mapOr(e,(e=>this.parent().join(e)),(()=>this.parent()));return this.mv_(i.join(this.name+"-"+t+this.ext),{overwrite:!0})}async saveIfNewOrDelete(e){if(await this.clear().isEmpty())return void await this.unlink("trace");const t=await this.siblingWithSameContents();if(null!=t)return await this.unlink(),t;const i=await this.sibling(e).ensureNew_();return this.mv_(i)}async chmod(e){return await s.default.chmod(this.nativePath,e),this.clear()}zreadline(){return r.default.createReadStream(this.nativePath).on("error",(e=>{throw new Error("Failed to read from "+this+": "+e)})).pipe(l.createGunzip()).on("error",(e=>{throw new Error("Failed to gunzip "+this+": "+e)})).pipe(new $.LineReader)}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return C.time("fs.childWithSameContents",(async()=>{if(await this.notExists()||!await this.isDirectory())return;const t=await e.size(),i=await this.children(),n=[];for(const r of b.toA(i))await r.size()!==t||e.eql(r)||n.push(r);if(u.isEmpty(n))return;const r=await e.sha();for(const e of n.sort(((e,t)=>W.diceCoeff(e.base,t.base))).reverse())if(await e.sha()===r)return e}))}async applyWip(e,t=0,i=15*h.secondMs){const n=this.wip();try{if(await n.parent().mkdirp(),(await n.clear().isRecent(i)||await this.clear().isRecent(i))&&(this.bflog().info("applyWip(): recent WIP exists. Waiting for a bit to see if someone else will do my work."),await k.untilTrue((()=>this.clear().isNonEmpty(t)),{timeoutMs:2*i,timeBetweenMs:500})))return void this.bflog().info("applyWip(): yay, someone else did my work.");await this.touch(),await n.unlink("trace");const r=await e(n);if(await k.untilTrue((()=>n.clear().isNonEmptyFile()),{timeoutMs:h.secondMs}))return await n.unwip_(),r;throw new Error("applyWip(): empty after apply for "+this)}catch(e){throw await n.unlink(),await this.unlink(),e}}async applyIfEmpty_(e,t=0){return await this.clear().isNonEmpty(t)?this.bflog().debug("applyIfEmpty(): non-empty"):(this.bflog().debug("applyIfEmpty(): empty, applying..."),await this.applyWip(e,t)),this.touch()}firstMatchingLine(e){const t=new E.Deferred("firstMatchingLine("+this+")"),i=r.default.createReadStream(this.nativePath,{flags:"r"});return i.on("error",(e=>{-2===e.errno||"ENOENT"===e.code?(t.maybeResolve(void 0),i.close()):t.maybeReject(e)})),i.on("close",(()=>t.maybeResolve(void 0))),X.onDataChunked(i,w.newlineRe,(n=>{const r=e.exec(n);null!=r&&(t.maybeResolve(r),i.close())})),t.promise}contemporary(e,t){return x.thenMap2Or(this.statTimes(),e.statTimes(),((e,i)=>{for(const n of e)for(const e of i)if(y.closeTo(n,e,t))return!0;return!1}),(()=>!1))}}t.BaseFile=ie,ie.attrTTL=3*h.minuteMs,ie.projectRoot=f.lazy((()=>{const e=Y.ProjectPath.Root();if(null==e)throw new Error("Cannot find project path");return ie.for(e)})),t.execDir=function(){return ie.for(process.execPath).parent()}},64974:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exifExtFilter=t.videoExtFilter=t.browserExtFilter=t.extFilter=t.excludedPathFilter=void 0;const n=i(31791),r=i(22766),s=i(3955);function a(e){return n.Filter.lift((t=>r.isExtType(null==t?void 0:t.ext,e)))}t.excludedPathFilter=function(e){const t=new Set(e.map((e=>e.toLowerCase())));return n.Filter.lift((e=>s.pathnames(e.nativePath).every((e=>!t.has(e.toLowerCase())))))},t.extFilter=a,t.browserExtFilter=a(r.ExtTypes.SupportedByCurrentBrowser),t.videoExtFilter=a(r.ExtTypes.Video),t.exifExtFilter=a(r.ExtTypes.AssetFile)},51081:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitLines=t.crlf=void 0;const n=i(11944),r=i(82798),s=i(99312),a=i(91464);t.crlf=function(e){const t=e+"\n";return s.isWin?t.replace(a.newlineRe,"\r\n"):t},t.splitLines=function(...e){return n.flatten(e.map((e=>r.toS(e).split(a.newlineRe))))}},57400:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryEntry=t.StatDirent=void 0;const n=i(35747),r=i(64298),s=i(85622),a=i(11448),o=i(39784),l=i(46852),u=i(7162),c=i(91464),d=i(3955),h=i(75123);class p{constructor(e,t){this.base=e,h.isSimpleDirent(t)?(this.isFile=t.isFile,this.isDirectory=t.isDirectory):(this.isFile=t.isFile(),this.isDirectory=t.isDirectory()),t instanceof n.Stats&&(this.size=t.size,this.mtimeMs=t.mtimeMs)}}t.StatDirent=p;const m=a.lazy((()=>u.mkLogger("DirectoryEntry")));class f{constructor(e,t){this.dir=e,this.dirent=t,this.nativePath=s.join(this.dir,t.base),this.ext=d.parseNativePath(t.base).ext}static async for(e){const t=d.parseNativePath(e);try{const i=await r.stat(e);return new f(t.dir,new p(t.base,i))}catch{return}}async join(...e){return f.for(s.join(this.nativePath,...e))}get base(){return this.dirent.base}get name(){return c.stripSuffix(this.base,this.ext)}get pathnames(){return this.nativePath.split(s.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}get isRoot(){return this.dir===s.parse(this.dir).dir}parent(){const e=d.parseNativePath(this.dir);return e.dir===this.dir?this:new f(e.dir,{base:e.base,isFile:!1,isDirectory:!0,mtimeMs:void 0,size:void 0})}async childNames(){try{return this.isDirectory()?(await h.readdir_(this.nativePath)).map((e=>e.basename)):void 0}catch(e){return void m().warn("childNames() failed to readdir("+this.nativePath+")",e)}}async children(){try{if(!this.isDirectory())return;return(await h.readdir_(this.nativePath)).map((e=>new f(this.nativePath,new p(e.basename,e))))}catch(e){return void m().warn("children() failed to readdir("+this.nativePath+")",e)}}async visitDescendantFiles(e){for(const t of o.toA(await this.children()))await(t.isFile()?e(t):t.isDirectory()?t.visitDescendantFiles(e):void 0)}async filterDescendantFiles(e){const t=[];return await this.visitDescendantFiles((async i=>{!0===await e(i)&&t.push(i)})),t}stat(){return r.stat(this.nativePath).catch((()=>{}))}async size(){return l.thenOrElse(this.dirent.size,(()=>l.thenMap(this.stat(),(e=>e.size))))}async mtimeMs(){return l.thenOrElse(this.dirent.mtimeMs,(()=>l.thenMap(this.stat(),(e=>e.mtimeMs))))}unlink_(){return r.unlink(this.nativePath)}}t.DirectoryEntry=f},21084:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpFileCache=t.FileCache=t.InstanceCacheMaxSize=void 0;const n=i(39938),r=i(43947),s=i(79015),a=i(51498);t.InstanceCacheMaxSize=64;class o extends a.FifoCache{constructor(){super(t.InstanceCacheMaxSize),r.later((()=>s.onFileChanged((e=>this.clearFromPath(e))))),r.later((()=>s.onClearCache((()=>this.clear())))),this.on("expire",((e,t)=>null==t?void 0:t.clear()))}clearFromPath(e){n.blank(e)?this.clear():this.visit(((t,i)=>{t.startsWith(e)&&i.clear()}))}}t.FileCache=o,t.NoOpFileCache=class{get(e){}set(e,t){return this}getOrSet(e,t){return t()}}},18941:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readFileType=void 0;const n=i(9796),r=i(64298),s=i(85622),a=i(39938),o=i(88491),l=i(43947),u=i(11448),c=i(54608),d=i(46852),h=i(79015),p=i(51498),m=i(91464),f=i(44546),g=i(53755);l.later((()=>{h.onClearCache((()=>{var e;return null===(e=y.prior())||void 0===e?void 0:e.clear()})),h.onFileChanged((e=>{var t,i;return null==e?null===(t=y.prior())||void 0===t?void 0:t.clear():null===(i=y.prior())||void 0===i?void 0:i.delete(e)}))}));const y=u.lazy((()=>new p.FifoCache(512,3*o.minuteMs)));function v(e){return m.stripPrefix(s.extname(e),".")}t.readFileType=async function(e){return y().getOrSet(e,(async()=>{const{buffer:t}=await g.readFilePart(e,0,248);return c.thenOpt(n.fromBuffer(t)).filter((e=>"image/tiff"!==e.mime)).orElse((()=>c.thenOpt(d.resolved(r.stat(e))).filter((e=>e)).flatMap((()=>f.exiftool().readRaw(e,["-mimetype"]))).flatMap((e=>e.MIMEType)).filter(a.notBlank).map((t=>({ext:v(e),mime:t}))).get())).get()}))}},92445:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Hanoi=t.HanoiFile=void 0;const n=i(11944),r=i(11448),s=i(66776),a=i(75556),o=i(39784),l=i(13779),u=i(46852),c=i(80294),d=i(6667),h=i(12651);class p{constructor(e,t,i,n=c.filestampUTC()){this.seq=e,this.set=t,this.name=i,this.stamp=n}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return this.fromBasename(e.base)}static fromBasename(e){return s.map(this.parseRe.exec(e),(e=>new p(parseInt(e[2],10),parseInt(e[3],10),e[4],e[1])))}}t.HanoiFile=p,p.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;class m{constructor(e,t,i){this.dir=e,this.sets=t,this.seq=i,this.mods=r.lazy((()=>a.times(this.sets,(e=>Math.pow(2,e))).reverse()))}static async for(e,t){return new m(e,t,s.orElse(await m.maxSeq(e),-1))}static async maxSeq(e){return d.max([...o.toA(await u.thenMap(e.childNames(),(e=>e.map((e=>{var t;return null===(t=p.fromBasename(e))||void 0===t?void 0:t.seq})))))])}set(e){return this.sets-this.mods().findIndex((t=>e%t==0))}next(e){const t=++this.seq;return new p(t,this.set(t),e)}async hanoiFiles(){const e=await this.dir.clear().childNames();return n.compact(null==e?void 0:e.map((e=>p.fromBasename(e))))}async validHanoiFiles(e){const t=await u.thenOrElse(e,(()=>this.hanoiFiles())),i=h.groupBy(t,(e=>e.set)),n=[];for(const e of i.keys())s.map(l.greatestBy(i.get(e),(e=>e.seq)),(e=>n.push(e)));return n}async staleHanoiFiles(e){const t=await u.thenOrElse(e,(()=>this.hanoiFiles())),i=(await this.validHanoiFiles(e)).map((e=>e.seq));return t.filter((e=>!i.includes(e.seq)))}async staleFiles(){return this.staleHanoiFiles().then((e=>e.map((e=>e.toFile(this.dir)))))}}t.Hanoi=m},59873:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.randomSha=t.numericSha=t.shortFsStringSha=t.shortStringSha=t.stringSha=t.fileSha=t.HashBits=void 0;const r=n(i(76417)),s=n(i(35747)),a=i(87748),o=i(66776),l=i(26588),u=i(6231);function c(e,i=t.HashBits){return r.default.createHash("sha512").update(e).digest().slice(0,i/8)}function d(e,t=9,i=u.Radix58,n=224){return i.encodeBuffer(c(e,n)).substring(0,t)}t.HashBits=192,t.fileSha=async function(e,i){const n=r.default.createHash("sha512");let a=0;const u=o.orElse(null==i?void 0:i.msbits,t.HashBits)/8;return await l.thenCollect(e,(e=>new Promise(((t,r)=>{const o=s.default.createReadStream(e,{autoClose:!0});o.on("error",(e=>r(e))),o.on("data",(e=>{var t;a+=e.length,null===(t=null==i?void 0:i.observer)||void 0===t||t.onProgress(a),n.update(e)})),o.on("end",(()=>t()))})))),n.digest().slice(0,u)},t.stringSha=c,t.shortStringSha=d,t.shortFsStringSha=function(e,t=24,i=u.GeoRadix,n=224){return d(e,t,i,n)},t.numericSha=function(e,t=48){return parseInt(c(a.stringify(e),t).toString("hex"),16)},t.randomSha=function(){return r.default.randomBytes(t.HashBits/8).toString("base64")}},64546:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hidden=void 0;const n=i(39938),r=i(88491),s=i(75556),a=i(98510),o=i(69317),l=i(99312),u=i(71663);t.hidden=function(e){return!!e.base.startsWith(".")||(l.isWin?async function(e){const t=await u.PowerShell.instance().executeJsonToA(["Get-Item -Force -LiteralPath",u.pwshQuote(e.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return a.opt(t).flatMap((e=>e[0])).flatMap((e=>e.Mode)).filter(n.notBlank).flatMap((e=>e.includes("h")||e.includes("s"))).getOrElse((()=>!1))}(e):!!l.isMac&&async function(e){try{const t=await o.stdout("stat",["-f","%f",e.nativePath],{timeout:10*r.secondMs}),i=s.toInt(t);return null!=i&&(32768&i)>0}catch(e){return!1}}(e))}},83873:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ignorableDirectory=t.ignorablePredicates=t.ignorableDirectoryPredicates=t.ignorableFile=t.ignorablePath=t.ignorablePathPredicates=t.Ignorable=void 0;const n=i(11944),r=i(39938),s=i(11448),a=i(47977),o=i(46852),l=i(7799),u=i(11935),c=i(7162),d=i(19658),h=i(99312),p=i(70032),m=i(32421),f=i(64546),g=i(95616),y=i(28659),v=i(3955),w=i(98250),b=i(39329),S=i(81412);class M{constructor(e=d.isTest){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map((e=>e.toLowerCase().normalize()))),this.ignorableDirectories=new Set(["#snapshot","__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Support","Applications","arangodb","cache","caches","CacheClip","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iMovie Cache","iTunes Cache","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","SteamApps","System Volume Information","System32","temp","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map((e=>e.toLowerCase()))),this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/resources\/media\/face/i,/\/facetile[-_]/i,/\/.*?\.photos?library\/(?!(masters?|originals)\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i],this.systemDirs=n.uniq(n.compactBlanks([a.appData(),l.getEnv("APPDATA"),l.getEnv("SYSTEMROOT"),l.getEnv("ProgramFiles"),l.getEnv("ProgramFiles(x86)")]).map((e=>e.toLowerCase().normalize()))),this.ignorableSubdirs=new p.SetSet,h.isLinux&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);const t=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",t),this.addIgnorableSubdirs("cygwin",t),this.addIgnorableSubdirs("cygwin64",t),this.addIgnorableSubdirs("local",t),this.addIgnorableSubdirs("Windows",["Boot","Containers","Cursors","Fonts","Help","Installer","Logs","Microsoft.NET","SoftwareDistribution","System","System32","SysWOW64","Temp"]),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...t]),this.addIgnorableSubdirs("lfs",["objects"]),this.addIgnorableSubdirs("var",["cache","crash","games","lib","local","lock","log","mail","run","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);const i=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",i),this.addIgnorableSubdirs("Perl64",i),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(l.getEnv("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("temp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),h.isWin&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,t){if(r.blank(e))return;const i=e.toLowerCase().normalize();n.compactBlanks(t).forEach((e=>this.ignorableSubdirs.add(i,e.toLowerCase().normalize())))}ignorablePathPredicates(e){const t=g.pathIsNeverIgnoredPredicate(e);if(null!=t)return t;const i=e.toLowerCase().normalize(),r=n.compactBlanks(v.pathnames(i));return{hiddenPosix:()=>r.some((e=>e.startsWith("."))),systemDir:()=>this.systemDirs.some((e=>i.startsWith(e))),ignorableRoot:()=>this.ignorableRootDirectories.has(r[0]),ignorableDirectory:()=>r.some((e=>this.ignorableDirectories.has(e))),ignorablePath:()=>this.ignorableSubdirs.has(r),ignorablePattern:()=>{const t=v.native2posix(e);return this.ignorableDirectoryPatterns.some((e=>e.test(t)))}}}ignorablePath(e){return u.orLogged([this.ignorablePathPredicates(e)],e,c.mkLogger("ignorablePath()"))}}t.Ignorable=M;const P=s.lazy((()=>new M));function E(e){return{...P().ignorablePathPredicates(e),notExists:()=>w.PosixFile.for(e).notExists()}}function T(e){return P().ignorablePath(e)}function x(e){const t=e.nativePath.toLowerCase().normalize();return g.pathIsNeverIgnored(e.nativePath)||g.pathIsNeverIgnored(t)?{pathIsNeverIgnored:()=>!1}:{...E(e.nativePath),snapDirectory:async()=>h.isLinux&&await S.ignorableSnapDir.apply(e),noMedia:async()=>!0===await y.hasNoMedia(e),hidden:()=>f.hidden(e),seemsRecursive:()=>b.seemsRecursive(e.pathnames),mountpoint:async()=>o.thenMapOr(m.mountpoints(),(t=>t.includes(e.nativePath)),(()=>!1))}}t.ignorablePathPredicates=E,t.ignorablePath=T,t.ignorableFile=function(e){return T(e.nativePath)},t.ignorableDirectoryPredicates=x,t.ignorablePredicates=async function(e){return await e.isDirectory()?x(e):E(e.nativePath)},t.ignorableDirectory=async function(e){return u.orLoggedAsync([x(e)],e.nativePath,c.mkLogger("ignorableDirectory()"))}},61861:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JsonFileStore=void 0;const n=i(11448),r=i(46852),s=i(7162),a=i(79141);t.JsonFileStore=class{constructor(e,t,i){this.file=e,this.mkObject=t,this.onWrite=i,this.prior=n.lazy((()=>this.file.readJson("debug")))}async read(){const e=await this.prior();return s.mkLogger("JsonFileStore").debug("prior "+this.file,e),null!=e?e:r.thenMap(this.mkObject(),(e=>this.write(e)))}async write(e){try{return await this.file.writeJSON_(e,{spaces:2}),await this.prior.set(Promise.resolve(e)),s.mkLogger("JsonFileStore").info("wrote to "+this.file,e),null!=this.onWrite&&await this.onWrite(this.file,e),e}catch(e){throw new a.WrappedError({cause:e,message:"Failed to write to "+this.file})}}}},94329:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LineReader=void 0;const n=i(92413),r=i(43947),s=i(44726),a=i(82798);class o extends n.Transform{constructor(){super({objectMode:!1,autoDestroy:!0})}async _transform(e,t,i){const n=(a.toS(this._prior)+a.toS(e)).split(s.newlineRe),o=n.pop();this._prior=""===o?void 0:o;for(const e of n)this.push(e)||await r.unrefDelay(1);i()}_flush(e){null!=this._prior&&this.push(this._prior),this._prior=void 0,e()}}t.LineReader=o},95616:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathIsNeverIgnoredPredicate=t.neverIgnore=t.pathIsNeverIgnored=void 0;const n=i(11944),r=i(11448),s=i(79015),a=i(7162),o=i(43414),l=i(3955),u=r.lazy((()=>a.mkLogger("NeverIgnoredPaths"))),c=r.lazy((()=>{o.Settings.neverIgnored.addListener((()=>{d.clear(),s.emitFileChanged(),u().info("Settings.neverIgnored changed",o.Settings.neverIgnored.value)})),o.Settings.scanPaths.addListener((()=>{d.clear(),s.emitFileChanged()})),s.onClearCache((()=>d.clear()))})),d=r.lazy((()=>(c(),new Set(n.compactBlanks([...o.Settings.scanPaths.values,...o.Settings.neverIgnored.values])))));function h(e){return d().has(e)||d().has(e.toLowerCase())}t.pathIsNeverIgnored=h,t.neverIgnore=function(...e){o.Settings.neverIgnored.push(...n.compactBlanks(e).map(l.resolveSimpleFile))},t.pathIsNeverIgnoredPredicate=function(e){return h(e)?{pathIsNeverIgnored:()=>!1}:void 0}},28659:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasNoMedia=t.isNoMediaName=void 0;const n=i(85622),r=i(88491),s=i(43947),a=i(11448),o=i(46852),l=i(79015),u=i(51498),c=i(7162),d=i(53719),h=i(98462),p=i(95616),m=i(3955),f=/^\.?NoMedia$/i;function g(e){return[e,e.toLowerCase(),e.toUpperCase()]}const y=Object.freeze([...g(".NoMedia"),...g("NoMedia")]);function v(e){return null!=f.exec(e)}t.isNoMediaName=v;const w=new u.FifoCacheAsync({maxSize:1024,timeoutMs:d.MountpointsTtlMs,clearEveryMs:r.minuteMs});s.later((()=>l.onClearCache((()=>w.clear())))),s.later((()=>l.onFileChanged((e=>{null==e?w.clear():w.deleteIf((t=>t.startsWith(e)))}))));const b=a.lazy((()=>c.mkLogger("hasNoMedia()")));t.hasNoMedia=async function e(t){return null!=t&&(p.pathIsNeverIgnored(t.nativePath)?b().tap({msg:t+" is never ignored",result:!1}):t instanceof h.BaseFile?e(await t.directoryEntry()):v(t.base)?b().tap({msg:t+" basename is NoMedia",result:!0}):m.pathnames(t.nativePath).some(v)?b().tap({msg:t+" parent path is NoMedia",result:!0}):!(!await t.isDirectory()||!0!==await w.getOrSetAsync(t.nativePath,(async()=>{for(const e of y)if(await m.nativePathExists(n.join(t.nativePath,e)))return b().tap({msg:t+" is a directory and has a noMedia child, "+e,result:!0});return!1})))||!t.isRoot&&o.thenMap(t.parent(),e))}},3955:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.gzip_=t.ensureNewNativePath_=t.DefaultEnsureNewOptions=t.isAbsolute=t.isUNC=t.nativePathIsReadableDirectory=t.nativePathExistsSync=t.nativePathExists=t.posixPathExistsSync=t.firstExistingDirectory=t.isDirectory=t.isEmpty=t.notExists=t.stat=t.isDirectorySync=t.addNameSuffix=t.countFromName=t.nameWithoutCount=t.posixPathFromGrandparent=t.posixPathFrom=t.pathnames=t.containedByNativePath=t.containedBy=t.parseNativePath=t.extname=t.parsePosixPath=t.resolve=t.resolveSimpleFile=t.native2posix=t.posix2native=void 0;const r=n(i(35747)),s=n(i(64298)),a=n(i(85622)),o=i(78761),l=i(39938),u=i(66776),c=i(75556),d=i(82798),h=i(13779),p=i(46852),m=i(13317),f=i(99312),g=i(91464),y=i(53719),v=i(84571),w=i(83837),b=a.default.posix;function S(e,t){if(l.blank(e))return e;if(a.default.sep===b.sep)return e;const i=l.notBlank(t)?a.default.sep+a.default.sep+t+a.default.sep:"",n=e.split(b.sep);return g.equalsIgnoreCase(n[0],t)&&n.unshift(),i+n.join(a.default.sep)}function M(e){return l.blank(e)||a.default.sep===b.sep||b.sep===a.default.sep?e:e.split(a.default.sep).join(b.sep)}t.posix2native=S,t.native2posix=M;const P=/^([A-Z]:)[\\/]?(.*)$/i;function E(...e){const t=a.default.join(...e);return a.default.resolve(f.isWin?function(e){const t=P.exec(e);return null!=t?t[1].toUpperCase()+"\\"+t[2]:e}(t):t)}t.resolveSimpleFile=function(e){return u.orElse(e.nativePath,(()=>E(e.toString())))},t.resolve=E,t.parsePosixPath=function(e){return x(S(e))},t.extname=function(e){return x(e).ext};const T=/(\.(?:gz|z|7z|xz|bz2))$/i;function x(e){const t=g.spliceCapture(e,T),i=a.default.parse(u.orElse(null==t?void 0:t.uncaptured,e));return{...i,...null==t?{}:{ext:i.ext+t.captured,base:i.base+t.captured}}}function D(e){return g.stripPrefix(e,a.default.sep).split(a.default.sep)}t.parseNativePath=x,t.containedBy=function(e,t){return l.notBlank(e)&&l.notBlank(t)&&(e===t||e.startsWith(g.ensureSuffix(t,b.sep)))},t.containedByNativePath=function(e,t){return l.notBlank(e)&&l.notBlank(t)&&(e===t||e.startsWith(g.ensureSuffix(t,a.default.sep)))},t.pathnames=D,t.posixPathFrom=function(e,t){return e.nativePath===t.nativePath?"":g.stripPrefix(M(t.nativePath),g.ensureSuffix(M(e.nativePath),"/"))},t.posixPathFromGrandparent=function(e){return D(e).slice(-3).join("/")};const C=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function k(e){if(l.blank(e))return!1;try{return r.default.statSync(e).isDirectory()}catch{return!1}}async function I(e){if(!l.blank(e))try{return await m.thenOrTimeout(s.default.stat(e),y.MountpointsTtlMs)}catch{return}}function F(e){if(l.blank(e))return!1;try{return r.default.existsSync(e)}catch{return!1}}function O(e){return e.startsWith("\\\\")}function A(e){return null==e||e.isFile()&&0===e.size}t.nameWithoutCount=function(e){return u.mapOr(d.toS(e).match(C),(e=>e[1]),(()=>e)).toLowerCase().normalize()},t.countFromName=function(e){return u.map(d.toS(e).match(C),(e=>h.first([e[2],e[3]],c.toInt)))},t.addNameSuffix=function(e,t){const i=x(e);return`${i.base}${t}${i.ext}`},t.isDirectorySync=k,t.stat=I,t.notExists=async function(e){return null==await I(e)},t.isEmpty=async function(e){const t=await I(e);return null==t||t.isFile()&&0===t.size},t.isDirectory=async function(e){return p.thenMapOr(I(e),(e=>e.isDirectory()),(()=>!1))},t.firstExistingDirectory=function(e){for(const t of e)if(l.notBlank(t)){const e=E(t);if(k(e))return e}},t.posixPathExistsSync=function(e){return l.mapNotBlankOr(e,(e=>F(S(e))),!1)},t.nativePathExists=async function(e){if(l.blank(e))return!1;try{return null!=await I(e)}catch{return!1}},t.nativePathExistsSync=F,t.nativePathIsReadableDirectory=async function(e,t=v.StatTimeoutMs){if(l.blank(e))return!1;try{const i=await m.thenOrTimeout(I(e),t);return!(null==i||!i.isDirectory())&&await p.resolvedWithin(s.default.access(e,r.default.constants.R_OK|(f.isWin?0:r.default.constants.X_OK)),t)}catch{return!1}},t.isUNC=O,t.isAbsolute=function(e){return f.isPosix&&e.startsWith("/")||f.isWin&&(O(e)||null!=e.match(P))},t.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1}),t.ensureNewNativePath_=async function(e){const i={...t.DefaultEnsureNewOptions,...e},n=x(i.nativePath);await s.default.mkdirp(n.dir);{const e=await I(i.nativePath);if(!i.requireNumber&&(null==e||i.emptyIsNew&&A(e)))return i.nativePath}for(let e=i.startIndex;e<=i.maxVersions;e++){const t=a.default.join(n.dir,`${n.name}-${g.leftPad(e,i.leftPad,"0")}${n.ext}`),r=await I(t);if(null==r||i.emptyIsNew&&A(r))return t}throw new Error("There are already more than "+i.maxVersions+" of "+i.nativePath)},t.gzip_=async function(e){if(e.endsWith(".gz"))return e;const t=e+".gz";return await w.pipelineAsync([r.default.createReadStream(e),o.createGzip(),r.default.createWriteStream(t)]),await s.default.unlink(e),t}},9288:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.arpWin=t.pingWin=t.nslookupWin=t.fsutil=t.wmic=void 0,t.wmic=()=>"wmic",t.fsutil=()=>"fsutil",t.nslookupWin=()=>"nslookup",t.pingWin=()=>"ping",t.arpWin=()=>"arp"},98250:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PosixFile=t.coalesce=t.uniquePrefixes=t.groupByMountpoint=void 0;const n=i(85622),r=i(11944),s=i(39938),a=i(88491),o=i(11448),l=i(66776),u=i(75556),c=i(98510),d=i(54608),h=i(44726),p=i(39784),m=i(82798),f=i(13779),g=i(46852),y=i(69317),v=i(79015),w=i(7162),b=i(6231),S=i(12651),M=i(99312),P=i(43414),E=i(91464),T=i(22766),x=i(3874),D=i(19209),C=i(25116),k=i(32421),I=i(98462),F=i(21084),O=i(59873),A=i(64546),_=i(83873),L=i(28659),R=i(3955),N=new F.FileCache;function B(e,t){return S.groupBy(e,(e=>l.map(e.bestMountpoint(t),(e=>e.nativePath))))}function j(e){return r.sortBy(e,(e=>e.nativePath))}function z(e){return f.contextFilter(j(e),((e,t,i)=>null==i||!e.isDescendantOf(i)))}t.groupByMountpoint=B,t.uniquePrefixes=z,t.coalesce=function(e,t){const i=B(e,t);return j(r.flatten(p.toA(i.values()).map(z)))};class V extends I.BaseFile{constructor(e,t){super(e,t),this.nativePath=e,this.pflog=o.lazy((()=>w.mkLogger("PosixFile("+this.nativePath+")"))),this.uriObject=o.lazy((()=>x.nativePath2uri(this.nativePath))),this.uri=o.lazy((()=>g.thenMap(this.uriObject(),m.toS))),this.fileuri=o.lazy((()=>D.URI.file(this.nativePath).toString())),this.mountpoint=o.lazy((()=>M.isWin&&this.nativePath.startsWith("\\\\")?this.for(this.nativePath.split("\\").slice(0,4).join("\\")):g.thenMap(k.mountpoints(),(e=>this.bestMountpoint(e.map((e=>this.for(e)))))))),this.etag=o.lazy((()=>g.thenMap(this.stat(),(e=>[e.size,e.mtime.getTime()].map((e=>b.Radix58.encode(e))).join("-"))))),this.isMountpoint=o.lazy((async()=>await this.isDirectory()&&await g.thenMapOr(k.mountpoints(),(e=>e.includes(this.nativePath)),(()=>!1)))),this.sidecars=o.lazy((async()=>{if(this.isSidecar())return[];const e=await this.parent().childDirectoryEntries((e=>e.base!==this.base&&T.isSidecarExt(e.ext)&&(e.name===this.name||e.name===this.base||!!P.Settings.matchSidecarsCaseInsensitively.valueOrDefault&&(E.equalsIgnoreCase(e.name,this.name)||E.equalsIgnoreCase(e.name,this.base))||R.nameWithoutCount(e.name)===R.nameWithoutCount(this.name)||!!P.Settings.matchSidecarsCaseInsensitively.valueOrDefault&&E.equalsIgnoreCase(R.nameWithoutCount(e.name),R.nameWithoutCount(this.name)))));if(null==e)return[];const t=e.map((e=>this.parent()._directoryEntryChild(e)));return g.sortByAsync(t,(e=>e.maxStatMs()))})),this.shaWithSidecars=o.lazy((async()=>{const e=[this,...await this.sidecars()].map((e=>e.nativePath));return(await O.fileSha(r.sort(e))).toString("base64")}),I.BaseFile.attrTTL)}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,t){if(s.blank(e))throw new Error("unexpectedly empty path");if(e instanceof V)return e;if(e instanceof I.BaseFile)return this.for(e.nativePath,t);if(C.isUri(e))throw new Error("use forUri");const i=N.get(e);if(null!=i)return i;const n=R.resolve(e);return N.getOrSet(n,(()=>new V(n,t)))}static forPosix(e){return this.for(e.replace(/\//g,n.sep))}static forUri(e,t){return g.thenMap(x.uri2nativePath(e,t),(e=>this.for(e)))}for(e,t){return V.for(e,t)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.sidecars.unset(),this}bestMountpoint(e){return f.greatestBy(e.filter((e=>R.containedByNativePath(this.nativePath,e.toString()))).map((e=>V.for(e))),(e=>c.opt(r.commonPrefixLength(this.pathnames,e.pathnames)).filter((t=>t>=e.pathnames.length)).get()))}async isDeleted(e){if(e=await s.notBlankOr(e,(()=>this.uri())),this.isUNC)return this.pflog().tap({result:void 0,msg:"isDeleted(): UNC not supported"});if(await this.exists())return this.pflog().tap({result:!1,msg:"isDeleted(): file exists"});if(null==e)return this.pflog().tap({result:void 0,level:"warn",msg:"isDeleted(): missing URI"});if((e=D.toURI(e)).isRootPath())return this.pflog().tap({result:void 0,msg:"isDeleted(): uri isRootPath",meta:{uri:e}});if(m.toS(e.pathBase).normalize()!==this.base.normalize())return this.pflog().tap({level:"warn",result:void 0,msg:"isDeleted(): uri isn't correct",meta:{uri:e,expectedBase:this.base,uriBase:e.pathBase}});const t=await this.parent().isDeleted(e.parent());return null==t?this.pflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{uri:e}}):this.pflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted, which means I am deleted.",meta:{parentDeleted:t,uri:e}})}async httpHeaders(){return{ETag:await this.etag(),"Last-Modified":await this.lastModifiedUtc()}}async hide(){const e=await(M.isWin?y.stdout("attrib",["+h",this.nativePath],{timeout:10*a.secondMs}).catch((e=>e)):M.isMac?y.stdout("chflags",["hidden",this.nativePath],{timeout:10*a.secondMs}).catch((e=>e)):"");return s.notBlank(e)?void this.pflog().warn("hide("+this.nativePath+") failed: "+e):this.clear()}ignorableParent(){return this.trapOr("ignorableParent",(()=>this.nearestDir().then((e=>e.ignorable()))))}async mkNoMedia_(){if(await this.isFile())throw new Error("mkNoMedia(): "+this+" is a file.");await this.mkdirp_();const e=this.join(".NoMedia");await e.isNotDirectory()&&await e.isEmpty()&&(await e.writeTxt_(["This directory's contents are excluded from PhotoStructure libraries.","","See <https://photostructure.com/nomedia/> for details."].join("\n")),v.emitFileChanged(this.nativePath))}async mkNoMedia(){try{return await this.mkNoMedia_(),this}catch(e){return void this.pflog().warn("Could not add .NoMedia file to "+this,e)}}hasNoMedia(){return L.hasNoMedia(this)}ignorableCheap(){return _.ignorablePath(this.nativePath)}async ignorable(){return await this.isDirectory()?_.ignorableDirectory(this):_.ignorableFile(this)}hidden(){return A.hidden(this)}isSidecar(){return T.isSidecarExt(this.ext)}async sidecar(){return d.thenOpt(this.sidecars()).flatMap((e=>e[e.length-1])).getOrElse((()=>this.sibling(this.base+h.ensurePrefix(P.Settings.defaultSidecarType.valueOrDefault,".").toLowerCase())))}async jsonSidecars(){const e=await this.siblings((e=>E.equalsIgnoreCase(e.ext,".json")&&(e.name===this.name||e.name===this.base||R.nameWithoutCount(e.name)===R.nameWithoutCount(this.name))));return this.pflog().tap({msg:"jsonSidecars()",result:null==e?void 0:await g.sortByAsync(e,(e=>e.maxStatMs()))})}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",(async()=>{const e=await this.mtimeMs(),t=await this.sidecars(),i=[e,...await Promise.all(p.toA(t).map((e=>e.mtimeMs())))].filter(u.gt0);return r.mapNotEmpty(i,(e=>Math.floor(Math.max(...e))))}))}thisOrSidecareMaxMtimeSec(){return g.thenMap(this.thisOrSidecareMaxMtimeMs(),(e=>a.unixtime(e)))}}t.PosixFile=V},23872:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.excludeDirnameFilter=t.onlyDirectories=t.extless=t.expensiveFileFilter=t.expensiveFileFilters=t.cheapFileFilter=t.noStatFileFilter=t.fileSizeFilter=t.noMediaFilter=t.notHiddenCheap=t.supportedMimeTypeFilter=t.videoFilter=t.imageFilter=t.hasBrowserImgMimetype=t.notRejected=t.hasMakeAndModel=t.hasMimeType=t.minVideoDurationFilter=t.minDimensionsFilter=t.requiredTagsFilter=t.onlyReadable=t.onlyFiles=void 0;const n=i(11944),r=i(39938),s=i(11448),a=i(75556),o=i(82798),l=i(13779),u=i(91419),c=i(46852),d=i(71923),h=i(49312),p=i(46517),m=i(15271),f=i(7162),g=i(70283),y=i(43414),v=i(27947),w=i(44546),b=i(23199),S=i(64974),M=i(83873),P=i(28659);function E(e){return u.AsyncFilter.lift((async t=>c.thenMapOr(w.readRawTags(t,!1),e,(()=>!1))))}function T(e){return E((t=>l.allNotBlank(...e.map((e=>t[e])))))}t.onlyFiles=u.AsyncFilter.lift((e=>e.isFile())),t.onlyReadable=u.AsyncFilter.lift((e=>e.isReadable())),t.requiredTagsFilter=T,t.minDimensionsFilter=u.AsyncFilter.lift((async e=>{const t=await w.mimetype(e);if(null==t||!t.startsWith("image/")&&!t.startsWith("video/"))return!1;const i=t.startsWith("video/")?y.Settings.minVideoDimension.valueOrDefault:y.Settings.minImageDimension.valueOrDefault;return c.thenMapOr(w.sizeInfo(e),(e=>a.gte(e.ImageWidth,i)&&a.gte(e.ImageHeight,i)),(()=>!1))})),t.minVideoDurationFilter=u.AsyncFilter.lift((async e=>{const t=await w.mimetype(e);if(null==t)return!1;if(!t.startsWith("video/"))return!0;const i=await w.readRawTags(e,!1);return null!=i&&a.gte(v.extractDurationSec(i),y.Settings.minVideoDurationSec.valueOrDefault)})),t.hasMimeType=T(["MIMEType"]),t.hasMakeAndModel=T(["Make","Model"]),t.notRejected=E((e=>a.toInt(e.Rating,{defaultValue:0})>=0)),t.hasBrowserImgMimetype=E((e=>n.includes(["image/jpeg","image/png"],o.toS(e.MIMEType)))),t.imageFilter=E((e=>o.toS(e.MIMEType).startsWith("image/"))),t.videoFilter=E((e=>o.toS(e.MIMEType).startsWith("video/")));const x=t.imageFilter.and(t.hasMakeAndModel).or(t.videoFilter);async function D(e){return!r.blank(e)&&(b.isSharpMimetype(e)||b.isLibrawMimetype(e)||m.isVideoMimeType(e)&&await p.isVideoSupported()||h.isHeifMimetype(e)&&await d.isHeifSupported())}t.supportedMimeTypeFilter=u.AsyncFilter.lift((async e=>c.thenMapOr(w.mimetype(e.nativePath),D,(()=>!1)))),t.notHiddenCheap=u.AsyncFilter.lift((async e=>!M.ignorablePath(e.nativePath))),t.noMediaFilter=u.AsyncFilter.lift((async e=>c.thenNot(P.hasNoMedia(e)))),t.fileSizeFilter=u.AsyncFilter.lift((async e=>c.thenMapOr(e.size(),(e=>g.within(y.Settings.minAssetFileSizeBytes.valueOrDefault,y.Settings.maxAssetFileSizeBytes.valueOrDefault,e)),(()=>!1)))),t.noStatFileFilter=u.AsyncFilter.andLogged(f.mkLogger("fileFilterNoStat"),{exifExtFilter:S.exifExtFilter},{notHiddenCheap:t.notHiddenCheap}),t.cheapFileFilter=u.AsyncFilter.andLogged(f.mkLogger("fileFilterCheap"),{exifExtFilter:S.exifExtFilter},{notHiddenCheap:t.notHiddenCheap},{noMediaFilter:t.noMediaFilter},{fileSizeFilter:t.fileSizeFilter}),t.expensiveFileFilters=s.lazy((()=>n.compact([{exifExtFilter:S.exifExtFilter},{fileSizeFilter:t.fileSizeFilter},{notHiddenCheap:t.notHiddenCheap},{noMediaFilter:t.noMediaFilter},{hasMimeType:t.hasMimeType},{supportedMimeTypeFilter:t.supportedMimeTypeFilter},y.Settings.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:x}:void 0,{notRejected:t.notRejected},{minDimensionsFilter:t.minDimensionsFilter},y.Settings.minVideoDurationSec.valueOrDefault>0?{minVideoDurationFilter:t.minVideoDurationFilter}:void 0]))),t.expensiveFileFilter=s.lazy((()=>u.AsyncFilter.andLogged(f.mkLogger("expensiveFileFilter"),...t.expensiveFileFilters()))),t.extless=u.AsyncFilter.lift((async e=>r.blank(e.ext))),t.onlyDirectories=u.AsyncFilter.lift((async e=>e.isDirectory())),t.excludeDirnameFilter=function(e){return u.AsyncFilter.and(S.excludedPathFilter(e),t.onlyDirectories)}},54953:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PullProgressObserver=t.PushProgressObserver=void 0;const n=i(78213),r=i(41663),s=i(66776),a=i(75556),o=i(26719),l=i(46852);t.PushProgressObserver=class{constructor(e,t,i=500){this.context=e,this.total=t,this.throttleMs=i,this.start=Date.now(),this.emit=o.throttle((()=>{r.emitProgressEvt({...this.context,pct:this.pct,elapsedMs:this.elapsedMs})}),this.throttleMs,!0)}incrProgress(e){this.onProgress(e+s.orElse(this.current,0))}onProgress(e){this.current=a.clamp(0,this.total,s.orElse(e,s.orElse(this.current,0)+1)),this.emit()}get pct(){return a.round(100*s.orElse(this.current,0)/this.total)}get elapsedMs(){return Date.now()-this.start}},t.PullProgressObserver=class{constructor(e,t,i,r=500){this.ctx=e,this.total=t,this.progress=i,this.throttleMs=r,this.start=Date.now(),this.onInterval=o.throttle((()=>l.thenMap(this.progress(),(e=>this.emit(e)))),this.throttleMs),this.timer=n.setInterval((()=>this.onInterval()),500)}observe(e){return e.then((()=>this.completed())).catch((()=>this.end())),e}emit(e){s.map(e,(e=>r.emitProgressEvt({...this.ctx,pct:100*a.clamp(0,this.total,e)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>500&&this.emit(this.total),this.end()}end(){s.map(this.timer,(e=>n.clearInterval(e))),this.timer=void 0}}},27175:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectPath=t.execDir=void 0;const n=i(85622),r=i(61765),s=i(11944),a=i(11448),o=i(9678),l=i(13779),u=i(99312),c=i(40786);t.execDir=a.lazy((()=>n.dirname(process.execPath))),function(e){e.Root=a.lazy((()=>{const e=["icc","migrations","public","views"],i=[];u.isDocker()&&i.push("/ps/app"),u.isElectron&&i.push(n.join(t.execDir(),"resources"),n.join(t.execDir(),"..","Resources")),i.push(...s.compactBlanks([t.execDir(),r.cwd(),__dirname])),l.uniqInPlace(i);for(const t of i){if(c.hasChildren(t,e))return t;for(const i of c.ancestors(t).slice(0,4)){if(c.hasChildren(i,e))return i;const r=n.join(t,"node_modules","photostructure");if(c.hasChildren(r,e))return r}}throw new Error("Failed to find project root. Looked in "+i)}));const i=t=>a.lazy((()=>n.join(e.Root(),t)));e.Bin=i("bin"),e.ICC=i("icc"),e.Migrations=i("migrations"),e.Public=i("public"),e.Tools=i("tools"),e.Views=i("views"),e.isInDMG=async function(t=e.Root()){return!!u.isMac&&null!=new RegExp(`^\\/Volumes\\/${o.SimpleAppName}[^\\/]*\\/${o.SimpleAppName}.app\\/`,"i").exec(t)}}(t.ProjectPath||(t.ProjectPath={}))},4931:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readFileMaybe=void 0;const n=i(69225),r=i(11448),s=i(7162),a=r.lazy((()=>s.mkLogger("ReadFile")));t.readFileMaybe=async function(e){try{return await n.readFile(e)}catch(t){return void a().info(".readFileMaybe("+e+")",t)}}},53755:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readFilePart=void 0;const n=i(64298),r=i(66776),s=i(46852),a=i(70283);t.readFilePart=async function(e,t=0,i){let o=-1;try{const l=await r.orElse(i,(()=>s.thenMap(n.stat(e),(e=>e.size-t)))),u=Buffer.alloc(l);return o=await n.open(e,"r"),await n.read(o,u,0,l,t)}finally{await a.mapGte0(o,n.close)}}},75123:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readdir_=t.isSimpleDirent=t.cachedReadDirJson=t.readdirCacheDir=t.ReadDirCacheName=void 0;const n=i(64298),r=i(85622),s=i(39938),a=i(88491),o=i(43947),l=i(11448),u=i(21142),c=i(38625),d=i(70403),h=i(79015),p=i(51498),m=i(7162),f=i(43414),g=i(91464),y=i(53719),v=i(59873),w=i(95998);async function b(e){return r.join(await t.readdirCacheDir(),...g.splitEvery(v.shortFsStringSha(e)+".json.gz",2,3))}t.ReadDirCacheName="readdircache",t.readdirCacheDir=l.lazy((async()=>{const e=r.join(f.Settings.cacheDir.valueOrDefault,t.ReadDirCacheName);return await n.mkdirp(e),e}),a.minuteMs),t.cachedReadDirJson=b;const S=l.lazy((()=>m.mkLogger("Readdir")));function M(e){return null!=e&&s.notBlank(e.basename)&&c.isBoolean(e.isFile)&&c.isBoolean(e.isDirectory)}t.isSimpleDirent=M,o.later((()=>{h.onClearCache((()=>{var e;return null===(e=P.prior())||void 0===e?void 0:e.clear()})),h.onFileChanged((e=>{var t,i;null==e?null===(t=P.prior())||void 0===t||t.clear():null===(i=P.prior())||void 0===i||i.deleteIf((t=>t.startsWith(e)))}))}));const P=l.lazy((()=>new p.FifoCacheAsync({maxSize:500,timeoutMs:y.CmdTimeoutMs,clearEveryMs:a.minuteMs})));t.readdir_=async function(e){const t=await P().getOrSetAsync(e,(()=>async function(e){const t=await b(e);try{const e=(await n.stat(t)).mtimeMs;if(Date.now()-e<f.Settings.readdirCacheSeconds.valueOrDefault*a.secondMs){let e;if(await u.untilTrue((async()=>(e=await w.readJsonGz_(t),null!=e&&Array.isArray(e)&&e.every(M))),{timeoutMs:y.CmdTimeoutMs-a.secondMs,timeBetweenMs:250}))return e}}catch(e){"ENOENT"!==e.code&&S().debug("Failed to read from readdir cache",e)}const i=await d.thenElapsed(n.readdir(e,{withFileTypes:!0})),r=g.sortByCaseInsensitive(i.result.map((e=>({basename:e.name,isFile:e.isFile(),isDirectory:e.isDirectory()}))),(e=>e.basename));if(i.elapsedMs>=500)try{await w.outputJsonGz_(t,r),S().debug("Wrote readdir cache for slow directory",{nativePath:e,elapsedMs:i.elapsedMs})}catch(e){S().debug("Failed to write to readdir cache",e)}return r}(e)));if(null==t)throw new Error("readdir() timeout for "+e);return t}},64021:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrSetByNativePath=t.sameNativePaths=void 0;const n=i(43947),r=i(39784),s=i(79015),a=new(i(51498).FifoCache)(256);function o(e){return[e.toString(),...r.toA(a.get(e.toString()))]}n.later((()=>s.onClearCache((()=>a.clear())))),n.later((()=>s.onFileCopied(((e,t)=>{a.getOrSet(e,(()=>[])).push(t),a.getOrSet(t,(()=>[])).push(e)})))),t.sameNativePaths=o,t.getOrSetByNativePath=function(e,t,i){for(const t of o(e)){const e=i.get(t);if(null!=e)return e}const n=t(e);return i.set(e.toString(),n),n}},39329:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.seemsRecursive=void 0;const n=i(11944),r=i(43414);t.seemsRecursive=function(e){const t=r.Settings.maxDuplicatePathElements.valueOrDefault;for(const i of new Set(e))if(n.count(e,(e=>e===i))>t)return!0;return!1}},81412:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.snaps=t.hasSnap=t.ignorableSnapDir=void 0;const n=i(88491),r=i(11448),s=i(39784),a=i(91419),o=i(69317),l=i(82128),u=i(7162),c=i(99312),d=i(3955),h=u.mkLogger("Snap");t.ignorableSnapDir=a.AsyncFilter.lift((async e=>{if(!await t.hasSnap())return!1;const i=d.pathnames(e.nativePath).indexOf("snap");return!(i<0)&&s.toA(await t.snaps()).includes(d.pathnames[i+1])})),t.hasSnap=r.lazy((async()=>{if(!c.isLinux||c.isDocker())return!1;try{return await o.stdout("snap",["--version"],{timeout:10*n.secondMs,quiet:!0,maxRetries:0}),!0}catch{return!1}})),t.snaps=r.lazy((async()=>{if(!await t.hasSnap())return[];try{return await l.parseFixed(["Name","Version"],await o.stdout("snap",["list"],{timeout:10*n.secondMs})).map((e=>e.Name))}catch(e){return h.warn("snap failed",e),[]}}),30*n.secondMs)},76531:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mtimeMs=t.maybeSizeSync=void 0;const n=i(64298),r=i(39938),s=i(98510);t.maybeSizeSync=function(e){try{return s.opt(e).filter(r.notBlank).flatMap(n.statSync).flatMap((e=>Number(e.size))).get()}catch{return}},t.mtimeMs=function(e){return n.stat(e).then((e=>e.mtimeMs)).catch((()=>{}))}},84571:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatTimeoutMs=void 0;const n=i(88491);t.StatTimeoutMs=25*n.secondMs},45512:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunker=t.onDataChunked=void 0;const n=i(39938),r=i(6314);t.onDataChunked=function(e,t,i){const n=new s(t,i,!0);return n.read(e),n.done};class s{constructor(e,t,i=!0){this.sep=e,this.onData=t,this.filterBlanks=i,this.incompleteChunk="",this.done=new r.Latch}onChunk(e){if(null==e)return;const t=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=t.pop(),t.forEach((e=>{this.filterBlanks&&!n.notBlank(e)||this.onData(e)}))}clear(){this.onChunk(""),n.notBlank(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",(e=>this.onChunk(e))),e.on("end",(()=>{this.clear(),this.done.resolve()})),this}}t.Chunker=s},83837:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ByteCounter=t.remoteDesc=t.pipelineAsync=t.closeStreams=t.onChildError=t.closeStream=t.endStream=t.PassthroughStream=t.ReadableBuffer=void 0;const n=i(92413),r=i(31669),s=i(43947),a=i(66776),o=i(61570),l=i(90957),u=i(36079),c=i(49379),d=i(2023);class h extends n.Readable{constructor(e){super(),this.push(e),this.push(null)}}t.ReadableBuffer=h;class p extends n.Duplex{_write(e,t){this.push(e,t)}}t.PassthroughStream=p,t.endStream=async function(e){null!=e&&(d.Try((()=>o.maybeCall(e,"unref"))),u.ending()?e.end(null):await new Promise((t=>e.end(null,t))),await s.unrefDelay(50),d.Try((()=>o.maybeCall(e,"destroy"))))},t.closeStream=async function(e){null!=e&&(d.Try((()=>o.maybeCall(e,"unref"))),u.ending()?e.close(l.NoOp):await new Promise((t=>e.close(t))))},t.onChildError=function(e,t){[{name:"cp",ea:e},{name:"stdin",ea:e.stdin},{name:"stdout",ea:e.stdout},{name:"stderr",ea:e.stderr}].forEach((({name:e,ea:i})=>a.map(i,(i=>i.on("error",(i=>{c.isIgnorableError(i)||t(e,i)}))))))},t.closeStreams=function(e){for(const t of[null==e?void 0:e.stdin,null==e?void 0:e.stdout,null==e?void 0:e.stderr])try{null==t||t.destroy()}catch{}},t.pipelineAsync=r.promisify(n.pipeline),t.remoteDesc=function(e){return e.destroyed?"destroyed":`${e.remoteFamily}:${e.remoteAddress}:${e.remotePort}`};class m extends n.Transform{constructor(e){super({transform:(e,t,i)=>{this.onProgress(this.bytes+=e.length),i(e)}}),this.onProgress=e,this.bytes=0}}t.ByteCounter=m},86664:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TmpfileCleanup=void 0;const n=i(11944),r=i(88491),s=i(75556),a=i(28807),o=i(70259),l=i(21142),u=i(28659);class c extends a.EndableInterval{constructor(e,t,i,n=!0){super({name:"TmpfileCleanup",intervalMs:s.clamp(10*r.secondMs,15*r.minuteMs,t/5),callback:()=>this.cleanup()}),this.root=e,this.maxAgeMs=t,this.filter=i,this.scheduleCleanup=n,this.mutex=new o.Promises,this.lastCleanupFinishTs=0}async cleanup(e=this.maxAgeMs){return this.ended||Date.now()-this.lastCleanupFinishTs<10*r.secondMs?void 0:this.mutex.maybeRun("cleanup",(()=>this._cleanup(e)))}async _cleanup(e){const t=await this.root();if(null==t)return[];const i=Date.now()-e,s=[];await t.clear().visitDescendants((async e=>{const n=await e.maxStatMs();await e.isFile()&&null!=n&&(!e.parent().eql(t)||!u.isNoMediaName(e.base))&&await this.filter(e)&&n<i&&(s.push(e),await e.unlink().catch((t=>this.logger.warn("Failed to unlink "+e,t))))}));const a=s.length;return this.logger.info("Removed "+a+" files."),await t.clear().visitDescendants((async e=>{if(e.clear(),await e.isDirectory()&&!await e.hasNoChildren()){const t=await e.childDirectoryEntries();n.isNotEmpty(t)&&t.map((e=>e.nativePath)).every((e=>s.some((t=>t.nativePath===e))))&&await l.untilTrue((()=>e.rmdir()),{timeoutMs:7*r.secondMs})&&s.push(e)}await e.isDirectory()&&await e.hasNoChildren()&&(s.push(e),await e.rmdir().catch((t=>this.logger.warn("Failed to rmdir "+e,t))))})),this.logger.info("Pruned "+(s.length-a)+" empty directories."),this.lastCleanupFinishTs=Date.now(),s}}t.TmpfileCleanup=c},22143:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sqliteNativePath=t.jpegtranNativePath=t.rawIdentifyNativePath=t.dcrawEmuNativePath=t.pathToTool=t.pathTo=void 0;const r=n(i(12087)),s=i(39938),a=i(11448),o=i(66776),l=i(64975),u=i(69317),c=i(49379),d=i(99312),h=i(53719),p=i(98462),m=i(27175);async function f(e){var t;const i=d.isWin?"where":"which";try{const n=await u.stdoutResult(i,[e],{timeout:h.CmdTimeoutMs,ignoreExitCode:!0,ignoreStderr:!0});return 0===n.code&&s.notBlank(n.result)?null===(t=n.result.trim().split("\n")[0])||void 0===t?void 0:t.trim():void 0}catch{return}}async function g(e){return null!=e&&await e.exists()?e.nativePath:void 0}async function y(e,t){const i=o.map(m.ProjectPath.Tools(),(e=>p.BaseFile.for(e)));if(d.isElectron&&(null==i||await i.isNotDirectory()))throw new Error("Cannot find project path for tools"+c.FatalErrorFlag);function n(n){return null==i?void 0:i.join(d.platformName+"-"+n,o.orElse(t,e),e+(d.isWin?".exe":""))}return l.firstDefinedLater((()=>g(n(r.default.arch()))),(()=>"x64"===r.default.arch()?g(n("ia32")):void 0),(()=>async function(e){return l.firstDefinedLater((()=>f(e)),(()=>{var t;return g(null===(t=p.BaseFile.for(m.ProjectPath.Bin()))||void 0===t?void 0:t.join(e))}),(()=>{throw new Error("Cannot find path for "+e)}))}(e)))}t.pathTo=f,t.pathToTool=y,t.dcrawEmuNativePath=a.lazy((()=>y("dcraw_emu","libraw"))),t.rawIdentifyNativePath=a.lazy((()=>y("raw-identify","libraw"))),t.jpegtranNativePath=a.lazy((()=>y("jpegtran"))),t.sqliteNativePath=a.lazy((()=>y("sqlite3")))},43586:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LibraryUIDStore=t.UIDStore=t.mkuid=void 0;const n=i(43947),r=i(11448),s=i(66776),a=i(46852),o=i(79015),l=i(6231),u=i(71395),c=i(43414),d=i(42041),h=i(79141),p=i(61861);function m(){return l.TokenRadix.safeRandomUid(16,4)}t.mkuid=m;class f extends p.JsonFileStore{constructor(e,t){super(e.join("."+t+"-uid.json"),(()=>({uid:m(),version:d.version,type:this.type,createdAt:Date.now()})),(e=>e.hide())),this.rootDir=e,this.type=t,this.read_=r.lazy((()=>a.thenMapOr(this.read(),(e=>e.uid),(()=>"missing!")).catch((e=>{throw new h.WrappedError({cause:e,fatal:!0,message:"Failed to read "+this.rootDir})}))))}}t.UIDStore=f,t.LibraryUIDStore=r.lazy((()=>s.map(u.libraryDataDir(),(e=>new f(e,"library"))))),n.later((()=>{o.onClearCache((()=>{t.LibraryUIDStore.unset()})),c.Settings.libraryPath.addListener((()=>t.LibraryUIDStore.unset()))}))},16414:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WritableToBuffer=void 0;const n=i(92413),r=i(34996);class s extends n.Writable{constructor(e){super(e),this.deferred=new r.Deferred("WritableToBuffer"),this._buf=[],this.on("finish",(()=>{this.deferred.resolve(this.data)})),this.on("error",(e=>{this.deferred.reject(e)}))}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,t,i){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,t)),i()}}t.WritableToBuffer=s},95998:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.outputJsonGz_=t.readJsonGz_=t.zCopyToBuffer_=t.zCopyTo_=t.zcat=void 0;const n=i(35747),r=i(64298),s=i(31669),a=i(78761),o=i(11944),l=i(87748),u=i(11448),c=i(26588),d=i(82798),h=i(7162),p=i(79141),m=i(83837),f=i(16414),g=u.lazy((()=>h.mkLogger("zcat")));async function y(e,t,i){if(0===(await r.stat(e)).size)return;const s=[],l=[n.createReadStream(e,{autoClose:!0,...i}).on("error",(e=>s.push(e)))];if(e.toLowerCase().endsWith(".gz")?l.push(a.createGunzip().on("error",(e=>s.push(e)))):e.toLowerCase().endsWith(".br")&&l.push(a.createBrotliDecompress().on("error",(e=>s.push(e)))),l.push(t),await m.pipelineAsync(l),o.isNotEmpty(s))throw new p.WrappedError({message:"zReadFile("+e+") failed",cause:s[0]})}async function v(e,t){if(0===(await r.stat(e)).size)return Buffer.from([]);const i=new f.WritableToBuffer;return await y(e,i,t),await i.buffer}t.zcat=async function(e,t){try{return c.thenMap(v(e,t),d.toS)}catch(t){return void g().warn("zcat failed to read "+e,t)}},t.zCopyTo_=y,t.zCopyToBuffer_=v,t.readJsonGz_=async function(e){return JSON.parse((await v(e)).toString())};const w=s.promisify(a.gzip);t.outputJsonGz_=async function(e,t){const i=l.stringify(t),n=await w(i);return r.outputFile(e,n)}},49166:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assetFileSortCriteriaPojo=t.sortAssetFiles=t.file2sortableAssetFile=t.mtime2sort=t.sortScale=t.dim2sort=void 0;const n=i(11944),r=i(39938),s=i(88491),a=i(11448),o=i(66776),l=i(75556),u=i(61570),c=i(49049),d=i(3955),h=i(7162),p=i(43414),m=i(22766),f=i(19209),g=i(7218),y=a.lazy((()=>h.mkLogger("AssetFileSorter"))),v=[c.PS_NETWORK_FILESYSTEM_PROTOCOL,"file",c.PS_LOCAL_FILE_PROTOCOL,c.PS_LIBRARY_PROTOCOL];function w(e){return o.map(e,(e=>l.map2Numeric(e.width,e.height,((e,t)=>b(e*t)))))}function b(e){return Math.round(Math.pow(e,p.Settings.variantSortCriteriaPower.valueOrDefault))}function S(e){return Math.round(e/(2*s.minuteMs))}function M(e){const t=w(e),i=f.URI.parse(e.uri);if(r.blank(i.scheme)||r.blank(i.path)||null==e.mtime)return void y().debug("assetFileSortCriteriaPojo(): skipping",{af:e,parsedURI:i});const n=v.indexOf(i.scheme);if(-1===n)return void y().debug("assetFileSortCriteriaPojo(): skipping",{af:e,schemeIdx:n,parsedURI:i});const s=d.parsePosixPath(i.path),a=s.base.toLowerCase().includes("cover"),u=m.isSupportedByCurrentBrowserExt(s.ext),c=o.orElse(d.countFromName(s.name),0),h={resolution:t,mtime:S(e.mtime),schemeIdx:n,fileSize:l.mapNumeric(e.fileSize,b),isCover:a,count:c,isBrowserSupported:u},g={};for(const e of p.Settings.variantSortCriteria.values)o.map(h[e],(t=>g[e]=t));return g.uri=e.uri,g}t.dim2sort=w,t.sortScale=b,t.mtime2sort=S,t.file2sortableAssetFile=async function(e){return u.reqValuedOrElse({uri:await e.uri(),mtime:await e.thisOrSidecareMaxMtimeMs(),fileSize:await e.size(),sha:await e.sha(),...await g.dimensions(e)})},t.sortAssetFiles=function(e){for(const t of n.uniq(e.map((e=>e.sha)))){const i=e.filter((e=>e.sha===t)),r=Math.max(...n.compact(i.map((e=>e.mtime))));i.forEach((e=>e.mtime=r))}const t=n.compact(e.map((e=>o.map(M(e),(t=>o.map(function(e){const t=u.values(e);return t.some((e=>null==e))?void y().debug("pojoToCriteria(): skipping",{pojo:e}):t}(t),(i=>({f:e,crit:i,pojo:t})))))))),i=n.sortBy(t,(({crit:e})=>e));return n.mapNotEmpty(i,(e=>e.map((e=>e.f))))},t.assetFileSortCriteriaPojo=M},65564:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviewBuilder=void 0;const n=i(742),r=i(31669),s=i(11944),a=i(38625),o=i(88491),l=i(57743),u=i(16475),c=i(87748),d=i(66776),h=i(61570),p=i(26588),m=i(13779),f=i(7383),g=i(79141),y=i(98250),v=i(54953),w=i(7162),b=i(2023),S=i(43414),M=i(31329),P=i(49166),E=i(95011),T=i(49312),x=i(36810),D=i(23024),C=i(18538),k=i(14489),I=i(31216);class F{constructor(e,t){this.ap=e,this.assetFiles=t,this.badShas=new M.TTLSet(2*o.minuteMs),this.logger=w.mkLogger("AssetPreviewBuilder("+e.assetId+")")}[r.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build_(e){return f.time("img.AssetPreviewBuilder.build()",(async()=>{const t=s.compact(await P.sortAssetFiles(await this.assetFiles));for(this.logger.info("build_(): asset file candidates:",t.map((e=>e.uri)).reverse());s.isNotEmpty(t);){const i=t.pop(),n=await y.PosixFile.forUri(i.uri);if(null==n)continue;const r=await n.sha();if(null!=r&&!this.badShas.has(r))try{return await this._build(n,i,e)}catch(e){this.badShas.add(r),this.logger.warn("Failed to set shown file to "+i,u.errorToS(e))}}return this.logger.throw("none of the files are valid",{ignorable:!0,retriable:!1})}))}async _build(e,t,i){var r;this.logger.info("_build("+e+")",{uri:t.uri}),a.isTrue(i.validate)&&await I.validFile(e);const o=await e.size(),u=await e.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:o,mtime:u,best:t}),null==o||null==u)return this.logger.throw("build(): missing stat info for best file",{ignorable:!0,best:t});if(null==t.width||null==t.height||null==t.mimetype||null==t.sha)return this.logger.throw("IE build(): missing fields for best file "+e,{ignorable:!0,best:t});const f=E.fitSizes(t,t.rotation,t.mimetype),y={assetFileId:t.id,...h.pick(t,"assetId","uri","width","height","mimetype","sha","rotation"),path:e.nativePath,mtime:u,filesize:o,fitSizes:f.map((([,e])=>e.name)).join(",")};if(!0!==i.force&&!S.Settings.forceSync.valueOrDefault){const e=await this.ap.readInfo.refresh();if(null!=e){if(e.assetId!==y.assetId)throw new Error("IE build(): Mismatched asset IDs for "+t+": "+c.stringify({priorInfo:e,info:y}));const i=e.fitSizes.split(","),n=y.fitSizes.split(",");if(null!=e.sha&&e.sha===y.sha&&e.rotation===y.rotation&&E.equivalentFitSizes(i,n)){const t=s.diff(i,n);if(s.isNotEmpty(t)){this.logger.info("build(): removing previews that aren't required anymore.",{leftovers:t});for(const e of t){const t=f.find((([,t])=>t.name===e));if(null==t)this.logger.warn("build(): Failed to clean up: missing fit size",{fitsize:t,fits:f});else{const e=this.ap.fileForWidth(t[1].reducer.name,t[0].width);this.logger.debug("build(): unlinking unwanted preview "+e,{fitsize:t}),await e.unlink("warn")}}}return this.logger.debug("build(): SHA and rotation match, and previews exist.",{info:y,priorInfo:e}),await this.ap.writeInfo(y),y}}}const w=new v.PushProgressObserver({path:e.nativePath,op:"Building previews for"},x.ImageSize.sq().length+x.ImageSize.fit().length);if(this.logger.debug("Rebuilding all previews from "+t.uri,{assetId:t.assetId,best:t,info:y}),null==await this.ap.parent.mkdirp())throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+t);const M=await this.ap.existingFiles(),P=await k.sharpReadable(e,x.ImageSize.largestFit().max);if(null==P)throw new g.WrappedError({message:"AssetPreviewBuilder.build(): "+t.uri+", "+e.nativePath+", is not readable by sharp.",retriable:!1});const F=await C.maybeApplyColorspace(e,n(P.nativePath));t.mimetype.startsWith("image/")&&!T.isHeifMimetype(t.mimetype)&&null!=t.rotation&&0!==t.rotation&&(F.rotate(t.rotation),this.logger.debug("build(): rotating "+t.rotation+"Â°")),P.name.toLowerCase().includes("thumbnail")&&b.Try((()=>F.trim(1)));const O=[];let A,_;const L=x.ImageSize.largestSq(),R=null===(r=m.leastBy(f,(([e,t])=>d.map(L.outputSize(e),(()=>t.megapixels())))))||void 0===r?void 0:r[1].name,N=h.pick(t,"width","height");{let e=F.clone(),t=N;for(const[i,n]of f){const r=Date.now(),s=t,a=this.ap.fileForWidth(n.reducer.name,i.width).wip();e=n.resize(i,e),t=i,n.name===R&&(_=e.clone(),A=i),await n.toJpeg({path:a.nativePath,sh:e,outputSize:i}),w.onProgress(),this.logger.debug("resize("+n.name+") "+l.dimToS(s)+" -> "+l.dimToS(i)+" in "+(Date.now()-r)+" ms"),O.push(a)}}{null==_?(this.logger.debug("square resize(): resorting to ",{origDim:N,bestFitNameForSq:R}),_=F,A=N):this.logger.debug("square resize(): using to ",{sqDim:A,bestFitNameForSq:R});let e=!1;for(const t of x.ImageSize.sq()){const i=Date.now(),n=A,r=t.outputSize(d.orElse(A,N));if(null==r){this.logger.debug("skipping square output for "+t.max);continue}e||(r.position=S.Settings.squareThumbStrategy.valueOrDefault,e=!0),this.logger.debug("Applying ",{outputSize:r});const s=this.ap.fileForWidth(t.reducer.name,r.width).wip();t.resize(r,_),null!=r.position&&(this.logger.debug("Cloning square crop to make position consistent",{outputSize:r}),_=await D.sharpClone(_)),A=r,await t.toJpeg({path:s.nativePath,sh:_,outputSize:r}),w.onProgress(),O.push(s),this.logger.debug("resize("+t.name+") "+l.dimToS(n)+" -> "+l.dimToS(r)+" in "+(Date.now()-i)+" ms")}}try{await Promise.all(M.map((e=>e.unlink()))),await Promise.all(O.map((e=>e.unwip_()))),await this.ap.writeInfo(y),this.logger.debug("Previews unwipped and info written",{info:y})}catch(t){throw await p.thenCollect(O,(e=>e.unlink())),new g.WrappedError({cause:t,fatal:!1,message:"Failed to create previews from "+e})}return y}}t.AssetPreviewBuilder=F},8104:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviews=t.previewTimers=void 0;const n=i(88012),r=i(11944),s=i(13783),a=i(9381),o=i(11448),l=i(66776),u=i(13779),c=i(46852),d=i(7383),h=i(7162),p=i(91464),m=i(27649);t.previewTimers=new d.PromiseTimer,t.AssetPreviews=class{constructor(e,t,i){this.previewsRoot=e,this.alp=i,this.readInfo=o.lazy((()=>this.infoJson().readJson("debug"))),this.logger=h.mkLogger("AssetPreviews(assetId:"+n.id2id(t)+")"),this.assetId=n.id2id(t),this.urls=new s.AssetUrls(t);const r=p.leftPad(this.assetId,8,"0"),a=p.splitEvery(r,3);this.basename=a.pop()+"-",this.parent=e.join(...a)}existingFiles(){return c.thenOrElse(this.parent.childFiles((e=>e.base.startsWith(this.basename))),(()=>[]))}existingJpgs(){return c.thenOrElse(this.parent.childFiles((e=>e.base.startsWith(this.basename)&&".jpg"===e.ext)),(()=>[]))}async previews(){const e=await this.existingFiles();return c.sortByAsync(r.compact(e.map((e=>m.extractPreviewInfo(this.previewsRoot,e)))),(e=>null==e?void 0:e.file.size()))}async deleteAll(){this.parent.clear();const e=await this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return await Promise.all(e.map((e=>e.unlink()))),e}file(e){return this.parent.join(this.basename+e)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(e){return this.readInfo.unset(),this.infoJson().writeJsonMaybe(e,{spaces:2})}fileForWidth(e,t){return this.file(e+"-w"+t+".jpg")}filesForReducer(e){const t=this.basename+e+"-";return this.existingFiles().then((e=>e.filter((e=>e.base.startsWith(t)))))}async smallestFileForReducer(e){return u.leastBy(await this.filesForReducer(e),(e=>l.orElse(l.map(m.extractPreviewInfo(this.previewsRoot,e),(e=>e.width)),0)))}async largestFileForReducer(e){return u.greatestBy(await this.filesForReducer(e),(e=>l.orElse(l.map(m.extractPreviewInfo(this.previewsRoot,e),(e=>e.width)),0)))}async widths(e){const t=await this.filesForReducer(e);return r.sort(r.compact(t.map((e=>l.map(m.extractPreviewInfo(this.previewsRoot,e),(e=>e.width))))))}async posterLink(){const e=await this.widths(a.ReducerNames.fit);return this.urls.imgLink(a.ReducerNames.fit,Math.max(...e))}async imgAttrs(e,t=!1,i=!0){if(t||e!==a.ReducerNames.sq){const t=e===a.ReducerNames.fit?await this.readInfo():void 0;return this.urls.imgAttrs(e,await this.widths(e),i,t)}return this.urls.sqImgAttrs(i)}}},52879:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rgbhex2hsv=t.diffCIE94Corr=t.MaxCie=t.MinCie=t.closestLab=t.diffCIE94rgb=t.cie94_delta_e=t.cie76_delta_e=t.unlabhash=t.labhash=t.xyz2rgb=t.lab2xyz=t.xyz2lab=t.rgb2xyz=t.clampLab=t.clampRGB=t.lab2rgb=t.rgb2lab=t.rgb2labs=t.lab2rgbhex=t.rgbhex2Labhash=t.rgbhex2Lab=t.rgbhex2triplet=void 0;const n=i(66776),r=i(75556),s=i(82798),a=i(13779),o=i(70208),l=i(71538),u=i(91464),c=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],d=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];function h(e){return n.map(s.toS(e).match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),(e=>[e[1],e[2],e[3]].map((e=>parseInt(e,16)))))}function p(e){return M(y(e))}function m(e){return f(E(P(e)))}function f(e){return[e[0],e[1],e[2]].map((e=>r.clamp(0,255,e)))}function g(e){return[r.clamp(0,100,e[0]),r.clamp(-100,100,e[1]),r.clamp(-108,100,e[2])]}function y(e){const t=f(e).map((e=>e/255)).map((e=>e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92));return l.matXvec(c,t)}t.rgbhex2triplet=h,t.rgbhex2Lab=function(e){return n.map(h(e),p)},t.rgbhex2Labhash=function(e,t){return n.map(h(e),(e=>T(p(e),t)))},t.lab2rgbhex=function(e){return`#${m(e).map((e=>u.leftPad(e.toString(16),2,"0"))).join("")}`},t.rgb2labs=function(e){const t=[];for(let i=0;i<e.length;i+=3)t.push(...p([e[i],e[i+1],e[i+2]]));return t},t.rgb2lab=p,t.lab2rgb=m,t.clampRGB=f,t.clampLab=g,t.rgb2xyz=y;const v=.95047,w=1.08883,b=216/24389,S=24389/27;function M(e){const[t,i,n]=l.vecXvec(e,[1/v,1,1/w]).map((e=>e>b?Math.pow(e,1/3):(S*e+16)/116));return[116*i-16,500*(t-i),200*(i-n)]}function P(e){const[t,i,n]=g(e),r=(t+16)/116,s=i/500+r,a=r-n/200,o=s*s*s,l=a*a*a,u=o>b?o:(116*s-16)/S,c=t>8?Math.pow(r,3):t/S;return[u*v,1*c,(l>b?l:(116*a-16)/S)*w]}function E(e){return l.matXvec(d,e).map((e=>{const t=e<0?-1:1,i=e*t;return r.round(255*t*(i<=.0031308?12.92*i:1.055*Math.pow(i,1/2.4)-.055))}))}function T(e,t){return o.bitZip({dims:[{value:e[0],min:0,max:100},{value:e[1],min:-80,max:80},{value:e[2],min:-80,max:80}],bitDepth:t})}function x(e,t){return function(e,t){const i=e.L-t.L,n=e.a-t.a,r=e.b-t.b,s=Math.sqrt(e.a*e.a+e.b*e.b),a=s-Math.sqrt(t.a*t.a+t.b*t.b);let o=n*n+r*r-a*a;return o=o<0?0:Math.sqrt(o),Math.sqrt((i/1)**2+(a/(1+.045*s))**2+(o/(1+.015*s))**2)}({L:e[0],a:e[1],b:e[2]},{L:t[0],a:t[1],b:t[2]})}t.xyz2lab=M,t.lab2xyz=P,t.xyz2rgb=E,t.labhash=T,t.unlabhash=function(e,t){return o.bitUnzip(e,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:t})},t.cie76_delta_e=function(e,t){return Math.sqrt((t[0]-e[0])**2+(t[1]-e[1])**2+(t[2]-e[2])**2)},t.cie94_delta_e=x,t.diffCIE94rgb=function(e,t){return x(p(e),p(t))},t.closestLab=function(e,t){return a.leastBy(e,(e=>x(e,t)))},t.MinCie=2,t.MaxCie=50,t.diffCIE94Corr=function(e,i){return null==e||null==i?1:r.clamp(0,t.MaxCie,x(e,i)-t.MinCie)/t.MaxCie},t.rgbhex2hsv=function(e){let t,i,n,r=0,s=0;const[a,o,l]=h(e).map((e=>e/255)),u=Math.max(a,o,l),c=u-Math.min(a,o,l),d=e=>(u-e)/6/c+.5;return 0!==c&&(s=c/u,t=d(a),i=d(o),n=d(l),a===u?r=n-i:o===u?r=1/3+t-n:l===u&&(r=2/3+i-t),r<0?r+=1:r>1&&(r-=1)),[360*r,100*s,100*u]}},34928:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseDimensions=t.ltEither=t.lteBoth=t.ltBoth=t.tmegapixels=void 0;const n=i(11944),r=i(57743),s=i(75556),a=i(82798);t.tmegapixels=function(e){return null!=e.dimensions?r.dmegapixels(e.dimensions):s.gt0(e.Megapixels)?e.Megapixels:void 0},t.ltBoth=function(e,t){return s.lt(e.width,t.width)&&s.lt(e.height,t.height)},t.lteBoth=function(e,t){return s.lte(e.width,t.width)&&s.lte(e.height,t.height)},t.ltEither=function(e,t){return s.lt(e.width,t.width)||s.lt(e.height,t.height)},t.parseDimensions=function(e){const t=n.compact(a.toS(e).split(/[xÃ]/).map((e=>s.toInt(e))));return 2===t.length?{width:t[0],height:t[1]}:void 0}},7218:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dimensions=void 0;const n=i(46852),r=i(44546);t.dimensions=function(e){return n.thenMap(r.sizeInfo(e.nativePath),(e=>({width:e.ImageWidth,height:e.ImageHeight})))}},95011:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.equivalentFitSizes=t.fitSizes=void 0;const n=i(11944),r=i(57743),s=i(75556),a=i(36810);function o(e){return"qhd"===e?"wvga":"uhd"===e?"uhd4k":e}t.fitSizes=function(e,t,i){const n=a.ImageSize.fit().map((t=>[t.outputSize(e),t])).filter((([e])=>null!=e));let o=e;return n.filter((([e],n)=>function(e,n){const a=r.dmegapixels(o)/r.dmegapixels(e),l=0===n&&("image/jpeg"!==i||s.gt0(t))||a>3||r.dmegapixels(e)-r.dmegapixels(o)>2.5;return l&&(o=e),l}(e,n)))},t.equivalentFitSizes=function(e,t){return n.includesAll(n.compactBlanks(e).map(o),n.compactBlanks(t).map(o))}},71923:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isHeifSupported=t.getHeifSupportDetails=void 0;const n=i(39938),r=i(43947),s=i(11448),a=i(10408),o=i(79015),l=i(7162),u=i(99312),c=i(43414),d=i(50886),h=i(16114),p=s.lazy((()=>l.mkLogger("Heif")));t.getHeifSupportDetails=s.lazy((async()=>{try{if(u.isMac)try{const e=await h.sipsPath();if(!n.blank(e))return{ok:!0,msg:e}}catch(e){p().error("Failed to find the sips tool (either in PATH or /usr/bin).",e)}const e=await d.heifConvertPath();return{ok:n.notBlank(e),msg:n.notBlankOr(e,c.Settings.heifConvertPath.valueOrDefault+": not installed")}}catch(e){return{ok:!1,msg:a.errorToHumanString(e)}}})),t.isHeifSupported=async function(){return(await t.getHeifSupportDetails()).ok},r.later((()=>o.onClearCache((()=>t.getHeifSupportDetails.unset()))))},50886:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.heif2jpeg=t.isHeifConvertSupported=t.heifConvertPath=void 0;const n=i(39938),r=i(43947),s=i(11448),a=i(26588),o=i(69317),l=i(79015),u=i(22143),c=i(7162),d=i(43414),h=i(53719),p=i(78432),m=s.lazy((()=>c.mkLogger("HeifConvert")));async function f(){const e=await t.heifConvertPath();return m().tap({msg:"isHeifConvertSupported()",result:n.notBlank(e),meta:{heifConvertPath:e}})}r.later((()=>l.onClearCache((()=>t.heifConvertPath.unset())))),t.heifConvertPath=s.lazy((async()=>u.pathTo(d.Settings.heifConvertPath.valueOrDefault))),t.isHeifConvertSupported=f,t.heif2jpeg=async function(e){if(await f())return a.thenMap(p.cachedImgFile(e,"heif",".jpeg"),(t=>t.applyIfEmpty_((async t=>{try{await o.stdoutResult(d.Settings.heifConvertPath.valueOrDefault,["-q",String(d.Settings.jpegQuality.valueOrDefault),e.nativePath,t.nativePath],{timeout:h.CmdTimeoutMs})}catch(i){return void m().warn("heif2jpeg(): failed to convert "+e+" to "+t.nativePath+": "+i)}}))))}},49312:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isHeifMimetype=void 0;const n=i(82798),r=/^image\/hei[fc]$/i;t.isHeifMimetype=function(e){return null!=r.exec(n.toS(e))}},72461:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.imageHash=t.ModeDim=t.HashDim=t.maxPerBits=t.ModeCount=t.ModeBits=void 0;const n=i(742),r=i(11944),s=i(39938),a=i(88491),o=i(66776),l=i(75556),u=i(8199),c=i(17078),d=i(7383),h=i(70403),p=i(79015),m=i(51498),f=i(85296),g=i(7162),y=i(48446),v=i(6667),w=i(43414),b=i(52879),S=i(7218),M=i(78432),P=i(14489);t.ModeBits=12,t.ModeCount=7,t.maxPerBits=function(e){return Math.floor(52/e)};const E=g.mkLogger("ImageHash"),T=new m.FifoCache(250);function x(e){return v.avg(e)}p.onClearCache((()=>T.clear())),p.onFileChanged((e=>s.notBlank(e)?T.delete(e):T.clear())),p.onFileCopied(((e,t)=>o.map(T.get(e),(e=>T.getOrSet(t,(()=>e)))))),t.HashDim=8,t.ModeDim={width:96,height:96},t.imageHash=async function(e){return T.getOrSet(e.nativePath,(()=>h.elapsedAsync((()=>d.time(`img.imageHash${e.ext.toUpperCase()}`,(()=>async function(e){const i=g.mkLogger("ImageHash("+e+")");try{const a=!0,o=await P.sharpReadable(e,t.ModeDim,a);if(null==o)return void i.warn("Cannot build readable stream");if(null==await S.dimensions(e))return void i.warn("Can't extract dimensions");let h=n(o.nativePath).removeAlpha();o.isDescendantOf(await M.imgCacheDir())&&u.lt(await o.size(),2*c.MB)&&(h=h.trim(4)),h=h.resize({...t.ModeDim,fit:n.fit.fill,kernel:n.kernel.lanczos3,fastShrinkOnLoad:!0,withoutEnlargement:!0});const{data:p,info:m}=await h.raw().toBuffer({resolveWithObject:!0}),f=r.stepRange(0,p.length,3,(e=>b.rgb2lab([p[e],p[e+1],p[e+2]]))),g=function(e){const t=w.Settings.greyscaleColorThreshold.valueOrDefault;for(const i of e)if(Math.abs(i[1])>t||Math.abs(i[2])>t)return!1;return!0}(f);let E=v.modes(f.map((e=>b.labhash(e,t.ModeBits))),t.ModeCount);if(!g&&w.Settings.includeSharpDominantColor.valueOrDefault){const i=await d.time(`img.imageHash.stats ${e.ext.toUpperCase()}`,(()=>h.stats())),n=b.labhash(b.rgb2lab([i.dominant.r,i.dominant.g,i.dominant.b]),t.ModeBits);E=r.uniq([n,...E]).slice(0,t.ModeCount)}const T=n(p,{raw:{...m,channels:3}}).resize({width:t.HashDim,height:t.HashDim}),{data:D}=await T.raw().toBuffer({resolveWithObject:!0}),C=function(e){const t=[[],[],[]];for(let i=0;i<e.length;i+=3){const n=b.rgb2lab([e[i],e[i+1],e[i+2]]);t[0].push(n[0]),t[1].push(n[1]),t[2].push(n[2])}return t}(D),k=g?[x(C[0]),0,0]:l.times(3,(e=>x(C[e]))),I=(g?[C[0]]:C).map(((e,t)=>{const i=k[t];return e.map((e=>e>=i?1:0))}));if(g){const e=l.times(t.HashDim*t.HashDim,(()=>0));I.push(e,e)}return{meanHash:(s=r.flatten(I),y.b64encode(BigInt("0b0"+s.map((e=>1===e?1:0)).join("")))),isGreyscale:g,modes:E}}catch(t){return void i.warn("Failed to imageHash("+e.nativePath+")",t)}var s}(e))))).then((({elapsedMs:t,result:i})=>E.tap({level:f.ms2level(t,4*a.secondMs),msg:"imageHash()",result:i,meta:{file:e.nativePath,elapsedMs:t}})))))}},36810:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageSize=void 0;const n=i(31669),r=i(57743),s=i(11448),a=i(17078),o=i(13779),l=i(43414),u=i(80870);class c{constructor(e,t,i,n,r=!0){this.name=e,this.maxWidth=t,this.maxHeight=i,this.reducer=n,this.rotational=r,this.megapixels=s.lazy((()=>a.megapixels(this.maxWidth*this.maxHeight))),this.max={width:t,height:i},c._Sizes.push(this)}static sq(){return this._Sizes.filter((e=>e.reducer===u.Square))}static largestSq(){return o.greatestBy(this.sq(),(e=>e.megapixels()))}static fit(){const e=l.Settings.previewResolutions.valueOrDefault;return this._Sizes.filter((t=>t.reducer===u.Fit&&e.includes(t.name)))}static largestFit(){return o.greatestBy(this.fit(),(e=>e.megapixels()))}[n.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"Ã"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&r.isPortrait(e)?r.flip(this.max):this.max,e)}resize(e,t){return t.resize({...e,fit:this.reducer.fit,withoutEnlargement:!0})}toJpeg({path:e,sh:t,outputSize:i}){return(r.dmegapixels(i)<2||l.Settings.sharpen.valueOrDefault)&&(t=t.sharpen()),t.jpeg({quality:l.Settings.jpegQuality.valueOrDefault,progressive:l.Settings.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}}t.ImageSize=c,c._Sizes=[],c.UHD8k=new c("uhd8k",7680,4320,u.Fit,!1),c.UHD5k=new c("uhd5k",5120,2880,u.Fit,!1),c.UHD=new c("uhd4k",4096,2160,u.Fit),c.QHD=new c("qhd",3120,1440,u.Fit),c.FHD=new c("fhd",1920,1080,u.Fit),c.HD=new c("hd",1280,720,u.Fit),c.WVGA=new c("wvga",720,480,u.Fit),c.QVGA=new c("qvga",320,240,u.Fit),c.QQVGA=new c("qqvga",160,120,u.Fit),c.S480=new c("s480",480,480,u.Square),c.S240=new c("s240",240,240,u.Square),c.S120=new c("s120",120,120,u.Square),c.S60=new c("s60",60,60,u.Square)},78432:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prepFileForBrowser=t.withImgCache=t.readableToFile=t.cachedImgFile=t.emptyImgCacheDir=t.imgCacheDir=t.ImgCacheName=void 0;const n=i(87748),r=i(11448),s=i(66776),a=i(46852),o=i(28801),l=i(10408),u=i(49379),c=i(79141),d=i(18941),h=i(59873),p=i(7162),m=i(19658),f=i(91464),g=i(44546),y=i(23199),v=i(84685),w=i(68107),b=i(14489),S=i(742),M=r.lazy((()=>p.mkLogger("ImgCache")));async function P(){return o.cacheDir().join(t.ImgCacheName).mkdirp_().catch((e=>{l.onError("Failed to create imgCache directory"+u.FatalErrorFlag,e)}))}async function E(e,t,i){const r=await e.stat();if(null==r)throw new Error(`cachedImgFile(${e}): unreadable`);const s=await P();if(null==s)throw new Error("imgcache dir is missing");const a=await d.readFileType(e.nativePath);if(null==a)throw new Error("Cannot read filetype for "+e);const o=h.shortFsStringSha(n.stringify({basename:e.base.toLowerCase(),mimetype:a.mime,size:r.size}));i=f.ensurePrefix(i,".");const l=s.join(...f.splitEvery(o.slice(0,24),2,3),t+i);if(null==await l.parent().mkdirp())throw new Error("Cannot make dest dir, "+l.parent());return M().debug("cachedImgFile("+e.baseWithGrandparent+")",{desc:t,ext:i,result:l}),l}async function T(e,t,i,n){try{return await a.thenMap(E(e,t,i),(e=>e.applyIfEmpty_(n)))}catch(t){throw M().warn("readableToFile("+e+"): "+t),t}}t.ImgCacheName="imgcache",t.imgCacheDir=P,t.emptyImgCacheDir=async function(){if(m.isProd)throw new Error("emptyImgCacheDir is for tests");await a.thenMap(P(),(e=>a.thenMap(e.children(),(e=>Promise.all(e.map((e=>e.rmrf())))))))},t.cachedImgFile=E,t.readableToFile=async function({src:e,desc:t,suffix:i,f:n}){try{return await a.thenMap(E(e,t,i),(e=>e.applyIfEmpty_((async e=>a.thenMap(n(),(t=>e.writeStream_(t)))))))}catch(e){throw new c.WrappedError({cause:e,message:"readableToFile() failed"})}},t.withImgCache=T,t.prepFileForBrowser=async function(e,t){if(await e.notExists())return;const i=await g.readRawTags(e,!0),n=null==i?void 0:i.MIMEType,r=s.orElse(v.extractRotation(i),0),o=s.map(i,(e=>w.extractSizeInfo(e,r))),l=s.orElse(null==o?void 0:o.dimensions,t);if(null==l)return void M().warn("prepFileForBrowser(): no file dimensions",{file:e,si:o,info:t});const u={width:l.width-32,height:l.height-32};return y.isMimetypeSupported(n,t.userAgent)&&0===r?e:(M().info("prepFileForBrowser(): non-browser-supported mimetype",{file:e,mt:n,info:t}),T(e,"web-"+r,".jpg",(async t=>a.thenMap(b.sharpReadable(e,u),(async e=>S(e.nativePath).rotate(r).toFile(t.nativePath))))))}},27649:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkDownloadableTitle=t.previewToDownloadable=t.extractPreviewInfo=void 0;const n=i(13783),r=i(57743),s=i(9381),a=i(66776),o=i(75556),l=i(46852),u=i(3955),c=i(7162),d=i(70283),h=i(91464),p=i(7218),m=c.mkLogger("extractPreviewInfo");function f(e,t,i,n){return`Download ${t} ${e.ext} ${i} (${r.dimToS(n)})`}t.extractPreviewInfo=function(e,t){const i=t.posixPathFrom(e).replace(/\//g,"").split("-"),n=o.toInt(i[0]),r=i[1],a=s.ReducerNames.validOrElse(r,void 0),l=d.extractInt(i[2]);return o.gt0(n)?{file:t,assetId:n,reducer:a,width:l}:void m.warn("Failed to extract preview info",{file:t,previewsRoot:e,arr:i,assetId:n,reducer:a,width:l})},t.previewToDownloadable=async function(e,t){return a.map2(t.assetId,t.width,((i,a)=>l.thenMap(p.dimensions(t.file),(o=>{const l=r.dimToSize(o);return{size:l,basename:`${h.stripSuffix(e,u.extname(e))}-${l}${t.file.ext}`,title:f(t.file,l,"image",o),description:`Download ${l}`,details:`(${r.dimToS(o)} ${t.file.ext})`,href:new n.AssetUrls(i).imgLink(s.ReducerNames.fit,a)}}))))},t.mkDownloadableTitle=f},19371:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Previews=void 0;const n=i(88012),r=i(75556),s=i(82798),a=i(51498),o=i(65564),l=i(8104);t.Previews=class{constructor(e,t){this.root=e,this.alp=t,this.id2ap=new a.FifoCache(512)}async build_(e){return this.apb(e.assetId,e.assetFiles).build_(e)}apb(e,t){return new o.AssetPreviewBuilder(this.ap(e),t)}ap(e){const t=s.toS(n.id2id(e)),i=this.id2ap.get(t);if(null!=i&&n.idEql(e,i.assetId))return i;{const i=new l.AssetPreviews(this.root,e,this.alp);return r.isNumber(e)||this.id2ap.set(t,i),i}}clearAssetId(e){this.id2ap.delete(s.toS(e))}}},53026:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseRawInfoOutput=t.rawInfo=void 0;const n=i(39938),r=i(16475),s=i(11448),a=i(75556),o=i(69317),l=i(79015),u=i(51498),c=i(84571),d=i(22143),h=i(7162),p=new u.FifoCache(512);l.onClearCache((()=>p.clear())),l.onFileChanged((e=>null==e?p.clear():p.delete(e)));const m=s.lazy((()=>h.mkLogger("RawInfo")));function f(e){const[t,i,n,r,s]=e.split("\t");return m().tap({msg:"parseRawInfoOutput()",result:a.map2Numeric(a.toInt(r),a.toInt(s),((e,r)=>({Filename:t,Make:i,Model:n,ImageSize:{width:e,height:r}}))),meta:{input:e}})}t.rawInfo=async function(e){return p.getOrSet(e.nativePath,(async()=>{try{const t=await d.rawIdentifyNativePath(),i=await o.stdout(t,["-s",e.nativePath],{timeout:c.StatTimeoutMs});return n.mapNotBlank(i,f)}catch(t){return void m().warn("raw-identify failed",{file:e.nativePath,error:r.errorToS(t)})}}))},t.parseRawInfoOutput=f},80870:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Reducers=t.Fit=t.fitInsideToAspectRatio=t.Square=t.SharpFits=void 0;const n=i(57743),r=i(85643),s=i(9381),a=i(11448),o=i(84253),l=i(7162),u=i(34928);var c,d;t.SharpFits=o.strEnum("cover","contain","fill","inside","outside"),function(e){const i=a.lazy((()=>l.mkLogger("Reducers.Square")));e.name=s.ReducerNames.sq,e.fit="cover",e.reduce=function(e,n){const r=u.lteBoth(e,n)?{...e,fit:t.SharpFits.cover}:void 0;return i().tap({msg:"reduce()",result:r,meta:{max:e,input:n}})}}(c=t.Square||(t.Square={})),t.fitInsideToAspectRatio=function(e,t){return e.width/e.height>=t?{width:Math.floor(e.height*t),height:e.height}:{width:e.width,height:Math.floor(e.width/t)}},function(e){const t=a.lazy((()=>l.mkLogger("Reducers.Fit")));e.name=s.ReducerNames.fit,e.fit="inside",e.reduce=function(e,i){if(!u.ltBoth(i,e))return r.fitInside(i,e);t().trace(`reduce(): input ${n.dimToS(i)} is too small for ${n.dimToS(e)}`)}}(d=t.Fit||(t.Fit={})),t.Reducers=[c,d]},23024:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sharpFromRawBuffer=t.sharpClone=void 0;const r=n(i(742)),s=i(11448),a=i(7162),o=s.lazy((()=>a.mkLogger("Sharp")));function l(e,t){return r.default(e,{raw:t})}t.sharpClone=async function(e){try{const{data:t,info:i}=await e.raw().toBuffer({resolveWithObject:!0});return l(t,i)}catch(t){return o().info("Failed to buffer-clone sharp",t),e.clone()}},t.sharpFromRawBuffer=l},18538:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.maybeApplyColorspace=void 0;const n=i(39938),r=i(11448),s=i(61570),a=i(98250),o=i(27175),l=i(7162),u=i(43414),c=i(44546),d=r.lazy((async()=>{const e=a.PosixFile.for(o.ProjectPath.ICC()),t={};for(const i of u.Settings.iccProfileMappings.valueOrDefault){const[n,r]=i.split(":"),s=e.join(r);await s.isNonEmptyFile()?t[n]=s.nativePath:l.mkLogger("SharpColorspace").warn(" iccProfileMappings has an invalid ICC profile filename: "+r)}return Object.freeze(t)}));t.maybeApplyColorspace=async function(e,t){const i=await c.readRawTags(e,!1),r=null==i?void 0:i.ProfileDescription;if(!n.blank(r)){const e=await d();for(const i of s.keys(e))if(r.includes(i))return t.withMetadata({icc:e[i]})}return t.toColorspace("srgb")}},14489:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractImageForThumbs=t.sharpReadable=t.imgFromExif=void 0;const n=i(742),r=i(92585),s=i(39938),a=i(57743),o=i(11448),l=i(66776),u=i(46852),c=i(7383),d=i(7162),h=i(99312),p=i(43414),m=i(35290),f=i(44546),g=i(23199),y=i(84685),v=i(68107),w=i(59387),b=i(34928),S=i(7218),M=i(71923),P=i(50886),E=i(49312),T=i(78432),x=i(50885),D=i(53026),C=i(16114),k=i(46517),I=i(15271),F=d.mkLogger("SharpReadable");async function O(e,t,i,n){const r=null==t?void 0:t[i];if(!(r instanceof m.BinaryField))return;const s=n.width*n.height*.1;if(null==r.binaryDataBytes||r.binaryDataBytes<s)return void F.debug("imgFromExif(): rejecting (too small) "+i,{minBytes:s,val:r});const a=await _(e,i),o=await l.map(a,S.dimensions);return F.tap({msg:"imgFromExif()",meta:{src:e.baseWithGrandparent,tag:i,dim:o,minDim:n},result:null!=o&&b.ltBoth(n,o)?a:void 0})}t.imgFromExif=O;const A=o.lazy((()=>{n.simd(p.Settings.enableSIMD.valueOrDefault),n.cache(p.Settings.enableVipsCache.valueOrDefault),n.concurrency(w.sharpThreadsPerJob())}));function _(e,t){const i=t.toLowerCase().endsWith("tiff")?".tiff":".jpg";return u.thenMap(T.cachedImgFile(e,t,i),(i=>i.applyIfEmpty_((async i=>{try{return await f.extractBinaryTag(t,e.nativePath,i.nativePath)}catch(i){return void F.warn("Failed to extract embedded "+t+" from "+e.nativePath+": "+i)}}))))}t.sharpReadable=function(e,t,i=!1){return c.time(`img.sharpReadable${e.ext.toUpperCase()}`,(()=>async function(e,t,i=!1){A();const n=!i,o=await f.readRawTags(e,n),c=null==o?void 0:o.MIMEType;if(null==o||s.blank(c))throw new Error(e+" is not supported (missing mimetype)");if(E.isHeifMimetype(c)&&!await M.isHeifSupported())return void F.warn("sharpReadable(): HEIF file, but heif support is missing",{src:e.nativePath,mimetype:c,minDim:t});if(I.isVideoMimeType(c)&&!await k.isVideoSupported())return void F.warn("sharpReadable(): video file, but video support is missing",{src:e.nativePath,mimetype:c,minDim:t});const d=[],m=y.extractRotation(o),w=v.extractSizeInfo(o,m,g.isLibrawMimetype(c)?await D.rawInfo(e):void 0);if(null!=w){const n=l.orElse(t,{width:.95*w.dimensions.width,height:.95*w.dimensions.height});if(a.dmegapixels(n)>15&&(i||null==m||0===m)&&!I.isVideoMimeType(c)){const i=p.Settings.embeddedPreviews.valueOrDefault;null!=t&&a.dmegapixels(t)<1&&i.unshift(...p.Settings.embeddedThumbnails.values),d.push(...i.map((t=>()=>O(e,o,t,n))))}}E.isHeifMimetype(c)&&(h.isMac&&d.push((()=>C.sips2jpeg(e))),d.push((()=>P.heif2jpeg(e)))),g.isSharpMimetype(c)&&d.push((async()=>e)),null!=w&&g.isLibrawMimetype(c)&&d.push((()=>(F.info("sharpReadable() -> dcraw()",{src:e.nativePath,minDim:t}),T.readableToFile({src:e,desc:"dcraw",suffix:".tiff",f:()=>x.dcraw_emu(e)})))),c.startsWith("video/")&&d.push((()=>r.retryOnReject((()=>k.extractVideoFrame(e,c)),{maxRetries:1})));const b=[],S=await u.firstResolvedDefinedPromise(d,(t=>{F.warn("strategy failed for "+e+": "+t),b.push(t)}));if(null==S)throw l.orElse(b[0],new Error("Cannot read "+e+" ("+c+")"));return S}(e,t,i)))},t.extractImageForThumbs=_},59430:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.syncFileTimeout=t.dcrawTimeout=t.syncFileTimeoutForFile=t.syncFileTimeoutForFileMs=t.transcodeTimeout=t.transcodeTimeoutForFile=t.DurationMultiplier=t.MaxSyncFileTimeoutMs=t.MinSyncFileTimeoutMs=void 0;const n=i(43649),r=i(88491),s=i(66776),a=i(75556),o=i(17078),l=i(46852),u=i(70283),c=i(43414),d=i(44546),h=i(22766),p=i(53719);t.MinSyncFileTimeoutMs=r.minuteMs,t.MaxSyncFileTimeoutMs=15*r.minuteMs,t.DurationMultiplier=10;const m={p0:{x:.8*o.MB,y:4*r.secondMs},p1:{x:20*o.MB,y:12*r.secondMs}},f={p0:{x:11*o.MB,y:12*r.secondMs},p1:{x:26*o.MB,y:24*r.secondMs}},g={p0:{x:7*o.MB,y:45*r.secondMs},p1:{x:32*o.MB,y:90*r.secondMs}};function y(e){return h.isVideoExt(e.ext)?Math.max(s.orElse(u.mapGt0(e.durationMs,(e=>e*t.DurationMultiplier)),0),n.lerp2d(g.p0,g.p1,e.bytes)):0}function v(e){return l.thenMap(w(e),b)}function w(e){return l.thenMap(e.size(),(async t=>({bytes:t,ext:e.ext,durationMs:h.isVideoExt(e.ext)?await l.thenMap(d.readRawTags(e),(e=>u.mapGt0(e.Duration,(e=>e*r.secondMs)))):void 0})))}function b(e){const i=a.clamp(.5*o.MB,64*o.GB,e.bytes),s=5*r.secondMs,l=p.CmdTimeoutMs,u=2*i*p.MinIoRate,d=e=>n.lerp2d(e.p0,e.p1,a.clamp(.5*o.MB,50*o.MB,i)),g=d(m),v=h.extTypes(e.ext),w=!0===(null==v?void 0:v.includes(h.ExtTypes.RawImage))?d(f):0,b=y(e),S=c.Settings.validateVideos.valueOrDefault?b:0;return{result:a.clamp(t.MinSyncFileTimeoutMs,t.MaxSyncFileTimeoutMs,Math.round(s+l+u+g+w+b+S)),dbMs:s,tagMs:l,copyMs:u,thumbMs:g,rawDecodeMs:w,transcodeMs:b,validateMs:S}}t.transcodeTimeoutForFile=function(e){return h.isVideoExt(e.ext)?l.thenMap(w(e),y):void 0},t.transcodeTimeout=y,t.syncFileTimeoutForFileMs=function(e){return l.thenMap(v(e),(e=>e.result))},t.syncFileTimeoutForFile=v,t.dcrawTimeout=function(e){return n.lerp2d(f.p0,f.p1,a.clamp(11*o.MB,100*o.MB,s.orElse(e,0)))},t.syncFileTimeout=b},31216:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validFile=t.isValidFile=t.isIgnorableValidationError=void 0;const n=i(88491),r=i(43947),s=i(16475),a=i(11448),o=i(98510),l=i(46852),u=i(79141),c=i(79015),d=i(51498),h=i(98250),p=i(64021),m=i(69060),f=i(7162),g=i(1058),y=i(43414),v=i(44546),w=i(15299),b=i(14489),S=i(46517),M=i(15271),P=i(742),E=a.lazy((()=>f.mkLogger("ValidFile"))),T=a.lazy((()=>new d.FifoCache(1024,n.minuteMs)));r.later((()=>c.onClearCache((()=>{var e;return null===(e=T.prior())||void 0===e?void 0:e.clear()})))),r.later((()=>c.onFileChanged((e=>o.opt(e).forEach((e=>{var t;null===(t=T.prior())||void 0===t||t.delete(e)})).orElse((()=>{var e;null===(e=T.prior())||void 0===e||e.clear()}))))));const x=a.lazy((()=>g.joinPatterns(y.Settings.validationErrorBlocklist.values,"i")));async function D(e){if(!await m.l()&&(y.Settings.validateJpegImages.valueOrDefault||y.Settings.validateVideos.valueOrDefault))return p.getOrSetByNativePath(e,C,T());E().debug("no validation for "+e,{validateJpegImages:y.Settings.validateJpegImages.valueOrDefault,validateVideos:y.Settings.validateVideos.valueOrDefault})}async function C(e){const t=h.PosixFile.for(e);try{const e=await v.mimetype(t);if(null==e)throw new Error("Cannot validate, no mimetype");if(M.isVideoMimeType(e))y.Settings.validateVideos.valueOrDefault&&(E().debug("validating "+t),await S.validVideo(t,e));else{if(!e.startsWith("image/"))throw new Error("Unsupported mimetype, "+e);if("image/jpeg"===e){if(y.Settings.validateJpegImages.valueOrDefault)return await w.validJpeg(t)}else if(y.Settings.validateRawImages.valueOrDefault){const e=await b.sharpReadable(t);if(null==e)throw new Error("Cannot read");await P(e.nativePath,{failOnError:!0}).tiff().toBuffer()}}}catch(e){throw new u.WrappedError({cause:e,message:"invalid file "+t,retriable:!1,doNotSend:!0,ignorable:!0})}}t.isIgnorableValidationError=function(e){return E().tap({msg:"isIgnorableValidationError",result:null==x().exec(s.errorToS(e))})},t.isValidFile=async function(e){return l.resolved(D(e))},t.validFile=D},46517:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validVideo=t.guessExpectedSize=t.transcode=t.needsTranscoding=t.isVideoTranscodingSupported=t.extractVideoFrame=t.bitrateKps=t.isVideoSupported=t.getVideoToolDetails=t.maxConcurrentVideoImports=void 0;const n=i(12087),r=i(11944),s=i(38625),a=i(88491),o=i(43947),l=i(11448),u=i(66776),c=i(75556),d=i(8199),h=i(17078),p=i(64975),m=i(46852),f=i(7383),g=i(79015),y=i(54953),v=i(7162),w=i(43649),b=i(19658),S=i(70283),M=i(43414),P=i(91464),E=i(68567),T=i(27947),x=i(44546),D=i(84685),C=i(68107),k=i(59387),I=i(12737),F=i(7218),O=i(78432),A=i(15299),_=i(59430),L=i(15271),R=i(2724);async function N(e){return await p.firstDefinedLater((()=>s.isTrue(null==e?void 0:e.ignoreffmpeg)&&!b.isProd?void 0:m.thenMap(I.checkFFmpegVersion(),(e=>({ok:!0,msg:"FFmpeg "+e})))),(()=>s.isTrue(null==e?void 0:e.ignorevlc)?void 0:m.thenMap(R.checkVlcInfo(),(e=>({ok:!0,msg:"VLC "+e.version})))),(()=>({ok:!1,msg:"(no video tools were found)"})))}function B(e,i){const n=v.mkLogger("img/Video.dim("+e+")"),r=M.Settings.minVideoDimension.valueOrDefault,s=i.ImageWidth;if(null!=s&&!c.gte(s,r))return n.throw("invalid width: "+s,{ignorable:!0});const a=i.ImageHeight;if(null!=a&&!c.gte(a,r))return n.throw("invalid height: "+a,{ignorable:!0});const o=u.orElse(E.extractBitrateKbps(i),M.Settings.transcodeBitrateUHD.valueOrDefault),l=S.mapGt0(s,(e=>S.mapGt0(a,(i=>c.clamp(0,o,t.bitrateKps(e*i)))))),d={width:s,height:a,videoBitrateKbps:l};return n.debug("dim()",{src:e,result:d}),d}async function j(e,t,i){var n;if(!L.isVideoMimeType(t))return;const r=!s.isTrue(null==i?void 0:i.useVlc)&&s.isTrue(await m.thenOrElse(null==i?void 0:i.useFfmpeg,(()=>I.isFFmpegSupported()))),a=!r&&s.isTrue(await m.thenOrElse(null==i?void 0:i.useVlc,(()=>R.isVlcSupported())));if(!r&&!a)return;const o=v.mkLogger("img/Video.extractVideoFrame("+e+")"),l=await O.cachedImgFile(e,"frame",".jpg");o.debug("extractVideoFrame",{dest:l.nativePath,mimetype:t});const u=await e.mtimeMs();if(null==u)return o.throw("null mtime");const c=await x.readRawTags(e);if(null==c)return o.throw("no tags");const d=D.extractRotation(c);o.debug("video orientation:"+d);const h=null===(n=C.extractSizeInfo(c,d))||void 0===n?void 0:n.dimensions,p=await l.stat(),f=null==p?void 0:await F.dimensions(l);if(null!=p&&p.mtimeMs>u&&null!=f&&(null==h||f.height===h.height&&f.width===h.width))return o.debug("prior dest, "+l+" seems reasonable",{srcDim:h,destDim:f}),l;const g=T.extractDurationSec(c),y=Math.min(null!=g?g:0,M.Settings.videoFrameAtSec.valueOrDefault);return o.info("extracted metadata",{startAtSec:y,duration:g}),await l.applyWip((async t=>{const i={src:e,dest:t,startAtSec:y,...h};await(r?I.ffmpegFrame(i):R.vlcFrame(i)),await x.deleteAllTags(t),a&&null!=d&&0!==d&&(o.info("rotating in place..."+t,{rot:d}),await A.rotateInPlace(t,d))})),l}async function z(){return M.Settings.transcodeVideos.valueOrDefault&&(await I.isFFmpegSupported()||await R.isVlcSupported())}async function V(e){const t=v.mkLogger("needsTranscoding("+e+")");if(!await z())return t.tap({msg:"videoTranscodingSupported is false",result:!1});const i=await x.readRawTags(e);if(null==i)return t.tap({msg:"Cannot transcode files that exiftool can't read",result:!1});const n=i.MIMEType;if(!L.isVideoMimeType(n))return t.tap({msg:"not transcoding (unsupported mimetype)",result:!1,meta:{mimetype:n}});const s=T.extractDurationSec(i);if(!d.gt(s,M.Settings.minVideoDurationSec.valueOrDefault))return t.tap({msg:"not transcoding (video duration is too short)",result:!1,meta:{duration:s}});const a=r.compactBlanks([i.AudioFormat]),o=a.some((e=>P.hasAnyIgnoreCase(M.Settings.doNotTranscodeAudioCodecs.values,e))),l=r.compactBlanks([i.VideoCodec,i.CompressorID,i.CompressorName]),u=l.some((e=>P.hasAnyIgnoreCase(M.Settings.doNotTranscodeVideoCodecs.values,e))),c=P.hasAnyIgnoreCase(M.Settings.doNotTranscodeMimetypes.values,n);return t.tap({msg:"result",result:!(o&&u&&c),meta:{mimetype:n,isSafeMimetype:c,audioCodecs:a,isSafeAudioCodec:o,videoCodecs:l,isSafeVideoCodec:u}})}function W(e,t,i){return Math.min(e,u.orElse(i,60)*u.orElse(t,1e3))}t.maxConcurrentVideoImports=l.lazy((async()=>n.totalmem()>16*h.GiB&&k.maxCpus()>5&&await I.isFFmpegSupported()?2:1)),t.getVideoToolDetails=N,t.isVideoSupported=l.lazy((async()=>(await N()).ok)),o.later((()=>g.onClearCache((()=>t.isVideoSupported.unset())))),t.bitrateKps=e=>c.sigFigs(w.lerp2d({x:76800,y:M.Settings.transcodeBitrateQVGA.valueOrDefault},{x:8294400,y:M.Settings.transcodeBitrateUHD.valueOrDefault},e),2),t.extractVideoFrame=j,t.isVideoTranscodingSupported=z,t.needsTranscoding=V,t.transcode=async function(e,t){if(!1===await V(e))return;const i=await e.size();if(!c.gt0(i))throw new Error("transcode(): cannot read "+e);const n=await x.readRawTags(e);if(null==n)throw new Error("Cannot transcode files that exiftool can't read");return f.time("video.transcode()",(async()=>{const r=u.orElse(T.extractDurationSec(n),60),s=_.transcodeTimeout({bytes:i,durationMs:r*a.secondMs,ext:e.ext}),o={src:e,timeoutMs:s,...B(e,n)},l=W(i,o.videoBitrateKbps,r),c=l/3;return t.applyIfEmpty_((i=>(async i=>{const n=Date.now(),r=new y.PullProgressObserver({path:e.nativePath,op:"Transcoding video"},l,(async()=>{const e=u.orElse(await t.clear().size(),0),i=(Date.now()-n)/s*l;return Math.max(e,i)}));o.dest=i;const a=await r.observe(await I.isFFmpegSupported()?I.ffmpegTranscode(o):R.vlcTranscode(o));if(0!==a.code)throw new Error("transcode failed with code "+a.code)})(i)),c)}))},t.guessExpectedSize=W,t.validVideo=async function(e,t){const i=v.mkLogger("img/Video.validVideo("+e+")");return null==await j(e,t)&&i.throw("Could not extract a video frame"),await I.isFFmpegSupported()?I.ffmpegValidVideo(e):void 0}},15271:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isVideoMimeType=void 0;const n=i(39938);t.isVideoMimeType=function(e){return n.notBlank(e)&&(e.startsWith("video/")||"application/mp4"===e||"application/ogg"===e)}},12737:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ffmpegValidVideo=t.ffmpegTranscode=t.ffmpegFrame=t.isFFmpegSupported=t.checkFFmpegVersion=t.ffmpegVersionDescription=t.ffmpegVersion=void 0;const n=i(11944),r=i(39938),s=i(88491),a=i(43947),o=i(11448),l=i(66776),u=i(75556),c=i(98510),d=i(82798),h=i(46852),p=i(69317),m=i(79015),f=i(7162),g=i(70283),y=i(43414),v=i(53719),w=i(59387),b=i(59430),S=i(31216),M=o.lazy((()=>f.mkLogger("ffmpeg"))),P=o.lazy((()=>u.clamp(1,8,u.round(w.maxCpus()/2)))),E=/ffmpeg version (\S+)/i;t.ffmpegVersion=o.lazy((async()=>{var e;try{const t=await p.stdoutResult(y.Settings.ffmpegPath.valueOrDefault,["-version"],{timeout:v.CmdTimeoutMs,ignoreStderr:!0,isIgnorableError:()=>!0}),i=null===(e=E.exec(t.result))||void 0===e?void 0:e[1];return M().info("ffmpegVersion",{version:i,code:t.code,stdout:t.result.split("\n",1)[0]}),0===t.code&&r.notBlank(i)?i:void 0}catch(e){return}})),t.ffmpegVersionDescription=o.lazy((()=>h.thenMapOr(t.ffmpegVersion(),(e=>"version "+e),(()=>"(not found)")))),a.later((()=>m.onClearCache((()=>t.ffmpegVersion.unset())))),t.checkFFmpegVersion=async function(){return h.thenOrElse(t.ffmpegVersion.prior(),(()=>t.ffmpegVersion.refresh()))},t.isFFmpegSupported=async function(){return null!=await t.ffmpegVersion()},t.ffmpegFrame=async function(e){var t;return await e.dest.exists()&&await e.dest.isEmpty()&&await e.dest.unlink(),p.stdoutResult(y.Settings.ffmpegPath.valueOrDefault,n.compact(["-loglevel","error","-i",e.src.nativePath,...null!==(t=g.mapGte0f(e.startAtSec,(e=>["-ss",e.toFixed(1)])))&&void 0!==t?t:[],"-vframes","1","-f","singlejpeg","-y",e.dest.nativePath]),{timeout:s.minuteMs,isIgnorableError:S.isIgnorableValidationError})},t.ffmpegTranscode=async function(e){const t=c.opt(e.videoBitrateKbps).filter(u.gt0).map((e=>u.sigFigs(e,2))).map((e=>["-b:v",e+"k","-maxrate",e+"k","-bufsize",u.sigFigs(e/2,2)+"k"])).getOrElse((()=>[]));return p.stdoutResult(y.Settings.ffmpegPath.valueOrDefault,["-loglevel","error","-threads",d.toS(P()),"-i",e.src.nativePath,...y.Settings.ffmpegTranscodeArgs.values,...t,e.dest.nativePath],{timeout:e.timeoutMs,isIgnorableError:S.isIgnorableValidationError})},t.ffmpegValidVideo=async function(e){return M().tap({msg:"ffmpegValidVideo",meta:{src:e.nativePath},result:await p.stdoutResult(y.Settings.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",d.toS(P()),"-i",e.nativePath,"-f","null","-"],{timeout:l.orElse(await b.syncFileTimeoutForFileMs(e),2*s.minuteMs),isIgnorableError:S.isIgnorableValidationError,ignoreExitCode:!0,quiet:!1})})}},15299:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rotateToImgTmp=t.rotate=t.rotateInPlace=t.validJpeg=void 0;const n=i(88491),r=i(11448),s=i(33714),a=i(46852),o=i(69317),l=i(79141),u=i(79015),c=i(22143),d=i(7162),h=i(99312),p=i(78432),m=i(31216),f=h.isWin?"NUL":"/dev/null",g=r.lazy((()=>d.mkLogger("jpegtran")));async function y(e,t,i){const r=await c.jpegtranNativePath();if(!s.isRotation(i))throw new Error("refusing to rotate("+e+", "+i+")");await o.stdout(r,["-copy","all","-trim","-rotate",i.toFixed(0),"-outfile",t.nativePath,e.nativePath],{timeout:n.minuteMs})}t.validJpeg=async function(e){const t=await c.jpegtranNativePath();try{await o.stdoutResult(t,["-outfile",f,e.nativePath],{timeout:30*n.secondMs,isIgnorableError:m.isIgnorableValidationError})}catch(e){throw new l.WrappedError({cause:e,doNotSend:!0,fatal:!1,retriable:!1})}},t.rotateInPlace=async function(e,t){const i=e.wip();g().info("rotateInPlace("+e+")",t),await y(e,i,t),await i.unwip_(),u.emitFileChanged(e.nativePath)},t.rotate=y,t.rotateToImgTmp=async function(e,t){return null==t||0===t?e:a.thenMap(p.cachedImgFile(e,"r"+t,e.ext),(i=>i.applyIfEmpty_((i=>y(e,i,t)))))}},50885:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dcraw_emu=t.librawSupported=void 0;const n=i(88491),r=i(57743),s=i(17078),a=i(46852),o=i(69317),l=i(10408),u=i(49379),c=i(67817),d=i(18941),h=i(54953),p=i(22143),m=i(7162),f=i(43414),g=i(23199),y=i(7218),v=i(36810),w=i(59430),b=m.mkLogger("libraw");t.librawSupported=async function(e){try{return g.isLibrawMimetype(await a.thenMap(d.readFileType(e.nativePath),(e=>e.mime)))}catch(e){return b.warn("librawSupported(): failed to read filetype",e),!1}};const S=["-T"],M=["-Z","-"],P=["-o","1"],E=["-t","0","-j"];t.dcraw_emu=async function(e){const t=Date.now(),i=await y.dimensions(e);if(null==i)return b.throw("Cannot decode RAW "+e+": no EXIF dimensions."+u.DoNotSendErrorFlag+u.NonRetriableErrorFlag);const a=v.ImageSize.largestFit().outputSize(i),d=[];null!=a&&4*r.dmegapixels(a)<r.dmegapixels(i)&&(b.debug("Large original source: using -h"),d.push("-h"));const m=await p.dcrawEmuNativePath(),g=[...S,...M,...P,...d,...E,...f.Settings.dcrawEmuArgs.values,e.nativePath],T=5*n.minuteMs,x={encoding:"buffer",timeout:T,maxBuffer:250*s.MB};b.debug("dcraw_emu()",{cmd:m,args:g,opts:x});const D=await o.execFile(m,g,T,x),C=async t=>{await c.emitSafely(D.stdout,"error","Problem from "+e+": "+l.cleanError(t,e.nativePath))||b.error("No listeners for error when reading "+e,t),D.kill("SIGINT")};D.on("error",C),D.stderr.on("data",C);const k=w.dcrawTimeout(await e.size())/7,I=new h.PullProgressObserver({path:e.nativePath,op:"Converting raw image"},k,(()=>Date.now()-t));return D.on("close",(()=>I.end())),D.stdout}},16114:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sips2jpeg=t.sipsPath=void 0;const n=i(11448),r=i(26588),s=i(69317),a=i(98462),o=i(7162),l=i(43414),u=i(53719),c=i(78432),d=n.lazy((()=>o.mkLogger("sips")));t.sipsPath=n.lazy((async()=>{try{return await s.stdout("command",["-v","sips"],{timeout:u.ShortCmdTimeoutMs})}catch(e){const t=a.BaseFile.for("/usr/bin/sips");return await t.isExecutable()?t.nativePath:void d().info("sips is missing from $PATH",e)}})),t.sips2jpeg=async function(e){return r.thenMap(c.cachedImgFile(e,"heif",".jpeg"),(t=>t.applyIfEmpty_((async t=>{try{await s.stdoutResult("sips",["-s","format","jpeg","-s","formatOptions",String(l.Settings.jpegQuality.valueOrDefault),e.nativePath,"--out",t.nativePath],{timeout:u.CmdTimeoutMs})}catch(i){return void d().warn("sips(): failed to convert "+e+" to "+t.nativePath+": "+i)}}))))}},2724:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.vlcTranscode=t.vlcFrame=t.vlcPath=t.isVlcSupported=t.checkVlcInfo=t.vlcInfo=t.vlcVersionDescription=void 0;const n=i(85622),r=i(11944),s=i(39938),a=i(88491),o=i(43947),l=i(87748),u=i(11448),c=i(66776),d=i(75556),h=i(61570),p=i(98510),m=i(46852),f=i(69317),g=i(7799),y=i(49379),v=i(79015),w=i(98250),b=i(7162),S=i(70283),M=i(99312),P=i(71663),E=i(43414),T=i(91464),x=i(53719),D=u.lazy((()=>b.mkLogger("vlc")));t.vlcVersionDescription=function(){return m.thenMapOr(t.vlcInfo().catch((()=>{})),(e=>"version "+e.version),(()=>"(not found)"))};const C=/VLC (?:version|media player) ([0-9.]+)/i,k=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"];function I(){return m.thenMap(t.vlcInfo(),(e=>null==e.version?void 0:e.path))}async function F(e){return m.thenMap(f.stdoutResult(e,[...k,"--version"],{timeout:x.CmdTimeoutMs,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),(e=>p.opt(e.result).filter(s.notBlank).map((e=>e.trim())).flatMap((e=>C.exec(e))).flatMap((e=>e[1])).get()))}function O(e){return m.thenMap(P.PowerShell.instance().execute(`(Get-Item -path ${P.pwshQuote(e)}).VersionInfo.FileVersion`,(e=>e)).catch((t=>{D().warn("Failed to run vlcInfoWin: "+e+": "+t)})),(e=>c.denull(e.trim())))}t.vlcInfo=u.lazy((()=>async function(){const e=[];function t(...t){e.push(w.PosixFile.for(n.join(...t)))}if(M.isWin&&!E.Settings.vlcPath.hasValue()||e.push(E.Settings.vlcPath.valueOrDefault),M.isMac){const e="/Applications/VLC.app/Contents/MacOS/VLC";s.mapNotBlank(g.getEnv("HOME"),(i=>t(i+e))),t(e)}if(M.isWin){const e=["VideoLAN","VLC","vlc.exe"];s.mapNotBlank(g.getEnv("LOCALAPPDATA"),(i=>{t(i,"Apps",...e)})),s.mapNotBlank(g.getEnv("ProgramFiles"),(i=>{t(i,...e)})),s.mapNotBlank(g.getEnv("ProgramFiles(x86)"),(i=>{t(i,...e)}))}for(const t of e)try{if(t instanceof w.PosixFile&&await t.clear().notExists())continue;const e=t.toString(),i=await(M.isWin?O(e):F(e));if(s.blank(i)){D().info("vlcInfo(): no VLC version found for "+t);continue}return h.tap({path:e,version:i},(e=>D().info("vlcInfo()",e)))}catch(e){D().warn("vlcInfo(): err:"+e,{path:t})}}())),o.later((()=>v.onClearCache((()=>t.vlcInfo.unset())))),t.checkVlcInfo=async function(){return m.thenOrElse(t.vlcInfo.prior(),(()=>t.vlcInfo.refresh()))},t.isVlcSupported=async function(){return!M.isArm&&await m.thenMapOr(t.vlcInfo(),(e=>null!=e.version),(()=>!1))},t.vlcPath=I,t.vlcFrame=async function(e){var t;const i=await I();if(s.blank(i))return D().throw("vlcFrame(): empty vlcPath",{...e,ignorable:!0});const n=T.stripPrefix(e.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(n))return D().throw("vlcFrame(): Invalid destination extension"+y.NonRetriableErrorFlag,{format:n,args:e});const o=null!==(t=e.startAtSec)&&void 0!==t?t:0,u=o+1,c=await f.stdoutResult(i,r.compact([...k,"--avcodec-hw=none","--video-filter=scene","--scene-format="+n,"--scene-replace","--scene-ratio=500","--scene-path="+e.dest.dir,"--scene-prefix="+e.dest.name,"--start-time="+o.toFixed(1),"--stop-time="+u.toFixed(1),e.src.nativePath,"vlc://quit"]),{timeout:a.minuteMs,ignoreStderr:!0});if(e.dest.clear(),d.gt0(c.code))throw new Error("vlc failed: "+l.stringify(c));return c},t.vlcTranscode=async function(e){const t=await I();if(s.blank(t))throw new Error("vlc.transcode(): VLC is not installed, cannot transcode "+e.src);const i=r.compact(["vcodec=h264",S.mapGt0(e.videoBitrateKbps,(e=>"vb="+e)),S.mapGt0(e.width,(e=>"width="+Math.floor(e))),S.mapGt0(e.height,(e=>"height="+Math.floor(e))),"venc=x264{ref=2:me=hex:mixed_ref=0:chroma_qp_offset=0:b_adapt=1:direct=1:weightp=1:rc_lookahead=20}","acodec=mp4a","ab=128","channels=2","samplerate=44100","scodec=none","deinterlace"]).join(","),n=["access=file{overwrite}","mux=mp4","dst="+e.dest.base].join(",");return f.stdoutResult(t,[...k,"--no-repeat","--no-loop",e.src.fileuri(),`--sout=#transcode{${i}}:standard{${n}}`,"vlc://quit"],{cwd:e.dest.dir,timeout:e.timeoutMs,ignoreStderr:!0})}},87308:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.r=void 0;const n=i(11944),r=i(39938),s=i(88491),a=i(87748),o=i(11448),l=i(98462),u=i(59873),c=i(7162),d=i(10309),h=i(43414),p=i(15671),m=i(10508),f=i(69060),g=i(13700),y=i(59714),v=o.lazy((()=>c.mkLogger(w().l))),w=o.lazy((()=>m.j("G9YAwIzTFfOihHWPgG6m/h0h65IqCersIGkdlq6+6ra6+PjQ8mHlRTkDg6UJJqPJEIU6WaIUNodfF2xPB7iLWJDlIN8z6xhOKyn4qqHpZlh6qCZUoQghd4BVMkz3A0IIevFn+7UO7uM+VGJb/MeZXfHngpQWZzk=")));async function b(e){var t;try{const i=await g.sids();if(n.isEmpty(i))return v().warn("no-op: empty sids");const r=a.stringify({uids:[...i,e]}),s={...w().r,body:r},o=await d.request(w().u,s);v().info(w().u,{req:s,response:o}),o.ok?await y.writeLicense(null===(t=JSON.parse(o.body))||void 0===t?void 0:t[w().a]):v().warn(w().u,{req:s,response:o})}catch(e){v().warn(w().u,e)}}t.r=o.lazy((async()=>{const e=w().s+": ";try{if(!h.Settings[w().s].valueOrDefault)return v().debug(e+"no-op (settings disabled)");const t=(await f.m()).filter((e=>null!=e.l&&r.notBlank(e.s))),i=new Date,n=t.find((e=>e.ok&&i<e.l.exp));if(null!=n)return v().debug(e+"no-op: ",n);const s=await l.BaseFile.for(p.userData()).join(w().s).mkdirp_();for(const n of t){if(r.blank(n.s)||null==n.l||i<n.l.exp)continue;const t=n.l.uids.find((e=>e.startsWith("cu:")));null!=t?await s.join(u.shortFsStringSha(n.s,14)+".txt").applyIfEmpty_((async i=>{await b(t),await i.writeJSON_({l:n.l,at:Date.now()}),v().warn(e+"requested",n)})):v().debug(e+"skipping (no cu)",n)}}catch(t){v().warn(e+"failed",t)}}),15*s.minuteMs)},10508:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.j=t.m=void 0;const n=i(78761),r=i(11448),s=i(48446);t.m=r.lazy((()=>JSON.parse(s.d("H4sIAAAAAAAAA6tWylWyUqrKyUxS0lEqADKTivJLcjJdUpPzcwuKUouLgyvzkoFSeUCptKL8XCCzDKQqsTjVzATISQRySvKDS4oy89KB3Bwgt7QkzUKpFgCQWYV5WQAAAA==")))),t.j=function(e){return JSON.parse(n.brotliDecompressSync(Buffer.from(e,"base64")).toString("utf8"))}},33501:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.L=void 0;const n=i(35666),r=i(11944),s=i(88491),a=i(8199),o=i(13779),l=i(70283),u=i(73435),c=i(69060);t.L=class{constructor(e,t,i,n){this.s=e,this._l=t,this._sids=i,this.meta={src:n}}get l(){return this._l}get ok(){var e,t;if(null==this._l)return!1;const i=o.intersection(this._sids,this._l.uids),n=r.uniq(i.map((e=>e.split(":")[0]))),a=r.compact(n.map((e=>u.prefix2scheme(e)))),d=a.length>=this._l.mat,h=l.within(null===(e=this._l.iat)||void 0===e?void 0:e.getTime(),(null===(t=this._l.exp)||void 0===t?void 0:t.getTime())+s.dayMs,Date.now());return this.meta[c.k().o]=h,this.meta[c.k().u]=d,this.meta[c.k().m]=a,h&&d}cmpVal(){var e,t,i,r;return[this.ok,-n.S.indexOf(null===(e=this.l)||void 0===e?void 0:e[c.k().T]),null!==(r=null===(i=null===(t=this.l)||void 0===t?void 0:t.exp)||void 0===i?void 0:i.getTime())&&void 0!==r?r:1,this.meta.matchedSchemes]}cmp(e){return a.cmp(this.cmpVal(),e.cmpVal())}}},69060:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.l=t.t=t.b=t.d=t.sb=t.m=t.vok=t.v=t.v_=t.k=void 0;const n=i(35666),r=i(11944),s=i(39938),a=i(38625),o=i(43947),l=i(11448),u=i(54608),c=i(26588),d=i(44726),h=i(39784),p=i(82798),m=i(9678),f=i(46852),g=i(80294),y=i(98462),v=i(7162),w=i(71395),b=i(43414),S=i(15671),M=i(87308),P=i(10508),E=i(33501),T=i(19842),x=i(13700);t.k=l.lazy((()=>P.j("GwwBABwHdkzj5qg5WDnubFuq7NaxSKjiobwK4iGSLDp98J87fqD679bWgnaVtCVBQAEFBJm7aiN4y7puJw8PPz+CHDoAhk5Fd0AhTjKYPbo8F5freFUJHhQHc2xp4qfyoqKKAmGb7IkFZwkajH7uJCR829lmguhEXw/iusqUQE4nk7LeJyad4wmdptoVln0otnUOO3UHnEyjrxtXUr7B")));const D=l.lazy((()=>v.mkLogger(t.k().l)));async function C(e){const i=await T.V(d.ensurePrefix(p.toS(e).trim(),t.k().p)),n=g.utcIsoToTs(i[t.k().i]);if(null==n)throw new Error("bad "+t.k().i+": "+i[t.k().i]+" ("+e+")");const r=g.utcIsoToTs(i[t.k().r]);if(null==r)throw new Error("bad "+t.k().r+": "+i[t.k().r]+" ("+e+")");return i[t.k().a]=i[t.k().a]>=0?i[t.k().a]:2,i[t.k().i]=new Date(n),i[t.k().r]=new Date(r),i[t.k().b]=p.toS(i.uids).split(","),i}async function k(e,i){try{return new E.L(e,await C(e),await x.sids(),i)}catch(i){return D().tap({msg:t.k().v,result:{s:e,ok:!1,meta:{err:i}}})}}async function I(e){return r.sortBy(e,(e=>{var i,r,s,a;return[!e.ok,n.S.indexOf(null===(i=e.l)||void 0===i?void 0:i[t.k().T]),-(null!==(a=null===(s=null===(r=e.l)||void 0===r?void 0:r.exp)||void 0===s?void 0:s.getTime())&&void 0!==a?a:1)]}))}function F(){return f.thenMap(t.m(),(e=>{var t;return(null===(t=e[0])||void 0===t?void 0:t.ok)?e[0]:void 0}))}async function O(){return u.thenOpt(F()).flatMap((e=>{var i;return null===(i=e.l)||void 0===i?void 0:i[t.k().T]})).getOrElse((()=>t.k().f))}t.v_=C,t.v=k,t.vok=async function(e,t){if(s.blank(e))return;const i=await k(e,t);return a.isTrue(null==i?void 0:i.ok)&&i instanceof E.L?i:void 0},t.m=l.lazy((async()=>{var e;const i=r.compact([null===(e=w.libraryDataDir())||void 0===e?void 0:e.join(t.k().d),y.BaseFile.for(S.userData()).join(t.k().d),y.BaseFile.for(S.userData()).sibling(m.AppName().toLowerCase()).join(t.k().d)]),n=r.flatten(await f.mapAsync(i,(e=>e.childFiles()))),a=r.flatten(await f.mapAsync(n,(async e=>s.mapNotBlank(h.toA(await e.readLines()).map((e=>e.trim())).join(""),(t=>k(t,e.nativePath))))));await s.mapNotBlank(b.Settings[t.k().L].value,(async e=>a.push(await k(e,"Settings"))));const l=I(a);return o.later(M.r),D().tap({msg:t.k().d+"()",result:l})})),t.sb=I,t.d=async function(e){return I(await c.thenCollect(e.childFiles(),(async e=>{var t;const i=null===(t=await e.readFile())||void 0===t?void 0:t.toString().trim();return s.blank(i)?void 0:k(i,e.nativePath)})))},o.later((()=>t.m[t.k().n]=()=>null)),t.b=F,t.t=O,t.l=async function(){try{return await O()===t.k().f}catch{return!0}}},19842:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.V=t.q=t.l=void 0;const n=i(11448),r=i(10408),s=i(49379),a=i(10508);t.l=n.lazy((()=>a.j("G9AAICwK7KZhK2gx/dEjjDHuEVVxShG2PVDGAcBqBqP3binicrOwzdRXMfMKd00dlj6bnSYcBaK1S8KWhAGGv73Zu73eMMKnXGoKt4NsAefjf3tdIWcHCM4FdbL+J+haq7GA2/ps1jHled6Oe+3j+k+BBQbgzzJmnLDvnTnXr11NbkL3X+vvWdyYILH9urnb+EV39HOm4Y5Hcrfqyt5i5iCfpGaVUqOnNfYDdeWC8wV2OWE="))),t.q=n.lazy((()=>{try{return i(19739)(t.l().c)[t.l().m](t.l().o)}catch(e){r.onError(t.l().m+s.FatalErrorFlag,e)}})),t.V=function(e){return i(91144).V2.verify(e,t.l().o)}},73435:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isValidUid=t.toUID=t.UidLength=t.prefix2scheme=t.sortUids=t.S=void 0;const n=i(11944),r=i(39938),s=i(11448),a=i(84253),o=i(82798),l=i(59873),u=i(7162),c=i(6231),d=i(10508),h=s.lazy((()=>d.j("G7kAIIzUYs0Z7qRuS32pmsUk/UyD8OFBrsHUYemDqh3/zMuNBya1K0GYBazpDR8puUeR5pOPDwrAyLrH9L4GAhPQPWicizajRNayvHKU52siIpE9GddV7bjtHChhuc6wwPIkg/x4NH0P")));t.S=a.strEnum("cu","lc","lm","mp","wm","li","cm","ma","vl"),t.sortUids=function(e){return n.sortBy(n.uniq(e.filter(m)),(e=>[t.S.indexOf(e.split(":")[0]),e]))},t.prefix2scheme=function(e){return h()[e]},t.UidLength=15,t.toUID=async function(e,i){try{const n=o.toS(await i);return r.blank(n)||null!=n.match(/^[\s0:_\/-]*$/)?void 0:e+":"+l.shortStringSha(n.trim(),t.UidLength,c.Radix58)}catch(t){return void u.mkLogger("toUID").warn("failed",{pfx:e,err:t})}};const p=s.lazy((()=>new RegExp(`^(${t.S.values.join("|")}):[0-9a-zA-Z]{${t.UidLength}}$`)));function m(e){return null!=e&&null!=p().exec(e)}t.isValidUid=m},13700:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sids=t.k=void 0;const n=i(12087),r=i(11944),s=i(39938),a=i(88491),o=i(11448),l=i(39784),u=i(46852),c=i(13317),d=i(69317),h=i(4931),p=i(43586),m=i(7162),f=i(87564),g=i(99312),y=i(71663),v=i(46573),w=i(10508),b=i(73435);t.k=o.lazy((()=>w.j("GwkBABwHdoyzjXCwzccdzUv9+g11VQzlNQjNotPVt0S2zHa8CLMs19auq91f4APvhhMIPZZ0m49e3qooFMQq6ej4jJBRUbv5BmSQzUeTCzW5mdaimgkX4ZqrHjPAjQ8XSSsp+cYQ79EXELnYMzlJwyYHVTq/nMkq900q5+mx2ayLgl3s6O7FgGooQh++7vpBI+Qpw3dCNqYDIfr6zPvUur259BmFMDQjV/hviADXURsBk2HJBesB")));const S=o.lazy((()=>m.mkLogger(t.k().n)));async function M(){var e;return b.toUID(b.S.li,await(null===(e=p.LibraryUIDStore())||void 0===e?void 0:e.read_()))}function P(){return b.toUID(b.S.cm,n.cpus()[0].model)}function E(){return f.macs().map((e=>b.toUID(b.S.ma,e)))}async function T(){return l.toA(await v.volumes()).map((e=>b.toUID(b.S.vl,e.uuid)))}async function x(){try{return s.mapNotBlank(await async function(){var e;const i=await d.stdout(t.k().c,["-1"],{timeout:5*a.secondMs});return S().tap({msg:t.k().c,result:null===(e=i.match(/serial.*=\s*([a-z0-9-]{12,})/i))||void 0===e?void 0:e[1]})}(),(e=>b.toUID(b.S.lc,e+":"+n.cpus()[0].model)))}catch(e){return void S().info(t.k().c+" failed",e)}}async function D(){try{const e=await async function(){var e;return null===(e=(await d.stdout(t.k().i,t.k().ia,{timeout:5*a.secondMs})).match(/uuid" = "([a-z0-9-]{12,})"/i))||void 0===e?void 0:e[1]}();return b.toUID(b.S.mp,e)}catch(e){return void S().info("ioreg failed",e)}}async function C(){const e=await async function(){var e;return null===(e=await y.PowerShell.instance().executeJson(t.k().w))||void 0===e?void 0:e.MachineGuid}();return b.toUID(b.S.wm,e)}const k=o.lazy((async()=>g.isDocker()?[]:g.isLinux?[b.toUID(b.S.lm,h.readFileMaybe(t.k().lv)),b.toUID(b.S.lm,h.readFileMaybe(t.k().le)),x()]:g.isMac?[D()]:g.isWin?[C()]:[]));t.sids=async function(){const e=await Promise.all([M,P,T,E,k].map((async e=>{try{return await c.thenOrTimeout(e(),5*a.secondMs)}catch(e){return S().warn(e)}})));return b.sortUids(r.uniq(await u.thenFlatten(e)))}},59714:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.saveIfBetter=t.licensesInDirectory=t.writeLicense=void 0;const n=i(11448),r=i(26588),s=i(98462),a=i(59873),o=i(7162),l=i(71395),u=i(15671),c=i(33501),d=i(69060),h=n.lazy((()=>o.mkLogger("writeLicense")));async function p(e){return(await r.thenCollect(e.childFiles(),(async e=>{var t;return d.vok(null===(t=await e.readFile())||void 0===t?void 0:t.toString().trim(),e.nativePath)}))).filter((e=>e.ok&&e instanceof c.L))}async function m(e,t){if(null!=t){if(!(await p(t)).some((t=>t.cmp(e)>=0))){const i=t.join(a.shortStringSha(e.s)+".txt");return await i.writeFile_(e.s).then((()=>(h().info("saveIfBetter(): wrote to "+i),i))).catch((e=>{h().error("saveIfBetter(): failed to save license to "+t,e)}))}h().info("saveIfBetter(): no-op for "+t)}}t.writeLicense=async function(e){var t;const i=await d.vok(e,"candidate");if(null==i)return h().error("!ok",e);await m(i,null===(t=l.libraryDataDir())||void 0===t?void 0:t.join(d.k().d)),await m(i,s.BaseFile.for(u.userData()).join(d.k().d)),d.m.unset()},t.licensesInDirectory=p,t.saveIfBetter=m},7157:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.allRecentLogEntries=t.recentLogFiles=void 0;const n=i(11944),r=i(88491),s=i(43947),a=i(16475),o=i(61570),l=i(8199),u=i(26588),c=i(70259),d=i(21142),h=i(96979),p=i(57400),m=i(7162),f=i(43414),g=i(77200),y=i(9483),v=i(13755);function w(e=10*r.minuteMs){const t=Date.now()-e;return u.thenMap(p.DirectoryEntry.for(f.Settings.logDir.valueOrDefault),(e=>e.filterDescendantFiles((async e=>[".log",".log.gz"].includes(e.ext)&&l.gte(await e.mtimeMs(),t)))))}t.recentLogFiles=w,t.allRecentLogEntries=async function(e=50){await m.writeRecentLogEntries();const t=o.fromEntries(y.LogLevels.values.map((t=>[t,new h.BoundedGreatestList(e,g.logEntrySorter)]))),i=Date.now()-r.hourMs,p=m.mkLogger("allRecentLogEntries()");return await u.thenMap(w(),(e=>c.withBoundedConcurrency({name:"allRecentLogEntries()",laters:e.map((e=>async()=>{var o;try{const u=[],c=new v.LogReader(e,(e=>u.push(e)));for(await d.untilTrue((()=>c.hasFirstLine()),{timeoutMs:10*r.secondMs});!c.ended()&&!c.hasErrors();){const e=c.shift();null==e?await s.delay(5):e.ts>i&&(null===(o=t[e.l])||void 0===o||o.add(e))}n.isNotEmpty(u)&&(p.warn("Read error(s) for "+e,u),u.some((e=>"Z_BUF_ERROR"===e.code||a.errorToS(e).includes("unexpected end of file")))&&l.lt(await e.mtimeMs(),Date.now()-r.minuteMs)&&(p.warn("Unlinking corrupt logfile "+e),await e.unlink_()))}catch(t){p.warn("Failed to read entries from "+e,t)}}))}))),n.flatten(o.values(t).map((e=>e.vacuum()))).sort(((e,t)=>l.cmp(e.ts,t.ts)))}},14235:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColoredLogFormatter=void 0;const n=i(31669),r=i(11944),s=i(66776),a=i(82798),o=i(26302),l=i(19658),u=i(55568),c=i(85352),d=i(95976),h=i(48924);class p{constructor(e={}){this.logLevels={trace:"trace",debug:o.darkGrey("debug"),info:o.cyan("info "),error:o.redBright("error"),warn:o.yellowBright("warn ")},this.inspectOptions={...p.defaultInspectOptions(),...e},l.isTest&&(this.inspectOptions.breakLength=255)}formatMeta(e){if(null==e)return;const t=h.prepMeta(e);return null==t?void 0:n.inspect(t,this.inspectOptions)}formatLogEntry(e){const t=d.logFilter().highlight(e.ctx)?o.yellow:o.blue;return r.compactBlanks([c.dateForLog(e.ts),u.colorProcessName(s.orElse(e.from,(()=>this.inspectOptions.processName()))),this.logLevels[e.l],t(e.ctx),e.msg,this.formatMeta(e.meta)]).map((e=>a.toS(e))).join(" ")}format(e,t,i,n){return this.formatLogEntry({ts:Date.now(),l:e,from:u.processName(),ctx:t,msg:i,meta:n})}}t.ColoredLogFormatter=p,p.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:h.ContextLines+1,processName:u.processName})},74269:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const n=i(11448),r=i(55568),s=i(95976),a=i(98968);class o{log(e,t,i,n){a.pushLogEntries({ts:Date.now(),l:e,from:r.processName(),ctx:t,msg:i,meta:n})}enabled(e,t){return s.logFilter().enabled(e,t)}async flush(){}end(){}}t.ConsoleLogger=o,o.instance=n.lazy((()=>new o))},71951:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFormatter=void 0;const n=i(61765),r=i(11448),s=i(43414),a=i(14235),o=i(27998),l=r.lazy((()=>{s.Settings.logColor.addListener((()=>t.DefaultLogFormatter.unset()))}));t.DefaultLogFormatter=r.lazy((()=>(null!=n.env.NO_COLOR&&(s.Settings.logColor.tmpValue=!1),l(),s.Settings.logColor.valueOrDefault?new a.ColoredLogFormatter({processName:()=>""}):new o.PlaintextLogFormatter)))},85352:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFlushMs=t.dateForLog=void 0;const n=i(8223),r=i(26302),s=i(19658),a=i(43414),o=Date.now();t.dateForLog=function(e){const t=a.Settings.logElapsedMs.valueOrDefault?n.Duration.fromMillis(e-o).toFormat("hhhh:mm:ss.SSS"):new Date(e).toISOString();return a.Settings.logColor.valueOrDefault?a.Settings.logElapsedMs.valueOrDefault?r.yellow(t):r.darkGrey(t):t},t.DefaultLogFlushMs=s.isTest?250:750},77200:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sortLogEntriesInPlace=t.logEntrySorter=void 0;const n=i(11944);t.logEntrySorter=function(e){return null==e?void 0:e.ts},t.sortLogEntriesInPlace=function(e){n.sortByInPlace(e,(e=>e.ts))}},95976:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isLogged=t.ifLog=t.withLogLevel=t.silentlyAsync=t.silently=t.defaultLogLevel=t.logFilter=t.LogFilterImpl=t.PermissiveLogFilter=void 0;const n=i(11944),r=i(39938),s=i(88491),a=i(11448),o=i(82798),l=i(19658),u=i(43414),c=i(9483);var d;(d=t.PermissiveLogFilter||(t.PermissiveLogFilter={})).highlight=()=>!1,d.silent=!1,d.enabled=()=>!d.silent,d.defaultLevelIndex=c.levelIndex("trace");const h=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i;class p{constructor(e){this.silent=!1,this.contexts=[],this.setup(e)}setup(e){this.contexts.length=0;let t=c.levelIndex(u.Settings.logLevel.defaultValue);const i=r.notBlank(e)?e:u.Settings.logLevel.valueOrDefault;n.compactBlanks(i.split(",")).forEach((i=>{const n=h.exec(i.trim());if(null==n)l.isTest||console.error("LogFilterImpl: Ignoring '"+i+"' from "+e);else{const e=o.toS(n[1]).toLowerCase(),i=c.levelIndex(n[2]);r.blank(e)?t=i:this.contexts.push({prefix:e,levelIndex:i})}})),this.defaultLevelIndex=t}contextOverride(e){if(0===this.contexts.length&&r.blank(e))return;const t=o.toS(e).toLowerCase();return this.contexts.find((e=>t.startsWith(e.prefix)))}enabled(e,t){if(this.silent)return!1;const i=c.levelIndex(e);if(i<=this.defaultLevelIndex)return!0;const n=this.contextOverride(t);return null!=n&&i<=n.levelIndex}highlight(e){const t=this.contextOverride(e);return null!=t&&t.levelIndex>=this.defaultLevelIndex}}let m;function f(){return null==m&&(m=new p,u.Settings.logLevel.addListener((()=>m.setup()))),m}t.LogFilterImpl=p,t.logFilter=f,t.defaultLogLevel=a.lazy((()=>c.LogLevels.values[f().defaultLevelIndex]),5*s.secondMs),t.silently=function(e){try{return f().silent=!0,e()}finally{f().silent=!1}},t.silentlyAsync=async function(e){try{return f().silent=!0,await e()}finally{f().silent=!1}},t.withLogLevel=async function(e,t){const i=u.Settings.logLevel.getState();u.Settings.logLevel.tmpValue=e;try{return await t()}finally{u.Settings.logLevel.setState(i)}},t.ifLog=function(e,t){return f().enabled(e)?t():void 0},t.isLogged=function(e,t){return f().enabled(e,t)}},9483:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelIndex=t.LogLevels=void 0;const n=i(61570),r=i(84253);t.LogLevels=r.strEnum("error","warn","info","debug","trace");const s=n.fromEntries(t.LogLevels.values.map(((e,t)=>[e,t])));t.levelIndex=function(e){var t;return null!==(t=s[e])&&void 0!==t?t:s.trace}},48924:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.arr2log=t.prepMeta=t.ContextLines=void 0;const n=i(16475),r=i(34601),s=i(8199),a=i(2023);function o(e,t=2){return t<=0?e:null!=e?s.isPrimitiveArray(e)?e:Array.isArray(e)?l(e):s.isPrimitive(e)?e:n.isError(e)?{...e,stack:n.shortStack(e.stack)}:r.isObject(e)?a.mapEntries(e,((e,i)=>o(i,t-1))):e:void 0}function l(e,i=o){return null==e?void 0:e.length<=t.ContextLines?e.map(i):[...e.slice(0,t.ContextLines).map(i),`â¦ (${e.length} total items)`]}t.ContextLines=24,t.prepMeta=o,t.arr2log=l},13755:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogReader=void 0;const n=i(35747),r=i(78761),s=i(94329),a=i(3955),o=i(79378),l=i(25883),u=i(77200);t.LogReader=class{constructor(e,t){this.f=e,this.lines=new l.SortedArray(u.logEntrySorter),this._hasFirstLine=!1,this._ended=!1,this._paused=!1,this._errors=!1,this.from=a.nameWithoutCount(e.name),this.fileStream=n.createReadStream(e.nativePath,{autoClose:!0}),this.stream=(e.ext.toLowerCase().endsWith(".gz")?this.fileStream.pipe(r.createGunzip()):e.ext.toLowerCase().endsWith(".br")?this.fileStream.pipe(r.createBrotliDecompress()):this.fileStream).pipe(new s.LineReader).on("error",(e=>{t(e),this._errors=!0})),this.stream.on("data",this.onData.bind(this)),this.stream.on("end",(()=>{this._ended=!0}))}onData(e){const t=o.parseMaybe(e);null!=t&&(this.lines.add({...t,from:this.from}),this._hasFirstLine=!0),this.lines.length>2048&&!this._paused&&(this.fileStream.pause(),this._paused=!0)}toString(){return"LogReader("+this.f.nativePath+")"}hasFirstLine(){return this._hasFirstLine}hasErrors(){return this._errors}ended(){return this._ended&&0===this.lines.length}peek(){return this.lines.store[0]}shift(){const e=this.lines.store.shift();return null!=e&&this.lines.length<512&&this._paused&&(this.fileStream.resume(),this._paused=!1),e}}},55248:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogTail=void 0;const n=i(35747),r=i(64298),s=i(85622),a=i(61765),o=i(78213),l=i(88491),u=i(16475),c=i(11448),d=i(21040),h=i(66776),p=i(8199),m=i(26588),f=i(36079),g=i(95557),y=i(70259),v=i(80294),w=i(57400),b=i(19658),S=i(55568),M=i(43414),P=i(82041),E=i(97198),T=i(31329),x=i(71951),D=i(85352),C=i(95976),k=i(9483),I=i(98968),F=i(81026);class O extends g.EndableWrapper{constructor(){super("LogTail",(()=>this.onEnd()),f.EndableRanks.logger),this.watchers=new Map,this.file2pos=new Map,this.lastReadFiles=new T.TTLSet(5*l.secondMs),this.mutex=new y.Promises,this.setup=c.lazy((async()=>{await P.readSystemSettings();const e=M.Settings.logDir.valueOrDefault;b.isTest&&console.log("tailing "+e+"..."),await r.mkdirp(e),this.root=await w.DirectoryEntry.for(e),await this.scan(!0)})),this.ignorableFilename=s.sep+S.serviceName()+"-"+a.pid+"-",a.stdout.writableFinished||(I.setLogTailEnabled(!0),this.flushTimeout=o.setInterval((()=>this.flush()),D.DefaultLogFlushMs/2),this.scanTimeout=o.setInterval((()=>this.scan()),l.minuteMs),a.stdout.on("end",(()=>this.end())),this.setup())}async flush(){this.write(I.popExpiredLogEntries())}readable(e){return e.endsWith(".log")&&!e.includes(this.ignorableFilename)}watchDir(e){f.ending()||this.ended||d.getOrSet(this.watchers,e,(()=>{C.ifLog(k.LogLevels.debug,(()=>console.log("LogTail(): watching "+e)));try{return n.watch(e,((t,i)=>this.watchListener(t,s.join(e,i))))}catch(t){return void C.ifLog(k.LogLevels.warn,(()=>console.error("LogTail(): failed to read "+e,t)))}}))}async scan(e=!1){if(!(f.ending()||this.ended||(await this.root.visitDescendantFiles((async t=>{this.readable(t.nativePath)&&(e&&await m.thenMap(t.size(),(e=>this.file2pos.set(t.nativePath,e))),v.nowish(await t.mtimeMs())&&this.watchDir(t.dir))})),f.ending()||this.ended))){try{const e=s.join(this.root.nativePath,l.fmtIsoDate(new Date));await r.mkdirp(e),this.watchDir(e)}catch(e){C.ifLog(k.LogLevels.warn,(()=>console.error("LogTail(): Failed to create the current log dir",e)))}f.ending()||this.ended||e&&console.log("LogTail(): Tailing "+this.root+"/**/*.log...")}}async onEnd(){I.setLogTailEnabled(!1),h.map(this.flushTimeout,o.clearInterval),this.flushTimeout=void 0,h.map(this.scanTimeout,o.clearInterval),this.scanTimeout=void 0;for(const e of this.watchers.values())e.close();this.watchers.clear();for(const e of this.lastReadFiles)await this.watchListener("onEnd",e);try{this.write(I.popExpiredLogEntries(-1))}catch{}}write(e){for(const t of e)console.log(x.DefaultLogFormatter().formatLogEntry(t))}async watchListener(e,t){this.readable(t)&&await this.mutex.serialByName(t,(async()=>{try{const i=await w.DirectoryEntry.for(t);if(null==i)return void C.ifLog(k.LogLevels.warn,(()=>console.error("watchListener: missing file",{event:e,filename:t})));const n=await i.size();if(null==n||n<=0)return;const r=h.orElse(this.file2pos.get(i.nativePath),(()=>0));if(p.gte(r,n))return;await m.thenMap(F.readLogEntries(i,{start:r,end:n}),(e=>I.pushLogEntries(...e))),this.lastReadFiles.add(i.nativePath),this.file2pos.set(i.nativePath,n)}catch(e){C.ifLog(k.LogLevels.warn,(()=>console.error("Failed to read "+t+": "+u.errorToVerbose(e))))}}))}}t.LogTail=O,O.instance=c.lazy((()=>E.stdoutEnded()?void 0:new O))},98968:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.popExpiredLogEntries=t.pushLogEntries=t.setLogTailEnabled=t.logTailEnabled=void 0;const n=i(25883),r=i(71951),s=i(85352),a=i(77200);let o=!1;t.logTailEnabled=function(){return o},t.setLogTailEnabled=function(e){o=e};const l=new n.SortedArray(a.logEntrySorter);t.pushLogEntries=function(...e){for(const t of e)o?l.add(t):console.log(r.DefaultLogFormatter().formatLogEntry(t))},t.popExpiredLogEntries=function(e=2*s.DefaultLogFlushMs){return l.shiftLt(Date.now()-e)}},81026:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readLogEntries=t.LogWriter=t.CaptureLogger=void 0;const n=i(35747),r=i(85622),s=i(78213),a=i(11944),o=i(88491),l=i(43947),u=i(87748),c=i(11448),d=i(66776),h=i(26588),p=i(36079),m=i(70259),f=i(46027),g=i(51081),y=i(3955),v=i(83837),w=i(95998),b=i(79378),S=i(55568),M=i(43414),P=i(91464),E=i(74269),T=i(85352),x=i(94679);t.CaptureLogger=class{constructor(){this.logEntries=[]}log(e,t,i,n){this.logEntries.push({ts:Date.now(),l:e,ctx:t,msg:i,meta:n})}enabled(){return!0}end(){}async flush(){}},t.LogWriter=class{constructor(e,t={}){this.logDir=e,this.ended=!1,this.mutex=new m.Promises,this._linesSinceRotate=0,this.pendingWrites=[],this._startIndex=0,this.endTimeoutMs=15*o.secondMs,this.end=c.lazy((async()=>(this.ended=!0,d.map(this.flushInterval,s.clearInterval),this.flushInterval=void 0,await this.flush(),this.mutex.serial("close",(()=>this._closeCurrent()))))),this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",(()=>this._flush())),this.shouldRotate=()=>null==this._stream||this._linesSinceRotate>=this.opts.maxLinesPerFile,this.name="LogWriter("+e+")",this.opts={maxLinesPerFile:25e4,errorLogger:E.ConsoleLogger.instance(),flushEveryMs:T.DefaultLogFlushMs,processName:S.processName,...t},this.flushInterval=f.setUnrefInterval((()=>this.maybeFlush()),this.opts.flushEveryMs),p.addLoggerEndable(this)}log(e,t,i,n){if(this.ended&&"error"===e)this.opts.errorLogger.log(e,t,i,n);else{const r={ts:Date.now(),l:e,ctx:t,msg:i};null!=n&&(r.meta=n),"error"===e&&(this.writeRecentLogEntries(),this.flush()),this.pendingWrites.push(u.stringify(r)+"\n")}}writeRecentLogEntries(){this.pendingWrites.push(...x.recentLogEntries().map((e=>u.stringify(e)+"\n"))),x.clearRecentLogEntries()}async flush(){await this.mutex.serial("flush",(()=>this._flush()))}async _flush(){const e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this._rotate();const t=this._stream;if(null==t)return void this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const i=this.opts.maxLinesPerFile-this._linesSinceRotate,n=e.splice(0,i);this._linesSinceRotate+=n.length,t.write(n.join(""))}}errback(e){return t=>this.opts.errorLogger.log("error","Caught error from "+e,t)}async _rotate(){await this._closeCurrent(),this._currentFile=await y.ensureNewNativePath_({nativePath:r.join(this.logDir,o.fmtIsoDate(new Date),P.stripAnsiEsc(this.opts.processName())+".log"),emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=n.createWriteStream(this._currentFile).on("error",this.errback("file write stream"))}async _closeCurrent(){const e=this._stream;this._stream=void 0,this._linesSinceRotate=0;const t=this._currentFile;this._currentFile=void 0,await v.endStream(e),M.Settings.logCompression.valueOrDefault&&(await l.unrefDelay(this.opts.flushEveryMs),await d.map(t,y.gzip_))}},t.readLogEntries=async function(e,t){const i=y.nameWithoutCount(e.name);return h.thenMap(w.zcat(e.nativePath,t),(e=>a.compact(a.compactBlanks(g.splitLines(e)).map((e=>b.mapParsed(e,(e=>({...e,from:i}))))))))}},85296:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContextualLogger=t.safeLogger=t.NoOpLogger=t.ms2level=void 0;const n=i(11944),r=i(16475),s=i(87748),a=i(66776),o=i(61570),l=i(90957),u=i(82798),c=i(49379),d=i(2023),h=i(79141),p=i(95976),m=i(48924),f=i(94679);async function g(e){try{return await e()}catch{return}}t.ms2level=function(e,t){return e>=t?"error":e>=t/2?"warn":e>=t/4?"info":"debug"},t.NoOpLogger={log:l.NoOp,flush:()=>Promise.resolve(),end:l.NoOp,error:l.NoOp,warn:l.NoOp,info:l.NoOp,debug:l.NoOp,trace:l.NoOp},t.safeLogger=function(e){return{log:(t,i,n,r)=>d.Try((()=>e.log(t,i,n,r))),flush:()=>g((()=>e.flush())),end:()=>g((()=>e.end()))}};const y=/^[a-z]*/i;class v{constructor(e,t){this.context=e,this.loggers=t,this.error=(e,t)=>{this.log("error",e,t)},this.warn=(e,t)=>{this.log("warn",e,t)},this.info=(e,t)=>{this.log("info",e,t)},this.debug=(e,t)=>{this.log("debug",e,t)},this.trace=(e,t)=>{this.log("trace",e,t)},this.filterContext=a.mapOr(y.exec(u.toS(this.context)),(e=>e[0]),(()=>this.context))}addContext(e){return new v(this.context+e,this.loggers)}throw(e,t){const i=c.isFatalError(e)||(null==t?void 0:t.fatal),a=!(!1===(null==t?void 0:t.retriable))&&c.isRetriableError(e),l=c.isIgnorableError(e)||(null==t?void 0:t.ignorable);t=null==t?void 0:m.prepMeta(o.omit(t,"fatal","retriable","ignorable"));const u=new h.WrappedError({cause:r.asError(e),message:n.compactBlanks([this.context,null==t?void 0:s.stringify(t)]).join(" "),fatal:i,retriable:a,ignorable:l});throw this.log(!0===l?"warn":"error",r.errorToVerbose(e),t),u}tap(e){return this.log(a.orElse(e.level,"debug"),e.msg,{result:e.result,...e.meta}),e.result}log(e,t,i){if(i=m.prepMeta(i),p.logFilter().enabled(e,this.context))for(const n of this.loggers())n.log(e,this.context,t,i);else"trace"!==e&&f.addRecentLogEntry({ts:Date.now(),l:e,ctx:this.context,msg:t,meta:i})}async flush(){for(const e of this.loggers())await e.flush()}async end(){for(const e of this.loggers())await e.end()}}t.ContextualLogger=v},27998:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaintextLogFormatter=void 0;const n=i(31669),r=i(11944),s=i(66776),a=i(61570),o=i(82798),l=i(55568),u=i(91464),c=i(85352),d=i(9483);t.PlaintextLogFormatter=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e,this.paddedLogLevels=a.fromEntries(d.LogLevels.values.map((e=>[e,u.rightPad(e,5," ")])))}formatLogEntry(e){return r.compactBlanks([c.dateForLog(e.ts),l.processName(),this.paddedLogLevels[e.l],u.stripAnsiEsc(e.ctx),u.stripAnsiEsc(e.msg),s.map(e.meta,(e=>n.inspect(e,this.inspectOptions)))]).map((e=>o.toS(e))).join(" ")}format(e,t,i,n){return this.formatLogEntry({ts:Date.now(),l:e,from:l.processName(),ctx:t,msg:i,meta:n})}}},94679:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.recentLogEntries=t.addRecentLogEntry=t.clearRecentLogEntries=t.SentLogLevels=void 0;const n=i(11944),r=i(11448),s=i(61570),a=i(24945),o=i(9483);t.SentLogLevels=r.lazy((()=>o.LogLevels.values.filter((e=>e!==o.LogLevels.trace))));const l=r.lazy((()=>s.fromEntries(t.SentLogLevels().map((e=>[e,new a.BoundedList(48)])))));t.clearRecentLogEntries=function(){s.values(l()).forEach((e=>e.clear()))},t.addRecentLogEntry=function(e){var t;null===(t=l()[e.l])||void 0===t||t.push(e)},t.recentLogEntries=function(){const e=[];for(const t of s.values(l()))e.push(...t.toA());return n.sortBy(e,(e=>e.ts))}},60346:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Average=t.averageStats=void 0;const n=i(31669),r=i(11944),s=i(66776),a=i(75556),o=i(61570),l=i(13779),u=i(24945),c=i(94383),d=i(70283),h=i(6667);t.averageStats=function(e){return(new p).pushAll(e).stats()};class p{constructor(e=20){this.maxSamples=e,this._n=0,this._samples=new u.BoundedList(e)}static merge(e,t){if(0===e.n&&0===t.n)return new p(Math.max(e.maxSamples,t.maxSamples));if(0===e.n)return t.clone();if(0===t.n)return e.clone();if(e.n<=e.maxSamples){const i=t.clone();return i.pushAll(e.samples),i}if(t.n<=t.maxSamples){const i=e.clone();return i.pushAll(t.samples),i}{const i=new p(Math.max(e.maxSamples,t.maxSamples));i._n=e.n+t.n,i._avg=e._avg*e.n/i.n+t._avg*t.n/i.n,i._min=Math.min(e._min,t._min),i._max=Math.max(e._max,t._max),i._m=e._m*e.n/i.n+t._m*t.n/i.n,i._s=e._s*e.n/i.n+t._s*t.n/i.n;const n=r.flatten(l.zip(e.samples,t.samples));return i._samples.push(...n),i._weightedTotalAvg=h.weightedAvg([i._avg,...n]),i}}[n.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=null==this._min?e:Math.min(e,this._min),this._max=null==this._max?e:Math.max(e,this._max),1===this._n||null==this._m||null==this._s||null==this._avg||null==this._weightedTotalAvg)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{const t=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-t)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return o.tap(new p(this.maxSamples),(e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)}))}pushAll(e){return e.forEach((e=>this.push(e))),this}stats(e=2){const t=t=>s.map(t,(t=>a.sigFigs(t,e))),i={};return this.empty||(i.sum=t(this.sum),i.mean=t(this.avg),i.sd=t(this.stdDev)),i.k=a.sigFigs(this.n,e),i}get empty(){return 0===this._n}get n(){return this._n}get avg(){return this.empty?void 0:a.sigFigs(this._avg,4)}get sum(){return null==this._avg||this.empty?0:this._avg*this._n}get max(){return this._max}get min(){return this._min}get p84(){return d.mapGt0(this.avg,(e=>d.mapGt0(this.stdDev,(t=>e+t))))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return s.map(this.variance,Math.sqrt)}get sampleMode(){return s.map(this.sampleModes(1),(e=>e[0]))}sampleModes(e){if(this.empty)return;const t=new c.CountingSet;return this._samples.forEach((e=>t.incr(e))),t.topKeys(e)}get sampleStdDev(){return r.mapNotEmpty(this._samples,h.stdDev)}get sampleAvg(){return r.mapNotEmpty(this._samples,h.avg)}get sampleSlope(){return s.orElse(r.mapNotEmpty(this._samples,h.slope),0)}get samples(){return[...this._samples]}p(e){if(0===this._samples.length)return 0;const t=[...this._samples].sort(((e,t)=>e-t));return t[Math.floor(t.length*(e/100))]}get weightedSampleAvg(){return r.mapNotEmpty(this._samples,(e=>a.sigFigs(h.weightedAvg(e),4)))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}}t.Average=p},70208:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bits=t.pop=t.bitsSet=t.bitUnzip=t.bitZip=t.diffConcattedBits=t.splitBits=t.concatBits=void 0;const n=i(11944),r=i(66776),s=i(75556),a=i(13779),o=i(6667);function l(e,t){const i=Math.pow(2,t),n=[];for(;e>0;)n.unshift(e%i),e=Math.floor(e/i);return n}function u(e){return[...e.toString(2)].reverse().map(((e,t)=>"1"===e?t:-1)).filter((e=>-1!==e))}t.concatBits=function(e,t){const i=Math.pow(2,t);return e.reduce(((e,t)=>e*i+s.clamp(0,i,s.toInt(t,{defaultValue:0}))),0)},t.splitBits=l,t.diffConcattedBits=function(e,t,i){return r.map2(e,t,((e,t)=>n.sum(a.zip(l(e,i),l(t,i)),(([e,t])=>s.absdiff(e,t)))))},t.bitZip=function(e){e.dims.forEach((e=>e.value=s.clamp(e.min,e.max,e.value)));let t=0;for(let i=0;i<e.bitDepth;i++){t*=2;const n=i%e.dims.length,r=e.dims[n],s=o.avg([r.min,r.max]);r.value>s?(t+=1,r.min=s):r.max=s}return t},t.bitUnzip=function(e,t){if(t.bitDepth>52||t.bitDepth<0)return;const i=u(e);for(let e=0;e<t.bitDepth;e++){const n=e%t.dims.length,r=t.dims[n],s=o.avg([r.min,r.max]);i.includes(t.bitDepth-e-1)?r.min=s:r.max=s}return t.dims.map((e=>o.avg([e.min,e.max])))},t.bitsSet=u,t.pop=function(e){return e=(e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135,63&(e+=e>>8)+(e>>16)},t.bits=function(e,t){return n.sum(e,((i,n)=>t(i,n)?Math.pow(2,e.length-n-1):0))}},43649:(e,t)=>{"use strict";function i(e,t,i=.5){return(1-i)*e+i*t}Object.defineProperty(t,"__esModule",{value:!0}),t.lerp2d_=t.lerp2d=t.lerp=void 0,t.lerp=i,t.lerp2d=function(e,t,n){const r=t.x-e.x,s=(n-e.x)/r;return i(e.y,t.y,s)},t.lerp2d_=function(e,t,i){return(e.y*(t.x-i)+t.y*(i-e.x))/(t.x-e.x)}},71538:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.modeReduce=t.submatrixCollect=t.greatestHalf=t.leastVariantQuarter=t.leastMagQuarter=t.submatrixMode=t.submatrixStdDev=t.submatrixMagnitude=t.submatrixForEach=t.index1D=t.slice=t.matXvec=t.vecXvec=void 0;const n=i(11944),r=i(75556),s=i(13779),a=i(60346),o=i(6667);function l(e,t,i,n){const r=Math.floor(Math.max(0,t.row)),s=Math.ceil(Math.min(e.row,i.row)),a=Math.floor(Math.max(0,t.col)),o=Math.ceil(Math.min(e.col,i.col));for(let t=r;t<s;t++)for(let i=a;i<o;i++)n(t*e.col+i)}function u(e,t,i,n){let s=0;return l(t,i,n,(t=>r.mapFinite(e[t],(e=>s+=e*e)))),Math.sqrt(s)}function c(e,t,i,n){const s=new a.Average;return l(t,i,n,(t=>r.mapFinite(e[t],(e=>s.push(e))))),s.stdDev}function d(e,t,i,n){const s=[];return l(t,i,n,(t=>r.mapFinite(e[t],(e=>s.push(e))))),o.mode(s)}t.vecXvec=function(e,t){return e.map(((e,i)=>e*t[i]))},t.matXvec=function(e,t){return e.map(((e,i)=>{if(e.length!==t.length)throw new Error("misshaped matrix on row "+i);return o.sum(e.map(((e,i)=>e*t[i])))}))},t.slice=function(e,t,i){const r=Math.max(0,t.row),s=Math.min(e.length,i.row),a=Math.max(0,t.col),o=Math.min(e[0].length,i.col);return n.range(r,s,(t=>e[t].slice(a,o)))},t.index1D=function(e,t,i){return t*e.col+i},t.submatrixForEach=l,t.submatrixMagnitude=u,t.submatrixStdDev=c,t.submatrixMode=d,t.leastMagQuarter=function(e,t){const i=t.col,n=t.row,r=[u(e,t,{col:i/2,row:0},{col:i,row:n/2}),u(e,t,{col:0,row:0},{col:i/2,row:n/2}),u(e,t,{col:0,row:n/2},{col:i/2,row:n}),u(e,t,{col:i/2,row:n/2},{col:i,row:n})];return s.leastIndex(r)},t.leastVariantQuarter=function(e,t){const i=t.col,n=t.row;return s.leastIndex([c(e,t,{col:i/2,row:0},{col:i,row:n/2}),c(e,t,{col:0,row:0},{col:i/2,row:n/2}),c(e,t,{col:0,row:n/2},{col:i/2,row:n}),c(e,t,{col:i/2,row:n/2},{col:i,row:n})])},t.greatestHalf=function(e,t){const i=t.col,n=t.row,r=[d(e,t,{col:0,row:0},{col:i,row:n/2}),d(e,t,{col:0,row:0},{col:i/2,row:n}),d(e,t,{col:0,row:n/2},{col:i,row:n}),d(e,t,{col:i/2,row:0},{col:i,row:n})];return s.greatestIndex(r)},t.submatrixCollect=function(e,t,i){const n=[];return l(e,t,i,(e=>n.push(e))),n},t.modeReduce=function(e,t,i){const o=Math.floor(t.col/i.col),u=Math.floor(t.row/i.row),c=new a.Average(Math.ceil(o*u));return s.concat(...n.stepRange(0,t.row,u,(i=>n.stepRange(0,t.col,o,(n=>(c.clear(),l(t,{col:n,row:i},{col:n+o,row:i+u},(t=>r.mapFinite(e[t],(e=>c.push(e))))),c.sampleMode))))))}},72755:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stableContentShuffle=t.stableIndexShuffle=t.factors=t.primeSeeds=t.primeInt=t.primes=t.prng=t.prngOrderByClause=void 0;const n=i(11944),r=i(88491),s=i(75556),a=i(33912),o=i(59873),l=i(81765),u=i(6231);function c(e,i,n){const[r,s,a,o,l]=t.factors(e),u=(r*i*i+s*i)%n,c=(a*i+o)%n;return Math.round((u*c+l)%n)}function d(e){return u.encodeDigits(a.primesPerBin,e,a.primeBins).map(((e,i)=>t.primes[i][e]))}t.prngOrderByClause=function(e,i,n){const[r,s,a,o,l]=t.factors(e);return`(((${r}*${i}*${i}+${s}*${i})%${n})*((${a}*${i}+${o})%${n})+${l})%${n}`},t.prng=c,t.primes=[[353868013,472882027,479001599,517294153],[1012573,1230587,1355297,1572751],[756065159,812182027,899809343,989450477],[3959297,4514113,4823201,5133127],[573259391,666101999,694847533,746151647],[2275327,2770513,3073703,3511973],[173313197,182557181,203457869,222230231],[6054613,6189107,7752103,9852103]],t.primeInt=[1012573,1101689,1183811,1196089,1230587,1355297,1419641,1483733,1572751,2275327,2770513,3010349,3073703,3118691,3174823,3511973,3959297,4514113,4690451,4823201,5133127,5375327,6019889,6054613,6189107,7752103,7752103,9852103],t.primeSeeds=d,t.factors=l.memoize((e=>{const[i,n,r,o,l,u,c,h]=d(e%a.SeedCount),p=[i/n,r/o,l/u,c/h].map((e=>s.sigFigs(e,7)));return p.push(t.primeInt[e%t.primeInt.length]),p}),{maxSize:128,ttlMs:r.minuteMs}),t.stableIndexShuffle=function(e,t=1){return n.sortBy(e,((i,n)=>c(t,n,e.length)))},t.stableContentShuffle=function(e,t=1){return n.sortBy(e,(e=>o.numericSha(String(e)+t)))}},6231:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NumericRadix=t.AlphaRadix=t.TokenRadix=t.GeoRadix=t.RadixAlphaNum=t.Radix58=t.Hex=t.Radix=t.encodeDigits=void 0;const n=i(76417),r=i(39938),s=i(66776),a=i(34601),o=i(93491),l=i(2023),u=i(91464),c=BigInt(0);function d(e,t,i=0){if(!isFinite(t)||e<=1)return[];const n=[];if(0===t)n.push(0);else for(;t>0;)n.push(t%e),t=Math.floor(t/e);for(;n.length<i;)n.push(0);return n.reverse()}t.encodeDigits=d;class h{constructor(e,t,i=l.identity){this.name=e,this.numerals=t,this.decodePreparser=i,this.base=t.length}digitsToNumerals(e){return e.map((e=>this.numerals[e])).join("")}encode(e,t=0){if(!isFinite(e))return"";const i=e<0;return i&&(e=Math.abs(e),t--),(i?"-":"")+this.digitsToNumerals(d(this.base,e,t))}encodeBigInt(e){if("bigint"!=typeof e)throw new Error("bad input");if(e===c)return this.numerals[0];const t=[],i=BigInt(this.base);let n=e;for(;n>c;)t.push(Number(n%i)),n/=i;return this.digitsToNumerals(t.reverse())}encodeBuffer(e){if(null==e||0===e.length)return"";const t=[0];for(let i of e)for(t.forEach(((e,n)=>{i+=e<<8,t[n]=i%this.base,i=Math.floor(i/this.base)}));i>0;)t.push(i%this.base),i=Math.floor(i/this.base);return this.digitsToNumerals(t.reverse())}decode(e){return s.map(this.decodeBigInt(e),(t=>{if(t>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(t)}))}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(null==e||r.blank(e))return;const t="-"===(e=a.isFunction(this.decodePreparser)?this.decodePreparser(e):e)[0];t&&(e=e.slice(1));const i=BigInt(this.base);let n=BigInt(0);for(const t of e){const e=this.numerals.indexOf(t);if(e<0)return;n=n*i+BigInt(e)}return t?BigInt(-1)*n:n}randomChars(e){return this.encodeBuffer(n.randomBytes(e+3)).slice(1,e+1)}safeRandomChars(e){return o.decuss((()=>this.randomChars(e)))}randomUid(e=20,t=5,i="-"){return u.splitEvery(this.randomChars(e),t).join(i)}safeRandomUid(e,t=5,i="-"){return o.decuss((()=>this.randomUid(e,t,i)))}tokenEql(e,t,i){const n=this.normalizeToken(e),r=this.normalizeToken(t);return n.length>=i&&n===r}normalizeToken(e){return[...this.decodePreparser(e.trim())].filter((e=>this.numerals.includes(e))).join("")}}t.Radix=h,t.Hex=new h("hex","0123456789abcdef",(e=>e.toLowerCase())),t.Radix58=new h("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.RadixAlphaNum=new h("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",(e=>e.toLowerCase())),t.GeoRadix=new h("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",(e=>e.toLowerCase())),t.TokenRadix=new h("TokenRadix","0123456789abcdefhjkmnpqrtuvwxy",(e=>e.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9"))),t.AlphaRadix=new h("AlphaRadix","abcdefghjkmnpqrtuvwxyz"),t.NumericRadix=new h("NumericRadix","0123456789",(e=>e.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9")))},69547:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rate=void 0;const n=i(31669),r=i(88491),s=i(75556),a=i(70283),o=i(55646),l=i(6667);class u{constructor(e){if(this.ttlMs=e,this._eventCount=0,this._lastEventTime=0,e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new o.TTLArray(e)}[n.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){const e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return a.mapGt0(this.eventDeltas.length,(()=>l.weightedAvg(this.eventDeltas)))}get msPerEvent(){return l.avg(this.eventDeltas)}get eventsPerMs(){return a.mapGte0f(this.msPerEvent,(e=>1/e))}get eventsPerSecond(){return a.mapGte0f(this.eventsPerMs,(e=>s.sigFigs(r.secondMs*e,3)))}get eventsPerMinute(){return a.mapGte0f(this.eventsPerMs,(e=>s.sigFigs(r.minuteMs*e,3)))}}t.Rate=u},76474:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UUIDRegExp=t.safeUUID=t.uuid=void 0;const n=i(76417),r=i(11448),s=i(93491);function a(){const e=n.randomBytes(16);e[6]=15&e[6]|64;const t=e.toString("hex");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20)].join("-")}t.uuid=a,t.safeUUID=function(){return s.decuss(a)},t.UUIDRegExp=r.lazy((()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/))},6667:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jaccard=t.cosineSimilarity=t.dot=t.l2norm=t.centroid=t.euclidean=t.avgWeighted=t.weightedAvg=t.stdDev=t.variance=t.avgMaybe=t.slope=t.normalize=t.avg=t.sum=t.mode=t.modes=t.deltas=t.max=t.min=void 0;const n=i(11944),r=i(66776),s=i(75556),a=i(39784),o=i(94383),l=i(70283),u=i(8177);function c(e){let t;for(const i of e)null!=i&&(null==t||i<t)&&(t=i);return t}function d(e){let t;for(const i of e)null!=i&&(null==t||i>t)&&(t=i);return t}function h(e,t){const i=new o.CountingSet;return a.toA(e).forEach((e=>s.mapFinite(e,(e=>i.incr(e))))),i.topKeys(t)}function p(e){return a.toA(e).reduce(((e,t)=>s.isNumber(t)?e+t:e),0)}function m(e){const t=n.compact(a.toA(e));return n.isEmpty(t)?void 0:t.reduce(((e,t,i)=>0===i?t:e*i/(i+1)+t/(i+1)),0)}function f(e){return r.map(m(e),(t=>m(e.map((e=>Math.pow(e-t,2))))))}function g(e){return Math.sqrt(e.reduce(((e,t)=>e+t*t),0))}function y(e,t){return e.reduce(((e,i,n)=>e+i*t[n]),0)}t.min=c,t.max=d,t.deltas=function(e){const t=a.toA(e);return null==e||t.length<=1?[]:t.slice(1).map(((t,i)=>t-e[i]))},t.modes=h,t.mode=function(e){return h(e,1)[0]},t.sum=p,t.avg=m,t.normalize=function({x:e,strength:t=1,normMin:i,normMax:n}){const r=c(e),s=d(e)-r,a=n-i;return e.map((e=>(1-t)*e+t*(i+a*(e-r)/s)))},t.slope=function(e){const t=a.toA(e);return r.map(m(t),(e=>{const i=(t.length-1)/2,n=p(t.map(((t,n)=>(t-e)*(n-i)))),r=p(t.map((t=>(t-e)**2)));return 0===r?0:n/r}))},t.avgMaybe=function(...e){const t=n.compact(e);return n.isEmpty(t)?void 0:p(t)/t.length},t.variance=f,t.stdDev=function(e){return r.map(f(e),(e=>Math.sqrt(e)))},t.weightedAvg=function(e){let t;for(const i of e)t=null==t?i:(t+i)/2;return null==t?NaN:t},t.avgWeighted=function(e,t){let i=0;return e.reduce(((e,n,r)=>{const s=l.mapGt0Or(t[r],(e=>e),1);return i+=s,e+n*s}),0)/i},t.euclidean=function(e,t){return Math.sqrt(a.toA(e).reduce(((e,i,n)=>e+Math.pow(i-t[n],2)),0))},t.centroid=function(e){return s.times(e[0].length,(t=>m(e.map((e=>e[t])))))},t.l2norm=g,t.dot=y,t.cosineSimilarity=function(e,t){return s.finiteOrElse(y(e,t)/(g(e)*g(t)),void 0)},t.jaccard=function(e,t){return n.isEmpty(e)&&n.isEmpty(t)?0:s.finiteOrElse(u.intersection(e,t).size/u.union(e,t).size,void 0)}},48446:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.b64diff=t.b64corr=t.uint12toB64=t.uint6toB64=t.uint8toB64=t.b64decodeSmall=t.b64hammRatio=t.gz64decodeString=t.d=t.gz64encodeString=t.b64decodeString=t.b64encodeString=t.b64decode=t.b64encode=t.hex2b64=void 0;const n=i(78761),r=i(11944),s=i(39938),a=i(66776),o=i(75556),l=i(13779),u=i(70283),c=i(6667);t.hex2b64=function(e){return Buffer.from(e,"hex").toString("base64")};const d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function h(e){if("number"==typeof e&&e<d.length)return d[e];let t=e.toString(16);return t.length%2==1&&(t="0"+t),Buffer.from(t,"hex").toString("base64")}function p(e){return BigInt("0x0"+Buffer.from(e,"base64").toString("hex"))}function m(e){return n.gunzipSync(Buffer.from(e,"base64")).toString("utf8")}function f(e){if(null==e||0===e.length)return-1;const t=[...e];let i=0;for(const n of t){const t=d.indexOf(n);if(-1===t)return-1;if(i>2**46)throw new Error("b64decodeSmall("+e+"): overflow");i=64*i+t}return i}function g(e,t=6){const i=t/6;return r.stepRange(0,e.length,i,(t=>f(e.substr(t,i))))}t.b64encode=h,t.b64decode=p,t.b64encodeString=function(e){return Buffer.from(e,"utf8").toString("base64")},t.b64decodeString=function(e){return Buffer.from(e,"base64").toString("utf8")},t.gz64encodeString=function(e){return n.gzipSync(Buffer.from(e,"utf8")).toString("base64")},t.d=m,t.gz64decodeString=m,t.b64hammRatio=function(e,t){return s.mapNotBlank(e,(e=>s.mapNotBlank(t,(t=>u.hammRatioBigInt(p(e),p(t))))))},t.b64decodeSmall=f,t.uint8toB64=function(e){return Buffer.from(Uint8ClampedArray.from(e).buffer).toString("base64")},t.uint6toB64=function(e){return e.map((e=>d[63&e])).join("")},t.uint12toB64=function(e){const t=[];return e.forEach((e=>{t.push(h(e>>6&63)),t.push(h(63&e))})),t.join("")},t.b64corr=function(e,t,i=6){if(e===t)return 1;const n=g(e,i),r=g(t,i),s=Math.pow(2,i-1);return c.cosineSimilarity(n.map((e=>e-s)),r.map((e=>e-s)))},t.b64diff=function(e,t,i=6){return e===t?0:l.zip(g(e,i),g(t,i)).reduce(((e,t)=>a.orElse(o.absdiff(t[0],t[1]),0)+e),0)}},45025:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HttpStatus=void 0;const n=i(70283);t.HttpStatus={success:e=>n.within(200,299,e),redirect:e=>n.within(300,399,e),clientError:e=>n.within(400,499,e),serverError:e=>n.within(500,599,e),error:e=>n.within(400,599,e)}},10309:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.request=void 0;const n=i(57211),r=i(39938),s=i(66776),a=i(9678),o=i(79141),l=i(70283),u=i(42041),c=i(53719);t.request=async function(e,t={}){return null==t.headers&&(t.headers={}),r.blank(t.headers["user-agent"])&&(t.headers["user-agent"]=a.AppName+" v"+u.version),new Promise(((i,r)=>{const a=n.request(e.toString(),t);a.setTimeout(s.orElse(t.timeout,c.CmdTimeoutMs),(()=>{r(new o.WrappedError({message:"Timeout fetching <"+e+">",doNotSend:!0,retriable:!0}))})),a.on("response",(e=>{const t=[];e.setEncoding("utf8"),e.on("data",(e=>t.push(e))),e.on("end",(()=>{i({ok:l.within(200,399,e.statusCode),headers:e.headers,body:t.join(""),statusCode:e.statusCode,statusMessage:e.statusMessage})}))})).on("error",(e=>{r(e)})),s.map(t.body,(e=>a.write(e))),a.end()}))}},47858:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.httping=void 0;const n=i(98605),r=i(11448),s=i(34996),a=i(7162),o=i(19209),l=i(45025),u=r.lazy((()=>a.mkLogger("httping")));t.httping=function(e,t,i,r){const a=o.URI.from({scheme:"http",authority:e+":"+t,path:i}).toString(),c=new s.Deferred("ping "+a);return c.setTimeout(r),n.get(a,{timeout:r},(e=>{u().log(l.HttpStatus.error(e.statusCode)?"warn":"debug","ping",{latencyMs:Date.now()-c.start,statusCode:e.statusCode}),e.resume(),c.resolve(e.statusCode)})).on("error",(e=>{u().warn("Failed to connect to "+a,e),c.resolve(void 0)})),c.promise}},87564:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.macs=void 0;const n=i(12087),r=i(11944),s=i(39938),a=i(11448),o=i(61570),l=i(39784),u=/^(?:[0:]+|[f:]+)$/i;t.macs=a.lazy((()=>r.uniq(r.flatten(o.values(n.networkInterfaces()).map((e=>l.toA(e).map((e=>e.mac))))).filter((e=>s.notBlank(e)&&null==u.exec(e))))))},58659:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEquivalentHost=t.nslookup=t.resolve4=t.octets=t.isLoopback=t.friendlyname=void 0;const n=i(40881),r=i(39938),s=i(88491),a=i(43947),o=i(11448),l=i(75556),u=i(82798),c=i(97503),d=i(46852),h=i(13317),p=i(79015),m=i(7162),f=i(70283),g=i(91464),y=i(53719),v=i(94517),w=new RegExp("^"+v.ipv4Re.source+"$");t.friendlyname=c.memoizeAsync((async e=>{const i=null==w.exec(e)?e:await t.nslookup(e);return u.toS(i).toLowerCase().normalize()}),{maxSize:128,timeoutMs:y.ShortCmdTimeoutMs});const b=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function S(e){return null!=b.exec(e)}function M(e){const t=e.split(".").map((e=>l.toInt(e))).filter((e=>f.within(0,255,e)));return 4===t.length?t:void 0}t.isLoopback=S,t.octets=M,t.resolve4=c.memoizeAsync((async e=>{if(!r.blank(e)){if(null!=M(e))return[e];try{return await n.promises.resolve4(e)}catch(t){return void P().warn("No name found for "+e)}}}),{maxSize:256,timeoutMs:y.ShortCmdTimeoutMs,clearEveryMs:10*s.minuteMs});const P=o.lazy((()=>m.mkLogger("nslookup")));a.later((()=>p.onClearCache((()=>t.nslookup.clear())))),t.nslookup=c.memoizeAsync((async e=>{try{const t=await h.thenOrTimeout((()=>S(e)?e.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=M(e)?n.promises.reverse(e):n.promises.resolve4(e)),5*s.secondMs);if(null==t)return P().info("nslookup("+e+"): timeout"),e;const i=t.find(r.notBlank);return null==i?(P().warn("No name found for "+e),e):i}catch(t){return P().warn("Failed to look up "+e+", using name.",t),e}}),{maxSize:256,timeoutMs:y.ShortCmdTimeoutMs,clearEveryMs:10*s.minuteMs}),t.isEquivalentHost=async function(e,i){return!r.blank(e)&&!r.blank(i)&&(!!g.equalsIgnoreCase(e,i)||!(!S(e)||!S(i))||d.thenMap2Or(t.resolve4(e),t.resolve4(i),((e,t)=>e.some((e=>t.includes(e)))),(()=>!1)))}},94517:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ipAddrFromPing=t.ipv4Re=t.ping=void 0;const n=i(39938),r=i(88491),s=i(75556),a=i(98510),o=i(82798),l=i(97503),u=i(69317),c=i(9288),d=i(99312),h=i(53719);t.ping=l.memoizeAsync((async e=>{const t=d.isWin?await c.pingWin():"ping";return u.stdout(t,[d.isWin?"-n":"-c","1",e],{timeout:5*r.secondMs})}),{maxSize:255,timeoutMs:h.ShortCmdTimeoutMs,clearEveryMs:10*r.minuteMs}),t.ipv4Re=new RegExp("\\b"+s.times(4,(()=>"[0-9]{1,3}")).join("\\.")+"\\b"),t.ipAddrFromPing=l.memoizeAsync((async e=>a.opt(await t.ping(e).catch((e=>{console.warn("failed to ping: "+e)}))).filter(n.notBlank).flatMap((e=>t.ipv4Re.exec(o.toS(e)))).map((e=>e[0])).get()),{maxSize:255,timeoutMs:h.ShortCmdTimeoutMs,clearEveryMs:10*r.minuteMs})},9211:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CPUs=t.osNameWin=t.osNameMac=t.osNameLinux=t.OS=void 0;const n=i(63129),r=i(35747),s=i(12087),a=i(39938),o=i(88491),l=i(11448),u=i(66776),c=i(13779),d=i(56533),h=i(7162),p=l.lazy((()=>h.mkLogger("os")));function m(){switch(s.platform()){case"linux":return g();case"darwin":return b();case"win32":return M();default:return f()}}function f(){return s.platform()+" "+s.release()}function g(){try{const e=r.readFileSync("/etc/os-release").toString(),t=d.parseEnvTokens({input:e,lowerCaseKeys:!0});if(a.notBlank(t.pretty_name))return t.pretty_name;const i=u.orElse(t.version,t.version_id);return u.map2Or(t.name,i,((e,t)=>e+" "+t),f)}catch(e){return p().warn("Failed to fetch /etc/os-release",e),f()}}function y(e){return e.split(".").slice(0,2).join(".")}t.OS=l.lazy((()=>[m(),"on",s.arch()].join(" "))),t.osNameLinux=g;const v={10.6:"Snow Leopard",10.7:"Lion",10.8:"Mountain Lion",10.9:"Mavericks","10.10":"Yosemite",10.11:"El Capitan",10.12:"Sierra",10.13:"High Sierra",10.14:"Mojave",10.15:"Catalina",11.1:"Big Sur"},w=l.lazy((()=>n.execSync("sw_vers -productVersion").toString().trim()));function b(e=w()){try{return a.mapNotBlankOr(function(e=w()){return v[y(e)]}(e),(t=>`macOS ${t} (${e})`),f)}catch(e){return p().warn("osNameMac(): unknown release",e),f()}}t.osNameMac=b;const S={"10.0":"10",6.3:"8.1",6.2:"8",6.1:"7","6.0":"Vista",5.2:"Server 2003",5.1:"XP","5.0":"2000",4.9:"ME",4.1:"98","4.0":"95"};function M(e=s.release()){const t=S[y(e)];return null!=t?`Windows ${t} (${e})`:(p().warn("osNameWin(): unknown release: "+e),`Windows (${e})`)}t.osNameWin=M,t.CPUs=l.lazy((()=>c.uniqCount(s.cpus().map((e=>e.model))).map((e=>`${e.count} Ã ${e.t}`)).join(", ")),o.minuteMs)},71663:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkPowerShell=t.PowerShell=t.pwshQuote=void 0;const n=i(17324),r=i(39938),s=i(88491),a=i(43947),o=i(11448),l=i(66776),u=i(36079),c=i(46852),d=i(13317),h=i(21142),p=i(13056),m=i(69317),f=i(70403),g=i(79015),y=i(85296),v=i(7162),w=i(19658),b=i(99312),S=i(43414),M=i(91464),P=i(53719),E=i(59387),T=10*s.minuteMs,x=" | ConvertTo-Json -Compress";t.pwshQuote=function(e){return'"'+e.replace(/['`"ââ#]/g,(e=>"`"+e)).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v")+'"'},a.later((()=>g.onClearCache((()=>{var e;return null===(e=D.instance.prior())||void 0===e?void 0:e.clearMockResults()}))));class D{constructor(){this.name="PowerShell",this.logger=v.mkLogger("PowerShell"),this.mockResults=new Map,this.bco=new p.BatchClusterObserver("PowerShell",new n.BatchCluster({processFactory:()=>m.execFile("powershell",S.Settings.powerShellArgs.values,T),logger:()=>v.mkLogger("PowerShell"),versionCommand:['function prompt {"{ready}"}',...r.mapNotBlankOr(S.Settings.powerShellCulture.valueOrDefault,(e=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${e}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${e}'`]),[])].join(";"),pass:"{ready}",fail:"Error",exitCommand:"exit",maxProcs:E.maxCpus()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:P.CmdTimeoutMs,cleanupChildProcs:!1}),u.EndableRanks.postdb),this.pwsh=this.bco.t}get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return c.thenMap(this.executeJson("$PSVersionTable.PSVersion"),(e=>`${e.Major}.${e.Minor}.${e.Build}`))}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,t){this.pushMockResult(M.ensureSuffix(e,x),t)}pushMockResult(e,t){this.mockResults.set(e,t)}clearMockResults(){this.mockResults.clear()}async execute(e,t){if(this.pwsh.ended||u.ending())this.logger.warn("execute() failed (ended)",{cmd:e});else{if(w.isTest&&this.mockResults.has(e)){const i=this.mockResults.get(e);return t(i.stdout,i.stderr,i.passed)}try{this.logger.debug("execute()",{cmd:e});const i=await f.elapsedAsync((()=>this.pwsh.enqueueTask(new n.Task(e,((i,n,r)=>t(l.map(i,(t=>M.stripPrefix(t,e))),n,r))))));return this.logger.log(y.ms2level(i.elapsedMs,7*s.secondMs),"execute()",{cmd:e,elapsedMs:i.elapsedMs}),i.result}catch(t){return void this.logger.warn("execute() failed: "+t,{cmd:e})}}}async executeJson(e){const t=await this.execute(M.ensureSuffix(e,x),((e,t,i)=>({stdout:e,stderr:t,passed:i})));if(null!=t)if(r.blank(t.stdout)||r.notBlank(t.stderr)||!t.passed)this.logger.warn("executeJson(): failed result",{cmd:e,...t});else try{return JSON.parse(t.stdout)}catch(e){const i=t.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:M.ellipsize(t.stdout),after:M.ellipsize(i)}),JSON.parse(i)}else this.logger.warn("executeJson(): null result",{cmd:e})}async executeJsonToA(e){return c.thenMap(this.executeJson(e),(e=>Array.isArray(e)?e:[e]))}}t.PowerShell=D,D.instance=o.lazy((()=>{if(!b.isWin)throw new Error("PowerShell isn't available on this platform");return new D})),t.checkPowerShell=async function(){if(!b.isWin)return;const e=D.instance();if(!e.ended&&!u.ending()&&null==await d.thenOrTimeout((()=>e.version()),7*s.secondMs)){const t=await h.until((()=>l.orElse(e.lastStartError,e.lastTaskError)),{timeoutMs:P.ShortCmdTimeoutMs,timeBetweenMs:250});throw null!=t?t:new Error("(unknown error)")}}},53370:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.broadcast=t.setBroadcasterIfUnset=t.setBroadcaster=void 0;const n=i(69604);let r=n.NoOpBroadcaster;t.setBroadcaster=function(e){r=e},t.setBroadcasterIfUnset=function(e){r===n.NoOpBroadcaster&&(r=e)},t.broadcast=function(e,t){r.broadcast(e,t)}},60326:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;const n=i(61765),r=i(39938),s=i(88491),a=i(87748),o=i(11448),l=i(66776),u=i(75556),c=i(36079),d=i(95557),h=i(46852),p=i(7383),m=i(49379),f=i(79015),g=i(45512),y=i(83837),v=i(69547),w=i(19658),b=i(55568),S=i(37086),M=i(70529),P={requestTTL:(w.isTest?7:30)*s.secondMs,retriesPerRequest:5,delayBetweenRetries:w.isTest?500:5*s.secondMs,maxPendingRequests:10};let E=0;class T extends d.EndableWrapper{constructor(e,t,i={}){super("rpc.Client("+e+"#"+E+++")",(()=>this.onEnd()),c.EndableRanks.first),this.streamFactory=t,this.mkStreamRate=new v.Rate(s.minuteMs),this.pending=new Map,this.times=new p.PromiseTimer,this.changeListeners=[()=>this.mkStreamRate.onEvent()],this.stream=o.lazy((async()=>{try{if(this.flapping)return this.onError("stream() is restarting too frequently (epm: "+this.mkStreamRate.eventsPerMinute+")");const e=await this.streamFactory();return null==e?this.onError("streamFactory() returned null"):(this.changeListeners.forEach((e=>e())),e.on("end",(e=>this.onFinish("on(end)",e))),e.on("close",(e=>this.onFinish("on(close)",e))),e.on("error",(e=>this.onError("stream error",e))),g.onDataChunked(e,"\n",(e=>this.onData(e))),e)}catch(e){return this.onError("streamFactory rejection",e)}})),this.ping=o.lazy((()=>this.request("ping",{serviceName:b.serviceName(),pid:n.pid})),250),this.opts={...P,...i},this.stream()}onEnd(){return this.logger.info("end()",{ending:c.ending(),timings:this.times.report(),pendingSize:this.pending.size}),this.pending.clear(),this.close()}addChangeListener(e){this.changeListeners.push(e)}get flapping(){return this.logger.tap({level:w.isTest?"debug":"trace",msg:"flapping()",result:this.mkStreamRate.msSinceLastEvent<this.opts.delayBetweenRetries||u.gt(this.mkStreamRate.eventsPerMinute,3),meta:{msSinceLastStream:this.mkStreamRate.msSinceLastEvent,mkStreamRatePerMin:this.mkStreamRate.eventsPerMinute}})}broadcast(e,t){return this.request("broadcast",{event:e,args:t})}sendRecentLogs(){return this.request("sendRecentLogs")}async ready(){return this.ended?(this.logger.debug("ready(): false (ended)"),!1):null!=await this.stream()}async request(e,t){if(this.ended){if(c.ending())return;throw new Error("client is ending")}if(r.blank(e))throw new Error("method cannot be blank");return this.submit(e,t)}async submit(e,t){const i=await this.stream();if(null==i)return this.onError("submit("+e+"): stream is closed");const n=S.uid(),r=new M.RequestResponse(n,e,t,this.times);return r.setTimeout(this.opts.requestTTL),this.pending.set(n,r),r.d.finally((()=>this.pending.delete(n))),this.logger.log(w.isTest?"debug":"trace","sending request",{id:n,method:e,params:t}),i.write(a.stringify({id:n,method:e,params:t})+"\n"),r.response}close(){return this.logger.info("close()",{ended:this.ended}),h.thenMap(this.stream.clear(),y.endStream)}onData(e){if(!r.blank(e))try{this.logger.log(w.isTest?"debug":"trace","onData()",{req:e});const t=JSON.parse(e);if(r.blank(t.sid))throw new Error("response is missing server id");if(this.sid!==t.sid&&(null!=this.sid&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:t.sid}),f.eventEmitter.emit("rpcServerChange")),this.sid=t.sid,c.ending()))return;if(null==t.id){if(r.notBlank(t.event))return this.logger.trace("re-broadcasting event",t),void f.eventEmitter.emit(t.event,t.args);throw new Error("missing request id from response")}const i=this.pending.get(t.id);this.pending.delete(t.id),null==i?this.logger.warn("unknown or stale request ID",{resp:t,pendingIds:[...this.pending.keys()]}):null!=t.error?(i.reject(t.error),this.logger.warn("Rejected",{resp:t,rr:i})):(i.resolve(t.result),this.logger.debug("Resolved",t.result))}catch(t){this.logger.warn("invalid input: "+e,t)}}async onError(e,t){return this.logger.warn(e+" onError(): "+l.map(t,(e=>l.orElse(e.stack,e)))),this.restart()}async restart(){if(this.logger.info("restart()",{ended:this.ended,flapping:this.flapping}),await this.close(),this.ended||c.ending())return void this.logger.warn("restart(): Ending. Rejecting new connection.");if(this.flapping)return void this.logger.warn("restart(): Too many recent errors, we'll try reconnecting again in a bit",{errPerMin:this.mkStreamRate.eventsPerMinute});const e=await this.stream();if(null!=e){const t=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+t.length+" jobs now."),t.forEach((e=>e.reject("restarting"+m.RetriableErrorFlag))),e}this.logger.warn("restart(): stream() returned null")}onFinish(e,t){if(this.ended)return;const i=null==t||!1===t;return this.logger.info("onFinish",{source:e,error:t,restarting:i}),i?this.restart():this.onError(e,t)}}t.Client=T},69604:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpBroadcaster=void 0;const n=i(11448),r=i(7162),s=n.lazy((()=>r.mkLogger("Broadcaster")));var a;!function(e){e.broadcast=async(e,t)=>(s().warn("broadcast sent to no-op",{event:e,args:t}),!1)}(a||(a={})),t.NoOpBroadcaster=a},70529:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestResponse=void 0;const n=i(31669),r=i(66776),s=i(34996);class a{constructor(e,t,i,n){this.id=e,this.method=t,this.params=i,this.timer=n,this.start=Date.now(),this.name="rpc.RequestResponse("+t+")#"+e,this.d=new s.Deferred(this.name)}[n.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),r.map(this.d.settledMs,(e=>this.timer.push(this.method,e))))}reject(e){return this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}}t.RequestResponse=a},97024:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Server=t.ClientConnection=void 0;const n=i(11631),r=i(61765),s=i(11944),a=i(39938),o=i(88491),l=i(87748),u=i(6314),c=i(11448),d=i(66776),h=i(61570),p=i(26719),m=i(82798),f=i(36079),g=i(7383),y=i(21142),v=i(70403),w=i(10408),b=i(49379),S=i(79015),M=i(45512),P=i(83837),E=i(85296),T=i(7162),x=i(6231),D=i(70283),C=i(55568),k=i(43414),I=i(53370),F=T.mkLogger("rpc.Server"),O=({params:e,conn:t})=>(a.mapNotBlank(e.serviceName,(e=>{a.blank(t.serviceName)&&(t.serviceName=e)})),D.mapGt0(e.pid,(e=>{a.blank(t.pid)&&(t.pid=e)})),`pong to ${t.serviceName}@${t.pid} from ${C.serviceName()}@${r.pid} at ${new Date}`);class A{constructor(e){this.socket=e}toString(){return a.blank(this.serviceName)?P.remoteDesc(this.socket):`${this.serviceName}:${this.pid}`}}t.ClientConnection=A,t.Server=class{constructor(e,t=!0){this.port=e,this.unref=t,this._ended=!1,this._ready=new u.Latch,this.connections=[],this.onPause=()=>this.broadcast("pause"),this.onResume=()=>this.broadcast("resume"),this.handlers=new Map,this.sid=c.lazy((()=>x.Radix58.randomChars(12))),this.start=p.throttle((async()=>{if(!this.ended)return F.debug("start("+this.port+")"),this.server=n.createServer(this.onConnect.bind(this)),this.server.on("listening",(()=>{F.info("listening on "+this.port),this._ready.resolve()})),this.server.on("error",(async e=>{F.warn("error, rejecting ready"),this._ready.reject(),await this.onError("createServer"+b.FatalErrorFlag,e)})),this.server.listen(this.port,k.Settings.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise}),5e3),this.end=c.lazy((async()=>{this._ended=!0,S.eventEmitter.removeListener("pause",this.onPause),S.eventEmitter.removeListener("resume",this.onResume),await this.closeAllConnections(),await P.closeStream(this.server)})),this.name="Server:"+e,this.addHandler("ping",O),this.addSimpleHandler("broadcast",(e=>(S.eventEmitter.emit(e.event,e.args),this.broadcast(e.event,e.args)))),S.onPause(this.onPause),S.onResume(this.onResume),f.addFirstEndable(this),I.setBroadcaster(this)}get connectionCount(){return this.connections.length}async serialize(e){return l.stringify({sid:this.sid(),...e})+"\n"}addHandler(e,t){const i=this.handlers.get(e);null!=i&&F.warn("addHandler(): overwriting",{method:e,prior:i,newHandler:t}),this.handlers.set(e,t)}addSimpleHandler(e,t){this.addHandler(e,(({params:e})=>t(e)))}addSimpleHandlers(e){h.entries(e).forEach((([e,t])=>this.addSimpleHandler(e,t)))}get ended(){return this._ended||f.ending()}get ready(){return this._ready.promise}closeAllConnections(){const e=this.connections.map((e=>P.endStream(e.socket)));return this.connections.length=0,Promise.all(e)}broadcast(e,t){return this.sendAll({event:e,args:t})}async sendAll(e,t="write"){const i=await this.serialize(e),n=[...this.connections];let r=n.length;F.debug("sendAll()",{pojo:e,method:t});for(const e of n)try{e.socket.writableEnded?r--:e.socket[t](i,(()=>r--))}catch{r--}return y.untilTrue((()=>r<=0),{timeoutMs:o.secondMs})}onConnect(e){F.info("Connection from "+P.remoteDesc(e)),this.unref&&e.unref();const t=new A(e);this.connections.push(t),e.on("end",(()=>{F.info("Closing connection from "+P.remoteDesc(e)),s.filterInPlace(this.connections,(t=>t.socket!==e))})),e.on("error",(async t=>{F.warn("on error from "+P.remoteDesc(e)+": "+t),await this.onError("socket",t),e.end()}));try{M.onDataChunked(e,"\n",(e=>this.onRequest(e,t)))}catch(t){F.warn("Caught error from "+P.remoteDesc(e)+": "+t),e.end()}}async onRequest(e,t){if(F.debug("onRequest()",e),a.blank(e))return;let i="missing",n="missing";try{const r=JSON.parse(e);return a.mapNotBlank(r.id,(e=>i=e)),a.mapNotBlank(r.method,(e=>n=e)),await g.time("rpc."+n,(()=>this.handle(i,n,r.params,t)))}catch(n){F.warn("invalid request",{line:e,error:n}),t.socket.write(await this.serialize({id:i,error:d.orElse(n.message,(()=>m.toS(n)))}))}}async handle(e,t,i,n){const r=this.handlers.get(t);if(null==r)throw F.warn("bad handler request",{method:t,params:i,supported:h.keys(this.handlers)}),new Error("No handler for "+t);const{elapsedMs:s,result:a}=await v.elapsedAsync((()=>r({id:e,method:t,params:i,conn:n})));F.log(E.ms2level(s,o.secondMs),"handle()",{method:t,conn:m.toS(n),elapsedMs:s,id:e,params:i,result:a}),n.socket.write(await this.serialize({id:e,result:a}))}async onError(e,t){this.ended||w.onError(e,t)}}},71395:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupLibraryDataDir=t.libraryPreviewsDir=t.setupLibraryOriginalsDir=t.libraryOriginalsDir=t.libraryDataDir=void 0;const n=i(39938),r=i(98250),s=i(42041),a=i(43414),o=`\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n\nMoving or deleting any files here will cause problems using your library.\n\nIf you have any questions, please visit <https://photostructure.com/support/>.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v${s.version}`;function l(e=a.Settings.libraryPath.value){return n.mapNotBlank(e,(e=>r.PosixFile.for(e).join(".photostructure")))}function u(e=a.Settings.libraryPath.value){return n.mapNotBlank(e,(e=>r.PosixFile.for(e).join(a.Settings.originalsDir.valueOrDefault)))}t.libraryDataDir=l,t.libraryOriginalsDir=u,t.setupLibraryOriginalsDir=function(e=a.Settings.libraryPath.value){var t;return null===(t=u(e))||void 0===t?void 0:t.mkdirp()},t.libraryPreviewsDir=function(e=a.Settings.libraryPath.value){return n.mapNotBlank(e,(e=>r.PosixFile.for(e).join(a.Settings.previewsDir.valueOrDefault)))},t.setupLibraryDataDir=async function(e){const t=l(e);if(null==t)throw new Error("empty dataDir");if(null==await t.mkdirp())throw new Error("Could not mkdirp "+t);await t.mkNoMedia();const i=t.join("README.txt");return await i.size()!==o.length&&await i.writeTxt_(o),t}},84161:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BooleanSetting=t.BoundedFloatSetting=t.BoundedIntegerSetting=t.FloatSetting=t.MaybeIntegerSetting=t.IntegerSetting=t.StringEnumsSetting=t.StringArraySetting=t.splitStringArray=t.StringEnumSetting=t.StringSetting=t.MaybeStringSetting=t.Setting=t.SystemCategories=t.LibraryCategories=t.SettingCategories=t.envAtStartup=t.envkey=void 0;const n=i(85622),r=i(61765),s=i(11944),a=i(39938),o=i(38625),l=i(87748),u=i(66776),c=i(75556),d=i(98510),h=i(84253),p=i(90957),m=i(39784),f=i(82798),g=i(84593),y=i(19658),v=i(63774);function w(e){return"PS_"+v.camel2snake(e).toUpperCase()}t.envkey=w,t.envAtStartup=d.opt({...r.env}).map((e=>y.isProd?Object.freeze(e):e)).get(),t.SettingCategories=h.strEnum("Paths","Logging","Networking","Processes","Tools","Updates","Desktops","Volumes","Db","HealthChecks","Filters","Previews","Reporting","Deduping","Sidecars","Sync","Parsing","Tagging","Web","Subscriptions"),t.LibraryCategories=Object.freeze([t.SettingCategories.Db,t.SettingCategories.HealthChecks,t.SettingCategories.Filters,t.SettingCategories.Previews,t.SettingCategories.Reporting,t.SettingCategories.Deduping,t.SettingCategories.Sidecars,t.SettingCategories.Sync,t.SettingCategories.Parsing,t.SettingCategories.Tagging,t.SettingCategories.Web,t.SettingCategories.Subscriptions]),t.SystemCategories=Object.freeze(t.SettingCategories.values.filter((e=>!t.LibraryCategories.includes(e))));const b=e=>a.notBlank(e)&&"undefined"!==e?f.toS(e).trim():void 0;class S{constructor(e){this.opts=e,this._persist=!1,this.listeners=[]}hasValue(){return null!=this._value}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){const t=u.orElse(e,r.env);for(const e of[this.key,...m.toA(this.opts.envAliases)]){const i=u.map(t[e],(e=>this.opts.fromEnv(e)));if(null!=i)return i}}importFromEnv(e=r.env){if(!this._persist)return u.map(this.readFromEnv(e),(e=>this.setValue(e)))}importFromFile(e){if(!this.hasValue()||this._persist)return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate((()=>e(this.value)))}removeListener(e){s.filterInPlace(this.listeners,(t=>t===e))}onChange(){const e=this.value;this.listeners.forEach((t=>t(e)))}get name(){return this._name}_setName(e){if(null!=this._name)throw new Error("cannot set name twice");this._name=e,this._key=w(e),this.importFromEnv()}get persist(){return this._persist}get key(){return this._key}get category(){return this.opts.category}get categoryType(){return t.LibraryCategories.includes(this.category)?"library":"system"}get transient(){return!0===this.opts.transient}get advanced(){return u.mapOr(this.opts.advanced,(e=>e()),(()=>!0))}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}maybeSetValue(e){null!=e&&(this.value=e)}set valueAndEnv(e){this.value=e,this.addToEnv(r.env,e)}get envValueOrDefault(){return this.opts.toEnv(this.valueOrDefault)}set tmpValue(e){this._persist=!1,this.addToEnv(r.env,e),this.setValue(e)}set tmpValueIfUnset(e){this.isUnset()&&(this.tmpValue=e)}setValue(e){const t=this._value,i=this.opts.toEnv(e),n=this.opts.fromEnv(i);return this._value=n,g.eql(t,this._value)||this.onChange(),this._value}get defaultValue(){return p.tot(this.opts.defaultValue)}get exampleValue(){return d.opt(this.opts.exampleValue).flatMap((e=>e())).filter(a.notBlank).getOrElse((()=>this.defaultValue))}get valueOrDefault(){return null!=this.value?this.value:this.defaultValue}maybeAddToEnv(e,t){const i=u.orElse(e,r.env);return this.hasValue()&&(i[this.key]=b(this.opts.toEnv(u.orElse(t,this.valueOrDefault)))),i}addToEnv(e,t){const i=u.orElse(e,r.env);return i[this.key]=b(this.opts.toEnv(u.orElse(t,this.valueOrDefault))),i}deleteFromEnv(e){const t=u.orElse(e,r.env);return delete t[this.key],u.map(this.opts.envAliases,(e=>e.forEach((e=>{delete t[e]})))),t}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),this}addToJSON(){return{}}toJSON(){return{key:this.key,value:this.value,defaultValue:this.opts.defaultValue}}}function M(e){return null==e?void 0:e.trim()}function P(e,t){const i=f.toS(e).toLowerCase();return t.find((e=>e.toLowerCase()===i))}function E(e){return a.blankish(e)?void 0:s.mapNotEmpty(function(e){return a.mapNotBlank(f.toS(e).trim(),(e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return s.flatten(JSON.parse(e)).map(f.toS)}catch{}for(const t of["Â¦",n.delimiter])if(e.includes(t))return e.split(t);return[e]}))}(e),x)}function T(e){return s.mapNotEmpty(x(e),l.stringify)}function x(e){return s.uniq(s.compactBlankish(e))}function D(e,t){if(null==e)return;const i=[];for(const n of e){const e=P(n,t);null!=e&&i.push(e)}return i}t.Setting=S,t.MaybeStringSetting=class extends S{constructor(e){super({toEnv:b,fromEnv:b,defaultValue:void 0,...e})}hasValue(){return a.notBlank(this.value)}},t.StringSetting=class extends S{constructor(e){super({toEnv:M,fromEnv:M,...e})}hasValue(){return a.notBlank(this.value)}},t.StringEnumSetting=class extends S{constructor(e){if(super({toEnv:t=>P(t,e.validValues),fromEnv:t=>P(t,e.validValues),...e}),this.validValues=e.validValues,null!=this.defaultValue&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}},t.splitStringArray=E,t.StringArraySetting=class extends S{constructor(e){super({defaultValue:[],fromEnv:E,toEnv:T,...e})}push(...e){this.value=x([...this.valueOrDefault,...e])}get values(){return x(this.valueOrDefault)}set values(e){this.value=x(e)}removeValueFromEnv(e){u.map(this.value,(t=>this.tmpValue=t.filter((t=>t!==e))))}},t.StringEnumsSetting=class extends S{constructor(e){super({fromEnv:t=>{return i=t,n=e.validValues,D(E(i),n);var i,n},toEnv:e=>u.map(e,(e=>l.stringify(s.uniq(e)))),...e}),this.validValues=e.validValues}asValidValues(e){return D(e,this.validValues)}addToJSON(){return{validValues:this.validValues}}},t.IntegerSetting=class extends S{constructor(e){super({...e,toEnv:b,fromEnv:c.toInt})}},t.MaybeIntegerSetting=class extends S{constructor(e){super({...e,toEnv:b,fromEnv:c.toInt,defaultValue:void 0})}},t.FloatSetting=class extends S{constructor(e){super({...e,toEnv:b,fromEnv:c.toFloat})}},t.BoundedIntegerSetting=class extends S{constructor(e){super({...e,toEnv:b,fromEnv:t=>d.opt(t).flatMap(parseInt).map((t=>c.clamp(e.min,e.max,t))).get()}),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},t.BoundedFloatSetting=class extends S{constructor(e){super({...e,toEnv:b,fromEnv:t=>d.opt(t).flatMap(parseFloat).map((t=>c.clamp(e.min,e.max,t))).get()}),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},t.BooleanSetting=class extends S{constructor(e){super({...e,toEnv:b,fromEnv:o.toBoolean})}}},43414:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.persistedLibrarySettings=t.persistedSystemSettings=t.persistedSettings=t.pathWithDefaults=t.withDefaultPaths=t.SuggestedDirsEnvKey=t.Settings=t.DefaultPaths=t.isProd=void 0;const n=i(12087),r=i(85622),s=i(11944),a=i(39938),o=i(88491),l=i(97042),u=i(11448),c=i(61570),d=i(17078),h=i(42536),p=i(7799),m=i(17525),f=i(19658),g=i(32330),y=i(58517),v=i(99312),w=i(86725),b=i(82590),S=i(98788),M=i(48262),P=i(84161),E=i(61765),T=Object.freeze(["/usr/local/sbin","/usr/local/bin","/usr/lib/libraw","/opt/local/sbin","/opt/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]);t.isProd=u.lazy((()=>f.isProd));const x=()=>!t.isProd();t.DefaultPaths=Object.freeze(v.isWin?[...a.mapNotBlankOr(E.env.SYSTEMROOT,(e=>[e,r.join(E.env.SYSTEMROOT,"System32"),r.join(E.env.SYSTEMROOT,"System32","webm")]),(()=>[])),"C:\\cygwin64\\bin"]:T),t.Settings={copyAssetsToLibrary:new P.BooleanSetting({category:P.SettingCategories.Paths,description:'Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page\'s "May PhotoStructure organize your photos and videos?" section. Read more about this setting here: <https://photostructure.com/getting-started/automatic-library-organization/>.',defaultValue:!0,advanced:()=>!1}),libraryPath:new P.MaybeStringSetting({envAliases:["PS_LIBRARY","PS_LIBRARY_DIR"],category:P.SettingCategories.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>x()?"/home/test/Pictures":v.isDocker()?"/ps/library":y.defaultPicturesDir(),defaultValue:()=>v.isDocker()&&!x()?"/ps/library":void 0,advanced:()=>!1}),previewsDir:new P.StringSetting({category:P.SettingCategories.Paths,description:'This is the directory that PhotoStructure uses to store preview images. This defaults to the ".photostructure/previews" directory inside your PhotoStructure library. Absolute paths here are supported, but if you keep your library and previews directory separated, take care when you open your library on different computers, as this setting needs to be adjusted for those computers as well.\nNOTE: "originalDirs" is recommended instead of this setting; If you get "previewsDir" wrong, your library won\'t work. If you get "originalsDir" wrong, you just break full-screen zoom and non-transcoded videos.',defaultValue:()=>".photostructure/previews"}),originalsDir:new P.StringSetting({category:P.SettingCategories.Paths,description:'This is the directory that PhotoStructure uses to store original images when "copyAssetsToLibrary" is enabled. Absolute paths are supported. Relative paths are evaluated from your libraryPath. This setting defaults to ".", which is the same as your PhotoStructure library directory.\nIf you open your PhotoStructure library on a different computer, and that computer doesn\'t have access to your originals volume, full-screen zoom won\'t work, and non-transcoded videos will not play.\nThis system setting needs to be set appropriately on different computers (it won\'t be set automatically!)\nIf you have a large library and want to use an SSD, we recommend you set your libraryPath to your SSD, and use this setting to store your originals on a larger volume, rather than using the "previewsDir" setting.',defaultValue:()=>"."}),scanAllDrives:new P.BooleanSetting({category:P.SettingCategories.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new P.BooleanSetting({category:P.SettingCategories.Paths,description:"Deprecated, and will be removed in the next version. If set, PhotoStructure will automatically add your pictures directory to your `scanPaths` setting.",defaultValue:!1,advanced:()=>!1}),scanPaths:new P.StringArraySetting({category:P.SettingCategories.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1,exampleValue:()=>x()?["/path/one","/path/two"]:[y.defaultPicturesDir()]}),cacheDir:new P.StringSetting({category:P.SettingCategories.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free. Note that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory.",exampleValue:()=>x()?"/tmp/ps_cache_dir":h.defaultCacheDir(),defaultValue:()=>h.defaultCacheDir()}),neverIgnored:new P.StringArraySetting({category:P.SettingCategories.Paths,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),pidfile:new P.MaybeStringSetting({envAliases:["PIDFILE"],category:P.SettingCategories.Paths,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),scanLibraryFirst:new P.BooleanSetting({category:P.SettingCategories.Paths,description:"Should PhotoStructure scan your library before all other paths are synchronized?",defaultValue:!1}),scanLibraryLast:new P.BooleanSetting({category:P.SettingCategories.Paths,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!0}),logLevel:new P.StringSetting({envAliases:["PS_LOG","LOG"],category:P.SettingCategories.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc').",defaultValue:()=>t.isProd()?"error":"info"}),logDir:new P.StringSetting({category:P.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>m.defaultLogDir(),exampleValue:()=>x()?"/var/log/photostructure":void 0}),logCompression:new P.BooleanSetting({category:P.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>t.isProd()}),logElapsedMs:new P.BooleanSetting({category:P.SettingCategories.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new P.BooleanSetting({category:P.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new P.MaybeStringSetting({category:P.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new P.BooleanSetting({envAliases:["LOG_STDOUT","PS_STDOUT"],category:P.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new P.BooleanSetting({category:P.SettingCategories.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new P.BooleanSetting({category:P.SettingCategories.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR is set, this defaults to false. See <https://no-color.org/>.",defaultValue:()=>a.blank(E.env.NO_COLOR)}),logSql:new P.BooleanSetting({category:P.SettingCategories.Logging,description:"Log SQL queries to the default log level. *This is really chatty* and impacts performance. Normally these log messages are completely disabled.",defaultValue:()=>!1}),localhost:new P.StringSetting({category:P.SettingCategories.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). See <https://letsencrypt.org/docs/certificates-for-localhost/> and <https://photostructure.com/faq/troubleshooting/#windows-firewall-issues>.',defaultValue:()=>"127.0.0.1"}),httpPort:new P.IntegerSetting({category:P.SettingCategories.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),trustProxy:new P.StringSetting({category:P.SettingCategories.Networking,description:'Support for PhotoStructure instances running behind a reverse proxy. See <http://expressjs.com/en/guide/behind-proxies.html>. This setting should either be "false" (don\'t trust any proxies), "loopback", (only trust localhost), a single subnet (like "127.0.0.0/8"), or a comma-delimited set of subnets.',defaultValue:"false"}),exposeNetworkWithoutAuth:new P.BooleanSetting({category:P.SettingCategories.Networking,description:"Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n**Don't enable this unless you know what you are doing**.",defaultValue:()=>v.isDocker()&&!x()}),rpcPort:new P.IntegerSetting({category:P.SettingCategories.Networking,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),exiftoolProcsPerChild:new P.BoundedIntegerSetting({category:P.SettingCategories.Processes,description:"Each PhotoStructure process spins up an ExifTool when needed. Note that the `web`, `sync`, and `sync-file` services all use exiftool, so the total number of exiftool processes can be many times larger than this value.",min:1,max:8,defaultValue:2}),sensitiveEnvRegExp:new P.StringSetting({category:P.SettingCategories.Processes,description:'PhotoStructure spawns a number of processes (including "exiftool" and "ffmpeg"), and passes through environment variables, mostly to ensure locale and TZ settings are correct. To prevent environment values that contain sensitive information, like API access tokens, from either being logged, or being accessed by external tools, all environment variables whose key matches this setting will be removed. This regex is applied case-insensitively.',defaultValue:"key|secret|pass|_user|aws_"}),bounceMinutes:new P.IntegerSetting({category:P.SettingCategories.Processes,description:"PhotoStructure will bounce the web and sync processes periodically. Set to 0 to disable.",defaultValue:60*(x()?5:v.isMac?2:5)}),setupTimeoutMs:new P.IntegerSetting({category:P.SettingCategories.Processes,description:"To prevent unhealthy services running as zombies, they self-terminate if the setup processes are not complete within this amount of time. Note that only the environment variable value is used for this setting.",defaultValue:35*o.secondMs}),probationMs:new P.IntegerSetting({category:P.SettingCategories.Processes,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*o.minuteMs}),minTimeBetweenServiceRestartsMs:new P.IntegerSetting({category:P.SettingCategories.Processes,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*o.secondMs}),fatalErrorRatePerMinute:new P.IntegerSetting({category:P.SettingCategories.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),minDiskFreeGb:new P.IntegerSetting({category:P.SettingCategories.Processes,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new P.BoundedIntegerSetting({category:P.SettingCategories.Processes,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new P.StringEnumSetting({category:P.SettingCategories.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>w.PriorityClasses.BelowNormal,validValues:w.PriorityClasses.values}),maxMemoryMb:new P.BoundedIntegerSetting({category:P.SettingCategories.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.",defaultValue:500,min:256,max:8e3}),maxRssMemoryMb:new P.BoundedIntegerSetting({category:P.SettingCategories.Processes,description:"PhotoStructure will restart services if their' resident set size consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:250,max:8e3}),maxTasksPerProcess:new P.BoundedIntegerSetting({category:P.SettingCategories.Processes,description:"PhotoStructure will recycle sync-file processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>x()?10:200,min:1,max:5e3}),pollIntervalMs:new P.IntegerSetting({category:P.SettingCategories.Processes,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>t.isProd()?o.minuteMs:5*o.secondMs}),inspect:new P.BooleanSetting({category:P.SettingCategories.Processes,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,transient:!0,advanced:()=>!0}),ignoreUnhealthyVolumes:new P.BooleanSetting({category:P.SettingCategories.Volumes,description:"When true, PhotoStructure ignores volumes that are not healthy (due to needing filesystem checks, or remote filesystems that are not available).",defaultValue:!0}),validateMountpoints:new P.BooleanSetting({category:P.SettingCategories.Volumes,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist.",defaultValue:!0}),readVolumeUuidFiles:new P.BooleanSetting({category:P.SettingCategories.Volumes,description:'When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume UUID, which can help with cross-host library portability. Set this to false if you don\'t want PhotoStructure to read these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.',defaultValue:!0}),writeVolumeUuidFiles:new P.BooleanSetting({category:P.SettingCategories.Volumes,description:'When true, PhotoStructure (tries to) write ".uuid" files into the root directory of volumes, which enables cross-host library portability. Set this to false if you don\'t want PhotoStructure to try to write these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.',defaultValue:!0}),forceLocalDbReplica:new P.BooleanSetting({category:P.SettingCategories.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:()=>!x()&&v.isDocker()}),dbBackupsCount:new P.IntegerSetting({category:P.SettingCategories.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",defaultValue:20}),maxBusyDbMs:new P.IntegerSetting({category:P.SettingCategories.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 2 minutes, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>2*o.minuteMs}),dbTimeoutMs:new P.IntegerSetting({category:P.SettingCategories.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",defaultValue:()=>o.secondMs}),dbBackupIntervalMinutes:new P.BoundedFloatSetting({category:P.SettingCategories.Db,description:"How many minutes should elapse between backing of your library database? Note that PhotoStructure vacuums and optimizes the database before a backup is taken. You want this period to be frequent enough such that data loss isn't too painful. Note that backups can cause the webserver to be momentarily unresponsive. Default is every hour.",min:x()?.5:1,max:720,defaultValue:()=>x()?.5:30}),dbCacheSizeMb:new P.IntegerSetting({category:P.SettingCategories.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:192}),dbBatchSelectSize:new P.BoundedIntegerSetting({category:P.SettingCategories.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",defaultValue:128,min:1,max:900}),dbBatchUpsertSize:new P.BoundedIntegerSetting({category:P.SettingCategories.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",defaultValue:16,min:1,max:500}),forceOpen:new P.BooleanSetting({category:P.SettingCategories.HealthChecks,description:"DANGEROUS: if set, all previously-existing library locks will be removed. This should only be necessary if the prior PhotoStructure process was not shut down gracefully.",defaultValue:!1,transient:!0}),skipLibraryOpenLocks:new P.BooleanSetting({category:P.SettingCategories.HealthChecks,description:"DANGEROUS: if set, PhotoStructure will not do any library opened-by locking, which could result in concurrent library writes, which can cause database corruption. If only one system will open this library concurrently, it's OK to set this to true.",defaultValue:!1}),healthCheckExiftool:new P.BooleanSetting({category:P.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies ExifTool is available and a valid version.",defaultValue:!0}),healthCheckLibraryIsWritable:new P.BooleanSetting({category:P.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies the library directory exists, and is writable.",defaultValue:!0}),healthCheckVolumes:new P.BooleanSetting({category:P.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies volumes as part of periodic health checks.",defaultValue:!0}),healthCheckFreeSpace:new P.BooleanSetting({category:P.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies that the library and cache volumes have sufficient free space.",defaultValue:!0}),healthCheckDb:new P.BooleanSetting({category:P.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies that the library database can be read from and written to.",defaultValue:!0}),enableSIMD:new P.BooleanSetting({category:P.SettingCategories.Tools,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to false on macOS due to instability on that platform.",defaultValue:()=>!x()&&!v.isMac}),enableVipsCache:new P.BooleanSetting({category:P.SettingCategories.Tools,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations? This defaults to false to reduce memory consumption.",defaultValue:()=>!1}),showFileInFolderUsesThunar:new P.BooleanSetting({category:P.SettingCategories.Tools,description:'If we\'re on Linux, should we use Thunar (via dbus) to "show file in folder"?',defaultValue:!1}),showFileInFolderUsesFileUri:new P.BooleanSetting({category:P.SettingCategories.Tools,description:"Does the showFileInFolderCommand expect a file: URI to the file? If this is false, the native path will be appended instead.",exampleValue:()=>!0,defaultValue:()=>v.isLinux}),showFileInFolderCommand:new P.StringArraySetting({category:P.SettingCategories.Tools,description:'If set, the first argument will be used as a command (or path to command), and the subsequent arguments (if present) will be used as arguments. The native path to the file or the file: URI will be appended, based on the value given to the "showFileInFolderUsesFileUri" setting. If this is set to an empty array, the default tool for your platform will be used instead: "nautilus -s" on linux, "open -R" on mac, and "explorer /select" on Windows.\nThis is provided to support Linux desktops that don\'t use Gnome.',defaultValue:[]}),dcraw_emuPath:new P.StringSetting({category:P.SettingCategories.Tools,description:'This should be the absolute, native path to the "dcraw_emu" binary on this system. If this is set to "dcraw_emu", PhotoStructure will search your $PATH. See <https://www.libraw.org/docs/Samples-LibRaw.html>.',defaultValue:"dcraw_emu"}),ffmpegPath:new P.StringSetting({category:P.SettingCategories.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc. See <https://photostructure.com/getting-started/video-support/>.',defaultValue:"ffmpeg"}),ffmpegTranscodeArgs:new P.StringArraySetting({category:P.SettingCategories.Tools,description:'The following are the default arguments added to transcode requests made to ffmpeg (when ffmpeg is available). The following arguments will proceed the command: "-loglevel error -threads T -i INPUT_FILE_PATH" (where T is replaced by ~half the available CPU threads, and INPUT_FILE_PATH is the full native pathname to the source video). The following arguments will follow the arguments in this setting: "-b:v VIDEO_BITRATE_KBPS OUTPUT_FILE_PATH".\nCAUTION: this is an advanced setting. Editing this may cause videos that require transcoding to not be imported, or not be viewable on all browsers and platforms. See <https://forum.photostructure.com/t/hardware-accelerated-encoding-transcoding/166> for more details.',defaultValue:["-c:a","aac","-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high"]}),heifConvertPath:new P.StringSetting({category:P.SettingCategories.Tools,description:'This should be the absolute, native path to the "heif-convert" binary on this system. If this is set to "heif-convert", PhotoStructure will search your $PATH. See <https://photostructure.com/getting-started/heif-support/>.',defaultValue:"heif-convert"}),powerShellArgs:new P.StringArraySetting({category:P.SettingCategories.Tools,description:'The following are the default arguments added to spin up PowerShell on Windows devices.\nSee <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1> for all arguments that PowerShell.exe accepts.\nSee <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-5.1> for a description of Bypass.\nSee <https://forum.photostructure.com/t/eliminate-powershell-profile-and-execution-policy-related-errors/184> for more details about why this needs to be configurable.\n(Versions prior to v1.0.0 only specified "-NoLogo").',defaultValue:["-NoLogo","-NoProfile","-ExecutionPolicy","Bypass"]}),powerShellCulture:new P.StringSetting({category:P.SettingCategories.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),toolPaths:new P.StringArraySetting({category:P.SettingCategories.Tools,description:'These paths are appended to the PATH to ensure PhotoStructure can find and run external tools like ffmpeg. Use your operating system\'s separator to separate paths (":" for mac and linux, ";" for windows).',defaultValue:()=>p.isEnvTrue("SETTINGS_IO_TEST")?T:t.DefaultPaths}),vlcPath:new P.StringSetting({category:P.SettingCategories.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),openAtLogin:new P.BooleanSetting({category:P.SettingCategories.Desktops,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!v.isElectron}),updateChannel:new P.StringEnumSetting({category:P.SettingCategories.Desktops,description:'TL:DR; keep this on "latest." This setting only applies to PhotoStructure for Desktops, and controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds have not been thoroughly tested. Please only consider changing this if customer support asks you to, and that you have recent backups of your system.',defaultValue:()=>g.channel(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new P.BooleanSetting({category:P.SettingCategories.Desktops,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new P.IntegerSetting({category:P.SettingCategories.Desktops,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:1440}),autoHideMenuBar:new P.BooleanSetting({category:P.SettingCategories.Desktops,description:"If true, PhotoStructure for Desktops on Windows and Linux will auto hide the menu bar unless the Alt key is pressed.",defaultValue:!1}),email:new P.MaybeStringSetting({category:P.SettingCategories.Reporting,description:"If set, this email will be used for license subscriptions and added to error reports, so we can contact you to help debug the issue. It is not required. Setting a value here does not subscribe you to any marketing emails.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new P.BooleanSetting({category:P.SettingCategories.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new P.IntegerSetting({category:P.SettingCategories.Reporting,description:"Set this to zero to remove all bugs in PhotoStructure.\nHUR HUR #DADJOKE\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3}),minStreamCorrPct:new P.BoundedIntegerSetting({category:P.SettingCategories.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),hiddenHomeTags:new P.StringArraySetting({category:P.SettingCategories.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", and "Keyword").',defaultValue:()=>["Type"]}),placeholderThumbs:new P.BooleanSetting({category:P.SettingCategories.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),cspReportOnly:new P.BooleanSetting({category:P.SettingCategories.Web,description:"Only report CSP violations. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>.",defaultValue:()=>!1}),cspDirective:new P.MaybeStringSetting({category:P.SettingCategories.Web,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src>.",exampleValue:()=>"https://myphotos.example.com"}),readdirCacheSeconds:new P.IntegerSetting({category:P.SettingCategories.Sync,description:"readdir() can take a long time over slow network shares and when directories are very large. This setting controls how long to cache readdir results that are slow (which take >= .5 seconds). Set to 0 to disable readdir() caching.",defaultValue:300}),verifyFileCopies:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new P.StringSetting({category:P.SettingCategories.Sync,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:"If you chose to copy assets into your library, they will be copied into <originals directory>/<result of this pattern>/<original imagename>.\n- See the originalsDir system setting for what your <originals directory> is (it defaults to your library root directory).\n- Please encode this path with forward-slashes, even if you're on Windows.\n- If you want to add a static path, escape the pathname with single quotes (like \"'photos'/y/MM/dd\").\n- This will always be interpreted as a relative path from your PhotoStructure library.\n- See <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.",defaultValue:"y/y-MM-dd"}),transcodeVideos:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"Should videos that are not in a browser-supported format be transcoded during import? Note that this is a plus-only feature. FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),transcodeBitrateQVGA:new P.IntegerSetting({category:P.SettingCategories.Sync,description:"What max bitrate should PhotoStructure encode QVGA (320 Ã 240) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:800}),transcodeBitrateUHD:new P.IntegerSetting({category:P.SettingCategories.Sync,description:"What max bitrate should PhotoStructure encode UHD (3840âÃâ2160) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:18e3}),doNotTranscodeMimetypes:new P.StringArraySetting({category:P.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "[\'video/quicktime\',\'video/mp4\']").',defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),doNotTranscodeVideoCodecs:new P.StringArraySetting({category:P.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following video codecs. The video codec may be stored in the "VideoCodec", "CompressorID", or "CompressorName" tags.',defaultValue:()=>["avc1"]}),doNotTranscodeAudioCodecs:new P.StringArraySetting({category:P.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following audio codecs. The audio codec is stored in the "AudioCodec" tag.',defaultValue:()=>["mp4a","sowt"]}),statTimeoutSeconds:new P.BoundedIntegerSetting({category:P.SettingCategories.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncIntervalHours:new P.IntegerSetting({category:P.SettingCategories.Sync,description:"This value controls both how often the sync process discovers new or changed files for any given volume.\nNote that this value is the duration between the last completion time and when the next sync should be scheduled.\nWARNING: Setting this value to a small value will mean PhotoStructure is constantly scanning your disks, which will add wear and tear and possibly reduce the lifespan of your storage media.\nNote that setting this to a zero or negative value will disable automatic scheduling of the sync process.",defaultValue:24}),rebuild:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"When set, all files in your library will be re-imported (caution: slow!).",defaultValue:!1,transient:!0}),forceSync:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),skipModelUpdates:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"When set, skip any pending library database updates.",defaultValue:!1,transient:!0}),exitWhenDone:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),matchSidecarsCaseInsensitively:new P.BooleanSetting({category:P.SettingCategories.Sidecars,description:'If set to true, PhotoStructure will look for sidecar files that match file basenames (with or without the file extension), regardless of case (for example: "IMAGE.XMP" will be a sidecar for "image.jpg").\nIf set to false, sidecars must match case (so only "image.jpg.xmp" and "image.xmp" will match for "image.jpg").\nThis defaults to false just to be conservative, but true should be fine in normal cases.',defaultValue:!1}),defaultSidecarType:new P.StringEnumSetting({category:P.SettingCategories.Sidecars,description:"What type of sidecar file do you want to generate for non-destructive edits? XMP is the most popular and well-adopted format.",defaultValue:"XMP",validValues:M.SidecarExts}),writeMetadataToSidecarsIfImage:new P.BooleanSetting({category:P.SettingCategories.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to images into sidecars. If set to false, PhotoStructure will overwrite original images with metadata changes.",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new P.BooleanSetting({category:P.SettingCategories.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to videos into sidecars. If set to false, PhotoStructure will overwrite original videos with metadata changes. This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),writeMetadataToSidecarsIfSidecarExists:new P.BooleanSetting({category:P.SettingCategories.Sidecars,description:"If set to true, PhotoStructure will write metadata changes into sidecars if the file already has a sidecar.",defaultValue:!0}),overwriteOriginal:new P.BooleanSetting({category:P.SettingCategories.Sync,description:'Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents. If this is set to false, the original file will be retained in the same directory. "image.jpg" will be stored as "image_original.jpg".',defaultValue:!1}),maxDuplicatePathElements:new P.IntegerSetting({category:P.SettingCategories.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),skipAssetFileUpdates:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),skipAssetUpdates:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>!!x()||n.cpus().length>=8}),excludeNoMediaAssetsOnRebuild:new P.BooleanSetting({category:P.SettingCategories.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),strictDeduping:new P.BooleanSetting({category:P.SettingCategories.Deduping,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true.',defaultValue:!1}),useImageHashes:new P.BooleanSetting({category:P.SettingCategories.Deduping,description:"Building image hashes slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing. If you set this from false to true, and you'd previously imported new assets, you may want to rebuild your library to re-aggregate your assets.",defaultValue:!0}),includeSharpDominantColor:new P.BooleanSetting({category:P.SettingCategories.Deduping,description:"PhotoStructure's image library, sharp, computes the dominant color using a 4096-bin 3D histogram. This doubles image hashing time, but the most-dominant color might be more accurate.",defaultValue:!1}),minExposureSettingsCoeffPct:new P.BoundedIntegerSetting({category:P.SettingCategories.Deduping,description:"This is the minimum similarity coefficient between exposure setting values two images must be to be considered equivalent. Many cameras actually report different exposure setting values between JPG and RAW: values within 90% of each other should avoid false-positives.",defaultValue:()=>90,max:100,min:0}),minImageCoeffPct:new P.BoundedIntegerSetting({category:P.SettingCategories.Deduping,description:"This is the minimum image hash similarity coefficient for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image similarity. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minImageGreyscaleCoeffPct:new P.BoundedIntegerSetting({category:P.SettingCategories.Deduping,description:"This is the minimum image hash similarity coefficient for greyscale images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>93,max:100,min:0}),minColorCoeffPct:new P.BoundedIntegerSetting({category:P.SettingCategories.Deduping,description:"This is the minimum similarity coefficient found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 50% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minMeanCoeffPct:new P.BoundedIntegerSetting({category:P.SettingCategories.Deduping,description:"If the average of image and color similarity coefficients exceeds this score, the image will be considered a match.",defaultValue:()=>65,max:100,min:0}),fuzzyDateImageCoeffWeight:new P.BoundedFloatSetting({category:P.SettingCategories.Deduping,description:'Image similar, by default, is somewhat lax to ensure JPG+RAW and downsampled or edited images are matched together. This is OK when dates must match, and the date is exactly correct. When dates are manually set to something "fuzzy", with perhaps only the year, month, and day, or is inferred by siblings, we need to be more discriminate with image contents to prevent incorrectly grouping photos from that day into a single asset. This value is multiplied with minImageCorrPct and minColorCorrPct to make them more stringent. For example, by default, the minImageCorrPct is 80%, and when the dates are manually set, and this weight is 1.2, the minImageCorrPct for manually-set-date files will be 90%.',defaultValue:()=>1.4,max:2,min:.5}),greyscaleColorThreshold:new P.BoundedIntegerSetting({category:P.SettingCategories.Deduping,description:"When looking at each pixel in L*a*b* space, a greyscale image is expected to have a* and b* values around 0. If the absolute value of every a* and b* value is under this setting's value, the image will be considered to be greyscale. A value of 0 will force all images to be considered non-greyscale.",defaultValue:5,max:128,min:0}),modeCorrCieDiffWeight:new P.BoundedFloatSetting({category:P.SettingCategories.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to the CIE94 color delta e. Smaller values apply a larger discount to color deltas.",defaultValue:()=>.6,max:2,min:0}),modeCorrIndexDiffWeight:new P.BoundedFloatSetting({category:P.SettingCategories.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to difference between the color indexes. Smaller values apply a larger discount to index differences.",defaultValue:()=>.6,max:2,min:0}),gpsErrorMeters:new P.IntegerSetting({category:P.SettingCategories.Deduping,description:"What's the maximum number of meters between GPS fixpoints that should be considered equivalent locations? Note that JPG+RAW pairs from smartphones frequently have different GPS locations due to one being recorded from a rough WiFi fix, and another from aGPS.\nGPS position error is ~10-100m. Cellular position error is ~500-750m.",defaultValue:500}),variantSortCriteria:new P.StringArraySetting({category:P.SettingCategories.Previews,description:'How should PhotoStructure pick the "best" asset file variant for a given asset? You may reorder the default fields. Only "resolution", "fileSize", "mtime", "schemeIdx", "isCover", "count", and "isBrowserSupported" are understood: other field names will be ignored. Details about these fields are here: <https://photostructure.com/faq/what-do-you-mean-by-dedupe/#how-does-photostructure-pick-which-file-to-show>.',defaultValue:["resolution","mtime","schemeIdx","isCover","count","isBrowserSupported","fileSize"]}),variantSortCriteriaPower:new P.BoundedFloatSetting({category:P.SettingCategories.Deduping,description:'Larger variant sort criteria, "resolution" and "fileSize", are scaled to ignore smaller (irrelevant) differences. Scalars are raised to this power to reduce them, so a value of 1 means the criterion is unchanged from the "raw" value.',defaultValue:()=>.15,max:1,min:1e-6}),jpegQuality:new P.BoundedIntegerSetting({category:P.SettingCategories.Previews,description:"JPEG output quality for previews. Smaller values produce smaller images with lower quality. The default value of 85 strikes a balance that has almost no noticeable compression artifacts, yet still compresses images reasonably well. Values less than ~50-70 can produce noticeable artifacts (depending on the image).",defaultValue:()=>85,max:100,min:10}),dcrawEmuArgs:new P.StringArraySetting({category:P.SettingCategories.Previews,description:'What options do you want to pass to dcraw_emu? Note that "-T -o 1 -j -Z -" will always be added (as we need TIFF, sRGB, raw pixels send to stdout). The "-h" arg will be added if the preview image needed is less than half the resolution of the original.\nRun "dcraw_emu" with no arguments to get usage help.\n"-q 1" sets interpolation quality to "0".\n"-H 2" turns on highlight blending.\n"-w" uses the camera-set white balance.\nNote: changing these values can dramatically (> 10x!) increase the time it takes to render RAW images.',defaultValue:["-q","0","-w"]}),iccProfileMappings:new P.StringArraySetting({category:P.SettingCategories.Previews,description:'Maps an original image profile to a filename stored in the "icc" directory. See that directory\'s _info.md for more information about this settings.',defaultValue:["Display P3:DisplayP3Compat-v2-magic.icc","Adobe RGB:AdobeCompat-v2.icc"]}),squareThumbStrategy:new P.StringEnumSetting({category:P.SettingCategories.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>.',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new P.FloatSetting({category:P.SettingCategories.Previews,description:"When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.\nNote that if a video is shorter than this value, the frame will be captured from the middle of the video.",defaultValue:1.5}),sharpen:new P.BooleanSetting({category:P.SettingCategories.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new P.BooleanSetting({category:P.SettingCategories.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new P.StringEnumsSetting({category:P.SettingCategories.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:s.diff(l.FitSizeValues,["uhd8k","uhd5k","qqvga"]),validValues:l.FitSizeValues}),embeddedPreviews:new P.StringArraySetting({category:P.SettingCategories.Previews,description:"For larger source images that are greater than 15MP, what embedded image preview tags should be used when present? Using these embedded images speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.\nOrder matters here: the first embedded image with sufficient resolution will be used.\nSet this to an empty array to disable using embedded previews.",defaultValue:["PreviewImage","PreviewTIFF","JpgFromRaw"]}),embeddedThumbnails:new P.StringArraySetting({category:P.SettingCategories.Previews,description:"Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.\nOrder matters here: the first embedded image with sufficient resolution will be used.\nSet this to an empty array to disable using embedded previews.",defaultValue:["ThumbnailImage","ThumbnailTIFF"]}),skipPreviews:new P.BooleanSetting({category:P.SettingCategories.Previews,description:"No previews will be built. The UI will be broken if this is set.",defaultValue:!1}),requireMakeModel:new P.BooleanSetting({category:P.SettingCategories.Filters,description:"Normally PhotoStructure requires images to have EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),minImageDimension:new P.IntegerSetting({category:P.SettingCategories.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new P.IntegerSetting({category:P.SettingCategories.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minVideoDurationSec:new P.FloatSetting({category:P.SettingCategories.Filters,description:"What's the minimum number of seconds for a video to be imported?",defaultValue:2}),minAssetFileSizeBytes:new P.IntegerSetting({envAliases:["PS_MIN_ASSET_SIZE_BYTES","PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:P.SettingCategories.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*d.KB}),maxAssetFileSizeBytes:new P.IntegerSetting({envAliases:["PS_MAX_ASSET_SIZE_BYTES","PS_MAX_ASSET_SIZE","PS_MAX_FILE_SIZE_BYTES"],category:P.SettingCategories.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library).",defaultValue:.5*d.GB}),validateJpegImages:new P.BooleanSetting({category:P.SettingCategories.Filters,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateRawImages:new P.BooleanSetting({category:P.SettingCategories.Filters,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateVideos:new P.BooleanSetting({category:P.SettingCategories.Filters,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!x()}),validationErrorBlocklist:new P.StringArraySetting({category:P.SettingCategories.Filters,description:'If any of the following patterns match a validation error found in a photo or video, the file will be considered corrupt and not be imported into your library.\nNote the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message, so, for example, a value of "caution" will ignore any error message that contains the string "caution".',defaultValue:()=>["Cannot determine format of input stream","corrupt","error","failed","invalid","not a .+ file","nothing was written into output file","partial file","Premature end of .+ file"]}),capturedAtTags:new P.StringArraySetting({category:P.SettingCategories.Parsing,description:"The following tags are examined to parse a file's captured-at time. The earliest valid tag is returned: order doesn't matter. See <https://photostructure.com/faq/captured-at/> for details.",defaultValue:()=>b.DefaultCapturedAtTags}),minRatingForFave:new P.IntegerSetting({category:P.SettingCategories.Parsing,description:'Metadata "ratings" are stored in both EXIF and XMP "Rating" and "RatingPercent" tags. Ratings are typically encoded as a value between -1 and 5 (where -1 is used by some DAMs to mark "rejected").\nPhotoStructure will prefer the XMP Rating tag.\nIf the only tag with a rating is a "RatingPercent", it will be converted to a 5-point scale..\nIf you want only ratings of 5 to be considered a favorite, set this to 5.\nThis value will be used when assets are favorited via the PhotoStructure UI.\nNote that PhotoStructure doesn\'t import assets with a negative Rating (to respect the "rejected" rating).',defaultValue:()=>4}),lensMakes:new P.StringArraySetting({category:P.SettingCategories.Parsing,description:"Used to extract and parse lens metadata (useful when Google Takeout has stripped metadata).",defaultValue:()=>S.DefaultLensMakes}),fuzzyDateParsing:new P.BooleanSetting({category:P.SettingCategories.Parsing,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),fuzzyYearParsing:new P.BooleanSetting({category:P.SettingCategories.Parsing,description:'When enabled, PhotoStructure will use directories starting with a number that looks year-like (four digits, 1826-the present) to infer the captured-at time, if all other date parsers have failed. Note that setting this to true "forces" the "fuzzyDateParsing" setting to be true.\nTo elaborate: PhotoStructure first looks for metadata with a date, then looks for an ISO-compliant YMD timestamp in the filename or path, and then, if "fuzzyDateParsing" or this setting is enabled, a YMD or YM datestamp, and then finally, if this setting is enabled, it looks for a directory that begins with a number that is between 1826-2020.',defaultValue:!1}),minValidYear:new P.IntegerSetting({category:P.SettingCategories.Parsing,description:"If PhotoStructure encounters a year that is less than this value, it will consider it invalid and look elsewhere for dates. The default value, 1826, is the first year a photograph was captured, as per <https://en.wikipedia.org/wiki/History_of_photography>. If you have paintings or other imagery from before this time, you'll want to make this value less than the earliest image in your library.",defaultValue:1826}),useStatToInferDates:new P.BooleanSetting({category:P.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in the file "birthtime" (on Windows), or the lesser value of "mtime" and "ctime" (on macOS and Linux). Note that these values are not very reliable, as file transfers and backups frequently don\'t retain these values correctly.',defaultValue:!0}),usePathsToInferDates:new P.BooleanSetting({category:P.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.',defaultValue:!0}),useLibraryPathsToInferDates:new P.BooleanSetting({category:P.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths *for files that are in your PhotoStructure library. This defaults to false, as prior versions of PhotoStructure may have placed files into incorrect datestamped directories.',defaultValue:!1}),tagCamera:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:'Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you\'ll need to "Rebuild" your library to make the setting take effect).',defaultValue:!0}),tagYMD:new P.StringEnumSetting({category:P.SettingCategories.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["y","ym","ymd",""]}),tagDateFromStat:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!x()}),tagKeywordsFromPath:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new P.StringSetting({category:P.SettingCategories.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new P.StringSetting({category:P.SettingCategories.Tagging,description:'PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "ObjectsâToolsâHammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don\'t want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.',defaultValue:"/|>â"}),tagFileType:new P.BooleanSetting({category:P.SettingCategories.Tagging,envAliases:["PS_TAG_TYPE"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0}),tagWhoSynonyms:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:'List hierarchical tags that PhotoStructure should interpret to be face names. Digicam uses "People". This is matched case-insensitively.',defaultValue:()=>["People","Face","Faces"]}),tagJsonFaces:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:'Google Takeout provides .json sidecars that may contain the names of the people (or pets) found in the image. Should PhotoStructure import these tags under "Who"?.',defaultValue:!0}),tagFaceRegions:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:'Picasa and other software supports embedding face names within "RegionInfo" metadata. If this setting is enabled, PhotoStructure will import these tags under "Who".',defaultValue:!0}),tagWhoNames:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:'This is a list of tags that will be examined for strings or string arrays. All values associated to these fields will be interpreted as names. Note that "dotted notation" is supported.\nSet this value to an empty array to disable scanning for person names.',defaultValue:["People","PersonInImage","PersonInImageWDetails.PersonName","PersonInImageName"]}),tagNamesFormatter:new P.StringEnumSetting({category:P.SettingCategories.Tagging,description:'How should PhotoStructure format the "Who" tags for assets whose files are tagged with "people" strings?\n"as-is" will tag names directly to "Who", so, "Who/Albert Einstein".\n"family/given" will tag "Who/Einstein/Albert" (for regions that provide given names first). The default is "as-is," because discerning given and family names aren\'t reliably inferable.\nSee <https://en.wikipedia.org/wiki/Personal_name#Name_order>.',defaultValue:"as-is",validValues:["as-is","family/given"]}),tagNamesDefaultFamily:new P.StringSetting({category:P.SettingCategories.Tagging,description:'If a name is missing a family name, if this value is not blank, it will be provided as a default. If this value is blank, the name tag will be Who/given. Note that this setting is only used if "tagNamesFormatter" is set to "family/given".',defaultValue:"-"}),tagNamesCapitalizedAsFamily:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:"Assume uppercased names are family names (this is common practice in geneology).",defaultValue:!0}),tagNamesOrder:new P.StringEnumSetting({category:P.SettingCategories.Tagging,description:'How should PhotoStructure parse people\'s names? Note that this setting is only used if "tagNamesFormatter" is set to "family/given". See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.',defaultValue:"western",validValues:["western","eastern"]}),tagNamesSurnamePrefixes:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:'List all family name prefixes to be considered part of the family name. These are matched case-insensitively. This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>["A","Dâ","Da","De la","De las","De","Del","Della","Den","Des","Di","Du","La","Las","Le","Li","Lo","Mc","Mac","op de","ten","ter","Van ât","van der","van","von der","von","z","zu"]}),tagNamesSurnames:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:'List all family names you expect in tags that are not single words that are found at the end of a tagged name. Hyphenated family names (like "Ocasio-Cortez") do not need to be listed here: only compound family names, and if your language doesn\'t separate family names with whitespace. In the latter case, either include all family names, or include all givenNames (whatever\'s easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>[]}),tagNamesGiven:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:'List all given names you expect in tags that are not single words. Hyphenated given names (like "Rose-Ann") do not need to be listed here. If your language doesn\'t separate family names and given names with whitespace, either include all given names, or include all familyNames (whatever\'s easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>[]}),tagNamesFamilySurrounds:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added as a family name. As an example, if you use the default "()", then "Michelle LaVaughn (Robinson) Obama" will be name tagged with both "Who/Robinson/Michelle LaVaughn" and "Who/Obama/Michell LaVaugn". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["()"]}),tagNamesGivenSurrounds:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added to the end of the given name with the surrounds retained. As an example, if you use the defaults of "[]" and double-quotes, then "Joe "Joey" Smith" will be name tagged with Who/Smith/Joe "Joey". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["[]",'""']}),tagNamesLexical:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:'Assume any name with a comma is in "lexical name order", which is always "lastname, given name(s)". If the given name is found to be "sr.", "senior", "jr.", or "junior", the name will be considered to be in western order ($givenNames $familyName, $modifier), and the $modifier will be added to the $givenNames. If this is set to false, commas are ignored.',defaultValue:!0}),excludedRootTags:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:"Keywords starting with the given roots will be omitted from your PhotoStructure library.",defaultValue:()=>["http:","https:"]}),tagDisplayNameFS:new P.StringSetting({category:P.SettingCategories.Tagging,description:'What should PhotoStructure call the "root" tag for browsing by filesystem paths? Note that this value is only for the UI, and will update the "_displayName" of the /fs/ tag: this value won\'t change the URL path from be "/tag/fs/.../". Reasonable options that have been suggested include "Folder", "Directory", "Drive", "File", "Path", "Volume", or "Computer".',defaultValue:"Folder"}),tagAlbums:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:'Should PhotoStructure look for $tagJsonAlbumFilename (by default, "metadata.json") files in the same directory as asset files for album titles?',defaultValue:!0}),tagAlbumFilenames:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:'If you have enabled "tagJsonAlbums", what\'s the name of the file that PhotoStructure should look for with album metadata? This can be JSON, XMP, MIE, or EXIF encoded.',defaultValue:["metadata.json"]}),tagAlbumTitle:new P.StringSetting({category:P.SettingCategories.Tagging,description:'If you have enabled "tagJsonAlbums", what\'s the name of the field encoded in the album file? Object hierarchies are separated with a ".".',defaultValue:"albumData.title"}),tagAlbumTitleHierarchies:new P.BooleanSetting({category:P.SettingCategories.Tagging,description:'If true, album titles will be split as hierarchical keywords. If false, album titles will not be split, and all albums will be under the "Albums" root tag.',defaultValue:!1}),tagAlbumDescription:new P.StringSetting({category:P.SettingCategories.Tagging,description:'If you have enabled "tagJsonAlbums", what\'s the name of the field encoded in the album file? Object hierarchies are separated with a ".".',defaultValue:"albumData.description"}),tagAlbumDate:new P.StringSetting({category:P.SettingCategories.Tagging,description:'If you have enabled "tagJsonAlbums", what\'s the name of the field encoded in the album file? Object hierarchies are separated with a ".".',defaultValue:"albumData.date"}),tagAlbumsExcluded:new P.StringArraySetting({category:P.SettingCategories.Tagging,description:'For "metadata.json" albums, some are automatically generated. If the title or description includes any given string, it will be ignored.',defaultValue:["Album for automatically uploaded content"]}),pickPlanOnWelcome:new P.BooleanSetting({category:P.SettingCategories.Subscriptions,description:'If set to true, the welcome page flow will redirect to https://account.photostructure.com/plans to have you pick between "plus" and "lite". If set to false, the welcome page will continue directly to the settings page with a "lite" license. You can still upgrade to a paid plan later from the main menu or the about page, even if this is false.',defaultValue:!0}),autoRefreshLicense:new P.BooleanSetting({category:P.SettingCategories.Subscriptions,description:'PhotoStructure uses cryptographically signed licenses to locally store your current plan subscription status. These licenses are only valid for the current subscription period, and must be refreshed when your subscription renews or converts from a free trial to a paid subscription. To minimize the hassle of license renewals, PhotoStructure can automatically renew expired licenses in the background.\nIf the current license has expired and this value is true, PhotoStructure will make one secure POST request to https://account.photostructure.com/ that contains several lossy one-way hashes of current system metadata. We hash all identifying metadata to only 15 characters to alleviate any privacy concerns. If your plan subscription is active, a new license will be added to your library.\nSet this to false and set the "reportErrors" setting to false if you don\'t want PhotoStructure "phoning home" for any reason.\nNote that if this is disabled, license renewals will require manual intervention: click "Upgrade" from the main menu, pick your plan, authenticate, and the license will automatically refresh.',defaultValue:!0}),license:new P.MaybeStringSetting({category:P.SettingCategories.Subscriptions,description:'Subscription licenses are normally saved automatically into both your library and system configuration directories. This setting just provides users with an alternative way to provide a license, if it\'s more convenient. Any value provided to this setting will be considered in addition to existing license files when PhotoStructure is trying to find the "best" license available.'})};for(const[e,i]of c.entries(t.Settings))i._setName(e);function D(e){const i=(a.blank(e)?"":e).split(r.delimiter);if(v.isWin&&a.blank(E.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return i.push(...t.Settings.toolPaths.valueOrDefault),s.uniq(i).filter(a.notBlank).join(r.delimiter)}t.SuggestedDirsEnvKey="SUGGESTED_DIRS",t.withDefaultPaths=D,t.pathWithDefaults=u.lazy((()=>D(E.env.PATH))),t.persistedSettings=u.lazy((()=>{const e=c.values(t.Settings).filter((e=>!e.transient));return s.sortBy(e,(e=>["system"===e.categoryType?0:1,P.SettingCategories.indexOf(e.category),e.advanced,e.name]))})),t.persistedSystemSettings=u.lazy((()=>t.persistedSettings().filter((e=>P.SystemCategories.includes(e.category))))),t.persistedLibrarySettings=u.lazy((()=>t.persistedSettings().filter((e=>P.LibraryCategories.includes(e.category)))))},82041:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.writeEnv=t.nukeSettings=t.clearSettings=t.readToml=t.writeLibrarySettings=t.readLibrarySettings=t.writeSystemSettings=t.stringifyToml=t.versionForSettings=t._libraryHasSettings=t.libraryHasSettings=t.librarySettingsVersion=t.systemSettingsVersion=t.savedLibraryPath=t.envOrSavedLibraryPath=t.readSystemSettings=t.librarySettingsFile=t.systemSettingsFile=void 0;const r=n(i(33815)),s=i(11944),a=i(39938),o=i(38625),l=i(43947),u=i(16475),c=i(87748),d=i(11448),h=i(66776),p=i(61570),m=i(90957),f=i(82798),g=i(13779),y=i(46852),v=i(71817),w=i(84593),b=i(79015),S=i(51081),M=i(98250),P=i(7162),E=i(32330),T=i(58517),x=i(91464),D=i(63774),C=i(15671),k=i(42041),I=i(53719),F=i(71395),O=i(84161),A=i(43414),_=P.mkLogger("SettingsIO"),L="settings.toml";function R(){return M.PosixFile.for(C.userData()).join(L)}function N(e){return g.first([e,A.Settings.libraryPath.value],(e=>a.mapNotBlank(e,(e=>h.map(F.libraryDataDir(e),(e=>e.join(L)))))))}function B(){return y.thenMap(G(R()),(e=>e[A.Settings.libraryPath.name]))}function j(e){const t=N(e);return _.tap({msg:"_libraryHasSettings",result:h.orElse(null==t?void 0:t.clear().existsSync(),!1),level:"info",meta:{libraryPath:e,settings:A.Settings.libraryPath.value,librarySettingsFile:null==t?void 0:t.nativePath}})}t.systemSettingsFile=R,t.librarySettingsFile=N,t.readSystemSettings=async function(e=R()){const i=await y.thenOrElse(J(e),(()=>[]));return await async function(){o.isTrue(A.Settings.scanMyPictures.value)&&(A.Settings.scanMyPictures.value=!1,A.Settings.scanPaths.push(await T.picturesDir()))}(),t.libraryHasSettings.unset(),i},t.envOrSavedLibraryPath=async function(){var e;return null!==(e=A.Settings.libraryPath.value)&&void 0!==e?e:B()},t.savedLibraryPath=B,t.systemSettingsVersion=async function(){return V(R())},t.librarySettingsVersion=async function(e){return h.map(N(e),(e=>V(e)))},t.libraryHasSettings=d.lazy((()=>j()),I.ShortCmdTimeoutMs),l.later((()=>{b.onClearCache((()=>t.libraryHasSettings.unset())),A.Settings.libraryPath.addListener((()=>t.libraryHasSettings.unset()))})),t._libraryHasSettings=j;const z=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;async function V(e){return y.thenMap(e.firstMatchingLine(z),(e=>e[1]))}const W={maxLineLen:78,prefix:"# "};async function q(e,i){const n=await e.clear().isNonEmpty(),r=n?await e.wip():e;await async function(e,i,n){const r=h.orElse(await G(n),{}),a=s.flatten(["","Hello!","",`These are ${i[0].categoryType} settings for PhotoStructure.`,""," - Please shut down PhotoStructure before editing this file.",""," - PhotoStructure has TWO settings files!",""," - Most settings have reasonable defaults, which are provided after the",'   description. Remove the "#" from the beginning of the line to override',"   the default.",""," - See <https://photostructure.com/getting-started/advanced-settings/>","   for more details","","Thanks for using PhotoStructure! Visit <https://photostructure.com/support> or email <support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+t.versionForSettings()].map((e=>x.wrap(e,W))));a.push("","");let o="";i.forEach((e=>{const t=`${x.capitalize(e.categoryType)}.${e.category.toLowerCase()}`;t!==o&&(o=t,a.push("",x.padding("#",78),"#","# Settings for "+t+":","#","",""));const i="# +"+x.padding("-",e.name.length+4)+"+",n=p.entries({env:e.key,...s.mapNotEmpty(e.opts.envAliases,(e=>({"env aliases":e}))),...e.addToJSON()}).map((([e,t])=>`${e}: ${c.stringify(t)}`)).join(", ");a.push(...x.wrap([i,"|  "+e.name+"  |",i,"",`${e.opts.description.replace(/\n/g,"\n\n")}`,`(${n})`,""].join("\n"),W));const l=r[e.name],u={},d=e.valueToPersist(l);null!=d?(u[e.name]=d,a.push(...U(u))):(u[e.name]=e.exampleValue,a.push(...U(u).map((e=>"# "+e)))),a.push("","")})),await e.writeTxt_("\n"+a.map((e=>e.trimRight())).join("\n")+"\n\n"),b.emitSettingsChanged()}(r,i,e),_.info("maybeWriteFile(): wrote settings",{dest:r,file:e,nonDefaults:i.filter((e=>e.hasValue())).map((e=>({name:e.name,value:e.value})))}),n&&(await y.thenNot(w.eqlAsync(G(r),G(e)))&&(_.info("Archiving prior, different contents",{dest:r,file:e}),await e.renameYMDHMS_("old")),await r.unwip_())}function U(e){return S.splitLines(...p.entries(e).map((([e,t])=>e+" = "+c.stringify(t,void 0,2))))}function H(e){return a.blank(e)?void 0:r.default.parse(x.dumbquote(e))}async function G(e){const t=await e.readFile();if(null!=t)return m.firstDefinedSuccess([()=>H(v.debom(t)),()=>H(t.toString())])}async function J(e){const t=P.mkLogger("SettingsIO.importFileSettings("+e.nativePath+")");try{const i=await G(e);if(null==i){if(await e.isNonEmpty())throw new Error("Failed to read "+e);return[]}const n=new Map(p.entries(A.Settings).filter((([,e])=>e instanceof O.Setting&&!e.transient)).map((([e,t])=>[e.toLowerCase(),t]))),r=s.compact(p.entries(i).map((([e,i])=>{const r=n.get(f.toS(e).toLowerCase());return null==r?t.warn("Failed to import (no setting with this name)",{key:e}):r.importFromFile(i),r})));return t.info("loaded",{tomlMap:i,imported:r.map((e=>p.pick(e,"name","value","persist")))}),r}catch(e){return void t.error("Cannot read"+u.errorToVerbose(e))}}t.versionForSettings=d.lazy((()=>k.version)),t.stringifyToml=U,t.writeSystemSettings=async function(e=R()){return q(e,A.persistedSystemSettings())},t.readLibrarySettings=async function(e){return h.map(N(e),(e=>J(e)))},t.writeLibrarySettings=async function(e){await F.setupLibraryDataDir(a.firstNotBlank(e,A.Settings.libraryPath.value));const i=N(e);return _.warn("writeLibrarySettings("+i+")"),await h.map(i,(e=>q(e,A.persistedLibrarySettings()))),t.libraryHasSettings.unset(),i},t.readToml=G;const $=d.lazy((()=>new Set([A.Settings.logLevel,A.Settings.httpPort,A.Settings.rpcPort,A.Settings.license].map((e=>e.key)))));function K(){p.values(A.Settings).filter((e=>!$().has(e.key))).forEach((e=>e.unset())),b.emitClearCache(),b.emitSettingsChanged()}t.clearSettings=K,t.nukeSettings=async function(){await R().unlink("debug"),await h.map(N(),(e=>e.unlink("debug"))),K()},t.writeEnv=async function(e,t){const i=s.flatten(["",`Welcome to PhotoStructure! These are the settings for version ${E.baseVersion()}.`,"","Please see <https://photostructure.com/environment-variables> for more information about using environment variables with PhotoStructure.","",'PLEASE NOTE: PhotoStructure does not read the contents of this "defaults.env" (or any ".env" variant).',"","The following settings categories are stored in the system settings.toml:","",...s.sort([...O.SystemCategories]).map((e=>"* System."+e)),"","The following settings categories are stored in the library settings.toml:","",...s.sort([...O.LibraryCategories]).map((e=>"* Library."+e)),"","Please visit <https://forum.photostructure.com> if you find anything that may be a bug or have any questions, ideas, or feedback. We'd love to hear from you!",""].map((e=>x.wrap(e,W))));i.push("","");let n="";t.forEach((e=>{const t=`${x.capitalize(e.categoryType)}.${e.category.toLowerCase()}`;t!==n&&(n=t,i.push("",x.padding("#",78),"#","# Settings for "+t+":","#","",""));const r=e.name,a="# +"+x.padding("-",r.length+4)+"+",o={...e.addToJSON()};s.mapNotEmpty(e.opts.envAliases,(e=>o.aliases=e));const l=p.entries(o).map((([e,t])=>`${x.capitalize(D.camel2snake(e)).replace(/_/g," ")}: ${t}`));s.isNotEmpty(l)&&l.push(""),i.push(...x.wrap([a,`|  ${r}  |`,a,"",e.opts.description.replace(/\n/g,"\n\n"),"",...l].join("\n"),W)),i.push(`# ${e.key}=${c.stringify(f.toS(e.envValueOrDefault))}`),i.push("","")})),await e.writeTxt_(i.map((e=>e.trimRight())).join("\n"))}},35290:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseBinaryField=t.BinaryField=t.BinaryFieldRE=void 0;const n=i(75556);t.BinaryFieldRE=/^\(?Binary data (\d+).*use -b option to extract\)?$/i;class r{constructor(e){this.binaryDataBytes=e}}t.BinaryField=r,t.parseBinaryField=function(e){if("string"!=typeof e)return;const i=e.match(t.BinaryFieldRE);return null==i?void 0:new r(n.toInt(i[1],{defaultValue:0}))}},68567:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractBitrateKbps=void 0;const n=i(66776),r=i(82798),s=i(13779),a=i(70283);t.extractBitrateKbps=function(e){return s.first(["AvgBitrate","MaxDataRate"],(t=>{return i=e[t],n.map(a.extractFloat(i),(e=>{const t=r.toS(i).toLowerCase();return n.map(s.first(o,(e=>t.includes(e.pat)?e.fac:void 0)),(t=>e*t))}));var i}))};const o=[{pat:"mb/s",fac:1024},{pat:"mbps",fac:1024},{pat:"kb/s",fac:1},{pat:"kbps",fac:1}]},65642:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.capturedAtFromTags=t.extractCapturedAt=t.addTzFromSibs=t.hasSubSecCapturedAt=t.capturedAtTags=t.bestCapturedAt=t.CapturedAt=t.capturedAtSrcFromTags=void 0;const n=i(55883),r=i(8223),s=i(11944),a=i(88491),o=i(87748),l=i(11448),u=i(66776),c=i(39784),d=i(82798),h=i(13779),p=i(64975),m=i(46852),f=i(45161),g=i(3955),y=i(95976),v=i(9483),w=i(7162),b=i(2023),S=i(43414),M=i(26352),P=l.lazy((()=>w.mkLogger("CapturedAt")));function E(e){return d.toS(e).toLowerCase().startsWith("tags")}t.capturedAtSrcFromTags=E;class T{constructor(e,t,i,n,r){this.nativePath=e,this.date=t,this.src=i,this.mtime=n,this.precisionMs=r,this.toISOString=l.lazy((()=>f.datedToISO(this.date)))}spread(e){const t={...this,...e};return new T(t.nativePath,t.date,t.src,t.mtime)}toLocal(){return f.datedToLocal(this.date)}toOffset(){return f.datedToOffsetMinutes(this.date)}get isFromTags(){return E(this.src)}toPrecisionMs(){return u.orElse(this.precisionMs,(()=>f.datedToPrecisionMs(this.date)))}toString(){return o.stringify({nativePath:this.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return f.hasZone(this.date)}hasTime(){return f.hasTime(this.date)}}async function x(e,t){if(!f.validDate(t))return;if(f.hasZone(t))return t;const i=await M.nearestSiblingTzOffset(e);if(null!=i){const e=f.toExifDateTime(t,i);if(f.validDate(e))return e}return t}function D(e,t){return f.mapValidDate(e[t],(e=>({src:t,date:e})))}function C(e){if(null==e)return;const t=s.compact(S.Settings.capturedAtTags.values.map((t=>({date:e[t],src:t,ts:u.map(f.datedToMillis(e[t]),(e=>Math.floor(e/1e3)))})))),i=t.filter((e=>{const t=e.date instanceof n.ExifDateTime?e.date:void 0;return"2002:12:08 12:00:00"!==(null==t?void 0:t.rawValue)&&f.validDate(e.date)&&null!=e.ts}));return y.ifLog(v.LogLevels.debug,(()=>{P().debug("capturedAtFromTags()",{rawArr:t,validArr:i})})),b.firstThunk((()=>h.greatestBy(i,(e=>u.map(f.datedToLocal(e.ts),(t=>[-Math.floor(t/1e8),f.hasTime(e.date)?1:0,f.hasSeconds(e.date)?1:0,f.hasZone(e.date)?1:0,-S.Settings.capturedAtTags.values.indexOf(e.src)]))))),(()=>D(e,"DateTimeUTC")),(()=>D(e,"GPSDateTime")))}t.CapturedAt=T,t.bestCapturedAt=function(e){const t=s.sortBy(e,(e=>-e.mtime.getTime()));return b.firstThunk((()=>t.find((e=>e.src.startsWith("tags")))),(()=>t.find((e=>e.src.startsWith("bname+stat")))),(()=>t.find((e=>e.src.startsWith("bname")))),(()=>t.find((e=>e.src.startsWith("siblings")))),(()=>t.find((e=>e.src.startsWith("path")))),(()=>e[0]))},t.capturedAtTags=function(e){return e=s.sortBy(c.toA(e),(e=>-e.mtime)),h.firstNonEmptyThunk((()=>e.filter((e=>e.src.startsWith("tags")))),(()=>e.filter((e=>e.src.startsWith("bname+stat")))),(()=>e.filter((e=>e.src.startsWith("bname")))),(()=>e.filter((e=>e.src.startsWith("siblings")))),(()=>e.filter((e=>e.src.startsWith("path")))),(()=>e.filter((e=>e.src.startsWith("stat"))).slice(1,1)),(()=>[]))},t.hasSubSecCapturedAt=function(e){return null!=e&&h.anyDefined([e.SubSecTime,e.SubSecTimeDigitized,e.SubSecTimeOriginal,e.SubSecCreateDate,e.SubSecDateTimeOriginal])},t.addTzFromSibs=x,t.extractCapturedAt=async function(e,t,i){const n=await e.mtime(),o=async(a,o)=>m.thenMap(o,(o=>m.thenMap(async function(e,t,i,n){const s=await i;if(f.validDate(s))return f.hasZone(s)?s:null!=t&&null!=t.tz&&r.Info.isValidIANAZone(t.tz)?f.setZone(s,t.tz):n?s:x(e,s)}(e,t,o.date,i),(t=>new T(e.nativePath,t,s.compactBlanks([a,o.src]).join(":"),n,o.precisionMs)))));return p.firstDefinedLater((()=>o("tags",C(t))),(()=>o("bname+stat",M.extractStatBname(e))),(()=>i?void 0:o("siblings",M.inferCapturedAtFromSiblings(e))),(()=>i||!S.Settings.usePathsToInferDates.valueOrDefault?void 0:o("bname",u.map(f.parseDated(M.bname(e)),(e=>({date:e,src:"",precisionMs:h.max([f.datedToPrecisionMs(e),a.secondMs])}))))),(()=>function(e,t){return null==e||t||!S.Settings.usePathsToInferDates.valueOrDefault||!S.Settings.useLibraryPathsToInferDates.valueOrDefault&&g.containedByNativePath(e.nativePath,S.Settings.libraryPath.value)}(e,i)?void 0:o("path",u.map(f.extractDateFromPath(e.pathnamesWithoutDrive),(e=>({src:"",date:e}))))),(()=>S.Settings.useStatToInferDates.valueOrDefault?o("stat",m.thenMap(e.minStatDate(),(e=>({src:"",date:e})))):void 0))},t.capturedAtFromTags=C},82590:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultCapturedAtTags=void 0,t.DefaultCapturedAtTags=["SubSecDateTimeOriginal","SubSecCreateDate","SubSecTimeDigitized","SubSecMediaCreateDate","DateTimeOriginal","OriginalCreateDateTime","CreateDate","DateTimeCreated","DateCreated","DateTimeDigitized","MediaCreateDate","DateTime","SubSecTime","ModifyDate","photoTakenTime"]},98788:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLensMakes=void 0,t.DefaultLensMakes=["7artisans","Bower","Canon","Carl Zeiss","Cosina","Fuji","Fujifilm","Goerz","Hasselblad","Hirox","Hoya","Konica","Leica","Leidolf","Lensbaby","Lumix","Meike","Meopta","Minolta","Neewer","Nikon","Olympus","Opteka","Panasonic","Pentacon","Pentax","Ricoh","Rodenstock","Rokinon","Ross","Samsung","Samyang","Seiko","Sigma","Silor","Soligor","Sony","Sunpak","Tamron","Tiffen","Tokina","Topcon","Venus","VoigtlÃ¤nder","Wray","Yongnuo","Zhong Yi","Zuiko"]},27947:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.duration=t.extractDurationSec=void 0;const n=i(66776),r=i(75556),s=i(54608),a=i(98250),o=i(15271),l=i(44546);function u(e){return n.map(e,(e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(r.gt0)))}t.extractDurationSec=u,t.duration=async function(e){const t=a.PosixFile.for(e);return s.thenOpt(l.mimetype(t)).filter(o.isVideoMimeType).flatMap((()=>l.readRawTags(t,!1))).flatMap(u).get()}},44546:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseTags=t.readRawTags=t.writeTags=t.writeTagArgs=t.deleteAllTags=t.moveOriginal=t.sizeInfo=t.isMimetype=t.readRotation=t.mimetype=t.capturedAt=t.cachedTags=t.readTags=t.sidecarEql=t.clearTagsCache=t.rawTagsCache=t.extractBinaryTag=t.shutdownExiftool=t.exiftoolVersionMaybe=t.exiftoolVersion=t.exiftool=t.setExifToolProcs=t.addInstanceIdsToTags=void 0;const n=i(55883),r=i(85622),s=i(11944),a=i(39938),o=i(88491),l=i(43947),u=i(16475),c=i(6314),d=i(11448),h=i(66776),p=i(61570),m=i(8199),f=i(82798),g=i(17078),y=i(36079),v=i(64975),w=i(46852),b=i(7383),S=i(13317),M=i(13056),P=i(70403),E=i(84593),T=i(79015),x=i(51498),D=i(18941),C=i(98250),k=i(53026),I=i(46517),F=i(15271),O=i(7162),A=i(76474),_=i(2023),L=i(99312),R=i(43414),N=i(53719),B=i(59387),j=i(35290),z=i(65642),V=i(27947),W=i(94435),q=i(22766),U=i(71932),H=i(91854),G=i(54988),J=i(23199),$=i(84685),K=i(68107),Q=i(26352),Y=i(45023),X=d.lazy((()=>O.mkLogger("ExifTags")));let Z=!1;t.addInstanceIdsToTags=function(e){Z=e},t.setExifToolProcs=function(e){return R.Settings.exiftoolProcsPerChild.tmpValue=e,ie()};const ee=d.lazy((()=>{return new M.BatchClusterObserver("ExifTool",new n.ExifTool({logger:()=>O.mkLogger("ExifTool"),maxProcs:null!==(e=R.Settings.exiftoolProcsPerChild.value)&&void 0!==e?e:B.maxCpus()>4?3:2,maxIdleMsPerProcess:5*o.minuteMs,maxTasksPerProcess:R.Settings.maxTasksPerProcess.valueOrDefault,cleanupChildProcs:!1}),y.EndableRanks.service,!0).t;var e}));function te(){const e=ee();return e.ended?ee.refresh():e}function ie(e=!1){return h.map(ee.clear(),(t=>t.end(e)))}t.exiftool=te,t.exiftoolVersion=function(){return S.thenOrTimeout(te().version(),N.CmdTimeoutMs,(()=>{throw new Error("ExifTool timed out")}))},t.exiftoolVersionMaybe=function(){return h.map(ee.prior(),(e=>e.ended?void 0:S.thenOrTimeout(e.version(),N.CmdTimeoutMs,(()=>{throw new Error("ExifTool timed out")}))))},t.shutdownExiftool=ie,T.onFileCopied(((e,t)=>w.thenMap(oe(e),(e=>{const i=C.PosixFile.for(t);return ne.getOrSetAsync(i.nativePath,(()=>Promise.resolve({...e,SourceFile:i.nativePath,FileName:i.base,Directory:i.dir})))})))),t.extractBinaryTag=function(e,t,i){return te().extractBinaryTag(e,t,i)};const ne=new x.FifoCacheAsync({maxSize:128,timeoutMs:o.minuteMs});function re(){ne.clear(),t.rawTagsCache.clear()}t.rawTagsCache=new x.FifoCacheAsync({maxSize:128,timeoutMs:o.minuteMs}),t.clearTagsCache=re,l.later((()=>T.onClearCache(re))),T.onFileChanged((e=>{a.blank(e)?re():(ne.deleteIf((t=>t.startsWith(e))),t.rawTagsCache.deleteIf((t=>t.startsWith(e))))}));const se=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];async function ae(e){if(null==e)return;const t=C.PosixFile.for(e);return await t.isEmpty()||await t.isNotReadable()?void 0:b.time("tags.readTags",(async()=>w.thenMap(he(t),(e=>ge(t,e)))))}async function oe(e){return ne.get(String(e))}async function le(e){if(a.blank(e))return;const i=C.PosixFile.for(e);return v.firstDefinedLater((()=>w.thenMap(t.rawTagsCache.get(i.nativePath),(e=>e.MIMEType))),(()=>w.thenMap(oe(i),(e=>e.MIMEType))),(()=>w.thenMap(D.readFileType(i.nativePath),(e=>"image/tiff"===e.mime?void 0:e.mime))),(()=>q.isExifExt(i.ext)?w.thenMap(he(i,!1),(e=>e.MIMEType)):void 0))}async function ue(e,t){const i=C.PosixFile.for(e),n=null==t||a.blank(t.ImageHeight)?await he(i):t;if(null==n)return;const r=h.orElse($.extractRotation(t),(()=>$.extractRotation(n))),s=J.isLibrawMimetype(n.MIMEType)?await k.rawInfo(i).catch((e=>{X().warn("Failed to read raw info",{file:i.nativePath,err:u.errorToS(e)})})):void 0,o=K.extractSizeInfo(n,r,s);return null!=o?o:F.isVideoMimeType(n.MIMEType)?w.thenMap(I.extractVideoFrame(i,n.MIMEType),(e=>ue(e,n))):void 0}async function ce(e,t="_original"){return e.sibling(e.base+t).saveIfNewOrDelete(e.name+t+e.ext)}async function de(e){const t=["-api QuickTimeUTC=1"];return R.Settings.overwriteOriginal.valueOrDefault&&t.push("-overwrite_original"),m.gt(await e.size(),2*g.GB)&&t.push("-api LargeFileSupport=1"),t}async function he(e,t=!0){const i=C.PosixFile.for(e);if(await i.isFile())return b.time("tags.readRawTags",(async()=>{var e;const n=await fe(i.nativePath);if(null==n||!t)return n;const r=w.thenCollectParallel(i.jsonSidecars(),U.readJsonSidecar),a=w.thenCollectParallel(i.sidecars(),(e=>fe(e.nativePath))),o={...n};for(const[t,i]of[...await r,...await a]){const n=p.omit(t,...se);s.isNotEmpty(p.values(n))?((null!==(e=o.sidecars)&&void 0!==e?e:o.sidecars=[]).push(i.base),_.assignFields(o,n),X().debug("readRawTags() sidecar had values",{sidecar:i.base,safeTags:n})):X().debug("readRawTags() sidecar was empty",{sidecar:i.base})}return o}))}t.sidecarEql=async function(e,t){const i=e=>w.thenMap(he(e,!1),(e=>p.omit(e,...se)));return await E.eqlAsync(e.clear().sha(),t.clear().sha())||await E.eqlAsync(i(e),i(t))},t.readTags=ae,t.cachedTags=oe,t.capturedAt=async function(e){return w.thenMap(ae(e),(e=>e.capturedAt))},t.mimetype=le,t.readRotation=async function(e){return w.thenMap(he(e,!0),$.extractRotation)},t.isMimetype=async function(e,t){const i=await le(e);return X().tap({msg:"isMimetype",meta:{path:f.toS(e),mimeType:i},result:null!=i&&t.has(i)})},t.sizeInfo=ue,t.moveOriginal=ce,t.deleteAllTags=async function(e){await te().deleteAllTags(e.nativePath),await e.sibling(e.base+"_original").unlink("trace")},t.writeTagArgs=de,t.writeTags=function(e,t,i){return b.time("tags.writeTags",(async()=>{const n=await e.sidecar(),r=F.isVideoMimeType(i),a=r&&R.Settings.writeMetadataToSidecarsIfVideo.valueOrDefault||!r&&R.Settings.writeMetadataToSidecarsIfImage.valueOrDefault||R.Settings.writeMetadataToSidecarsIfSidecarExists.valueOrDefault&&await n.exists()?n:e;await te().write(a.nativePath,t,await de(a));const o=await ce(a);return s.uniq([e.nativePath,a.nativePath]).forEach(T.emitFileChanged),e.clearThisAndParent(),a.clearThisAndParent(),{original:o,dest:a}}))},t.readRawTags=he;const pe=new c.Latch,me=new c.Latch;async function fe(e){return t.rawTagsCache.getOrSetAsync(e,(async()=>{X().debug("_readRawTags("+e+") not cached, reading now.");const t=pe.pending;t?pe.resolve():await me.promise;const i=q.isVideoExt(r.extname(e))?[]:void 0,n=await b.time("exiftool.read()",(()=>S.thenOrTimeout(P.thenElapsed(te().read(e,i).catch((t=>{X().info("Failed to read "+e,t)}))),N.CmdTimeoutMs)));return t&&me.resolve(),h.map(n,(t=>(X().debug("_readRawTags("+e+") in "+t.elapsedMs+"ms"),h.map(t.result,(e=>{for(const t of p.keys(e)){const i=e[t];if("string"==typeof i){const n=j.parseBinaryField(i);null!=n&&(e[t]=n)}}const i=s.compactBlanks([e.Error,...h.orElse(e.errors,[]),e.Warning].map(f.toS));return s.isNotEmpty(i)&&(e.problems=i),e.exiftoolMs=t.elapsedMs,Z&&(e.instance=A.safeUUID()),e})))))}))}async function ge(e,t){if(null==t)return;const i=t.MIMEType,n=e.nativePath;if(a.blank(i))return void X().debug("No mimetype for "+e);const r=e.nativePath.startsWith(R.Settings.cacheDir.valueOrDefault)||e.pathnames.includes(".photostructure");r||await Q.inferMakeAndModel(e,t);const s=t;s.originalMake=t.Make,s.originalModel=t.Model,t.Make=G.make(t.Make),t.Model=G.model(t.Make,t.Model);const o=H.extractLensMakeModel(t),l=await z.extractCapturedAt(e,t,r);if(null==l)return void X().info("No capturedAt for "+e);const u=W.extractExposureSettings(t),c=await ue(e,t);if(null==c)return void X().info("No size info for "+n);const d=i.startsWith("video/")?V.extractDurationSec(t):void 0,p={mimetype:i,exposureSettings:u,...Y.extractTitleDescription(s),...o,...c,duration:d,capturedAt:l,tz:t.tz};return X().debug("parsedTags",{nativePath:n,...p,capturedAt:h.map(l,(e=>({date:e.date,src:e.src})))}),{...s,...p}}L.isWin||(pe.resolve(),me.resolve()),t.parseTags=ge},74873:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uidGeoHash=t.imageId=t.lensId=t.cameraId=t.firstTagWithName=t.whyExposureSettingsNotSimilar=t.present=t.compactZeroes=t.zeroesRe=void 0;const n=i(39938),r=i(66776),s=i(75556),a=i(61570),o=i(90957),l=i(82798),u=i(85563),c=i(70283),d=i(43414),h=i(91854);function p(e){return null==e||s.isNumber(e)?0===e:null!=t.zeroesRe.exec(l.toS(e))}function m({a:e,b:t,field:i,desc:n,parser:r}){const a=r(e[i]),o=r(t[i]),l=d.Settings.minExposureSettingsCoeffPct.valueOrDefault/100;return null==a||null==o||s.approximates(a,o,l)?void 0:"Different "+n+": "+e[i]+" â  "+t[i]}function f(e,t){for(const i of t){const t=e[i];if(n.notBlank(t))return i+":"+l.toS(t).trim()}}t.zeroesRe=/^[\s0]*$/,t.compactZeroes=function(e){return a.mapFields(e,((e,t)=>p(t)?void 0:[e,t]))},t.present=function(e){return null!=e&&n.notBlank(e)&&!p(e)},t.whyExposureSettingsNotSimilar=function(e,t){if(null!=e&&null!=t)return o.firstDefinedThunk([()=>m({a:e,b:t,field:"focalLength",desc:"focal length",parser:c.extractFloat}),()=>m({a:e,b:t,field:"aperture",desc:"aperture",parser:c.extractFloat}),()=>m({a:e,b:t,field:"shutterSpeed",desc:"shutter speed",parser:c.extractFraction}),()=>m({a:e,b:t,field:"iso",desc:"ISO",parser:c.extractFloat})])},t.firstTagWithName=f,t.cameraId=function(e){return f(e,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"])},t.lensId=function(e){{const t=f(e,["LensSerialNumber","LensID"]);if(null!=t)return t}return r.map(h.extractLensMakeModel(e),(({lensMake:e,lensModel:t})=>`${e.toLowerCase()}/${t.toLowerCase()}`))},t.imageId=function(e){return f(e,["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"])},t.uidGeoHash=function(e,t){return u.geohash(s.toFixed(e,4),s.toFixed(t,4))}},94435:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractExposureSettings=void 0;const n=i(39938),r=i(61570),s=i(7162),a=i(70283),o=s.mkLogger("ExposureSettings");t.extractExposureSettings=function(e){const t={focalLength:e.FocalLength,iso:a.firstNonZero(e.ISO,e.ISOSpeed,e.SonyISO),aperture:a.firstNonZero(e.FNumber,e.Fnumber,e.ApertureValue,e.SonyFNumber),shutterSpeed:n.firstNotBlank(e.ExposureTime,e.ShutterSpeed,e.SonyExposureTime)};return o.debug("extracted from "+e.FileName,{exposureSettings:t}),r.reqValuedOrElse(t)}},22766:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSupportedByOldBrowserExt=t.isSupportedByCurrentBrowserExt=t.isExifExt=t.isAssetFileExt=t.isSidecarExt=t.isVideoExt=t.isSharpExt=t.isRawImageExt=t.mimeRootType=t.isExtType=t.normalizeExt=t.extTypes=t.ExtTypes=t.fileExtsToDesc=void 0;const n=i(11944),r=i(11448),s=i(66776),a=i(84253),o=i(82798),l=i(12651),u=i(48262);t.fileExtsToDesc=[[["360"],"GoPro 360 video (QuickTime-based)"],[["3FR"],"Hasselblad RAW (TIFF-based)"],[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["AVIF"],"AV1 Image File Format (QuickTime-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["CZI"],"Zeiss Integrated Software RAW (ZISRAW)"],[["DCP"],"DNG Camera Profile (DNG-like)"],[["DCR"],"Kodak Digital Camera RAW (TIFF-based)"],[["DNG"],"Digital Negative (TIFF-based)"],[["DV"],"Digital Video"],[["ERF"],"Epson RAW Format (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["FFF"],"Hasselblad Flexible File Format (TIFF-based)"],[["FFF"],"FLIR Systems thermal image File Format"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HDP","WDP","JXR"],"Windows HD Photo / Media Photo / JPEG XR (TIFF-based)"],[["HDR"],"Radiance RGBE High Dynamic-Range"],[["HEIC","HEIF","HIF"],"High Efficiency Image Format (QuickTime-based)"],[["IIQ"],"Phase One Intelligent Image Quality RAW (TIFF-based)"],[["INSP"],"Insta360 Picture (JPEG-based)"],[["INSV"],"Insta360 Video (QuickTime-based)"],[["J2C","J2K","JPC"],"JPEG 2000 codestream"],[["JP2","JPF","JPM","JPX"],"JPEG 2000 image [Compound/Extended]"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PEF"],"Pentax (RAW) Electronic Format (TIFF-based)"],[["PNG","JNG","MNG"],"Portable/JPEG/Multiple-image Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Kyocera Contax N Digital RAW"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["X3F"],"Sigma/Foveon RAW"],[["XMP"],"Extensible Metadata Platform sidecar file"]],t.ExtTypes=a.strEnum("RawImage","Sharp","Video","Sidecar","AssetFile","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser");const c=r.lazy((()=>{const e=new l.MultiMap,i=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"];for(const n of i)e.add(n,t.ExtTypes.RawImage);const r=n.compact(["GIF","JPEG","PNG","PPM","TIFF","WEBP"]);for(const i of r)e.add(i,t.ExtTypes.Sharp);const s=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"];for(const i of s)e.add(i,t.ExtTypes.Video);const a=[...r,"HEIC",...i,...s];for(const i of a)e.add(i,t.ExtTypes.AssetFile);for(const i of u.SidecarExts)e.add(i,t.ExtTypes.Sidecar);for(const i of[...a,...u.SidecarExts])e.add(i,t.ExtTypes.Exif);for(const i of["GIF","JPEG","MP4","PNG","WEBM","WEBP"])e.add(i,t.ExtTypes.SupportedByCurrentBrowser);for(const i of["GIF","JPEG","MP4","PNG"])e.add(i,t.ExtTypes.SupportedByOldBrowser);const o=t.fileExtsToDesc.map((e=>e[0]));for(const t of e.keys()){const i=o.find((e=>e.includes(t)));if(null!=i&&i.length>0){const n=e.get(t);for(const t of i)e.has(t)||e.set(t,n)}}return e}));function d(e){return s.map(p(e),(e=>c().get(e)))}t.extTypes=d;const h=/\.?([a-z0-9]{2,4})$/i;function p(e){return s.map(h.exec(o.toS(e)),(e=>e[1].toUpperCase()))}function m(e,t){return s.mapOr(d(e),(e=>e.includes(t)),(()=>!1))}t.normalizeExt=p,t.isExtType=m,t.mimeRootType=function(e){const i=d(e);return null==i?void 0:i.includes(t.ExtTypes.Sharp)||i.includes(t.ExtTypes.RawImage)?"image":i.includes(t.ExtTypes.Video)?"video":void 0},t.isRawImageExt=function(e){return m(e,t.ExtTypes.RawImage)},t.isSharpExt=function(e){return m(e,t.ExtTypes.Sharp)},t.isVideoExt=function(e){return m(e,t.ExtTypes.Video)},t.isSidecarExt=function(e){return m(e,t.ExtTypes.Sidecar)},t.isAssetFileExt=function(e){return m(e,t.ExtTypes.AssetFile)},t.isExifExt=function(e){return m(e,t.ExtTypes.Exif)},t.isSupportedByCurrentBrowserExt=function(e){return m(e,t.ExtTypes.SupportedByCurrentBrowser)},t.isSupportedByOldBrowserExt=function(e){return m(e,t.ExtTypes.SupportedByOldBrowser)}},71932:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readJsonSidecar=void 0;const n=i(11944),r=i(39938),s=i(75556),a=i(61570),o=i(26588),l=i(39784),u=i(13779),c=i(38625),d=i(45161),h=i(85563);function p(e){return s.mapInt(null==e?void 0:e.timestamp,(e=>d.mapValidDate(new Date(1e3*e),(e=>e))))}t.readJsonSidecar=async function(e){return o.thenMap(e.readJson("info"),(e=>{var t,i,o,d,m,f;return a.compactValues({Title:r.ifNotBlank(e.title),Description:r.ifNotBlank(e.description),GPSLatitude:u.first([null===(t=null==e?void 0:e.geoData)||void 0===t?void 0:t.latitude,null===(i=null==e?void 0:e.geoData)||void 0===i?void 0:i.latitude],(e=>h.validLat(e)?e:void 0)),GPSLongitude:u.first([null===(o=null==e?void 0:e.geoData)||void 0===o?void 0:o.longitude,null===(d=null==e?void 0:e.geoData)||void 0===d?void 0:d.longitude],(e=>h.validLon(e)?e:void 0)),GPSAltitude:u.first([null===(m=null==e?void 0:e.geoData)||void 0===m?void 0:m.altitude,null===(f=null==e?void 0:e.geoData)||void 0===f?void 0:f.altitude],(e=>s.isNumber(e)?e:void 0)),favorited:null==e.favorited?void 0:c.isTrue(e.favorited),peopleNames:n.mapNotEmpty([...l.toA(e.people),...l.toA(e.person)],(e=>n.compactBlanks(e.map((e=>e.name))))),creationTime:p(e.creationTime),modificationTime:p(e.modificationTime),photoTakenTime:p(e.photoTakenTime),imageViews:s.mapInt(e.imageViews,(e=>e))})}))}},91854:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeLensModel=t.cleanBogusPrecision=t.justLengthAndAperture=t.extractLensMakeModel=void 0;const n=i(11944),r=i(39938),s=i(11448),a=i(66776),o=i(75556),l=i(82798),u=i(13779),c=i(7162),d=i(43414),h=i(91464),p=i(54988),m=/\b(n\/a|unknown)\b/i,f=s.lazy((()=>c.mkLogger("LensMakeModel")));function g(e){var t,i;if(r.blank(e)||l.toS(e).toLowerCase().includes("unknown"))return;const n=v(e.replace(/\b(AF-S|DG|Digital|DI|DX|E|ED|HSM|LM|OIS|Pro|R|XF)\b/gi,"")),s=null===(t=/[\d.-]+mm/.exec(n))||void 0===t?void 0:t[0],o=null===(i=/f\/[\d.-]+/.exec(n))||void 0===i?void 0:i[0];return"0mm"!==s&&"f/0"!==o?a.map2(s,o,((e,t)=>`${e} ${t}`)):void 0}function y(e,t=3){return e.replace(/\d+\.\d+/g,(e=>a.mapOr(o.toFloat(e),(e=>String(o.sigFigs(e,t))),e)))}function v(e){return y(e).replace(/(\d) - (\d)/g,((e,t,i)=>`${t}-${i}`)).replace(/(\d)\s+mm\b/,((e,t)=>t+"mm")).replace(/\s+f\/?(\d)/i,((e,t)=>" f/"+t))}t.extractLensMakeModel=function(e){const t=p.make(e.LensMake),i=p.make(e.Make),s=[t,e.LensMake,i,e.Make].filter((e=>r.notBlank(e)&&null==m.exec(e))),a=e=>(e=y(e),s.reduce(((e,t)=>h.stripPrefixIgnoreCase(e,t).trim()),e)),o=u.first([e.LensInfo,e.LensSpec,e.LensModel,e.LensID],g),l=n.uniq([e.LensID,e.LensModel,e.LensSpec,e.LensInfo,e.LensType]);f().debug("extractLensMakeModel",{lensMake:t,lensInfo:o,lensModels:l});for(const e of l){const l=null!=g(e);if(f().debug("extractLensMakeModel",{lensModel:e,hasLengthAndAperture:l}),l){if(r.notBlank(t))return{lensMake:t,lensModel:a(e),lensInfo:o};if(e.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:a(e),lensInfo:o};for(const r of n.compactBlanks([t,i,...d.Settings.lensMakes.values]))if(e.toLowerCase().includes(r.toLowerCase()))return s.unshift(r),{lensMake:r,lensModel:a(e),lensInfo:o}}}},t.justLengthAndAperture=g,t.cleanBogusPrecision=y,t.normalizeLensModel=v},54988:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.model=t.make=t.companyCased=void 0;const n=i(39938),r=i(11448),s=i(66776),a=i(1058),o=i(91464);function l(e,t,i=""){const n=e.replace(t,i);return n===e?e:l(n,t,i)}const u=new Map(["BenQ","GoPro","HTC","LG","NEC","OnePlus","Sony","TrueHDR"].map((e=>[e.toLowerCase(),e])));function c(e){const t=e.trim(),i=u.get(t.toLowerCase());return null!=i?i:t.length<4?t:t.toLowerCase().replace(/(?:^|\s|-)\S/g,(e=>e.toUpperCase()))}t.companyCased=c;class d{constructor(){this.ignorables=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|"),this.ignorableSep="[\\s\\.,_-]*",this.IgnorableMakePatterns=new RegExp(`${this.ignorableSep}(?:${this.ignorables})${this.ignorableSep}$`,"i"),this.IgnorableModelPatterns=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i],this.samsungPatterns=[[/^PL150 /,"PL150"],[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-G98[01]/,"Galaxy S20"],[/^SM-G98[56]/,"Galaxy S20+"],[/^SM-G988/,"Galaxy S20 Ultra"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]],this.lgPatterns=[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]],this.onePlusPatterns=[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]],this.CommonNamesByMake={Samsung:this.samsungPatterns,LG:this.lgPatterns,OnePlus:this.onePlusPatterns}}}const h=r.lazy((()=>new d));t.make=function(e){return n.mapNotBlank(e,(e=>c(e=(e=(e=l(e=o.stripQuotes(e),h().IgnorableMakePatterns)).replace(/\s+app on Apple iDevice$/i,"")).replace(/\bLGE\b/,"LG"))))};const p=/<(.+?)[,/].+>/;t.model=function(e,t){if(n.blank(e)||n.blank(t))return;let i=o.stripQuotes(t);if("Samsung"===e){const e=p.exec(i);null!=e&&(i=e[1])}const r=s.map(h().CommonNamesByMake[e],(e=>e.find((([e])=>null!=i.match(e)))));if(null!=r)return r[1].trim();"Sony"===e&&(i=i.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"Î±").replace(/7CL/i,"7c").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V").replace(/M6$/," VI").replace(/M7$/," VII").replace(/M8$/," VIII").replace(/M9$/," IX").replace(/M10$/," X").replace(/M11$/," XI")),"Olympus"===e&&(i=s.mapOr(/^(.+?\d)mark(i.+?)$/i.exec(i),(e=>`${e[1]} Mark ${e[2]}`),(()=>i))),"Canon"===e&&(i=i.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel"));for(const e of h().IgnorableModelPatterns)i=l(i,e).trim();return i=i.replace(new RegExp(`^${a.escapeRegExp(e)}\\s+`,"i"),""),null!=e.match(/^HP|Hewlett.Packard$/i)&&null!=i.match(/^hp\b/i)&&(i=i.slice(2).trim()),i}},23199:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isMimetypeSupported=t.isLibrawMimetype=t.isSharpMimetype=void 0;const n=i(82798),r=i(96518),s=["image/gif","image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"];t.isSharpMimetype=function(e){return s.includes(n.toS(e).toLowerCase())};const a=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-cr3","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);t.isLibrawMimetype=function(e){return a.has(n.toS(e).toLowerCase())};const o=["image/gif","image/jpeg","image/pjpeg","image/png","image/webp"],l=["image/gif","image/jpeg","image/png"];t.isMimetypeSupported=function(e,t){return(r.isChrome(t)||r.isFirefox(t)?o:l).includes(n.toS(e))}},65308:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.renderNameTag=t.parseName=void 0;const n=i(11254),r=i(11944),s=i(39938),a=i(11448),o=i(66776),l=i(39784),u=i(7162),c=i(1058),d=i(43414),h=i(91464),p=a.lazy((()=>u.mkLogger("Names")));function m(e){return c.matchQuotes(c.escapeRegExp(e))}const f=/(\(\s*\d+\s*-\s*(?:[\d\?]{1,4})?\s*\)?)/,g=/(,?\s*(?:jr\.?|junior|sr.?|senior|i+\.?))$/i,y=/\b([A-Zââ']+(?:[-A-Zââ']{2}))\b/;function v(e){if(s.blank(e))return;let t=e.trim();const i=o.map(h.spliceCapture(t,f),(e=>(t=e.unmatched.trim(),e.captured.replace(/\s+/g,"")))),n=o.map(h.spliceCapture(t,g),(e=>(t=e.unmatched.trim(),e.captured.trim()))),a=[],u=[],v=[];for(const e of d.Settings.tagNamesGiven.values.map((e=>new RegExp("\\b("+m(e)+")\\b","i")))){const i=h.spliceCapture(t,e);null!=i&&(a.push(i.captured),t=i.unmatched.trim())}for(const e of function(){const e=r.compactBlanks(d.Settings.tagNamesGivenSurrounds.values);for(const t of e)2!==t.length&&p().warn("Settings.tagNamesFamilySurrounds has an invalid value:",t);return e.map((e=>new RegExp(`(${c.escapeRegExp(e.charAt(0))}\\s*[^${c.escapeRegExp(e.charAt(0))}]+\\s*${c.escapeRegExp(e.charAt(1))})`,"i")))}()){let i;do{i=h.spliceCapture(t,e),null!=i&&(u.push(i.captured),t=i.unmatched.trim())}while(null!=i)}let w;function b(e){(null==w||w>e.matchedIndex)&&(w=e.matchedIndex)}if(d.Settings.tagNamesCapitalizedAsFamily.valueOrDefault){let e;do{e=h.spliceCapture(t,y),null!=e&&(b(e),v.push(e.captured),t=e.unmatched.trim())}while(null!=e)}for(const e of function(){const e=r.compactBlanks(d.Settings.tagNamesFamilySurrounds.values);for(const t of e)2!==t.length&&p().warn("Settings.tagNamesFamilySurrounds has an invalid value:",t);return e.map((e=>new RegExp(`${c.escapeRegExp(e.charAt(0))}\\s*([^${c.escapeRegExp(e.charAt(0))}]*)\\s*${c.escapeRegExp(e.charAt(1))}`,"i")))}()){let i;do{i=h.spliceCapture(t,e),null!=i&&(b(i),v.push(i.captured),t=i.unmatched.trim())}while(null!=i)}if(d.Settings.tagNamesLexical.valueOrDefault){const e=t.indexOf(",");e>=0&&(w=void 0,v.push(t.substring(0,e).trim()),a.push(t.substring(e+1).trim()),t="")}for(const e of d.Settings.tagNamesSurnames.values.map((e=>new RegExp("\\b("+m(e)+")\\b","i")))){const i=h.spliceCapture(t,e);null!=i&&(b(i),v.push(i.captured),t=i.unmatched.trim())}for(const e of l.toA(r.mapNotEmpty(r.compactBlanks(d.Settings.tagNamesSurnamePrefixes.values),(e=>r.sortBy(e,(e=>-e.length)).map((e=>new RegExp(`\\b(${m(e)}\\s+\\S+)`,"i"))))))){const i=h.spliceCapture(t,e);null!=i&&(b(i),v.push(i.captured),t=i.unmatched.trim())}null!=w&&t.length>w&&r.mapNotEmpty(r.compactBlanks(t.substr(w).split(/\s+/)),(e=>{v.push(...e),t=t.substr(0,w)}));const S=r.compactBlanks(t.split(/\s+/)),M=a.length,P=v.length;if(S.length>0)if(0===M&&P>0)a.push(...S);else if(0===P&&M>0&&1===S.length)v.push(...S);else if(1===S.length)a.push(...S);else{const e="western"===d.Settings.tagNamesOrder.valueOrDefault;v.push(e?S.pop():S.shift()),a.push(...S)}return{givenNames:r.uniq(r.compactBlanks([...a,...u])),modifier:n,lifespan:i,familyNames:r.uniq(r.compactBlanks(v))}}function w(e){return r.compactBlanks(e).join(" ")}t.parseName=v,t.renderNameTag=function(e){if(s.blank(e))return[];if("family/given"===d.Settings.tagNamesFormatter.valueOrDefault){const t=v(e);if(null==t)return[];{const e=w([w(t.givenNames)+s.mapNotBlankOr(t.modifier,(e=>e.startsWith(",")?e:" "+e.trim()),""),t.lifespan]);return r.compactBlanks(r.notEmptyOr(t.familyNames,[d.Settings.tagNamesDefaultFamily.valueOrDefault])).map((t=>[n.TagRoots.Who,t,e]))}}return[[n.TagRoots.Who,e.trim()]]}},84685:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rotationToWriteTag=t.rotationToExifOrientation=t.orientationToRotation=t.extractRotation=void 0;const n=i(66776),r=i(33714),s=i(15271),a=i(2023);t.extractRotation=function(e){return n.map(e,(e=>a.firstThunk((()=>l(e.Orientation)),(()=>l(e.CameraOrientation)),(()=>r.normalizeRotation(e.Rotation)))))};const o=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function l(e){return n.map(e,(e=>o.get(e)))}t.orientationToRotation=l;const u=new Map([[0,1],[90,6],[180,3],[270,8]]);function c(e){return n.map(e,(e=>u.get(e)))}t.rotationToExifOrientation=c,t.rotationToWriteTag=function(e,t){return n.map(r.normalizeRotation(e),(e=>s.isVideoMimeType(t)?{Rotation:e}:n.map(c(e),(e=>({"Orientation#":e})))))}},48262:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidecarExts=void 0,t.SidecarExts=["EXIF","EXV","MIE","XMP"]},68107:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractSizeInfo=void 0;const n=i(57743),r=i(11448),s=i(75556),a=i(13779),o=i(7162),l=r.lazy((()=>o.mkLogger("SizeInfo")));t.extractSizeInfo=function(e,t,i){const r=a.first([null==i?void 0:i.ImageSize,{width:e.ImageWidth,height:e.ImageHeight}],(e=>n.isDimensions(e)?e:void 0));if(l().debug("extractSizeInfo()",{filename:e.FileName,mimetype:e.MIMEType,rawInfo:i,fileDimensions:r}),null==r)return;const o=n.maybeFlip(r,t),u=s.sigFigs(o.width/o.height,5);return{ImageHeight:o.height,ImageWidth:o.width,aspectRatio:u,dimensions:o,rotation:t,fileDimensions:r}}},26352:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractStatBname=t.nearestSiblingTzOffset=t.nearestSiblings=t.bname=t.inferCapturedAtFromSiblings=t.inferMakeAndModel=void 0;const n=i(11944),r=i(39938),s=i(88491),a=i(43947),o=i(11448),l=i(66776),u=i(98510),c=i(39784),d=i(82798),h=i(13779),p=i(46852),m=i(44665),f=i(45161),g=i(79015),y=i(51498),v=i(64974),w=i(98250),b=i(7162),S=i(91464),M=i(2073),P=i(6646),E=i(65642),T=i(44546),x=i(22766),D=o.lazy((()=>b.mkLogger("TagInference")));async function C(e,t=7){return h.firstAsync(c.toA(e).slice(0,t),((e,t)=>p.thenMap(T.readRawTags(e),(e=>p.thenMap(E.capturedAtFromTags(e),(e=>({...e,index:t})))))))}async function k(e,t=7){return h.firstAsync(e.slice(0,t),((e,t)=>p.thenMap(T.readRawTags(e),(e=>p.thenMap(E.capturedAtFromTags(e),(e=>u.opt(e).filter((e=>f.hasZone(e.date))).flatMap((e=>f.getZoneName(e.date))).map((e=>({zoneName:e,index:t}))).get()))))))}t.inferMakeAndModel=async function(e,t){if(r.notBlank(t.Make)&&r.notBlank(t.Model))return;if(r.blank(t.Make)&&(d.toS(t.HandlerDescription)+d.toS(t.CompressorName)).includes("GoPro"))return void(t.Make="GoPro");const i=O(e),s=await _(e);if(null==s)return;const a=n.compact(n.flatten(h.zip(s.younger,s.older))).slice(0,50).filter((e=>M.diceCoeff(O(e),i)>.7)).slice(0,10);D().info("inferMakeAndModel("+e+"): looking at nearby siblings",a.map((e=>e.base)));for(const i of a){const n=await T.readRawTags(i);if(null!=n&&h.allNotBlank(n.Make,n.Model))return D().info("inferMakeAndModel("+e+")",{sibling:i.base,Make:n.Make,Model:n.Model}),t.Make=n.Make,void(t.Model=n.Model)}},t.inferCapturedAtFromSiblings=async function(e){return p.thenMap(function(e){return I().getOrSet(e.nativePath,(async()=>{const t=await _(e),i=await C(null==t?void 0:t.younger),n=await C(null==t?void 0:t.older);return null==i||null==n?void 0:{before:i,after:n,index:i.index,slots:i.index+n.index+1}}))}(e),(({before:t,after:i,index:n,slots:r})=>{if(f.sameDay(t.date,i.date))return l.map(m.DateInterval.for(t.date,i.date,n,r),(e=>({date:e,src:`before:${t.src},after:${i.src}`})));D().debug("inferCapturedAtFromSiblings(): rejecting, not same day",{file:e.nativePath,before:d.toS(t),after:d.toS(i)})}))},a.later((()=>g.onClearCache((()=>{var e;return null===(e=I.prior())||void 0===e?void 0:e.clear()}))));const I=o.lazy((()=>new y.FifoCache(1024)));a.later((()=>g.onClearCache((()=>{var e;return null===(e=F.prior())||void 0===e?void 0:e.clear()}))));const F=o.lazy((()=>new y.FifoCache(2048,s.minuteMs)));function O(e){let t=S.isString(e)?e:e.name;return F().getOrSet(t,(()=>(l.map(/(?:burst)(.{8,})$/i.exec(t),(e=>t=e[1])),l.map(/^(?:(?:dsc[0f]?|img|mov|mvi|mvimg|vid|gpfr|gopro?|gp|gf|p)(?:[-_ ])?)(\S.+)$/i.exec(t),(e=>t=e[1])),t.replace(/\s*-?\s*copy( \(?\d+\)?)?\s*$/i,"").replace(/\s*\((another |\d+[a-z]{2} )?copy\)\s*$/i,"").replace(/^[-\s_0]+/,"").replace(/[\s-_][\d\s]{0,2}$/,"").replace(/_cover$/i,"").toLowerCase().normalize())))}t.bname=O;const A=v.extFilter(x.ExtTypes.AssetFile);async function _(e,t=7){const i=await e.parent().childDirectoryEntries((e=>e.isFile()&&!e.name.startsWith(".")&&!x.isSidecarExt(e.ext)&&A.apply(e)));if(null==i)return void D().info("nearestSiblings(): can't readdir parent, "+e.parent());const r=await e.statTimes();if(n.isEmpty(r))return void D().info("nearestSiblings(): statTimes() missing from "+e);const s=n.sortBy(i,(e=>O(e))),a=s.findIndex((t=>t.base===e.base));if(a<0)return void D().warn("nearestSiblings(): can't find self in siblings: "+e);const[o,l]=[s.slice(a-2*t,a),s.slice(a+1,a+1+2*t)],u=[],c=[];for(;n.isNotEmpty(o)&&u.length<t;){const t=w.PosixFile.forDirectoryEntry(o.pop());await L(e,t)&&u.push(t)}for(;n.isNotEmpty(l)&&c.length<t;){const t=w.PosixFile.forDirectoryEntry(l.shift());await L(e,t)&&c.push(t)}return{younger:u,older:c}}function L(e,t,i=2*s.dayMs){const n=f.diffMillis(f.parseYMD(e.base),f.parseYMD(t.base));return!(null!=n&&Math.abs(n)>i)&&e.contemporary(t,i)}t.nearestSiblings=_,t.nearestSiblingTzOffset=async function(e){const t=await _(e),i=h.flatZip(c.toA(null==t?void 0:t.younger),c.toA(null==t?void 0:t.older)).slice(0,10);return D().tap({msg:"nearestSiblingTzOffset("+e+")",result:await p.thenMap(k(i),(e=>e.zoneName)),meta:{zipped:i}})},t.extractStatBname=async function(e){const t=f.parseDateTime(O(e)),i=l.map(t,f.datedToMillis);if(null==t||null==i)return void D().debug("extractStatBname() bname isn't dated",{bname:O(e),fromName:t,fromNameMs:i});const n=await e.stat();if(null!=n)return D().tap({msg:"extractStatBname()",result:h.first(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],(e=>Math.abs(n[e]-i)<P.MaxTzOffsetHours?{src:e,date:t}:void 0)),meta:{fromName:t,fromNameMs:i,stat:n}});D().debug("extractStatBname() no stat",{fromName:t,fromNameMs:i})}},45023:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractTitleDescription=void 0;const n=i(11944),r=i(39938),s=i(61570),a=i(82798);t.extractTitleDescription=function(e){const t=n.uniq(["OLYMPUS DIGITAL CAMERA",e.originalMake,e.originalModel,e.Model,e.Make,e.CameraID]).map((e=>r.mapNotBlank(e,(e=>e.trim().toLowerCase().normalize())))),i=(...i)=>{for(const n of i){const i=a.toS(e[n]).trim();if(r.notBlank(i)&&!t.includes(i.toLowerCase().normalize()))return i}};return s.compactValues({title:i("XPTitle","Title","ObjectName"),description:i("XPSubject","Description","ImageDescription","Caption-Abstract")})}},3874:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uri2nativePath=t.uriVariants=t.nativePath2uriVariants=t.nativePath2uris=t.nativePath2uri=void 0;const n=i(11944),r=i(39938),s=i(11448),a=i(39784),o=i(49049),l=i(64975),u=i(46852),c=i(7162),d=i(46573),h=i(26682),p=i(55713),m=i(30848),f=i(19209),g=i(25116),y=s.lazy((()=>c.mkLogger("FileURI")));async function v(e){const t=await d.volumeFor(e);return u.thenCompact([p.nativePath2pslib(e),h.nativePath2psfile(e,t),m.nativePath2psnet(e,t),f.URI.file(e)])}async function w(e){const t=await v(e);return n.uniq(n.flatten(t.map(g.uriEncodingVariants)))}async function b(e,t){if(r.blank(e))return;const i=function(e){try{return f.URI.isUri(e)?e:f.URI.parse(e,!0)}catch(t){return void y().warn("bad URI",{uri:e,err:t})}}(e);if(null!=i)switch(i.scheme){case"file":return i.fsPath;case o.PS_LOCAL_FILE_PROTOCOL:return h.psfile2nativePath(i,t);case o.PS_NETWORK_FILESYSTEM_PROTOCOL:return m.psnet2nativePath(i,t);case o.PS_LIBRARY_PROTOCOL:return p.pslib2nativePath(i);default:throw new Error("unsupported URI: "+e)}}t.nativePath2uri=async function(e,t){if(null==e||r.blank(e))return y().throw("empty nativePath passed to nativePath2uri()",{retriable:!1});const i=s.lazy((()=>u.thenOrElse(t,(()=>d.volumeFor(e)))));return l.firstDefinedLater((()=>p.nativePath2pslib(e)),(async()=>h.nativePath2psfile(e,await i())),(async()=>m.nativePath2psnet(e,await i())),(()=>f.URI.file(e)))},t.nativePath2uris=v,t.nativePath2uriVariants=w,t.uriVariants=async function(e,t){const i=g.uriEncodingVariants(e);return i.push(...a.toA(await u.thenMap(b(e,t),w))),n.uniq(i)},t.uri2nativePath=b},19209:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toURI=t.uriToFsPath=t.encodeURIComponentFast=t.URI=void 0;const n=i(85622),r=i(94213),s=i(31669),a=i(39938),o=i(66776),l=i(44726),u=i(13779),c=i(99312),d=/^\w[\w\d+.-]*$/,h=/^\//,p=/^\/\//,m="",f="/",g=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class y{constructor(e,t,i,n,r,s=!1){"object"==typeof e?(this.scheme=e.scheme||m,this.authority=e.authority||m,this.path=e.path||m,this.query=e.query||m,this.fragment=e.fragment||m):(this.scheme=function(e,t){return e||t?e:"file"}(e,s),this.authority=o.orElse(t,m),this.path=function(e,t){switch(e){case"https":case"http":case"file":t?t[0]!==f&&(t=f+t):t=f}return t}(this.scheme,o.orElse(i,m)),this.query=o.orElse(n,m),this.fragment=o.orElse(r,m),function(e,t){if(!e.scheme&&!0===t)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${e.authority}", path: "${e.path}", query: "${e.query}", fragment: "${e.fragment}"}`);if(e.scheme&&!d.test(e.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(e.path)if(e.authority){if(!h.test(e.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(p.test(e.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}(this,s))}static isUri(e){return e instanceof y||null!=e&&"string"==typeof e.authority&&"string"==typeof e.fragment&&"string"==typeof e.path&&"string"==typeof e.query&&"string"==typeof e.scheme&&"function"==typeof e.fsPath&&"function"==typeof e.with&&"function"==typeof e.toString}get fsPath(){return P(this,!1)}with(e){if(null==e)return this;let{scheme:t,authority:i,path:n,query:r,fragment:s}=e;return void 0===t?t=this.scheme:null===t&&(t=m),void 0===i?i=this.authority:null===i&&(i=m),void 0===n?n=this.path:null===n&&(n=m),void 0===r?r=this.query:null===r&&(r=m),void 0===s?s=this.fragment:null===s&&(s=m),t===this.scheme&&i===this.authority&&n===this.path&&r===this.query&&s===this.fragment?this:new w(t,i,n,r,s)}static parse(e,t=!1){const i=g.exec(e);if(!i)return new w(m,m,m,m,m);const n=i[2]||m,r=D(i[4]||m),s=(i[5]||m).split("/").map(D).join("/"),a="psfile"===n&&s.startsWith("//")?s.slice(1):s,o=D(i[7]||m),l=D(i[9]||m);return new w(n,r,a,o,l,t)}static file(e){let t=m;if(c.isWin&&(e=e.replace(/\\/g,f)),e[0]===f&&e[1]===f){const i=e.indexOf(f,2);-1===i?(t=e.substring(2),e=f):(t=e.substring(2,i),e=e.substring(i)||f)}return new w("file",t,e,m,m)}static from(e){return new w(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...t){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let i;return i=c.isWin&&"file"===e.scheme?y.file(n.win32.join(P(e,!0),...t)).path:n.posix.join(e.path,...t),e.with({path:i})}isRootPath(){return null==this.path||this.path===f}get pathBase(){return this.isRootPath()?"":o.map(this.path,(e=>u.findLast(e.split(f),a.notBlank)))}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(f))})}join(...e){return this.with({path:l.ensureSuffix(this.path,f)+e.join(f)})}toString(e=!1){return E(this,e)}toJSON(){return this}[s.inspect.custom](){return this.toString()}}t.URI=y;const v=c.isWinPortable?1:void 0;class w extends y{constructor(){super(...arguments),this._formatted=null,this._fsPath=null}get fsPath(){return null==this._fsPath&&(this._fsPath=P(this,!1)),this._fsPath}toString(e=!1){return e?E(this,!0):(null==this._formatted&&(this._formatted=E(this,!1)),this._formatted)}toJSON(){const e={$mid:1};return null!=this._fsPath&&(e.fsPath=this._fsPath,e._sep=v),null!=this._formatted&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),this.query&&(e.query=this.query),this.fragment&&(e.fragment=this.fragment),e}}const b={58:"%3A",47:"%2F",63:"%3F",35:"%23",91:"%5B",93:"%5D",64:"%40",33:"%21",36:"%24",38:"%26",39:"%27",40:"%28",41:"%29",42:"%2A",43:"%2B",44:"%2C",59:"%3B",61:"%3D",32:"%20"};function S(e,t){let i,n=-1;for(let r=0;r<e.length;r++){const s=e.charCodeAt(r);if(s>=97&&s<=122||s>=65&&s<=90||s>=48&&s<=57||45===s||46===s||95===s||126===s||t&&47===s)-1!==n&&(i+=encodeURIComponent(e.substring(n,r)),n=-1),void 0!==i&&(i+=e.charAt(r));else{void 0===i&&(i=e.substr(0,r));const t=b[s];void 0!==t?(-1!==n&&(i+=encodeURIComponent(e.substring(n,r)),n=-1),i+=t):-1===n&&(n=r)}}return-1!==n&&(i+=encodeURIComponent(e.substring(n))),void 0!==i?i:e}function M(e){let t;for(let i=0;i<e.length;i++){const n=e.charCodeAt(i);35===n||63===n?(void 0===t&&(t=e.substr(0,i)),t+=b[n]):void 0!==t&&(t+=e[i])}return void 0!==t?t:e}function P(e,t){let i;return i=e.authority&&e.path.length>1&&"file"===e.scheme?`//${e.authority}${e.path}`:47===e.path.charCodeAt(0)&&(e.path.charCodeAt(1)>=65&&e.path.charCodeAt(1)<=90||e.path.charCodeAt(1)>=97&&e.path.charCodeAt(1)<=122)&&58===e.path.charCodeAt(2)?t?e.path.substr(1):e.path[1].toLowerCase()+e.path.substr(2):e.path,c.isWin&&(i=i.replace(/\//g,"\\")),i}function E(e,t){const i=t?M:S;let n="";const{scheme:r,query:s,fragment:a}=e;let{authority:o,path:l}=e;if(r&&(n+=r,n+=":"),(o||"file"===r)&&(n+=f,n+=f),o){let e=o.indexOf("@");if(-1!==e){const t=o.substr(0,e);o=o.substr(e+1),e=t.indexOf(":"),-1===e?n+=i(t,!1):(n+=i(t.substr(0,e),!1),n+=":",n+=i(t.substr(e+1),!1)),n+="@"}e=o.indexOf(":"),-1===e?n+=i(o,!1):(n+=i(o.substr(0,e),!1),n+=o.substr(e))}if(l){if(l.length>=3&&47===l.charCodeAt(0)&&58===l.charCodeAt(2)){const e=l.charCodeAt(1);e>=65&&e<=90&&(l=`/${String.fromCharCode(e+32)}:${l.substr(3)}`)}else if(l.length>=2&&58===l.charCodeAt(1)){const e=l.charCodeAt(0);e>=65&&e<=90&&(l=`${String.fromCharCode(e+32)}:${l.substr(2)}`)}n+=i(l,!0)}return s&&(n+="?",n+=i(s,!1)),a&&(n+="#",n+=t?a:S(a,!1)),n}function T(e){try{return decodeURIComponent(e)}catch{return e.length>3?e.substr(0,3)+T(e.substr(3)):e}}t.encodeURIComponentFast=S,t.uriToFsPath=P;const x=/(%[0-9A-Za-z][0-9A-Za-z])+/g;function D(e){return e.startsWith("xn--")?r.toUnicode(e):e.match(x)?e.replace(x,(e=>T(e))):e}t.toURI=function(e){return y.isUri(e)?e:y.parse(e)}},25116:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uriEncodingVariants=t.uriIsEquivalent=t.uriEqlSync=t.normalizeURI=t.isUri=void 0;const n=i(11944),r=i(24603),s=i(11448),a=i(82798),o=i(49049),l=i(46852),u=i(7162),c=i(3874),d=i(19209),h=["http:","https:","file:",o.PS_LOCAL_FILE_PROTOCOL,o.PS_NETWORK_FILESYSTEM_PROTOCOL].map((e=>e+"//"));t.isUri=function(e){const t=a.toS(e).toLowerCase();return h.some((e=>t.startsWith(e)))};const p=s.lazy((()=>u.mkLogger("UriNormalization")));function m(e,t){try{if(null==e||null==t)return!1;const i=d.URI.parse(e),n=d.URI.parse(t);return i.scheme===n.scheme&&i.authority===n.authority&&i.path.normalize()===n.path.normalize()}catch{return!1}}t.normalizeURI=function(e){try{return d.URI.parse(e).toString()}catch(t){return p().warn("Failed to normalize invalid URI",{uri:e,err:t}),e}},t.uriEqlSync=m,t.uriIsEquivalent=async function(e,t){try{if(null==e||null==t)return!1;if(r.eql(e,t))return!0;const i=e.toString(),n=t.toString();return!!m(i,n)||await l.thenMap2Or(c.uri2nativePath(i),c.uri2nativePath(n),((e,t)=>e.normalize()===t.normalize()),(()=>!1))}catch{return!1}},t.uriEncodingVariants=function(e){const t=d.toURI(e);return n.uniq([t.toString(),t.with({path:t.path.normalize("NFC")}).toString(),t.with({path:t.path.normalize("NFD")}).toString()])}},26682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.psfile2nativePath=t.joinMountpoint=t.nativePath2psfile=t.mountpointToVolsha=t.volshaToMountpoint=t.volsha=void 0;const n=i(85622),r=i(39938),s=i(88491),a=i(43947),o=i(11448),l=i(44726),u=i(49049),c=i(46852),d=i(79015),h=i(59873),p=i(3955),m=i(48783),f=i(81765),g=i(46573),y=i(19209);function v(e,t){return n.join(e,...t.split("/").slice(1))}t.volsha=f.memoize((e=>r.mapNotBlank(e,h.shortStringSha)),{maxSize:128,ttlMs:s.minuteMs}),a.later((()=>{d.onClearCache((()=>{t.volshaToMountpoint.unset(),t.mountpointToVolsha.unset()})),g.volumes.onChange((()=>{t.volshaToMountpoint.unset(),t.mountpointToVolsha.unset()}))})),t.volshaToMountpoint=o.lazy((async()=>c.thenMap(g.volumes(),(e=>m.compactMap(e.map((e=>[t.volsha(e.uuid),e.mountpoint]))))))),t.mountpointToVolsha=o.lazy((()=>c.thenMap(t.volshaToMountpoint(),m.inverse))),t.nativePath2psfile=function(e,i){if(r.blank(e)||null==i||r.blank(i.uuid))return;const n=p.native2posix(e),s=p.native2posix(i.mountpoint);if(!n.normalize().startsWith(s.normalize()))return;const a=l.ensurePrefix(n.slice(s.length),"/");return y.URI.from({scheme:u.PS_LOCAL_FILE_PROTOCOL,authority:t.volsha(i.uuid),path:a})},t.joinMountpoint=v,t.psfile2nativePath=async function(e,i){if(e.scheme!==u.PS_LOCAL_FILE_PROTOCOL)throw new Error("invalid URI: "+e+" (bad scheme)");if(r.blank(e.authority))throw new Error("invalid URI: "+e+" (missing authority)");const s=null!=i&&i.includes(n.sep);if(s){const n=await g.volumeFor(i);if(null!=(null==n?void 0:n.uuid)&&t.volsha(n.uuid)===e.authority)return v(i,e.path)}const a=await c.thenMap(t.volshaToMountpoint(),(t=>t.get(e.authority)));return r.notBlank(a)?v(a,e.path):s?v(i,e.path):void 0}},55713:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pslib2nativePath=t.nativePath2pslib=t.PSLIB_ROOT_URI=void 0;const n=i(85622),r=i(39938),s=i(49049),a=i(3955),o=i(43414),l=i(19209);t.PSLIB_ROOT_URI=l.URI.from({scheme:s.PS_LIBRARY_PROTOCOL,path:""}),t.nativePath2pslib=function(e){const t=o.Settings.libraryPath.value;if(r.blank(t)||r.blank(e)||!e.startsWith(t))return;const i="/"+a.posixPathFrom({nativePath:t},{nativePath:e});return l.URI.from({scheme:s.PS_LIBRARY_PROTOCOL,path:i})},t.pslib2nativePath=function(e){if(e.scheme!==s.PS_LIBRARY_PROTOCOL)throw new Error("invalid URI: "+e+" (bad scheme)");const t=o.Settings.libraryPath.value;if(r.blank(t))throw new Error("invalid URI: "+e+" (no library set)");return n.join(t,...e.path.split("/"))}},30848:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.psnet2nativePath=t.nativePath2psnet=void 0;const n=i(85622),r=i(39938),s=i(39784),a=i(49049),o=i(3955),l=i(58659),u=i(99312),c=i(91464),d=i(46573),h=i(19209);t.nativePath2psnet=function(e,t){if(!r.blank(e))return null!=t&&!0===t.remote&&r.notBlank(t.remoteHost)&&r.notBlank(t.remoteShare)?h.URI.from({scheme:a.PS_NETWORK_FILESYSTEM_PROTOCOL,authority:t.remoteHost,path:n.posix.join("/"+t.remoteShare,c.stripPrefix(o.native2posix(e),o.native2posix(t.mountpoint)))}):e.startsWith("\\\\")?h.URI.file(e).with({scheme:a.PS_NETWORK_FILESYSTEM_PROTOCOL}):void 0},t.psnet2nativePath=async function(e,t){if(e.scheme!==a.PS_NETWORK_FILESYSTEM_PROTOCOL)throw new Error("invalid URI: "+e+" (bad scheme)");if(r.blank(e.authority))throw new Error("invalid URI: "+e+" (missing authority)");const i=e.path.split("/").slice(1),h=i[0];if(r.blank(h))throw new Error("invalid URI: "+e+" (missing share)");if(u.isWin)return`\\\\${e.authority}\\${i.join(n.sep)}`;const p=i.slice(1),m=await d.volumes();for(const t of s.toA(m))if(t.remote&&c.equalsIgnoreCase(t.remoteShare,h)&&await l.isEquivalentHost(e.authority,t.remoteHost))return n.join(t.mountpoint,...p);return await o.nativePathIsReadableDirectory(t)?n.join(t,...p):void 0}},69329:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosix=void 0;const n=i(46852),r=i(7903),s=i(36736),a=i(55412),o=a.lazyFsAsync("localMountpoints",(()=>n.thenMap(r.dfPosixRaw(!0),(e=>e.map((e=>e.mountpoint))))));t.dfPosix=a.lazyFsAsync("dfPosix",(async()=>{const e=await r.dfPosixRaw(!1);if(null!=e)return await n.thenMap(o(),(t=>{e.forEach((e=>{e.remote=!t.includes(e.mountpoint)}))})),await s.isGioSupported()&&await n.thenMap(s.gioVolumes(),(t=>e.push(...t))),e}))},7903:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosixRaw=void 0;const n=i(39938),r=i(75556),s=i(82798),a=i(69317),o=i(82128),l=i(99312),u=i(87824),c=i(53719);function d(e){return 1024*r.toInt(e,{defaultValue:0})}const h=l.isMac?["devfs"]:["udev","tmpfs","devtmpfs","shm"],p=["/boot/efi","/dev/shm"];t.dfPosixRaw=async function(e,t){const i=l.isMac?await u.ignorableMacFilesystems():[],r=["-k","-P"];e&&r.push("-l"),n.notBlank(t)&&r.push(t);const m=await a.stdout("df",r,{timeout:c.CmdTimeoutMs,ignoreStderr:!0,ignoreExitCode:!0});return o.parseFixed(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],m).map((e=>({filesystem:e.Filesystem,size:d(e["1024-blocks"]),used:d(e.Used),available:d(e.Available),mountpoint:e["Mounted on"]}))).filter((e=>{const t=s.toS(e.filesystem),r=s.toS(e.mountpoint);return n.notBlank(r)&&!p.includes(r)&&n.notBlank(t)&&!i.includes(t)&&!h.includes(t)}))}},69551:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.volumeInfoWin=t.GetVolume=t.GetPsDrive=t.dfWin=void 0;const n=i(11944),r=i(39938),s=i(11448),a=i(66776),o=i(75556),l=i(61570),u=i(26588),c=i(82798),d=i(10408),h=i(7162),p=i(71663),m=i(91464),f=i(55412),g=i(76019),y=s.lazy((()=>h.mkLogger("DfWin")));t.dfWin=f.lazyFsAsync("dfWin",(async()=>(await w()).filter((e=>!1!==e.ok&&o.gt0(e.size))))),t.GetPsDrive="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free",t.GetVolume="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus,UniqueId";const v=/\{([-a-z0-9]{7,})\}/i;async function w(){const e=await u.thenCollect(p.PowerShell.instance().executeJsonToA(t.GetPsDrive).catch((e=>(d.onError("volumeInfoWin(): LocalAndNetCmd failed",e),[]))),(e=>l.compactBlankValues(function(e){return r.notBlank(e.Root)&&null!=e.Free&&null!=e.Used?{mountpoint:e.Root,label:e.Description,size:e.Used+e.Free,used:e.Used,available:e.Free,remote:r.notBlank(e.DisplayRoot),...a.map(g.parseRemoteName(e.DisplayRoot),(e=>({remoteHost:e.host,remoteShare:e.share})))}:void 0}(e)))),i=await u.thenCollect(p.PowerShell.instance().executeJsonToA(t.GetVolume).catch((e=>(d.onError("_localAndNet(): LocalCmd failed",e),[]))),(e=>l.compactBlankValues(function(e){if(null==e.DriveLetter||"null"===e.DriveLetter||"System Reserved"===e.FileSystemLabel)return;const t=null!=e.Size&&null!=e.SizeRemaining&&r.notBlank(e.DriveLetter)&&(r.notBlankAnd(e.HealthStatus,(e=>m.equalsIgnoreCase(e,"Healthy")))||r.notBlankAnd(e.OperationalStatus,(e=>m.equalsIgnoreCase(e,"OK"))));return{mountpoint:e.DriveLetter+":\\",filesystem:e.FileSystem,label:e.FileSystemLabel,uuid:(i=e.UniqueId,y().tap({msg:"uniqueId2uuid",result:a.map(v.exec(c.toS(i)),(e=>e[1])),meta:{s:i}})),size:e.Size,used:e.Size-e.SizeRemaining,available:e.SizeRemaining,remote:!1,ok:t};var i}(e)))),s=n.uniq([...e,...i].filter((e=>!1===e.ok)).map((e=>e.mountpoint))),o=n.sort(n.uniq([...e,...i].map((e=>e.mountpoint))).filter((e=>!s.includes(e))));return y().info("volumeInfoWin()",{getPsDrive:e,getVolumes:i,mountpoints:o,unhealthy:s}),o.map((t=>({...e.find((e=>t===e.mountpoint)),...i.find((e=>t===e.mountpoint))})))}t.volumeInfoWin=w},36736:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mtabEntries=t.gioVolumes=t.GioMountMonitorArgs=t.GioCommand=t.isGioSupported=void 0;const n=i(39938),r=i(88491),s=i(11448),a=i(66776),o=i(98510),l=i(97503),u=i(46852),c=i(13317),d=i(69317),h=i(98462),p=i(7162),m=i(99312),f=i(91464),g=i(7903),y=i(53719);t.isGioSupported=s.lazy((async()=>{if(!m.isLinux||m.isDocker())return!1;try{return 0===(await d.stdoutResult(t.GioCommand,["version"],{timeout:y.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}})),t.GioCommand="gio",t.GioMountMonitorArgs=["mount","--monitor","--anonymous"];const v=s.lazy((()=>p.mkLogger("Gio.gioVolumes()")));t.gioVolumes=s.lazy((()=>c.thenOrTimeout((async()=>{const e=await async function(){return await t.isGioSupported()?u.thenFlatten(await u.thenMap(t.mtabEntries(),(e=>e.map((e=>h.BaseFile.for(e).clear().childDirectories()))))):[]}(),i=(await u.thenFlatten(e.map((async e=>{const t=await g.dfPosixRaw(!1,e.nativePath).catch((t=>{v().warn("Failed to df "+e+": "+t)})),i=a.map(t,(e=>e[0]));return a.map(i,(t=>t.mountpoint=e.nativePath)),i})))).filter((e=>e.size>0));return Promise.all(i.map((async e=>u.thenMapOr(b(e.mountpoint),(t=>(e.remoteHost=t.remoteHost,e.remoteShare=t.remoteShare,e.label=t.displayName,e.remote=!0,e)),(()=>e)))))}),y.MountpointsTtlMs,(()=>p.mkLogger("Gio.gioVolumes").warn("timed out after "+y.MountpointsTtlMs+"ms")))),y.LongMountpointsTtlMs);const w=p.mkLogger("Gio.getRemoteInfo()"),b=l.memoizeAsync((async e=>{try{const i=(await d.stdout(t.GioCommand,["info",e],{timeout:y.CmdTimeoutMs})).split(/[\n\r]+/),r=n.mapNotBlank(i.find((e=>e.startsWith("uri: "))),(e=>new URL(f.stripPrefix(e,"uri: "))));return{displayName:a.map(i.find((e=>e.startsWith("display name: "))),(e=>f.stripPrefix(e,"display name: "))),remoteHost:a.map(r,(e=>e.hostname)),remoteShare:o.opt(r).flatMap((e=>e.pathname)).flatMap((e=>f.stripPrefix(e,"/"))).flatMap((e=>f.stripSuffix(e,"/"))).flatMap(decodeURIComponent).filter(n.notBlank).get()}}catch(t){return void w.warn("gio info failed",{mountpoint:e,err:t})}}),{maxSize:255,timeoutMs:y.ShortCmdTimeoutMs,clearEveryMs:10*r.minuteMs});t.mtabEntries=s.lazy((async()=>u.thenMap(h.BaseFile.for("/proc/mounts").readLines(),(e=>e.filter((e=>e.startsWith("gvfsd-fuse "))).map((e=>e.split(" ")[1]))))),y.LongMountpointsTtlMs)},55412:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazyFsAsync=void 0;const n=i(92585),r=i(43947),s=i(7383),a=i(49379),o=i(79015),l=i(32421),u=i(53719);t.lazyFsAsync=function(e,t){const i=s.timedLazy("vol."+e,(()=>n.retryOnReject(t,{maxRetries:2,timeoutMs:u.CmdTimeoutMs,errorIsRetriable:e=>a.isIgnorableError(e)})),u.LongTtlMs);return l.mountpoints.onChange((()=>i.unset())),r.later((()=>o.onClearCache((()=>i.unset())))),i}},71820:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mnt2uuidMac=t.addLocalVolumeInfoMac=void 0;const n=i(39938),r=i(66776),s=i(26588),a=i(69317),o=i(48783),l=i(91464),u=i(55412),c=i(53719);t.addLocalVolumeInfoMac=async function(e){return s.thenMap(t.mnt2uuidMac(),(t=>e.map((e=>r.mapOr(t.get(e.mountpoint),(t=>({...e,...t})),(()=>e))))))},t.mnt2uuidMac=u.lazyFsAsync("mnt2uuidMac",(async()=>{const e=(await a.stdout("diskutil",["info","-all"],{timeout:c.CmdTimeoutMs})).split(/^\s*\*{8,12}\s*$/m);return o.toMap(e,(e=>{const t=o.toMap(e.split(/\s*\n+\s*/),(e=>{const[t,i]=e.split(":").map((e=>e.trim()));return l.hasAnyIgnoreCase(["not applicable","no file system"],i)?void 0:[t.toLowerCase(),i]})),i=t.get("mount point"),r=t.get("volume name"),s=t.get("volume uuid");return n.blank(i)?void 0:[i,{label:r,uuid:s}]}))}))},9698:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localVolumeInfoPosix=t.addLocalVolumeInfoPosix=void 0;const n=i(11944),r=i(39938),s=i(11448),a=i(75556),o=i(26588),l=i(46852),u=i(69317),c=i(56533),d=i(51081),h=i(3955),p=i(7162),m=i(99312),f=i(91464),g=i(55412),y=i(53719),v=s.lazy((()=>p.mkLogger("LocalVolumesPosix")));t.addLocalVolumeInfoPosix=async function(e){return o.thenMap(await t.localVolumeInfoPosix(),(t=>f.sortIgnoreCase(n.uniq([...t.filter((e=>!e.ignorable)).map((e=>e.mountpoint)),...e.map((e=>e.mountpoint))])).map((i=>({...e.find((e=>e.mountpoint===i)),...t.find((e=>e.mountpoint===i))})))))},t.localVolumeInfoPosix=g.lazyFsAsync("localVolumeInfoPosix",(async()=>{const e=await u.stdout("lsblk",["-P","-b","--output","mountpoint,label,fsused,fsavail,uuid"],{timeout:y.CmdTimeoutMs}),t=d.splitLines(e).map((e=>c.parseEnvTokens({input:e,lowerCaseKeys:!0}))).filter((e=>null!=e)),i=await l.mapAsync(t,(async e=>{const t=r.blank(e.mountpoint)||e.mountpoint.startsWith("/snap/")||"/boot"===e.mountpoint||e.mountpoint.startsWith("/boot/")||!await h.isDirectory(e.mountpoint);return a.map2Numeric(a.toInt(e.fsused),a.toInt(e.fsavail),((i,n)=>({mountpoint:e.mountpoint,label:e.label,uuid:e.uuid,ignorable:t,used:i,available:n,size:i+n,...m.isDocker()?void 0:{remote:!1}})))}));return v().tap({msg:"lsblk",result:i})}))},87824:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isInstallDmg=t.ignorableMacFilesystems=t.mounts=void 0;const n=i(11944),r=i(11448),s=i(66776),a=i(46852),o=i(69317),l=i(84593),u=i(98462),c=i(53719),d=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;async function h(){const e=await o.stdout("mount",[],{timeout:c.CmdTimeoutMs});return n.compact(e.split("\n").map((e=>s.map(d.exec(e),(e=>{const[t,i,n]=e.slice(1);return{filesystem:t,mountpoint:i,options:n.split(",").map((e=>e.trim()))}})))))}async function p(e){const t=u.BaseFile.for(e),i=await a.thenMapOr(await t.childNames(),(e=>e.filter((e=>!e.startsWith("."))).map((e=>e.toLowerCase())).sort()),(()=>[]));return l.eql(i,["applications","photostructure.app"])}t.mounts=h,t.ignorableMacFilesystems=r.lazy((async()=>a.filterAsync(await h(),(async e=>e.options.includes("nobrowse")||e.options.includes("quarantine")||await p(e.mountpoint))).then((e=>e.map((e=>e.filesystem))))),c.MountpointsTtlMs),t.isInstallDmg=p},32421:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.findmntPoll=t.gioMountMonitor=t.diskUtilActivity=t.mountpoints=t.localMountpointSetup=t.setRpcMountpointsImpl=t.nonRpcMountpoints=void 0;const n=i(92585),r=i(88491),s=i(43947),a=i(11448),o=i(36079),l=i(64975),u=i(46852),c=i(69317),d=i(95298),h=i(64126),p=i(10408),m=i(79015),f=i(7162),g=i(99312),y=i(55568),v=i(36736),w=i(62255),b=i(49829),S=i(53719);let M;t.nonRpcMountpoints=()=>g.isWin?b.mountpointsWin():w.mountpointsPosix(),t.setRpcMountpointsImpl=function(e){M=e,t.localMountpointSetup()},t.localMountpointSetup=a.lazy((async()=>{y.isRpcServer()?s.later((async()=>{const e=f.mkLogger("Mountpoints.localMountpointSetup()");g.isMac&&(e.info("Setting up Mac diskutil activity watcher"),t.mountpoints.setTTL(S.LongMountpointsTtlMs),t.diskUtilActivity()),g.isLinux&&(await v.isGioSupported()&&(e.info("Setting up Linux gio mount monitor"),t.mountpoints.setTTL(S.LongMountpointsTtlMs),t.gioMountMonitor()),await P()&&(e.info("Setting up Linux findmnt mount monitor"),t.mountpoints.setTTL(S.LongMountpointsTtlMs),t.findmntPoll()))}),30*r.secondMs).unref():await u.awaitAll([o.end(t.diskUtilActivity.clear()),o.end(t.gioMountMonitor.clear()),o.end(t.findmntPoll.clear())])})),t.mountpoints=a.lazy((async()=>{const e=await n.retryOnReject((()=>l.firstDefinedLater(M,t.nonRpcMountpoints)),{maxRetries:3,onRetryWaitUntil:e=>s.unrefDelay(1500*e)}).catch((e=>{p.onError("mountpoints() failed",e)}));return null==e?void 0:e.sort()}),S.MountpointsTtlMs),s.later((()=>m.onClearCache((()=>t.mountpoints.unset())))),t.diskUtilActivity=a.lazy((()=>d.mkBasicWatchedChild({cmd:"diskutil",args:["activity"],onStdout:h.debounce((()=>t.mountpoints.unset()),1.5*r.secondMs)}))),t.gioMountMonitor=a.lazy((()=>d.mkBasicWatchedChild({cmd:v.GioCommand,args:v.GioMountMonitorArgs,onStdout:h.debounce((()=>{v.gioVolumes.unset(),v.mtabEntries.unset(),t.mountpoints.unset()}),1.5*r.secondMs)})));const P=a.lazy((async()=>{if(!g.isLinux)return!1;try{return 0===(await c.stdoutResult("findmnt",["--version"],{timeout:S.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}}));t.findmntPoll=a.lazy((()=>d.mkBasicWatchedChild({cmd:"findmnt",args:["--poll"],onStdout:h.debounce((()=>{v.mtabEntries.unset(),t.mountpoints.unset()}),1.5*r.secondMs)})))},62255:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsPosix=void 0;const n=i(11944),r=i(66776),s=i(46852),a=i(7162),o=i(7903),l=i(36736),u=a.mkLogger("Mountpoints.localMountpointSetup()");t.mountpointsPosix=async function(){const e=await s.thenMap(o.dfPosixRaw(!1),(e=>n.compactBlanks(e.map((e=>e.mountpoint)))));if(null!=e&&await l.isGioSupported())try{await s.thenMap(l.gioVolumes(),(t=>e.push(...t.map((e=>e.mountpoint)))))}catch(e){u.warn("Failed to fetch gio volumes",e)}return r.map(e,(e=>e.filter((e=>!e.startsWith("/snap/")&&"/dev"!==e))))}},49829:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsWinFsutil=t.mountpointsWin=void 0;const n=i(11944),r=i(88491),s=i(54608),a=i(69317),o=i(9288),l=i(71663),u=/\s([A-Z]:\\)/g;t.mountpointsWin=async()=>s.thenOpt(l.PowerShell.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap((e=>e.map((e=>e.Root)))).filter(n.isNotEmpty).orElse((()=>t.mountpointsWinFsutil())).map((e=>e.sort())).getRequired(),t.mountpointsWinFsutil=async()=>{const e=(await a.stdout(await o.fsutil(),["fsinfo","drives"],{timeout:10*r.secondMs})).trim(),t=[];let i;for(;null!==(i=u.exec(e));)t.push(i[1]);return t}},92002:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addRemoteVolumeInfoPosix=t.nfsRe=void 0;const n=i(66776),r=i(82798),s=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i;t.nfsRe=/^([^:\s]+):(\/.+)$/,t.addRemoteVolumeInfoPosix=async function(e){return e.filter((e=>e.remote)).forEach((e=>{n.mapOr(s.exec(r.toS(e.filesystem)),(t=>{e.remoteHost=t[1],e.remoteShare=t[2]}),(()=>n.map(t.nfsRe.exec(r.toS(e.filesystem)),(t=>{e.remoteHost=t[1],e.remoteShare=t[2]}))))})),e}},76019:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t._netInfoWinWmic=t.parseRemoteName=t.NetInfoCmd=t.addRemoteVolumeInfoWin=void 0;const n=i(11944),r=i(39938),s=i(88491),a=i(66776),o=i(98510),l=i(82798),u=i(46852),c=i(69317),d=i(82128),h=i(9288),p=i(48783),m=i(2023),f=i(99312),g=i(71663),y=i(91464),v=i(55412);t.addRemoteVolumeInfoWin=async function(e,t){if(!f.isWin)throw new Error("wtf");return await u.thenMap(a.orElse(t,(()=>T())),(t=>{const i=p.toMap(t,(e=>[e.mountpoint,e]));e.forEach((e=>{a.map(i.get(e.mountpoint),(t=>{e.remote=!0,e.remoteHost=t.host,e.remoteShare=t.share,e.ok=t.ok}))}))})),e};const w=["LocalName","RemoteName","Status"],b=["NETUSE","get",w.join(",")],S=/^\\\\(.+?)\\(.+)$/,M=/^[a-z]:\\?$/i;function P(e){if(!r.blank(e))return o.opt(e).flatMap((e=>S.exec(e))).map((e=>({host:e[1],share:e[2]}))).orElse((()=>o.opt(e).flatMap((e=>m.Try((()=>new URL(e))))).filter((e=>r.notBlank(e.hostname))).map((e=>({host:e.hostname,share:o.opt(e.pathname).filter(r.notBlank).getOrElse((()=>"/"))}))))).get()}async function E(){const e=h.wmic(),t=await c.stdout(e,b,{timeout:15*s.secondMs}),i=d.parseFixed(w,t);return n.compact(i.map((e=>a.map(S.exec(l.toS(e.RemoteName)),(t=>a.map(M.exec(l.toS(e.LocalName)),(i=>({mountpoint:y.ensureSuffix(i[0],"\\"),host:t[1],share:t[2],ok:"OK"===e.Status}))))))))}t.NetInfoCmd="Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status",t.parseRemoteName=P,t._netInfoWinWmic=E;const T=v.lazyFsAsync("netInfoWin",(async function(){const e=await g.PowerShell.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return null==e?E():n.compact(e.filter((e=>r.notBlank(e.LocalName))).map((e=>a.map(P(e.RemoteName),(({host:t,share:i})=>a.map(M.exec(l.toS(e.LocalName)),(n=>({mountpoint:y.ensureSuffix(n[0],"\\"),host:t,share:i,ok:"OK"===e.Status&&"Connected"===e.ConnectionState}))))))))}))},53719:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MinIoRate=t.LongTtlMs=t.ShortCmdTimeoutMs=t.CmdTimeoutMs=t.LongMountpointsTtlMs=t.MountpointsTtlMs=void 0;const n=i(88491),r=i(17078);t.MountpointsTtlMs=15*n.secondMs,t.LongMountpointsTtlMs=5*n.minuteMs,t.CmdTimeoutMs=35*n.secondMs,t.ShortCmdTimeoutMs=7*n.secondMs,t.LongTtlMs=1*n.hourMs,t.MinIoRate=n.secondMs/(2*r.MiB)},27127:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readVolumeUUID=t.addVolumeUUIDs=t.VolumeUuidTimeoutMs=void 0;const n=i(92585),r=i(39938),s=i(38625),a=i(43947),o=i(11448),l=i(21040),u=i(54608),c=i(46852),d=i(70259),h=i(2234),p=i(79015),m=i(98250),f=i(7162),g=i(76474),y=i(43414),v=i(32421),w=i(53719),b=o.lazy((()=>f.mkLogger("VolumeUUID")));t.VolumeUuidTimeoutMs=w.MountpointsTtlMs/2;const S=new Map;async function M(e){const i=m.PosixFile.for(e.mountpoint).join(".uuid");if(y.Settings.readVolumeUuidFiles.valueOrDefault){const s=await n.thenOrTimeout((()=>u.thenOpt(i.readFile("debug")).map((e=>e.toString().trim())).filter(r.notBlank).get()),t.VolumeUuidTimeoutMs);if(null!=s&&s.length>6)return b().debug("Serving UUID from .uuid",{uuid:s,mountpoint:e.mountpoint}),s}if("/"===e.mountpoint)return e.uuid;if(y.Settings.writeVolumeUuidFiles.valueOrDefault){const t=r.notBlankOr(e.uuid,g.safeUUID);if(await i.parent().isReadWritable())try{return await i.writeTxt_(t),b().info("volumeUUID(): Saved new UUID for "+e.mountpoint,{uuid:t}),t}catch(t){b().warn("volumeUUID(): Failed to save new UUID for "+e.mountpoint,t)}}return e.uuid}a.later((()=>{p.onClearCache((()=>S.clear())),v.mountpoints.onChange((()=>S.clear()))})),t.addVolumeUUIDs=async function(e){await d.withBoundedConcurrency({name:"addVolumeUUIDs",laters:e.map((e=>()=>async function(e){s.isTrue(e.ignorable)?b().debug("volumeUUID(): ignorable is true for "+e.mountpoint):s.isFalse(e.ok)?b().debug("volumeUUID(): remoteOK is false for "+e.mountpoint):await c.thenMap(l.getOrSet(S,e.mountpoint,(()=>n.thenOrTimeout((()=>h.tryWithErrorHandling((()=>M(e)),{message:"readVolumeUUID("+e.mountpoint+")"})),t.VolumeUuidTimeoutMs))),(t=>e.uuid=t))}(e)))})},t.readVolumeUUID=M},46573:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bestRemoteVolume=t.remoteVolumeFor=t.bestVolume=t.volumeFor=t.rootVolume=t.rootPath=t.volumes=t.setRpcVolumesImpl=void 0;const n=i(11944),r=i(39938),s=i(38625),a=i(88491),o=i(11448),l=i(66776),u=i(98510),c=i(13779),d=i(64975),h=i(46852),p=i(70259),m=i(13317),f=i(7799),g=i(84593),y=i(10408),v=i(79015),w=i(3955),b=i(84571),S=i(7162),M=i(58659),P=i(99312),E=i(43414),T=i(91464),x=i(69329),D=i(69551),C=i(55412),k=i(71820),I=i(9698),F=i(92002),O=i(76019),A=i(53719),_=i(27127),L=o.lazy((()=>S.mkLogger("Volumes")));async function R(){const e=await m.thenOrTimeout(P.isWin?D.dfWin():x.dfPosix(),A.MountpointsTtlMs,(()=>y.onError("Timed out getting local volume metadata")));if(null==e)return void L().warn("df failed");const t=E.Settings.validateMountpoints.valueOrDefault?n.compact(await p.withBoundedConcurrency({name:"nonRpcVolumes: filter unhealthy volumes",laters:e.map((e=>async()=>{try{if(await w.nativePathIsReadableDirectory(e.mountpoint,b.StatTimeoutMs/2))return e;L().info("validateMountpoints(): "+e.mountpoint+" is not a directory")}catch(t){L().info("validateMountpoints(): failed to stat "+e.mountpoint,t)}}))})):e;t.some((e=>e.remote&&r.blank(e.remoteHost)))&&await m.thenOrTimeout(P.isWin?O.addRemoteVolumeInfoWin(t):F.addRemoteVolumeInfoPosix(t),10*a.secondMs).catch((e=>{y.onError("Failed to get remote volume info",e)}));const i=l.orElse(await(P.isWin?t:P.isMac?k.addLocalVolumeInfoMac(t):I.addLocalVolumeInfoPosix(t)),t);n.filterInPlace(i,(e=>!s.isTrue(e.ignorable))),E.Settings.ignoreUnhealthyVolumes.valueOrDefault&&n.filterInPlace(i,(e=>!s.isFalse(e.ok)));for(const e of i)e.remote=s.isTrue(e.remote),r.mapNotBlank(e.remoteHost,(t=>e.remoteHost=t.toLowerCase().normalize().trim()));for(const e of i)r.blank(e.label)&&delete e.label;L().debug("nonRpcVolumes(): before addVolumeUUIDs",i),await _.addVolumeUUIDs(i);const o=n.sortBy(i,(e=>e.mountpoint));return L().debug("_volumes(): final result",{sorted:o}),Object.freeze(o)}let N;t.setRpcVolumesImpl=function(e){N=e};let B=[];async function j(e){return h.thenMap(t.volumes(),(t=>z(t,e)))}function z(e,t){const i=e.filter((e=>w.containedByNativePath(t,e.mountpoint)));return c.greatestBy(i,(e=>n.commonPrefixLength(e.mountpoint,t)))}async function V(e,t,i){const a=i.filter((e=>T.equalsIgnoreCase(t,e.remoteShare)));if(n.isEmpty(a))return;const o=a.find((t=>s.isTrue(t.remote)&&r.notBlank(t.remoteHost)&&T.equalsIgnoreCase(e,t.remoteHost)));if(null!=o)return o;const l=await M.friendlyname(e);return h.asyncFind(a,(async e=>T.equalsIgnoreCase(l,await M.friendlyname(e.remoteHost))))}t.volumes=C.lazyFsAsync("volumes",(async()=>{try{const e=await d.firstDefinedLater(N,R);return n.mapNotEmpty(e,(e=>{const t=e.map((e=>e.mountpoint)).sort();g.eql(B,t)||(v.emitVolumesChanged(),B=t)})),e}catch(e){return void y.onError("volumes() failed",e)}})),t.rootPath=o.lazy((()=>P.isWin?u.opt(f.getEnv("SystemDrive")).filter(r.notBlank).orElse((()=>"C:")).map((e=>T.ensureSuffix(e,"\\"))).get():"/")),t.rootVolume=function(){return j(t.rootPath())},t.volumeFor=j,t.bestVolume=z,t.remoteVolumeFor=async function(e,i){return h.thenMap(t.volumes(),(t=>V(e,i,t)))},t.bestRemoteVolume=V},94569:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.idleStats=t.removeIdleListener=t.addIdleListener=t.setDoNotRunImpl=t.idleRunner=void 0;const n=i(88491),r=i(43947),s=i(36079),a=i(28807),o=i(70259),l=i(79015),u=i(93138),c=i(59387),d=i(29916);l.onResume((()=>v())),l.onIdle((()=>r.later(v)));const h=new o.Promises,p=new o.Promises,m=new u.RoundRobin;t.idleRunner=new a.EndableInterval({name:"Idle",callback:v,intervalMs:7*n.secondMs,initialDelayMs:20*n.secondMs});let f=async()=>!1;async function g(){return d.isPaused()||s.ending()||0===m.size||p.pendingCount>=c.maxCpus()||await f()}t.setDoNotRunImpl=function(e){f=e};const y=c.maxCpus()>4?250:750;async function v(){return await g()?void 0:h.maybeRun("runOnIdle",(async()=>{if(await g())return;const{value:e}=m.next((e=>e.runnable));null!=e&&p.push(e.name,(async()=>e.onIdle())).finally((()=>v)),m.size>0&&r.later(v,y)}))}t.addIdleListener=function(e){m.push(e),r.later(v)},t.removeIdleListener=function(e){return m.filterInPlace((t=>t.name!==e))},t.idleStats=async function(){return{doNotRun:{isPaused:d.isPaused(),ending:s.ending(),doNotRunImpl:await f()},idleListeners:m.toA().map((e=>null==e?void 0:e.name)),runnableIdleListeners:m.toA((e=>null==e?void 0:e.runnable)).map((e=>null==e?void 0:e.name)),pendingWorkItems:p.pendingNames()}}},59387:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.maxPendingSyncFileJobs=t.sharpThreadsPerJob=t.maxSyncFileJobs=t.sharpThreadsPerSystem=t.maxCpus=t.totalCpus=t.estimatedFreeMem=void 0;const n=i(12087),r=i(43947),s=i(11448),a=i(75556),o=i(17078),l=i(79015),u=i(43414);r.later((()=>{l.onClearCache((()=>{t.estimatedFreeMem.unset(),t.totalCpus.unset(),t.maxCpus.unset(),t.sharpThreadsPerSystem.unset(),t.maxSyncFileJobs.unset(),t.sharpThreadsPerJob.unset(),t.maxPendingSyncFileJobs.unset()}))})),t.estimatedFreeMem=s.lazy((()=>(2*n.freemem()+n.totalmem())/3)),t.totalCpus=s.lazy((()=>n.cpus().length)),t.maxCpus=s.lazy((()=>{const e=1*o.GB,i=Math.max(1,Math.floor(t.estimatedFreeMem()/e)),n=u.Settings.cpuLoadPercent.valueOrDefault/100*t.totalCpus();return a.clamp(1,i,Math.floor(n))})),t.sharpThreadsPerSystem=s.lazy((()=>{const e=500*o.MB,i=Math.floor(t.estimatedFreeMem()/e),n=Math.max(1,Math.floor(1.5*t.totalCpus()*(u.Settings.cpuLoadPercent.valueOrDefault/100)));return a.clamp(1,n,i)})),t.maxSyncFileJobs=s.lazy((()=>a.clamp(1,24,t.maxCpus()))),t.sharpThreadsPerJob=s.lazy((()=>a.clamp(1,6,Math.ceil(t.sharpThreadsPerSystem()/t.maxSyncFileJobs())))),t.maxPendingSyncFileJobs=t.maxSyncFileJobs},29916:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.resume=t.pause=t.isPaused=void 0;const n=i(79015);let r=!1;t.isPaused=function(){return r},t.pause=function(){r||(r=!0,n.emitPause())},t.resume=function(){r&&(r=!1,n.emitClearCache(),n.emitResume())}},11944:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.commaList=t.last=t.diff=t.stepRange=t.range=t.anneal=t.commonPrefixLength=t.firstMatch=t.sum=t.count=t.clear=t.uniqBy2=t.uniqBy=t.uniq=t.compactBlanks=t.compactBlankish=t.compact=t.insertUniq=t.insertAt=t.pushUniqBy=t.pushUniq=t.eqlUnordered=t.includesAll=t.indexOf=t.includes=t.move=t.filterInPlace=t.startsWith=t.arrayEql=t.deepSortBy=t.sortBy=t.sortedBy=t.sorted=t.sortUniqByInPlace=t.sortByInPlace=t.copyArrayTo=t.sort=t.flatten=t.mapNotEmptyOr=t.mapNotEmpty=t.mapArray=t.isEmpty=t.notEmptyOr=t.isNotEmpty=void 0;const n=i(39938),r=i(24603),s=i(20810),a=i(87748),o=i(1682),l=i(21040),u=i(66776),c=i(8199),d=i(23175),h=i(44726),p=i(90957),m=i(39784),f=i(82798);function g(e){return o.isList(e)&&e.length>0&&e.some((e=>null!=e))}function y(e){return!g(e)}function v(e){return c.isPrimitive(e)||c.isPrimitiveArray(e)?e:e.valueOf()}function w(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t.length=e.length,t}function b(e,t){return w(S(e,t),e)}function S(e,t){return m.toA(e).filter((e=>null!=e)).map(((e,i)=>({item:e,cmp:u.map(t(e,i),(e=>[e,i]))}))).filter((e=>null!=e.cmp)).sort(((e,t)=>c.cmp(e.cmp,t.cmp))).map((e=>e.item))}function M(e,t){return null!=e&&null!=t&&e.length===t.length&&e.every(((e,i)=>e===t[i]))}function P(e,t,i){if(t===i||t<0||i<0||t>=e.length||i>=e.length)return e;const n=e[t];return e.splice(t,1),e.splice(i,0,n),e}function E(e,t){if(null==e)return!1;for(const i of e)if(t.valueOf()===i.valueOf())return!0;return!1}function T(e){if(null==e)return[];const t=m.toA(e);return t.every(u.defined)?t:t.filter(u.defined)}function x(e,t=(e=>a.stringify(e))){if(y(e))return[];const i=new Map;for(const n of e)if(null!=n){const e=t(n);null!=e&&l.getOrSet(i,e,(()=>n))}return[...i.values()]}function D(e,t,i=1,n=(e=>e)){const r=[];if(e<t)for(let s=e;s<t;s+=i)r.push(n(s));else for(let s=e;s>t;s-=i)r.push(n(s));return r}t.isNotEmpty=g,t.notEmptyOr=function(e,t){return g(e)?e:p.tot(t)},t.isEmpty=y,t.mapArray=function(e,t){return Array.isArray(e)?t(e):void 0},t.mapNotEmpty=function(e,t){return g(e)?t(e):void 0},t.mapNotEmptyOr=function(e,t,i){return g(e)?t(e):p.tot(i)},t.flatten=function(e,t=[]){if(null==e)return t;for(const i of e)if(null!=i)if(Array.isArray(i))for(const e of i)null!=e&&t.push(e);else t.push(i);return t},t.sort=function(e){return b(T(e),v)},t.copyArrayTo=w,t.sortByInPlace=b,t.sortUniqByInPlace=function(e,t){const i=new Map;for(const n of e)l.getOrSet(i,a.stringify(t(n)),(()=>n));return w(S(i.values(),t),e)},t.sorted=function(e){return e.every(((t,i)=>0===i||t>e[i-1]))},t.sortedBy=function(e,t){return e.every(((i,n)=>0===n||t(i)>t(e[n-1])))},t.sortBy=S,t.deepSortBy=function e(t,i){return S(t,i).map((t=>s.isIterable(t)?e(t,i):t))},t.arrayEql=M,t.startsWith=function(e,t){return M(e.slice(0,t.length),t)},t.filterInPlace=function(e,t){for(let i=0;i<e.length;)t(e[i],i,e)?i++:e.splice(i,1);return e},t.move=P,t.includes=E,t.indexOf=function(e,t){if(null==e)return;let i=0;for(const n of e){if(t(n,i))return i;i++}},t.includesAll=function(e,t){return null!=e&&null!=t&&t.every((t=>E(e,t)))},t.eqlUnordered=function(e,t){if(null==e||null==t||e.length!==t.length)return!1;const i=S(e,v),n=S(t,v);return i.every(((e,t)=>e===n[t]))},t.pushUniq=function(e,...t){for(const i of t)e.some((e=>r.eql(e,i)))||e.push(i);return e},t.pushUniqBy=function(e,t,i){const n=e.map(i);for(const r of t){const t=i(r);n.includes(t)||(e.push(r),n.push(t))}return e},t.insertAt=function(e,t,...i){return e.splice(t,0,...i),e},t.insertUniq=function(e,t,i){for(let t=0;t<e.length-1;t++)if(i(e[t],e[t+1])>0)throw new Error("badly sorted array: "+e);for(let n=0;n<e.length;n++){const r=i(e[n],t);if(0===r)return e;if(r>0)return e.splice(n,0,t),e}return e.push(t),e},t.compact=T,t.compactBlankish=function(e){const t=m.toA(e).filter((e=>!n.blankish(f.toS(e))));return h.isString(t[0])?t.map((e=>f.toS(e).trim())):t},t.compactBlanks=function(e){return m.toA(e).map((e=>f.toS(e).trim())).filter((e=>e.length>0))},t.uniq=function(e){return x(T(e),(e=>a.stringify(e)))},t.uniqBy=x,t.uniqBy2=function(e,t){if(y(e))return[];const i=[];for(const n of e)null!=n&&i.every((e=>!t(n,e)))&&i.push(n);return i},t.clear=function(e){return e.length=0,e},t.count=function(e,t){return e.reduce(((e,i,n)=>e+(t(i,n)?1:0)),0)},t.sum=function(e,t){return e.reduce(((e,i,n)=>e+t(i,n)),0)},t.firstMatch=function(e,t){for(const i of T(t)){const t=e.exec(i);if(null!=t)return t}},t.commonPrefixLength=function(e,t){if(null==e||null==t)return 0;if(e===t)return e.length;if("string"==typeof e&&(e=[...e]),"string"==typeof t&&(t=[...t]),M(e,t))return e.length;let i=0;for(;e[i]===t[i];)i++;return i},t.anneal=function({array:e,expense:t,allowedDelta:i}){const n=Math.round(i);if(n<2)return e;for(let i=0;i<e.length-1;i++){const r=d.randomInt(Math.max(0,i-n),Math.min(e.length,i+n),[i]);if(null==r)continue;const s=Math.max(0,Math.min(r,i)-1),a=Math.min(e.length,Math.max(r,i)+1),o=t(e,s,a);P(e,i,r);const l=t(e,s,a);c.lt(o,l)&&P(e,r,i)}return e},t.range=function(e,t,i=(e=>e)){return D(e,t,1,i)},t.stepRange=D,t.diff=function(e,t){const i=new Set(t);return e.filter((e=>!i.has(e)))},t.last=function(e){return null!=e?e[e.length-1]:void 0},t.commaList=function(e,t="or"){return e.length<=1?e.join(""):2===e.length?e.join(" "+t+" "):e.slice(0,-1).join(", ")+", "+t+" "+e[e.length-1]}},41135:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.asPromise=void 0;const n=i(34601);t.asPromise=async function(e){const t=await e;return n.isFunction(t)?t():t}},13783:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetUrls=void 0;const n=i(88012),r=i(11944),s=i(9381),a=i(97042),o=i(87748),l=i(66776),u=i(82798);class c{constructor(e,t=""){if(this.query="",this.query=t,this.assetId=n.id2id(e),null==this.assetId)throw new Error("internal error: null asset id "+o.stringify({id:e}))}static onNewPage(){this.pageImageCount=0}get unset(){return null==this.assetId||this.assetId<=0}assetUrl(){return this.unset?"":`/asset/${this.assetId}${this.query}`}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,t){return`/img/${this.assetId}/${e}/${t}${this.query}`}imgActualLink(e){return`/img/${r.compact([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e,t="m"){return{...this.imgAttrs("sq",a.SqWidths,e),sizes:"s"===t?"80px":"m"===t?"160px":"320px"}}imgAttrs(e,t,i,n){if(this.unset)return{src:"/images/clear-64.png"};const r=Math.min(...t),a={width:u.toS(r)},o=this.imgLink(e,r);c.pageImageCount++,(i=l.orElse(i,(()=>c.pageImageCount>72)))?(a.src="/images/clear-64.png",a["data-src"]=o):a.src=o,e===s.ReducerNames.sq&&(a.height=u.toS(r));const h=t.map((t=>d(this.imgLink(e,t),t)));return l.map(n,(e=>h.push(d(this.imgActualLink(),e.width)))),a[(i?"data-":"")+"srcSet"]=h.join(","),a}}function d(e,t){return e+" "+t+"w"}t.AssetUrls=c,c.pageImageCount=0},92585:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.retryOnReject=t.thenOrTimeout=void 0;const n=i(43947),r=i(66776),s=i(75556),a=i(98510);async function o(e,t){let i;return Promise.race([e().then((e=>null==i?(i=!0,e):void 0)),n.unrefDelay(t).then((()=>{if(null==i)throw i=!1,new Error("timeout")}))])}t.thenOrTimeout=o,t.retryOnReject=function(e,t){const i=s.gt0(t.timeoutMs)?()=>o(e,t.timeoutMs):e;if(t.maxRetries<=0)return i();const l=a.opt(t.onRetryWaitUntil).getOrElse((()=>e=>{var i;return n.unrefDelay((null!==(i=t.retryDelay)&&void 0!==i?i:250)*r.orElse(e,1))}));let u=0;const c=async()=>{var e;try{return await i()}catch(i){if(!1===await(null===(e=t.errorIsRetriable)||void 0===e?void 0:e.call(t,i))||u>t.maxRetries)throw i;return u++,await l(u),c()}};return c()}},37609:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.at=void 0,t.at=function(e,t){if((t=Math.trunc(t)||0)<0&&(t+=e.length),!(t<0||t>=e.length))return e[t]}},39938:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstNotBlank=t.mapNotBlankOr=t.mapNotBlank=t.notBlankAnd=t.notBlankOr=t.ifNotBlank=t.notBlank=t.blankish=t.blank=void 0;const n=i(66776),r=i(90957),s=i(82798);function a(e){if(null==e)return!0;const t=s.toS(e);return 0===t.length||0===t.trim().length}t.blank=a;const o=/^\s*(?:null|undefined)?\s*$/i;function l(e){return!a(e)}function u(e,t){if(!1===e||null==e||""===e)return;const i=s.toS(e);return l(i)?t(i):void 0}t.blankish=function(e){return null==e||null!=o.exec(e)},t.notBlank=l,t.ifNotBlank=function(e){if(null==e)return;const t=s.toS(e);return 0===t.length||0===t.trim().length?void 0:t},t.notBlankOr=function(e,t){if(null==e)return r.tot(t);const i=s.toS(e).trim();return i.length>0?i:r.tot(t)},t.notBlankAnd=function(e,t){return!a(e)&&t(e)},t.mapNotBlank=u,t.mapNotBlankOr=function(e,t,i){return n.orElse(u(e,t),i)},t.firstNotBlank=function(...e){for(const t of e)if(l(t))return t}},38625:(e,t)=>{"use strict";function i(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e)return!0;const t=String(e).toLowerCase();return["true","1"].includes(t)}function n(e){if("boolean"==typeof e)return!e;if(null==e)return!1;if(0===e)return!0;const t=String(e).toLowerCase();return["false","0"].includes(t)}Object.defineProperty(t,"__esModule",{value:!0}),t.mapTrue=t.mapBoolean=t.and=t.or=t.isFalse=t.boolToInt=t.toBoolean=t.isTrue=t.isBoolean=void 0,t.isBoolean=function(e){return"boolean"==typeof e},t.isTrue=i,t.toBoolean=function(e){return!!i(e)||!n(e)&&void 0},t.boolToInt=function(e){return i(e)?1:0},t.isFalse=n,t.or=function(e){return e.some((e=>i(e)))},t.and=function(e){return e.every((e=>i(e)))},t.mapBoolean=function(e,t){return i(e)?t(!0):n(e)?t(!1):void 0},t.mapTrue=function(e,t){return i(e)?t():void 0}},88491:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fmtIsoDate=t.fmtYMDHMS=t.unixtime=t.hence=t.ago=t.isDate=t.splitHMS=t.fmtDateShort=t.yearMs=t.weekMs=t.dayMs=t.hourMs=t.minuteMs=t.secondMs=void 0;const n=i(11448),r=i(66776),s=i(75556),a=i(98510);t.secondMs=1e3,t.minuteMs=60*t.secondMs,t.hourMs=60*t.minuteMs,t.dayMs=24*t.hourMs,t.weekMs=7*t.dayMs,t.yearMs=365.25*t.dayMs;const o=n.lazy((()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"})));function l(e){return e instanceof Date}function u(e,t){return new Date(r.orElse(t,new Date).getTime()-e)}function c(e){const t=String(e);return t.length>=2?t:("0"+t).slice(-2)}t.fmtDateShort=function(e){return a.opt(e).flatMap((e=>e instanceof Date?e.getTime():e)).map((e=>o().format(e))).get()},t.splitHMS=function(e){return r.mapOr(/^[0:]{1,4}/.exec(e),(t=>[t[0],e.substr(t[0].length)]),(()=>["",e]))},t.isDate=l,t.ago=u,t.hence=function(e,t){return u(-e,t)},t.unixtime=function(e){const i=l(e)?e.getTime():s.isNumber(e)?e:Date.now();return Math.floor(i/t.secondMs)},t.fmtYMDHMS=function(e){const t=l(e)?e:new Date(e);return t.getFullYear()+c(t.getMonth()+1)+c(t.getDate())+c(t.getHours())+c(t.getMinutes())+c(t.getSeconds())},t.fmtIsoDate=function(e){const t=l(e)?e:new Date(e);return t.getFullYear()+"-"+c(t.getMonth()+1)+"-"+c(t.getDate())}},43947:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.later=t.delayUntil=t.delay=t.unrefDelay=void 0;const n=i(75556),r=i(34601);function s(e){return a(e,!1)}function a(e,t){return new Promise((i=>{if(e<=0)i();else{const n=setTimeout((()=>i()),Math.ceil(e+.5));t&&null!=n.unref&&r.isFunction(n.unref)&&n.unref()}}))}t.unrefDelay=function(e){return a(e,!0)},t.delay=s,t.delayUntil=function(e){const t=(n.gt0(e)?e:e.getTime())-Date.now();if(t<0){if(t>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-t+"ms")}return s(t).then((()=>t))},t.later=function(e,t=1){return setTimeout(e,Math.max(1,Math.ceil(t)))}},57743:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dmegapixels=t.isPortrait=t.maybeFlipInPlace=t.maybeFlip=t.flip=t.dimToSize=t.dimToS=t.isDimensions=void 0;const n=i(75556),r=i(33714),s=i(17078);function a(e){return{width:e.height,height:e.width}}t.isDimensions=function(e){return null!=e&&n.gt0(e.width)&&n.gt0(e.height)},t.dimToS=function(e){return`${e.width} Ã ${e.height}`},t.dimToSize=function(e){return s.pixels2size(e.width*e.height)},t.flip=a,t.maybeFlip=function(e,t){return r.flippable(t)?a(e):e},t.maybeFlipInPlace=function(e,t){r.flippable(t)&&([e.width,e.height]=[e.height,e.width])},t.isPortrait=function(e){return e.width/e.height<1},t.dmegapixels=function(e){return s.megapixels(e.width*e.height)}},24603:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.objectEql=t.eql=void 0;const n=i(61570),r=i(34601),s=i(8199);function a(e,t){return null==e||null==t?null==e&&null==t:s.isPrimitive(e)&&s.isPrimitive(t)?e===t:r.isObject(e)&&r.isObject(t)?o(e,t):!(!Array.isArray(e)||!Array.isArray(t))&&e.length===t.length&&e.every(((e,i)=>a(e,t[i])))}function o(e,t){const i=n.keys(e);return i.length===n.keys(t).length&&i.every((i=>a(e[i],t[i])))}t.eql=a,t.objectEql=o},16475:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isError=t.asError=t.shortStack=t.errorToVerbose=t.errorToS=void 0;const n=i(11944),r=i(39938),s=i(44726),a=i(39784),o=i(82798);function l(e){if(r.blankish(e))return"";const t=e instanceof Error?n.uniq(n.compactBlankish([o.toS(e.name).trim(),r.mapNotBlank(e.code,(e=>`code ${e.trim()}`)),o.toS(e.message).trim()])).join(": "):o.toS(e);return s.ellipsize(t,255)}function u(e){return r.blank(e)?void 0:o.toS(e).split("\n").slice(0,6)}t.errorToS=l,t.errorToVerbose=function(e){return null==e?"(undefined)":[l(e),...a.toA(u(e.stack))].join("\n")},t.shortStack=u,t.asError=function(e){if(r.blank(e))throw new Error("undefined error");if(e instanceof Error)return e;if(Array.isArray(e)){const t=e[0];return t instanceof Error?(e.length>1&&(t.errors=e.slice(1)),t):new Error(e.map((e=>o.toS(e))).filter(r.notBlank).join(", "))}{const t=l(e),i=t.indexOf(":");if(i>2&&i<15){const e=new Error(t.slice(i+1).trim());return e.name=t.slice(0,i).trim(),e}return new Error(t)}},t.isError=function(e){return e instanceof Error}},85643:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fitInside=void 0,t.fitInside=function(e,t){const i=e.width/e.height;if(i>=t.width/t.height){const n=Math.min(t.width,e.width);return{width:n,height:Math.ceil(n/i)}}{const n=Math.min(t.height,e.height);return{width:Math.ceil(t.height*i),height:n}}}},9381:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReducerNames=void 0;const n=i(84253);t.ReducerNames=n.strEnum("fit","sq")},97042:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqWidths=t.SqSizes=t.FitSizeValues=t.FitSizes=void 0;const n=i(84253);t.FitSizes=n.strEnum("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),t.FitSizeValues=t.FitSizes.values,t.SqSizes=n.strEnum("s480","s240","s120","s60"),t.SqWidths=[60,120,240,480]},20810:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIterable=void 0,t.isIterable=function(e){return null!=e&&"string"!=typeof e&&"function"==typeof e[Symbol.iterator]}},87748:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clone=t.stringify=t.parseMaybe=void 0;const n=i(39938),r=i(66776);function s(e,t,i,n){return JSON.stringify(e,function(e,t){const i=[],n=[],r=null!=t?t:(e,t)=>i[0]===t?"[Circular ~]":"[Circular ~."+n.slice(0,i.indexOf(t)).join(".")+"]";return function(t,s){if(i.length>0){const e=i.indexOf(this);e>=0?(i.splice(e+1),n.splice(e,1/0,t)):(i.push(this),n.push(t)),i.indexOf(s)>=0&&(s=r.call(this,t,s))}else i.push(s);return null==e?s:e.call(this,t,s)}}(t,n),r.denull(i))}t.parseMaybe=function(e){try{if(n.notBlank(e))return JSON.parse(e)}catch{}},t.stringify=s,t.clone=function(e){return JSON.parse(s(e))}},6314:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Latch=void 0,t.Latch=class{constructor(e){this.id=e,this._state="pending",this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then((()=>this.resolve()),(e=>this.reject(e))),this}observeQuietly(e){return e.then((()=>this.resolve()),(()=>this.resolve())),this}get pending(){return"pending"===this._state}get settled(){return!this.pending}get resolved(){return"resolved"===this._state}get rejected(){return"rejected"===this._state}get state(){return this._state}then(e,t){return this.promise.then(e,t)}}},11448:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Lazy=t.lazy=void 0;const n=i(11944),r=i(24603),s=i(66776);t.lazy=function(e,t){return new a(e,t).asMemoizedThunk()};class a{constructor(e,t){this.thunk=e,this.ttlMs=t,this.lastSet=0,this.listeners=[]}asMemoizedThunk(){const e=this.apply.bind(this);return e.set=this.set.bind(this),e.clear=this.clear.bind(this),e.unset=this.unset.bind(this),e.prior=this.prior.bind(this),e.refresh=this.refresh.bind(this),e.ttl=this.ttl.bind(this),e.setTTL=this.setTTL.bind(this),e.onChange=this.onChange.bind(this),e.toJSON=this.toJSON.bind(this),e.lastSetAgoMs=this.lastSetAgoMs.bind(this),e}async onSetResult(e,t){if(n.isEmpty(this.listeners))return;const i=await e,s=await t;if(!r.eql(i,s))for(const e of this.listeners)e(s,i)}setResult(e){return this.lastSet=Date.now(),this.onSetResult(this.result,e),this.result=e}apply(){return(0===this.lastSet||null!=this.ttlMs&&this.lastSet+this.ttlMs<=Date.now())&&this.setResult(this.thunk()),this.result}set(e){return this.setResult(e)}unset(){this.setResult(void 0),this.lastSet=0}clear(){const e=this.result;return this.unset(),e}prior(){return this.result}refresh(){return this.setResult(this.thunk())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=e}onChange(e){this.listeners.push(e),s.map(this.result,e)}toJSON(){return"(Lazy)"}lastSetAgoMs(){return Date.now()-this.lastSet}}t.Lazy=a},1682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isList=void 0;const n=i(34601);t.isList=function(e){return null!=e&&(Array.isArray(e)||isFinite(e.length)&&n.isFunction(e[Symbol.iterator])&&n.isFunction(e.push)&&n.isFunction(e.pop)&&n.isFunction(e.forEach)&&n.isFunction(e.some))}},21040:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deleteIf=t.getOrSet=void 0,t.getOrSet=function(e,t,i){if(null==t)throw new Error("null key");if(e.has(t))return e.get(t);{const n=i();return null!=n&&e.set(t,n),n}},t.deleteIf=function(e,t){for(const[i,n]of e.entries())t(i,n)&&e.delete(i)}},66776:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nulled=t.denull=t.firstDefined=t.allDefined=t.defined=t.map2Or=t.mapOr=t.orElse=t.map3=t.map2=t.mapTry=t.map=void 0;const n=i(90957),r=i(82798);function s(e,t){return null==e?void 0:t(e)}function a(e,t,i){return null==e||null==t?void 0:i(e,t)}function o(e,t){return null!=e?e:n.tot(t)}function l(e){return null!=e}t.map=s,t.mapTry=function(e,t){try{return s(e(),t)}catch{return}},t.map2=a,t.map3=function(e,t,i,n){return null==e||null==t||null==i?void 0:n(e,t,i)},t.orElse=o,t.mapOr=function(e,t,i){return null!=e?t(e):n.tot(i)},t.map2Or=function(e,t,i,n){return o(a(e,t,i),n)},t.defined=l,t.allDefined=function(e){return null!=e&&e.every(l)},t.firstDefined=function(...e){return e.find(l)},t.denull=function(e){return null==e||"null"===r.toS(e)?void 0:e},t.nulled=function(e){return null==e?null:e}},75556:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.times=t.clamp=t.base10Ceil=t.base2Ceil=t.sigFigs=t.toPrecision=t.toFixed=t.toPrecisionMaybe=t.round=t.numericOr=t.mapNumericOr=t.map2Numeric=t.mapNumeric=t.mapIntOr=t.id=t.mapFloat=t.mapInt=t.gte0=t.lte0=t.gtOrElse=t.gt0=t.lt0=t.toGt0=t.toFloat=t.toInt=t.isToNumber=t.trunc=t.closeTo=t.approximates=t.safeDivide=t.absdiff=t.diff=t.finiteOrElse=t.gte=t.gt=t.lte=t.lt=t.mapFinite=t.isNumber=void 0;const n=i(39938),r=i(66776),s=i(34601),a=i(98510),o=i(90957),l=i(82798);function u(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function c(e,t){return u(e)?t(e):void 0}t.isNumber=u,t.mapFinite=c;const d=e=>(t,i)=>u(t)&&u(i)&&e(t,i);function h(e,t){return e/(0===t?1e-8:t)}function p(e){if(!u(e))return;const t=Math.trunc(e);return 0===t?Math.abs(t):t}function m(e){return s.isFunction(e.toNumber)}function f(e,t){if(n.blank(e))return t.defaultValue;if(u(e))return t.nton(e);if(m(e))return t.nton(e.toNumber());try{const i=t.ston(l.toS(e).trim());return u(i)?t.nton(i):t.defaultValue}catch{return t.defaultValue}}function g(e,t){return f(e,{defaultValue:void 0,nton:e=>p(e),ston:parseInt,...t})}function y(e,t){return f(e,{defaultValue:void 0,nton:e=>e,ston:parseFloat,...t})}function v(e){return u(e)&&e>0}function w(e,t){return a.opt(e).flatMap((e=>g(e))).flatMap(t).get()}function b(e,t){return u(e)?t(e):void 0}function S(e){return e<0?-Math.round(-e):Math.round(e)}function M(e,t){if(null==e)return 0;const i=Math.pow(10,t);return S(e*i)/i}t.lt=d(((e,t)=>e<t)),t.lte=d(((e,t)=>e<=t)),t.gt=d(((e,t)=>e>t)),t.gte=d(((e,t)=>e>=t)),t.finiteOrElse=function(e,t){return u(e)?e:t},t.diff=function(e,t){return u(e)&&u(t)?e-t:void 0},t.absdiff=function(e,t){return u(e)&&u(t)?Math.abs(e-t):void 0},t.safeDivide=h,t.approximates=function(e,i,n){return null!=e&&null!=i&&(e===i||t.gte(e<i?h(e,i):h(i,e),n))},t.closeTo=function(e,t,i){return null!=e&&null!=t&&Math.abs(e-t)<i},t.trunc=p,t.isToNumber=m,t.toInt=g,t.toFloat=y,t.toGt0=function(e){const t=g(e);return null!=t&&t>0?t:void 0},t.lt0=function(e){return u(e)&&e<0},t.gt0=v,t.gtOrElse=function(e,t){return u(e)&&u(t)&&e>t?e:void 0},t.lte0=function(e){return u(e)&&e<=0},t.gte0=function(e){return u(e)&&e>=0},t.mapInt=w,t.mapFloat=function(e,t){return a.opt(e).flatMap((e=>y(e))).flatMap(t).get()},t.id=function(e){const t=g(e);return v(t)?String(t):void 0},t.mapIntOr=function(e,t,i){return r.orElse(w(e,t),i)},t.mapNumeric=b,t.map2Numeric=function(e,t,i){return b(e,(e=>b(t,(t=>i(e,t)))))},t.mapNumericOr=function(e,t,i){return u(e)?t(e):i},t.numericOr=function(e,t){return u(e)?e:o.tot(t)},t.round=S,t.toPrecisionMaybe=function(e,t){return c(e,(e=>M(e,t)))},t.toFixed=function(e,t){try{return b(e,(e=>S(e*10**t)/10**t))}catch(e){return}},t.toPrecision=M,t.sigFigs=function(e,t){if(0===e||0===t)return 0;const i=t-S(Math.ceil(Math.log10(Math.abs(e)))),n=Math.pow(10,Math.abs(i));return i<0?S(e/n)*n:S(e*n)/n},t.base2Ceil=function(e){return Math.pow(2,Math.ceil(Math.log2(e)))},t.base10Ceil=function(e){return Math.pow(10,Math.ceil(Math.log10(e)))},t.clamp=function(e,t,i){if(e>t||!u(e)||!u(t))throw new Error(`invalid clamp(${e}, ${t}, ${i})`);return u(i)?i<e?e:i>t?t:i:S((e+t)/2)},t.times=function(e,t){if(!v(e))return[];const i=Math.round(e);return i<=0?[]:[...Array(i)].map(((e,i)=>t(i)))}},61570:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstValueCaseInsensitive=t.maybeCall=t.allKeys=t.filter=t.sortedKeys=t.onlyReqValued=t.mapReqValued=t.reqValuedOrElse=t.isReqValued=t.omit=t.pickFirst=t.pick=t.mapFields=t.compactBlankValues=t.compactValues=t.fromEntries=t.entries=t.values=t.mapCompactObj=t.notEmptyObj=t.emptyObj=t.keys=t.tap=void 0;const n=i(11944),r=i(39938),s=i(87748),a=i(66776),o=i(34601);function l(e,t){return null!=t?t(e):"string"==typeof e?console.log(e):console.dir(e,{depth:null}),e}function u(e){return null==e||"object"!=typeof e?[]:Object.keys(e).filter((t=>"string"==typeof t&&(null==e.propertyIsEnumerable||!0===e.propertyIsEnumerable(t))))}function c(e){return null!=e&&n.isNotEmpty(u(e))}function d(e){return u(e).map((t=>e[t]))}function h(e){return u(e).map((t=>[t,e[t]]))}function p(e,t){return"object"!=typeof t&&(t={}),n.compact(e).reduce(((e,[t,i])=>l(e,(()=>{null!=t&&null!=i&&(e[t]=i)}))),t)}function m(e){if(null==e)return;const t=h(e).filter((([e,t])=>null!=e&&null!=t));return n.isEmpty(t)?void 0:p(t)}function f(e){return d(e).every((e=>null!=e))}t.tap=l,t.keys=u,t.emptyObj=function(e){return n.isEmpty(u(e))},t.notEmptyObj=c,t.mapCompactObj=function(e,t){const i=m(e);return c(i)?t(i):void 0},t.values=d,t.entries=h,t.fromEntries=p,t.compactValues=m,t.compactBlankValues=function(e){if(null==e)return;const t=h(e).filter((([e,t])=>null!=e&&r.notBlank(t)));return n.isEmpty(t)?void 0:p(t)},t.mapFields=function(e,t,i={}){return p(n.compact(h(e).sort((([e],[t])=>e.localeCompare(t,void 0,{sensitivity:"base"}))).map((([e,i])=>t(e,i)))).filter((([e,t])=>null!=e&&null!=t)),i)},t.pick=function(e,...t){if(null==e)return e;if(!t.every((e=>"string"==typeof e)))throw new Error("bad keys: "+s.stringify(t));if(n.isEmpty(t))return{};const i={};for(const n of t){const t=e[n];null!=t&&(i[n]=t)}return i},t.pickFirst=function(e,t,i=a.defined){if(null!=e)for(const n of t)if(i(e[n]))return e[n]},t.omit=function(e,...t){if(null==e||t.every((t=>r.blank(e[t]))))return e;const i=h(e).filter((([e])=>!t.includes(e)));return n.isEmpty(i)?void 0:p(i)},t.isReqValued=f,t.reqValuedOrElse=function(e){return f(e)?e:void 0},t.mapReqValued=function(e,t){return f(e)?t(e):void 0},t.onlyReqValued=function(e){return e.filter(f)},t.sortedKeys=function(e){return p(n.sortBy(h(e),(([e])=>e.toLowerCase())))},t.filter=function(e,t){return null==e?e:p(h(e).filter((([e,i])=>t(e,i))))},t.allKeys=function(e){const t=u(e);for(;null!=(e=Reflect.getPrototypeOf(e));)t.push(...Reflect.ownKeys(e).filter((e=>"string"==typeof e)));return n.uniq(t)},t.maybeCall=function(e,t,...i){return null!=e&&o.isFunction(e[t])?e[t].bind(e)(...i):void 0},t.firstValueCaseInsensitive=function(e,t){if(r.blank(t))return;if(null!=e[t])return e[t];const i=t.toLocaleLowerCase().normalize();for(const t of u(e))if(i===t.toLocaleLowerCase().normalize()&&null!=e[t])return e[t]}},34601:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.objectType=t.isObject=t.isFunction=t.isSymbol=t.ObjectType=void 0;const n=i(20810),r=i(8199);var s;function a(e){return"symbol"==typeof e}function o(e){return"function"==typeof e}function l(e){return null==e?s.Empty:a(e)?s.Symbol:r.isPrimitive(e)?s.Primitive:Array.isArray(e)?s.Array:n.isIterable(e)?s.Iterable:o(e)?s.Function:"object"==typeof e?null!=e.constructor&&"Object"===e.constructor.name?s.Object:s.Instance:s.Unknown}!function(e){e[e.Empty=0]="Empty",e[e.Primitive=1]="Primitive",e[e.Symbol=2]="Symbol",e[e.Object=3]="Object",e[e.Array=4]="Array",e[e.Iterable=5]="Iterable",e[e.Instance=6]="Instance",e[e.Function=7]="Function",e[e.Unknown=8]="Unknown"}(s=t.ObjectType||(t.ObjectType={})),t.isSymbol=a,t.isFunction=o,t.isObject=function(e){return l(e)===s.Object},t.objectType=l},98510:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.opt=t.isOpt=t.Some=t.None=void 0,function(e){e.isDefined=!1,e.isEmpty=!0,e.get=()=>{},e.exists=()=>!1;const t=()=>e;e.map=t,e.flatMap=t,e.filter=t,e.forEach=t,e.getOrElse=e=>e(),e.orElse=e=>s(e()),e.zip1=t,e.zip2=t,e.zip3=t}(i||(i={})),t.None=i;class n{constructor(e){this.a=e,this.isDefined=!0,this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new n(e(this.a))}flatMap(e){const t=e(this.a);return r(t)?t:s(t)}filter(e){return s(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,t){return s(e).flatMap((e=>t(this.a,e)))}zip2(e,t,i){return s(e).flatMap((e=>s(t).flatMap((t=>i(this.a,e,t)))))}zip3(e,t,i,n){return s(e).flatMap((e=>s(t).flatMap((t=>s(i).flatMap((i=>n(this.a,e,t,i)))))))}}function r(e){return e instanceof n||e===t.None}function s(e){return r(e)?e:null!=e?new n(e):t.None}t.Some=n,t.isOpt=r,t.opt=s},54608:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenOpt=t.OptAsync=void 0;const n=i(66776);class r{constructor(e){this.a=e}async _map(e,t){const i=null!=this.a?await this.a():void 0,n=s(i)?await i.get():i;return null!=n?e(n):t()}async isDefined(){return this._map((()=>!0),(()=>!1))}async isEmpty(){return this._map((()=>!1),(()=>!0))}async get(){return this._map((e=>e),(()=>{}))}async getRequired(){return this._map((e=>e),(()=>{throw new Error("unexpectedly undefined")}))}async exists(e){return this._map(e,(()=>!1))}map(e){return new r((async()=>this._map(e,(()=>{}))))}flatMap(e){return new r((async()=>this._map(e,(()=>{}))))}filter(e){return new r((async()=>this._map((async t=>await e(t)?t:void 0),(()=>{}))))}catch(e){return new r((()=>this.get().catch((async t=>e(t)))))}forEach(e){return new r((async()=>{const t=await this.get();return await n.map(t,e),t}))}async getOrElse(e){return n.orElse(await this.get(),e)}orElse(e){return new r((async()=>{const t=await this.get(),i=null==t?await e():t;return s(i)?i.get():i}))}}function s(e){return e instanceof r}t.OptAsync=r,t.thenOpt=function(e){return s(e)?e:new r((()=>e))}},33912:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prngSeed=t.SeedCount=t.primeBins=t.primesPerBin=void 0;const n=i(23175);t.primesPerBin=4,t.primeBins=8,t.SeedCount=t.primesPerBin**t.primeBins,t.prngSeed=function(){return n.randomInt(0,t.SeedCount)}},8199:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cmpArr=t.gt=t.gte=t.lte=t.lt=t.cmp=t.isPrimitiveArray=t.mapPrimitiveOr=t.mapPrimitive=t.isPrimitive=void 0;const n=i(11944),r=i(82798),s=["number","string","boolean"];function a(e){return-1!==s.indexOf(typeof e)||e instanceof Date}t.isPrimitive=a,t.mapPrimitive=function(e,t){return a(e)?t(e):void 0},t.mapPrimitiveOr=function(e,t,i){return a(e)?t(e):i()},t.isPrimitiveArray=function(e){return Array.isArray(e)&&e.every(a)};const o=["boolean","number","bigint","symbol","string","object","function"];function l(e,t){if(null==e&&null==t)return 0;if(null==e)return-1;if(null==t)return 1;const i=typeof e,n=typeof t;return"string"!==i&&"symbol"!==i||"string"!==n&&"symbol"!==n?Array.isArray(e)&&Array.isArray(t)?u(e,t):i!==n?o.indexOf(i)-o.indexOf(n):e>t?1:e<t?-1:0:r.toS(e).localeCompare(r.toS(t))}function u(e,t){if(n.isEmpty(e)&&n.isEmpty(t))return 0;const i=Math.min(e.length,t.length);for(let n=0;n<i;n++){const i=l(e[n],t[n]);if(0!==i)return i}return l(e.length,t.length)}t.cmp=l,t.lt=function(e,t){return l(e,t)<0},t.lte=function(e,t){return l(e,t)<=0},t.gte=function(e,t){return l(e,t)>=0},t.gt=function(e,t){return l(e,t)>0},t.cmpArr=u},26588:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isPromise=t.thenTap=t.thenCollect=t.thenMap=void 0;const n=i(39784);t.thenMap=async function(e,t){const i=await e;return null==i?void 0:t(i)},t.thenCollect=async function(e,t){const i=[];for(const r of n.toA(await e))if(null!=r){const e=await r;if(null!=e){const n=await t(e);null!=n&&i.push(n)}}return i},t.thenTap=async function(e,t=console.dir.bind(console)){const i=await e;return await t(i),i},t.isPromise=function(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch}},46234:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PromiseStates=void 0;const n=i(84253);t.PromiseStates=n.strEnum("pending","resolved","rejected")},23175:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickWeightedRandom=t.sample=t.shuffle=t.pickRandom=t.randomChar=t.randomChars=t.RandomChars=t.randomFloat=t.randomInts=t.randomInt=void 0;const n=i(11944),r=i(75556);function s(e,t,i=[]){if(e=Math.ceil(e),(t=Math.floor(t))<e)return e;if(n.isNotEmpty(i)&&i.length+10>t-e){const r=n.range(e,t).filter((e=>!i.includes(e)));return n.mapNotEmpty(r,(e=>e[s(0,r.length)]))}const r=Math.floor(Math.random()*(t-e))+e;return i.includes(r)?s(e,t,i):r}function a(e,t){return Math.random()*(t-e)+e}function o(e=t.RandomChars){return e[s(0,e.length)]}function l(e){const t=[...e];for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));e!==i&&([t[e],t[i]]=[t[i],t[e]])}return t}t.randomInt=s,t.randomInts=function(e,t,i){const n=[];for(;n.length<i;)n.push(s(e,t,n));return n},t.randomFloat=a,t.RandomChars="0123456789abcdefghijkmnopqrstuvwxyz",t.randomChars=function(e,i=t.RandomChars){let n="";for(let t=0;t<e;t++)n+=o(i);return n},t.randomChar=o,t.pickRandom=function(e){return e[s(0,e.length)]},t.shuffle=l,t.sample=function(e,t){if(t<e.length/10){const i=new Set;for(;i.size<t;)i.add(s(0,e.length));return[...i.keys()].map((t=>e[t]))}return l([...e]).slice(0,t)},t.pickWeightedRandom=function(e){if(n.isEmpty(e))return;const t=e.filter((e=>r.gt0(e.priority)));let i=a(0,n.sum(t,(e=>e.priority)));return t.find((e=>(i-=e.priority,i<=0)))}},33714:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flippable=t.normalizeRotation=t.isRotation=void 0;const n=i(66776),r=i(75556);function s(e){return r.isNumber(e)&&[0,90,180,270].includes(e)}function a(e){const t=n.map(e,(e=>r.round(e+360*Math.ceil(-e/360))));return s(t)?t:void 0}t.isRotation=s,t.normalizeRotation=a,t.flippable=function(e){const t=a(e);return 90===t||270===t}},84253:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.strEnum=void 0;const n=i(90957);t.strEnum=function(...e){const t=Object.freeze(e),i={};for(const e of t)i[e]=e;const r=e=>null!=e&&t.includes(e);return{...i,values:t,length:t.length,has:r,includes:r,indexOf:e=>null==e?-1:t.indexOf(e),validOrElse:(e,t)=>r(e)?e:n.tot(t),mapValid:(e,t)=>r(e)?t(e):void 0}}},44726:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compressWhitespace=t.replaceAll=t.eqlStrings=t.wrap=t.leftIndexOf=t.newlineRe=t.ellipsize=t.ensureSuffix=t.ensurePrefix=t.strslice=t.strlen=t.charAt=t.isBMP=t.isString=void 0;const n=i(11944),r=i(37609),s=i(82798);function a(e){for(let t=e.length-1;t>=0;t--)if(e.charCodeAt(t)!==e.codePointAt(t))return!1;return!0}function o(e,t,i){return a(e)?(t<0&&(t+=e.length),null!=i&&i<0&&(i+=e.length),e.substring(t,i)):[...s.toS(e)].slice(t,i).join("")}function l(e,t){return e=s.toS(e),t=s.toS(t),e.startsWith(t)?e:t+e}function u(e,t,i){null==i&&(i=e.length);for(let n=i;n>=0;n--)if(o(e,n).startsWith(t))return n;return-1}t.isString=function(e){return"string"==typeof e},t.isBMP=a,t.charAt=function(e,t){if(a(e)){if((t=Math.trunc(t)||0)<0&&(t+=e.length),t<0||t>=e.length)return;return e[t]}return r.at([...s.toS(e)],t)},t.strlen=function(e){return a(e)?e.length:[...e].length},t.strslice=o,t.ensurePrefix=l,t.ensureSuffix=function(e,t){return e=s.toS(e),t=s.toS(t),e.endsWith(t)?e:e+t},t.ellipsize=function(e,t=80){if(null==e)return"";const i=[...s.toS(e)];return i.length<=t?i.join(""):i.slice(0,t-1).join("")+"â¦"},t.newlineRe=/\r?\n/gm,t.leftIndexOf=u,t.wrap=function e(i,r={maxLineLen:75,prefix:""}){if(i.includes("\n"))return n.flatten(i.split(t.newlineRe).map((t=>e(t,r))));if((i=l(s.toS(i),r.prefix).trim()).length<=r.maxLineLen)return[i];const a=u(i," ",r.maxLineLen);if(a>r.prefix.length)return[o(i,0,a),...e(o(i,a+1),r)];{const t=i.indexOf(" ",r.prefix.length+1);return t>0&&t<i.length-1?[o(i,0,t),...e(o(i,t+1),r)]:[i]}},t.eqlStrings=function(e,t){return null!=e&&null!=t&&(e===t||e.normalize()===t.normalize())},t.replaceAll=function(e,t,i){return""===t?e:e.split(t).join(i)},t.compressWhitespace=function(...e){return e.join(" ").replace(/\s+/g," ").trim()}},93667:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagUrls=void 0;const n=i(66776),r=i(49049);t.TagUrls=class{constructor(e){this.id=e}nextAssetBatch(e){const t={};return n.map(e,(e=>t.capturedAtLt=e.getTime())),r.assembleUri(`/tag-gallery/${this.id}`,t)}}},26719:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=void 0,t.throttle=function(e,t,i=!1){let n=i?Date.now()+t:0,r=0;const s=(...i)=>{const s=Date.now();return s>=n?(n=s+t,r++,e(...i)):void 0};return s.count=()=>r,s}},90957:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOp=t.firstDefinedSuccess=t.firstDefinedThunk=t.tot=void 0;const n=i(34601);t.tot=function(e){return n.isFunction(e)?e():e},t.firstDefinedThunk=function(e){for(const t of e){const e=t();if(null!=e)return e}},t.firstDefinedSuccess=function(e){for(const t of e)try{const e=t();if(null!=e)return e}catch{}},t.NoOp=()=>{}},49049:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PS_NETWORK_FILESYSTEM_PROTOCOL=t.PS_LOCAL_FILE_PROTOCOL=t.PS_LIBRARY_PROTOCOL=t.joinQuery=t.assembleUri=void 0;const n=i(11944),r=i(61570),s=i(82798);function a(e){if(null==e)return"";const t=r.entries(e).filter((([,e])=>null!=e));return n.isEmpty(t)?"":t.map((e=>e.map(s.toS).map(encodeURIComponent).join("="))).join("&")}t.assembleUri=function(e,t){const i=a(t);return""===i?e:e+"?"+i},t.joinQuery=a,t.PS_LIBRARY_PROTOCOL="pslib",t.PS_LOCAL_FILE_PROTOCOL="psfile",t.PS_NETWORK_FILESYSTEM_PROTOCOL="psnet"},17078:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.plurMetric=t.plur=t.pixels2size=t.SizeDescriptions=t.megapixels=t.MP=t.fmtMebi=t.fmtBytes=t.TiB=t.GiB=t.MiB=t.KiB=t.TB=t.GB=t.MB=t.KB=t.fmtToInt=t.fmt=t.decimalSep=t.thousandsSep=void 0;const n=i(39938),r=i(11448),s=i(75556),a=i(84253),o=i(44726),l=r.lazy((()=>new Intl.NumberFormat));function u(e){return l().format(e)}t.thousandsSep=r.lazy((()=>o.replaceAll(l().format(1111),"1","").charAt(0))),t.decimalSep=r.lazy((()=>o.replaceAll(l().format(1.1),"1","").charAt(0))),t.fmt=u,t.fmtToInt=function(e){return n.mapNotBlank(e,(e=>s.toInt(o.replaceAll(e,t.thousandsSep(),""))))},t.KB=1e3,t.MB=1e3*t.KB,t.GB=1e3*t.MB,t.TB=1e3*t.GB,t.KiB=1024,t.MiB=1024*t.KiB,t.GiB=1024*t.MiB,t.TiB=1024*t.GiB;const c=["B","KB","MB","GB","TB","PB"],d=["B","KiB","MiB","GiB","TiB","PiB"];t.fmtBytes=function(e,t=3){if(0===e)return"0";if(!s.isNumber(e))return"-";const i=Math.floor(Math.log10(e)),n=Math.floor(i/3),r=Math.pow(10,3*n),a=c[n];return s.sigFigs(e/r,t)+" "+a},t.fmtMebi=function(e,t=3){const i=Math.floor(Math.log2(e)),n=Math.floor(i/10),r=Math.pow(2,10*n),a=d[n];return s.sigFigs(e/r,t)+" "+a},t.MP=1e6,t.megapixels=function(e){return s.sigFigs(e/t.MP,2)},t.SizeDescriptions=a.strEnum("tiny","small","medium","large","original"),t.pixels2size=function(e){return e<76800?"tiny":e<345600?"small":e<2073600?"medium":"large"},t.plur=function(e,t,i=t+"s"){return u(e)+" "+(1===e?t:i)},t.plurMetric=function(e,t,i=t+"s"){return{count:u(e),desc:1===e?t:i}}},96518:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isFirefox=t.isChrome=t.isSafari=void 0;const n=i(82798);t.isSafari=function(e){return n.toS(e).includes(" Safari/")},t.isChrome=function(e){return n.toS(e).includes(" Chrome/")},t.isFirefox=function(e){return n.toS(e).includes(" Firefox/")}},88012:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.idEql=t.id2id=void 0;const n=i(66776),r=i(75556);function s(e){const t=e;return null==t?void 0:r.gt0(t)?t:r.gt(t.id,-20)?t.id:r.gt0(t.assetId)?t.assetId:r.gte0(t.tagId)?t.tagId:void 0}t.id2id=s,t.idEql=function(e,t){return n.map2Or(s(e),s(t),((e,t)=>e===t),(()=>!1))}},35666:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.S=void 0;const n=i(84253);t.S=n.strEnum("plus","lite")},11254:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isInfoTag=t.NotInfoPanelTags=t.TagRoots=t.ctxToS=t.TagGalleryProps=t.nextChildTagsUrl=t.nextAssetsUrl=t.BeforeAfterStreamLimit=t.ThumbsPerSample=void 0;const n=i(11944),r=i(87748),s=i(75556),a=i(84253),o=i(44726),l=i(49049);t.ThumbsPerSample=128,t.BeforeAfterStreamLimit=8,t.nextAssetsUrl=function(e,t){const i={};return s.mapNumeric(t.capturedAtLt,(e=>i.capturedAtLt=e.toString())),s.mapNumeric(t.capturedAtGt,(e=>i.capturedAtGt=e.toString())),s.mapNumeric(t.limit,(e=>i.limit=e.toString())),l.assembleUri(`/api/t/${e}/assets`,i)},t.nextChildTagsUrl=function(e,t){const i={};return s.mapNumeric(t.seed,(e=>i.seed=e.toString())),s.mapNumeric(t.limit,(e=>i.limit=e.toString())),s.mapNumeric(t.offset,(e=>i.offset=e.toString())),l.assembleUri(`/api/t/${e}/child-tags`,i)},t.TagGalleryProps=["tagId","tagPath","assetCount","assetIds","nextAssets","childTags","nextChildTags"],t.ctxToS=function(e){return r.stringify({seed:e.seed,tagIds:n.sort([...e.tagIds])})},t.TagRoots=a.strEnum("When","Who","Where","What","Camera","Lens","Albums","Keywords","Type","fs"),t.NotInfoPanelTags=[t.TagRoots.When,t.TagRoots.Camera,t.TagRoots.Lens,t.TagRoots.Type,t.TagRoots.fs],t.isInfoTag=function(e){var i;if(null==e)return!1;const n=o.isString(e)?e:null===(i=e.tagPath)||void 0===i?void 0:i[0];return!t.NotInfoPanelTags.includes(n)}},61560:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fmtDuration=void 0;const n=i(11944),r=i(88491),s=i(66776),a=i(75556),o=i(17078),l=[{ms:r.yearMs,s:"year",p:"years"},{ms:30.4*r.dayMs,s:"month",p:"months"},{ms:r.weekMs,s:"week",p:"weeks"},{ms:r.dayMs,s:"day",p:"days"},{ms:r.hourMs,s:"hour",p:"hours"},{ms:r.minuteMs,s:"minute",p:"minutes"},{ms:r.secondMs,s:"second",p:"seconds"}];t.fmtDuration=function e(t,i=2,r){if(!a.gte0(t))return a.isNumber(t)?"-"+e(Math.abs(t),i):"";const u=l.findIndex((e=>e.ms<=t));if(-1===u)return"";let c=t;const d=n.compact(l.slice(u,u+i).map((e=>{if(!(e.ms>c)){const t=Math.floor(c/e.ms);return c-=t*e.ms,{i:t,s:o.plur(t,e.s,e.p)}}})));return n.isEmpty(d)?"":d.map((e=>e.s)).join(", ")+s.mapOr(r,(e=>" "+(1!==d[d.length-1].i?e.singular:e.plural)),"")}},39784:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toA=void 0;const n=i(20810);t.toA=function(e){return null==e?[]:Array.isArray(e)?e:n.isIterable(e)?Array.from(e):[e]}},82798:(e,t)=>{"use strict";function i(e,t=","){return null==e?"":"string"==typeof e?e:Array.isArray(e)?e.map((e=>i(e,t))).join(t):e.toString()}Object.defineProperty(t,"__esModule",{value:!0}),t.toStr=t.toS=void 0,t.toS=function(e){return i(e,",")},t.toStr=i},46022:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BroadcasterImpl=void 0;const n=i(46852),r=i(93850),s=i(71002);t.BroadcasterImpl={broadcast:(e,t)=>n.thenMapOr(s.rpcServer(),(i=>i.broadcast(e,t)),(()=>n.thenMap(r.rpcClient(),(i=>i.broadcast(e,t)))))}},64303:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.forceRebuildLibrary=void 0;const n=i(93813),r=i(75179),s=i(30690),a=i(89452),o=i(9069),l=i(36310);t.forceRebuildLibrary=function(){return r.tx(o.modelDb(),(async()=>{await s.Asset.dbl.runf((e=>e.update({version:0}))),await a.AssetFile.dbl.runf((e=>e.update({version:0}))),await l.Operation.dbl.runf((e=>e.where({name:l.OperationNames.enqueueAssetFileUpdates,version:n.AssetFileVersion}).orWhere({name:l.OperationNames.enqueueAssetUpdates,version:n.AssetVersion}).delete()))}))}},30394:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.runvalve=t.doNotRun=t.healthChecks=t.syncSettingsCheck=t.memoryCheck=t.memoryUsageIsHigh=void 0;const n=i(36079),r=i(95557),s=i(46852),a=i(1315),o=i(10408),l=i(49379),u=i(7162),c=i(68114),d=i(19658),h=i(55568),p=i(43414),m=i(29916),f=i(11944),g=i(39938),y=i(16475),v=i(87748),w=i(11448),b=i(75556),S=i(17078),M=i(23297);t.memoryUsageIsHigh=function(){return p.Settings.maxMemoryMb.valueOrDefault<c.memoryUsageBytes()/S.MB};const P=w.lazy((()=>new r.EndableWrapper("memoryCheck on exit",(()=>{const e=u.mkLogger("PromiseTimer"),t=E();e.log(a.hasWarn(t)?"warn":"info","memory use on exit:",t)}),n.EndableRanks.service)));function E(){P();const e=[],t=[],i=[];function n(n,r,s){if(!b.gt0(n))return o.onError("memoryCheck(): invalid bytesUsed. "+v.stringify({bytesUsed:n,desc:s})+l.HealthCheckErrorFlag);const a=n/S.MB,u=`used by ${h.serviceName()} (${S.fmtBytes(n,2)})`;a>=r?i.push(`${s} ${u} is high`):a>=.8*r?t.push(`${s} ${u} is high`):e.push(`${s} ${u} is OK`)}return n(c.memoryUsageBytes(),p.Settings.maxMemoryMb.valueOrDefault,"Used memory"),n(c.memoryUsageRssBytes(),p.Settings.maxRssMemoryMb.valueOrDefault,"RSS memory"),{ok:e,warn:t,bad:i}}async function T(){try{return a.concatHealthChecks(await M.libraryHealthChecks(),E())}catch(e){return a.fullhc({fail:[g.notBlankOr(y.errorToS(e),"healthChecks failed")]})}}async function x(){if(m.isPaused()||n.ending())return!0;const e=await T();return null==e||f.isNotEmpty(e.fail)||f.isNotEmpty(e.bad)||f.isNotEmpty(e.warn)}t.memoryCheck=E,t.syncSettingsCheck=function(){return d.isTest||p.Settings.scanAllDrives.valueOrDefault||!f.isEmpty(p.Settings.scanPaths.values)?{}:{warn:["Nothing to scan: scanAllDrives is false and scanPaths is empty."]}},t.healthChecks=T,t.doNotRun=x,t.runvalve=function(){return s.thenNot(x())}},49374:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Library=void 0;const n=i(36079),r=i(95557),s=i(46852),a=i(28801),o=i(10408),l=i(49379),u=i(3955),c=i(98250),d=i(78432),h=i(19371),p=i(53370),m=i(55568),f=i(71395),g=i(43414),y=i(82041),v=i(53719),w=i(39938),b=i(38625),S=i(88491),M=i(6314),P=i(11448),E=i(66776),T=i(61570),x=i(46022),D=i(57527),C=i(34490),k=i(31457),I=i(18935),F=i(93850),O=i(36376),A=i(89749),_=i(47707),L=i(97840);class R extends r.EndableWrapper{constructor(e){super(`Library(${e})`,(()=>this.onEnd()),n.EndableRanks.predb),this.start=Date.now(),this._ready=new M.Latch,this.setup=P.lazy((async()=>{var e;const t=()=>{if(this.ended||n.ending())throw new Error};try{if(this.logger.debug("setup() started"),!y.libraryHasSettings()){if(!m.isWelcomeService())throw new Error("Cannot run "+m.serviceName()+" without a library"+l.FatalErrorFlag+l.DoNotSendErrorFlag);return void this.logger.warn("Library settings don't exist yet. Skipping setup.")}await(null===(e=this.openedBy())||void 0===e?void 0:e.throwIfUnavailable("(library setup)")),t(),await f.setupLibraryDataDir(this.rootDir),await y.readLibrarySettings(this.rootDir.nativePath);const i=this.originalsDir();if(null==i||null==await i.mkdirp()||!await i.isReadWritable())throw new Error(`Invalid value for ${g.Settings.originalsDir.key}: ${i} must be readable and writable.`);await this.statsDbDir(),await d.imgCacheDir(),t(),p.setBroadcasterIfUnset(x.BroadcasterImpl),m.isRpcClient()&&await F.rpcClientReady()&&(await D.checkRemoteVacuuming(),O.setupVolumeRpc()),t(),await this.modelDb(),t(),m.isStatsDbClient()&&await this.statsDb()}catch(e){this.ended||n.ending()||(o.onError("Library.setup() failed"+(m.isWebService()?"":l.FatalErrorFlag),e),this._ready.reject(e))}finally{this._ready.pending&&(this.logger.info("Library.setup() finished."),this._ready.resolve())}})),this.openedBy=P.lazy((()=>g.Settings.skipLibraryOpenLocks.valueOrDefault?void 0:new I.OpenedByIO(this.dataDir))),this.statsDbDir=P.lazy((()=>_.statsDbDir())),this.previews=P.lazy((()=>new h.Previews(this.rootDir.join(g.Settings.previewsDir.valueOrDefault),C.DbAdvisoryLockProvider))),this.originalsDir=P.lazy((()=>f.libraryOriginalsDir(this.rootDir))),this.assetFileRepository=P.lazy((()=>new L.AssetFileRepository(this.originalsDir(),(()=>g.Settings.copyAssetsToLibrary.valueOrDefault)))),this.modelDbJanitor=P.lazy((async()=>k.ModelDbJanitor.for({dataDir:this.dataDir}))),this.modelDb=P.lazy((async()=>(await this.modelDbJanitor()).db.promise)),this.statsDb=P.lazy((async()=>A.statsDbJanitor(await this.statsDbDir()))),this.statsDbFile=P.lazy((()=>this.statsDb().then((e=>e.dbfile)))),this.onEnd=P.lazy((async()=>{for(const{ea:e,t}of[{ea:this.statsDb,t:v.CmdTimeoutMs},{ea:this.modelDbJanitor,t:S.minuteMs},{ea:this.openedBy,t:v.CmdTimeoutMs}])await E.map(await e.clear(),(e=>n.end(e,t)));this.logger.info("onEnd(): finished.")})),this.rootDir=c.PosixFile.for(e),this.dataDir=f.libraryDataDir(this.rootDir),this.logger.info("new()")}static libraryPathChanged(){return E.map(g.Settings.libraryPath.value,u.resolve)!==E.map(this.priorInstance,(e=>e.rootDir.nativePath))}static instance(){var e;const t=this.libraryPathChanged(),i=b.isTrue(null===(e=this.priorInstance)||void 0===e?void 0:e.ended);let r;return(t||i)&&(r=n.end(this.priorInstance,S.minuteMs),this.priorInstance=void 0),null==this.priorInstance&&y.libraryHasSettings()&&(this.priorInstance=w.mapNotBlank(g.Settings.libraryPath.value,(e=>T.tap(new R(e),(async e=>(await r,e.setup())))))),this.priorInstance}static instanceRequired(){const e=R.instance();if(null==e)throw new Error("Library is undefined"+l.FatalErrorFlag);return e}get isPendingSetup(){return this._ready.pending}get ready(){return this._ready.promise}async requiredFiles(){const e=[];return await u.nativePathIsReadableDirectory(g.Settings.cacheDir.valueOrDefault)&&e.push({desc:"Cache directory",isDir:!0,file:()=>a.cacheDir()}),this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library model DB",isDir:!1,file:()=>s.thenMap(this.modelDbJanitor(),(e=>e.srcDbFile))},{desc:"Library model DB (local replica)",isDir:!1,file:()=>s.thenMap(this.modelDbJanitor(),(e=>e.localDbReplica))}),e}}t.Library=R},93445:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.libraryFileFilter=t.libraryFileFilters=void 0;const n=i(91419),r=i(23872),s=i(7162),a=i(11448),o=i(13222),l=n.AsyncFilter.lift((async e=>{const t=await e.sha();return null!=t&&!await o.isShaBlockslisted(t)}));t.libraryFileFilters=a.lazy((()=>[...r.expensiveFileFilters(),{shaBlocklistFilter:l}])),t.libraryFileFilter=a.lazy((()=>n.AsyncFilter.andLogged(s.mkLogger("libraryFileFilter"),...t.libraryFileFilters())))},23297:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.copyExampleImageToLibraryDir=t.libraryHealthChecks=void 0;const n=i(61765),r=i(1315),s=i(10408),a=i(49379),o=i(79141),l=i(79015),u=i(98462),c=i(27175),d=i(7162),h=i(99312),p=i(71663),m=i(71395),f=i(43414),g=i(82041),y=i(44546),v=i(46573),w=i(53719),b=i(11944),S=i(39938),M=i(88491),P=i(43947),E=i(16475),T=i(11448),x=i(23175),D=i(39784),C=i(17078),k=i(30394),I=i(49374),F=i(77910),O=i(91476),A=d.mkLogger("LibraryHealthChecks");function _(){R.unset(),t.libraryHealthChecks.unset()}function L(){return _(),t.libraryHealthChecks.refresh()}t.libraryHealthChecks=T.lazy((()=>async function(){if(O.healthChecksArePaused())return{ok:["Library health checks are paused"]};if(!f.Settings.libraryPath.hasValue()&&!g.libraryHasSettings())return{ok:["Library isn't set up yet"]};const e=I.Library.instance();if(null==e)return g.libraryHasSettings()?{fail:["Missing library at "+f.Settings.libraryPath.value]}:{};if(e.isPendingSetup){e.ready.then((()=>t.libraryHealthChecks.unset()));const i=Date.now()-e.start;return i<w.CmdTimeoutMs?{ok:["Library is setting up..."]}:i<3*M.minuteMs?{warn:["Library is taking a long time to set up..."]}:{fail:["Library took too long time to set up."]}}try{await e.ready}catch(e){return{fail:["Library setup failed: "+s.errorToHumanString(e)]}}const i=[],l=[],u=[],c=[],d=async e=>{try{return await e()}catch(t){return c.push(t),A.warn("trap(): failed to run "+e.name+": "+E.errorToVerbose(t)),void u.push(s.errorToHumanString(t))}};if(await d((()=>{var t;return null===(t=e.openedBy())||void 0===t?void 0:t.throwIfUnavailable("(library health check)")})),f.Settings.healthCheckExiftool.valueOrDefault&&await d((()=>y.exiftoolVersionMaybe())),f.Settings.healthCheckLibraryIsWritable.valueOrDefault&&await d((()=>R().catch((e=>{throw new o.WrappedError({cause:e,message:"Cannot write to "+m.libraryOriginalsDir(),fatal:!0})})))),h.isWin)try{const e=await p.PowerShell.instance().version();S.blank(e)&&u.push("PowerShell isn't working (can't get version).")}catch(e){c.push(e),u.push(`PowerShell isn't working (${s.errorToHumanString(e)}).`)}if(f.Settings.healthCheckFreeSpace.valueOrDefault||f.Settings.healthCheckVolumes.valueOrDefault){const t=await d((()=>v.volumes()));if(b.isEmpty(t))u.push("Failed to scan system volumes."+a.FatalErrorFlag);else if(f.Settings.healthCheckFreeSpace.valueOrDefault)for(const i of await e.requiredFiles())try{const e=await i.file();if(null==e)continue;if(e.clear(),i.isDir&&!await e.isDirectory())u.push(`${i.desc}, ${e}, is missing`+a.FatalErrorFlag);else if(b.isNotEmpty(t)){const n=v.bestVolume(t,e.nativePath);A.debug("checkDir()",{dir:e.nativePath,desc:i.desc,bestVolume:n,vols:t.map((e=>e.mountpoint))}),null==n?e.isUNC?l.push(`${i.desc}, ${e}: cannot be monitored for sufficient free space. Consider using a mapped network drive instead.`):u.push(`${i.desc}, ${e}, doesn't seem to have a mountpoint (?!)`):n.available<f.Settings.minDiskFreeGb.valueOrDefault*C.GB&&l.push(`Only ${C.fmtBytes(n.available)} are available on ${n.mountpoint}.`)}}catch(e){c.push(e),u.push("Failed to check "+i.desc+": "+s.errorToHumanString(e))}}return b.isEmpty(u)&&b.isEmpty(l)&&i.push("Library and support directories are OK"),S.notBlank(n.env.TEST_FAIL)&&u.unshift(...n.env.TEST_FAIL.split(",")),S.notBlank(n.env.TEST_WARN)&&l.unshift(...n.env.TEST_WARN.split(",")),f.Settings.healthCheckDb.valueOrDefault&&await d((()=>F.Heartbeat.assertPing())),u.map((e=>s.onError(e+a.HealthCheckErrorFlag))),r.concatHealthChecks({ok:i,warn:l,bad:[],fail:u},k.syncSettingsCheck())}()),15*M.secondMs),P.later((()=>{f.Settings.libraryPath.addListener(_),l.onVolumesChanged(L),l.onSettingsChanged(L),l.onNonFatal(_)}));const R=T.lazy((async()=>N(m.libraryOriginalsDir())),M.hourMs);async function N(e){if(null==e)return A.throw("copyExampleImageToLibraryDir(): undefined rootDir");const t=D.toA(await u.BaseFile.for(c.ProjectPath.Public()).join("images").children()).find((e=>e.name.startsWith("splash")));if(null==t)return A.throw("copyExampleImageToLibraryDir(): missing validation image");const i=(e=u.BaseFile.for(e)).join(".tmp-"+x.randomChars(6)),n=i.join("write-test"+t.ext);try{await t.copyFile_(n);if(await t.sha()!==await n.sha())return A.throw("Failed to copy sample file to library. Is "+e+" writable?",{ignorable:!0});A.debug(`Library root directory, ${e}, is writable`)}finally{await i.rmrf("debug")}}t.copyExampleImageToLibraryDir=N},15868:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localDbDir=void 0;const n=i(28801),r=i(11448);t.localDbDir=r.lazy((async()=>{const e=n.cacheDir().join("local-db");return await e.join("README.txt").writeTxt_("\nThis folder is only used when your library is on a remote filesystem.\n\nYou will corrupt your library if you remove this directory while PhotoStructure is\nrunning.\n\nIf you have any questions, please visit <https://photostructure.com/support/>."),e}))},57567:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MainService=void 0;const n=i(61765),r=i(34996),s=i(36079),a=i(28807),o=i(95557),l=i(46852),u=i(70259),c=i(95237),d=i(1315),h=i(10408),p=i(49379),m=i(79015),f=i(41663),g=i(98462),y=i(98250),v=i(86664),w=i(7162),b=i(47858),S=i(70283),M=i(92661),P=i(53370),E=i(71395),T=i(43414),x=i(82041),D=i(97198),C=i(53719),k=i(29916),I=i(39938),F=i(38625),O=i(88491),A=i(43947),_=i(11448),L=i(66776),R=i(61570),N=i(82798),B=i(64303),j=i(30394),z=i(49374),V=i(34490),W=i(91476),q=i(71002),U=i(20990),H=i(81520),G=i(47707),J=i(87186);t.MainService=class{constructor(){this.start=Date.now(),this.logger=_.lazy((()=>w.mkLogger("MainService"))),this.httpPort=new r.Deferred("MainService.httpPort"),this.libraryPath=new r.Deferred("MainService.libraryPath"),this.setup=_.lazy((async()=>{await I.mapNotBlank(T.Settings.pidfile.value,(async e=>{const t=g.BaseFile.for(e);this.logger().info("Writing to pidfile "+t,{pid:n.pid}),await t.writeTxt_(N.toS(n.pid)),new o.EndableWrapper("remove pidfile",(()=>t.unlink()),s.EndableRanks.postdb)}));const e=e=>D.consoleLog(e.op+" ("+e.pct+"%)");f.onProgressEvt(e);const t=_.lazy((()=>D.consoleLog("Upgrading your library database...")));if(m.onMigration(t),await this.service.ready,T.Settings.startPaused.valueOrDefault&&(this.logger().info("Settings.startPaused: pausing on startup."),k.pause()),await q.rpcServer(),this.service.setInputHandler("--restart-sync",(()=>this.restartSync())),this.service.setInputHandler("--bounce",(()=>this.bounce())),this.service.setInputHandler("--status",(async()=>{const e=await j.healthChecks(),t=await l.thenOrElse(this.web.healthCheck(),(()=>({fail:["could not reach web"]}))),i=await l.thenMap(this.sync,(e=>l.thenOrElse(e.healthCheck(),(()=>({fail:["could not reach sync"]})))));J.stdoutWrite(d.uniqhc(e,t,i))})),this.web=await c.ChildService.mk("web",{onData:e=>this.onWebData(e),healthy:()=>this.webHealthCheck()}),null==this.web)return h.onError("Failed to start webservice"+p.FatalErrorFlag);x.libraryHasSettings()&&(await V.AdvisoryLock.vacuum(0),await this.restartSync()),m.onPause((()=>this.onPause())),m.onResume((()=>this.onResume())),M.ProcCleaner(),this.httpPort.promise.then((e=>{D.consoleLog(`PhotoStructure is ready: <http://localhost:${e}/>`)})),this.libraryPath.promise.then((e=>{D.consoleLog(`Your library is at ${e}`)})),new o.EndableWrapper("shutdown notice",(()=>D.consoleLog("\nShutting down PhotoStructure...")),s.EndableRanks.first),f.removeProgressEvtListener(e),m.eventEmitter.removeListener("migration",t),new v.TmpfileCleanup((()=>y.PosixFile.for(T.Settings.logDir.valueOrDefault)),O.weekMs,(e=>[".log",".log.gz"].includes(e.ext)))})),this.setupBounceInterval=_.lazy((async()=>(await x.readSystemSettings(),S.mapGt0(T.Settings.bounceMinutes.valueOrDefault,(e=>new a.EndableInterval({name:"web/sync bounce",intervalMs:e*O.minuteMs,callback:()=>this.bounce()})))))),this.bounce=u.maybeRun("MainService.bounce()",(async()=>{var e;const t=w.mkLogger("MainService.bounce()");if(await x.readSystemSettings(),!x.libraryHasSettings())return t.warn("no library set up yet: no-op.");if(null==this.web)return t.error("web service was null");if(null==await E.libraryDataDir())return t.throw("libraryDataDir() returned null",{libraryPath:T.Settings.libraryPath.value});t.info("shutting down sync..."),await l.thenMap(this.sync,(e=>e.stop())),t.info("sync stopped.");const i=L.map(this.web,(e=>e.pid));t.info("shutting down web...",{priorWebPid:i}),await L.map(this.web,(e=>e.stop())),t.info("web stopped.",{priorWebPid:i}),t.info("killing old procs..."),await M.Pids.instance().killOldProcs({everything:!0}),await l.thenMap(null===(e=z.Library.instance())||void 0===e?void 0:e.modelDb(),(e=>e.maybeRepair())),t.info("restarting web..."),await this.web.start()})),this.service=new U.Service({name:"main"}),this.setup(),A.delay(4*O.secondMs).then((()=>{this.httpPort.pending&&!s.ending()&&D.consoleLog("Please wait, setting up...")}))}async webHealthCheck(){const e=this.httpPort.value;if(null!=e)try{const t=await b.httping("localhost",e,"/ping",C.CmdTimeoutMs);return!!S.within(200,299,t)||(this.logger().warn("webHealthCheck(): web service returned "+t),!1)}catch(e){return this.logger().warn("webHealthCheck(): httping error: "+e),!1}else this.logger().info("webHealthCheck(): no-op, no http port set (web is starting up still)")}async onWebData(e){I.blank(e)||(await L.map(e[T.Settings.libraryPath.key],(async e=>{T.Settings.libraryPath.value!==e&&(this.logger().info("Got new library path from web service:"+e),T.Settings.libraryPath.tmpValue=e,await L.map(z.Library.instance(),(e=>e.ready)),this.libraryPath.maybeResolve(e),m.emitSettingsChanged())})),L.map(e[T.Settings.httpPort.key],(e=>{this.logger().info("Got HTTP port number from web service:"+e),T.Settings.httpPort.tmpValue=e,this.httpPort.maybeResolve(e)})),I.mapNotBlank(e.migration,m.emitMigration),F.mapBoolean(e.pauseHealthChecks,(e=>e?W.pauseHealthChecks():W.resumeHealthChecks())),F.mapBoolean(e.pause,(e=>e?k.pause():k.resume())),await F.mapTrue(e.shutdown,(()=>this.service.exit({reason:"shutdown requested",status:0,waitForJobs:!0}))),await F.mapTrue(e.shutdownSync,(()=>this.shutdownSync())),await F.mapTrue(e.restartSync,(()=>this.restartSync())),await F.mapTrue(e.forceRestartSync,(()=>this.forceRestartSync())),I.mapNotBlank(e.event,(t=>P.broadcast(t,e.args))))}shutdownSync(){this.logger().info("shutdownSync()",{syncWasDefined:null!=this.sync}),s.end(this.sync),this.sync=void 0}async rebuildLibrary(){return this.restartSync((()=>B.forceRebuildLibrary()))}async forceRestartSync(){return this.restartSync((async()=>{L.map(H.statsDb(),(e=>e.closeDb())),await l.thenMap(G.statsDbDir(!1),(e=>e.rmrf("info")))}))}async restartSync(e){await l.thenMap(this.setupBounceInterval.clear(),s.end),await this.setupBounceInterval();const t=w.mkLogger("MainService.restartSync()");if(s.ending())return void t.info("ending, no-op");const i=await this.sync;if(t.info("priorSync",L.map(i,(e=>R.pick(e,"pid","name")))),await s.end(i),this.sync=void 0,await x.readSystemSettings(),!x.libraryHasSettings())return void t.info("restartSync(): no library settings",{libraryPath:T.Settings.libraryPath.value});if(null!=e&&await e(),k.isPaused())return void t.info("paused. no-op");const n=await(this.sync=c.ChildService.mk("sync"));t.info("Started sync",L.map(n,(e=>R.pick(e,"pid","name"))))}async onPause(){return this.sendToChildren("--pause")}async sendToChildren(e){return Promise.all([l.thenMap(this.web,(t=>t.write(e))),l.thenMap(this.sync,(t=>t.write(e)))])}async onResume(){await this.sendToChildren("--resume"),null==await this.sync&&!0===await this.webHealthCheck()&&(this.logger().info("onResume(): starting sync."),await this.restartSync())}}},18935:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenedByIO=t.currentLibraryLockOwner=t.expectedJson=t.isLockOwner=t.openedByFiles=t.StaleMs=t.maybeRemovePriorLocks=void 0;const n=i(64298),r=i(12087),s=i(61765),a=i(13779),o=i(36079),l=i(95557),u=i(97503),c=i(46852),d=i(46027),h=i(84593),p=i(49379),m=i(79015),f=i(59873),g=i(7162),y=i(18),v=i(55568),w=i(71395),b=i(43414),S=i(53719),M=i(11944),P=i(92585),E=i(88491),T=i(11448),x=i(66776),D=i(23175),C=i(39784);function k(e){const t=function(e){return x.map(e,(e=>e.join("opened-by")))}(e);return null==t?void 0:t.clear().children((e=>".json"===e.ext))}t.maybeRemovePriorLocks=T.lazy((async()=>{if(b.Settings.forceOpen.valueOrDefault){const e=w.libraryDataDir();null!=e&&await P.thenOrTimeout((async()=>Promise.all(C.toA(await k(e)).map((e=>e.unlink())))),7*E.secondMs)}})),t.StaleMs=E.hourMs,t.openedByFiles=k,t.isLockOwner=async function(){return x.mapOr(w.libraryDataDir(),(async e=>h.eqlAsyncPicked(t.currentLibraryLockOwner(e),t.expectedJson(),"hostname","pid")),(async()=>!1))},t.expectedJson=T.lazy((async()=>({hostname:r.hostname(),pid:s.pid}))),t.currentLibraryLockOwner=u.memoizeAsync((e=>async function(e){await t.maybeRemovePriorLocks();const i=!v.isSyncFileService(),n=g.mkLogger("currentLibraryLockOwner("+e+")"),s=r.hostname(),o=await k(e);if(M.isEmpty(o))return void n.warn("no opened-by files found.");const l=await c.thenCompact(o.map((async e=>{const t=await e.readJson();return i&&null==t&&!0!==await e.modifiedCloseTo(Date.now(),S.CmdTimeoutMs)?(n.warn("unlinking old empty json file: "+e),void await e.unlink("debug")):{file:e,...t}})));n.debug("read",{jsons:l});const u=Date.now()-t.StaleMs,[d,h]=a.partition(l,(e=>e.updatedAt>u));i&&M.isNotEmpty(h)&&(n.debug("Unlinking expired opened-by files:",{minUpdatedAt:u,staleJsons:h}),await Promise.all(h.map((e=>{var t;return null===(t=e.file)||void 0===t?void 0:t.unlink("debug")}))));const[p,m]=a.partition(d,(e=>e.hostname===s)),f=p.map((e=>e.pid)),w=x.orElse(await y.existingPids(f),f),[b,P]=a.partition(p,(e=>w.includes(e.pid)));i&&M.isNotEmpty(P)&&(n.debug("Unlinking zombie opened-by files:",P),await Promise.all(P.map((e=>{var t;return null===(t=e.file)||void 0===t?void 0:t.unlink()}))));const E=[...b,...m];if(M.isEmpty(E))return void n.debug("No valid opened-by files.");const T=a.leastBy(E,(e=>e.createdAt)),D=E.filter((e=>e.systemUID===T.systemUID)),C=a.leastBy(D,(e=>[v.serviceNameIndex(e.serviceName),x.orElse(e.createdAt,(()=>Date.now()))]));return n.tap({msg:"currentLibraryLockOwner",level:"info",result:C})}(e)),{maxSize:3,timeoutMs:S.CmdTimeoutMs,clearEveryMs:D.randomInt(7*E.secondMs,S.CmdTimeoutMs)}),m.onClearCache((()=>t.currentLibraryLockOwner.clear()));class I extends l.EndableWrapper{constructor(e){super("OpenedByIO()",(()=>this.onEnd()),o.EndableRanks.postdb),this.ldd=e,this.createdAt=Date.now(),this.watchers=[],this.intervalMs=t.StaleMs/4,this.file=T.lazy((()=>this.dir.join(f.shortFsStringSha(r.hostname(),7)+"-"+s.pid+".json"))),this.json=T.lazy((async()=>({serviceName:v.serviceName(),createdAt:this.createdAt,updatedAt:Date.now(),...await t.expectedJson()})),this.intervalMs/2),this.write_=T.lazy((async()=>{const e=await this.json();await this.file().writeJSON_(e),t.currentLibraryLockOwner.clear()}),this.intervalMs/2),this.setup=T.lazy((async()=>{if(await this.write_(),v.isMainService())for(const e of this.file().selfAndParents(4))try{const t=n.watch(e.nativePath,{persistent:!1,recursive:!1},(()=>this.lockOwner.refresh())).on("error",(e=>(this.logger.warn("watch().on(error):",e),this.lockOwner.refresh())));this.watchers.push(t)}catch(t){this.logger.warn("Failed to set up watch",{f:e.nativePath,err:t})}})),this.lockOwner=T.lazy((async()=>{if(!o.ending())return await this.setup(),t.currentLibraryLockOwner(this.ldd)}),7*E.secondMs),this.dir=e.join("opened-by"),this.timer=d.setUnrefInterval((()=>this.write_()),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write_.unset()}refresh_(){return this.clear(),this.write_()}async onEnd(){this.watchers.forEach((e=>e.close())),this.watchers.length=0,x.map(this.timer,clearInterval),this.timer=void 0,await this.file().unlink()}async deleteAllLocks(e=!1){e?await this.dir.rmrf():await this.dir.visitDescendants((e=>e.eql(this.file())?void 0:e.unlink()))}async isLockOwner(){return h.eqlAsyncPicked(this.lockOwner(),t.expectedJson(),"hostname","pid")}async throwIfUnavailable(e){this.logger.debug("throwIfAvailable()",{from:e});const t=await this.lockOwner();if(this.logger.debug("throwIfAvailable()",{from:e,lockOwner:t}),null==t)return;const i=await this.json();if(this.logger.debug("throwIfAvailable()",{from:e,json:i}),null!=t&&t.hostname!==i.hostname)throw this.logger.warn("library is unavailable",{lockOwner:t,json:i}),new Error(`Library is already opened by ${t.hostname} (${t.serviceName}:${t.pid}) ${e}`+(v.isWebService()?"":p.FatalErrorFlag)+p.DoNotSendErrorFlag+p.NonRetriableErrorFlag)}}t.OpenedByIO=I},91476:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.healthChecksArePaused=t.resumeHealthChecks=t.pauseHealthChecks=void 0;const n=i(88491);let r=0;t.pauseHealthChecks=function(e=2*n.minuteMs){r=Date.now()+e},t.resumeHealthChecks=function(){r=0},t.healthChecksArePaused=function(){return Date.now()<=r}},16285:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sendRecentLogs=t.pleaseSendMessage=void 0;const r=n(i(15409)),s=i(49379),a=i(27601),o=i(27242),l=i(27579);function u(){return"User requested recent logs at "+(new Date).toISOString()+s.PleaseSendErrorFlag}t.pleaseSendMessage=u,t.sendRecentLogs=async function(){const e=u(),t=await l.annotateEvent({message:e,breadcrumbs:await l.mkBreadcrumbs()});return o.sentryEnabled()?r.default.captureEvent(t):await a.EventStore.instance().writeEvent(t),t}},27242:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sentryEnabled=void 0;const n=i(7799),r=i(19658),s=i(99312),a=i(43414),o=i(11448);t.sentryEnabled=o.lazy((()=>n.isEnvTrue("ENABLE_SENTRY")||r.isProd&&s.isPacked&&a.Settings.reportErrors.valueOrDefault)),a.Settings.reportErrors.addListener((()=>t.sentryEnabled.clear()))},27579:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.logLevelToSeverity=t.logEntryToBreadcrumb=t.mkBreadcrumbs=t.annotateEvent=t.sentryExceptionToS=t.sentryExceptionsToS=t.extractMessage=t.EventFilter=t.eventFilter=t.sendToSentry=t.installSentry=void 0;const r=n(i(15409)),s=i(16098),a=i(12087),o=n(i(61765)),l=i(36079),u=i(95557),c=i(10408),d=i(49379),h=i(79015),p=i(27601),m=i(12737),f=i(2724),g=i(92507),y=i(7157),v=i(85352),w=i(7162),b=i(68114),S=i(19658),M=i(9211),P=i(99312),E=i(53370),T=i(55568),x=i(43414),D=i(91464),C=i(42041),k=i(11944),I=i(39938),F=i(88491),O=i(43947),A=i(16475),_=i(87748),L=i(11448),R=i(66776),N=i(39784),B=i(82798),j=i(17078),z=i(27242),V=w.mkLogger("Sentry");function W(e,t){z.sentryEnabled()&&(null==t||d.isDoNotSendError(t)?d.isDoNotSendError(e)||r.default.captureMessage(e):r.default.captureException(c.addMessage(t,e)))}t.installSentry=async function(e){try{return!!z.sentryEnabled()&&(r.default.init({dsn:P.isElectron?"https://0652cdd351054fe9853ff944b1f54e2c@sentry.io/289071":"https://408e2f8d62c3494d8ed663d9e488d67a@sentry.io/1828379",shutdownTimeout:T.serviceShutdownTimeoutMs(e.name),release:C.release,environment:S.nodeEnv,maxBreadcrumbs:100,integrations:()=>[],beforeSend:t.eventFilter().beforeSend,onFatalError:e=>c.onError("sentry.onFatalError",e)}),!0)}catch(e){return V.warn("Failed to set up sentry: "+e),!1}},t.sendToSentry=W,t.eventFilter=L.lazy((()=>new q));class q{constructor(){this.eventStore=p.EventStore.instance(),this.beforeSend=async(e,t)=>{if(!z.sentryEnabled())return V.warn("Sentry.beforeSend(): not sending event",e),null;if(await this.eventStore.eventQuotaExceeded(e))return V.warn("Sentry.beforeSend(): event quota exceeded",e),null;const i=U(e,t);if(d.isDoNotSendError(i))return V.info("Sentry.beforeSend(): event not sendable. vetoing",{event:e,hint:t,msg:i}),null;I.blank(e.message)&&(e.message=D.ellipsize(i,256));const n=await J(e);return this.eventStore.maybeSendEvent(n)},h.onNonFatal(W),h.onFatal(W),new u.EndableWrapper("EventFilter",(()=>this.end()),l.EndableRanks.first)}end(){return R.map(r.default.getCurrentHub().getClient(),(e=>e.close(5*F.secondMs)))}}function U(e,t){var i;return k.uniq(k.compactBlankish([e.message,...N.toA(H(null===(i=e.exception)||void 0===i?void 0:i.values)),A.errorToS(null==t?void 0:t.originalException)])).join(": ")}function H(e){return k.mapNotEmpty(e,(e=>k.compactBlanks(e.map(G))))}function G(e){return k.mapNotEmpty(k.compactBlanks([null==e?void 0:e.type,null==e?void 0:e.value].filter((e=>"error"!==B.toS(e).toLowerCase()))),(e=>e.join(": ")))}async function J(e){const t=x.Settings.email.value;I.notBlank(t)&&(null==e.user&&(e.user={}),e.user.email=t),k.isEmpty(e.breadcrumbs)&&(e.breadcrumbs=await $());const i=R.orElse(e.extra,{});return i.pid=o.default.pid,i.serviceName=T.serviceName(),i.serviceEnding=l.ending(),i.runtimeMs=Date.now()-S.start,i.version=C.version,i.os=M.OS(),i.isDocker=P.isDocker(),i.nodeVersion=o.default.versions.node,i.locale=await g.locale(),i.cpus=M.CPUs(),i.memoryUsageMb=b.memoryUsageMb(),i.memoryUsageRssMb=b.memoryUsageRssMb(),i.systemMemory=j.fmtBytes(a.freemem())+" / "+j.fmtBytes(a.totalmem()),i.ffmpeg=await m.ffmpegVersionDescription(),i.vlc=await f.vlcVersionDescription(),i.argv=_.stringify(o.default.argv),e.extra=i,{timestamp:Date.now()/F.secondMs,...e}}async function $(){await E.broadcast("writeRecentLogEntries"),await O.delay(3*v.DefaultLogFlushMs);const e=await y.allRecentLogEntries();return k.compact(e.map(K))}function K(e){return R.map(Q(e.l),(t=>({timestamp:e.ts/F.secondMs,level:t,category:R.orElse(e.from,T.processName()),message:D.stripAnsiEsc(e.ctx+": "+e.msg),data:"object"==typeof e.meta?e.meta:{value:D.isString(e.meta)?D.stripAnsiEsc(e.meta):e.meta}})))}function Q(e){switch(e){case"error":return s.Severity.Error;case"warn":return s.Severity.Warning;case"info":return s.Severity.Info;case"debug":return s.Severity.Debug;default:return}}t.EventFilter=q,t.extractMessage=U,t.sentryExceptionsToS=H,t.sentryExceptionToS=G,t.annotateEvent=J,t.mkBreadcrumbs=$,t.logEntryToBreadcrumb=K,t.logLevelToSeverity=Q},20990:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Service=t.setupEventHandlers=void 0;const r=n(i(61765)),s=i(9678),a=i(36079),o=i(70259),l=i(13317),u=i(21142),c=i(10347),d=i(95237),h=i(85297),p=i(80294),m=i(7799),f=i(10408),g=i(49379),y=i(79141),v=i(79015),w=i(94329),b=i(76531),S=i(55248),M=i(7162),P=i(19658),E=i(2023),T=i(99312),x=i(55568),D=i(43414),C=i(82041),k=i(42041),I=i(94569),F=i(29916),O=i(39938),A=i(38625),_=i(88491),L=i(43947),R=i(16475),N=i(6314),B=i(11448),j=i(66776),z=i(82798),V=i(30394),W=i(49374),q=i(9069),U=i(93850),H=i(16285),G=i(27579),J=i(87186);t.setupEventHandlers=B.lazy((()=>{v.onWriteRecentLogEntries((()=>M.writeRecentLogEntries())),v.onResume((()=>F.resume())),v.onPause((()=>F.pause()))})),t.Service=class{constructor(e){this.opts=e,this._exitted=!1,this._ready=new N.Latch,this.jobs=new o.Promises,this.onFatalHandlers=[],this.inputHandlers=new Map,this.setup=B.lazy((async()=>{this.logger.info("setup()");const e=()=>!this._exitted&&!a.ending();try{O.mapNotBlank(m.getEnv("PS_FATAL_"+this.name),(e=>{throw new y.WrappedError({fatal:!0,message:e})})),O.mapNotBlank(m.getEnv("PS_CRASH_"+this.name),(e=>{L.later((()=>{throw new y.WrappedError({message:e})}),5*_.secondMs)}));{const e=s.AppName()+(this.name===x.ServiceNames.main?"":` ${this.name}`),t=r.default;try{t.title=e}catch{}}if(await C.readSystemSettings(),C.libraryHasSettings()&&await C.readLibrarySettings(),await this.setupErrorHandling(),this.logStartup(),x.isMainService()&&(await this.maybeUpgradeSystemSettings(),await this.maybeUpgradeLibrarySettings()),t.setupEventHandlers(),I.setDoNotRunImpl(V.doNotRun),await this.stdinReadline(),e()){const e=W.Library.instance();if(null==e&&!x.isWelcomeService())throw new Error("Cannot start, library path is unset"+g.FatalErrorFlag);null!=e&&await e.ready}U.rpcClientReady();const i=!e();this.logger.debug("setup done.",{reject:i}),i?this._ready.reject():this._ready.resolve()}catch(e){console.error(R.errorToVerbose(e)),this._ready.reject(e),this.exit({reason:g.addErrorFlags(this.name+" setup failed: "+R.errorToS(e),g.FatalErrorFlag),status:14,waitForJobs:!1})}})),this.stdinReadline=B.lazy((()=>{const e=r.default.stdin.pipe(new w.LineReader);return e.on("data",(e=>this.onLine(z.toS(e)))),e})),x.setServiceName(this.name=this.opts.name),M.setupLogger(),D.Settings.logDir.addListener((()=>M.setupLogger())),D.Settings.tailLogs.valueOrDefault&&S.LogTail.instance(),this.logger=M.mkLogger("Service("+this.name+")"),this.addDefaultInputHandlers(),this.jobs.push("Service.setupOrTimeout",(()=>this.setupOrTimeout()))}async setupOrTimeout(){var e;{const e=await l.thenOrTimeout(this.setup().then((()=>!0)),D.Settings.setupTimeoutMs.valueOrDefault);if(A.isTrue(e))return}const t=b.maybeSizeSync(null===(e=q.libraryModelDbFile())||void 0===e?void 0:e.nativePath);if(null!=t){const e=t/10,i=e-(Date.now()-P.start);i>0&&this.logger.warn("Startup is taking a while, but the database looks like it's large, so we're going to wait for another "+p.fmtMs(i),{dbFileSize:t,timeoutMs:e,setupTimeoutMs:D.Settings.setupTimeoutMs.valueOrDefault});const n=await l.thenOrTimeout(this.setup().then((()=>!0)),i);if(A.isTrue(n))return}return this.exit({reason:"Setup timed out after "+p.fmtMs(Date.now()-P.start)+".\nPlease visit https://photostructure.com/troubleshooting for help.",status:13,waitForJobs:!1})}get ready(){return this._ready.promise}get isReady(){return this._ready.resolved}get exitted(){return this._exitted}onFatal(e){this.onFatalHandlers.push(e)}logStartup(){this.logger.info("setup()",{version:k.version,start:P.start,argv:r.default.argv,arch:r.default.arch,platform:r.default.platform,isDocker:T.isDocker(),isPacked:T.isPacked,isElectron:T.isElectron,versions:r.default.versions,settings:{logLevel:D.Settings.logLevel.valueOrDefault,httpPort:D.Settings.httpPort.valueOrDefault,rpcPort:D.Settings.rpcPort.valueOrDefault,libraryPath:D.Settings.libraryPath.valueOrDefault},...c.psenv()})}async maybeUpgradeSystemSettings(){k.version!==await C.systemSettingsVersion()&&await C.writeSystemSettings()}async maybeUpgradeLibrarySettings(){C.libraryHasSettings()&&k.version!==await C.librarySettingsVersion()&&await C.writeLibrarySettings()}async setupErrorHandling(){if(v.eventEmitter.on("fatal",(({message:e,error:t})=>this.exit({reason:e+j.map(t,(e=>": "+R.errorToS(e))),status:12,waitForJobs:!1}))),this.setInputHandler("--send-recent-logs",(()=>H.sendRecentLogs())),r.default.on("unhandledRejection",(e=>j.map(e,(e=>f.onError("unhandledRejection",e))))),r.default.on("uncaughtException",(e=>j.map(e,(e=>f.onError("uncaughtException",e))))),r.default.on("SIGINT",(()=>this.exit({reason:"SIGINT",status:0,waitForJobs:!1}))),r.default.on("SIGTERM",(()=>this.exit({reason:"SIGTERM",status:0,waitForJobs:!1}))),r.default.on("SIGCHLD",((...e)=>this.logger.debug("Received SIGCHLD",e))),r.default.on("disconnect",(()=>this.exit({reason:"disconnect",status:0,waitForJobs:!1}))),h.isDaemon()||x.isMainService()&&T.isDocker())this.logger.info("setupErrorHandling(): not adding stdin/stdout/stderr close handlers: we're daemonized or in docker.");else if(!T.isElectron){const e=!0;r.default.stdin.on("close",(()=>this.exit({reason:"stdin.close",status:0,waitForJobs:e}))),r.default.stdin.on("error",(e=>this.logger.warn("stdin.error: "+e))),r.default.stdin.on("disconnect",(()=>this.exit({reason:"stdin.disconnect",status:0,waitForJobs:e}))),r.default.stdout.on("disconnect",(()=>this.exit({reason:"stdout.disconnect",status:0,waitForJobs:e}))),r.default.stdout.on("error",(e=>this.logger.warn("stdout.error: "+e))),r.default.stderr.on("disconnect",(()=>this.exit({reason:"stderr.disconnect",status:0,waitForJobs:e}))),r.default.stderr.on("error",(e=>this.logger.warn("stderr.error: "+e)))}await G.installSentry(this)}async exit({reason:e,status:t,waitForJobs:i}){if(this._exitted=!0,this.logger.log(0===t?"info":"warn","exit()",{status:t,reason:e,waitForJobs:i,ending:a.ending()}),i&&(await L.delay(250),await u.untilTrue((()=>(this.logger.info("exit(): waiting for enqueued jobs to complete...",{pendingNames:this.jobs.pendingNames()}),this.jobs.settled)),{timeoutMs:void 0,timeBetweenMs:_.secondMs}),this.logger.info("exit(): enqueued jobs finished.")),0!==t){await Promise.all(this.onFatalHandlers.map((t=>t(e))));const i={fatal:!0,exit:!0,status:t,pid:r.default.pid,ppid:r.default.ppid};i.error=e,E.Try((()=>J.stdoutWrite(i,!1)))}return await a.endEndables(),r.default.exit(t)}setInputHandler(e,t){this.inputHandlers.set(e.trim().toLowerCase(),t)}addDefaultInputHandlers(){this.setInputHandler("--version",(async()=>{J.stdoutWrite({version:k.version})})),this.setInputHandler("--status",(async()=>{const e=await V.healthChecks();return this.logger.debug("--status",e),J.stdoutWrite({healthChecks:e})})),this.setInputHandler("--quit",(()=>L.later((()=>this.exit({reason:"--quit from stdin",status:0,waitForJobs:!0}))))),this.setInputHandler(d.ChildServiceExitCommand,(()=>L.later((()=>this.exit({reason:d.ChildServiceExitCommand+" from stdin",status:0,waitForJobs:!0}))))),this.setInputHandler("--pause",(()=>(F.pause(),J.stdoutWrite({paused:F.isPaused()},!1)))),this.setInputHandler("--resume",(()=>(F.resume(),J.stdoutWrite({paused:F.isPaused()},!1))))}onLine(e){return this.logger.debug("onLine()",{line:e,ending:this._exitted||a.ending()}),this.jobs.serial("Service.onLine("+e+")",(async()=>{if(await this.setup(),e.trim().startsWith("--")){const t=e.split(" ",1)[0],i=this.inputHandlers.get(t);null==i?(this.logger.error("onLine(): unknown command",{line:e}),console.warn("unknown command "+e)):await i(e.substr(t.length).trim())}else try{await j.map(this.opts.stdinReceiver,(t=>t(e)))}catch(t){this.logger.error("onLine(): failed to process",{line:e,error:t})}}))}}},47707:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clearCacheDirs=t.vacuumCacheDirs=t.clearCacheDir=t.statsDbDir=t.CacheDirPrefix=t.cacheDirs=void 0;const n=i(64298),r=i(46852),s=i(28801),a=i(59873),o=i(7162),l=i(6231),u=i(93813),c=i(43414),d=i(87748),h=i(11448),p=i(66776),m=h.lazy((()=>o.mkLogger("StatsDbDir")));async function f(){return r.thenMapOr(s.cacheDir().clear().children(),(e=>e.filter((e=>e.name.startsWith(t.CacheDirPrefix)))),(()=>[]))}async function g(e=!0){const i=[];i.push(["Asset version",u.AssetVersion]),i.push(["Asset file version",u.AssetFileVersion]),i.push(["Library path",c.Settings.libraryPath.value]);const r=a.shortStringSha(d.stringify(i),10,l.TokenRadix),o=s.cacheDir().join(t.CacheDirPrefix+r);return e?(await n.mkdirp(o.nativePath),await o.join("README.txt").applyIfEmpty_((e=>e.writeTxt_(`This folder holds state for library synchronization of\n\n${c.Settings.libraryPath.value}\n\nIf you delete or modify the contents of this directory, you will need to\nrestart PhotoStructure. The next sync will rescan all your drives.\n\nIf you have any questions, please visit <https://photostructure.com/support/>.\n\n`+i.map((([e,t])=>`${e}: ${t}`)).join("\n")).catch((e=>{m().warn("Failed to write README to "+o,e)})))),m().info("Set up statsDbDir dir "+o),o):o}async function y(e){const i=p.orElse(e,await g());if(!i.name.startsWith(t.CacheDirPrefix))throw new Error("Refusing to remove directory "+i);await i.rmrf()}t.cacheDirs=f,t.CacheDirPrefix="sync-state-",t.statsDbDir=g,t.clearCacheDir=y,t.vacuumCacheDirs=async function(){const e=await g();for(const t of await f())t.eql(e)||await y(t)},t.clearCacheDirs=async function(){for(const e of await f())await y(e)}},87186:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StdoutWrite=t.isMigrationEvent=t.stdoutWriteMigration=t.stdoutWriteUpdateResult=t.stdoutWriteSettings=t.ReadyStr=t.stdoutWrite=void 0;const n=i(61765),r=i(7162),s=i(55568),a=i(43414),o=i(97198),l=i(39938),u=i(87748);function c(e,i=s.isSyncFileService()){o.stdoutEnded()||(r.mkLogger("stdoutWrite").debug("()",{obj:e,ready:i}),n.stdout.write(u.stringify(e)+"\n"),i&&n.stdout.write(t.ReadyStr+"\n"))}t.stdoutWrite=c,t.ReadyStr=u.stringify({ready:!0}),t.stdoutWriteSettings=function(...e){const t={};for(const i of e)i.addToEnv(t);c(t)},t.stdoutWriteUpdateResult=function(e){return c(e)},t.stdoutWriteMigration=function(e){return c({migration:e.name})},t.isMigrationEvent=function(e){return null!=e&&l.notBlank(e.migration)},t.StdoutWrite={pauseHealthChecks:()=>c({pauseHealthChecks:!0}),resumeHealthChecks:()=>c({pauseHealthChecks:!1}),shutdownSync:()=>c({shutdownSync:!0}),restartSync:()=>c(a.Settings.libraryPath.addToEnv({restartSync:!0,pause:!1})),forceRestartSync:()=>c({forceRestartSync:!0,pause:!1}),rebuildLibrary:()=>c({rebuildLibrary:!0,pause:!1}),pause:()=>c({pause:!0}),resume:()=>c({pause:!1}),shutdown:()=>c({shutdown:!0}),sendRecentLogs:()=>c({sendRecentLogs:!0})}},52021:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommonArgs=void 0;const n=i(85297),r=i(99641),s=i(43414),a=i(38625);t.CommonArgs={beforeParse:e=>(e.option("--info",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--verbose",'Verbose logging from all processes. Shortcut for "--info --tail". Caution: noisy during imports!').option("--tail","Emit log messages from both this process and all other concurrently running PhotoStructure processes on this host to stdout. This can be really helpful in seeing how PhotoStructure's processes are coordinating work. Caution: very noisy especially during imports. Sets PS_TAIL_LOGS to true. Ignored if daemonized."),r.LogArgs.beforeParse(e,!0),e.option("--force-open","DANGEROUS: removes all previously-existing library locks. This should only be necessary if the prior PhotoStructure process was not shut down gracefully."),e),afterParse:e=>{if(r.LogArgs.afterParse(e),a.isTrue(e.elapsed)&&(s.Settings.logElapsedMs.tmpValue=e.elapsed),n.isDaemon(e))s.Settings.logStdout.tmpValue=!1,s.Settings.tailLogs.tmpValue=!1;else{const t=a.isTrue(e.verbose);t&&s.Settings.logLevel.isUnset()&&(s.Settings.logLevel.tmpValue="info"),(a.isTrue(e.tail)||t)&&(s.Settings.tailLogs.tmpValue=!0),a.isTrue(e.forceOpen)&&(s.Settings.forceOpen.tmpValue=!0)}}}},44:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DaemonArgs=void 0;const r=i(63129),s=n(i(61765)),a=i(46852),o=i(10347),l=i(98462),u=i(92661),c=i(43414),d=i(82041),h=i(39938),p=i(38625),m=i(75556);t.DaemonArgs={beforeParse:e=>e.option("-p, --pidfile PIDFILE",'Write a pidfile of the main process. PIDFILE must be an absolute path (like "/var/pids/photostructure.pid").').option("--stop","Shutdown daemonized PhotoStructure. Requires --pidfile").option("-d, --daemon","Run PhotoStructure as a daemon. Enabled by default when --pidfile is provided."),afterParse:async e=>{if(h.mapNotBlank(e.pidfile,(e=>c.Settings.pidfile.tmpValue=e)),p.isTrue(e.stop)){if(!c.Settings.pidfile.hasValue()&&(await d.readSystemSettings(),!c.Settings.pidfile.hasValue()))return console.error("--stop requires --pidfile to be set."),s.default.exit(1);const e=l.BaseFile.for(c.Settings.pidfile.value);if(await e.notExists())return console.error("Pidfile "+e+" does not exist."),s.default.exit(1);const t=m.toInt(await a.thenMap(e.readFile(),(e=>e.toString())));return m.gt0(t)?await u.pidNotExists(t)?(console.error("Pid "+t+" does not exist."),s.default.exit(1)):(await u.killPid(t),s.default.exit(0)):(console.error("Pidfile "+e+" is invalid."),s.default.exit(1))}if(!p.isTrue(s.default.env.__is_daemon)&&(p.isTrue(e.daemon)||c.Settings.pidfile.hasValue())){const e=s.default.argv.findIndex((e=>!e.includes("npx")&&!e.includes("node"))),t=s.default.argv.slice(-1===e?0:e),i=process.execPath,n={...o.childEnv(void 0,!1),__is_daemon:"1"},a=r.spawn(i,t,{env:n,detached:!0,shell:!0,stdio:["ignore","ignore","ignore"]});return a.unref(),console.log("Daemonized PhotoStructure.",{pid:a.pid,args:t}),s.default.exit(0)}}}},51731:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExposeArg=void 0;const n=i(43414),r=i(38625);t.ExposeArg={beforeParse:e=>e.option("--expose","Set PS_EXPOSE_NETWORK_WITHOUT_AUTH to true. Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network."),afterParse:e=>{r.isTrue(e.expose)&&(n.Settings.exposeNetworkWithoutAuth.tmpValue=!0)}}},38381:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PauseSyncArg=void 0;const n=i(43414),r=i(38625);t.PauseSyncArg={beforeParse:e=>e.option("--pause-sync,--pauseSync","Pause sync processing until manually resumed via the system tray or nav menu."),afterParse:e=>{r.isTrue(e.pauseSync)&&(n.Settings.startPaused.tmpValue=!0)}}},18290:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dateTagFile=t.dateTag=t.dayTagRef=t.monthTagRef=t.yearTagRef=t.dayToOrdinal=t.ordinalToMonth=t.monthToOrdinal=t.yearToOrdinal=void 0;const n=i(45161),r=i(79015),s=i(92507),a=i(70283),o=i(43414),l=i(91464),u=i(65642),c=i(44546),d=i(11254),h=i(11944),p=i(11448),m=i(66776),f=i(26588),g=i(82798),y=p.lazy((async()=>new Intl.DateTimeFormat(await s.locale(),{month:"short"}))),v=p.lazy((async()=>{const e=await y();return h.range(0,12,(t=>e.format(new Date(2016,t,1)))).map((e=>l.stripSuffix(e,".")))}));function w(e){return 1e4-e}function b(e){return 13-e}function S(e){return 33-e}function M(e){return a.mapGt0(e,(e=>({name:g.toS(e),ordinal:w(e)})))}async function P(e){if(a.within(1,12,e))return m.map((await v())[e-1],(t=>({name:String(e),displayName:t,ordinal:b(e)})))}function E(e){return a.mapGt0(e,(e=>({name:g.toS(e),ordinal:S(e)})))}async function T(e){const t=g.toS(o.Settings.tagYMD.valueOrDefault).toLowerCase();if(null==e||""===t||"off"===t||t.startsWith("disable"))return;const i=[d.TagRoots.When];if(t.startsWith("y")){const t=m.map(n.getYear(e),M);if(null==t)return;i.push(t)}if(t.startsWith("ym")){const t=await m.map(n.getMonth(e),P);if(null==t)return i;i.push(t)}if(t.startsWith("ymd")){const t=m.map(n.getDay(e),E);if(null==t)return i;i.push(t)}return i}r.onClearCache((()=>{y.unset(),v.unset()})),t.yearToOrdinal=w,t.monthToOrdinal=b,t.ordinalToMonth=function(e){return 13-e},t.dayToOrdinal=S,t.yearTagRef=M,t.monthTagRef=P,t.dayTagRef=E,t.dateTag=T,t.dateTagFile=async function(e,t){if(""===o.Settings.tagYMD.valueOrDefault)return;const i=[...t];h.isEmpty(t)&&await f.thenMap(c.readTags(e),(e=>i.push(e.capturedAt)));const n=u.bestCapturedAt(i);return null==n||n.src.startsWith("stat")&&!o.Settings.tagDateFromStat.valueOrDefault?void 0:T(n.date)}},96672:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addFileUriTagsToAsset=t.addFilesTagsToAsset=t.uriToTagPath=t.tagAssetPaths=void 0;const n=i(7162),r=i(19209),s=i(11254),a=i(11944),o=i(11448),l=i(49049),u=i(30690),c=i(89452),d=i(52465),h=o.lazy((()=>n.mkLogger("FilePathTagger")));function p(e){const t=r.toURI(e),i=((t.scheme===l.PS_LIBRARY_PROTOCOL?d.Library:t.authority)+"/"+t.path).split("/");return a.compactBlanks([s.TagRoots.fs,...i.slice(0,-1)])}async function m(e,t){return u.Asset.addTags(e,t.map(p))}t.tagAssetPaths=function(e){const t=[];for(const i of e)try{t.push(p(i))}catch(e){h().warn("Failed to parse asset file URI",{uri:i})}return t},t.uriToTagPath=p,t.addFilesTagsToAsset=async function(e){return c.AssetFile.tx((async()=>{const t=await c.AssetFile.dbl.pluckAllf((t=>t.select("uri").where({assetId:e})));return m(e,t)}))},t.addFileUriTagsToAsset=m},52465:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagDeltas=t.tagPathsInclude=t.tagDiff=t.tagPathEql=t.uniqTagPaths=t.normalizeTagPath=t.splitTagPath=t.joinedTagPathBasename=t.joinTagPath=t.tagPathToStringArray=t.tagRefToS=t.Roots=t.Library=void 0;const n=i(69060),r=i(43414),s=i(11254),a=i(11944),o=i(39938),l=i(66776),u=i(39784),c=i(82798),d=i(94719),h=i(83089);function p(e){return l.map(e,(e=>l.orElse(e.name,c.toS(e))))}function m(e){return e.map(p)}function f(e,t=d.TagSep){return m(e).join(t)+(t===d.TagSep?t:"")}function g(e,t=d.TagSep){return c.toS(e).split(t).filter(o.notBlank)}function y(e){return m(e).join(d.TagSep).toLowerCase()}function v(e,t){const i=new Set(a.compact(t).map((e=>y(e))));return a.compact(e).filter((e=>!i.has(y(e))))}function w(e,t){const i=y(e);return t.some((e=>i===y(e)))}t.Library="Library",t.Roots=[{name:s.TagRoots.When,ordinal:1},{name:s.TagRoots.Albums,ordinal:2},{name:s.TagRoots.fs,ordinal:3},{name:s.TagRoots.Who,ordinal:4},{name:s.TagRoots.Camera,ordinal:5},{name:s.TagRoots.Lens,ordinal:6},{name:s.TagRoots.Keywords,ordinal:7},{name:s.TagRoots.Type,ordinal:8}],t.tagRefToS=p,t.tagPathToStringArray=m,t.joinTagPath=f,t.joinedTagPathBasename=function(e){return a.last(g(e))},t.splitTagPath=g,t.normalizeTagPath=function(e){return f(g(e))},t.uniqTagPaths=function(e){return a.uniqBy(u.toA(e),(e=>a.isEmpty(e)?void 0:f(e)))},t.tagPathEql=function(e,t){return null!=e&&null!=t&&y(e)===y(t)},t.tagDiff=v,t.tagPathsInclude=w,t.tagDeltas=async function(e,t){const i=v(t,e),s=v(e,t),o=r.Settings.excludedRootTags.valueOrDefault;return a.filterInPlace(i,(e=>{const t=o.includes(p(e[0]).toLowerCase());return t&&!w(e,s)&&(s.push(e),console.log("removing bad tag",e)),!t})),await n.l()&&a.filterInPlace(s,(e=>!h.isWhoTag(e))),{add:i,remove:s}}},83089:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nameTag=t.isWhoRoot=t.isWhoTag=t.whoTagFiles=void 0;const n=i(46852),r=i(69060),s=i(7162),a=i(2023),o=i(43414),l=i(91464),u=i(44546),c=i(71932),d=i(65308),h=i(11254),p=i(11944),m=i(39938),f=i(66776),g=i(61570),y=i(39784),v=i(52465),w=s.mkLogger("WhoTagger");function b(e){return!m.blank(e)&&l.hasAnyIgnoreCase([h.TagRoots.Who,...o.Settings.tagWhoSynonyms.values],e)}function S(e){if(!m.blank(e))return Array.isArray(e)?(b(e[0])&&e.shift(),0===e.length?void 0:1===e.length?d.renderNameTag(e[0]):[[h.TagRoots.Who,...e]]):d.renderNameTag(e)}t.whoTagFiles=async function(e){if(await r.l())return;const t=[];if(o.Settings.tagJsonFaces.valueOrDefault){const i=p.flatten(await n.mapAsync(e,(e=>e.jsonSidecars())));await n.mapAsync(i,(async e=>{const i=await c.readJsonSidecar(e);f.map(null==i?void 0:i.peopleNames,(e=>t.push(...e)))}))}o.Settings.tagFaceRegions.valueOrDefault&&await n.mapAsync(e,(async e=>{const i=await u.readRawTags(e,!0);if(null!=i)for(const e of g.values(i)){const i=null==e?void 0:e.RegionList;if(Array.isArray(i))for(const e of i)"Face"===e.Type&&t.push(e.Name)}})),p.isNotEmpty(o.Settings.tagWhoNames.values)&&await n.mapAsync(e,(async e=>{const i=await u.readRawTags(e,!0);for(const e of o.Settings.tagWhoNames.values)t.push(...y.toA(a.valpath(i,e)))}));const i=p.uniq(p.flatten(p.uniq(t).map(S)));return w.tap({msg:"whoTagFiles()",level:"info",result:i,meta:{names:t,files:e.map((e=>e.nativePath))}})},t.isWhoTag=function(e){return b(v.tagRefToS(e[0]))},t.isWhoRoot=b,t.nameTag=S},18130:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Db=void 0;const n=i(36079),r=i(95557),s=i(49379),a=i(79141),o=i(98462),l=i(27175),u=i(71395),c=i(43414),d=i(88491),h=i(11448),p=i(66776),m=i(11303),f=i(56550),g=i(6628),y=i(48915),v=i(72537),w=i(57527);class b extends r.EndableWrapper{constructor(e,t,i=(()=>{})){super("Db("+e+")",(()=>this.closeDb()),n.EndableRanks.db),this.schema=e,this._dataDir=t,this._onMigration=i,this.endTimeoutMs=d.minuteMs,this.migrate=h.lazy((async()=>{const e=this.dbfile;if(null==this.db||null==e)throw new Error("Cannot migrate database: missing db");await this.maybeRepair();const t=h.lazy((async()=>(this._onMigration(),v.makeVersionBackup_(e)))),i=new g.Migration(o.BaseFile.for(l.ProjectPath.Migrations()).join(this.schema),this.db,e);return{appliedMigrations:await i.apply(t),migration:i}})),this.onRetry=h.lazy((()=>this.closeDb()),c.Settings.maxBusyDbMs.valueOrDefault/4)}get datadir(){return p.orElse(this._dataDir,u.libraryDataDir())}get dbfile(){return m.pathToDb(this.datadir,this.schema)}get open(){return null!=this._db&&this._db.open}get inTransaction(){var e;return this.open&&!0===(null===(e=this._db)||void 0===e?void 0:e.inTransaction)}prepare(e){return this.db.prepare(e)}pragma(e,t){return this.db.pragma(e,t)}get db(){const e=null==this._db;if(!this.open){this.logger.info("setting up new db connection to "+this.dbfile,{priorWasNull:e});try{this.dbfile.parent().mkdirpSync_(),this._db=y.mkdb(this.dbfile.nativePath);const e=this._db.pragma("quick_check",{simple:!0});if("ok"!==e)throw new Error("Quick integrity check failed: "+e+s.FatalErrorFlag)}catch(e){throw new a.WrappedError({cause:e,fatal:!0,message:"Failed to set up "+this.dbfile})}}return this._db}closeDb(){var e,t;try{!0===(null===(e=this._db)||void 0===e?void 0:e.open)&&(this.logger.info("closing db",this._db),null===(t=this._db)||void 0===t||t.close())}catch(e){this.logger.warn("closeDb(): .close() failed",e)}this._db=void 0}async maybeRepair(){let e=!0;try{e=v.verifyDb(this.db)}catch{e=!1}e||(this.logger.warn("maybeRepair(): database failed validation. Trying to restore with dump/load."),await this.repair_())}async vacuum(){await w.withVacuumEvent((()=>this._vacuum()))}async _vacuum(){try{await f.handleDbRetries((()=>{v.optimizeDb(this.db),this.db.exec("VACUUM")}),this.onRetry)}catch(e){this.logger.warn("vacuum(): vacuum failed, trying to recover by dump-load",e),await this.repair_()}}async repair_(){this.logger.warn("repair_(): Attemping restore of "+this.dbfile),this.closeDb(),await w.withVacuumEvent((()=>v.repairDbFile_(this.dbfile))),this.logger.info("repair_(): Database restoration was successful!")}}t.Db=b},62155:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DbBackup=t.stamp=t.DefaultRetentionCount=t.DefaultBackupFrequencyMs=void 0;const n=i(36079),r=i(28807),s=i(70259),a=i(80294),o=i(92445),l=i(19658),u=i(55568),c=i(43414),d=i(97198),h=i(88491),p=i(11448),m=i(72537),f=i(68746);t.DefaultBackupFrequencyMs=1*h.hourMs,t.DefaultRetentionCount=32,t.stamp=function(e=new Date){return"."+a.filestampUTC(e)+"-"};class g extends r.EndableInterval{constructor(e,t,i,r,a,m=(()=>{}),f=(()=>{})){super({name:"DbBackup("+i+")",callback:()=>this.backup(),intervalMs:c.Settings.dbBackupIntervalMinutes.valueOrDefault*h.minuteMs,rank:n.EndableRanks.predb}),this.db=e,this.isLockOwner=t,this.srcDbFile=i,this.backupsDir=r,this.replaceDir=a,this.beforeBackup=m,this.onBackupFinished=f,this.endTimeoutMs=h.minuteMs,this.mutex=new s.Promises,this.hanoi=p.lazy((()=>o.Hanoi.for(this.backupsDir,c.Settings.dbBackupsCount.valueOrDefault))),l.isSingleSpecTests()||this.onEnds.push((async()=>{await this.mutex.serial("DbBackup.end()",(async()=>{u.isMainService()&&d.consoleLog("Verifying & backing up "+e.dbfile+"..."),await this._backup(!0),u.isMainService()&&d.consoleLog("PhotoStructure library db has been backed up to "+r+".")}))}))}backup(){return this.mutex.maybeRun("DbBackup.backup()",(()=>this._backup()))}async _backup(e=this.ended){if(await this.isLockOwner())if(e||this.db.open)if(await this.srcDbFile.clear().isEmpty())this.logger.warn("backup(): db is missing.",this.srcDbFile.nativePath);else try{this.logger.info("backup(): beforeBackup...",{srcDb:this.srcDbFile.nativePath,backupsDir:this.backupsDir.nativePath}),await this.beforeBackup(),e&&this.db.open&&(this.logger.info("backup(): closing db before backup..."),await this.db.closeDb());const t=this.srcDbFile.parent().join("backup",this.srcDbFile.base);this.logger.info("backup(): starting backup to "+t),await m.backupDbFile_(this.srcDbFile,t),this.logger.info("backup(): backup taken. Verifying "+t),await m.verifyDbFile_(t),null!=this.replaceDir&&(this.logger.info("backup(): Copying to "+this.replaceDir),await m.backupDbCold_(t,this.replaceDir));const i=await f.sqliteFiles(t),n=await this.hanoi(),r=n.next("").toFilename();this.logger.info("backup(): Rotating files to "+this.backupsDir.join(r));for(const e of i)await e.mv_(this.backupsDir.join(r+e.base),{overwrite:!0});for(const e of await n.staleFiles())this.logger.info("backup(): removing stale backup "+e),await e.unlink();this.logger.info("backup(): finished successfully"),await this.onBackupFinished()}catch(e){this.logger.throw(e,{from:"DbBackup._backup() failed",fatal:!0,srcDb:this.srcDbFile.nativePath})}else this.logger.warn("backup(): db is already closed.",this.db.name);else this.logger.info("backup(): not lock owner, no-op.")}}t.DbBackup=g},11303:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathToDb=t.SqliteExt=void 0,t.SqliteExt=".sqlite3",t.pathToDb=function(e,i){return e.join(i,"db"+t.SqliteExt)}},78650:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DbRequest=t.MaxBatchSize=void 0;const n=i(36079),r=i(7383),s=i(51498),a=i(95976),o=i(7162),l=i(19658),u=i(43414),c=i(11944),d=i(39938),h=i(11448),p=i(66776),m=i(44726),f=i(18273),g=i(66056),y=i(75179);t.MaxBatchSize=l.isTest?25:1e3;const v=h.lazy((()=>o.mkLogger("DbRequest")));t.DbRequest=class{constructor(e,t){this.db=e,this.tableName=t,this.cachedStatements=new s.FifoCache(256)}qb(){return f.knex()(this.tableName)}prep(e,t,i=!1){const n=g.toSqlQuery(t);try{const r=this.cachedStatements.getOrSet((!0===i?"pluck:":"")+n.sql,(()=>{const t=e.prepare(n.sql);return!0===i?t.pluck():t}));return r.database.open?{sq:n,stmt:r}:(this.cachedStatements.clear(),this.prep(e,t,i))}catch(e){return v().throw("prep() failed",{error:e,sqlQuery:n,retriable:!1})}}async wrap({q:e,pluck:t,m:i}){try{return await y.tx(this.db(),(n=>{const{sq:r,stmt:s}=this.prep(n,e,t);u.Settings.logSql.valueOrDefault&&v().log(a.defaultLogLevel(),i+"(): "+g.sqlQueryToS(r));const o=s[i].bind(s);return null==r.bindings?o():o(r.bindings)}))}catch(t){if(String(t.message).includes("AdvisoryLock"))throw t;v().throw(t,{method:i,...g.toSqlQuery(e)})}}run(e){return this.wrap({q:e,m:"run"})}async runScript(e,t=""){const i=r.mkElapsed("runScript()");for(const n of e){if(d.blank(n)||n.trim().startsWith("--"))continue;await this.run({sql:n});const e=m.replaceAll(m.ellipsize(n,60),t,"");i.elapsed(e)}}mapRun(e){return y.tx(this.db(),(t=>e.map((e=>{const{sq:i,stmt:n}=this.prep(t,e);return p.mapOr(i.bindings,(e=>n.run(e)),(()=>n.run()))}))))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}upsert(e){const t=g.toSqlQuery(e(this.qb()));return t.sql=t.sql.replace(/^(update|insert)\b/i,(e=>e+" or replace ")),this.wrap({q:t,m:"run"})}first(e){return this.wrap({q:e,m:"get"})}firstf(e){return this.wrap({q:e(this.qb()),m:"get"})}mapAll(e){return y.tx(this.db(),(t=>c.flatten(e.map((e=>{const{sq:i,stmt:n}=this.prep(t,e);return p.mapOr(i.bindings,(e=>n.all(e)),(()=>n.all()))})))))}all(e){return this.wrap({q:e,m:"all"})}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}async batched(e){let i;do{i=await this.wrap({q:e.qb(this.qb(),i).limit(t.MaxBatchSize),m:"all"}),c.isNotEmpty(i)&&await e.onResults(i)}while(c.isNotEmpty(i)&&!n.ending())}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}async pluckBatched(e){let i;do{i=await this.wrap({q:e.qb(this.qb(),i).limit(t.MaxBatchSize),pluck:!0,m:"all"}),c.isNotEmpty(i)&&await e.onResults(i)}while(c.isNotEmpty(i))}}},56550:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleDbRetriesSync=t.handleDbRetries=void 0;const n=i(49379),r=i(43414),s=i(43947),a=i(23175);t.handleDbRetries=async function(e,t){let i=0;const o=Date.now()+r.Settings.maxBusyDbMs.valueOrDefault;for(;Date.now()<o;)try{return await e()}catch(e){if(!n.isSqliteBusyError(e)||Date.now()>=o)throw e;null==t||t(),await s.delay(a.randomInt(500,1500)*++i)}throw new Error("handleDbRetries(): timeout after "+r.Settings.maxBusyDbMs.valueOrDefault+"ms")},t.handleDbRetriesSync=function(e,t=25){let i;for(let r=0;r<t;r++)try{return e()}catch(e){if(i=e,!n.isSqliteBusyError(e))throw e}throw i}},21208:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toDbValued=t.isDbValued=t.isDbValue=void 0;const n=i(45161),r=i(11944),s=i(61570);function a(e){return null===e||r.includes(["number","string"],typeof e)}t.isDbValue=a,t.isDbValued=function e(t){return null!=t&&Array.isArray(t)?t.every(e):s.entries(t).every((([,e])=>a(e)))},t.toDbValued=function(e){return s.mapFields(e,((e,t)=>{if(!e.startsWith("$"))return"boolean"==typeof t?[e,t?1:0]:a(t)?[e,t]:n.isDated(t)?[e,n.datedToMillis(t)]:void 0}))}},18273:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.firstMigratedAt=t.knex=void 0;const r=n(i(85717)),s=i(46852),a=i(11448),o=i(66776),l=i(61570);t.knex=a.lazy((()=>r.default({client:"sqlite3",useNullAsDefault:!0}))),t.firstMigratedAt=async function(e){return s.thenMap(e("migrations").min("migration_time").first(),(e=>o.map(l.values(e)[0],(e=>new Date(e)))))}},6628:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration=void 0;const n=i(13317),r=i(79141),s=i(79015),a=i(7162),o=i(99312),l=i(42041),u=i(11944),c=i(39938),d=i(88491),h=i(16475),p=i(87748),m=i(11448),f=i(66776),g=i(75556),y=i(34601),v=i(82798),w=i(12586);t.Migration=class{constructor(e,t,i){this.migrationsDir=e,this.db=t,this.fsMigrations=m.lazy((()=>this.migrationsDir.children((e=>".sql"===e.ext)))),this.migrationsInDatabase=m.lazy((()=>this.db.prepare("SELECT name from migrations").pluck().all())),this.assertKnownMigrations=m.lazy((()=>{if(!o.isPacked)return;const e=this.migrationsInDatabase().filter((e=>{const[t,i,n]=[e.slice(0,4),e.slice(4,6),e.slice(6,8)].map((e=>g.toInt(e))),r=new Date(t,i-1,n);return this.logger.debug("migration filter",{migrationName:e,migrationDate:r,gitDate:l.gitDate}),l.gitDate.getTime()<r.getTime()}));if(u.isNotEmpty(e))throw new r.WrappedError({fatal:!0,doNotSend:!0,message:"PhotoStructure is not forward-compatible with newer libraries. Please upgrade to open this library",cause:new Error("Unknown migrations: "+e.join(","))})})),this.logger=a.mkLogger("Migration("+p.stringify({schema:e.base,db:i.nativePath})+")"),t.exec("\nCREATE TABLE IF NOT EXISTS migrations (\n  id integer NOT NULL PRIMARY KEY, \n  name varchar(255) NOT NULL, \n  migration_time integer NOT NULL \n)\n"),this.addMigrationStmt=t.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}async apply(e){this.assertKnownMigrations();const t=await this.fsMigrations();if(null==t)throw new Error("no migration files found for "+this.migrationsDir);const i=[],s=this.migrationsInDatabase();for(const a of t)s.includes(a.name)?this.logger.debug("latest(): already applied "+a.base):(await f.map(e,(e=>e(a))),await n.thenOrTimeout(this.applyMigration(a),5*d.minuteMs,(()=>{throw new r.WrappedError({fatal:!0,ignorable:!1,message:"Migration "+a.name+" timed out."})})),i.push(a.base));return this.logger.info("up to latest!",{appliedMigrations:i}),i}async applyMigration(e){s.emitMigration(e.name);try{const t=Date.now(),i=(await e.readLines()).filter((e=>c.blank(e)||e.trim().startsWith("--"))),n=w.Migrations[e.name.replace(/^[\d_-]+/,"")],s=y.isFunction(n);if(u.isEmpty(i)&&s)throw new r.WrappedError({message:"empty migration "+e.name,fatal:!0});return s?await n.bind(w.Migrations)(this.db):await this.applySqlMigration(e),this.logger.debug("applyMigration() completed",{elapsedMs:Date.now()-t,codeMigration:s,migration:e.baseWithParent}),this.db.transaction((()=>{this.addMigrationStmt.run(e.name,Date.now())}))()}catch(t){return this.logger.throw("Failed to apply migration "+e.baseWithParent,h.errorToVerbose(t))}}async applySqlMigration(e){const t=e.name.includes("_nofk");try{const i=v.toS(await e.readFile());if(c.blank(i))return void this.logger.error("Empty migration: "+e);t&&this.db.pragma("foreign_keys = OFF");for(const e of u.compactBlanks(i.split(";")))try{this.db.exec(e)}catch(t){throw new r.WrappedError({cause:t,fatal:!0,message:`Failed to apply: ${e}`})}if(t){const t=this.db.pragma("foreign_key_check");if(u.isNotEmpty(t))throw this.logger.error("foreign_key_check failed",t),new Error("Foreign key checks failed during migration "+e.name)}}finally{t&&this.db.pragma("foreign_keys = ON")}}}},12586:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migrations=t.dedupeTags=t.tag_path_suffix=t.plucklabmodeb6=t.lowercase_psnet_function=void 0;const n=i(13779),r=i(93125),s=i(45161),a=i(52879),o=i(72461),l=i(7162),u=i(70208),c=i(70283),d=i(1058),h=i(43414),p=i(82041),m=i(91464),f=i(25116),g=i(11944),y=i(11448),v=i(66776),w=i(75556),b=i(98510),S=i(82798),M=i(49049),P=i(52465),E=i(94719),T=y.lazy((()=>l.mkLogger("Migrations"))),x=new RegExp(`^(${d.escapeRegExp(M.PS_NETWORK_FILESYSTEM_PROTOCOL)}://.*?/)(.*)$`);function D(e,t){return c.mapGt0(e,(()=>v.map(function(e,t=o.ModeBits){return u.splitBits(e,t).map((e=>a.unlabhash(e,t)))}(e,6)[t],(e=>a.labhash(e,o.ModeBits)))))}function C(e){return e.endsWith(E.TagSep)?e:e+E.TagSep}function k(e,t){function i(t){return e.prepare(t).run()}g.isEmpty(t)&&T().warn("mergeTags(): empty tagIds",{tagIds:t});const n=new Map(e.prepare("SELECT id, _path FROM Tag WHERE id IN ("+t.join(",")+")").all().map((({id:e,_path:t})=>[e,t]))),r=g.sortBy(t.map((e=>{const t=n.get(e);return{id:e,path:t,base:P.joinedTagPathBasename(t)}})),(e=>[e.base,e.path]));r.reverse(),T().info("mergeTags()",{arr:r});const s=r[0],a=s.id;if(g.isEmpty(r)||!w.gt0(a))return void T().warn("mergeTags(): empty array, or missing winner",{arr:r,winner:s,winnerId:a});const o=r.slice(1);if(g.isNotEmpty(o)){const e=o.map((e=>e.id)).join(",");i(`UPDATE OR IGNORE AssetTag SET tagId = ${a} WHERE tagId in (${e})`),i(`UPDATE OR IGNORE Tag SET parentId = ${a} WHERE parentId in (${e})`),i(`UPDATE OR IGNORE Tag SET parentId = ${a} WHERE parentId in (${e})`),i(`DELETE FROM AssetTag WHERE tagId in (${e})`),i(`DELETE FROM Tag WHERE id in (${e})`)}const l=e.prepare("select _path from Tag where id = :id").get({id:a})._path,u=P.splitTagPath(l),c=e.prepare("SELECT id, _path FROM Tag WHERE id = :winnerId OR _path LIKE :like COLLATE NOCASE").all({winnerId:a,like:m.ensureSuffix(l,E.TagSep)+"%",winnerPath:l});for(const t of c){const i=P.joinTagPath([...u,...P.splitTagPath(m.stripPrefixIgnoreCase(t._path,l))]);t._path!==i&&(T().info("mergeTags(): repairing tag path",{ea:t,newPath:i}),e.prepare("UPDATE OR IGNORE Tag SET _path = :path, updatedAt = :updatedAt WHERE id = :id").run({id:t.id,updatedAt:Date.now(),path:i}))}return T().tap({msg:"mergeTags()",level:"info",result:{winner:s,losers:o},meta:{tagIds:t,winnerPath:l}})}function I(e){const t=e.prepare(["SELECT","rtrim(_path, char(31)) as path,","count(*) AS cnt,","group_concat(id) AS ids","FROM Tag","GROUP BY path","COLLATE NOCASE","HAVING cnt > 1"].join(" ")).all();for(const e of t)e.ids=g.compact(S.toS(e.ids).split(",").map((e=>w.toInt(e))));return g.sortByInPlace(t,(e=>e.path)).reverse(),T().tap({msg:"dedupeTags()",result:t.map((t=>k(e,t.ids))),meta:{rows:t}})}t.lowercase_psnet_function=e=>b.opt(e).filter(m.isString).flatMap((e=>x.exec(e))).map((e=>e[1].toLowerCase()+e[2])).getOrElse((()=>e)),t.plucklabmodeb6=D,t.tag_path_suffix=C,t.dedupeTags=I,t.Migrations={lowercase_psnet_hostname:e=>{e.function("lowercase_psnet_hostname",{deterministic:!0},t.lowercase_psnet_function),e.transaction((()=>{e.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),e.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),e.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")}))()},force_stable_channel:async()=>{try{await p.readSystemSettings();const e=h.Settings.updateChannel.value;"stable"!==e&&(h.Settings.updateChannel.value="stable",await p.writeSystemSettings(),T().info("force_stable_channel(): reset updateChannel",{priorValue:e}))}catch(e){T().error("force_stable_channel(): failed: "+e)}},numeric_captured_at:e=>{e.function("isoToLocal",{deterministic:!0},r.isoToLocal),e.function("isoToOffsetMinutes",{deterministic:!0},s.isoToOffsetMinutes),e.function("isoToPrecisionMs",{deterministic:!0},r.isoToPrecisionMs),e.transaction((()=>{e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),e.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),e.exec("DROP INDEX asset_captured_at_geohash_idx"),e.exec("DROP INDEX assetfile_exifuid_idx"),e.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")}))()},spread_modes:e=>{e.function("plucklabmodeb6",{deterministic:!0},D),e.transaction((()=>{w.times(o.ModeCount,(t=>e.exec(`ALTER TABLE AssetFile ADD COLUMN mode${t} integer`))),e.exec("UPDATE AssetFile SET "+w.times(o.ModeCount,(e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`)).join(", "))}))()},normalize_asset_file_uris:e=>{e.function("normalizeURI",{deterministic:!0},f.normalizeURI),e.transaction((()=>{const t=e.prepare("SELECT normalizeURI(uri) AS nuri, count(*) AS cnt, GROUP_CONCAT(id) AS ids FROM AssetFile GROUP BY nuri HAVING cnt > 1").all(),i=[];for(const r of t){const t=S.toS(r.ids).split(","),s=e.prepare("SELECT id, shown, version, updatedAt FROM AssetFile WHERE id in ("+t.join(",")+")").all(),a=n.greatestBy(s,(e=>[e.shown,e.version,e.updatedAt])),o=s.filter((e=>e.id!==a.id));i.push(...o.map((e=>e.id)))}for(const t of n.batches(i,256))e.exec("DELETE FROM AssetFile WHERE id in ("+t.join(",")+")");e.exec("UPDATE AssetFile SET uri = normalizeURI(uri)")}))()},dedupe_tag_paths:e=>{e.transaction((()=>I(e)))()},suffix_tag_paths:e=>(e.function("tag_path_suffix",{deterministic:!0},C),e.transaction((()=>{I(e),e.exec("UPDATE Tag SET _path = tag_path_suffix(_path)")}))()),normalize_tag_paths:e=>{const t=e.prepare("SELECT id, _path FROM Tag WHERE _path LIKE '%' || char(31) || char(31) || '%'").all();T().info("normalize_tag_paths():",{badTags:t});for(const i of t){const t=P.normalizeTagPath(i._path);k(e,g.compact([i.id,...e.prepare("SELECT id FROM Tag WHERE _path = ?").pluck().all(t)]))}},drop_tc_tables:e=>{const t=/^(ct|taf|tag_counts)_[a-z0-9]{6}$/i,i=e.prepare("SELECT name FROM sqlite_master WHERE type='table'").pluck().all(),n=i.filter((e=>null!=t.exec(e)));T().info("drop_tc_tables()",{tables:i,victims:n});for(const t of n)e.exec("DROP TABLE "+t)}}},48915:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setPragmas=t.mkdb=void 0;const n=i(76531),r=i(7162),s=i(43414),a=i(59387),o=i(66776),l=i(75556),u=i(17078),c=i(56550),d=i(23730);function h(e){const t=['encoding = "UTF-8"',"threads = "+l.clamp(1,4,a.maxCpus()),"foreign_keys = ON","page_size = "+16*u.KiB,"trusted_schema = 0","cache_size = -"+s.Settings.dbCacheSizeMb.valueOrDefault*u.MiB/1024,"locking_mode = NORMAL","journal_mode = WAL","busy_timeout = "+s.Settings.dbTimeoutMs.valueOrDefault,"synchronous = NORMAL","auto_vacuum = NONE"];return c.handleDbRetriesSync((()=>{for(const i of t)e.pragma(i)})),e}t.mkdb=function(e,t=s.Settings.dbTimeoutMs.valueOrDefault){return o.map(n.maybeSizeSync(e),(t=>{s.Settings.dbCacheSizeMb.tmpValue=Math.max(s.Settings.dbCacheSizeMb.valueOrDefault,Math.ceil(1.1*t/u.MiB)),r.mkLogger("mkdb("+e+")").info("Dynamically setting dbCacheSize to "+s.Settings.dbCacheSizeMb.value,{dbFileSize:t})})),h(new d(e,{fileMustExist:!1,readonly:!1,timeout:t,verbose:void 0}))},t.setPragmas=h},72537:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.backupDbCold_=t.makeVersionBackup_=t.escStr=t.repairDbFile_=t.optimizeDb=t.verifyDbFile_=t.verifyDb=t.verifyDb_=t.backupDbFile_=t.sqlite=t.sqliteVersion=void 0;const n=i(69317),r=i(80294),s=i(70403),a=i(10408),o=i(49379),l=i(79141),u=i(98462),c=i(54953),d=i(22143),h=i(7162),p=i(53719),m=i(88491),f=i(24603),g=i(87748),y=i(6314),v=i(26588),w=i(39784),b=i(82798),S=i(17078),M=i(68746),P=i(70582),E=i(23730),T=h.mkLogger("SQLite");t.sqliteVersion=async function(){return v.thenMap(d.sqliteNativePath(),(async e=>{const t=await n.stdout(e,["-version"],{timeout:p.CmdTimeoutMs}),i=t.split(/\s+/,1)[0],r=new E(":memory:",{fileMustExist:!1}),s=r.prepare("select sqlite_version()").pluck().get();return r.close(),{libraryVersion:s,toolVersion:i,fullToolVersion:t}}))},t.sqlite=async function({dbFile:e,sql:t,args:i}){const r=await d.sqliteNativePath(),a=await s.elapsedAsync((()=>n.stdout(r,[...w.toA(i),e.nativePath,t],{timeout:1*m.minuteMs})));return T.debug("sqlite("+t+") on "+e+" in "+a.elapsedMs+"ms",a.result),a.result},t.backupDbFile_=async function(e,t){try{await t.parent().mkdirp_();const i=new c.PushProgressObserver({path:b.toS(e),op:"Backing up"},100);await P.withDb(e,(e=>e.backup(b.toS(t),{progress:({totalPages:e,remainingPages:t})=>(i.onProgress(100*(1-t/(e+t))),100)})),p.CmdTimeoutMs)}catch(i){throw new l.WrappedError({cause:i,fatal:!0,message:`Could not back up db ${e} -> ${t}`})}};const x=[{integrity_check:"ok"}];function D(e){try{const t=e.pragma("integrity_check");if(f.eql(t,x))return T.info("verifyDb("+e.name+"): OK"),!0;throw new Error(g.stringify(t))}catch(t){throw new l.WrappedError({cause:t,fatal:!0,retriable:!1,message:"verifyDb("+e.name+") failed"})}}function C(e){return P.withDbSync(e,D,p.CmdTimeoutMs)}t.verifyDb_=D,t.verifyDb=function(e){try{return D(e)}catch{return!1}},t.verifyDbFile_=C;const k=["wal_checkpoint(RESTART)","optimize"];async function I(e,t){T.info("coldDbBackup(): copying "+e+" to "+t);const i=M.sqliteFiles(e).filter((t=>!t.eql(e)));await e.copyFile_(t),await v.thenCollect(i,(e=>e.copyFile_(t))).catch((e=>T.warn("Failed to copy aux db files",e)))}t.optimizeDb=function(e){T.warn("optimizeDb() starting...",e.name);for(const t of k)e.pragma(t);T.warn("optimizeDb() finished.")},t.repairDbFile_=async function(e,t="recover",i=!0){const r=u.BaseFile.for(e),s=(await r.parent().join(t).mkdirpSync_()).join(r.base);T.info(`repairDbFile_(${r} -> ${s})`);try{const e=await d.sqliteNativePath(),o=3*S.MB+1.25*await r.size(),u=10*o,h=new c.PushProgressObserver({path:b.toS(r),op:"Repairing db"},o),p=new y.Latch,f=n.execFile(e,[r.nativePath,"."+t],5*m.minuteMs,{encoding:"buffer",maxBuffer:u});f.stdout.on("error",(e=>a.onError("sqlite "+t+" failed for "+r,new l.WrappedError({cause:e,fatal:i}))));const g=n.execFile(e,[s.nativePath],5*m.minuteMs,{encoding:"buffer",maxBuffer:u});g.on("exit",(()=>p.resolve())),f.stdout.on("end",(()=>{g.stdin.end(k.map((e=>"PRAGMA "+e+";")).join("\n"))})),f.stdout.on("data",(e=>{const t=e.length;h.incrProgress(t),g.stdin.write(e)})),await p,await C(s),T.info(`repairDbFile_(): ${s} is valid, finishing repair.`);const w=await v.thenCollect(M.sqliteFiles(r),(e=>e.renameYMDHMS_("needed-repair")));return await v.thenCollect(M.sqliteFiles(s),(e=>e.mv_(r.parent()))),w.find((e=>".db"===e.ext||e.ext.startsWith(".sqlite")))}catch(e){return T.throw("failed to recover DB via dump and restore. Please see <https://photostructure.com/faq/restore-db-from-backup/> "+o.FatalErrorFlag,e)}},t.escStr=function(e){return`'${b.toS(e).replace(/'/g,"''")}'`},t.makeVersionBackup_=async function(e){if(await e.notExists())return;const t=await e.parent().join("version-backup").mkdirp(),i=await(null==t?void 0:t.childWithSameContents(e));if(null==t||null!=i)return i;const n=t.join(r.filestamp()+"-"+e.base);return await I(e,n),n},t.backupDbCold_=I},68746:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDbOpen=t.sqliteFiles=void 0;const n=i(7162),r=i(88491),s=i(11448),a=i(2829),o=s.lazy((()=>n.mkLogger("SQLiteFiles")));t.sqliteFiles=function(e){return[e,...a.SqliteSuffixes.map((t=>e.sibling(e.base+t)))].filter((e=>e.clear().existsSync()))},t.isDbOpen=async function(e,t=2*r.minuteMs){if(await e.clear().isEmpty())return!1;for(const i of a.SqliteSuffixes){const n=e.sibling(e.base+i),r=await n.clear().maxStatMs();if(null!=r&&Date.now()-r<t)return o().debug("isDbOpen("+e+"): "+n+" is too recent",{lastTouchedAgoMs:Date.now()-r}),!0}return!1}},66056:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prepQueries=t.isQueryBuilder=t.sqlQueryToS=t.toSqlQuery=t.isSqlQuery=void 0;const n=i(13779),r=i(1058),s=i(91464),a=i(11944),o=i(39938),l=i(87748),u=i(61570),c=i(34601),d=i(82798),h=i(21208);function p(e){return null!=e&&s.isString(e.sql)&&(null==e.bindings||h.isDbValued(e.bindings))}t.isSqlQuery=p,t.toSqlQuery=function(e){if(null==e)throw new Error("null sql");if(p(e))return e;if(s.isString(e))return{sql:e};if(c.isFunction(e.toSQL))return u.omit(e.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+l.stringify(e))},t.sqlQueryToS=function(e){if(null==e.bindings)return e.sql;if(Array.isArray(e.bindings))return a.flatten(n.zip(e.sql.split("?"),e.bindings.map((e=>l.stringify(e))))).join("");{let t=e.sql;for(const i of u.keys(e.bindings))t=t.replace(new RegExp("[@:$]"+r.escapeRegExp(i),"gi"),d.toS(e.bindings[i]));return t}},t.isQueryBuilder=function(e){return c.isFunction(e.where)&&c.isFunction(e.limit)},t.prepQueries=function(e){return e.replace(/\s*--.*?\n/g,"").split(";").map((e=>e.replace(/\s+/g," ").trim())).filter(o.notBlank)}},2829:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqliteSuffixes=void 0,t.SqliteSuffixes=["-wal","-journal"]},75179:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tx=void 0;const n=i(21142),r=i(49379),s=i(7162),a=i(43414),o=i(92585),l=i(88491),u=i(43947),c=i(11448),d=i(23175),h=i(56550),p=i(57527),m=c.lazy((()=>s.mkLogger("Transactions"))),f=l.minuteMs;let g=!1;t.tx=async function(e,t,i=!1,s=!1){if(null==e.db)throw new Error("tx(): null db");try{return i&&(g=!0),!s&&p.isVacuuming(e)&&null==await n.untilTrue((()=>!p.isVacuuming(e)),{timeoutMs:f})&&m().throw("Timeout while waiting for external vacuum to complete"),await o.retryOnReject((async()=>e.inTransaction?t(e.db):h.handleDbRetries((()=>e.db.transaction((()=>t(e.db))).deferred()),e.onRetry)),{maxRetries:10,errorIsRetriable:async t=>!(i||g||(m().warn("errorIsRetriable()",t),!r.isSqliteBusyError(t)&&!r.isSqliteDisconnectedError(t)||(e.closeDb(),m().warn("Trying to reopen the db "+e.dbfile),0))),timeoutMs:a.Settings.maxBusyDbMs.valueOrDefault/10,onRetryWaitUntil:e=>{const t=d.randomInt(10,a.Settings.maxBusyDbMs.valueOrDefault/(10-e));return m().warn("onRetryWaitUntil()",{retryCount:e,delayMs:t}),u.delay(t)}})}catch(e){if(i||g)return;throw m().warn("tx(): raised",e),e}finally{i&&(g=!1)}}},57527:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.withVacuumEvent=t.checkRemoteVacuuming=t.isVacuuming=void 0;const n=i(79015),r=i(7162),s=i(53370),a=i(38625),o=i(11448),l=i(66776),u=i(26588),c=i(18935),d=i(93850);let h;const p=o.lazy((()=>r.mkLogger("Vacuum")));t.isVacuuming=function(e){return(null==e||"models"===e.schema)&&a.isTrue(h)};const m=async e=>{"boolean"!=typeof e&&p().throw("invalid setVacuuming argument",{value:e}),p().debug("setVacuuming()",{value:e}),h=e};n.onVacuuming(m),t.checkRemoteVacuuming=async function(){var e;return u.thenMap(null===(e=d.rpcClient())||void 0===e?void 0:e.request("isVacuuming"),(e=>(p().info("checkRemoteVacuuming() received RPC value",{value:e}),l.map(e,m))))},t.withVacuumEvent=async function(e){if(await c.isLockOwner()){p().info("db vacuum starting...");try{return h=!0,s.broadcast("vacuuming",!0),await e()}finally{h=!1,s.broadcast("vacuuming",!1),p().info("db vacuum finished.")}}else p().info("withVacuumEvent(): no-op, I'm not the lock owner.")}},70582:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.withDb=t.withDbSync=void 0;const n=i(43414),r=i(82798),s=i(48915);t.withDbSync=function(e,t,i=n.Settings.dbTimeoutMs.valueOrDefault){const a=s.mkdb(r.toS(e),i);try{return t(a)}finally{a.close()}},t.withDb=async function(e,t,i=n.Settings.dbTimeoutMs.valueOrDefault){const a=s.mkdb(r.toS(e),i);try{return await t(a)}finally{a.close()}}},34490:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DbAdvisoryLockProvider=t.withAdvisoryLocks=t.AdvisoryLock=t.CurrentLockHoldersSql=void 0;const n=i(21142),r=i(80294),s=i(70403),a=i(37086),o=i(88491),l=i(11448),u=i(23175),c=i(7907);t.CurrentLockHoldersSql="\nSELECT\n  al1.name,\n  al1.lockId\nFROM\n  AdvisoryLock AS al1\n  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name\n  AND al1.createdAt > al2.createdAt\nWHERE\n  al2.createdAt IS NULL\n".replace(/\s+/," ");class d extends c.Model{static vacuum(e=30*o.minuteMs){return this.dbl.runf((t=>t.where("createdAt","<=",Date.now()-e).delete()))}static async currentAcquiredLocks(){return this.dbl.pluckAllf((e=>e.select("name").where({acquired:1})))}static async allLocks(){return this.dbl.pluckAllf((e=>e.select("name")))}static async withLocks({lockNames:e,f:t,timeoutMs:i}){const c=Date.now(),h={},p=a.uid();this.logger().debug("withLocks()",{lockNames:e,lockId:p});const m=h.locks=e.map((e=>({name:e,lockId:p,acquired:0,createdAt:Date.now()})));await this.tx((e=>e.runf((e=>e.insert(m)))));const f=l.lazy((()=>this.logger().warn("long wait time for",e)));try{const a=await n.untilTrue((async()=>{const e=await this.tx((e=>e.runf((e=>e.where({lockId:p}).update({acquired:1})))),!0);return null!=e||r.nowish(c,5*o.secondMs)||f(),null!=e}),{timeoutMs:i,timeBetweenMs:u.randomInt(5,500)});if(this.logger().info("withLocks()",{lockNames:e,acquired:a}),a){h.acquireMs=Date.now()-c;const e=await s.elapsedAsync((async()=>t(p)));h.result=e.result,h.runMs=e.elapsedMs}}finally{const e=await s.elapsedAsync((()=>d.tx((e=>e.runf((e=>e.where({lockId:p}).delete()))))));h.releaseMs=e.elapsedMs,h.released=!0}return h}}t.AdvisoryLock=d,d.tableName="AdvisoryLock",d.uniqueColumnName="name,lockId",t.withAdvisoryLocks=(e,t)=>d.withLocks({lockNames:e,f:t,timeoutMs:o.minuteMs}).then((e=>e.result)),t.DbAdvisoryLockProvider={withAdvisoryLocks:t.withAdvisoryLocks}},30690:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Asset=void 0;const n=i(46852),r=i(80294),s=i(93125),a=i(2023),o=i(93813),l=i(11944),u=i(13783),c=i(38625),d=i(9381),h=i(11448),p=i(66776),m=i(61570),f=i(54608),g=i(26588),y=i(39784),v=i(18290),w=i(52465),b=i(49374),S=i(89452),M=i(61331),P=i(13222),E=i(50725),T=i(94358),x=i(1724);class D extends x.TimestampedModel{constructor(){super(...arguments),this.attrs={},this.urls=h.lazy((()=>new u.AssetUrls(this.toID())))}static shownUnhidden(e){return p.orElse(e,(()=>D.query())).andWhere({shown:1,hidden:0,excluded:0})}static outdatedQuery(){return this.query().whereNull("deletedAt").andWhere({shown:1,excluded:0,hidden:0}).andWhere("version","<",o.AssetVersion)}static deletePreviews(e){return b.Library.instance().previews().ap(e).deleteAll()}static async delete(e){this.logger().warn("Deleting asset "+e);const t=await S.AssetFile.dbl.pluckAllf((t=>t.select("sha").where({assetId:e})));await P.upsertToShaBlockslist(...t),await M.AssetTag.dbl.runf((t=>t.delete().where({assetId:e}))),await S.AssetFile.dbl.runf((t=>t.delete().where({assetId:e}))),await D.dbl.runf((t=>t.delete().where({id:e}))),await D.deletePreviews(e)}static async exclude(e){return this.logger().info("Excluding asset "+e),{dbResult:await D.dbl.runf((t=>t.update({excluded:1}).where({id:e}))),deletedPreviews:await D.deletePreviews(e)}}static nextOutdated(e=a.identity){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=a.identity){return this.dbl.pluckFirst(e(this.outdatedQuery()).count())}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static async addTags(e,t){const i=l.uniqBy(t.filter(l.isNotEmpty),(e=>w.joinTagPath(e)));return this.logger().debug("addTags()",{assetId:e,tagPaths:t,uniqTagPaths:i}),l.isEmpty(i)?void 0:D.tx((async()=>{const t=(await g.thenCollect(i,(e=>E.Tag.findOrCreate(e)))).map((e=>e.id));return M.AssetTag.addTagsToAsset(e,t)}))}static async removeTags(e,t){if(l.isEmpty(t))return;const i=await g.thenCollect(t,(e=>E.Tag.findByPath(e)));return this.logger().info("removeTags()",{assetId:e,tags:i.map((e=>m.pick(e,"id","path"))),tagPaths:t}),M.AssetTag.removeTagsFromAsset(e,l.compact(i.map((e=>e.id))))}static unshownAssetIds(){return this.dbl.pluckAll("\n        SELECT DISTINCT af1.assetId\n        FROM AssetFile af1\n          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 \n            ON af1.assetId = af2.assetId\n        WHERE af2.assetId IS NULL")}static archive(e){return this.tx((async()=>{null!=await D.ops().findById(e)&&(await M.AssetTag.dbl.runf((t=>t.where({assetId:e}).delete())),await S.AssetFile.dbl.runf((t=>t.where({assetId:e}).delete())),await D.dbl.runf((t=>t.where({id:e}).delete())))}))}get capturedAt(){return r.localToDateObject(this.capturedAtLocal)}get capturedAtMs(){return r.localToTs(this.capturedAtLocal)}markUnshownAndUpsert(){return this.shown=!1,this.version=o.AssetVersion,this.upsert()}markShownAndUpsert(){return this.shown=!0,null==this.excluded&&(this.excluded=!1),this.version=o.AssetVersion,this.upsert()}toAssetId(){return{assetId:this.id,capturedAtLocal:this.capturedAtLocal}}renderCaption(e){return p.map(this.capturedAtMs,(t=>"Taken "+s.fmtDateShort(t,e)))}async whenApiTag(){return f.thenOpt(this.capturedAt).flatMap((e=>v.dateTag(e))).flatMap((e=>E.Tag.findOrCreate(e))).flatMap((e=>e.toApiTag())).get()}addTagPaths(e){return D.addTags(this.id,e)}async findAssetFileByUri(e){return await this.getFiles(),this.files.find((t=>t.uri===e))}async addAssetFile(e){return null==await this.findAssetFileByUri(e.uri)&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}static getTags(e){return E.Tag.ops().all(E.Tag.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}async getTags(){return null==this.tags&&(this.tags=await D.getTags(this.id)),this.tags}static getTagPaths(e){const t=E.Tag.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return E.Tag.dbl.pluckAll(t)}async tagPaths(){return(await this.getTags()).map((e=>e.path.join("/"))).sort()}async getStreams(e){if(null==this.streams){const t=await this.getTags();this.logger().info("getStreams(): fetched tags "+t,{limit:e});const i=await g.thenCollect(t,(t=>t.getAssetStream(this,e)));this.streams=T.coalesceStreams(l.compact(i));for(const e of this.streams)for(const t of e.tags)await t.getAncestors()}return this.streams}async getBeforeAfterId(){const e=await D.dbl.all(D.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id"));this.afterId=p.map(e.find((e=>e.id>this.id)),x.toID),this.beforeId=p.map(e.reverse().find((e=>e.id<this.id)),x.toID),await n.thenOrElse(this.beforeId,(()=>this.getBeforeId())),await n.thenOrElse(this.afterId,(()=>this.getAfterId()))}async getBeforeId(){return n.thenMap(D.dbl.first(D.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}])),(e=>this.beforeId=x.toID(e)))}async getAfterId(){return n.thenMap(D.dbl.first(D.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}])),(e=>this.afterId=x.toID(e)))}async getTagPaths(){return(await this.getTags()).map((e=>e.path))}async getFiles(){if(null!=this.files)return this.files;if(null==this.id)return this.files=[];const e=await S.AssetFile.ops().findBy({assetId:this.id});return this.files=l.sortBy(e,(e=>[!c.isTrue(e.shown),-e.mtime]))}async setShown(e){return S.AssetFile.setShown(this.id,e)}async getShown(){if(null!=this.files){const e=this.files.find((e=>c.isTrue(e.shown)));if(null!=e)return e}return n.thenMap(S.AssetFile.ops().findOneBy({assetId:this.id,shown:1}),(e=>m.tap(e,(e=>e.asset=this))))}async getCapturedAts(){return g.thenCollect(this.getFiles(),(e=>e.toCapturedAt()))}link(){return"/asset/"+this.id}sqAttrs(e=!0){return{...this.urls().sqImgAttrs(e),title:this.renderCaption(),...this.attrs}}async getImgAttrs(e,t,i=!1){if(null==this.imgAttrs&&(this.imgAttrs=new Map),null==this.imgAttrs.get(t)){const r=e.ap(this.toID());await n.thenMap(r.readInfo(),(async e=>{e.mimetype.startsWith("video/")&&(this.poster=await r.posterLink())}));const s=!0;this.imgAttrs.set(t,await r.imgAttrs(t,s,i))}return this.imgAttrs.get(t)}async fitAttrs(e){return{...await this.getImgAttrs(e,d.ReducerNames.fit),...this.attrs}}isVideo(){if(null==this.files)throw new Error(".video called before getFiles()");return this.files.some((e=>e.isVideo))}videoAttrs(){return{controls:!0,autoplay:!0,poster:this.poster,...this.attrs}}videoSources(){if(null==this.existingFiles)throw new Error(".videoSources called before getExistingFiles()");const e=this.existingFiles.filter((e=>e.isVideo)).map((e=>({src:this.urls().videoLink(e.id),type:e.mimetype}))),t=l.uniqBy(e,(e=>e.type));if(t.every((e=>"video/mp4"!==e.type))){const e=this.existingFiles[0];t.unshift({src:this.urls().videoLink(e.id)+".mp4",type:"video/mp4"})}return t}async getPosixFiles(){const e=await this.getFiles();return l.compact(await Promise.all(e.map((e=>e.posixFile()))))}async getExistingAssetFiles(){return null==this.existingFiles&&(this.existingFiles=await n.filterAsync(await this.getFiles(),(e=>n.thenMapOr(e.posixFile(),(e=>e.exists()),(()=>!1))))),this.existingFiles}async findOrCreateByFile(e){const t=await e.uri();if(null==t)return;const i=y.toA(await S.AssetFile.findByAsset({id:this.id},{uri:t}))[0];return p.orElse(i,(async()=>{const t=new S.AssetFile;return t.asset=this,t.assetId=this.id,await t.setFile(e),t}))}clear(){return this.existingFiles=void 0,this.files=void 0,this.imgAttrs=void 0,this.streams=void 0,this.tags=void 0,this}async setHidden(e){return this.hidden=e,this.upsert()}}t.Asset=D,D.tableName="Asset",D.uniqueColumnName="id",D.booleanFields=["shown","hidden","excluded"],D.shownCount=h.lazy((()=>D.ops().countf((e=>e.whereNull("deletedAt").andWhere({shown:1,excluded:0,hidden:0}).countDistinct("Asset.id")))))},89452:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFile=void 0;const n=i(85622),r=i(46852),s=i(80294),a=i(93125),o=i(10408),l=i(98250),u=i(85563),c=i(72461),d=i(27649),h=i(15271),p=i(2023),m=i(93813),f=i(1058),g=i(43414),y=i(91464),v=i(65642),w=i(44546),b=i(74873),S=i(3874),M=i(19209),P=i(25116),E=i(32421),T=i(11944),x=i(39938),D=i(38625),C=i(88491),k=i(57743),I=i(61560),F=i(9381),O=i(87748),A=i(11448),_=i(66776),L=i(75556),R=i(61570),N=i(54608),B=i(8199),j=i(82798),z=i(96672),V=i(18273),W=i(93445),q=i(30690),U=i(50725),H=i(1724);class G extends H.TimestampedModel{constructor(){super(...arguments),this.posixFile=A.lazy((()=>l.PosixFile.forUri(this.uri,this.mountpoint)))}static async recentAssetIdsByUriRoot(e,t,i=64){const n=Date.now()-t;let r=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",n).andWhere("Asset.shown",1).andWhere("Asset.hidden",0);return x.notBlank(e)&&(r=r.andWhere("AssetFile.uri","like",e+"%")),r=r.orderBy("AssetFile.updatedAt","desc").limit(i),this.logger().debug("recentAssetIdsByUriRoot",r.toSQL()),this.dbl.pluckAll(r)}static assetCountByMimetype(e){let t=this.query().select(V.knex().raw("mimetype, count(*) as count")).join("Asset","Asset.id","AssetFile.assetId").where("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0);return x.notBlank(e)&&(t=t.andWhere("uri","like",e+"%")),t=t.groupBy("mimetype").orderBy("mimetype"),this.dbl.all(t)}static async assetCountByMimetypeRoot(e){const t=await this.assetCountByMimetype(e);return T.sort(T.uniq(t.map((e=>e.mimetype.split("/")[0])))).map((e=>({mimetypeRoot:e,count:T.sum(t,(t=>t.mimetype.startsWith(e+"/")?t.count:0))})))}static children(e,t){const i=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${f.escapeRegExp(e)}/[^/]+$}`);return this.ops().all(_.mapOr(t,(e=>e(i)),(()=>i)))}get capturedAtDateTime(){return s.localToDateTime(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return a.fmtDateTime(this.capturedAtDateTime,e)}static outdatedQuery(e){const t=this.query().where("version","<",m.AssetFileVersion).orderBy("id");return T.isEmpty(e)?t:t.andWhere((t=>t.whereIn("mountpoint",e).orWhereNull("mountpoint")))}static async nextOutdated(e=p.identity){return this.ops().findOne(e(this.outdatedQuery(await E.mountpoints())))}static async outdatedCount(e=p.identity){const t=this.outdatedQuery(await E.mountpoints());return this.dbl.pluckFirst(e(t.count("id")))}static async setShown(e,t){if(this.logger().info("setShown()",{assetId:e,assetFileId:t}),!L.gt0(e)||!L.gt0(t))throw new Error("setShown(): invalid IDs: "+O.stringify({assetId:e,assetFileId:t}));await this.dbl.runf((t=>t.update("shown",0).where("assetId",e)));const i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),n={assetId:e,assetFileId:t,updatedAt:Date.now()};return this.dbl.run({sql:i,bindings:n})}static async findByAsset(e,t){const i=this.query().select("AssetFile.*");return _.map(R.compactValues(e),(e=>i.join("Asset","Asset.id","AssetFile.assetId").where(R.mapFields(e,((e,t)=>["Asset."+e,t]))))),_.map(R.compactValues(t),(e=>i.where(R.mapFields(e,((e,t)=>["AssetFile."+e,t]))))),this.ops().all(i)}get modes(){return T.compact(L.times(c.ModeCount,(e=>this["mode"+e])))}set modes(e){L.times(c.ModeCount,(t=>this["mode"+t]=e[t]))}async matchesFile(e){if(null==this.version||this.version<m.AssetFileVersion||g.Settings.forceSync.valueOrDefault)return!1;const t=await this.fileFields(e);return p.eqlSubset(t,this)}fileFields(e){return N.thenOpt(e).orElse((()=>this.posixFile())).filter((e=>e.exists())).flatMap((async e=>({uri:await e.uri(),fileSize:await e.size(),mtime:await e.thisOrSidecareMaxMtimeMs()}))).filter(R.isReqValued).get()}isVersionUpToDate(){return B.gte(this.version,m.AssetFileVersion)}async siblingCount(){return G.dbl.pluckFirstf((e=>e.count().where({assetId:this.assetId}).andWhereNot({id:this.id})))}async upsertIfNeeded(){const e=g.Settings.forceSync.valueOrDefault;return await this.matchesFile()&&L.gt0(this.id)&&!e?this.upsert():await this.isFileDeleted()?(this.deleted=!0,void await this.delete()):await this.notExists()?void 0:r.thenMap(this.updateFromFile(),(()=>this.upsert()))}async maybeUpdateStats(e){return r.thenMap(this.fileFields(e),(e=>p.assignFields(this,e)))}async updateFromFile(e){const t=Date.now(),i=this.logger().addContext(".updateFromFile()");if(i.debug("before",this),null!=this.id&&await this.matchesFile(e))return void i.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");if(null!=e&&await this.setFile(e),null==e&&(e=await this.posixFile()),null==e||await e.notExists())return void i.info("no-op, "+e+" is missing");if(null==this.mountpoint&&await r.thenMap(e.mountpoint(),(e=>this.mountpoint=e.nativePath)),null==await this.maybeUpdateStats(e))return void i.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});const n=e.sha(),s={},a=await w.readTags(e);if(null==a)return void i.error("missing tags for "+e);if(x.blank(a.MIMEType))return void i.error("missing MIMEType for "+e);s.mimetype=a.MIMEType;const o=a.capturedAt,l=o.toLocal();if(null==l)return i.throw("bad CapturedAt",o);s.capturedAtLocal=l,s.capturedAtOffset=o.toOffset(),s.capturedAtPrecisionMs=o.toPrecisionMs(),s.capturedAtSrc=o.src,_.map(a.exposureSettings,(e=>{s.focalLength=e.focalLength,s.aperture=e.aperture,s.shutterSpeed=e.shutterSpeed,s.iso=e.iso}));const d=a.dimensions;if(s.width=d.width,s.height=d.height,s.rotation=a.rotation,s.make=a.Make,s.model=a.Model,s.cameraId=b.cameraId(a),s.imageId=_.map(b.imageId(a),j.toS),s.lensId=b.lensId(a),s.geohash=u.geohashNumericShort(a.GPSLatitude,a.GPSLongitude),s.durationMs=_.map(a.duration,(e=>Math.round(1e3*e))),s.fps=_.map(L.toFloat(a.VideoFrameRate),L.round),s.sha=await n,null==s.sha)return void i.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri});(g.Settings.useImageHashes.valueOrDefault||g.Settings.strictDeduping.valueOrDefault)&&await r.thenMap(c.imageHash(e),(e=>{s.meanHash=e.meanHash,s.modes=e.modes})),p.assignFields(this,s),this.version=m.AssetFileVersion;const h=Date.now()-t;return i.log(h>C.secondMs?"info":"debug","after ("+h+"ms)",this),this}async updateFromShaSibling(e){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:null==e.sha||!e.isVersionUpToDate()||null!=this.sha&&e.sha!==this.sha?this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e}):(p.assignFields(this,R.omit(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt")),this)}async getAsset(){return null==this.assetId||null!=this.asset?this.asset:this.asset=await q.Asset.ops().findById(this.assetId)}async exists(){return r.thenMapOr(this.posixFile(),(e=>e.exists()),(()=>!1))}async notExists(){return r.thenNot(this.exists())}async isFileDeleted(){return r.thenMapOr(this.posixFile(),(e=>e.isDeleted(this.uri)),(()=>!1))}async isFiltered(){return N.thenOpt(this.posixFile()).filter((e=>e.exists())).flatMap((e=>W.libraryFileFilter().apply(e))).map((e=>!e)).getOrElse((()=>!1))}async hasNoMedia(){return r.thenMapOr(this.posixFile(),(e=>e.hasNoMedia()),(()=>!1))}async setFile(e){const t=await e.uri();if(null==t)return this.logger().throw("setFile(): no URI for "+e);const i=await e.mountpoint();if(null==i)return this.logger().throw("setFile(): no mountpoint for "+e);if(null!=this.uri&&!await P.uriIsEquivalent(t,this.uri))return this.logger().throw("setFile(): cannot reassign non-equivalent URI",{prior:this.uri,new:t,file:e.nativePath});if(null==await e.uriObject())throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);return this.uri=t,this.mountpoint=i.nativePath,this.posixFile.set(Promise.resolve(e)),t}nativePath(){return r.thenMap(this.posixFile(),(e=>e.nativePath))}toCapturedAt(){return _.map(s.localToDateTime(this.capturedAtLocal,this.capturedAtOffset),(e=>r.thenMap(this.posixFile(),(t=>new v.CapturedAt(t.nativePath,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))))}async downloadables(e,t){try{const i=await this.posixFile();if(null==i)return[];const n=e.ap(this.assetId),r=[];if(await i.isNonEmpty()&&r.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:d.mkDownloadableTitle(i,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:i.base,description:"Download original",details:`(${k.dimToS(this)} ${i.ext})`}),this.isVideo)return r;if(!D.isTrue(this.shown)&&this.sha!==t)return r;const s=T.compact(await Promise.all([...await n.previews()].reverse().filter((e=>e.reducer===F.ReducerNames.fit)).map((e=>d.previewToDownloadable(i.base,e)))));return r.push(...T.uniqBy(s,(e=>e.size))),r}catch(e){return o.onError("AssetFile.downloadables failed",e,{context:this}),[]}}async pathInfo(){try{const e=M.URI.parse(this.uri),t=await S.uri2nativePath(e,this.mountpoint);if(null==t)return void this.logger().warn("pathInfo(): failed to build nativePath",{uri:this.uri});const i=e.fsPath,r=y.stripSuffix(t,i).split(n.sep),s=r.pop(),a=i.split(n.sep),o=z.uriToTagPath(e),l=await U.Tag.findByPath(o);if(null==l)return void this.logger().warn("pathInfo(): failed to find existing Tag",{tagPath:o});const u=await l.toApiPathElements();this.logger().info("pathInfo()",{uri:this.uri,fsPath:i,nativePath:t,mountpointParent:r,pathAfterMountpointParent:a,mountpointName:s,tag_path:l.path,pathElements:u}),u.shift(),x.blank(s)?u.shift():u[0].displayName=s,a.splice(0,u.length);const c={nativePath:t,nativePathPrefixWbr:y.wbrPath(r.join(n.sep)+n.sep),pathElements:u,nativePathSuffix:a.join(n.sep),pathSep:n.sep,exists:await this.exists()};return this.logger().info("pathInfo()",{result:c}),c}catch(e){return void this.logger().warn("pathInfo(): failed",e)}}async toApi(e,t){return r.thenMap(this.pathInfo(),(async i=>R.reqValuedOrElse({assetId:this.assetId,assetFileId:this.id,...i,mimetype:this.mimetype,shown:D.isTrue(this.shown),width:this.width,height:this.height,rotation:_.orElse(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:await this.downloadables(e,t),createdAtLocale:J(this.createdAt),updatedAtLocale:J(this.updatedAt)})))}get isVideo(){return h.isVideoMimeType(this.mimetype)}}function J(e){return _.map(e,(e=>I.fmtDuration(Date.now()-e,1)+" ago"))}t.AssetFile=G,G.tableName="AssetFile",G.uniqueColumnName="uri",G.booleanFields=["shown"]},61331:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetTag=void 0;const n=i(11944),r=i(66776),s=i(75556),a=i(7907);class o extends a.Model{$pk(){return[r.orElse(this.assetId,(()=>r.map(this.asset,(e=>e.id)))),r.orElse(this.tagId,(()=>r.map(this.tag,(e=>e.id))))].join(":")}static addTagsToAsset(e,t){const i=s.id(e);if(null==i)return void this.logger().warn("addTagsToAsset(): got null assetId");const r=n.compact(t.map(s.id));if(n.isEmpty(r))return void this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:t});const a="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+r.map((e=>`(${i},${e})`)).join(",");return this.dbl.run(a)}static removeTagsFromAsset(e,t){t=n.compact(t);const i=this.query().whereIn("tagId",t).andWhere({assetId:e}).delete();return this.dbl.run(i)}}t.AssetTag=o,o.tableName="AssetTag",o.uniqueColumnName="assetId,tagId"},55916:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeMonthTag=t.normalizeDateTags=t.getMonthTags=void 0;const n=i(7162),r=i(70283),s=i(11254),a=i(11448),o=i(26588),l=i(18290),u=i(50725),c=`'${s.TagRoots.When}' || char(31) || '%' || char(31) || '%' || char(31)`,d=c+" || '%' || char(31)",h=a.lazy((()=>n.mkLogger("DateTagNormalizer")));async function p(){return u.Tag.ops().allf((e=>e.whereNotNull("ordinal").andWhereRaw("_path LIKE "+c+" AND _path NOT LIKE "+d).limit(2400)))}async function m(e){const t=await r.mapGt0(e.ordinal,(e=>l.monthTagRef(l.ordinalToMonth(e))));null==t?h().warn("failed to fix tag (no monthTagRef)",{t:e}):t.name!==e.name&&(h().info("Fixing month name",{tagRef:t,tag:e}),await e.changeName(t.name)),await e.maybeUpsertDisplayName(null==t?void 0:t.displayName)}t.getMonthTags=p,t.normalizeDateTags=async function(){await u.Tag.tx((async()=>o.thenCollect(p(),m)))},t.normalizeMonthTag=m},77910:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Heartbeat=void 0;const n=i(79141),r=i(88491),s=i(1724);class a extends s.TimestampedModel{static ping(e="ping"){return a.ops().upsertOne({name:e})}static async assertPing(e){const t=Date.now();try{if(null==a.db())throw new Error("db is undefined");const i=await this.ping(e);if(this.logger().debug("assertPing()",{heartbeat:i}),Math.abs(t-i.updatedAt)>20*r.secondMs)throw new Error("Heartbeat.updatedAt wasn't updated")}catch(e){throw new n.WrappedError({cause:e,message:"Failed to write to the library database"})}}}t.Heartbeat=a,a.tableName="Heartbeat",a.uniqueColumnName="name"},84509:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.runJanitorialTasks=void 0;const n=i(7383),r=i(63216);t.runJanitorialTasks=async function(){await n.time("db.runTagMaintenance",r.runTagMaintenance)}},7907:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Model=void 0;const n=i(31669),r=i(7162),s=i(19658),a=i(11944),o=i(39938),l=i(38625),u=i(66776),c=i(61570),d=i(8199),h=i(26588),p=i(82798),m=i(18273),f=i(75179),g=i(9069),y=i(79563),v=i(5333);class w{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return null==this._logger&&(this._logger=r.mkLogger(this.tableName)),this._logger}static query(){return m.knex()(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static ops(){return null==this._ops&&(this._ops=new v.ModelOps(this,this.db)),this._ops}static get dbl(){return this.ops().dbl}static async txOp(e){return f.tx(this.db(),(()=>e(this.ops())))}static async tx(e,t=!1){return f.tx(this.db(),(()=>e(this.dbl)),t)}static rows(){return this.ops().rows()}static truncate(){if(s.isProd)throw new Error("rejecting attempt to truncate in prod");return this.dbl.run("DELETE FROM "+this.tableName)}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return p.toS(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${u.orElse(this.id,this[this.class().uniqueColumnName])})`}logger(){return r.mkLogger(p.toS(this.valueOf()))}[n.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return y.fromJSON(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}$toShallowJSON(){return this.$_toJSON(l.isTrue)}$toDbJSON(e){const t=this.$_toJSON(l.boolToInt,!1);return o.notBlank(e)?c.pick(t,...e):t}toJSON(){return this.$_toJSON(l.isTrue)}$_toJSON(e,t=!0){const i=this.class();return c.mapFields(this,((t,n)=>{if(null!=n&&d.isPrimitive(n))return a.includes(i.booleanFields,t)?[t,e(n)]:[t,n]}),t?{$ctor:i.$ctor}:{})}upsert(e){return null!=e&&y.assignFromJSON(this,e),this.class().ops().upsertOne(this)}$beforeUpsert(){}async reload(){return h.thenMap(this.class().ops().findById(this.id),(e=>y.assignFromJSON(this,e)))}delete(){return u.map(this.id,(e=>this.class().ops().delete([e])))}}t.Model=w,w.schema="models",w.db=g.modelDb},9069:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localModelDbPath=t.libraryModelDbFile=t.setModelDb=t.modelDb=void 0;const n=i(38625),r=i(71395),s=i(66776),a=i(11303);let o;function l(){return s.map(r.libraryDataDir(),(e=>a.pathToDb(e,"models")))}t.modelDb=()=>o,t.setModelDb=function(e){o=e},t.libraryModelDbFile=l,t.localModelDbPath=function(){return n.isFalse(null==o?void 0:o.datadir.eql(l()))?o.dbfile:void 0}},31457:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDbJanitor=void 0;const n=i(34996),r=i(36079),s=i(46852),a=i(7383),o=i(7162),l=i(19658),u=i(55568),c=i(43414),d=i(46573),h=i(88491),p=i(11448),m=i(66776),f=i(18130),g=i(62155),y=i(11303),v=i(75179),w=i(15868),b=i(93850),S=i(47707),M=i(34490),P=i(55916),E=i(84509),T=i(9069),x=i(65548),D=i(63216);async function C(){return u.isMainService()||u.isSyncService()&&!await b.rpcClientReady()}class k{constructor(e,t,i){this.dataDir=e,this.localDbDir=t,this.backupAndMigrate=i,this.endTimeoutMs=h.minuteMs,this.end=p.lazy((()=>m.map(this.backup.value,(e=>e.end())))),this.setup=p.lazy((async()=>{var e;try{await this._setup(),this.logger.info("ModelDb reading from "+(null===(e=this.db.value)||void 0===e?void 0:e.dbfile))}catch(e){this.db.reject(e),this.backup.reject(e),this.logger.throw(e,{fatal:!0,from:"ModelDbJanitor.setup"})}})),this.beforeBackup=async()=>{r.ending()||!l.isTest&&u.isMainService()&&await v.tx(T.modelDb(),(async()=>{await M.AdvisoryLock.vacuum(),await x.Progress.vacuum(),await D.runTagMaintenance()}))},this.onBackupFinished=async()=>{r.ending()},this.onMigration=p.lazy((async()=>{this.logger.info("onMigration: removing prior stats db to clear prior work queues"),await s.thenMap(S.statsDbDir(!1),(e=>e.rmrf("info")))})),this.name="ModelDbJanitor("+e+")",this.logger=o.mkLogger(this.name),this.db=new n.Deferred(this.name+".db"),this.backup=new n.Deferred(this.name+".backup"),this.srcDbFile=y.pathToDb(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),r.addDbEndable(this),this.setup()}static async for({dataDir:e,localDbDir:t=w.localDbDir,backupAndMigrate:i=C}){const n=new k(e,t,i);return await n.setup(),n}get ended(){return null!=this.end.prior()}async _setup(){if(c.Settings.forceLocalDbReplica.valueOrDefault||!0===await s.thenMap(d.volumeFor(this.srcDbFile.nativePath),(e=>e.remote))){const e=await this.localDbDir();return this.localDbReplica=y.pathToDb(e,"models"),this.logger.info("Library on remote drive. Using local db replica.",{src:this.srcDbFile.nativePath,local:this.localDbReplica}),await this.backupAndMigrate()&&(this.logger.info("Setting up local model db replica...."),await this.localDbReplica.parent().rmrf("info"),await this.srcDbFile.clear().exists()&&(await this.srcDbFile.copyFile_(this.localDbReplica),await this.localDbReplica.chmod(420)),this.logger.info("Local model db replica set up at "+this.localDbReplica)),this._finishSetup(e,this.srcDbFile.parent())}return this._finishSetup(this.dataDir)}async _finishSetup(e,t){const i=await this.backupDir.mkdirp();if(null==i)throw new Error("Failed to create models DB backup dir "+this.backupDir);const n=new f.Db("models",e,this.onMigration),r=await this.backupAndMigrate();r?(await n.migrate(),this.backup.resolve(new g.DbBackup(n,this.backupAndMigrate,n.dbfile,i,t,this.beforeBackup,this.onBackupFinished))):this.backup.resolve(void 0),T.setModelDb(n),this.db.resolve(n),r&&(await a.time("db.normalizeDateTags",P.normalizeDateTags),await E.runJanitorialTasks()),this.logger.info("Finished setup",{primaryDbDir:e,replaceDbDir:t,backupDir:i})}}t.ModelDbJanitor=k},79563:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toJSON=t.assignFromJSON=t.fromJSON=t.addModelClass=void 0;const n=i(38625),r=i(7162),s=i(91464),a=i(11944),o=i(39938),l=i(61570),u=i(98510),c=new Map;function d(e){c.set(e.$ctor,e)}t.addModelClass=d;const h=([e,t])=>null!=e&&null!=t;function p(e,t,i=[]){const r=e.class();return l.keys(t).filter((e=>"$ctor"!==e)).filter((e=>null!=t[e])).map((e=>{const o=t[e];return i.forEach((t=>e=s.stripPrefix(e,t))),a.includes(r.booleanFields,e)?[e,n.isTrue(o)]:[e,o]})).filter(h).forEach((([t,i])=>e[t]=i)),e}t.fromJSON=function(e,t){if(null==t)throw new Error("json is null");if(null!=e&&o.notBlank(e.$ctor)&&!c.has(e.$ctor)&&d(e),t instanceof e)return t;const i=u.opt(t.$ctor).flatMap((e=>c.get(e))).getOrElse((()=>e));if(t instanceof i)return t;const n=new i;return null==t?n:p(n,t,a.uniq([e.tableName+".",i.tableName+"."]))},t.assignFromJSON=p,t.toJSON=function e(t,i,n){if(null!=t)return Array.isArray(t)?t.map(((t,r)=>e(t,i,`${n}[${r}]`))):"function"==typeof t.toJSON?t.toJSON():void r.mkLogger("ModelJSON.toJSON()").warn("Failed",{m:t,key:n,mc:i.$ctor})}},5333:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelOps=void 0;const n=i(13779),r=i(46852),s=i(49379),a=i(7162),o=i(70283),l=i(43414),u=i(11944),c=i(39938),d=i(87748),h=i(11448),p=i(66776),m=i(75556),f=i(61570),g=i(26588),y=i(39784),v=i(78650),w=i(56550),b=i(21208),S=i(75179),M=i(79563);t.ModelOps=class{constructor(e,t){this.model=e,this.db=t,this.columnNames=h.lazy((()=>w.handleDbRetriesSync((()=>this.db().pragma(`table_info(${this.tableName})`).map((e=>e.name)))))),this.logger=a.mkLogger(`ModelOps(${e.tableName})`),M.addModelClass(e),this.dbl=new v.DbRequest(this.db,e.tableName)}get dbOpen(){return p.mapOr(this.db(),(e=>e.open),(()=>!1))}get tableName(){return this.model.tableName}query(){return this.model.query()}async toDbValued(e){const t=this.model.fromJSON(e),i=b.toDbValued(t);return f.pick(i,...await this.columnNames())}run(e){return this.dbl.run(e)}fromJSON(e){return g.thenMap(e,(e=>this.model.fromJSON(e)))}async fromJSONs(e){return(await r.thenCompact(e)).map((e=>this.model.fromJSON(e)))}first(e){return this.fromJSON(this.dbl.first(e))}firstf(e){return this.first(e(this.query()))}all(e=this.query()){return this.fromJSONs(this.dbl.all(e))}allf(e){return this.all(e(this.query()))}findOne(e){return this.fromJSON(this.dbl.first(e))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e,t){return this.findOneBy({...t,id:e})}async findByIds(e){const t=await S.tx(this.db(),(async()=>g.thenCollect(n.batches(y.toA(e).filter(m.gt0),l.Settings.dbBatchSelectSize.valueOrDefault),(e=>this.dbl.all(this.query().whereIn("id",e))))));return u.sortBy(await this.fromJSONs(u.flatten(t)),(t=>e.indexOf(t.id)))}findBy(e){return this.all(this.model.queryBy(e))}findWhereIn(e,t){return this.all(this.model.query().whereIn(e,t))}rows(e){return this.count(p.orElse(e,(()=>this.model.query().count())))}count(e){return r.thenOrElse(this.dbl.pluckFirst(e),(()=>0))}countf(e){return this.count(e(this.query()))}async insert(e){return S.tx(this.model.db(),(()=>g.thenCollect(e,(e=>this.insertOne(e)))))}async upsertOne(e){return this.modelSupportsUpsert?(await this.upsert([e]))[0]:null==e.id?this.insertOne(e):this.updateOne(e)}async insertOne(e){if(null!=e.id)throw new Error("insert called for "+d.stringify(e)+s.NonRetriableErrorFlag);const t=this.model.fromJSON(e);t.$beforeUpsert();const i=t.$toDbJSON(await this.columnNames()),n=await this.dbl.runf((e=>e.insert(i))),r=await o.mapGt0Or(m.toInt(n.lastInsertRowid),(e=>this.findById(e)),(()=>{this.logger.throw("internal error: lastInsertedRowId was non-numeric",{runInfo:n})}));return e instanceof this.model&&M.assignFromJSON(e,r),r}async updateOne(e){if(null==e.id)throw new Error("update called for "+d.stringify(e)+s.NonRetriableErrorFlag);const t=this.model.fromJSON(e);t.$beforeUpsert();const i=t.$toDbJSON(await this.columnNames());return await this.dbl.runf((t=>t.where({id:e.id}).update(i))),t}get ucn(){return this.model.uniqueColumnName}get ucnFieldNames(){return p.orElse(this.ucn,"id").split(",")}get modelSupportsUpsert(){return null!=this.ucn&&"id"!==this.ucn}get ucnConstraint(){return`(${this.ucn})`}onConflictClause(e){const t=[...this.ucn.split(","),"id","createdAt"],i=e.filter((e=>!t.includes(e))).sort().map((e=>`${e}=excluded.${e}`)).join(","),n=["ON CONFLICT",this.ucnConstraint];return c.blank(i)?n.push("DO NOTHING"):n.push("DO UPDATE SET",i),n.join(" ")}async upsertDbJson(e){const t=this.query().insert(e).toSQL(),i=new Set;for(const t of e)for(const e of f.keys(t))i.add(e);const n={sql:`${t.sql} ${this.onConflictClause([...i.values()])}`,bindings:t.bindings};await this.run(n)}pickModelUcn(e){return f.pick(e,...this.ucnFieldNames)}async reload(e){return await g.thenCollect(e,(async e=>g.thenMap(this.findOneBy(this.pickModelUcn(e)),(t=>M.assignFromJSON(e,t))))),e}async upsert(e,t=!1){if(this.modelSupportsUpsert){const i=await this.columnNames(),n=await S.tx(this.db(),(async()=>r.thenCollectBatched(y.toA(e),l.Settings.dbBatchUpsertSize.valueOrDefault,(async e=>{const t=e.map((e=>this.model.fromJSON(e)));return t.forEach((e=>e.$beforeUpsert())),await this.upsertDbJson(t.map((e=>e.$toDbJSON(i)))),t}))));return t?n:this.reload(n)}return S.tx(this.db(),(()=>g.thenCollect(e,(e=>this.upsertOne(e)))))}async delete(e){return u.mapNotEmpty(e.filter(m.gt0),(e=>this.run(this.model.query().delete().whereIn("id",e))))}async batched(e){const t=l.Settings.dbBatchSelectSize.valueOrDefault;let i,n;do{i=await this.allf((i=>(i=e.qb(i),null!=n&&(i=i.andWhere("id",">",n)),i.orderBy("id","asc").limit(t)))),u.isNotEmpty(i)&&(n=Math.max(...i.map((e=>e.id))),await e.onResults(i))}while(u.isNotEmpty(i))}}},36310:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Operation=t.OperationNames=void 0;const n=i(36079),r=i(2023),s=i(39938),a=i(84253),o=i(1724);t.OperationNames=a.strEnum("rebuildLibrary","forceRestartSync","enqueueAssetFileUpdates","enqueueAssetUpdates","applyNewTagger");class l extends o.TimestampedModel{static incomplete(){return this.ops().allf((e=>e.whereIn("id",(e=>e.table(l.tableName).min("id").whereNull("completedAt")))))}static async getFirstPendingOp(e){return this.logger().tap({msg:"getFirstPendingOp",level:"info",result:await this.ops().firstf((t=>{const i=t.whereNull("completedAt").orderBy("createdAt","asc");return null!=e?i.andWhere(e):i})),meta:{pojo:e}})}static markOpCompleted(e){return s.blank(null==e?void 0:e.name)?this.logger().throw("markOpCompleted(): bad query",{query:e}):this.dbl.runf((t=>t.whereNull("completedAt").andWhere(e).update({completedAt:Date.now()})))}static async applyOnce(e,t,i=r.identity){const s=await this.ops().firstf((t=>i(t.whereNotNull("completedAt").andWhere(e))));if(null!=s)return void this.logger().info("applyOnce(): already done",{prior:s});const a=await this.ops().insertOne(e),o=await t(a);return n.ending()||await a.upsert({completedAt:Date.now()}),o}}t.Operation=l,l.tableName="Operation",l.uniqueColumnName="id"},65548:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Progress=t.ProgressRateMs=void 0;const n=i(12087),r=i(61765),s=i(10408),a=i(59387),o=i(11944),l=i(39938),u=i(88491),c=i(87748),d=i(11448),h=i(66776),p=i(61570),m=i(26588),f=i(44726),g=i(39784),y=i(79563),v=i(36310),w=i(33075),b=i(1724);t.ProgressRateMs=d.lazy((()=>u.secondMs*(a.maxCpus()<=3?3:1.5)));const S=f.compressWhitespace("\nSELECT\n  p1.uri as uri,\n  p1.lastUpdatedAt as lastUpdatedAt,\n  p1.lastCompletedAt as lastCompletedAt,\n  min(p2.createdAt) AS lastStartedAt\nFROM\n  (\n    SELECT\n      uri,\n      max(updatedAt) AS lastUpdatedAt,\n      max(completedAt) AS lastCompletedAt\n    FROM\n      Progress\n    WHERE\n      createdAt > :minCreatedAt\n    GROUP BY\n      uri\n  ) AS p1\n  JOIN Progress AS p2\n    ON \n      p2.uri = p1.uri AND \n      p2.createdAt > :minCreatedAt AND\n      (p2.createdAt > ifnull(p1.lastCompletedAt, 0) OR p2.completedAt = lastCompletedAt)\nGROUP BY\n  1,2,3\n"),M=f.compressWhitespace("\nSELECT\n  *\nFROM\n  ProgressMeta\nWHERE\n  id IN (\n    SELECT\n      max(pm.id)\n    FROM\n      ProgressMeta pm\n      JOIN Progress p ON pm.progressId = p.id\n      AND p.createdAt > :minCreatedAt\n    WHERE\n      p.uri = :uri\n      AND p.hostname = :hostname\n    GROUP BY\n      p.uri,\n      pm.name\n  )\n");class P extends b.TimestampedModel{static async vacuum(e=90*u.dayMs){await w.ProgressMeta.dbl.runf((t=>t.whereIn("progressId",(t=>t.table("Progress").select("id").where("createdAt","<=",Date.now()-e))).delete())),await this.dbl.runf((t=>t.where("createdAt","<=",Date.now()-e).delete()))}static async minCreatedAt(){const e=await v.Operation.getFirstPendingOp({name:v.OperationNames.forceRestartSync});return P.logger().tap({msg:"minCreatedAt",level:"info",result:h.orElse(null==e?void 0:e.createdAt,0),meta:{op:e}})}static async times(){const e=await this.minCreatedAt();return this.dbl.all({sql:S,bindings:{minCreatedAt:e}})}static async saveSyncState(e){return m.thenCollect(g.toA(await e.progress()),(t=>("done"===t.state&&null==t.completedAt&&(this.logger().warn("caller saved done sync state without setting completedAt",s.stack()),t.completedAt=Date.now()),null==t.id?this.logger().throw(e.name+" returned an unsaved Progress",t):t.upsert())))}static async insertNew(e,t){return this.ops().insertOne({uri:e,volume:t,pid:r.pid,hostname:n.hostname()})}toSyncState(){return{id:this.id,uri:this.uri,volume:this.volume,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return h.orElse(l.mapNotBlank(this.dekJSON,(()=>o.compactBlanks(JSON.parse(this.dekJSON)))),(()=>[]))}set dek(e){this.dekJSON=c.stringify(o.compactBlanks(e))}assignFromPojo(e){return y.assignFromJSON(this,e)}getThisMeta(){return w.ProgressMeta.ops().allf((e=>e.where({progressId:this.id}).orderBy("createdAt")))}async getMeta(){return w.ProgressMeta.ops().all({sql:M,bindings:{minCreatedAt:await P.minCreatedAt(),uri:this.uri,hostname:this.hostname}})}setMeta(e,t){return w.ProgressMeta.ops().upsertOne({progressId:this.id,name:e,value:t})}async getMetaAsRecord(){return p.fromEntries((await this.getMeta()).map((e=>[e.name,e.value])))}}t.Progress=P,P.tableName="Progress"},33075:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressMeta=t.ProgressMetaNames=void 0;const n=i(84253),r=i(1724);t.ProgressMetaNames=n.strEnum("lastScannedDirectory","scannedDirectoryCount","completedDirectoryScan","enqueuedStaleFiles","processedImageCount","processedVideoCount");class s extends r.TimestampedModel{}t.ProgressMeta=s,s.tableName="ProgressMeta",s.uniqueColumnName="progressId,name"},13222:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.upsertToShaBlockslist=t.isShaBlockslisted=t.isFileBlocklisted=void 0;const n=i(98462),r=i(11944),s=i(11448),a=i(78650),o=i(9069),l=s.lazy((()=>new a.DbRequest(o.modelDb,"ShaBlocklist")));async function u(e){return null!=await l().pluckFirstf((t=>t.where({sha:e}).limit(1)))}t.isFileBlocklisted=async function(e){const t=n.BaseFile.for(e),i=await t.sha();return null==i||u(i)},t.isShaBlockslisted=u,t.upsertToShaBlockslist=function(...e){return r.mapNotEmpty(r.uniq(e),(e=>l().upsert((t=>t.insert(e.map((e=>({sha:e}))))))))}},50725:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tag=void 0;const n=i(13779),r=i(46852),s=i(79015),a=i(51498),o=i(72755),l=i(70283),u=i(43414),c=i(91464),d=i(53719),h=i(11254),p=i(11944),m=i(39938),f=i(88491),g=i(11448),y=i(66776),v=i(75556),w=i(34601),b=i(8199),S=i(26588),M=i(44726),P=i(93667),E=i(17078),T=i(52465),x=i(94719),D=i(18273),C=i(30690),k=i(61331),I=i(94358),F=i(1724);function O(e){return e.orderByRaw("COALESCE(ordinal, _path) COLLATE NOCASE")}s.onClearCache((()=>A.clear()));class A extends F.TimestampedModel{constructor(){super(...arguments),this.urls=g.lazy((()=>new P.TagUrls(this.id))),this.displayPath=g.lazy((async()=>{const e=await this.getParent();return[...null==e?[]:await(null==e?void 0:e.displayPath()),this.displayName]})),this.descendantIds=g.lazy((async()=>A.dbl.pluckAll({sql:M.compressWhitespace("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT id ","FROM descendants","WHERE id <> :tagId"),bindings:{tagId:this.id}})),7*f.secondMs),this.ancestorIds=g.lazy((async()=>0===this.parentId||null==this.parentId?[]:A.dbl.pluckAll({sql:M.compressWhitespace(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT id","FROM Tag","WHERE Tag.id in ancestors","  AND Tag.id <> :tagId","ORDER BY _path DESC"].join(" ")),bindings:{tagId:this.id}})))}static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this.recentTagsByPath.clear(),this.tagById.clear()}static cacheTags(e){return e.map((e=>this.cacheTag(e)))}static cacheTag(e){return null!=e&&this.recentTagsByPath.set(e._path,e),null!=(null==e?void 0:e.id)&&this.tagById.set(e.id,e),e}static newTag(e){const t=new A;t._path=T.joinTagPath(e);const i=e[e.length-1];return null!=i&&w.isObject(i)&&(y.map(i.displayName,(e=>t._displayName=e)),y.map(i.ordinal,(e=>t.ordinal=e)),y.map(i.description,(e=>t.description=e)),y.map(i.releasedAt,(e=>t.releasedAt=e))),t}static findByIdOrPath(e,t){return 0===e?A.root():v.gt0(e)?this.findById(e):this.findByPath(t)}static findById(e){return 0===e?A.root():A.tagById.getOrSetAsync(e,(()=>r.thenMap(this.ops().findById(e),(e=>A.recentTagsByPath.set(e._path,e)))))}static async findByPath(e){const t=T.joinTagPath(e);return m.blank(t)?A.root():A.recentTagsByPath.getOrSetAsync(t,(()=>r.thenMap(this.ops().firstf((e=>e.where("_path","like",t))),(e=>A.tagById.set(e.id,e)))))}static getPagedAssets(e,t){const i=new A;return i.id=e,i.getPagedAssetIds(t)}static async findOrCreate(e){if(p.isEmpty(e))throw new Error("empty tagPath");const t=T.joinTagPath(e,"/"),i=await this.findByPath(e);if(this.logger().debug("_findOrCreate("+t+")",{prior:i}),null!=i)return i;const n=this.newTag(e),r=n.depth<=1?void 0:await this.findOrCreate(e.slice(0,-1));y.map(r,(e=>n.parentId=e.id));const s=A.cacheTag(await this.ops().upsertOne(n));return this.logger().debug("_findOrCreate("+t+") upserted",{newTag:n,result:s,parent:r}),s}clear(){return this.parent=void 0,this.root=void 0,this.children=void 0,this.ancestors=void 0,this.assets=void 0,this.relatedAssets=void 0,this.ancestorIds.unset(),this.descendantIds.unset(),this}siblingPath(e){return T.joinTagPath([...this.parentPath,e])}async changeName(e){return this.changePath(this.siblingPath(e))}maybeUpsertDisplayName(e){return m.blank(e)||e===this._displayName?void 0:this.upsert({_displayName:e})}async changePath(e,t=!0){const i=this._path,n=await A.findByPath(T.splitTagPath(e));this.logger().info("changePath(): ",{priorPath:i,newPath:e,existingSibling:n});try{null==n?(await A.tx((async()=>{await A.dbl.runf((t=>t.where("_path","LIKE",i+"%").update({updatedAt:Date.now(),_path:D.knex().raw("REPLACE(_path, ?, ?)",[i,e])})))})),this._path=e):(e=n._path,this.logger().info("changePath(): replacing with sibling",e),await k.AssetTag.dbl.upsert((e=>e.where({tagId:this.id}).update({tagId:n.id}))),await k.AssetTag.dbl.runf((e=>e.where({tagId:this.id}).delete())),await S.thenCollect(this.getChildren(),(e=>e.changePath(T.joinTagPath([...n.path,e.name]),!1))),await A.dbl.runf((e=>e.where({parentId:this.id}).update({parentId:n.id}))),await this.delete())}finally{t&&A.clear()}}get name(){const e=this.path;return e[e.length-1]}get path(){return T.splitTagPath(this._path)}get displayName(){return m.notBlank(this._displayName)?this._displayName:this.name}get isRoot(){return 0===this.id}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}get sortBy(){return[null==this.ordinal?2**51:this.ordinal,this.path.map((e=>e.toLowerCase()))]}$childrenQuery(){return O(A.query().where({parentId:this.id}))}$assetsQuery(){return C.Asset.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],y.map(this.parent,(t=>t.setAncestors(e.slice(0,-1))))}async toApiPathElements(){return S.thenCollect(this.getAncestorsAndSelf(),(e=>({tagPath:e.path,displayName:e.displayName})))}async toApiTag(){return{tagId:this.id,tagPath:this.path,displayPath:await this.displayPath(),description:this.description,assetCount:this.assetCount,assetFileCount:this.assetFileCount}}toStringId(){return"Tag("+this.path.join("/")+")"}async getParent(){if(!this.isRoot)return null!=this.parentId&&null==this.parent?this.parent=await A.findById(this.parentId):this.parent}async getPagedChildren(e){if(0===this.id){const t=y.orElse(e.offset,0),i=t+y.orElse(e.limit,this.children.length);return[...this.children].slice(t,i)}const t=this.$childrenQuery();l.mapGt0(e.offset,(e=>{t.offset(e)})),l.mapGt0(e.limit,(e=>{t.limit(e)}));const i=await A.ops().all(t);for(const e of i)A.cacheTag(e);return i}async getDescendants(){return A.ops().all({sql:M.compressWhitespace("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN descendants","  AND Tag.id <> :tagId"),bindings:{tagId:this.id}})}async getChildrenCount(){return null!=this.children?this.children.length:A.dbl.pluckFirstf((e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count()))}async getChildren(){return this.children=await A.ops().all(this.$childrenQuery()),this.children.forEach((e=>{e.parent=this})),this.children}link(){return"/tag/"+this.path.map(encodeURIComponent).join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}async getAncestors(){if(null==this.ancestors){const e=n.ancestry(this.parentPath).map((e=>T.joinTagPath(e))),t=await Promise.all(e.map((e=>A.recentTagsByPath.get(e))));if(t.every((e=>null!=e)))return this.ancestors=t;const i=A.query().whereIn("_path",e).orderBy("_path");this.ancestors=await A.ops().all(i),A.cacheTags(this.ancestors),this.parent=y.orElse(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}async getAncestorsAndSelf(){return[...await this.getAncestors(),this]}async _getAncestors(){return 0===this.parentId||null==this.parentId?[]:A.ops().all({sql:M.compressWhitespace(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN ancestors","  AND Tag.id <> :tagId","ORDER BY Tag._path DESC"].join(" ")),bindings:{tagId:this.id}})}getPagedAssetIds(e){let t=this.$assetsQuery().select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal"),i="desc";return l.mapGte0(e.capturedAtLt,(e=>{t=t.where("capturedAtLocal","<",e)})),l.mapGte0(e.capturedAtGt,(e=>{t=t.where("capturedAtLocal",">",e),i="asc"})),l.mapGte0(e.limit,(e=>{t=t.limit(e)})),t=t.orderBy("capturedAtLocal",i),C.Asset.dbl.all(t)}getAssets(){const e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return C.Asset.ops().all(e)}async assetCountDesc(e){const t=this.assetCount;return(null==t||null==e||e.length===t||0===e.length?"":E.fmt(e.length)+" of ")+E.plur(t,"asset")}$assetStreamQuery(e,t,i){let n=this.path[0]===h.TagRoots.When?C.Asset.shownUnhidden():this.$assetsQuery();return n=n.distinct().where("capturedAtLocal",i,e.capturedAtLocal).andWhereNot("Asset.id",e.id).limit("="===i?2*t:t),"="===i?n.orderByRaw(`ABS(Asset.id-${e.id})`):n.orderBy([{column:"capturedAtLocal",order:">"===i?"asc":"desc"},"Asset.id"])}async getAssetStream(e,t){t=v.gt0(t)?t:h.BeforeAfterStreamLimit;const[i,n,r]=await S.thenCollect(["<","=",">"],(i=>C.Asset.ops().all(this.$assetStreamQuery(e,t,i))));for(const t of n)t.id<e.id?i.push(t):r.push(t);return new I.TaggedAssetStream([this],i,r.reverse(),t)}async getRelatedAssetIds(e,t=h.ThumbsPerSample){const i=Math.max(256,await _()),n=await k.AssetTag.dbl.allf((n=>n.select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal").distinct().join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).andWhere("Asset.excluded",0).andWhere("Asset.hidden",0).orderByRaw(o.prngOrderByClause(e+y.orElse(this.id,0),"Asset.id",i)).limit(t)));return this.logger().debug(this.path+": Found "+n.length+" related assets",n),n}get attrs(){return{href:this.link(),title:this.name}}}t.Tag=A,A.tableName="Tag",A.uniqueColumnName="_path",A.recentTagsByPath=new a.FifoCacheAsync({maxSize:256,timeoutMs:d.ShortCmdTimeoutMs}),A.tagById=new a.FifoCacheAsync({maxSize:256,timeoutMs:d.ShortCmdTimeoutMs}),A.cmp=(e,t)=>b.cmp([y.orElse(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[y.orElse(t.ordinal,Number.MAX_SAFE_INTEGER),...t.path]),A.root=g.lazy((async()=>{const e=new A;return e.id=0,e._path=x.TagSep,e.parentId=void 0,e.children=(await A.roots()).filter((e=>!c.hasAnyIgnoreCase(u.Settings.hiddenHomeTags.valueOrDefault,e.name))),e.ancestors=[],e.assetCount=await C.Asset.shownCount(),e.upsert=()=>{throw new Error("upsert not supported on root")},e}),7*f.secondMs),A._upsertDefaultRoots=g.lazy((()=>A.ops().upsert(T.Roots.map((e=>({_path:T.joinTagPath([e.name]),ordinal:e.ordinal})))))),A.roots=g.lazy((async()=>{await A._upsertDefaultRoots();const e=await A.ops().all(O(A.query().whereNull("parentId")));return e.forEach((e=>{e.parentId=void 0,e.ancestors=[],A.cacheTag(e)})),e}));const _=g.lazy((()=>C.Asset.dbl.pluckFirstf((e=>e.count()))),f.minuteMs)},21250:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagFts=void 0;const n=i(26588),r=i(75179),s=i(21693),a=i(7907),o=i(50725);class l extends a.Model{static insertFts(e){if(null!=e.parentId)return this.dbl.runf((t=>t.insert({rowid:e.id,root:s.tag_fts_root(e._path),path:s.tag_fts_path(e._path)})))}static rebuild(){return r.tx(this.db(),(()=>this._rebuild_()))}static async _rebuild_(){const e=l.tableName;await this.dbl.runScript([`INSERT INTO ${e}(${e}) VALUES('delete-all')`]),await o.Tag.ops().batched({qb:e=>e,onResults:e=>n.thenCollect(e,(e=>this.insertFts(e)))})}}t.TagFts=l,l.tableName="tag_fts",l.uniqueColumnName="rowid",l.booleanFields=[]},94358:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.coalesceStreams=t.TaggedAssetStream=t.cmpAssetDesc=t.cmpAssetAsc=void 0;const n=i(13779),r=i(7162),s=i(43414),a=i(11944),o=i(75556),l=i(8199),u=i(26588),c=i(39784);function d(e){return{id:e.id,at:e.capturedAtLocal}}t.cmpAssetAsc=(e,t)=>l.cmp([e.capturedAtLocal,e.id],[t.capturedAtLocal,t.id]),t.cmpAssetDesc=(e,t)=>l.cmp([t.capturedAtLocal,t.id],[e.capturedAtLocal,e.id]),t.TaggedAssetStream=class{constructor(e,t,i,n){this.tags=e,this.before=t,this.after=i,this.limit=n,this.logger=()=>r.mkLogger("TaggedAssetStream("+this.toString()+")"),this.logger().info("new",this.toJSON())}vacuum(){a.sortByInPlace(this.before,(e=>[-e.capturedAtLocal,-e.id])),n.retainFirstN(this.before,this.limit),a.sortByInPlace(this.after,(e=>[-e.capturedAtLocal,-e.id])),n.retainLastN(this.after,this.limit)}toString(){return this.tags.map((e=>e.path.join("/"))).join(",")}valueOf(){return this.toString()}get length(){return c.toA(this.before).length+c.toA(this.after).length}leftPad(e){return[...o.times(this.limit-e.length,(e=>({id:-(e+1),v:0}))),...e]}rightPad(e){return[...e,...o.times(this.limit-e.length,(e=>({id:-(e+this.limit+1),v:0})))]}toJSON(){return{tags:this.tags.map((e=>e.toString())),assetIdsAfter:this.after.map(d),assetIdsBefore:this.before.map(d)}}mergeWith(e){a.pushUniqBy(this.tags,e.tags,(e=>e.path)),a.pushUniqBy(this.before,e.before,(e=>e.id)),a.pushUniqBy(this.after,e.after,(e=>e.id)),this.logger().debug("mergeWith() complete",{tas:e.toJSON(),tags:this.tags.map((e=>e.path)),beforeIds:this.before.map(d),afterIds:this.after.map(d)})}async toApi(){return this.vacuum(),this.logger().tap({msg:"toApi()",result:{tags:await u.thenCollect(this.tags,(e=>e.toApiTag())),assetIdsAfter:this.leftPad(this.after.map((e=>e.toID()))),assetIdsBefore:this.rightPad(this.before.map((e=>e.toID())))}})}streamCoeff(e){return this.logger().tap({msg:"streamCoeff",meta:{this:this.tags.map((e=>e.path)),tas:e.tags.map((e=>e.path))},result:n.diceCoeff([...this.before,...this.after],[...e.before,...e.after],(e=>e.id))})}},t.coalesceStreams=function(e){const t=s.Settings.minStreamCorrPct.valueOrDefault/100,i=[],r=e.filter((e=>e.length>5));for(const e of r){const r=n.greatestBy(i,(i=>o.gtOrElse(i.streamCoeff(e),t)));null==r?i.push(e):r.mergeWith(e)}return i}},1724:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toID=t.TimestampedModel=void 0;const n=i(70283),r=i(11944),s=i(66776),a=i(75556),o=i(39784),l=i(7907);class u extends l.Model{static touch(e){return r.mapNotEmpty(o.toA(e).filter(a.gt0),(e=>this.dbl.runf((t=>t.whereIn("id",e).update("updatedAt",Date.now())))))}toID(){return"updateCount"in this&&(this.updateCount=n.mapGt0Or(this.updateCount,(e=>e),1)),c(this)}get createdAtDate(){return n.mapGt0(this.createdAt,(e=>new Date(e)))}get updatedAtDate(){return n.mapGt0(this.updatedAt,(e=>new Date(e)))}$beforeUpsert(){if(null==this.createdAt&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this){const e=this;e.updateCount=n.mapGt0Or(e.updateCount,(e=>e+1),1)}}}function c(e){return s.map(e,(e=>({id:e.id,v:a.numericOr(e.updateCount,0)})))}t.TimestampedModel=u,t.toID=c},93850:function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.rpcClientEnd=t.rpcClientReady=t.rpcClient=void 0;const r=n(i(11631)),s=i(36079),a=i(13317),o=i(7162),l=i(60326),u=i(55568),c=i(43414),d=i(39938),h=i(88491),p=i(6314),m=i(11448),f=i(66776),g=o.mkLogger("RpcClient");t.rpcClient=m.lazy((()=>{if(u.isRpcServer())return;const e=c.Settings.rpcPort.valueOrDefault;g.debug("Creating new RPC client to "+e);const i=new l.Client("db@localhost:"+e,(()=>function(e){const t=new p.Latch,i=new r.default.Socket;return i.on("error",(e=>t.reject(e))),i.connect(e,"localhost",(()=>{g.debug("Connected to "+e),t.resolve()})),t.then((()=>i))}(e)));return i.addChangeListener((()=>t.rpcClientReady.unset())),i})),t.rpcClientReady=m.lazy((async()=>{try{if(u.isRpcServer())return!1;const e=await a.thenOrTimeout(f.map(t.rpcClient(),(e=>e.ping())),h.secondMs);return d.notBlank(e)}catch(e){return g.warn("rpcClientReady(): ping failed",e),!1}}),h.minuteMs),t.rpcClientEnd=function(){return s.end(t.rpcClient.clear())}},71002:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rpcServer=void 0;const n=i(7162),r=i(97024),s=i(55568),a=i(43414),o=i(11448),l=i(42104),u=o.lazy((()=>n.mkLogger("RpcServer")));t.rpcServer=o.lazy((async()=>{if(!await s.isRpcServer())return;u().info("Setting up RPC...");const e=a.Settings.rpcPort.valueOrDefault,t=new r.Server(e,!0);return t.addSimpleHandlers(l.RpcServiceHandlers()),await t.start(),u().info("RPC service serving port "+t.port),t}))},42104:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RpcServiceHandlers=void 0;const n=i(7162),r=i(43414),s=i(32421),a=i(46573),o=i(29916),l=i(11448),u=i(57527),c=i(23297),d=l.lazy((()=>n.mkLogger("RpcServiceHandlers")));t.RpcServiceHandlers=l.lazy((()=>({libraryPath:()=>r.Settings.libraryPath.value,healthChecks:()=>c.libraryHealthChecks(),isVacuuming:()=>d().tap({msg:"isVacuuming",result:u.isVacuuming()}),mountpoints:()=>s.mountpoints(),volumes:()=>a.volumes(),paused:()=>o.isPaused()})))},36376:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupVolumeRpc=void 0;const n=i(55568),r=i(32421),s=i(46573),a=i(11448),o=i(66776),l=i(93850);t.setupVolumeRpc=a.lazy((()=>{r.setRpcMountpointsImpl(n.isRpcClient()?u:void 0),s.setRpcVolumesImpl(n.isRpcClient()?c:void 0)}));const u=async()=>await l.rpcClientReady()?o.map(l.rpcClient(),(e=>e.request("mountpoints"))):void 0,c=async()=>await l.rpcClientReady()?o.map(l.rpcClient(),(e=>e.request("volumes"))):void 0},81520:(e,t)=>{"use strict";let i;Object.defineProperty(t,"__esModule",{value:!0}),t.setStatsDb=t.statsDb=void 0,t.statsDb=function(){return i},t.setStatsDb=function(e){i=e}},89749:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.statsDbJanitor=void 0;const n=i(36079),r=i(28807),s=i(19658),a=i(55568),o=i(88491),l=i(18130),u=i(81520);t.statsDbJanitor=async function(e){const t=new l.Db("stats",e);return a.isStatsDbMigrator()&&(await t.migrate(),new r.EndableInterval({name:"statsDbJanitor vacuum",callback:()=>t.vacuum(),intervalMs:s.isTest?20*o.secondMs:5*o.minuteMs,rank:n.EndableRanks.service})),u.setStatsDb(t),t}},97840:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileRepository=t.directoryForDate=void 0;const n=i(52132),r=i(79015),s=i(45161),a=i(69060),o=i(7162),l=i(43414),u=i(44546),c=i(11944),d=i(66776);function h(e){return e.toDateTime().toFormat(l.Settings.assetSubdirectoryDatestampFormat.valueOrDefault).split("/")}t.directoryForDate=h,t.AssetFileRepository=class{constructor(e,t){this.root=e,this.copyAssets=t,this.logger=o.mkLogger("AssetFileRepository")}directoryForDate(e){return this.root.join(...h(e))}async importFile(e){const t=this.copyAssets();if(this.logger.debug("importFile()",{file:e,copyAssets:t}),!t||await a.l())return e;if(await e.isDescendantOf(this.root))return this.logger.debug("no-op: "+e+" already contained by "+this.root),e;this.logger.debug("importing "+e);const i=await u.readTags(e);if(null==i)throw new Error(e.nativePath+" has no tags (so, no createdAt)");const r=d.map(i.capturedAt,(e=>s.toFuzzyDate(e.date)));if(null==r)throw new Error(e.nativePath+" has no capturedAt");if(null==r.year||null==r.month||null==r.day)return this.logger.warn("Insufficient capturedAt precision to copy "+e+" into library.",{capturedAt:i.capturedAt}),e;const o=this.directoryForDate(r);if(null==await o.mkdirp())throw new Error("Cannot create destination directory, "+o.nativePath+" for "+e.nativePath);const l=await o.children(),c=await e.size(),h=await n.filter(l,(e=>e.size().then((e=>e===c)))),p=await e.sha();if(h.length>0){const t=await n.filter(h,(e=>e.sha().then((e=>e===p))));if(t.length>0){const i=t[0];return this.logger.info(e+" matches "+i),this.handleSidecars(e,i)}}const m=await o.join(e.base).ensureNew_();return this.logger.info("Copying...",{src:e.nativePath,dest:m.nativePath}),await e.copyFile_(m),this.handleSidecars(e,m)}async handleSidecars(e,t){const i=d.orElse(await e.sidecars(),[]);for(const e of i)await this.handleSidecar(e,t);return c.isNotEmpty(i)&&r.emitFileChanged(t.nativePath),t}async handleSidecar(e,t){for(const i of d.orElse(await t.sidecars(),[]))if(await u.sidecarEql(e,i))return void this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:i,dest:t});const i=await t.parent().join(t.name+e.ext).ensureNew_({emptyIsNew:!0});return e.copyFile_(i)}}},21693:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tag_fts_path=t.tag_fts_root=void 0;const n=i(82798),r=i(94719);t.tag_fts_root=function(e){const t=n.toS(e).indexOf(r.TagSep);return-1===t?"":e.substring(0,t)},t.tag_fts_path=function(e){return n.toS(e).split(r.TagSep).filter((e=>null!=e&&""!==e.trim())).join(" ")}},94719:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagSep=void 0,t.TagSep=String.fromCharCode(31)},63216:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateTagMountpoints=t.updateTagCountSql=t.runTagMaintenance=void 0;const n=i(7383),r=i(70403),s=i(7162),a=i(19658),o=i(43414),l=i(91464),u=i(26682),c=i(46573),d=i(11254),h=i(11944),p=i(39938),m=i(88491),f=i(24603),g=i(11448),y=i(75556),v=i(23175),w=i(52465),b=i(78650),S=i(18273),M=i(66056),P=i(89452),E=i(9069),T=i(50725),x=i(21250),D=g.lazy((()=>s.mkLogger("TagSql")));let C;const k=g.lazy((()=>new b.DbRequest(E.modelDb,"Tag")));function I(e=v.randomChars(6)){const t=`temp.ct_${e}`,i=`temp.taf_${e}`,n=`temp.tag_counts_${e}`;return M.prepQueries(`\nCREATE TABLE ${t} AS\nSELECT\n  DISTINCT t.id AS parentId,\n  kid.id AS childId\nFROM\n  Tag t\n  JOIN Tag kid ON kid._path LIKE (t._path || '%');\n\nCREATE INDEX ${t}_idx ON ${t.replace(/^temp\./,"")}(parentId, childId);\n\nCREATE TABLE ${i} AS\nSELECT\n  DISTINCT AssetTag.tagId as tagId,\n  Asset.id AS assetId,\n  AssetFile.id AS assetFileId\nFROM\n  AssetTag\n  JOIN Asset ON AssetTag.assetId = Asset.id\n  JOIN AssetFile ON AssetFile.assetId = Asset.id\nWHERE\n  Asset.hidden = 0\n  AND Asset.excluded = 0\n  AND Asset.shown = 1;\n\nCREATE INDEX ${i}_idx ON ${i.replace(/^temp\./,"")}(tagId, assetId, assetFileId);\n\nCREATE TABLE ${n} AS\nSELECT\n  parentId AS tagId,\n  count(DISTINCT assetId) AS ac,\n  count(DISTINCT assetFileId) AS afc\nFROM\n  ${t}\n  JOIN ${i} ON childId = tagId\nGROUP BY\n  1;\n\nCREATE INDEX ${n}_idx ON ${n.replace(/^temp\./,"")}(tagId, ac, afc);\n\n-- Update used tags:\n\nUPDATE Tag SET \n  assetCount = NULL,\n  assetFileCount = NULL;\n\nUPDATE Tag\nSET\n  assetCount = ac,\n  assetFileCount = afc\nFROM ${n}\nWHERE tagId = id;\n\n-- Clean up:\n\nDROP INDEX IF EXISTS ${t}_idx;\nDROP INDEX IF EXISTS ${i}_idx;\nDROP INDEX IF EXISTS ${n}_idx;\nDROP TABLE ${t};\nDROP TABLE ${i};\nDROP TABLE ${n};\n`)}async function F(e){const t=await T.Tag.dbl.pluckAllf((t=>t.select("Tag.id").leftOuterJoin("AssetTag","AssetTag.tagId","Tag.id").leftOuterJoin(S.knex().raw("Tag AS child ON child.parentId = Tag.id")).whereNull("AssetTag.assetId").andWhere((e=>e.whereNull("child.id"))).andWhere((e=>e.whereNull("Tag.assetCount"))).andWhere("Tag.createdAt","<",e).orderBy("Tag._path","asc")));D().debug("vacuumLeafTags()",{candidates:t});for(const e of t)try{await T.Tag.dbl.runf((t=>t.where({id:e}).delete()))}catch(t){D().info("vacuumLeafTags(): failed to delete",{tagId:e,err:t})}return D().info("vacuumLeafTags() complete.",{candidates:t}),t}async function O(){const e=s.mkLogger("updateTagMountpoints()"),t=await T.Tag.findByPath([d.TagRoots.fs]);if(null==t)return void e.info("No root filesystem tag");await t.maybeUpsertDisplayName(o.Settings.tagDisplayNameFS.valueOrDefault);const i=await c.volumes();if(null!=i)for(const n of await t.getChildren()){if(n.name===w.Library){1!==n.ordinal&&await n.upsert({ordinal:1});continue}let t;const r=i.find((e=>p.notBlank(e.uuid)&&u.volsha(e.uuid)===n.name));t=null!=r?p.notBlankOr(r.label,l.stripPrefix(r.mountpoint,"/")):await P.AssetFile.dbl.pluckFirstf((e=>e.select("mountpoint").where("uri","LIKE","psfile://"+n.name+"/%").limit(1))),null!=t?(await n.maybeUpsertDisplayName(t),e.info("updated tag",{id:n.id,path:n.path,displayName:t}),T.Tag.clear()):e.debug("cannot update tag: no current volume.",{id:n.id,path:n.path})}else e.warn("no-op: volumes() returned null")}t.runTagMaintenance=g.lazy((async()=>{if(a.isProd&&Date.now()-a.start<20*m.secondMs)return;await O();const e=await k().pluckFirst({sql:"SELECT MAX(rowid) FROM AssetTag"});D().info("updateTagCounts()",{newMax:e,lastMax:C}),e!==C&&(C=e,await n.time("db.updateTagCounts",(()=>async function(){null==k().db()&&D().throw("updateTagCounts(): modelDb is unset",{retriable:!1});try{const e=v.randomChars(6),i="_"+e,n=await r.thenElapsed(k().runScript(I(e),i)),s=y.clamp(7*m.secondMs,5*m.minuteMs,20*n.elapsedMs);D().info("Updated tag counts",{elapsedMs:n.elapsedMs,newTTL:s}),t.runTagMaintenance.setTTL(s),await async function(e=Date.now()-10*m.minuteMs){let t=[-1];for(const i of h.range(0,5)){const i=await F(e);if(h.isEmpty(i)||f.eql(t,i))return;t=i}}()}catch(e){D().warn("Failed to update tag counts",e)}}())),await n.time("db.rebuildTagFts",(()=>x.TagFts.rebuild())))}),7*m.secondMs),t.updateTagCountSql=I,t.updateTagMountpoints=O},33815:e=>{"use strict";e.exports=require("@iarna/toml")},15409:e=>{"use strict";e.exports=require("@sentry/node")},16098:e=>{"use strict";e.exports=require("@sentry/types")},42357:e=>{"use strict";e.exports=require("assert")},17324:e=>{"use strict";e.exports=require("batch-cluster")},23730:e=>{"use strict";e.exports=require("better-sqlite3")},63129:e=>{"use strict";e.exports=require("child_process")},70647:e=>{"use strict";e.exports=require("commander")},76417:e=>{"use strict";e.exports=require("crypto")},17764:e=>{"use strict";e.exports=require("deep-eql")},40881:e=>{"use strict";e.exports=require("dns")},28614:e=>{"use strict";e.exports=require("events")},55883:e=>{"use strict";e.exports=require("exiftool-vendored")},9796:e=>{"use strict";e.exports=require("file-type")},35747:e=>{"use strict";e.exports=require("fs")},64298:e=>{"use strict";e.exports=require("fs-extra")},69225:e=>{"use strict";e.exports=require("fs/promises")},62684:e=>{"use strict";e.exports=require("he")},98605:e=>{"use strict";e.exports=require("http")},57211:e=>{"use strict";e.exports=require("https")},85717:e=>{"use strict";e.exports=require("knex")},8223:e=>{"use strict";e.exports=require("luxon")},11631:e=>{"use strict";e.exports=require("net")},12087:e=>{"use strict";e.exports=require("os")},85622:e=>{"use strict";e.exports=require("path")},61765:e=>{"use strict";e.exports=require("process")},94213:e=>{"use strict";e.exports=require("punycode")},742:e=>{"use strict";e.exports=require("sharp")},77748:e=>{"use strict";e.exports=require("source-map-support")},92413:e=>{"use strict";e.exports=require("stream")},78213:e=>{"use strict";e.exports=require("timers")},31669:e=>{"use strict";e.exports=require("util")},78761:e=>{"use strict";e.exports=require("zlib")}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var n={};("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"1.0.0-alpha.3+20210411105726"},(()=>{"use strict";var e=n;Object.defineProperty(e,"__esModule",{value:!0});try{i(77748).install()}catch{}const t=i(37980),r=i(52021),s=i(44),a=i(51731),o=i(38381),l=i(57567);!async function(){await new t.CLI("main").add(r.CommonArgs,a.ExposeArg,o.PauseSyncArg,s.DaemonArgs).parse(),new l.MainService}()})(),module.exports=n})();
//# sourceMappingURL=main.js.map