#!/usr/bin/env node
/* Copyright Â© 2021, PhotoStructure Inc. */
/* By using this software, you accept the terms in <https://photostructure.com/eula>. */
/* If you don't accept them, do not use this software. */
var UL=Object.create,Pp=Object.defineProperty,WL=Object.getPrototypeOf,Xy=Object.prototype.hasOwnProperty,qL=Object.getOwnPropertyNames,jL=Object.getOwnPropertyDescriptor,Zy=Object.getOwnPropertySymbols,HL=Object.prototype.propertyIsEnumerable;var b=Object.assign,GL=t=>Pp(t,"__esModule",{value:!0});var jr=(t,e)=>{var r={};for(var i in t)Xy.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(t!=null&&Zy)for(var i of Zy(t))e.indexOf(i)<0&&HL.call(t,i)&&(r[i]=t[i]);return r},$=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports);var KL=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of qL(e))!Xy.call(t,i)&&i!=="default"&&Pp(t,i,{get:()=>e[i],enumerable:!(r=jL(e,i))||r.enumerable});return t},v=t=>KL(GL(Pp(t!=null?UL(WL(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var vi=$((Rde,gn)=>{var e_={PasetoNotSupported:"ERR_PASETO_NOT_SUPPORTED",PasetoDecryptionFailed:"ERR_PASETO_DECRYPTION_FAILED",PasetoInvalid:"ERR_PASETO_INVALID",PasetoVerificationFailed:"ERR_PASETO_VERIFICATION_FAILED",PasetoClaimInvalid:"ERR_PASETO_CLAIM_INVALID",PasetoWorkerFailure:"ERR_PASETO_WORKER_FAILURE"},yn=class extends Error{constructor(e){super(e);this.name=this.constructor.name,this.code=e_[this.constructor.name],Error.captureStackTrace(this,this.constructor)}};gn.exports.PasetoError=yn;gn.exports.PasetoNotSupported=class extends yn{};gn.exports.PasetoDecryptionFailed=class extends yn{};gn.exports.PasetoInvalid=class extends yn{};gn.exports.PasetoVerificationFailed=class extends yn{};gn.exports.PasetoClaimInvalid=class extends yn{};gn.exports.PasetoWorkerFailure=class extends yn{}});var Rf=$((_de,IP)=>{IP.exports=t=>!!t&&t.constructor===Object});var _f=$((Nde,OP)=>{var t_=Rf();OP.exports=function(e){if(typeof e=="undefined")return Buffer.from("");if(Buffer.isBuffer(e))return e;if(t_(e))return Buffer.from(JSON.stringify(e),"utf8");if(typeof e!="string")throw new TypeError("options.footer must be a string, Buffer, or a plain object");return Buffer.from(e,"utf8")}});var lg=$((Bde,kP)=>{var RP=1e3,_P=RP*60,NP=_P*60,ag=NP*24,r_=ag*7,i_=ag*365.25,o_=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;kP.exports=t=>{let e=o_.exec(t);if(!e)throw new TypeError(`invalid time period format ("${t}")`);let r=parseFloat(e[1]);switch(e[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r*RP);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(r*_P);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(r*NP);case"day":case"days":case"d":return Math.round(r*ag);case"week":case"weeks":case"w":return Math.round(r*r_);case"year":case"years":case"yr":case"yrs":case"y":return Math.round(r*i_)}}});var VP=$((Cde,BP)=>{var CP=lg();BP.exports=({audience:t,expiresIn:e,iat:r=!0,issuer:i,jti:o,kid:n,notBefore:s,now:a=new Date,subject:m},c)=>{if(!(a instanceof Date)||!a.getTime())throw new TypeError("options.now must be a valid Date object");let d=a.getTime();if(r!==void 0){if(typeof r!="boolean")throw new TypeError("options.iat must be a boolean");r&&(c.iat=new Date(d))}if(e!==void 0){if(typeof e!="string")throw new TypeError("options.expiresIn must be a string");c.exp=new Date(d+CP(e))}if(s!==void 0){if(typeof s!="string")throw new TypeError("options.notBefore must be a string");c.nbf=new Date(d+CP(s))}if(t!==void 0){if(typeof t!="string")throw new TypeError("options.audience must be a string");c.aud=t}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.issuer must be a string");c.iss=i}if(m!==void 0){if(typeof m!="string")throw new TypeError("options.subject must be a string");c.sub=m}if(n!==void 0){if(typeof n!="string")throw new TypeError("options.kid must be a string");c.kid=n}if(o!==void 0){if(typeof o!="string")throw new TypeError("options.jti must be a string");c.jti=o}return c}});var Nf=$((Vde,zP)=>{var n_=VP(),s_=Rf(),a_=t=>JSON.parse(JSON.stringify(t));zP.exports=(t,e)=>{if(Buffer.isBuffer(t)){if(Object.keys(e).length!==0)throw new TypeError("options cannot contain claims when payload is a Buffer");return t}if(!s_(t))throw new TypeError("payload must be a Buffer or a plain object");return t=a_(t),t=n_(e,t),Buffer.from(JSON.stringify(t),"utf-8")}});var WP=$((zde,UP)=>{var{PasetoNotSupported:l_}=vi();UP.exports=t=>{if(!Number.isSafeInteger(t))throw new l_("message is too long for Node.js to safely process");let e=~~(t/4294967295),r=t%4294967295-e,i=Buffer.allocUnsafe(8);return i.writeUInt32LE(e,4),i.writeUInt32LE(r,0),i}});var Bf=$((Ude,qP)=>{var jP=WP();qP.exports=(...t)=>{let e=jP(t.length);for(let r of t){r=Buffer.from(r,"utf8");let i=jP(Buffer.byteLength(r));e=Buffer.concat([e,i,r])}return e}});var vm=$((Wde,mg)=>{var m_=t=>t.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),u_=t=>t.replace(/-/g,"+").replace(/_/g,"/"),c_=t=>m_(t.toString("base64")),f_=t=>Buffer.from(u_(t),"base64");mg.exports.decode=f_;mg.exports.encode=c_});var cg=$((qde,HP)=>{var{encode:ug}=vm();HP.exports=function(e,r,i){return i.length!==0?`${e}${ug(Buffer.concat(r))}.${ug(i)}`:`${e}${ug(Buffer.concat(r))}`}});var JP=$((jde,GP)=>{var{timingSafeEqual:p_}=require("crypto"),KP=(t,e)=>{if(t.length===e)return t;let r=Buffer.alloc(e);return t.copy(r),r},d_=(t,e)=>{let r=Math.max(t.length,e.length);return p_(KP(t,r),KP(e,r))};GP.exports=d_});var Sm=$((Gde,$P)=>{var bs=require("crypto"),h_=require("util"),{PasetoWorkerFailure:Hde}=vi(),QP=Bf(),za;if(bs.hkdf){let t=h_.promisify(bs.hkdf);za=(e,r,i,o)=>t("sha384",e,i,o,r)}else za=(t,e,r,i)=>{let o=bn.hmac("sha384",t,r),n=Buffer.from(i),s=Buffer.from(""),a=Buffer.from(""),m;for(let d=1;Buffer.byteLength(s)<e;++m){m=Buffer.from(String.fromCharCode(d));let w=Buffer.concat([a,n,m]);a=bn.hmac("sha384",w,o),s=Buffer.concat([s,a])}return Buffer.from(s).slice(0,e)};var g_=cg(),y_=JP(),bn={async"aes-256-ctr-hmac-sha-384-encrypt"(t,e,r,i){let o=bn.hmac("sha384",t,i);o=o.slice(0,32),e=Buffer.from(e);let n=o.slice(0,16),[s,a]=await Promise.all([za(r,32,n,"paseto-encryption-key"),za(r,32,n,"paseto-auth-key-for-aead")]),m=bn.encrypt("aes-256-ctr",t,s,o.slice(16)),c=QP("v1.local.",o,m,e),d=bn.hmac("sha384",c,a);return g_("v1.local.",[o,m,d],e)},async"aes-256-ctr-hmac-sha-384-decrypt"(t,e,r){let i=t.slice(0,32),o=t.slice(-48),n=t.slice(32,-48),s=i.slice(0,16),[a,m]=await Promise.all([za(r,32,s,"paseto-encryption-key"),za(r,32,s,"paseto-auth-key-for-aead")]),c=QP("v1.local.",i,n,e),d=bn.hmac("sha384",c,m),w=bn.decrypt("aes-256-ctr",n,a,i.slice(16));return!y_(o,d)||!w?!1:w},hmac(t,e,r){let i=bs.createHmac(t,r);return i.update(e),i.digest()},verify(t,e,r,i){return bs.verify(t,e,r,i)},sign(t,e,r){return bs.sign(t,e,r)},encrypt(t,e,r,i){let o=bs.createCipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])},decrypt(t,e,r,i){let o=bs.createDecipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])}};$P.exports=bn});var fg=$((Kde,YP)=>{var{sign:b_}=Sm(),w_=Bf(),x_=cg();YP.exports=async function(e,r,i,o,n,s){let a=w_(e,r,i),m=await b_(o,a,n);if(m.length!==s)throw new TypeError(`invalid ${e.slice(0,-1)} signing key bit length`);return x_(e,[r,m],i)}});var ZP=$((Jde,XP)=>{var{constants:{RSA_PKCS1_PSS_PADDING:T_,RSA_PSS_SALTLEN_DIGEST:v_},createPrivateKey:S_,KeyObject:M_}=require("crypto"),P_=_f(),E_=Nf(),D_=fg();function A_(t){if(t instanceof M_||(t=S_(t)),t.type!=="private"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public signing key must be a private RSA key");return t}XP.exports=async function(e,r,n={}){var{footer:i}=n,o=jr(n,["footer"]);let s=E_(e,o),a=P_(i);return r=A_(r),D_("v1.public.",s,a,"sha384",{key:r,padding:T_,saltLength:v_},256)}});var Cf=$(($de,eE)=>{var{PasetoClaimInvalid:Gt}=vi(),tE=lg();eE.exports=({ignoreExp:t,ignoreNbf:e,ignoreIat:r,maxTokenAge:i,subject:o,issuer:n,clockTolerance:s,audience:a,now:m=new Date},c)=>{if(!(m instanceof Date)||!m.getTime())throw new TypeError("options.now must be a valid Date object");let d=m.getTime();if("iss"in c&&typeof c.iss!="string")throw new Gt("payload.iss must be a string");if(n!==void 0){if(typeof n!="string")throw new TypeError("options.issuer must be a string");if(c.iss!==n)throw new Gt("issuer mismatch")}if("sub"in c&&typeof c.sub!="string")throw new Gt("payload.sub must be a string");if(o!==void 0){if(typeof o!="string")throw new TypeError("options.subject must be a string");if(c.sub!==o)throw new Gt("subject mismatch")}if("aud"in c&&typeof c.aud!="string")throw new Gt("payload.aud must be a string");if(a!==void 0){if(typeof a!="string")throw new TypeError("options.audience must be a string");if(c.aud!==a)throw new Gt("audience mismatch")}if(s!==void 0&&typeof s!="string")throw new TypeError("options.clockTolerance must be a string");let w=s?tE(s):0,P;if("iat"in c){if(typeof c.iat!="string")throw new Gt("payload.iat must be a string");if(P=new Date(c.iat).getTime(),!P)throw new Gt("payload.iat must be a valid ISO8601 string");if(!r&&P>d+w)throw new Gt("token issued in the future")}if("nbf"in c){if(typeof c.nbf!="string")throw new Gt("payload.nbf must be a string");let A=new Date(c.nbf).getTime();if(!A)throw new Gt("payload.nbf must be a valid ISO8601 string");if(!e&&A>d+w)throw new Gt("token is not active yet")}if("exp"in c){if(typeof c.exp!="string")throw new Gt("payload.exp must be a string");let A=new Date(c.exp).getTime();if(!A)throw new Gt("payload.exp must be a valid ISO8601 string");if(!t&&A<=d-w)throw new Gt("token is expired")}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.maxTokenAge must be a string");if(!("iat"in c))throw new Gt("missing iat claim");if(P+tE(i)<d+w)throw new Gt("maxTokenAge exceeded")}}});var Mm=$((Qde,rE)=>{var{PasetoInvalid:L_}=vi(),{strict:F_}=require("assert"),I_=Rf();rE.exports=t=>{try{let e=JSON.parse(t);return F_(I_(e)),e}catch(e){throw new L_("All PASETO payloads MUST be a JSON object")}}});var dg=$((Yde,iE)=>{var{PasetoInvalid:pg,PasetoVerificationFailed:O_}=vi(),{decode:oE}=vm(),{verify:k_}=Sm(),R_=Bf();iE.exports=async function(e,r,i,o,n){if(typeof r!="string")throw new TypeError("token must be a string");if(r.substr(0,e.length)!==e)throw new pg(`token is not a ${e.slice(0,-1)} token`);let{0:s,1:a,length:m}=r.substr(e.length).split(".");if(m!==1&&m!==2)throw new pg("token value is not a PASETO formatted value");let c,d;try{d=oE(s),c=oE(a||"")}catch(Se){throw new pg("token value is not a PASETO formatted value")}let w=d.slice(0,-o),P=d.slice(-o),A=R_(e,w,c);if(!await k_(i,A,n,P))throw new O_("invalid signature");return{m:w,footer:c.length?c:void 0}}});var sE=$((Xde,nE)=>{var{constants:{RSA_PKCS1_PSS_PADDING:__,RSA_PSS_SALTLEN_DIGEST:N_},createPublicKey:B_,KeyObject:C_}=require("crypto"),V_=Cf(),z_=Mm(),U_=dg();function W_(t){if((!(t instanceof C_)||t.type==="private")&&(t=B_(t)),t.type!=="public"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public verify key must be a public RSA key");return t}nE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=jr(s,["complete","buffer"]);r=W_(r);let{m:a,footer:m}=await U_("v1.public.",e,"sha384",256,{key:r,padding:__,saltLength:N_});if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let c=z_(a);return V_(n,c),i?{payload:c,footer:m,version:"v1",purpose:"public"}:c}});var hg=$((Zde,aE)=>{var{createSecretKey:q_,KeyObject:j_}=require("crypto");aE.exports=function(e,r){if(r instanceof j_||(r=q_(r)),r.type!=="secret"||r.symmetricKeySize!==32)throw new TypeError(`${e} secret key must be 32 bytes long symmetric key`);return r}});var gg=$((ehe,lE)=>{var H_=require("crypto"),{promisify:G_}=require("util"),K_=G_(H_.randomFill);lE.exports=async function(e){let r=Buffer.allocUnsafe(e);return K_(r)}});var uE=$((the,mE)=>{var J_=_f(),$_=hg().bind(void 0,"v1.local"),Q_=Nf(),Y_=gg(),{"aes-256-ctr-hmac-sha-384-encrypt":X_}=Sm();mE.exports=async function(e,r,s={}){var{footer:i,nonce:o}=s,n=jr(s,["footer","nonce"]);let a=Q_(e,n);r=$_(r);let m=J_(i),c=r.export();return(o&&process.env.NODE_ENV!=="test"||!o)&&(o=await Y_(32)),X_(a,m,c,o)}});var dE=$((rhe,cE)=>{var{decode:fE}=vm(),{"aes-256-ctr-hmac-sha-384-decrypt":Z_}=Sm(),{PasetoDecryptionFailed:eN,PasetoInvalid:pE}=vi(),tN=Cf(),rN=hg().bind(void 0,"v1.local"),iN=Mm(),yg="v1.local.";cE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=jr(s,["complete","buffer"]);if(typeof e!="string")throw new TypeError(`token must be a string, got: ${typeof e}`);if(r=rN(r),e.substr(0,yg.length)!==yg)throw new pE("token is not a v1.local PASETO");let{0:a,1:m="",length:c}=e.substr(yg.length).split(".");if(c>2)throw new pE("token value is not a PASETO formatted value");let d=fE(m),w=fE(a),P=r.export(),A=await Z_(w,d,P);if(!A)throw new eN("decryption failed");if(o){if(Object.keys(n).length!==0)throw new TypeError("options cannot contain claims when options.buffer is true");return i?{payload:A,footer:d.length?d:void 0,version:"v2",purpose:"local"}:A}let V=iN(A);return tN(n,V),i?{payload:V,footer:d.length?d:void 0,version:"v1",purpose:"local"}:V}});var yE=$((ihe,hE)=>{var gE=require("crypto"),{promisify:oN}=require("util"),{PasetoNotSupported:nN}=vi(),sN=gg(),aN=oN(gE.generateKeyPair),lN=32,mN=["rsa",{modulusLength:2048}];async function uN(t){switch(t){case"local":return gE.createSecretKey(await sN(lN));case"public":{let{privateKey:e}=await aN(...mN);return e}default:throw new nN("unsupported v1 purpose")}}hE.exports=uN});var wE=$((ohe,bE)=>{var cN=ZP(),fN=sE(),pN=uE(),dN=dE(),hN=yE();bE.exports={sign:cN,verify:fN,encrypt:pN,decrypt:dN,generateKey:hN}});var TE=$((nhe,xE)=>{var{createPrivateKey:gN,KeyObject:yN}=require("crypto"),bN=_f(),wN=Nf(),xN=fg();function TN(t){if(t instanceof yN||(t=gN(t)),t.type!=="private"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public signing key must be a private ed25519 key");return t}xE.exports=async function(e,r,n={}){var{footer:i}=n,o=jr(n,["footer"]);let s=wN(e,o);r=TN(r);let a=bN(i);return xN("v2.public.",s,a,void 0,r,64)}});var SE=$((she,vE)=>{var{createPublicKey:vN,KeyObject:SN}=require("crypto"),MN=Cf(),PN=Mm(),EN=dg();function DN(t){if((!(t instanceof SN)||t.type==="private")&&(t=vN(t)),t.type!=="public"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public verify key must be a public ed25519 key");return t}vE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=jr(s,["complete","buffer"]);r=DN(r);let{m:a,footer:m}=await EN("v2.public.",e,void 0,64,r);if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let c=PN(a);return MN(n,c),i?{payload:c,footer:m,version:"v2",purpose:"public"}:c}});var PE=$((ahe,ME)=>{var AN=require("crypto"),{promisify:LN}=require("util"),{PasetoNotSupported:FN}=vi(),IN=LN(AN.generateKeyPair);async function ON(t){switch(t){case"public":{let{privateKey:e}=await IN("ed25519");return e}default:throw new FN("unsupported v2 purpose")}}ME.exports=ON});var DE=$((lhe,EE)=>{var kN=TE(),RN=SE(),_N=PE();EE.exports={sign:kN,verify:RN,generateKey:_N}});var OE=$((mhe,AE)=>{var{PasetoInvalid:LE,PasetoNotSupported:FE}=vi(),{decode:IE}=vm(),NN=Mm();AE.exports=(t,{parse:e=!0}={})=>{if(typeof t!="string")throw new TypeError("token must be a string");let{0:r,1:i,2:o,3:n,length:s}=t.split(".");if(s!==3&&s!==4)throw new LE("token value is not a PASETO formatted value");if(r!=="v1"&&r!=="v2")throw new FE("unsupported PASETO version");if(i!=="local"&&i!=="public")throw new FE("unsupported PASETO purpose");let a={footer:n?IE(n):void 0,payload:void 0,version:r,purpose:i};if(i==="local")return a;let m=r==="v1"?256:64,c;try{c=IE(o).slice(0,-m)}catch(d){throw new LE("token value is not a PASETO formatted value")}return e?a.payload=NN(c):a.payload=c,a}});var RE=$((uhe,kE)=>{var BN=OE();kE.exports={decode:BN}});var NE=$((che,_E)=>{var CN=vi(),VN=wE(),zN=DE(),{decode:UN}=RE();_E.exports={decode:UN,V1:VN,V2:zN,errors:CN}});var V0=$(fp=>{Object.defineProperty(fp,"__esModule",{value:!0});var TC;(function(t){t[t.None=0]="None",t[t.Error=1]="Error",t[t.Debug=2]="Debug",t[t.Verbose=3]="Verbose"})(TC=fp.LogLevel||(fp.LogLevel={}))});var z0=$(pp=>{Object.defineProperty(pp,"__esModule",{value:!0});var vC;(function(t){t.Ok="ok",t.Exited="exited",t.Crashed="crashed",t.Abnormal="abnormal"})(vC=pp.SessionStatus||(pp.SessionStatus={}))});var W0=$(tl=>{Object.defineProperty(tl,"__esModule",{value:!0});var U0;(function(t){t.Fatal="fatal",t.Error="error",t.Warning="warning",t.Log="log",t.Info="info",t.Debug="debug",t.Critical="critical"})(U0=tl.Severity||(tl.Severity={}));(function(t){function e(r){switch(r){case"debug":return t.Debug;case"info":return t.Info;case"warn":case"warning":return t.Warning;case"error":return t.Error;case"fatal":return t.Fatal;case"critical":return t.Critical;case"log":default:return t.Log}}t.fromString=e})(U0=tl.Severity||(tl.Severity={}))});var j0=$(rl=>{Object.defineProperty(rl,"__esModule",{value:!0});var q0;(function(t){t.Unknown="unknown",t.Skipped="skipped",t.Success="success",t.RateLimit="rate_limit",t.Invalid="invalid",t.Failed="failed"})(q0=rl.Status||(rl.Status={}));(function(t){function e(r){return r>=200&&r<300?t.Success:r===429?t.RateLimit:r>=400&&r<500?t.Invalid:r>=500?t.Failed:t.Unknown}t.fromHttpCode=e})(q0=rl.Status||(rl.Status={}))});var H0=$(dp=>{Object.defineProperty(dp,"__esModule",{value:!0});var SC;(function(t){t.Explicit="explicitly_set",t.Sampler="client_sampler",t.Rate="client_rate",t.Inheritance="inheritance"})(SC=dp.TransactionSamplingMethod||(dp.TransactionSamplingMethod={}))});var G0=$(Ls=>{Object.defineProperty(Ls,"__esModule",{value:!0});var MC=V0();Ls.LogLevel=MC.LogLevel;var PC=z0();Ls.SessionStatus=PC.SessionStatus;var EC=W0();Ls.Severity=EC.Severity;var DC=j0();Ls.Status=DC.Status;var AC=H0();Ls.TransactionSamplingMethod=AC.TransactionSamplingMethod});var lL=$(Fy=>{var aL="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");Fy.encode=function(t){if(0<=t&&t<aL.length)return aL[t];throw new TypeError("Must be between 0 and 63: "+t)};Fy.decode=function(t){var e=65,r=90,i=97,o=122,n=48,s=57,a=43,m=47,c=26,d=52;return e<=t&&t<=r?t-e:i<=t&&t<=o?t-i+c:n<=t&&t<=s?t-n+d:t==a?62:t==m?63:-1}});var ky=$(Iy=>{var mL=lL(),Oy=5,uL=1<<Oy,cL=uL-1,fL=uL;function JC(t){return t<0?(-t<<1)+1:(t<<1)+0}function $C(t){var e=(t&1)==1,r=t>>1;return e?-r:r}Iy.encode=function(e){var r="",i,o=JC(e);do i=o&cL,o>>>=Oy,o>0&&(i|=fL),r+=mL.encode(i);while(o>0);return r};Iy.decode=function(e,r,i){var o=e.length,n=0,s=0,a,m;do{if(r>=o)throw new Error("Expected more digits in base 64 VLQ value.");if(m=mL.decode(e.charCodeAt(r++)),m===-1)throw new Error("Invalid base64 digit: "+e.charAt(r-1));a=!!(m&fL),m&=cL,n=n+(m<<s),s+=Oy}while(a);i.value=$C(n),i.rest=r}});var nl=$(rr=>{function QC(t,e,r){if(e in t)return t[e];if(arguments.length===3)return r;throw new Error('"'+e+'" is a required argument.')}rr.getArg=QC;var pL=/^(?:([\w+\-.]+):)?\/\/(?:(\w+:\w+)@)?([\w.-]*)(?::(\d+))?(.*)$/,YC=/^data:.+\,.+$/;function Xm(t){var e=t.match(pL);return e?{scheme:e[1],auth:e[2],host:e[3],port:e[4],path:e[5]}:null}rr.urlParse=Xm;function il(t){var e="";return t.scheme&&(e+=t.scheme+":"),e+="//",t.auth&&(e+=t.auth+"@"),t.host&&(e+=t.host),t.port&&(e+=":"+t.port),t.path&&(e+=t.path),e}rr.urlGenerate=il;function Ry(t){var e=t,r=Xm(t);if(r){if(!r.path)return t;e=r.path}for(var i=rr.isAbsolute(e),o=e.split(/\/+/),n,s=0,a=o.length-1;a>=0;a--)n=o[a],n==="."?o.splice(a,1):n===".."?s++:s>0&&(n===""?(o.splice(a+1,s),s=0):(o.splice(a,2),s--));return e=o.join("/"),e===""&&(e=i?"/":"."),r?(r.path=e,il(r)):e}rr.normalize=Ry;function dL(t,e){t===""&&(t="."),e===""&&(e=".");var r=Xm(e),i=Xm(t);if(i&&(t=i.path||"/"),r&&!r.scheme)return i&&(r.scheme=i.scheme),il(r);if(r||e.match(YC))return e;if(i&&!i.host&&!i.path)return i.host=e,il(i);var o=e.charAt(0)==="/"?e:Ry(t.replace(/\/+$/,"")+"/"+e);return i?(i.path=o,il(i)):o}rr.join=dL;rr.isAbsolute=function(t){return t.charAt(0)==="/"||pL.test(t)};function XC(t,e){t===""&&(t="."),t=t.replace(/\/$/,"");for(var r=0;e.indexOf(t+"/")!==0;){var i=t.lastIndexOf("/");if(i<0||(t=t.slice(0,i),t.match(/^([^\/]+:\/)?\/*$/)))return e;++r}return Array(r+1).join("../")+e.substr(t.length+1)}rr.relative=XC;var hL=function(){var t=Object.create(null);return!("__proto__"in t)}();function gL(t){return t}function ZC(t){return yL(t)?"$"+t:t}rr.toSetString=hL?gL:ZC;function eV(t){return yL(t)?t.slice(1):t}rr.fromSetString=hL?gL:eV;function yL(t){if(!t)return!1;var e=t.length;if(e<9||t.charCodeAt(e-1)!==95||t.charCodeAt(e-2)!==95||t.charCodeAt(e-3)!==111||t.charCodeAt(e-4)!==116||t.charCodeAt(e-5)!==111||t.charCodeAt(e-6)!==114||t.charCodeAt(e-7)!==112||t.charCodeAt(e-8)!==95||t.charCodeAt(e-9)!==95)return!1;for(var r=e-10;r>=0;r--)if(t.charCodeAt(r)!==36)return!1;return!0}function tV(t,e,r){var i=ol(t.source,e.source);return i!==0||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0||r)||(i=t.generatedColumn-e.generatedColumn,i!==0)||(i=t.generatedLine-e.generatedLine,i!==0)?i:ol(t.name,e.name)}rr.compareByOriginalPositions=tV;function rV(t,e,r){var i=t.generatedLine-e.generatedLine;return i!==0||(i=t.generatedColumn-e.generatedColumn,i!==0||r)||(i=ol(t.source,e.source),i!==0)||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0)?i:ol(t.name,e.name)}rr.compareByGeneratedPositionsDeflated=rV;function ol(t,e){return t===e?0:t===null?1:e===null?-1:t>e?1:-1}function iV(t,e){var r=t.generatedLine-e.generatedLine;return r!==0||(r=t.generatedColumn-e.generatedColumn,r!==0)||(r=ol(t.source,e.source),r!==0)||(r=t.originalLine-e.originalLine,r!==0)||(r=t.originalColumn-e.originalColumn,r!==0)?r:ol(t.name,e.name)}rr.compareByGeneratedPositionsInflated=iV;function oV(t){return JSON.parse(t.replace(/^\)]}'[^\n]*\n/,""))}rr.parseSourceMapInput=oV;function nV(t,e,r){if(e=e||"",t&&(t[t.length-1]!=="/"&&e[0]!=="/"&&(t+="/"),e=t+e),r){var i=Xm(r);if(!i)throw new Error("sourceMapURL could not be parsed");if(i.path){var o=i.path.lastIndexOf("/");o>=0&&(i.path=i.path.substring(0,o+1))}e=dL(il(i),e)}return Ry(e)}rr.computeSourceURL=nV});var By=$(bL=>{var _y=nl(),Ny=Object.prototype.hasOwnProperty,Fs=typeof Map!="undefined";function No(){this._array=[],this._set=Fs?new Map:Object.create(null)}No.fromArray=function(e,r){for(var i=new No,o=0,n=e.length;o<n;o++)i.add(e[o],r);return i};No.prototype.size=function(){return Fs?this._set.size:Object.getOwnPropertyNames(this._set).length};No.prototype.add=function(e,r){var i=Fs?e:_y.toSetString(e),o=Fs?this.has(e):Ny.call(this._set,i),n=this._array.length;(!o||r)&&this._array.push(e),o||(Fs?this._set.set(e,n):this._set[i]=n)};No.prototype.has=function(e){if(Fs)return this._set.has(e);var r=_y.toSetString(e);return Ny.call(this._set,r)};No.prototype.indexOf=function(e){if(Fs){var r=this._set.get(e);if(r>=0)return r}else{var i=_y.toSetString(e);if(Ny.call(this._set,i))return this._set[i]}throw new Error('"'+e+'" is not in the set.')};No.prototype.at=function(e){if(e>=0&&e<this._array.length)return this._array[e];throw new Error("No element indexed by "+e)};No.prototype.toArray=function(){return this._array.slice()};bL.ArraySet=No});var TL=$(wL=>{var xL=nl();function sV(t,e){var r=t.generatedLine,i=e.generatedLine,o=t.generatedColumn,n=e.generatedColumn;return i>r||i==r&&n>=o||xL.compareByGeneratedPositionsInflated(t,e)<=0}function wp(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}wp.prototype.unsortedForEach=function(e,r){this._array.forEach(e,r)};wp.prototype.add=function(e){sV(this._last,e)?(this._last=e,this._array.push(e)):(this._sorted=!1,this._array.push(e))};wp.prototype.toArray=function(){return this._sorted||(this._array.sort(xL.compareByGeneratedPositionsInflated),this._sorted=!0),this._array};wL.MappingList=wp});var Cy=$(vL=>{var Zm=ky(),vt=nl(),xp=By().ArraySet,aV=TL().MappingList;function ui(t){t||(t={}),this._file=vt.getArg(t,"file",null),this._sourceRoot=vt.getArg(t,"sourceRoot",null),this._skipValidation=vt.getArg(t,"skipValidation",!1),this._sources=new xp,this._names=new xp,this._mappings=new aV,this._sourcesContents=null}ui.prototype._version=3;ui.fromSourceMap=function(e){var r=e.sourceRoot,i=new ui({file:e.file,sourceRoot:r});return e.eachMapping(function(o){var n={generated:{line:o.generatedLine,column:o.generatedColumn}};o.source!=null&&(n.source=o.source,r!=null&&(n.source=vt.relative(r,n.source)),n.original={line:o.originalLine,column:o.originalColumn},o.name!=null&&(n.name=o.name)),i.addMapping(n)}),e.sources.forEach(function(o){var n=o;r!==null&&(n=vt.relative(r,o)),i._sources.has(n)||i._sources.add(n);var s=e.sourceContentFor(o);s!=null&&i.setSourceContent(o,s)}),i};ui.prototype.addMapping=function(e){var r=vt.getArg(e,"generated"),i=vt.getArg(e,"original",null),o=vt.getArg(e,"source",null),n=vt.getArg(e,"name",null);this._skipValidation||this._validateMapping(r,i,o,n),o!=null&&(o=String(o),this._sources.has(o)||this._sources.add(o)),n!=null&&(n=String(n),this._names.has(n)||this._names.add(n)),this._mappings.add({generatedLine:r.line,generatedColumn:r.column,originalLine:i!=null&&i.line,originalColumn:i!=null&&i.column,source:o,name:n})};ui.prototype.setSourceContent=function(e,r){var i=e;this._sourceRoot!=null&&(i=vt.relative(this._sourceRoot,i)),r!=null?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[vt.toSetString(i)]=r):this._sourcesContents&&(delete this._sourcesContents[vt.toSetString(i)],Object.keys(this._sourcesContents).length===0&&(this._sourcesContents=null))};ui.prototype.applySourceMap=function(e,r,i){var o=r;if(r==null){if(e.file==null)throw new Error(`SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map's "file" property. Both were omitted.`);o=e.file}var n=this._sourceRoot;n!=null&&(o=vt.relative(n,o));var s=new xp,a=new xp;this._mappings.unsortedForEach(function(m){if(m.source===o&&m.originalLine!=null){var c=e.originalPositionFor({line:m.originalLine,column:m.originalColumn});c.source!=null&&(m.source=c.source,i!=null&&(m.source=vt.join(i,m.source)),n!=null&&(m.source=vt.relative(n,m.source)),m.originalLine=c.line,m.originalColumn=c.column,c.name!=null&&(m.name=c.name))}var d=m.source;d!=null&&!s.has(d)&&s.add(d);var w=m.name;w!=null&&!a.has(w)&&a.add(w)},this),this._sources=s,this._names=a,e.sources.forEach(function(m){var c=e.sourceContentFor(m);c!=null&&(i!=null&&(m=vt.join(i,m)),n!=null&&(m=vt.relative(n,m)),this.setSourceContent(m,c))},this)};ui.prototype._validateMapping=function(e,r,i,o){if(r&&typeof r.line!="number"&&typeof r.column!="number")throw new Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.");if(!(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0&&!r&&!i&&!o)){if(e&&"line"in e&&"column"in e&&r&&"line"in r&&"column"in r&&e.line>0&&e.column>=0&&r.line>0&&r.column>=0&&i)return;throw new Error("Invalid mapping: "+JSON.stringify({generated:e,source:i,original:r,name:o}))}};ui.prototype._serializeMappings=function(){for(var e=0,r=1,i=0,o=0,n=0,s=0,a="",m,c,d,w,P=this._mappings.toArray(),A=0,V=P.length;A<V;A++){if(c=P[A],m="",c.generatedLine!==r)for(e=0;c.generatedLine!==r;)m+=";",r++;else if(A>0){if(!vt.compareByGeneratedPositionsInflated(c,P[A-1]))continue;m+=","}m+=Zm.encode(c.generatedColumn-e),e=c.generatedColumn,c.source!=null&&(w=this._sources.indexOf(c.source),m+=Zm.encode(w-s),s=w,m+=Zm.encode(c.originalLine-1-o),o=c.originalLine-1,m+=Zm.encode(c.originalColumn-i),i=c.originalColumn,c.name!=null&&(d=this._names.indexOf(c.name),m+=Zm.encode(d-n),n=d)),a+=m}return a};ui.prototype._generateSourcesContent=function(e,r){return e.map(function(i){if(!this._sourcesContents)return null;r!=null&&(i=vt.relative(r,i));var o=vt.toSetString(i);return Object.prototype.hasOwnProperty.call(this._sourcesContents,o)?this._sourcesContents[o]:null},this)};ui.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return this._file!=null&&(e.file=this._file),this._sourceRoot!=null&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e};ui.prototype.toString=function(){return JSON.stringify(this.toJSON())};vL.SourceMapGenerator=ui});var SL=$(Is=>{Is.GREATEST_LOWER_BOUND=1;Is.LEAST_UPPER_BOUND=2;function Vy(t,e,r,i,o,n){var s=Math.floor((e-t)/2)+t,a=o(r,i[s],!0);return a===0?s:a>0?e-s>1?Vy(s,e,r,i,o,n):n==Is.LEAST_UPPER_BOUND?e<i.length?e:-1:s:s-t>1?Vy(t,s,r,i,o,n):n==Is.LEAST_UPPER_BOUND?s:t<0?-1:t}Is.search=function(e,r,i,o){if(r.length===0)return-1;var n=Vy(-1,r.length,e,r,i,o||Is.GREATEST_LOWER_BOUND);if(n<0)return-1;for(;n-1>=0&&i(r[n],r[n-1],!0)===0;)--n;return n}});var PL=$(ML=>{function zy(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}function lV(t,e){return Math.round(t+Math.random()*(e-t))}function Uy(t,e,r,i){if(r<i){var o=lV(r,i),n=r-1;zy(t,o,i);for(var s=t[i],a=r;a<i;a++)e(t[a],s)<=0&&(n+=1,zy(t,n,a));zy(t,n+1,a);var m=n+1;Uy(t,e,r,m-1),Uy(t,e,m+1,i)}}ML.quickSort=function(t,e){Uy(t,e,0,t.length-1)}});var DL=$(Tp=>{var z=nl(),Wy=SL(),sl=By().ArraySet,mV=ky(),eu=PL().quickSort;function je(t,e){var r=t;return typeof t=="string"&&(r=z.parseSourceMapInput(t)),r.sections!=null?new Mi(r,e):new Jt(r,e)}je.fromSourceMap=function(t,e){return Jt.fromSourceMap(t,e)};je.prototype._version=3;je.prototype.__generatedMappings=null;Object.defineProperty(je.prototype,"_generatedMappings",{configurable:!0,enumerable:!0,get:function(){return this.__generatedMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__generatedMappings}});je.prototype.__originalMappings=null;Object.defineProperty(je.prototype,"_originalMappings",{configurable:!0,enumerable:!0,get:function(){return this.__originalMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__originalMappings}});je.prototype._charIsMappingSeparator=function(e,r){var i=e.charAt(r);return i===";"||i===","};je.prototype._parseMappings=function(e,r){throw new Error("Subclasses must implement _parseMappings")};je.GENERATED_ORDER=1;je.ORIGINAL_ORDER=2;je.GREATEST_LOWER_BOUND=1;je.LEAST_UPPER_BOUND=2;je.prototype.eachMapping=function(e,r,i){var o=r||null,n=i||je.GENERATED_ORDER,s;switch(n){case je.GENERATED_ORDER:s=this._generatedMappings;break;case je.ORIGINAL_ORDER:s=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var a=this.sourceRoot;s.map(function(m){var c=m.source===null?null:this._sources.at(m.source);return c=z.computeSourceURL(a,c,this._sourceMapURL),{source:c,generatedLine:m.generatedLine,generatedColumn:m.generatedColumn,originalLine:m.originalLine,originalColumn:m.originalColumn,name:m.name===null?null:this._names.at(m.name)}},this).forEach(e,o)};je.prototype.allGeneratedPositionsFor=function(e){var r=z.getArg(e,"line"),i={source:z.getArg(e,"source"),originalLine:r,originalColumn:z.getArg(e,"column",0)};if(i.source=this._findSourceIndex(i.source),i.source<0)return[];var o=[],n=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",z.compareByOriginalPositions,Wy.LEAST_UPPER_BOUND);if(n>=0){var s=this._originalMappings[n];if(e.column===void 0)for(var a=s.originalLine;s&&s.originalLine===a;)o.push({line:z.getArg(s,"generatedLine",null),column:z.getArg(s,"generatedColumn",null),lastColumn:z.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n];else for(var m=s.originalColumn;s&&s.originalLine===r&&s.originalColumn==m;)o.push({line:z.getArg(s,"generatedLine",null),column:z.getArg(s,"generatedColumn",null),lastColumn:z.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n]}return o};Tp.SourceMapConsumer=je;function Jt(t,e){var r=t;typeof t=="string"&&(r=z.parseSourceMapInput(t));var i=z.getArg(r,"version"),o=z.getArg(r,"sources"),n=z.getArg(r,"names",[]),s=z.getArg(r,"sourceRoot",null),a=z.getArg(r,"sourcesContent",null),m=z.getArg(r,"mappings"),c=z.getArg(r,"file",null);if(i!=this._version)throw new Error("Unsupported version: "+i);s&&(s=z.normalize(s)),o=o.map(String).map(z.normalize).map(function(d){return s&&z.isAbsolute(s)&&z.isAbsolute(d)?z.relative(s,d):d}),this._names=sl.fromArray(n.map(String),!0),this._sources=sl.fromArray(o,!0),this._absoluteSources=this._sources.toArray().map(function(d){return z.computeSourceURL(s,d,e)}),this.sourceRoot=s,this.sourcesContent=a,this._mappings=m,this._sourceMapURL=e,this.file=c}Jt.prototype=Object.create(je.prototype);Jt.prototype.consumer=je;Jt.prototype._findSourceIndex=function(t){var e=t;if(this.sourceRoot!=null&&(e=z.relative(this.sourceRoot,e)),this._sources.has(e))return this._sources.indexOf(e);var r;for(r=0;r<this._absoluteSources.length;++r)if(this._absoluteSources[r]==t)return r;return-1};Jt.fromSourceMap=function(e,r){var i=Object.create(Jt.prototype),o=i._names=sl.fromArray(e._names.toArray(),!0),n=i._sources=sl.fromArray(e._sources.toArray(),!0);i.sourceRoot=e._sourceRoot,i.sourcesContent=e._generateSourcesContent(i._sources.toArray(),i.sourceRoot),i.file=e._file,i._sourceMapURL=r,i._absoluteSources=i._sources.toArray().map(function(A){return z.computeSourceURL(i.sourceRoot,A,r)});for(var s=e._mappings.toArray().slice(),a=i.__generatedMappings=[],m=i.__originalMappings=[],c=0,d=s.length;c<d;c++){var w=s[c],P=new EL;P.generatedLine=w.generatedLine,P.generatedColumn=w.generatedColumn,w.source&&(P.source=n.indexOf(w.source),P.originalLine=w.originalLine,P.originalColumn=w.originalColumn,w.name&&(P.name=o.indexOf(w.name)),m.push(P)),a.push(P)}return eu(i.__originalMappings,z.compareByOriginalPositions),i};Jt.prototype._version=3;Object.defineProperty(Jt.prototype,"sources",{get:function(){return this._absoluteSources.slice()}});function EL(){this.generatedLine=0,this.generatedColumn=0,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}Jt.prototype._parseMappings=function(e,r){for(var i=1,o=0,n=0,s=0,a=0,m=0,c=e.length,d=0,w={},P={},A=[],V=[],Se,$t,He,J,Q;d<c;)if(e.charAt(d)===";")i++,d++,o=0;else if(e.charAt(d)===",")d++;else{for(Se=new EL,Se.generatedLine=i,J=d;J<c&&!this._charIsMappingSeparator(e,J);J++);if($t=e.slice(d,J),He=w[$t],He)d+=$t.length;else{for(He=[];d<J;)mV.decode(e,d,P),Q=P.value,d=P.rest,He.push(Q);if(He.length===2)throw new Error("Found a source, but no line and column");if(He.length===3)throw new Error("Found a source and line, but no column");w[$t]=He}Se.generatedColumn=o+He[0],o=Se.generatedColumn,He.length>1&&(Se.source=a+He[1],a+=He[1],Se.originalLine=n+He[2],n=Se.originalLine,Se.originalLine+=1,Se.originalColumn=s+He[3],s=Se.originalColumn,He.length>4&&(Se.name=m+He[4],m+=He[4])),V.push(Se),typeof Se.originalLine=="number"&&A.push(Se)}eu(V,z.compareByGeneratedPositionsDeflated),this.__generatedMappings=V,eu(A,z.compareByOriginalPositions),this.__originalMappings=A};Jt.prototype._findMapping=function(e,r,i,o,n,s){if(e[i]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+e[i]);if(e[o]<0)throw new TypeError("Column must be greater than or equal to 0, got "+e[o]);return Wy.search(e,r,n,s)};Jt.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var r=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var i=this._generatedMappings[e+1];if(r.generatedLine===i.generatedLine){r.lastGeneratedColumn=i.generatedColumn-1;continue}}r.lastGeneratedColumn=Infinity}};Jt.prototype.originalPositionFor=function(e){var r={generatedLine:z.getArg(e,"line"),generatedColumn:z.getArg(e,"column")},i=this._findMapping(r,this._generatedMappings,"generatedLine","generatedColumn",z.compareByGeneratedPositionsDeflated,z.getArg(e,"bias",je.GREATEST_LOWER_BOUND));if(i>=0){var o=this._generatedMappings[i];if(o.generatedLine===r.generatedLine){var n=z.getArg(o,"source",null);n!==null&&(n=this._sources.at(n),n=z.computeSourceURL(this.sourceRoot,n,this._sourceMapURL));var s=z.getArg(o,"name",null);return s!==null&&(s=this._names.at(s)),{source:n,line:z.getArg(o,"originalLine",null),column:z.getArg(o,"originalColumn",null),name:s}}}return{source:null,line:null,column:null,name:null}};Jt.prototype.hasContentsOfAllSources=function(){return this.sourcesContent?this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return e==null}):!1};Jt.prototype.sourceContentFor=function(e,r){if(!this.sourcesContent)return null;var i=this._findSourceIndex(e);if(i>=0)return this.sourcesContent[i];var o=e;this.sourceRoot!=null&&(o=z.relative(this.sourceRoot,o));var n;if(this.sourceRoot!=null&&(n=z.urlParse(this.sourceRoot))){var s=o.replace(/^file:\/\//,"");if(n.scheme=="file"&&this._sources.has(s))return this.sourcesContent[this._sources.indexOf(s)];if((!n.path||n.path=="/")&&this._sources.has("/"+o))return this.sourcesContent[this._sources.indexOf("/"+o)]}if(r)return null;throw new Error('"'+o+'" is not in the SourceMap.')};Jt.prototype.generatedPositionFor=function(e){var r=z.getArg(e,"source");if(r=this._findSourceIndex(r),r<0)return{line:null,column:null,lastColumn:null};var i={source:r,originalLine:z.getArg(e,"line"),originalColumn:z.getArg(e,"column")},o=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",z.compareByOriginalPositions,z.getArg(e,"bias",je.GREATEST_LOWER_BOUND));if(o>=0){var n=this._originalMappings[o];if(n.source===i.source)return{line:z.getArg(n,"generatedLine",null),column:z.getArg(n,"generatedColumn",null),lastColumn:z.getArg(n,"lastGeneratedColumn",null)}}return{line:null,column:null,lastColumn:null}};Tp.BasicSourceMapConsumer=Jt;function Mi(t,e){var r=t;typeof t=="string"&&(r=z.parseSourceMapInput(t));var i=z.getArg(r,"version"),o=z.getArg(r,"sections");if(i!=this._version)throw new Error("Unsupported version: "+i);this._sources=new sl,this._names=new sl;var n={line:-1,column:0};this._sections=o.map(function(s){if(s.url)throw new Error("Support for url field in sections not implemented.");var a=z.getArg(s,"offset"),m=z.getArg(a,"line"),c=z.getArg(a,"column");if(m<n.line||m===n.line&&c<n.column)throw new Error("Section offsets must be ordered and non-overlapping.");return n=a,{generatedOffset:{generatedLine:m+1,generatedColumn:c+1},consumer:new je(z.getArg(s,"map"),e)}})}Mi.prototype=Object.create(je.prototype);Mi.prototype.constructor=je;Mi.prototype._version=3;Object.defineProperty(Mi.prototype,"sources",{get:function(){for(var t=[],e=0;e<this._sections.length;e++)for(var r=0;r<this._sections[e].consumer.sources.length;r++)t.push(this._sections[e].consumer.sources[r]);return t}});Mi.prototype.originalPositionFor=function(e){var r={generatedLine:z.getArg(e,"line"),generatedColumn:z.getArg(e,"column")},i=Wy.search(r,this._sections,function(n,s){var a=n.generatedLine-s.generatedOffset.generatedLine;return a||n.generatedColumn-s.generatedOffset.generatedColumn}),o=this._sections[i];return o?o.consumer.originalPositionFor({line:r.generatedLine-(o.generatedOffset.generatedLine-1),column:r.generatedColumn-(o.generatedOffset.generatedLine===r.generatedLine?o.generatedOffset.generatedColumn-1:0),bias:e.bias}):{source:null,line:null,column:null,name:null}};Mi.prototype.hasContentsOfAllSources=function(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})};Mi.prototype.sourceContentFor=function(e,r){for(var i=0;i<this._sections.length;i++){var o=this._sections[i],n=o.consumer.sourceContentFor(e,!0);if(n)return n}if(r)return null;throw new Error('"'+e+'" is not in the SourceMap.')};Mi.prototype.generatedPositionFor=function(e){for(var r=0;r<this._sections.length;r++){var i=this._sections[r];if(i.consumer._findSourceIndex(z.getArg(e,"source"))!==-1){var o=i.consumer.generatedPositionFor(e);if(o){var n={line:o.line+(i.generatedOffset.generatedLine-1),column:o.column+(i.generatedOffset.generatedLine===o.line?i.generatedOffset.generatedColumn-1:0)};return n}}}return{line:null,column:null}};Mi.prototype._parseMappings=function(e,r){this.__generatedMappings=[],this.__originalMappings=[];for(var i=0;i<this._sections.length;i++)for(var o=this._sections[i],n=o.consumer._generatedMappings,s=0;s<n.length;s++){var a=n[s],m=o.consumer._sources.at(a.source);m=z.computeSourceURL(o.consumer.sourceRoot,m,this._sourceMapURL),this._sources.add(m),m=this._sources.indexOf(m);var c=null;a.name&&(c=o.consumer._names.at(a.name),this._names.add(c),c=this._names.indexOf(c));var d={source:m,generatedLine:a.generatedLine+(o.generatedOffset.generatedLine-1),generatedColumn:a.generatedColumn+(o.generatedOffset.generatedLine===a.generatedLine?o.generatedOffset.generatedColumn-1:0),originalLine:a.originalLine,originalColumn:a.originalColumn,name:c};this.__generatedMappings.push(d),typeof d.originalLine=="number"&&this.__originalMappings.push(d)}eu(this.__generatedMappings,z.compareByGeneratedPositionsDeflated),eu(this.__originalMappings,z.compareByOriginalPositions)};Tp.IndexedSourceMapConsumer=Mi});var LL=$(AL=>{var uV=Cy().SourceMapGenerator,vp=nl(),cV=/(\r?\n)/,fV=10,al="$$$isSourceNode$$$";function qr(t,e,r,i,o){this.children=[],this.sourceContents={},this.line=t??null,this.column=e??null,this.source=r??null,this.name=o??null,this[al]=!0,i!=null&&this.add(i)}qr.fromStringWithSourceMap=function(e,r,i){var o=new qr,n=e.split(cV),s=0,a=function(){var P=V(),A=V()||"";return P+A;function V(){return s<n.length?n[s++]:void 0}},m=1,c=0,d=null;return r.eachMapping(function(P){if(d!==null)if(m<P.generatedLine)w(d,a()),m++,c=0;else{var A=n[s]||"",V=A.substr(0,P.generatedColumn-c);n[s]=A.substr(P.generatedColumn-c),c=P.generatedColumn,w(d,V),d=P;return}for(;m<P.generatedLine;)o.add(a()),m++;if(c<P.generatedColumn){var A=n[s]||"";o.add(A.substr(0,P.generatedColumn)),n[s]=A.substr(P.generatedColumn),c=P.generatedColumn}d=P},this),s<n.length&&(d&&w(d,a()),o.add(n.splice(s).join(""))),r.sources.forEach(function(P){var A=r.sourceContentFor(P);A!=null&&(i!=null&&(P=vp.join(i,P)),o.setSourceContent(P,A))}),o;function w(P,A){if(P===null||P.source===void 0)o.add(A);else{var V=i?vp.join(i,P.source):P.source;o.add(new qr(P.originalLine,P.originalColumn,V,A,P.name))}}};qr.prototype.add=function(e){if(Array.isArray(e))e.forEach(function(r){this.add(r)},this);else if(e[al]||typeof e=="string")e&&this.children.push(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};qr.prototype.prepend=function(e){if(Array.isArray(e))for(var r=e.length-1;r>=0;r--)this.prepend(e[r]);else if(e[al]||typeof e=="string")this.children.unshift(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};qr.prototype.walk=function(e){for(var r,i=0,o=this.children.length;i<o;i++)r=this.children[i],r[al]?r.walk(e):r!==""&&e(r,{source:this.source,line:this.line,column:this.column,name:this.name})};qr.prototype.join=function(e){var r,i,o=this.children.length;if(o>0){for(r=[],i=0;i<o-1;i++)r.push(this.children[i]),r.push(e);r.push(this.children[i]),this.children=r}return this};qr.prototype.replaceRight=function(e,r){var i=this.children[this.children.length-1];return i[al]?i.replaceRight(e,r):typeof i=="string"?this.children[this.children.length-1]=i.replace(e,r):this.children.push("".replace(e,r)),this};qr.prototype.setSourceContent=function(e,r){this.sourceContents[vp.toSetString(e)]=r};qr.prototype.walkSourceContents=function(e){for(var r=0,i=this.children.length;r<i;r++)this.children[r][al]&&this.children[r].walkSourceContents(e);for(var o=Object.keys(this.sourceContents),r=0,i=o.length;r<i;r++)e(vp.fromSetString(o[r]),this.sourceContents[o[r]])};qr.prototype.toString=function(){var e="";return this.walk(function(r){e+=r}),e};qr.prototype.toStringWithSourceMap=function(e){var r={code:"",line:1,column:0},i=new uV(e),o=!1,n=null,s=null,a=null,m=null;return this.walk(function(c,d){r.code+=c,d.source!==null&&d.line!==null&&d.column!==null?((n!==d.source||s!==d.line||a!==d.column||m!==d.name)&&i.addMapping({source:d.source,original:{line:d.line,column:d.column},generated:{line:r.line,column:r.column},name:d.name}),n=d.source,s=d.line,a=d.column,m=d.name,o=!0):o&&(i.addMapping({generated:{line:r.line,column:r.column}}),n=null,o=!1);for(var w=0,P=c.length;w<P;w++)c.charCodeAt(w)===fV?(r.line++,r.column=0,w+1===P?(n=null,o=!1):o&&i.addMapping({source:d.source,original:{line:d.line,column:d.column},generated:{line:r.line,column:r.column},name:d.name})):r.column++}),this.walkSourceContents(function(c,d){i.setSourceContent(c,d)}),{code:r.code,map:i}};AL.SourceNode=qr});var FL=$(Sp=>{Sp.SourceMapGenerator=Cy().SourceMapGenerator;Sp.SourceMapConsumer=DL().SourceMapConsumer;Sp.SourceNode=LL().SourceNode});var OL=$((jWe,IL)=>{var pV=Object.prototype.toString,qy=typeof Buffer.alloc=="function"&&typeof Buffer.allocUnsafe=="function"&&typeof Buffer.from=="function";function dV(t){return pV.call(t).slice(8,-1)==="ArrayBuffer"}function hV(t,e,r){e>>>=0;var i=t.byteLength-e;if(i<0)throw new RangeError("'offset' is out of bounds");if(r===void 0)r=i;else if(r>>>=0,r>i)throw new RangeError("'length' is out of bounds");return qy?Buffer.from(t.slice(e,e+r)):new Buffer(new Uint8Array(t.slice(e,e+r)))}function gV(t,e){if((typeof e!="string"||e==="")&&(e="utf8"),!Buffer.isEncoding(e))throw new TypeError('"encoding" must be a valid string encoding');return qy?Buffer.from(t,e):new Buffer(t,e)}function yV(t,e,r){if(typeof t=="number")throw new TypeError('"value" argument must not be a number');return dV(t)?hV(t,e,r):typeof t=="string"?gV(t,e):qy?Buffer.from(t):new Buffer(t)}IL.exports=yV});var zL=$((Os,jy)=>{var bV=FL().SourceMapConsumer,Hy=require("path"),io;try{io=require("fs"),(!io.existsSync||!io.readFileSync)&&(io=null)}catch(t){}var wV=OL();function kL(t,e){return t.require(e)}var RL=!1,_L=!1,Gy=!1,tu="auto",ks={},ru={},xV=/^data:application\/json[^,]+base64,/,An=[],Ln=[];function Ky(){return tu==="browser"?!0:tu==="node"?!1:typeof window!="undefined"&&typeof XMLHttpRequest=="function"&&!(window.require&&window.module&&window.process&&window.process.type==="renderer")}function TV(){return typeof process=="object"&&process!==null&&typeof process.on=="function"}function Mp(t){return function(e){for(var r=0;r<t.length;r++){var i=t[r](e);if(i)return i}return null}}var Jy=Mp(An);An.push(function(t){if(t=t.trim(),/^file:/.test(t)&&(t=t.replace(/file:\/\/\/(\w:)?/,function(i,o){return o?"":"/"})),t in ks)return ks[t];var e="";try{if(io)io.existsSync(t)&&(e=io.readFileSync(t,"utf8"));else{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),r.readyState===4&&r.status===200&&(e=r.responseText)}}catch(i){}return ks[t]=e});function $y(t,e){if(!t)return e;var r=Hy.dirname(t),i=/^\w+:\/\/[^\/]*/.exec(r),o=i?i[0]:"",n=r.slice(o.length);return o&&/^\/\w\:/.test(n)?(o+="/",o+Hy.resolve(r.slice(o.length),e).replace(/\\/g,"/")):o+Hy.resolve(r.slice(o.length),e)}function vV(t){var e;if(Ky())try{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),e=r.readyState===4?r.responseText:null;var i=r.getResponseHeader("SourceMap")||r.getResponseHeader("X-SourceMap");if(i)return i}catch(a){}e=Jy(t);for(var o=/(?:\/\/[@#][\s]*sourceMappingURL=([^\s'"]+)[\s]*$)|(?:\/\*[@#][\s]*sourceMappingURL=([^\s*'"]+)[\s]*(?:\*\/)[\s]*$)/mg,n,s;s=o.exec(e);)n=s;return n?n[1]:null}var Qy=Mp(Ln);Ln.push(function(t){var e=vV(t);if(!e)return null;var r;if(xV.test(e)){var i=e.slice(e.indexOf(",")+1);r=wV(i,"base64").toString(),e=t}else e=$y(t,e),r=Jy(e);return r?{url:e,map:r}:null});function Yy(t){var e=ru[t.source];if(!e){var r=Qy(t.source);r?(e=ru[t.source]={url:r.url,map:new bV(r.map)},e.map.sourcesContent&&e.map.sources.forEach(function(o,n){var s=e.map.sourcesContent[n];if(s){var a=$y(e.url,o);ks[a]=s}})):e=ru[t.source]={url:null,map:null}}if(e&&e.map&&typeof e.map.originalPositionFor=="function"){var i=e.map.originalPositionFor(t);if(i.source!==null)return i.source=$y(e.url,i.source),i}return t}function NL(t){var e=/^eval at ([^(]+) \((.+):(\d+):(\d+)\)$/.exec(t);if(e){var r=Yy({source:e[2],line:+e[3],column:e[4]-1});return"eval at "+e[1]+" ("+r.source+":"+r.line+":"+(r.column+1)+")"}return e=/^eval at ([^(]+) \((.+)\)$/.exec(t),e?"eval at "+e[1]+" ("+NL(e[2])+")":t}function SV(){var t,e="";if(this.isNative())e="native";else{t=this.getScriptNameOrSourceURL(),!t&&this.isEval()&&(e=this.getEvalOrigin(),e+=", "),t?e+=t:e+="<anonymous>";var r=this.getLineNumber();if(r!=null){e+=":"+r;var i=this.getColumnNumber();i&&(e+=":"+i)}}var o="",n=this.getFunctionName(),s=!0,a=this.isConstructor(),m=!(this.isToplevel()||a);if(m){var c=this.getTypeName();c==="[object Object]"&&(c="null");var d=this.getMethodName();n?(c&&n.indexOf(c)!=0&&(o+=c+"."),o+=n,d&&n.indexOf("."+d)!=n.length-d.length-1&&(o+=" [as "+d+"]")):o+=c+"."+(d||"<anonymous>")}else a?o+="new "+(n||"<anonymous>"):n?o+=n:(o+=e,s=!1);return s&&(o+=" ("+e+")"),o}function BL(t){var e={};return Object.getOwnPropertyNames(Object.getPrototypeOf(t)).forEach(function(r){e[r]=/^(?:is|get)/.test(r)?function(){return t[r].call(t)}:t[r]}),e.toString=SV,e}function CL(t,e){if(e===void 0&&(e={nextPosition:null,curPosition:null}),t.isNative())return e.curPosition=null,t;var r=t.getFileName()||t.getScriptNameOrSourceURL();if(r){var i=t.getLineNumber(),o=t.getColumnNumber()-1,n=/^v(10\.1[6-9]|10\.[2-9][0-9]|10\.[0-9]{3,}|1[2-9]\d*|[2-9]\d|\d{3,}|11\.11)/,s=n.test(process.version)?0:62;i===1&&o>s&&!Ky()&&!t.isEval()&&(o-=s);var a=Yy({source:r,line:i,column:o});e.curPosition=a,t=BL(t);var m=t.getFunctionName;return t.getFunctionName=function(){return e.nextPosition==null?m():e.nextPosition.name||m()},t.getFileName=function(){return a.source},t.getLineNumber=function(){return a.line},t.getColumnNumber=function(){return a.column+1},t.getScriptNameOrSourceURL=function(){return a.source},t}var c=t.isEval()&&t.getEvalOrigin();return c&&(c=NL(c),t=BL(t),t.getEvalOrigin=function(){return c}),t}function MV(t,e){Gy&&(ks={},ru={});for(var r=t.name||"Error",i=t.message||"",o=r+": "+i,n={nextPosition:null,curPosition:null},s=[],a=e.length-1;a>=0;a--)s.push(`
    at `+CL(e[a],n)),n.nextPosition=n.curPosition;return n.curPosition=n.nextPosition=null,o+s.reverse().join("")}function VL(t){var e=/\n    at [^(]+ \((.*):(\d+):(\d+)\)/.exec(t.stack);if(e){var r=e[1],i=+e[2],o=+e[3],n=ks[r];if(!n&&io&&io.existsSync(r))try{n=io.readFileSync(r,"utf8")}catch(a){n=""}if(n){var s=n.split(/(?:\r\n|\r|\n)/)[i-1];if(s)return r+":"+i+`
`+s+`
`+new Array(o).join(" ")+"^"}}return null}function PV(t){var e=VL(t);process.stderr._handle&&process.stderr._handle.setBlocking&&process.stderr._handle.setBlocking(!0),e&&(console.error(),console.error(e)),console.error(t.stack),process.exit(1)}function EV(){var t=process.emit;process.emit=function(e){if(e==="uncaughtException"){var r=arguments[1]&&arguments[1].stack,i=this.listeners(e).length>0;if(r&&!i)return PV(arguments[1])}return t.apply(this,arguments)}}var DV=An.slice(0),AV=Ln.slice(0);Os.wrapCallSite=CL;Os.getErrorSource=VL;Os.mapSourcePosition=Yy;Os.retrieveSourceMap=Qy;Os.install=function(t){if(t=t||{},t.environment&&(tu=t.environment,["node","browser","auto"].indexOf(tu)===-1))throw new Error("environment "+tu+" was unknown. Available options are {auto, browser, node}");if(t.retrieveFile&&(t.overrideRetrieveFile&&(An.length=0),An.unshift(t.retrieveFile)),t.retrieveSourceMap&&(t.overrideRetrieveSourceMap&&(Ln.length=0),Ln.unshift(t.retrieveSourceMap)),t.hookRequire&&!Ky()){var e=kL(jy,"module"),r=e.prototype._compile;r.__sourceMapSupport||(e.prototype._compile=function(n,s){return ks[s]=n,ru[s]=void 0,r.call(this,n,s)},e.prototype._compile.__sourceMapSupport=!0)}if(Gy||(Gy="emptyCacheBetweenOperations"in t?t.emptyCacheBetweenOperations:!1),RL||(RL=!0,Error.prepareStackTrace=MV),!_L){var i="handleUncaughtExceptions"in t?t.handleUncaughtExceptions:!0;try{var o=kL(jy,"worker_threads");o.isMainThread===!1&&(i=!1)}catch(n){}i&&TV()&&(_L=!0,EV())}};Os.resetRetrieveHandlers=function(){An.length=0,Ln.length=0,An=DV.slice(0),Ln=AV.slice(0),Qy=Mp(Ln),Jy=Mp(An)}});var vv=v(require("commander")),Sv=v(require("process"));var hv=v(require("process"));function ll(t){return t!=null&&typeof t!="string"&&typeof t[Symbol.iterator]=="function"}function h(t){return t==null?"":typeof t=="string"?t:Array.isArray(t)?t.map(h).join(","):t.toString()}var JL=["number","string","boolean"];function Hr(t){return JL.indexOf(typeof t)!==-1||t instanceof Date}function iu(t){return Array.isArray(t)&&t.every(Hr)}var eb=["boolean","number","bigint","symbol","string","object","function"];function Lt(t,e){if(t==null&&e==null)return 0;if(t==null)return-1;if(e==null)return 1;let r=typeof t,i=typeof e;return(r==="string"||r==="symbol")&&(i==="string"||i==="symbol")?h(t).localeCompare(h(e)):Array.isArray(t)&&Array.isArray(e)?$L(t,e):r!==i?eb.indexOf(r)-eb.indexOf(i):t>e?1:t<e?-1:0}function ci(t,e){return Lt(t,e)<0}function tb(t,e){return Lt(t,e)<=0}function Ei(t,e){return Lt(t,e)>=0}function ml(t,e){return Lt(t,e)>0}function $L(t,e){if(R(t)&&R(e))return 0;let r=Math.min(t.length,e.length);for(let i=0;i<r;i++){let o=Lt(t[i],e[i]);if(o!==0)return o}return Lt(t.length,e.length)}var Gr;(function(t){t[t.Empty=0]="Empty",t[t.Primitive=1]="Primitive",t[t.Symbol=2]="Symbol",t[t.Object=3]="Object",t[t.Array=4]="Array",t[t.Iterable=5]="Iterable",t[t.Instance=6]="Instance",t[t.Function=7]="Function",t[t.Unknown=8]="Unknown"})(Gr||(Gr={}));function QL(t){return typeof t=="symbol"}function de(t){return typeof t=="function"}function ou(t){return YL(t)===3}function YL(t){return t==null?0:QL(t)?2:Hr(t)?1:Array.isArray(t)?4:ll(t)?5:de(t)?7:typeof t=="object"?t.constructor!=null&&t.constructor.name==="Object"?3:6:8}function Ar(t){return de(t)?t():t}var Ep=()=>{};function f(t,e){return t==null?void 0:e(t)}function Rs(t,e,r){return t==null||e==null?void 0:r(t,e)}function rb(t,e,r,i){return t==null||e==null||r==null?void 0:i(t,e,r)}function x(t,e){return t??Ar(e)}function Z(t,e,r){return t!=null?e(t):Ar(r)}function In(t,e,r,i){return x(Rs(t,e,r),i)}function Di(t){return t!=null}function nu(t){return t!=null&&t.every(Di)}function ib(...t){return t.find(Di)}function _s(t){return t==null||h(t)==="null"?void 0:t}function T(t){if(t==null)return!0;let e=h(t);return e.length===0||e.trim().length===0}var XL=/^\s*(?:null|undefined)?\s*$/i;function Ns(t){return t==null||XL.exec(t)!=null}function M(t){return!T(t)}function Dp(t){if(t==null)return;let e=h(t);return e.length===0||e.trim().length===0?void 0:e}function Kr(t,e){if(t==null)return Ar(e);let r=h(t).trim();return r.length>0?r:Ar(e)}function Ap(t,e){return T(t)?!1:e(t)}function j(t,e){if(t===!1||t==null||t==="")return;let r=h(t);return M(r)?e(r):void 0}function Ai(t,e,r){return x(j(t,e),r)}function su(...t){for(let e of t)if(M(e))return e}function k(t,e,r,i){return JSON.stringify(t,ZL(e,i),_s(r))}function ZL(t,e){let r=[],i=[],o=e??((n,s)=>r[0]===s?"[Circular ~]":"[Circular ~."+i.slice(0,r.indexOf(s)).join(".")+"]");return function(n,s){if(r.length>0){let m=r.indexOf(this);m>=0?(r.splice(m+1),i.splice(m,Infinity,n)):(r.push(this),i.push(n)),r.indexOf(s)>=0&&(s=o.call(this,n,s))}else r.push(s);return t==null?s:t.call(this,n,s)}}function oo(t,e){return k(t)===k(e)}function ob(t){return t!=null&&(Array.isArray(t)||isFinite(t.length)&&de(t[Symbol.iterator])&&de(t.push)&&de(t.pop)&&de(t.forEach)&&de(t.some))}function yr(t,e,r){if(e==null)throw new Error("null key");if(t.has(e))return t.get(e);{let i=r();return i!=null&&t.set(e,i),i}}var Lp;(function(V){V.isDefined=!1,V.isEmpty=!0,V.get=()=>{},V.exists=()=>!1;let o=()=>V;V.map=o,V.flatMap=o,V.filter=o,V.forEach=o,V.getOrElse=Se=>Se(),V.orElse=Se=>C(Se()),V.zip1=o,V.zip2=o,V.zip3=o})(Lp||(Lp={}));var nb=Lp,ul=class{constructor(e){this.a=e;this.isDefined=!0;this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new ul(e(this.a))}flatMap(e){let r=e(this.a);return sb(r)?r:C(r)}filter(e){return C(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,r){return C(e).flatMap(i=>r(this.a,i))}zip2(e,r,i){return C(e).flatMap(o=>C(r).flatMap(n=>i(this.a,o,n)))}zip3(e,r,i,o){return C(e).flatMap(n=>C(r).flatMap(s=>C(i).flatMap(a=>o(this.a,n,s,a))))}};function sb(t){return t instanceof ul||t===nb}function C(t){return sb(t)?t:t!=null?new ul(t):nb}function re(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function cl(t,e){return re(t)?e(t):void 0}var au=t=>(e,r)=>re(e)&&re(r)&&t(e,r),fl=au((t,e)=>t<e),On=au((t,e)=>t<=e),Bs=au((t,e)=>t>e),kn=au((t,e)=>t>=e);function ab(t,e,r){return t==null||e==null?!1:Math.abs(t-e)<r}function eF(t){if(!re(t))return;let e=Math.trunc(t);return e===0?Math.abs(e):e}function tF(t){return de(t.toNumber)}function lb(t,e){if(T(t))return e.defaultValue;if(re(t))return e.nton(t);if(tF(t))return e.nton(t.toNumber());try{let r=e.ston(h(t));return re(r)?e.nton(r):e.defaultValue}catch{return e.defaultValue}}function U(t,e){return lb(t,b({defaultValue:void 0,nton:r=>eF(r),ston:parseInt},e))}function Jr(t,e){return lb(t,b({defaultValue:void 0,nton:r=>r,ston:parseFloat},e))}function N(t){return re(t)&&t>0}function mb(t,e){return re(t)&&re(e)&&t>e?t:void 0}function lu(t){return re(t)&&t>=0}function Cs(t,e){return C(t).flatMap(r=>U(r)).flatMap(e).get()}function Fp(t){let e=U(t);return N(e)?String(e):void 0}function no(t,e){return re(t)?e(t):void 0}function Rn(t,e,r){return no(t,i=>no(e,o=>r(i,o)))}function Ip(t,e,r){return re(t)?e(t):r}function ub(t,e){return re(t)?t:Ar(e)}function et(t){return t<0?-Math.round(-t):Math.round(t)}function Ge(t,e){if(t===0||e===0)return 0;let r=e-et(Math.ceil(Math.log10(Math.abs(t)))),i=Math.pow(10,Math.abs(r));return r<0?et(t/i)*i:et(t*i)/i}function ee(t,e,r){if(t>e||!re(t)||!re(e))throw new Error(`invalid clamp(${t}, ${e}, ${r})`);return re(r)?r<t?t:r>e?e:r:et((t+e)/2)}function be(t,e){if(!N(t))return[];let r=Math.round(t);return r<=0?[]:[...Array(r)].map((i,o)=>e(o))}function ir(t,e,r=[]){if(t=Math.ceil(t),e=Math.floor(e),e<t)return t;if(_(r)&&r.length+10>e-t){let o=so(t,e).filter(n=>!r.includes(n));return De(o,n=>n[ir(0,o.length)])}let i=Math.floor(Math.random()*(e-t))+t;return r.includes(i)?ir(t,e,r):i}var cb="0123456789abcdefghijkmnopqrstuvwxyz";function pl(t,e=cb){let r="";for(let i=0;i<t;i++)r+=rF(e);return r}function rF(t=cb){return t[ir(0,t.length)]}function St(t){return typeof t=="string"}function Li(t,e){return t=h(t),e=h(e),t.startsWith(e)?t:e+t}function Mt(t,e){return t=h(t),e=h(e),t.endsWith(e)?t:t+e}function Yt(t,e=80){if(t==null)return"";let r=h(t);return r.length<=e?r:r.slice(0,e-1)+"\u2026"}var ao=/\r?\n/gm;function iF(t,e,r){r==null&&(r=t.length);for(let i=r;i>=0;i--)if(t.substr(i).startsWith(e))return i;return-1}function lo(t,e={maxLineLen:75,prefix:""}){if(t.includes(`
`))return ie(t.split(ao).map(i=>lo(i,e)));if(t=Li(h(t),e.prefix).trim(),t.length<=e.maxLineLen)return[t];let r=iF(t," ",e.maxLineLen);if(r>e.prefix.length)return[t.slice(0,r),...lo(t.slice(r+1),e)];{let i=t.indexOf(" ",e.prefix.length+1);return i>0&&i<t.length-1?[t.slice(0,i),...lo(t.slice(i+1),e)]:[t]}}function dl(t,e,r){return e===""?t:t.split(e).join(r)}function Fi(...t){return t.join(" ").replace(/\s+/g," ").trim()}function D(t){return t==null?[]:Array.isArray(t)?t:ll(t)?Array.from(t):[t]}function _(t){return ob(t)&&t.length>0&&t.some(e=>e!=null)}function R(t){return!_(t)}function De(t,e){return _(t)?e(t):void 0}function oF(t){return Hr(t)||iu(t)?t:t.valueOf()}function ie(t,e=[]){if(t==null)return e;for(let r of t)if(r!=null)if(Array.isArray(r))for(let i of r)i!=null&&e.push(i);else e.push(r);return e}function or(t){return _n(L(t),oF)}function Op(t,e){for(let r=0;r<t.length;r++)e[r]=t[r];return e.length=t.length,e}function _n(t,e){return Op(te(t,e),t)}function te(t,e){return D(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:f(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>Lt(r.cmp,i.cmp)).map(r=>r.item)}function uu(t,e){return t!=null&&e!=null&&t.length===e.length&&t.every((r,i)=>r===e[i])}function cu(t,e){return uu(t.slice(0,e.length),e)}function Ft(t,e){for(let r=0;r<t.length;)e(t[r],r,t)?r++:t.splice(r,1);return t}function mo(t,e){if(t==null)return!1;for(let r of t)if(e.valueOf()===r.valueOf())return!0;return!1}function fu(t,e){return t==null||e==null?!1:e.every(r=>mo(t,r))}function pu(t,e,r){let i=t.map(r);for(let o of e){let n=r(o);i.includes(n)||(t.push(o),i.push(n))}return t}function L(t){if(t==null)return[];let e=D(t);return e.every(Di)?e:e.filter(Di)}function Vs(t){let e=D(t).filter(r=>!Ns(h(r)));return St(e[0])?e.map(r=>h(r).trim()):e}function G(t){return D(t).map(e=>h(e).trim()).filter(e=>e.length>0)}function H(t){return uo(L(t),e=>k(e))}function uo(t,e=r=>k(r)){if(R(t))return[];let r=new Map;for(let i of t)if(i!=null){let o=e(i);o!=null&&yr(r,o,()=>i)}return[...r.values()]}function $r(t,e){return t.reduce((r,i,o)=>r+(e(i,o)?1:0),0)}function mu(t,e){return t.reduce((r,i,o)=>r+e(i,o),0)}function hl(t,e){if(t==null||e==null)return 0;if(t===e||(typeof t=="string"&&(t=t.split("")),typeof e=="string"&&(e=e.split("")),uu(t,e)))return t.length;let r=0;for(;t[r]===e[r];)r++;return r}function so(t,e,r=i=>i){return Nn(t,e,1,r)}function Nn(t,e,r=1,i=o=>o){let o=[];if(t<e)for(let n=t;n<e;n+=r)o.push(i(n));else for(let n=t;n>e;n-=r)o.push(i(n));return o}function du(t,e){let r=new Set(e);return t.filter(i=>!r.has(i))}function hu(t){return t!=null?t[t.length-1]:void 0}function l(t,e){return new fb(t,e).asMemoizedThunk()}var fb=class{constructor(e,r){this.thunk=e;this.ttlMs=r;this.lastSet=0;this.listeners=[]}asMemoizedThunk(){let e=this.apply.bind(this);return e.set=this.set.bind(this),e.clear=this.clear.bind(this),e.unset=this.unset.bind(this),e.prior=this.prior.bind(this),e.refresh=this.refresh.bind(this),e.ttl=this.ttl.bind(this),e.setTTL=this.setTTL.bind(this),e.onChange=this.onChange.bind(this),e.toJSON=this.toJSON.bind(this),e.lastSetAgoMs=this.lastSetAgoMs.bind(this),e}async onSetResult(e,r){if(R(this.listeners))return;let i=await e,o=await r;if(!oo(i,o))for(let n of this.listeners)n(o,i)}setResult(e){return this.lastSet=Date.now(),this.onSetResult(this.result,e),this.result=e}apply(){return(this.lastSet===0||this.ttlMs!=null&&this.lastSet+this.ttlMs<=Date.now())&&this.setResult(this.thunk()),this.result}set(e){return this.setResult(e)}unset(){this.setResult(void 0),this.lastSet=0}clear(){let e=this.result;return this.unset(),e}prior(){return this.result}refresh(){return this.setResult(this.thunk())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=e}onChange(e){this.listeners.push(e),f(this.result,e)}toJSON(){return"(Lazy)"}lastSetAgoMs(){return Date.now()-this.lastSet}};var S=1e3,E=60*S,Pt=60*E,ht=24*Pt,gu=7*ht,pb=365.25*ht,Y2=l(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));function zs(t){return t instanceof Date}function db(t,e){return new Date(x(e,new Date).getTime()-t)}function Ii(t){let e=zs(t)?t.getTime():re(t)?t:Date.now();return Math.floor(e/S)}function Bn(t){let e=String(t);return e.length>=2?e:("0"+e).slice(-2)}function hb(t){let e=zs(t)?t:new Date(t);return e.getFullYear()+Bn(e.getMonth()+1)+Bn(e.getDate())+Bn(e.getHours())+Bn(e.getMinutes())+Bn(e.getSeconds())}function yu(t){let e=zs(t)?t:new Date(t);return e.getFullYear()+"-"+Bn(e.getMonth()+1)+"-"+Bn(e.getDate())}function Me(...t){let e=Object.freeze(t),r={};for(let a of e)r[a]=a;let i=a=>a!=null&&e.includes(a),o=a=>a==null?-1:e.indexOf(a),n=(a,m)=>i(a)?a:Ar(m),s=(a,m)=>i(a)?m(a):void 0;return b(b({},r),{values:e,length:e.length,has:i,indexOf:o,validOrElse:n,mapValid:s})}var Us=v(require("process"));function kp(t){return typeof t=="boolean"}function I(t){if(typeof t=="boolean")return t;if(t==null)return!1;if(t===1)return!0;let e=String(t).toLowerCase();return["true","1"].includes(e)}function gb(t){return I(t)?!0:Qr(t)?!1:void 0}function yb(t){return I(t)?1:0}function Qr(t){if(typeof t=="boolean")return!t;if(t==null)return!1;if(t===0)return!0;let e=String(t).toLowerCase();return["false","0"].includes(e)}function Rp(t,e){return I(t)?e(!0):Qr(t)?e(!1):void 0}function gl(t,e){return I(t)?e():void 0}function nF(){switch(h(Us.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return Us.argv.some(t=>t.endsWith("mocha")||t.endsWith(".spec.js"))?"test":"production"}}var Bo=(()=>{let t=nF();return Us.env.NODE_ENV=t,t})();var he=Bo==="test",nr=Bo==="production";function Cn(){return he&&I(Us.env.SINGLE_SPEC_TESTS)}var Oi=Date.now();var Vn="PhotoStructure",fi=l(()=>Vn+(nr?"":`-${Bo}`));function xe(t,e){return r=>`[${t}m${r}[${e}m`}var mz=xe(30,39),bu=xe(31,39),wu=xe(32,39),Ws=xe(33,39),xu=xe(34,39),Tu=xe(35,39),vu=xe(36,39),uz=xe(37,39),qs=xe(90,39),bb=xe(91,39),cz=xe(92,39),wb=xe(93,39),xb=xe(94,39),fz=xe(95,39),pz=xe(96,39),dz=xe(97,39),Tb=xe(40,49),hz=xe(41,49),gz=xe(42,49),yz=xe(43,49),bz=xe(44,49),wz=xe(45,49),xz=xe(46,49),Tz=xe(47,49),vz=xe(100,49),Sz=xe(101,49),Mz=xe(102,49),Pz=xe(103,49),Ez=xe(104,49),Dz=xe(105,49),Az=xe(106,49),Lz=xe(107,49);var Eb=v(require("process"));function Et(t,e){return e!=null?e(t):typeof t=="string"?console.log(t):console.dir(t,{depth:3}),t}function gt(t){return t==null||typeof t!="object"?[]:Object.keys(t).filter(e=>typeof e=="string"&&(t.propertyIsEnumerable==null||t.propertyIsEnumerable(e)===!0))}function yt(t){return gt(t).map(e=>t[e])}function Ke(t){return gt(t).map(e=>[e,t[e]])}function tt(t,e){return typeof e!="object"&&(e={}),L(t).reduce((r,[i,o])=>Et(r,()=>{i!=null&&o!=null&&(r[i]=o)}),e)}function pi(t){if(t==null)return;let e=Ke(t).filter(([r,i])=>r!=null&&i!=null);return R(e)?void 0:tt(e)}function _p(t){if(t==null)return;let e=Ke(t).filter(([r,i])=>r!=null&&M(i));return R(e)?void 0:tt(e)}function Co(t,e,r={}){let i=L(Ke(t).sort(([o],[n])=>o.localeCompare(n,void 0,{sensitivity:"base"})).map(([o,n])=>e(o,n)));return tt(i.filter(([o,n])=>o!=null&&n!=null),r)}function rt(t,...e){if(t==null)return t;if(!e.every(i=>typeof i=="string"))throw new Error("bad keys: "+k(e));if(R(e))return{};let r={};for(let i of e){let o=t[i];o!=null&&(r[i]=o)}return r}function Bt(t,...e){if(t==null||e.every(i=>T(t[i])))return t;let r=Ke(t).filter(([i])=>!e.includes(i));return R(r)?void 0:tt(r)}function Su(t){return yt(t).every(e=>e!=null)}function yl(t){return Su(t)?t:void 0}function vb(t){return t.filter(Su)}function Sb(t){return tt(te(Ke(t),([e])=>e.toLowerCase()))}function Mb(t,e){return t==null?t:tt(Ke(t).filter(([r,i])=>e(r,i)))}function Mu(t,e,...r){return t!=null&&de(t[e])?t[e].bind(t)(...r):void 0}function Pb(t,e){if(T(e))return;if(t[e]!=null)return t[e];let r=e.toLocaleLowerCase().normalize();for(let i of gt(t))if(r===i.toLocaleLowerCase().normalize()&&t[i]!=null)return t[i]}function Ne(t){return Pb(Eb.env,t)}function co(t){return I(Ne(t))}var Db=v(require("util"));var sF=require("deep-eql");function br(t,e){return sF(t,e)}async function zn(t,e){return In(await t,await e,br,()=>!1)}async function Np(t,e,...r){return In(await t,await e,(i,o)=>br(rt(i,...r),rt(o,...r)),()=>!1)}function Pu(...t){return t!=null&&t.every(M)}function Ab(t){return t==null||t.some(e=>e==null)}function Je(t,e){if(t!=null)for(let r of L(t)){let i=e(r);if(i!=null)return i}}async function bl(t,e){if(t!=null){let r=-1;for(let i of t){r++;try{if(i==null)continue;let o=await e(i,r);if(o!=null)return o}catch(o){}}}}function Lb(t,e){for(let r=t.length-1;r>=0;r--)if(e(t[r]))return t[r]}function Fb(t,...e){let r=t.length;return Ft(t,i=>e.every(o=>!br(i,o))),r!==t.length}var Ib=t=>{if(Hr(t))return t;if(Array.isArray(t))return k(t);if(de(t.valueOf))return t.valueOf();throw new Error("Cannot get primitive value for "+(0,Db.inspect)(t))};function Bp(t,e,r=Ib){let i=new Set(e.map(r));return t.filter(o=>i.has(r(o)))}function Ob(t,e,r=Ib){return R(t)&&R(e)?1:Bp(t,e,r).length*2/(t.length+e.length)}function kb(t,e=r=>k(r)){Op(uo(t,e),t)}function Eu(t,e){let r=[],i=[];return t.forEach((o,n)=>(e(o,n)?r:i).push(o)),[r,i]}function _b(t){return Rb(t.sort())}function Rb(t){if(t==null||t.length===0)return[];let e=t[0],r=t.lastIndexOf(e);return[{t:e,count:r+1},...Rb(t.slice(r+1))]}function Nb(t,e){return t.reduce((r,i)=>r.concat(...L(e(i))),[])}function Du(t,e){return t.length>e&&t.splice(0,t.length-e),t}function Bb(t,e){return t.length=Math.min(t.length,e),t}function Un(...t){let e=Math.max(...t.map(r=>r.length));return be(e,r=>t.map(i=>i[r]))}function Cb(...t){let e=Math.max(...t.map(i=>i.length)),r=[];return be(e,i=>t.map(o=>r.push(o[i]))),r}function Vb(t){return be(t.length,e=>t.slice(0,e+1))}function Cp(t){return zb(t,e=>e.valueOf())}function Au(t){return t[Ub(t)]}function Ub(t){return Wb(t,e=>e.valueOf())}function zb(t,e){return qb(t,e,(r,i)=>ci(r,i))}function Wb(t,e){return qb(t,e,(r,i)=>ml(r,i))}function Vo(t,e){return t[zb(t,e)]}function Dt(t,e){return t[Wb(t,e)]}function qb(t,e,r){if(R(t))return-1;let i=-1,o;for(let n=0;n<t.length;n++){let s=t[n];if(s!=null){let a=e(s);a!=null&&(o==null||r(a,o)===!0)&&(i=n,o=a)}}return i}function js(t,e){return e<=0&&(e=1),Nn(0,t.length,e,r=>t.slice(r,r+e))}var rw=v(require("util"));var wl=class{constructor(e){this.maxLength=e;this._length=0;this._firstIndex=0;if(e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...be(e,()=>null))}mapIndex(e,r){return e=Math.trunc(e)??0,e<0&&(e+=this._length),e<0||e>this._length-1?void 0:r((e+this._firstIndex+this.maxLength)%this.maxLength)}item(e){return this.mapIndex(e,r=>this.store[r])}set(e,r){return this.mapIndex(e,i=>this.store[i]=r)}get length(){return this._length}set length(e){this._length=ee(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){let e=this;function*r(){for(let i=0;i<e.length;i++)yield e.mapIndex(i,o=>e.store[o])}return r()}push(...e){for(let r of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,i=>{this.store[i]=r});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(let r of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,i=>{this.store[i]=r,this._firstIndex=i});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}shiftOrFirst(){return this.length>1?this.shift():this.item(0)}every(e){for(let r=0;r<this._length;r++)if(!e(this.item(r),r))return!1;return!0}some(e){for(let r=0;r<this._length;r++)if(e(this.item(r),r))return!0;return!1}forEach(e){for(let r=0;r<this._length;r++)e(this.item(r),r)}map(e){let r=[];for(let i=0;i<this._length;i++)r.push(e(this.item(i),i));return r}reduce(e,r){let i=r;for(let o=0;o<this._length;o++)i=e(i,this.item(o),o);return i}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,r=>{this.mapIndex(this._length-1-e,i=>{let o=this.store[i];this.store[i]=this.store[r],this.store[r]=o})});return this}toA(){return[...this]}slice(e,r){return[...this].slice(e,r)}};var aF=require("he"),xl={};function Hs(t,e){if(e<1)return"";for(xl[t]==null&&(xl[t]=t);e>xl[t].length;)xl[t]+=t;return xl[t].substring(0,e)}function di(t,e,r){if(r.length===0)throw new Error("leftPad() given empty pad");if(typeof t=="number"&&t<0)return"-"+di(String(-t),e-1,r);let i=String(t);return Hs(r,e-i.length)+i}function jb(t,e,r){if(r.length===0)throw new Error("rightPad() given empty pad");let i=String(t);return i+Hs(r,e-i.length)}function Ct(t){return di(t,2,"0")}function Hb(t,e,r,i){return t.substr(0,e)+Hs(i,r)+t.substr(e+r)}function zo(t,e,r){let i=Math.min(Math.ceil(t.length/e),x(r,()=>t.length))-1;return i<=0?[t]:[...be(i,o=>t.slice(o*e,(o+1)*e)),t.slice(i*e)]}function Vp(t,e){let r=e.exec(t);if(r==null||r[1]==null)return;let i=r[0].indexOf(r[1])+r.index;return{captured:r[1],uncaptured:t.substring(0,i)+t.substring(i+r[1].length),unmatched:t.substring(0,r.index)+t.substring(r.index+r[0].length),matchedIndex:i}}function Qe(t,e){let r=h(t),i=h(e);return i.length>0&&r.startsWith(i)?r.slice(i.length):r}function Lu(t,e){return t=h(t),e=h(e),Gb(t,e)?t.slice(e.length):t}function sr(t,e){if(e==null)return t;let r=h(t),i=h(e);return i.length>0&&r.endsWith(i)?r.slice(0,-i.length):r}function Kb(t,e,r){return e==null?sr(t,r):(t=h(t),t.endsWith(r)&&t.startsWith(e)?t.slice(e.length,-r.length):t)}function Jb(t,e=80,r=80){let i=h(t),o=i.length-(e+r);return o<=0?i:i.slice(0,e).trim()+" \u2026(+"+o+" chars)\u2026"+i.slice(-r).trim()}function $b(t){t=h(t);let e=t.normalize().split("");return T(t)?t:e[0].toLocaleUpperCase()+e.slice(1).join("")}function zp(t,e){return t.localeCompare(e,void 0,{sensitivity:"base"})}function Ye(t,e){if(t==null||e==null)return!1;let r=h(t),i=h(e);return r.length!==i.length?!1:r===i||r.toLowerCase()===i.toLowerCase()?!0:r.localeCompare(i,void 0,{sensitivity:"base"})===0||zp(r.normalize(),i.normalize())===0}function Up(t){return t.sort(zp)}function Qb(t,e){return D(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:f(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>{let o=zp(r.cmp[0],i.cmp[0]);return o!==0?o:Lt(r.cmp[1],i.cmp[1])}).map(r=>r.item)}function Gb(t,e){return t==null||e==null||e.length===0||t.length===0?!1:Ye(t.substring(0,e.length),e)}function Uo(t,e){return R(t)||T(e)?!1:t.some(r=>Ye(e,r))}function ki(t){return h(t).replace(/\u001b\[[0-9;]+[a-z]/gi,"")}var lF=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function Wp(t){return lF.reduce((e,[r,i])=>e.replace(r,i),t).normalize()}var mF=/^(['"]).+\1$/;function qp(t){return T(t)||(t=h(t).trim(),mF.exec(Wp(t))!=null&&(t=t.slice(1,-1).trim())),t}function Yb(t){return t.split(/(?<=[\\/_,:=-]+)/).map(e=>aF.escape(e.normalize())).join("<wbr>")}function jp(t){return h(t).normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function Xb(t){return h(t).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")}function Zb(t){let e=Up(G(t)),r=e.filter((i,o)=>!Gb(e[o+1],i));return te(r,i=>t.indexOf(i))}function ew(...t){return t.find(N)}function Hp(...t){for(let e of ie(t)){let r=Jr(e);if(r!=null&&r!==0)return r}}function Wo(t,e){return Cs(t,r=>r>=0?e(r):void 0)}function Gs(t,e){return no(t,r=>r>=0?e(r):void 0)}function we(t,e){return Cs(t,r=>r>0?e(r):void 0)}function Ks(t,e,r){return x(we(t,e),r)}function Ie(t,e,r){return r==null||!re(r)?!1:([t,e]=[Math.min(t,e),Math.max(t,e)],kn(r,t)&&On(r,e))}var uF=/[+-]?[0-9\,\.]+/;function Gp(t){if(re(t))return t;if(T(t))return;let e=String(t);return f(uF.exec(e),r=>Jr(e.substr(r.index)))}function tw(t){return U(Gp(t))}var lr=class{constructor(e=20){this.maxSamples=e;this._n=0,this._samples=new wl(e)}static merge(e,r){if(e.n===0&&r.n===0)return new lr(Math.max(e.maxSamples,r.maxSamples));if(e.n===0)return r.clone();if(r.n===0)return e.clone();if(e.n<=e.maxSamples){let i=r.clone();return i.pushAll(e.samples),i}else if(r.n<=r.maxSamples){let i=e.clone();return i.pushAll(r.samples),i}else{let i=new lr(Math.max(e.maxSamples,r.maxSamples));i._n=e.n+r.n,i._avg=e._avg*e.n/i.n+r._avg*r.n/i.n,i._min=Math.min(e._min,r._min),i._max=Math.max(e._max,r._max),i._m=e._m*e.n/i.n+r._m*r.n/i.n,i._s=e._s*e.n/i.n+r._s*r.n/i.n;let o=ie(Un(e.samples,r.samples));return i._samples.push(...o),i._weightedTotalAvg=Tl([i._avg,...o]),i}}[rw.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=this._min==null?e:Math.min(e,this._min),this._max=this._max==null?e:Math.max(e,this._max),this._n===1||this._m==null||this._s==null||this._avg==null||this._weightedTotalAvg==null)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{let r=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-r)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return Et(new lr(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){return e.forEach(r=>this.push(r)),this}stats(e=2){let r=o=>f(o,n=>Ge(n,e)),i={};return this.empty||(i.sum=r(this.sum),i.mean=r(this.avg),i.sd=r(this.stdDev)),i.k=Ge(this.n,e),i}get empty(){return this._n===0}get n(){return this._n}get avg(){return this.empty?void 0:Ge(this._avg,4)}get sum(){return this._avg==null||this.empty?0:this._avg*this._n}get max(){return this._max}get min(){return this._min}get p84(){return we(this.avg,e=>we(this.stdDev,r=>e+r))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return f(this.variance,Math.sqrt)}get sampleMode(){return f(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;let r=new Wn;return this._samples.forEach(i=>r.incr(i)),r.topKeys(e)}get sampleStdDev(){return De(this._samples,ow)}get sampleAvg(){return De(this._samples,ar)}get sampleSlope(){return x(De(this._samples,iw),0)}get samples(){return[...this._samples]}p(e){if(this._samples.length===0)return 0;let r=[...this._samples].sort((o,n)=>o-n),i=Math.floor(r.length*(e/100));return r[i]}get weightedSampleAvg(){return De(this._samples,e=>Ge(Tl(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}};var Wn=class{constructor(){this.m=new Map}incr(e,r=1){let i=this.get(e)+r;return i===0?this.m.delete(e):this.m.set(e,i),this}get(e){return x(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){let e=new lr(0);for(let r of this.keys())if(re(r))e.push(r);else return;return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){let e=this.keyAvg();return te([...this.entries()],([r,i])=>[-i,Ip(e,o=>Math.abs(r-o),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(r=>r[0])}get averageCounts(){return Et(new lr(this.size),e=>[...this.m.values()].forEach(r=>e.push(r)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return or([...this.keys()]).map(e=>e+" "+this.get(e)).join(`
`)}};function nw(t){return t instanceof Set?t:new Set(D(t))}function Fu(t,e){return new Set([...t,...e])}function Kp(t,e){let r=nw(e);return new Set([...t].filter(i=>r.has(i)))}function sw(t,e){let r=nw(e);return new Set([...t].filter(i=>!r.has(i)))}function aw(t){let e;for(let r of t)r!=null&&(e==null||r<e)&&(e=r);return e}function lw(t){let e;for(let r of t)r!=null&&(e==null||r>e)&&(e=r);return e}function Jp(t,e){let r=new Wn;return D(t).forEach(i=>cl(i,o=>r.incr(o))),r.topKeys(e)}function $p(t){return Jp(t,1)[0]}function qo(t){return D(t).reduce((e,r)=>re(r)?e+r:e,0)}function ar(t){let e=L(D(t));return R(e)?void 0:e.reduce((r,i,o)=>o===0?i:r*o/(o+1)+i/(o+1),0)}function iw(t){let e=D(t);return f(ar(e),r=>{let i=(e.length-1)/2,o=qo(e.map((s,a)=>(s-r)*(a-i))),n=qo(e.map(s=>(s-r)**2));return n===0?0:o/n})}function cF(t){return f(ar(t),e=>ar(t.map(r=>Math.pow(r-e,2))))}function ow(t){return f(cF(t),e=>Math.sqrt(e))}function Tl(t){let e;for(let r of t)e=e==null?r:(e+r)/2;return e??NaN}var jo=class{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return qo([...this.store.values()].map(e=>e.length))}add(e,...r){let i=yr(this.store,e,()=>[]);return i.push(...r),i}set(e,r){this.store.set(e,r)}delete(e,r){if(r==null)return this.store.delete(e);{let i=this.store.get(e);if(i==null)return!1;{let o=Fb(i,r);return o&&i.length===0&&this.store.delete(e),o}}}clear(){return this.store.clear(),this}keys(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield i)}return r()}values(){let e=this;function*r(){for(let[,i]of e.store.entries())i.length>0&&(yield i)}return r()}flatValues(){let e=this;function*r(){for(let[,i]of e.store.entries())if(i.length>0)for(let o of i)yield o}return r()}entriesArray(){return[...this.store.entries()].filter(([,e])=>_(e))}entries(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield[i,o])}return r()}tuples(){let e=this;function*r(){for(let[i,o]of e.store.entries())for(let n of D(o))n!=null&&(yield[i,n])}return r()}filterInPlace(e){let r=!1;for(let[i,o]of this.store.entries()){let n=o.length;Ft(o,s=>e(i,s)),r=r||n!==o.length}return r}};function Qp(t,e){let r=new jo;return t.forEach(i=>f(e(i),o=>r.add(o,i))),r}function Ri(...t){for(let e of t){let r=e();if(r!=null)return r}}function mw(t,e){for(let r of t){let i=r();if(i!=null&&(e==null||e(i)))return i}}function it(t,e){try{return t()}catch(r){return e!=null?e(r):void 0}}function Lr(t){return t}function Js(t,e){if(e==null)return t;for(let[r,i]of Ke(e))i!=null&&(t[r]=i);return t}function Iu(t,e){let r={};for(let i of gt(t)){let o=e(i,t[i]);o!=null&&(r[i]=o)}return r}function uw(t,e){return t==null?!1:gt(t).every(r=>br(t[r],e[r]))}async function cw(t){let e=await t;return de(e)?e():e}function at(t){return fw(t,!0)}function It(t){return fw(t,!1)}function fw(t,e){return new Promise(r=>{if(t<=0)r();else{let i=setTimeout(()=>r(),Math.ceil(t+.5));e&&i.unref!=null&&de(i.unref)&&i.unref()}})}function B(t,e=1){return setTimeout(t,Math.max(1,Math.ceil(e)))}async function Ae(t,e,r=()=>{},i=()=>{}){let o=!1,n=!1,s;return await Promise.race([cw(t).then(a=>{if(!n)return s=a,o=!0,a}),at(e).then(()=>{o||(n=!0)})]),o?await i(s):await r(),s}var Ou=v(require("timers"));function $s(t,e,...r){return Et((0,Ou.setTimeout)(t,Math.round(e),...r),i=>i.unref())}function wr(t,e,...r){return Et((0,Ou.setInterval)(t,Math.round(e),...r),i=>i.unref())}var qn=l(()=>p(Tu("Endable"))),ku=new jo;wr(()=>pw(),1*E);var fF=5*S,oe=Me("first","service","predb","db","postdb","logger");function Ru(t){return jn(oe.first,t)}function dw(t){return jn(oe.db,t)}function hw(t){return jn(oe.logger,t)}function jn(t,e){return oe.validOrElse(t,()=>{throw new Error("internal error: invalid rank "+t)}),ku.add(t,e),e}var gw=!1;function K(){return gw}async function mr(t,e){let r=await t;if(r==null||r.ended)return;let i=he&&co("SINGLE_SPEC_TESTS")?100:ew(e,r.endTimeoutMs,fF);return qn().debug(r.name+" ending...",{timeoutMs:i}),Ae(r.end(),i,()=>qn().warn(r.name+".end() timed out"),()=>qn().debug(r.name+".end() completed")).catch(o=>{it(()=>qn().warn(r.name+".end() rejected: "+o))})}function pw(){ku.filterInPlace((t,e)=>!e.ended),qn().debug("vacuumEndables()",ku.entriesArray().map(([t,e])=>[t,e.map(r=>r.name)]))}var yw=l(async()=>{let t=Cn()?250:void 0;qn().info("endEndables()",{isTest:he,isSingleSpecTests:Cn}),he||(gw=!0),pw();for(let e of oe.values){let r=x(ku.get(e),[]);_(r)&&(qn().debug("endEndables(): ending "+e),await Promise.all(r.map(i=>mr(i,t))))}});var QT=v(require("os")),xa=v(require("path"));var pF=Me("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),Yp=pF.values,GW=Me("s480","s240","s120","s60"),bw=[60,120,240,480];var Xp=l(()=>new Intl.NumberFormat),eq=l(()=>dl(Xp().format(1111),"1","").charAt(0)),tq=l(()=>dl(Xp().format(1.1),"1","").charAt(0));function Zp(t){return Xp().format(t)}var ed=1e3,Ce=ed*1e3,fo=Ce*1e3,rq=fo*1e3,td=1024,_i=td*1024,rd=_i*1024,iq=rd*1024,dF=["B","KB","MB","GB","TB","PB"];function Hn(t,e=3){if(t===0)return"0";if(!re(t))return"-";let r=Math.floor(Math.log10(t)),i=Math.floor(r/3),o=Math.pow(10,i*3),n=dF[i];return Ge(t/o,e)+" "+n}var hF=1e6;function _u(t){return Ge(t/hF,2)}var oq=Me("tiny","small","medium","large","original");function ww(t){return t<320*240?"tiny":t<720*480?"small":t<1920*1080?"medium":"large"}function Nu(t,e,r=e+"s"){return Zp(t)+" "+(t===1?e:r)}var aa=v(require("fs")),Al=v(require("fs-extra")),zt=v(require("path")),Yw=v(require("zlib"));async function y(t,e){let r=await t;return r==null?void 0:e(r)}async function ge(t,e){let r=[];for(let i of D(await t))if(i!=null){let o=await i;if(o!=null){let n=await e(o);n!=null&&r.push(n)}}return r}async function xw(t,e=console.dir.bind(console)){let r=await t;return await e(r),r}var Ot=class{constructor(e){this.id=e;this._state="pending";this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i})}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve(),r=>this.reject(r)),this}observeQuietly(e){return e.then(()=>this.resolve(),()=>this.resolve()),this}get pending(){return this._state==="pending"}get settled(){return!this.pending}get resolved(){return this._state==="resolved"}get rejected(){return this._state==="rejected"}get state(){return this._state}then(e,r){return this.promise.then(e,r)}};var Xs=v(require("os"));var vw=v(require("events"));var Tw=v(require("events")),id=class extends Tw.EventEmitter{constructor(){super(...arguments);this.events=[]}emit(e,...r){return super.emit(e,...r),this.events.push({name:e,args:r}),!0}clear(){this.events.length=0}};var pq=l(()=>new id),gF=l(()=>{let t=new vw.EventEmitter;return t.setMaxListeners(50),t}),ue=gF();function od(){p("EventEmitter").info("emitClearCache()"),ue.emit("clearCache")}function W(t){ue.on("clearCache",t)}function Sw(t){ue.on("idle",t)}function Bu(t){ue.emit("migration",t)}function Mw(t){ue.on("migration",t)}function Pw(){ue.emit("pause")}function Qs(t){ue.on("pause",t)}function Ew(){ue.emit("resume")}function Ho(t){ue.on("resume",t)}function Fr(t){ue.emit("fileChanged",t)}function Ys(t){ue.on("fileCopied",t)}function nd(t,e){ue.emit("fileCopied",t,e)}function Xt(t){ue.on("fileChanged",t)}function Dw(t){ue.on("fatal",({message:e,error:r})=>t(e,r))}function Cu(t){ue.on("nonFatal",({message:e,error:r})=>t(e,r))}function Aw(){ue.emit("volumesChanged")}function Lw(t){ue.on("volumesChanged",t)}function Vu(){ue.emit("settingsChanged")}function Fw(t){ue.on("settingsChanged",t)}function Iw(t){ue.on("vacuuming",t)}function Ow(t){ue.on("writeRecentLogEntries",t)}B(()=>{W(()=>{sd.unset(),ad.unset(),lt.unset(),kw.unset(),ld.unset(),md.unset(),yF.unset()})});var sd=l(()=>((0,Xs.freemem)()*2+(0,Xs.totalmem)())/3),ad=l(()=>(0,Xs.cpus)().length),lt=l(()=>{let t=1*fo,e=Math.max(1,Math.floor(sd()/t)),r=u.cpuLoadPercent.valueOrDefault/100*ad();return ee(1,e,Math.floor(r))}),kw=l(()=>{let t=500*Ce,e=Math.floor(sd()/t),r=Math.max(1,Math.floor(1.5*ad()*(u.cpuLoadPercent.valueOrDefault/100)));return ee(1,r,e)}),ld=l(()=>ee(1,24,lt())),md=l(()=>ee(1,6,Math.ceil(kw()/ld()))),yF=ld;var fd=v(require("timers")),Bw=v(require("util"));function me(t){if(Ns(t))return"";let e=t instanceof Error?H(Vs([h(t.name).trim(),j(t.code,r=>`code ${r.trim()}`),h(t.message).trim()])).join(": "):h(t);return Yt(e,255)}function ur(t){return t==null?"(undefined)":[me(t),...D(ud(t.stack))].join(`
`)}function ud(t){return T(t)?void 0:h(t).split(`
`).slice(0,6)}function zu(t){if(T(t))throw new Error("undefined error");if(t instanceof Error)return t;if(Array.isArray(t)){let e=t[0];return e instanceof Error?(t.length>1&&(e.errors=t.slice(1)),e):new Error(t.map(r=>h(r)).filter(M).join(", "))}else{let e=me(t),r=e.indexOf(":");if(r>2&&r<15){let i=new Error(e.slice(r+1).trim());return i.name=e.slice(0,r).trim(),i}else return new Error(e)}}function Uu(t){return t instanceof Error}var po=Me("pending","resolved","rejected");var ce="\xB9",Vt="\xB2",vl="\xB3",ho="\u2074",Gn="\u2075",Yr="\u2076",Zs="\u2077",bF=[ce,Vt,vl,ho,Gn,Yr,Zs];function Wu(t,...e){return t+e.filter(r=>r!=null&&!t.includes(r)).join("")}var wF=/[â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g;function qu(t){return t.replace(wF,"")}function Rw(t){return t.split("").filter(e=>bF.includes(e)).join("")}function ju(t){return me(t).includes(ho)}var xF=[vl,"0 output files created","BatchCluster has ended, cannot enqueue","called while not idle","Can't set headers after they are sent","debugger attached","debugger listening on","diskutil: interrupted","ECONNRESET","end() called before task completed","EPIPE","for help","Format error in file","https://nodejs.org/en/docs/inspector","Invalid data found when processing input","Missing expected status message","net::ERR_","onExit(exit) called end()","This socket has been ended by the other party","Unexpected error while trimming","Warning"].map(t=>t.toLowerCase());function kt(t){if(t==null)return!0;let e=me(t).toLowerCase(),r=xF.some(i=>e.includes(i));return K()||!ju(t)&&!Ni(t)&&r}var TF=/SQLITE_BUSY|database is locked/i;function Sl(t){return t.code==="SQLITE_BUSY"||me(t).match(TF)!=null}function _w(t){return me(t).match(/database .+ not open/i)!=null}function vF(t){return me(t).match(/SQLITE_CONSTRAINT|constraint failed/i)!=null}function cd(t){return!Ni(t)&&!me(t).includes(Vt)&&!vF(t)&&!Qr(t.retriable)}function Nw(t){return!cd(t)}function Hu(t){if(ju(t))return!1;if(I(t?.doNotSend))return!0;let e=me(t).toLowerCase();return SF.some(r=>e.includes(r))||kt(e)}var SF=[Yr,"Corrupt JPEG data","premature end of data segment","VipsJpeg"],MF=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+ce,"i");function Ni(t){return t==null?!1:I(t.fatal)?!0:MF.exec(me(t))!=null}var mt=class{constructor(e){this.name=e;this.start=Date.now();this.state=po.pending;this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i}),this.logger=p("Deferred("+this.toString()+")")}toString(){return St(this.name)?this.name:k(this.name)}[Bw.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(r=>{this.resolve(r)}).catch(r=>{this.logger.warn("observeQuietly.reject()",r),this.resolve(void 0)}),this}observe(e){return e.then(r=>{this.maybeResolve(r)}).catch(r=>{this.maybeReject(r)}),this}setTimeout(e){return f(this.priorTimeout,fd.clearTimeout),this.priorTimeout=$s(()=>{if(this.pending){let r="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(r)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===po.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==po.pending}get resolved(){return this.state===po.resolved}get rejected(){return this.state===po.rejected}get settledMs(){return this.end==null?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=po.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(kt(e)?"info":"warn",".reject()",e);let r=zu(e);return this.settle(()=>{this._error=r,this.state=po.rejected,this._reject(r)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(r=>e(r))}settle(e){if(this.state===po.pending){f(this.priorTimeout,fd.clearTimeout),e(),this.end=Date.now();let r=this.settledMs;if(this.resolved&&r>5e3){let i=r>5e3?"info":"debug";this.logger.log(i,"Completed in "+r+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}};var ut=class{constructor(){this._pushCount=0;this.lastPushTs=0;this._arr=[];this.nextSettledLatches=[];this.serialLatencyAvg=new lr;this.applyListeners=[]}get arr(){return Ft(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}onApply(e){this.applyListeners.push(e)}_emitApply(e){for(let r of this.applyListeners)r(e)}push(e,r){return this._emitApply(e),this._push(e,r)}_push(e,r){this._pushCount++,this.lastPushTs=Date.now();let i=de(r)?r():r;return this.arr.push(new mt(e).observeQuietly(i).finally(()=>this.emitSettled())),i}emitSettled(){for(let e of this.nextSettledLatches)e.resolve();this.nextSettledLatches.length=0}awaitNextSettled(){let e=new Ot;return this.nextSettledLatches.push(e),e}serial(e,r){let i=Date.now();return this._push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}serialByName(e,r){let i=Date.now();return this._push(e,this.awaitAllByName(e).then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}oneRunAtATime(e,r){return this.pending?this.awaitAll():this.serial(e,r)}maybeRun(e,r){return this.maybeRunConcurrent(e,r,1)}maybeRunConcurrent(e,r,i=lt()){return this.pendingCount>=i?void 0:this.push(e,r)}get pendingCount(){return $r(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return this.arr.length===0}async awaitAll(){for(let e of[...this.arr])await e.promise}async awaitAllByName(e){for(let r of[...this.arr])r.name===e&&await r.promise}async pushAll({name:e,laters:r,maxConcurrent:i=lt()}){i=ee(1,lt()*2,i);let o=[];for(let n of r){for(;this.pendingCount>=i;)await this.awaitNextSettled();o.push(this.push(e,n))}return Promise.all(o)}};function Cw(t,e){let r=new ut;return()=>r.maybeRun(t,e)}function Vw(t,e){let r=new ut;return()=>r.serial(t,e)}async function Bi({name:t,laters:e,maxConcurrent:r}){return new ut().pushAll({name:t,laters:e,maxConcurrent:r})}async function zw(t,e,r){let i=[];for(let o of js(D(await t),e)){let n=[];for(let s of o)if(s!=null){let a=await s;a!=null&&n.push(a)}for(let s of D(await r(n)))s!=null&&i.push(s)}return i}function Uw(t,e){return Promise.race([t.then(()=>!0),at(e).then(()=>!1)]).catch(()=>!1)}async function pd(t){try{return await t,!0}catch(e){return!1}}async function Ww(t){return await t!=null}async function Gu(t){let e=L(t);_(e)&&await Promise.all(e)}async function Ml(t){let e=[];for(let r of D(await t)){let i=await r;if(i!=null)if(Array.isArray(i))for(let o of i){let n=await o;n!=null&&e.push(n)}else e.push(i)}return e}async function Kn(t){let e=L(await t);return R(e)?[]:L(await Promise.all(e))}async function ea(t,e,r){if(t==null)return[];let i=L(await t);return R(i)?[]:(await Bi({name:"thenCollectParallel",laters:i.map((n,s)=>async()=>[await e(n,s),n]),maxConcurrent:r})).filter(([n,s])=>n!=null&&s!=null)}async function ta(t,e,r){return(await ea(t,e,r)).map(i=>i[0])}async function Go(t,e,r){return(await ea(L(t),e,r)).filter(([o])=>o).map(([,o])=>o)}var pj=30*S;async function ct(t,e=!0){if(t==null)return e;let r=await t;return r==null?e:!I(r)}async function ye(t,e,r){let i=await t;if(i==null)return r();let o=await e(i);return o??r()}async function ra(t,e,r,i){let o=await t;if(o==null)return i();let n=await e;if(n==null)return i();let s=await r(o,n);return s??i()}async function Pe(t,e){return x(await t,e)}async function qw(t,e){for(let r of t)try{let i=await r();if(i!=null)return i}catch(i){e(i)}}async function Pl(t,e){return te(await ea(t,e),r=>r[0]).map(r=>r[1])}var jw=v(require("fs")),El=v(require("os")),go=v(require("process"));var Dl=(0,El.platform)(),Tj=go.default.argv.includes("--inspect")||I(go.default.env.NODE_INSPECT),yo=!h(__filename).includes("Platform"),O=Dl==="win32"||Dl==="cygwin",Hw=O&&M(go.default.env.PORTABLE_EXECUTABLE_DIR),fe=Dl==="darwin",ot=Dl==="linux",vj=ot&&(0,El.arch)()==="x64",dd=(0,El.arch)()==="arm",PF=ot&&dd,Sj=ot&&(M(go.default.env.APPIMAGE)||M(go.default.env.APPDIR)),Mj=ot&&M(go.default.env.SNAP_USER_DATA),ia=fe||ot,EF="PS_IS_ELECTRON",DF="PS_IS_DOCKER",Xr=go.default.versions.electron!=null||I(go.default.env[EF]);function Oe(){return ot&&(co(DF)||co("PS_DOCKER"))}var Pj=l(()=>PF&&h(AF()).startsWith("Raspberry Pi")),AF=l(()=>{try{return ot?f((0,jw.readFileSync)("/proc/device-tree/model"),h):void 0}catch{return}}),Gw=O?"win":fe?"mac":ot?"linux":Dl;var cr=15*S,Jn=5*E,q=35*S,xr=7*S,Kw=1*Pt,Ku=S/(2*_i);var oa=25*S;var na=v(require("stream")),Jw=v(require("util"));async function Ci(t){t!=null&&(it(()=>Mu(t,"unref")),K()?t.end(null):await new Promise(e=>t.end(null,e)),await at(50),it(()=>Mu(t,"destroy")))}async function $w(t){t!=null&&(it(()=>Mu(t,"unref")),K()?t.close(Ep):await new Promise(e=>t.close(e)))}function Qw(t){for(let e of[t?.stdin,t?.stdout,t?.stderr])try{e?.destroy()}catch{}}var $n=(0,Jw.promisify)(na.pipeline);function sa(t){return t.destroyed?"destroyed":`${t.remoteFamily}:${t.remoteAddress}:${t.remotePort}`}var hd=class extends na.Transform{constructor(e){super({transform:(r,i,o)=>{this.onProgress(this.bytes+=r.length),o(r)}});this.onProgress=e;this.bytes=0}};var Ll=zt.default.posix;function LF(t,e){if(T(t)||zt.default.sep===Ll.sep)return t;let r=M(e)?zt.default.sep+zt.default.sep+e+zt.default.sep:"",i=t.split(Ll.sep);return Ye(i[0],e)&&i.unshift(),r+i.join(zt.default.sep)}function Zr(t){return T(t)||zt.default.sep===Ll.sep||Ll.sep===zt.default.sep?t:t.split(zt.default.sep).join(Ll.sep)}var Xw=/^([A-Z]:)[\\/]?(.*)$/i;function FF(t){let e=Xw.exec(t);return e!=null?e[1].toUpperCase()+"\\"+e[2]:t}function ei(...t){let e=zt.default.join(...t);return zt.default.resolve(O?FF(e):e)}function Zw(t){return hi(LF(t))}function ex(t){return hi(t).ext}var IF=/(\.(?:gz|z|7z|xz|bz2))$/i;function hi(t){let e=Vp(t,IF),r=zt.default.parse(x(e?.uncaptured,t));return b(b({},r),e==null?{}:{ext:r.ext+e.captured,base:r.base+e.captured})}function la(t,e){return M(t)&&M(e)&&(t===e||t.startsWith(Mt(e,zt.default.sep)))}function Ko(t){return Qe(t,zt.default.sep).split(zt.default.sep)}function Ju(t,e){return t.nativePath===e.nativePath?"":Qe(Zr(e.nativePath),Mt(Zr(t.nativePath),"/"))}var tx=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function Ir(t){return Z(h(t).match(tx),e=>e[1],()=>t).toLowerCase().normalize()}function rx(t){return f(h(t).match(tx),e=>Je([e[2],e[3]],U))}function ma(t){if(T(t))return!1;try{return aa.default.statSync(t).isDirectory()}catch{return!1}}async function Fl(t){if(!T(t))try{return await Ae(Al.default.stat(t),cr)}catch{return}}async function ix(t){return ye(Fl(t),e=>e.isDirectory(),()=>!1)}async function ox(t){if(T(t))return!1;try{return await Fl(t)!=null}catch{return!1}}async function ua(t,e=oa){if(T(t))return!1;try{let r=await Ae(Fl(t),e);return r==null||!r.isDirectory()?!1:await Uw(Al.default.access(t,aa.default.constants.R_OK|(O?0:aa.default.constants.X_OK)),e)}catch{return!1}}function gd(t){return t.startsWith("\\\\")}function nx(t){return ia&&t.startsWith("/")||O&&(gd(t)||t.match(Xw)!=null)}var OF=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});function sx(t){return t==null||t.isFile()&&t.size===0}async function $u(t){let e=b(b({},OF),t),r=hi(e.nativePath);await Al.default.mkdirp(r.dir);{let i=await Fl(e.nativePath);if(!e.requireNumber&&(i==null||e.emptyIsNew&&sx(i)))return e.nativePath}for(let i=e.startIndex;i<=e.maxVersions;i++){let o=zt.default.join(r.dir,`${r.name}-${di(i,e.leftPad,"0")}${r.ext}`),n=await Fl(o);if(n==null||e.emptyIsNew&&sx(n))return o}throw new Error("There are already more than "+e.maxVersions+" of "+e.nativePath)}async function ax(t){if(t.endsWith(".gz"))return t;let e=t+".gz";return await $n([aa.default.createReadStream(t),(0,Yw.createGzip)(),aa.default.createWriteStream(e)]),await Al.default.unlink(t),e}var lx=v(require("os")),mx=v(require("path"));var gi=l(()=>{let t=[];O?t.push(Ne("USERPROFILE")):t.push(Ne("HOME"));for(let e of G(t)){let r=(0,mx.resolve)(e);if(ma(r))return r}return(0,lx.homedir)()});function yd(){if(Oe()&&ma("/ps/cache"))return"/ps/cache";if(O){for(let t of G([Ne("TEMP"),Ne("LOCALAPPDATA")]))if(ma(t))return ei(t,fi())}if(fe){let t=ei(gi(),"Library","Caches");if(ma(t))return ei(t,fi())}return ei(gi(),".cache",fi().toLowerCase())}var bd=v(require("path"));var ux=v(require("fs")),cx=v(require("fs-extra")),Qu=v(require("path")),fx=v(require("process"));var ca=l(()=>{let t=[fx.env.PS_CONFIG_DIR,Oe()?"/ps/config":void 0];O&&(t.push(Ne("APPDATA")),t.push((0,Qu.resolve)(gi(),"AppData","Roaming"))),fe&&t.push((0,Qu.resolve)(gi(),"Library","Application Support")),!fe&&ia&&t.push(Ne("XDG_DATA_HOME"),Ne("XDG_CONFIG_HOME"),(0,Qu.resolve)(gi(),".config"));let e=G(t);for(let r of e)try{if((0,ux.statSync)(r).isDirectory())return r}catch{}for(let r of e)try{return(0,cx.mkdirpSync)(r),r}catch{console.error("Failed to mkdirp "+r)}throw new Error("Cannot determine appData"+ce)});function px(){return Oe()?"/ps/logs":fe?(0,bd.resolve)(gi(),"Library","Logs",Vn.toLowerCase()):kF()}function kF(){return(0,bd.resolve)(ca(),Vn.toLowerCase(),"logs")}var ft="1.0.0-alpha.1",dx="1.0.0-alpha.1+20210314162034";var wd=new Date(1615764034e3);var RF=()=>ft.includes("-alpha"),_F=()=>ft.includes("-beta"),hx=()=>RF()?"alpha":_F()?"beta":"latest";var qT=v(require("path"));var wc=v(require("batch-cluster"));async function Yu(t,{timeoutMs:e,timeBetweenMs:r,acceptable:i,timeoutResult:o,unref:n}){let s=e==null?void 0:e+Date.now();for(;s==null||Date.now()<s;){let a=Date.now(),m=await t();if(m==null||(de(i)?!i(m):m===!1)){let c=Date.now()-a,d=x(r,()=>ee(100,5e3,c*ir(4,10)));await(Qr(n)?It(d):at(d))}else return m}return o}async function Ve(t,e){return Yu(t,b(b({},e),{acceptable:r=>I(r),timeoutResult:!1}))}var NT=v(require("process"));var ze=class{constructor(e,r,i,o,n){this.name=e;this._isEnded=o;this.endTimeoutMs=n;this.onEnds=[];this._ended=!1;this.logger=p(e),this.onEnds.push(r),jn(i,this)}get ended(){return Z(this._isEnded,e=>e(),()=>!1)||this._ended}end(){if(!this._ended)return this._ended=!0,Gu(this.onEnds.map(e=>e()))}};var Gd=v(require("child_process")),Kd=v(require("process"));async function fa(t,e){let r;return Promise.race([t().then(i=>{if(r==null)return r=!0,i}),at(e).then(()=>{if(r==null)throw r=!1,new Error("timeout")})])}function ti(t,e){let r=N(e.timeoutMs)?()=>fa(t,e.timeoutMs):t;if(e.maxRetries<=0)return r();let i=C(e.onRetryWaitUntil).getOrElse(()=>s=>at((e.retryDelay??250)*x(s,1))),o=0,n=async()=>{try{return await r()}catch(s){if(await e.errorIsRetriable?.(s)===!1||o>e.maxRetries)throw s;return o++,await i(o),n()}};return n()}var gx=v(require("util"));var xd=class{constructor(e,r){this.ttlMs=e;this.maxLength=r;this.times=[];this.a=[]}[Symbol.iterator](){this.vacuum();let e=[...this.a];function*r(){for(let i of e)yield i}return r()}push(...e){be(e.length,()=>this.times.push(Date.now())),this.a.push(...e),this.maxLength!=null&&this.vacuum()}pushUniq(...e){e.forEach(r=>{this.includes(r)||this.push(r)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(this.a.length===0)return;if(this.maxLength!=null){let i=this.a.length-this.maxLength;this.times.splice(0,i),this.a.splice(0,i)}let e=Date.now()-this.ttlMs,r=this.times.findIndex(i=>i>e);r===-1?this.clear():r>0&&(this.times.splice(0,r),this.a.splice(0,r))}};var Jo=class{constructor(e){this.ttlMs=e;this._eventCount=0;this._lastEventTime=0;if(e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new xd(e)}[gx.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){let e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return we(this.eventDeltas.length,()=>Tl(this.eventDeltas))}get msPerEvent(){return ar(this.eventDeltas)}get eventsPerMs(){return Gs(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return Gs(this.eventsPerMs,e=>Ge(S*e,3))}get eventsPerMinute(){return Gs(this.eventsPerMs,e=>Ge(E*e,3))}};function yx(t){let e=sr(h(t).trim().toUpperCase(),":");return Z(NF[e],r=>r.description,()=>t)}var NF=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}});var BF=Date.now(),Zu=l(()=>p("Error")),bx=new Jo(E),Td=new Jo(E);function wx(t,e){return e.exec(me(t))!=null}function CF(){let t=Date.now()>BF+u.probationMs.valueOrDefault,e=fl(Td.eventsPerMinute,u.fatalErrorRatePerMinute.valueOrDefault);return Zu().tap({level:"info",msg:"isFatalErrorAllowed()",result:Tr()&&t&&e,meta:{mainService:Tr(),postProbation:t,lowErrorRate:e,fatalErrorRatePerMin:Td.eventsPerMinute,errorRatePerMin:bx.eventsPerMinute,fatalErrorRatePerMinuteSetting:u.fatalErrorRatePerMinute.valueOrDefault}})}function ec(){let t={};return Error.captureStackTrace(t,ec),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)}var VF=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function zF(t){let e=qu(ki(t)),r=e;do r=e,e=VF.reduce((i,o)=>i.replace(o,""),e).trim();while(r!==e);return G(e.split(/\s+/).map(i=>{if(i.startsWith("E")){let o=yx(i);return e.toLowerCase().includes(o.toLowerCase())?"":o+":"}return i})).join(" ")}function Qn(t,e=256){let r=me(t),i=Rw(r);return Yt(zF(r),e-i.length)+i}function xx(t,e){return h(t).split(/\r?\n/).map(r=>Qe(r,e)).map(r=>r.replace(/: ?/,"")).filter(M).join(", ")}function Y(t,e,r){if(T(t)&&e==null){Zu().warn("onError() with empty args",ec());return}let i=me(t)+me(e)+me(r),o=Ni(e)||Ni(i)||I(r?.fatal);if(!o&&kt(i)){Zu().info("onError(): (ignorable): "+ur(e),b({message:t},r));return}f(Xu(),s=>s.writeRecentLogEntries()),bx.onEvent(),o&&Td.onEvent();let n=!o||CF()?"nonFatal":"fatal";Zu().log(n==="fatal"?"error":"warn","onError(): "+ur(e),b({event:n,message:t},x(r,{}))),K()||ue.emit(n,{message:t,error:e})}function Tx(t,e){return t==null?new Error(e):(M(e)&&(t.message.toLowerCase().includes(e.toLowerCase())||(t.message+=": "+e)),t)}var yT=v(require("child_process")),zl=v(require("process"));var vx=v(require("util"));function pa(t){return t==null?[]:Object.keys(t)}var ke=class{constructor(e,r){this.maxSize=e;this.clearEveryMs=r;this.setsSinceLastSpill=0;this.expireListeners=[];if(e<1)throw new Error("maxSize must be positive");if(e>3e4)throw new Error("maxSize is too big");this.clear(),N(r)&&(this.clearInterval=wr(()=>{this.spill()},et(r/2)))}spill(){if(this.priorCache!=null&&this.currentCache!=null&&_(this.expireListeners)){for(let e in this.priorCache)if(this.currentCache[e]==null){let r=this.priorCache[e];if(r!=null)for(let i of this.expireListeners)i(e,r)}}this.priorCache=this.currentCache??Object.create(null),this.currentCache=Object.create(null),this.setsSinceLastSpill=0}[vx.inspect.custom](){return b(b({},this.priorCache),this.currentCache)}end(){this.clearInterval!=null&&clearInterval(this.clearInterval)}clear(){return this.visit((e,r)=>{for(let i of this.expireListeners)i(e,r)}),this.currentCache=Object.create(null),this.priorCache=Object.create(null),this.setsSinceLastSpill=0,this}get size(){if(this.currentCache==null||this.priorCache==null)return 0;let e=0;for(let r of Fu(pa(this.priorCache),pa(this.currentCache)))this.has(r)&&e++;return e}has(e){return this.currentCache[e]!=null||this.priorCache[e]!=null}keys(){return H([...pa(this.priorCache),...pa(this.currentCache)]).filter(e=>this.currentCache[e]!=null)}delete(e){let r=this.currentCache[e];if(r!=null){this.currentCache[e]=void 0;for(let o of this.expireListeners)o(e,r)}let i=this.priorCache[e];if(i!=null&&(this.priorCache[e]=void 0,r==null))for(let o of this.expireListeners)o(e,i)}visit(e){for(let r of Fu(pa(this.priorCache),pa(this.currentCache))){let i=this.currentCache[r]??this.priorCache[r];i!=null&&e(r,i)}}deleteIf(e){for(let r of this.keys()){let i=x(this.currentCache[r],this.priorCache[r]);i!=null&&e(r,i)&&this.delete(r)}}get(e){return e=h(e),this.currentCache[e]??this.priorCache[e]}set(e,r){e=h(e),this.currentCache[e]==null&&(this.setsSinceLastSpill>=this.maxSize&&this.spill(),this.setsSinceLastSpill++),this.currentCache[e]=r}getOrSet(e,r){e=h(e);let i=this.get(e);if(i!=null)return i;let o=r();return this.set(e,o),o}on(e,r){this.expireListeners.push(r)}},Vi=class{constructor(e){this.opts=e;this.uid=0;this.cacheSyncHits=0;this.cacheAsyncHits=0;this.cacheMisses=0;this.timeouts=0;this.cache=new ke(e.maxSize,e.clearEveryMs)}get size(){return this.cache.size}stats(){return{size:this.size,cacheSyncHits:this.cacheSyncHits,cacheAsyncHits:this.cacheAsyncHits,cacheMisses:this.cacheMisses,timeouts:this.timeouts}}get(e){let r=this.cache.get(e);return r==null||r.__uid!=null?void 0:r}clear(){this.cache.clear(),this.cacheSyncHits=0,this.cacheAsyncHits=0,this.cacheMisses=0,this.timeouts=0}deleteIf(e){for(let r of this.cache.keys())e(r)&&this.cache.delete(r)}async getOrSetAsync(e,r,i=1){e=h(e);{let a=this.get(e);if(a!=null)return this.cacheSyncHits++,a}let o=this.uid++,n=Date.now(),s=this.cache.getOrSet(e,()=>({__uid:o,__start:n}));if(s.__uid===o)return this.cacheMisses++,Ae(r,this.opts.timeoutMs,()=>{this.timeouts++,this.cache.get(e)?.__uid===o&&this.cache.delete(e)},a=>{this.cache.set(e,a)});{let a=s.__start;if(a!=null){let c=a+this.opts.timeoutMs-Date.now();if(c>0){let d=Yu(()=>this.get(e),{timeoutMs:c});if(d!=null)return this.cacheAsyncHits++,d}}return i>0?this.getOrSetAsync(e,r,i-1):void 0}}};var vr=v(require("fs")),$e=v(require("fs-extra")),en=v(require("path")),eT=v(require("util")),rs=v(require("zlib"));async function Il(t,e){return t==null||e==null?Z(t,L,()=>[]):Go(t,e)}async function Sx(t,e){return t==null||e==null||await e(t)?t:void 0}var vd=class{constructor(e,r){this.l=e;this.listener=r;this.ts=Date.now()}elapsed(e){let r=Date.now(),i=r-this.ts;this.ts=r,f(this.listener,o=>o(e,i)),i>2&&this.l.log(i>500?"warn":i>100?"info":"debug",e,{elapsedMs:i})}};async function ri(t){let e=Date.now(),r=await t();return{elapsedMs:Date.now()-e,result:r}}async function da(t){let e=Date.now(),r=await t;return{elapsedMs:Date.now()-e,result:r}}var UF=15,ha=class{constructor(){this.errors=new Wn;this.times=new Map}async time(e,r,i){let o=Date.now();try{let n=await r(),s=Date.now()-o;return i!=null&&i(n,s),this.push(e,s),s>2*S&&p("time("+e+")").warn("slow",{elapsed:s}),n}catch(n){throw this.errors.incr(e),i!=null&&i(n,Date.now()-o),n}}get entriesBySumDesc(){return te([...this.times.entries()],([,e])=>-e.sum)}stats(e){let r=this.entriesBySumDesc.filter(([n])=>n.startsWith(e)),i=r.reduce((n,s)=>lr.merge(s[1],n),new lr),o=r.map(([n,s])=>[n,s.stats()]);return tt([["merged",i.stats()],...o])}mkElapsed(e){return new vd(e,(r,i)=>this.push(r,i))}push(e,r){r>UF&&yr(this.times,e,()=>new lr).push(r)}weightedAvg(e){return C(this.times.get(e)).map(r=>r.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[r,i])=>b(b({},e),{[r]:i.n}),{})}weightedAvgs(){return pi([...this.times.entries()].reduce((e,[r,i])=>b(b({},e),{[r]:cl(i.weightedSampleAvg,et)}),{}))}report(){return this.entriesBySumDesc.reduce((e,[r,i])=>b(b({},e),{[r]:b({sumSec:Ge(i.sum/S,3)},Bt(i.stats(),"sum"))}),{})}},Mx=l(()=>Et(new ha,t=>new ze("PromiseTimer",()=>{let e=p("PromiseTimer");e.info(`timings:
`,t.report()),De(t.errorCounts(),r=>e.warn(`error counts:
`,r))},oe.service)));function Px(t){return Mx().mkElapsed(p(t))}function pt(t,e,r){return Mx().time(t,e,r)}function Ex(t,e,r){return l(async()=>pt(t,e),r)}var kx=v(require("crypto"));var Sd=v(require("zlib"));var Dx="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function Ax(t){if(typeof t=="number"&&t<Dx.length)return Dx[t];let e=t.toString(16);return e.length%2==1&&(e="0"+e),Buffer.from(e,"hex").toString("base64")}function tc(t){return(0,Sd.gunzipSync)(Buffer.from(t,"base64")).toString("utf8")}var Lx=l(()=>tc("H4sIAAAAAAAAA1WcgZarLM+Fb8ibQkWlInhA2rFX/+8nOPN+/1qnAa1jEUKydxLP0oZPGtxcB3ecg0t5cMXpo+OqflV7bYNrP4P7fofRxWEcP8M4bcPodRynYcx5GNuhT9HnHsZ7HyZXh2lSG69hOtTP6udDn6TPzzC1qI+O72mYdd3s4zCHn2E+dHxNg/dl8CUP/h2Hxa36JH3+Dct8DovfhyUs+qjd9dG9l+scVncNa9Anz/rEYb3PYdPxpv7WXsPLncMrrPp8h1dpw66/3RufQ5+izzXsHzdEjT3q2eJ5DVHjPJY8HKEOR16GpL9P4RxSHvWZhnQdQy7HcLqmzz2cGtOpa0+N6dTznpqbM5/6XMP5rwxnScPZZn2CPvfw71/Qpw3FjfrUoeT3UDTn5e2GOu9D9T9D3YI+11B176rfrf/iUO9luMZjuPR81+camubwPR/DR/f55FWfc/hoHT/VD59rGX5+foY7zMOd2/B1kz778PXr4FyaBxdKGNzLaYmPaUXsEru0IGm5dQU9TZpLTdqQvjo8T/XKgbLoF1wdda6iO5ce2jU05sPf3nxxFy/FKYvEVyoyV+mKv5zEZxzGgCqFVYfh0nXhR708SqXyhEjrMF5c0qK+bRy2S0rlJiexIgqHHynYJg2QeEtIB6atrQidC6eui5qrKXGY0cwcdS6bPp63hLR9KlKRqXHnlhLiGma3ZokjSUfp+SoNDahs2L1EUu8lTZgj5/JUJTxCI53zqUuK9E/iHOZ2jBIay/zWnM63buBnjcr/SCzOo+MFZa8b4ishPVgmKeniJ4SfpfYa38IIFmZtCZqXJejXlqCHWYIecIlSuyWlW3tDPyShS7JUcvVTkJByr/5wEkmH4dTesW+zNGbNWgWJNqwl12FtI0JbcXOvIKHRb67MEh8deqeeH72EHyViRLDv9JNbdkVCa7llT0/zsuWDLw7OFXpSPYldomqrXtrHW+OLj3ZT2D9+CIcWJSRtwhcDfwWpj7awellDe+WQhlfVk7/eWtDdjQhpzu7iKCG12FmoPWXtcBZ+z1rVnYXfWe6dRd5bDcPOekSv4UZ0MvJnMRy3xFu9rEeN3CAypxJNYqEn/YuZS5o2U2x6jsNJ+Q8XEJpnCZkPl7xE1aFviyyKbiWBbXkhos5lbcsj77dE1LmcHGKV0JQcuZrQrdqiixvfMvqjXXVITgNPPHlyxyHxDUPyMpXJaycn/9El/uca0iqlSVljSXX5DKlpoVLTuuWo+cuHliwXXSJxS1x50MLIWPFEp1u9xMtJ7JzTIE+vG0jQi/SSCX3rpSqnL+/h3KTAEv9kGqW7Jw99Bu7Ck59BfucMiUP+NpwmdIMgIy1jKmsaLq7Ttj/ZYGf2WFTN/Zk3bKzm+WRBz1wmBD2twlmCDotMgYTOXZsOm5T1bDtCz3s2bt+qLHe7OLz4Qr/27588zr8WDplljVSa4ofi/SVR6GlfliyjXt7atZVpr04qUCeZoOo1fxKrhGxi3eTAKrapYpskvth0hIxCxepVFL1G3b5G7d96yDTXQ3uhHhwmWZCKblR0rWY5qXrKildNJWJF6It/fpNo+rbwbeEnL0TTqlbsmoR+qGm1apNa1Dvpuq++veQJJKRXl1urhLTuYp9f3snNeL8gvhJ6tsufTUJTfPk2DtemObhYwSuPiBMhj3qVkCWaH65LT3k17vfRgNqY76FFPVY7NNLGZLcqG9HadA5vr4vfq4zRO4xFwpv4DO8sF/bGQL0vjfTDICX24eMv+T3m9MOcfsJL3wap6OfUrv2wyD9yZsMP8/yTtdI3f3a7HOQGx3v4Bm2Xbwzj8D00yG/W7375oS+T6MaxTZKYXyRnckM2vN+M7XPzEcBRbdGZ1Um33OZBUhEL4KLXyrl4buofURMuj3qZX8VXpq8eUaY/6G+LedTrcsHkLf/puP7Wk8qDrltEyjSPLlRzrHK5oy5akQW3OnOllod+0++OYcF5hgO3GsybBhZkjFlrPWbmUVIPLqe76XxeuYMsgnlgjU3yy3m7ZzZXXLxmRtL6bB7N0YZcZdKRDXc9c6ZeQoXtm3DWk/ltrkR6yaUgV/t2xR+7TVo0+Vq79CaDyYx/l2GXxOtvwXuTBZmAAJhpycy3LLQAgAzUFKwf2PPIYFJ3i15zO0VM65RX7pM37pkxOcIIhg9yBCAURijJeczulO8Msv0KEE0FyyYpTZsqRkowQkZhat5k0ead2tcBJdCK2RVZ+dm7KKjgRxkwScGVOUTtzTkUPfucWa85Z6GBubhFWKRgA+fy1dadG7MnNCET720+tR7yrX7STAxezisKQRd5PS+ToPOy4pIXltDLaAE4ouYBmZGaAaEPrdTiLgf+uDTbgh2y+4uP0pnFVmSxFVlsRRZbEWGRDQiymswLZ+waDdaZVF+2Tecj9nWRXiGTvNai+QxIYfAl25X5+iKbfMFSnOzTUjKoRfs3IeV3V4dLWgUxhfR9kUVfQ/rmYY3A2TVJQQVhGMNq91wzJm6VruqaErR/hW1kSiRl1iXbCdCR1q0N/y8p27be+QT2zIZ7Xl1+BXBc1viFf4TXNy2dAJGvevYtvKTtklrfLSetr4BNQlZDP29pzmb6sMkg6fwnaNW2+9C6hFkKKpQzC+9Lao1CejXJyty+3Et/Jbkjd5nNl4wK8pImvPwoG4q8kMLoL/+RpXptTqv8EvgrkptG8sqs4Cu3oDNt1d5/tWtvQCf5EMEm8JCbZM0lAU1u0ZW7gIvO+CTLv/sit7uHQ5q2B55xj1lOfM97BkahUbvtekEqrf5uc7jf5YRXjcEkHEvbLknydFEuJUoWaX701fDXoTEjAV+HXFs0qxWPRTtIIIzr82Lga1nAZlr/Ido8x9wceKxJk2MbtRaxMQOxYdOkgLvhMd1ZUvMsKbsn2LNx/nqB0a7Et5d296HlQs4B2IY10MhmZ1JXrlgMSe0yWX/Nj6QY1iGYCIZLF/ito7jTwBu7T7LRx4oeZj00Ao1ZkrFVLJUQnjT8aKwX0pvsZzKAj9G26+pyE9xz+wX8Mxk0wuT+aZYkZT2SZ5ySxZn0JoPJDECUrU72LEl7WXfIYMtke1CESTuIaRYwfOGZ5RD0i+IK9AtzKxCv6wWBgXNuBhXK4SUkkNDszOkSEM8lsJYU085c9MvK9XXnW+EOwCQs2m87mDJ0ZHmAJSMs2uMfT9Ew5KVfl2yb5BeMJ5sPVESHJTdDm8HOVOs30GSMAEvWS9KuP8GqkkDPAi4MP7KfZ/hqJk9ZlYq8dWVs0nyhUO5svhIJx9fOk4xv+kXzfBag4Fk8AFPzQx/ierY0wf35xX/hlqX9F6FSstFuQcqPSHrrS0/+NfRBhnAOAy5XfRl35CmvpNuDSYOdl0JVycS37002sLzrvg7lRouqA5NUN4eKFGaojuurw8tU3Z8zBXhoq6B9qKdA6tsJtoj0JoNJzh+AUp3W9f7UTtdoZEsFcaVj1fxvDdg6ra68c93BTnUH+SCBu4aaIxRcJE66XeW66RfQarbx5Aq8zlcRiNX07YBaERHJHQk3EsKIAFtseG1oI5IzUZahyksCcYViJHu/6IkusbHV5I7U6gst27cGVyWD5A/A1rPiQsDyWYLAWnddZ0jY7iPJed0DeTmTXCMnLYnfF0jW7F2mLZcY5C0ZhfGujB5ewhgVWQ0/C9brsWbAMyGOq8AYhaa1o+XAgzPpkdH6kSvzj/qtguNb3W5kFUz/gIuuD4il7YQhZJ6lXbpQI38bHns77NvbLbrbW5S+yyzJM76DnQl2RrweeV0NKQ/1ztjnd4tiREgvRI4V/WxEMT4BuvnRjruHT4Hq3H4VQbk91u8OyyLsLdvlgOHEpAJWAinorf2ob203idazUTVa9pPT7r8KzTodajQaAfNDAwRFCx3fwGhCFWr0oL0hOqWOwPWbjhC1AD4weiSWpIYQkPq7NHgE1AO3E/ZNjYFgV7+yTKP7ws9G7+wkjeCtl4UEde+7NVK70Bvd0xu+FyJvMnWjEIXmyhpPk1ZdKZAgMCMH2dH5YoA95jzfYHKLluUlGB7f2AJjtj2vBhUQVIfTjUKMAeBeO4pXA7wX0+MPGs8uh5i4i6w3gF6GiWcXTyPYJvjaG6D6WMzKWcOVOdmROZ1RHknEXojfRtbMd4D5efa2i1GC+nF81vje6DHv/nx3rAG4r2Fkawz2282sgRAIgAiNuzg3Loky6WIAmfDCtAYeU6PTZNOklcYbtdgCqIfmDVkQgTSGYFSDJhhfaEYYFmfNYY3tTJjDyZX5NE5hLlAUwvjK1vpdWr9LA/6oOflzbU0ZVrkaPJ6aekIuAjhbjZ3ML3wZbCJwVIyRqPla4HHa4Q8epzoVw65TafZE5WESnTQJ3fjOLhjEbT87uw3ANLuDvQi3kEbS6Idm1FwEIsyzBjHnFagk8+96c1isMusf0UomeS5ifzpZKlBpvv2ivTt/w0dHPkkvxSg04QJN2oXEI7Rc1Y1qtg+coyWMnv85+W5h0IXYpjaumiPoZqITl/GJAzck4oCGSLkxvSIQxgJC7Ucywat4gy2xBjKH3txQhDn04CbTCqnIH5iEID9N4WeFAkunEdp4S9d50U24pjUcaY1mOEY1kjHiE4VHMUarAKKMx7p1uiFgIDUVxxB+FskIWTZ5zVLoH2uMbewCv5AOZmnN5oLUGBMpzo5EQjZjIQxp7ctoTYN2YBXXJiNL0PVgUdePY9uvH0+zObftRGBv0Ow2em/0IxEt2CAOxFVn4ghiIKvRjoQy0NjJvNvJgs0SGXnriTZhTZ0MMjefNog43nLt2hSrBhEOW0ZZCRhRSFpBkRUNXZgqpOrtu9q/e2PeA+jhVFPFoURQbB1e7k3IA4oCC/Efwj+QlGoMpIqC7ERUIowDoEkTelOgIVEOvze7moOJFKBwRlGSfoTmgoDwe1xyVaMyHxjiLgPhv6IrZqXEVy7ojFhLgreITx5Egomh7m3BJEBXOlNxH5EIwEAxZgLJEIOmCdN+GPEgDhS1pS/ISGcgLByR37HpFw43BSC+C+AvsTYCgYfmgVCvmkxj0QM12ULEBVOpphEXdrYRDnDJqKbpn5obO6FmNEZyjFziE6iLBlpA8xyF3uhm/kr8rBwmVwZNuf48dEYTXu63IRz9JUxx7K5xMo/ByMqELtEEO5K5UjOHhZOCeJEm+gNyY0ynzEkO89A9CHa3qO0BhUHn4TCM+tvS2uAv2odqRIp3GAwEIQmaRphMAW4k33CtuuGhOUtB8Fh8JXbaEo2DpSzuv6rJjJNG40wQsESg265scxC+TC3KMqmpOKJ0HyIOEBtjNimiYMJfJCJkoAU6Bxlrwa/e6MrLj7K7+RI2hcjMzTjPvpP6c4l4FIwmd0oDs/HmzkRtnAXJvf4ZuXGcTPnL0entSlEq0YTgF4LUQQAfKvM6rTlwKGcwBRN3MQIS5IAsWp4tuP7tf/6dCbpnP/J3wggTR1JbIt1jJDAujqfdWLSjiwW4ySEVP13aD8XLWXA0Ey8uYiMavAwmwLp46DMNOQ/REAxEkeuWH1PTxOsFV2eZ7dJ3XAnHy32syeNQqnAhZEWOYVJjeAnSItUQSBMtGMpX1m0yrmJx9QXFtIajKJWkwc6rwV1XnoGmsVfgLA91Me6y+QBt2cLroom+0Yj10uSFkyWc1mTXG0LyNKE38BpRo03NhE5Uby7LGl3io2YN0rMRmJdt9nZ0G/uRo0jWwIvgnAXSA/OF9TBcGh0lg0Y1T8ISNCxxlWM+OhuykwVoVLW5oEWncY9aN4KFVZooVazE94j6tzNollp5c+uPwzfWW6bkINz/gsvg6i4122aRf5tBET9nzMc0S7oOYL14TNcbOE1M/J0ur9lYUCdDWkKYDubCGhgPCGS4grToJD/ADrhCwUqpweRd2Ri8mBAPJspzkTUA/dBc9rNy3lJTWV2imFcHpWqEdGkapEcgQc4G1ZPRaefMMzTtG43z7UxprfEQGoyVuEzPLrgiWPEOYdfUvUHSRXxm1ROquQGJajAzb9tPw0ecQLqkRv/EagSvaWRYLmM6uhKqwyXEEtLwkWuFC7XvVyd/NGd66B//Yw0BlHm4nZwNtGh8C3WJC836g6+zaB5N4GQkafx1B8vxldUedQkh3tSbIq60kv+DMsGiWlj57uNQIrGbkR3kFrkJnXYiYLcmyoGYtWru5bckbXH/fPnXYFAa5kZq/4J2Da7+tC+ZD8G76P4N7ofHmY045TeUSXhxIhMRLiMjDhwCT0or0Ug9STEqYI7UW/t7bNxAliOLP8OkRmfE6srLAnuKJNZowWi07EU9xY5NJcMBI4ZCGZUKGCFaLQEZjZj1r9J+sDxjbOKeB5kOU1Mo1Byy5TkwgbQkZa29LPMxERlWOxNvUBucnZcmkj2RfQlWoyB9hQZBrfxDseBDco9VqGK8utsdZRTxE6NQBvo6NoNHEKYdKEO2pPV8Sb/f133jkycB+03uAIOqFWeznAlteFq+T57nmYi0GYVK5vx7y/nz6nmXs0W7nzat/N2k6cBSTphya2U1Xs6I1eRua5P0CCSvR1OrOxr1IddgzMv0Gs5FVItMDNli2rUzLMP0cKt+Pa0xqNlRcCEmZZkXqNRMfkZEmfHpz43uya8Fy728YAW0UhsyL+I+lp/R0yy+t4cVdezBvj/9Zd/Lc61GuVIzBqb2eo6ZH2vtvEVsJykZ66LFf4hbs4gh+Z5o973778saQ++NoG0PX+O5oG3cx1r/tL/nYXL972FmRs386nj+2YtSyKAI/GvD3OSCLBqlNUVVaVlitXUiozkf3YfOOax2XY6izpYlMgM6l3trh5WdiHuI38l1EYntbYbM5SA9EqRoo7E6jB75osm4qYbRosYrKheJsfmv7By1Vw62a9miUD25o76Pe0tWKDJwiN3a61K0T5OxuIMSkCUGc/q9haXJJ/QKlYt9Sh6IfGJv/dOGp4XqtTIGY3eyVJ3lYatpdSujbcbb5MzOnjMSuMm0KzmJFVdOPojM6cnxreebxfPazf5YY5+/NWfbbyv7XOssqF9mOfOVXBz0kP0Nm5L5YdyboD7QxihXodRFOMLa6u37fGnLUYu2es3VwOIwL1sjlu6GYBGMJM41+ilE2JYn2yhmlSHmL2E47OJL9s/acGhqN8vkUImxP/vaaM83kKWROlbyNGKzDeaTg1GflMl57Llm4re0PE+UNaQGJLoNlGuMxxnlUXv3FqdNKEacbwC3sK9lXmMgCyMt4jk1DZvlPITXkrWrBe8Otz2MKM7BjqPtzwO04WpnQ790iKwLUNttlmsJRnCYfve03tr814beVve0z/n6ex72U2L70taKPRcNKladA6WbKrkbTNjTPgSH41zMDx2PPTgKK04VDtSQbAxoSdTCvcTLvmrrdW/kVYrdr7fkXK4PlU5GOmRfZXSqwXI5YKAteRLG31v/tOFp7ftW7LpkfoNcCnaOPAp1YqesL/PR22DUgwCSUZDN2kzxXm8hHH1/CqjMlrmRIeglPIKXo7W7HWOfd2obmUgohtyrZVa6HzpBdhF2IsNcezYlJ/e0/mmDZVAg/mds+l3KeIrFvs/cViKpJ/s5WHuxr09RjCB/fWLPLJcS3g7+QkudTsmGktS+AODS/kzEvrcZgrP5XtQDrn1aMipOW5wsSzAi+6/pdnETBZpCtVzLYTUPxX1v6lm0zQv4Q2woUYWnViwlWQaG+S/+n+WLBS0jNRQiOodxKS0i+0McR/thJj/DziArcxYyF24XzBcZcawQ1EbjO51xFIq+qhyY5VFo4RLWPpRE81LJwWv/yOZEsgTWUje6CaYC+0V8WHe1bDVox9kJhz8ApxAPxg/l6GQDDa6WgbHzJ3EvCoxkOMi3aMKMt1zO9EZtAqzWC8NNKxLJeIB70rPe+qd9uIn2n3aHEAYVSMR6YCmnccj6zjFDgT7B8AD5GsKvl1sCGXcyNz0vcz7HRRD0JnMjXqPWHx47ARnphKWUzliKRVTIyQQ77viztzomzCQ9uvD+E9mZMxKZMuZhWRZtNGfVTCg8rS74sRxMZyi0/mk7K3lIShN/Fi8ZzY9czRCPWhHvXg5l9RCCBXhMEZfV/GA7pV4F6gJ88pZnIQBJq97wcRC5WTQkmt1Ru3DdZ+sx88/2UJHPZ0ZvfqQUdYI/jCQByLR4YY2nFWlYwcXesi48z1f6wPx+Zd+FgNV2vCtWoS18Uu+0eGmeCIUFqsUQIgSF/IzGaXEZLYy3YoxODoKzaiUoZ6cFxeqXCpULEIXyzZZW6B3/2wm/nWwkIRGXHgHVBvs9X9mZ+wHYYR0t0CGkf5y7ZUJAZCQeegewLi0hNy2U33mm5mRycEu0LRCENABviN+QvJW1C4Iat+kdA/EOtTI0329ocN7OiOejQAB51pAMh2G6DuWPsWP6DjKFeN++V0BlwqzkOhxPS0dmx1kShESCfdWhyQSxE3keAJjCJwbSWSVnqHzrcFzGiuik5UJcT4NY6uu383cm/HYsY7IUtPTp5A7nD8P9dHx6gL191VKH2oLuHWuHabJN8XT8b0c/QRrd7mMd7pP7YKm8iv2veufvDOA88lO1d74d7gdTto7rwwO002x1Vm9fLUsio2QpES/obOBYNtHQjpRXvM7OUKBhnaqNNwGwtYBUfwlpkz6mEOvEBFLsfTnL5Qlky4f5kQJvoRIqwgE55CXm000XBnkuD1KgOssK5Py6PUmS4+ixFWEOb6hgEdsVIK8PbA6WyggrjhRAXC/LY5TRyicohcKK/XZIarBPZI1Bt2ytYfUhJuoHMDpiChR3a6JcPUhMvC0EsOJyrdC7kKK0hMQz5rU54JT77fydIU0RSKCStijFqPBKkU+xaqjRbZaLyDiXclmOIeAWgb0bcyg8GwzQvlyIBAuG3VcmZLdSIotz779Ksv8qCahVDmaloMiZf1bH74Rt6chsUGVUZBxvIOOyy1TFHm7v0XTrBKv5iQ0Y5wReekw94eEs4n4FkPMhwp0pETy0KMVi1l5o7uMJsqfZomFCiwJvVrbNFBJq7x0C6iLw1GkcBPEMivaO/+38fQWaFOun0PGAdJMMOmTNtOWX4SDWz/ZM7RiTFXcDGeGmOW55BjRIdSkvXYd8suAaYT5RBet8YUSJwm0hpEi4mviVJvwkHWe1K8KS5jwEHvscCjUGC3wKc8w2G4AP0qJWotNYXHWuBKU5nZwGCnD6ieKfHtKu2/l5UCQ/0TvZKnbkN4J13s6qeoR8iSwLf5zle09gSk340kFleFDlZCnup/N3Jvx2cg9oGwTO6QZeghnfsGiBPUieZp4ygMKLEoVyjtOB5+ZAnNsC2qZ12n66Axf7dpkxl3+6NUeHOpRL3J7O+cC5pJUTP+qdVnsUGuRX4TmUMtYeC7Eosv8YWDJODQoDs9abAnEZOXCmBZVJSpBTD+RJqyGVtQLpUq/DkW+u985LQKWHTi2IzMBqyh9zoxYsttKa3glP52shY4xNAtNJWSkEInpMtI0nZ4NSWgM+Dh3nfYk39w4ILuA+gW6lYzMzjwSbatPerWKH9S2PZCU3VI1YBc4HT71bqNmV5Kbfzt6hXQ8xw8J7yPnK7WuoLvYORkOmnk6xJbAOeYlrK97zgoiAwNi8FZ4nwSuqzUlthmJxYzl+qtiLHCz46QLF9zOSROgsjGzhaOtc7rfzdyb8dqzApvO8jtsAbmO85SH3QQQQKntYkYyZ07e08vRtV4f50sxbeJkCFYNx7LiPv+ZCdf1X7nXCNH2pxaIc69sIeeoMNSIyTlSEL4t4F0Nzi57EIiguLt4SYdSRE/Pk/axiA57dXw9YJrxmMUAA86sFi9bOTrvTKl96LxsiI6tqsVb3tXH3KKvFSQloJN6KEZrSvOOMx1wNM3GOXIBMEThKeNqgHjb0sLpyQ1IG7Tqmqv6Jj1pk1nqY/bFdVGUYMIqaDWbFemGmrls+eLSY1QQkjwdvGXqL1yaLWybtjJifSKQBiqfn/3od6xhMfVBP6iDHafGO3KFMsbiifnYOb+BWwYcVasoNWLClZirCSo/bGaJoBil8nX37oRcOqwWZ/SlLF+06bRFL+RDRs2mlJ1IfrOY7m6+iAMOtVACm3iPpMPiX25tF1aQWbW1WhVFhRnbuZ/KnQY/FTcL0MlTUUwRBZKu6DpeGT8St4wjqn/XUxOuopf4mM/0W52oUsMqbh3KbTRGlXLQ60ohNPmG0Oq4NQH4xG1v+XHkPvPTVtHr1+rmGMCat11aeeFajdliQN1i+SRhAbgvITFTLU7tXh9DzCrrulZuLKLzVH39aqR0j7Jsl/gMFWPrxYZfY2rvN1ku9VpmKysCv9fgUG71PLbp7iLJOHwhJn+R+LuIaZoMEa49tH8AsA5VEn85cLT4ltm4Yi2S8G3vqvV4NAiI8sM6AVcMKl596nl0udArXE4OyKDb5NeJM/okvWYTs6f13DoAwy69fVBTri5siSkMGlfSL5dDfxFPJn0slqGFQL/QnJ0VOmX8ZSHkH27/ZMsKsea6EkXg9LV+H7BaFCPlq3zGUyaJML8EP8/JJ+opGCBOI4+FS6AkTpN6jwgAQUA/3QAYZtWyVtN612X+1p6WDgciaf+JG0U+/vfD05FroiXUaVDu1UjslKfh12yjEhsoFHiaaM4bJqsDOW1poOEK7BBNDTMViNFehIlYmAFb11+PbQ26O2SjdkenXfnvy43kEZ0t3S85bp5KVzNdMlK6KGUglSJz2BBZZVt043h+854SbZ9Ysz2zkDOfvf3siXlQGqfdR7/tEcw7z4E+PDHLi3pZZTr+oYCuhx4dr+On/6F13Mie7S0spEwQHjKPFj397mQiPp55SfxuDqP5FCtr8g8WTes/+ovf+Oxf+errLKZ43WUb9xITwOqPFeE5LxBMGmWIbSTZTrgFuaSO59JG6W2bXUSncfmecNHTMH4vsnOF1kYHvMRzL3gq3S0+1p827V94TVS8723kyuqe3yjfqZZvvL5ul9Zt9d/Gpxu62ZSRmXhHtfhvbfrXj7B7XPDfB6Sfmwqh+e2GQMoXLKidbyXr2aDWxK2U8VL5qTqsUpA7vmxoN7czh5i8/+K2ve5GqvahmrZBRzZV6BXQ9DWIVnrejqGb9vbNboh97Qhan3HWL6Ibsn1APYQ0o5uODF6HACrGR3yAoa9ESzZiefBettBDI0xV3LKm72tiEknopKe9MgBjdbygETfjrhv+6hEgKGU8CF1Y0+kR0xH6A61boKcd2vVln+etpI9hTLaTReM/H/UYlemQAvnHaG1Tmba2SyAhhtWyr/aoo1ux7XIHlWYdJNil6Mh2PG7aIlkUOPvkviKCuhRH+QV2BGRMKDm0kFvAHiWbvzq5KxAPcmlt3x/6/s6tdamfNXRP9ATuTQM3pt1v4HwqkA6uR0gEEMIFbq7yywE+zH8YLFGLW3goko3CA6B6WMLrFm7e+8E8iHJRA6saooJF9fU1Chy5zQw5KSpCl5dBwPQ6vNIQqT53kq/3mqQSc9qXYO1my57x/gyMQFX9zr4tXtN857Y0XnLcWKq+c8T6QNPeWfjVeEGrC5FZHs3vpociHTKH4t9xe7gz8b9b3/2Z9/29+rV6O0DC5o8OLiDElkfjKaW+UaZcU2YK1J3l69CB1H9qJ7kEIXTO00P1+5fKpKnmIdfePTxcHmbdDBsAK0qjyttXERe6b0ecE3p9attKx2+89xJBPXkHoLrHJCDXLPZ5OE8yOtHSLUPLByPCAbDNzhnV/vCtB+Bg8BcUnGmJpmacrU9O7V1gJ5tD9uvLlbCA6FShiUXf/65orhBVZHZdrb7v2O9+8soDn03AOK9d8iBlRwn+EYDaAifgs78xEY6veH2evnBRNHZkrmKbjRQ6rXa0U1ImK8v6G9ol/OOBvN/fSKdd0E7m5ItoYe8Zhc4bhzYEZzorJfJmMGdaoTnJ5BADWP2+2mYsrT2iOtzwSaEgX5GURybiMlz5dXus4jRZZvkFeHH7H68eQntqsJEmzmCxx/del7kgOuqevhASP8WuZSwqIQi/mwBpunWh3T2Au96/bo/QLM8XrEkXL7HjnSaaezcR9eR0ixPzm7Qb5Ja0Fr/dD4/xlSPIrS9u6pf2lafydEDOZIntdyx1Hd4T2qu9sil/5XzPkW128Og3yo1EJUp68okt5607AnDzw//TD0yeYPAUULPc48KuXZWKJhBjYaljSwq2sbIKyiqkXNlufmDQUioCRdDdxT/qPYzLD+Wc5BUhkyY3mGGmWxyq30RbKp1nB2SqMea1p68bR4lGiJz59wqmtB33RnsyweFGjBWKpJaN05s/+BfuPLHhEdSv9Ovsesuj91V5NWm2iqXN/7KFMNlB0ha3O3Z79EpVg/9uECMrR7CW1gF2eZOyq78XKZtopQLbnauzKvQdevr4Rb0x/Fg6z9rtGkSz9FCjiGX4nATqhH1wslAxgN8ogzZ7sdUKfrL61WFyR8iYLP8oXHIyfVHcWgyyYfMC+pjtZ1XGPDVKHsciWBYpUZT8pQz2/iZziq6d/J00yzI+K0uR4D8+skf5WA76K6/0lOvs/DgRhHVGbp66UV1aCX+21OOF4sn4GuwVDjEiemGWZTQtMmR3ZHkOiqQkvCwzaLl5dYC0ssrR5m/O+pb1b7eWsKHzenYdujjaF11MRGP3b/lZ96UYvu/rbq4SJmuWkLd1ztU1mrzUKRmUg5MKdhf7k8HiR6IIuv0UgzkXPThWclc1clnJziyz/rstlGfhvajK1NBmKP0bA1hPAHzMPfPY6bvvjg7ePiTZsRLC/Wz7v8ORBeO/Ikity+ddu5qeXNpF81br3g6OfekIJv1vWDo5eoj/LV5U9CLePwWIKrbh+tznIibI8+VP7QbUkwvfZe8K8Vr8zzRsBQw3jJGBQqG5ITBne4XS52WtzlP383XoR08fImBVbhboJXFhN5qpl8RYBdPWXwGs7UOKfnugmIPR/DsL/HmTtK5t/3gPutSeXtFULIyIPVfO7Mw+8U+22l9uG84ck0m1F8nIheF2C7P8dsKWApPjn1f/BCLJM/2GKX7reD+yby3Vg7quF9Vdi/Nn+XycA/mJGnhrw1eqzeKvgz19bjJlibfmLkO7Xn/vWXN0ULOgZJgu/U41w+u/cU9k9wlz6CKg24l0jS0b3nfREs6ggFmvoSyILQkeTyzd/B7jj/w7+3zfhfw8yseJKXiZZzXAM+xFeicLSgczKbASOu/134P/3IPzvweOgtdHFCP72tuubu8mPyjKTZiIOrF2Vq6Y8921cn/LJTti0TYk8/DI1s7x/LpjHfmcKg39p13e2185kk8P/AUrqYkahTAAA").split(","));function Ix(t){return Fx(t.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}function Fx(t){let e=t.indexOf("1");if(e===-1)return[t];{let r=t.substr(0,e),i=Fx(t.substr(e+1));return ie(i.map(o=>[r+"l"+o,r+"i"+o]))}}var qF=l(()=>Ox(Lx())),rc=3;function Ox(t){let e=new jo,r=[];for(let i of t)i.length<rc?r.push(i):e.add(i.slice(0,rc),i);return{trie:e,small:r}}function jF(t,e){let r=Xb(jp(t.toLowerCase().normalize())),{small:i,trie:o}=e==null?qF():Ox(e);for(let n of[r.replace(/[^a-z]/gi,""),...Ix(r)]){let s=i.find(a=>n.includes(a));if(s!=null)return s;for(let a=0;a<n.length-(rc-1);a++){let m=o.get(n.substr(a,rc));if(m!=null){let c=n.substr(a),d=m.find(w=>c.startsWith(w));if(d!=null)return d}}}}function HF(t){return jF(t)!=null}function Ol(t){let e=10,r="";do r=t();while(e-- >0&&HF(r.replace(/[^a-z]/gi,"")));return r}var Rx=BigInt(0);function Md(t,e,r=0){if(!isFinite(e)||t<=1)return[];let i=[];if(e===0)i.push(0);else for(;e>0;)i.push(e%t),e=Math.floor(e/t);for(;i.length<r;)i.push(0);return i.reverse()}var $o=class{constructor(e,r,i=Lr){this.name=e;this.numerals=r;this.decodePreparser=i;this.base=r.length}digitsToNumerals(e){return e.map(r=>this.numerals[r]).join("")}encode(e,r=0){if(!isFinite(e))return"";let i=e<0;return i&&(e=Math.abs(e),r--),(i?"-":"")+this.digitsToNumerals(Md(this.base,e,r))}encodeBigInt(e){if(typeof e!="bigint")throw new Error("bad input");if(e===Rx)return this.numerals[0];let r=[],i=BigInt(this.base),o=e;for(;o>Rx;)r.push(Number(o%i)),o=o/i;return this.digitsToNumerals(r.reverse())}encodeBuffer(e){if(e==null||e.length===0)return"";let r=[0];for(let i of e)for(r.forEach((o,n)=>{i+=o<<8,r[n]=i%this.base,i=Math.floor(i/this.base)});i>0;)r.push(i%this.base),i=Math.floor(i/this.base);return this.digitsToNumerals(r.reverse())}decode(e){return f(this.decodeBigInt(e),r=>{if(r>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(r)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(e==null||T(e))return;e=de(this.decodePreparser)?this.decodePreparser(e):e;let r=e[0]==="-";r&&(e=e.slice(1));let i=BigInt(this.base),o=BigInt(0);for(let n of e){let s=this.numerals.indexOf(n);if(s<0)return;o=o*i+BigInt(s)}return r?BigInt(-1)*o:o}randomChars(e){return this.encodeBuffer((0,kx.randomBytes)(e+3)).slice(1,e+1)}safeRandomChars(e){return Ol(()=>this.randomChars(e))}randomUid(e=20,r=5,i="-"){return zo(this.randomChars(e),r).join(i)}safeRandomUid(e,r=5,i="-"){return Ol(()=>this.randomUid(e,r,i))}tokenEql(e,r,i){let o=this.normalizeToken(e),n=this.normalizeToken(r);return o.length>=i&&o===n}normalizeToken(e){return this.decodePreparser(e.trim()).split("").filter(r=>this.numerals.includes(r)).join("")}},L5=new $o("hex","0123456789abcdef",t=>t.toLowerCase()),Qo=new $o("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),GF=new $o("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",t=>t.toLowerCase()),Yn=new $o("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",t=>t.toLowerCase()),ic=new $o("TokenRadix","0123456789abcdefhjkmnpqrtuvwxy",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9")),F5=new $o("AlphaRadix","abcdefghjkmnpqrtuvwxyz"),I5=new $o("NumericRadix","0123456789",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9"));function oc(t,e){let r=t.toUpperCase().normalize(),i=e.toUpperCase().normalize();return Ri(()=>r===i?1:void 0,()=>T(t)!==T(e)?0:void 0,()=>t.length===1&&e.length===1?0:void 0,()=>{let o=_x(r),n=_x(i),s=KF(o,n).length;return 2*s/(o.length+n.length)})}function _x(t){return t==null||t.length===0?[]:t.slice(0,-1).split("").map((e,r)=>e+t[r+1])}function KF(t,e){let r=Kp(t,e),i=[];return r.forEach(o=>{let n=Math.min($r(t,s=>s===o),$r(e,s=>s===o));be(n,()=>i.push(o))}),i}function Nx(t){let e=t+`
`;return O?e.replace(ao,`\r
`):e}function zi(...t){return ie(t.map(e=>h(e).split(ao)))}var Hx=v(require("fs")),Rl=v(require("fs-extra")),Xn=v(require("path"));var ya=v(require("fs-extra")),Ad=v(require("path"));var Pd=v(require("crypto")),Bx=v(require("fs"));var Cx=192;async function nc(t,e){let r=Pd.default.createHash("sha512"),i=0,o=x(e?.msbits,Cx)/8;return await ge(t,n=>new Promise((s,a)=>{let m=Bx.default.createReadStream(n,{autoClose:!0});m.on("error",c=>a(c)),m.on("data",c=>{i+=c.length,e?.observer?.onProgress(i),r.update(c)}),m.on("end",()=>s())})),r.digest().slice(0,o)}function JF(t,e=Cx){return Pd.default.createHash("sha512").update(t).digest().slice(0,e/8)}function Or(t,e=9,r=Qo,i=224){return r.encodeBuffer(JF(t,i)).substring(0,e)}function Yo(t,e=24,r=Yn,i=224){return Or(t,e,r,i)}var zx=v(require("fs")),kl=v(require("fs-extra")),Ux=v(require("util")),ga=v(require("zlib"));function $F({message:t,cause:e,retriable:r,ignorable:i,fatal:o,doNotSend:n}){let s=[t];j(Qe(me(e),"Error: "),m=>s.push(m));let a=Zb(G(s)).join(": ");return o=o||a.includes(ce),r=(r||a.includes(Zs))&&!a.includes(Vt),n=n||!a.includes(ho),i=i||a.includes(vl),Wu(qu(a),o?ce:void 0,n?Yr:void 0,i&&!o?vl:void 0,!r&&!o?Vt:void 0,r&&!o?Zs:void 0)}var le=class extends Error{constructor({cause:e,message:r,retriable:i=!0,ignorable:o=!1,fatal:n=!1,doNotSend:s=!1}){super($F({message:r,cause:e,retriable:i,ignorable:o,fatal:n,doNotSend:s}));this.cause=e,e!=null&&(this.stack=e.stack),this.retriable=i,this.fatal=n}};var Vx=v(require("stream"));var Ed=class extends Vx.Writable{constructor(e){super(e);this.deferred=new mt("WritableToBuffer");this._buf=[];this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",r=>{this.deferred.reject(r)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,r,i){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,r)),i()}};var QF=l(()=>p("zcat"));async function Wx(t,e){try{return y(sc(t,e),h)}catch(r){QF().warn("zcat failed to read "+t,r);return}}async function Dd(t,e,r){if((await(0,kl.stat)(t)).size===0)return;let o=[],n=[(0,zx.createReadStream)(t,b({autoClose:!0},r)).on("error",s=>o.push(s))];if(t.toLowerCase().endsWith(".gz")?n.push((0,ga.createGunzip)().on("error",s=>o.push(s))):t.toLowerCase().endsWith(".br")&&n.push((0,ga.createBrotliDecompress)().on("error",s=>o.push(s))),n.push(e),await $n(n),_(o))throw new le({message:"zReadFile("+t+") failed",cause:o[0]})}async function sc(t,e){if((await(0,kl.stat)(t)).size===0)return Buffer.from([]);let i=new Ed;return await Dd(t,i,e),await i.buffer}async function qx(t){return JSON.parse((await sc(t)).toString())}var YF=(0,Ux.promisify)(ga.gzip);async function jx(t,e){let r=k(e),i=await YF(r);return(0,kl.outputFile)(t,i)}var XF="readdircache",ZF=l(async()=>{let t=(0,Ad.join)(u.cacheDir.valueOrDefault,XF);return await(0,ya.mkdirp)(t),t},E);async function eI(t){return(0,Ad.join)(await ZF(),...zo(Yo(t)+".json.gz",2,3))}var Ld=l(()=>p("Readdir"));function Fd(t){return t!=null&&M(t.basename)&&kp(t.isFile)&&kp(t.isDirectory)}B(()=>{W(()=>ac.prior()?.clear()),Xt(t=>{t==null?ac.prior()?.clear():ac.prior()?.deleteIf(e=>e.startsWith(t))})});var ac=l(()=>new Vi({maxSize:500,timeoutMs:q,clearEveryMs:E}));async function Id(t){let e=await ac().getOrSetAsync(t,()=>tI(t));if(e==null)throw new Error("readdir() timeout for "+t);return e}async function tI(t){let e=await eI(t);try{let o=(await(0,ya.stat)(e)).mtimeMs;if(Date.now()-o<u.readdirCacheSeconds.valueOrDefault*S){let n;if(await Ve(async()=>(n=await qx(e),n!=null&&Array.isArray(n)&&n.every(Fd)),{timeoutMs:q-S,timeBetweenMs:250}))return n}}catch(o){o.code!=="ENOENT"&&Ld().debug("Failed to read from readdir cache",o)}let r=await da((0,ya.readdir)(t,{withFileTypes:!0})),i=Qb(r.result.map(o=>({basename:o.name,isFile:o.isFile(),isDirectory:o.isDirectory()})),o=>o.basename);if(r.elapsedMs>=500)try{await jx(e,i),Ld().debug("Wrote readdir cache for slow directory",{nativePath:t,elapsedMs:r.elapsedMs})}catch(o){Ld().debug("Failed to write to readdir cache",o)}return i}var _l=class{constructor(e,r){this.base=e;Fd(r)?(this.isFile=r.isFile,this.isDirectory=r.isDirectory):(this.isFile=r.isFile(),this.isDirectory=r.isDirectory()),r instanceof Hx.Stats&&(this.size=r.size,this.mtimeMs=r.mtimeMs)}},Gx=l(()=>p("DirectoryEntry")),kr=class{constructor(e,r){this.dir=e;this.dirent=r;this.nativePath=(0,Xn.join)(this.dir,r.base),this.ext=hi(r.base).ext}static async for(e){let r=hi(e);try{let i=await(0,Rl.stat)(e);return new kr(r.dir,new _l(r.base,i))}catch{return}}async join(...e){return kr.for((0,Xn.join)(this.nativePath,...e))}get base(){return this.dirent.base}get name(){return sr(this.base,this.ext)}get pathnames(){return this.nativePath.split(Xn.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}get isRoot(){return this.dir===(0,Xn.parse)(this.dir).dir}parent(){let e=hi(this.dir);return e.dir===this.dir?this:new kr(e.dir,{base:e.base,isFile:!1,isDirectory:!0,mtimeMs:void 0,size:void 0})}async childNames(){try{return this.isDirectory()?(await Id(this.nativePath)).map(e=>e.basename):void 0}catch(e){Gx().warn("childNames() failed to readdir("+this.nativePath+")",e);return}}async children(){try{return this.isDirectory()?(await Id(this.nativePath)).map(r=>new kr(this.nativePath,new _l(r.basename,r))):void 0}catch(e){Gx().warn("children() failed to readdir("+this.nativePath+")",e);return}}async visitDescendantFiles(e){for(let r of D(await this.children()))await(r.isFile()?e(r):r.isDirectory()?r.visitDescendantFiles(e):void 0)}async filterDescendantFiles(e){let r=[];return await this.visitDescendantFiles(async i=>{await e(i)===!0&&r.push(i)}),r}stat(){return(0,Rl.stat)(this.nativePath).catch(()=>{})}async size(){return Pe(this.dirent.size,()=>y(this.stat(),e=>e.size))}async mtimeMs(){return Pe(this.dirent.mtimeMs,()=>y(this.stat(),e=>e.mtimeMs))}unlink_(){return(0,Rl.unlink)(this.nativePath)}};var rI=64,Nl=class extends ke{constructor(){super(rI);B(()=>Xt(e=>this.clearFromPath(e))),B(()=>W(()=>this.clear())),this.on("expire",(e,r)=>r?.clear())}clearFromPath(e){T(e)?this.clear():this.visit((r,i)=>{r.startsWith(e)&&i.clear()})}};var Kx=v(require("stream"));var Zn=class extends Kx.Transform{constructor(){super({objectMode:!1,autoDestroy:!0})}async _transform(e,r,i){let o=(h(this._prior)+h(e)).split(ao),n=o.pop();this._prior=n===""?void 0:n;for(let s of o)this.push(s)||await at(1);i()}_flush(e){this._prior!=null&&this.push(this._prior),this._prior=void 0,e()}};var lc=v(require("timers"));function iI(t){return t!=null&&M(t.path)&&M(t.op)&&Ie(0,100,t.pct)}var Od="progress";function kd(t){iI(t)&&ue.emit(Od,b(b({},t),{pct:et(ee(0,100,t.pct))}))}function Jx(t){ue.on(Od,t)}function $x(t){return ue.removeListener(Od,t)}function Bl(t,e,r=!1){let i=r?Date.now()+e:0,o=0,n=(...s)=>{let a=Date.now();if(a>=i)return i=a+e,o++,t(...s)};return n.count=()=>o,n}var mc=500,Xo=class{constructor(e,r,i=mc){this.context=e;this.total=r;this.throttleMs=i;this.start=Date.now();this.emit=Bl(()=>{kd(b(b({},this.context),{pct:this.pct,elapsedMs:this.elapsedMs}))},this.throttleMs,!0)}incrProgress(e){this.onProgress(e+x(this.current,0))}onProgress(e){this.current=ee(0,this.total,x(e,x(this.current,0)+1)),this.emit()}get pct(){return et(100*x(this.current,0)/this.total)}get elapsedMs(){return Date.now()-this.start}},es=class{constructor(e,r,i,o=mc){this.ctx=e;this.total=r;this.progress=i;this.throttleMs=o;this.start=Date.now();this.onInterval=Bl(()=>y(this.progress(),n=>this.emit(n)),this.throttleMs),this.timer=(0,lc.setInterval)(()=>this.onInterval(),mc)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){f(e,r=>kd(b(b({},this.ctx),{pct:100*ee(0,this.total,r)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>mc&&this.emit(this.total),this.end()}end(){f(this.timer,e=>(0,lc.clearInterval)(e)),this.timer=void 0}};var ts=v(require("path")),Xx=v(require("process"));var Qx=v(require("fs")),Rd=v(require("path"));function Yx(t){let e=[];for(;t!==(0,Rd.dirname)(t);)t=(0,Rd.dirname)(t),e.push(t);return e}function oI(t){try{return(0,Qx.readdirSync)(t)}catch(e){return[]}}function uc(t,e){let r=oI(t);return e.every(i=>r.includes(i))}var _d=l(()=>(0,ts.dirname)(process.execPath)),Rr;(function(c){c.Root=l(()=>{let d=["icc","migrations","public","views"],w=[];Oe()&&w.push("/ps/app"),Xr&&w.push((0,ts.join)(_d(),"resources"),(0,ts.join)(_d(),"..","Resources")),w.push(...G([_d(),(0,Xx.cwd)(),__dirname])),kb(w);for(let P of w){if(uc(P,d))return P;for(let A of Yx(P).slice(0,4)){if(uc(A,d))return A;let V=(0,ts.join)(P,"node_modules","photostructure");if(uc(V,d))return V}}throw new Error("Failed to find project root. Looked in "+w)});let e=d=>l(()=>(0,ts.join)(c.Root(),d));c.Bin=e("bin"),c.ICC=e("icc"),c.Migrations=e("migrations"),c.Public=e("public"),c.Tools=e("tools"),c.Views=e("views");async function m(d=c.Root()){return fe?new RegExp(`^\\/Volumes\\/${Vn}[^\\/]*\\/${Vn}.app\\/`,"i").exec(d)!=null:!1}c.isInDMG=m})(Rr||(Rr={}));function Zo(t,e,r){let i=new Zx(e,r,!0);return i.read(t),i.done}var Zx=class{constructor(e,r,i=!0){this.sep=e;this.onData=r;this.filterBlanks=i;this.incompleteChunk="";this.done=new Ot}onChunk(e){if(e==null)return;let i=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=i.pop(),i.forEach(o=>{(!this.filterBlanks||M(o))&&this.onData(o)})}clear(){this.onChunk(""),M(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",r=>this.onChunk(r)),e.on("end",()=>{this.clear(),this.done.resolve()}),this}};var tT=O?"wip-":".",Nd=new Nl,ii=class{constructor(e,r){this.dirent=r;this.bflog=l(()=>p("BaseFile("+this.nativePath+")"));this._childDirectoryEntries=l(()=>y(this.directoryEntry(),e=>e.children()));this.stat=l(()=>this.trap("stat",()=>$e.default.stat(this.nativePath).catch(()=>{})),ii.attrTTL);this.statSync=l(()=>this.trapSync("statSync",()=>it(()=>vr.default.statSync(this.nativePath))),ii.attrTTL);this.shaResult=l(async()=>{let e=await this.size();if(e===0||e==null)return;let r=e>5*_i?new Xo({op:"Computing SHA of",path:this.nativePath},e):void 0,i=await ri(()=>this.trap("sha",()=>nc([this.nativePath],{observer:r}))),o=f(i.result,n=>n.toString("base64"));return{elapsedMs:i.elapsedMs,buffer:i.result,b64:o}},ii.attrTTL);if(r!=null)this.nativePath=r.nativePath,this.dir=r.dir,this.base=r.base,this.name=r.name,this.ext=r.ext;else{this.nativePath=ei(e);let i=hi(this.nativePath);this.dir=i.dir,this.base=i.base,this.name=i.name,this.ext=i.ext}this.posixPath=Zr(this.nativePath),Nd.set(e,this)}toJSON(){return{nativePath:this.nativePath}}[eT.inspect.custom](){return this.toJSON()}static async withFastestAccess(e){let r=L(e),i=await Promise.all(r.map(o=>o.shaMs()));return r[Cp(i)]}static forPosix(e){return e instanceof ii?e:this.for(e.split("/").join(en.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(e instanceof ii)return e;let i=Nd.get(e);if(i!=null)return i;let o=ei(e);return Nd.getOrSet(o,()=>new ii(o,r))}static clear(e){Fr(e)}for(e,r){return ii.for(e,r)}clear(){return this.dirent=void 0,this._childDirectoryEntries.unset(),this.stat.unset(),this.statSync.unset(),this.shaResult.unset(),this}clearThisAndParent(){return Fr(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return e==null?!1:e instanceof ii?this.nativePath===e.nativePath:this.nativePath===ii.for(e).nativePath}get isUNC(){return gd(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return Ju(e,this)}async directoryEntry(){return this.dirent==null&&(this.dirent=await y(this.stat(),e=>new kr(this.dir,new _l(this.base,e)))),this.dirent}async childDirectoryEntries(e){let r=await this._childDirectoryEntries();return r==null||e==null||R(r)?r:await Go(r,e)}_directoryEntryChild(e){return this.for((0,en.join)(this.nativePath,e.base),e)}childNames(){return y(this.childDirectoryEntries(),e=>e.map(r=>r.base))}async children(e){return(await this.childDirectoryEntries(e))?.map(r=>this._directoryEntryChild(r))}async childFiles(e){let r=[];for(let i of D(await this.childDirectoryEntries()))if(i.isFile()){let o=this._directoryEntryChild(i);(e==null||await e(o))&&r.push(o)}return r}async childDirectories(e){return y(this.childDirectoryEntries(),r=>Kn(r.filter(i=>i.isDirectory()).map(async i=>Sx(this._directoryEntryChild(i),e))))}childrenSync(){return x(this.trapSync("childrenSync",()=>vr.default.readdirSync(this.nativePath).map(e=>this.join(e))),[])}async hasChildren(e){let r=await this.childNames();return _(e)?fu(r,e):_(r)}async hasNoChildren(){return await this.isFile()||R(await this.childNames())}async visitDescendants(e){return y(this.children(),async r=>{for(let i of r)await i.visitDescendants(e),await e(i)})}async descendants(e){let r=[];for(let o of D(await this.childFiles()))await e(o)&&r.push(o);let i=await this.childDirectories();if(i!=null)return await Bi({name:"descendants",laters:i.map(o=>()=>y(o.descendants(e),n=>r.push(...n)))}),r}async ancestorWithChildren(e){return await this.hasChildren(e)?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}async siblings(e){let r=this.parent();return(await this.siblingDirectoryEntries(e))?.map(i=>r._directoryEntryChild(i))}async siblingDirectoryEntries(e){return this.parent().childDirectoryEntries(async r=>r.base!==this.base&&(e==null||await e(r)))}async selfAndSiblings(){return this.parent().children()}async firstExistingSelfOrAncestor(){return this.isRoot||await this.exists()?this:this.parent().firstExistingSelfOrAncestor()}get pathnames(){return this.nativePath.split(en.sep).filter(e=>e!=null&&e!=="")}get pathnamesWithoutDrive(){return O?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(O?1:0)}get isRoot(){return this.pathnames.length===(O?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return e!=null&&(this.nativePath===e.nativePath||cu(e.pathnames,this.pathnames))}isDescendantOf(e){return e!=null&&e.isAncestorOf(this)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){let e=this.parent();return this.isRoot?[]:[...e.parents(),e]}async normalize(){return this.isUNC?this:await this.exists()||this.isRoot?this:y(this.parent().normalize(),async e=>{let r=await e.childNames();if(_(r)){for(let o of r)if(o===this.base)return e.join(o);let i=this.base.normalize();for(let o of r)if(o.normalize()===i)return e.join(o);if(fe||O){for(let o of r)if(Ye(o,this.base))return e.join(o)}}})}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return R(e)||br(["."],e)?this:nx(e[0])?this.for((0,en.join)(...e)):this.for((0,en.join)(this.nativePath,...e))}joinYMD(e=new Date){return rb(e?.getFullYear(),e?.getMonth(),e?.getDate(),(r,i,o)=>this.join(h(r),Ct(i+1),Ct(o)))}child(...e){if(R(e))return this;let r=ie(e.map(i=>i.split(en.sep))).filter(i=>i!=="..");return this.join(...r)}async trap(e,r,i="warn"){try{return await pt("fs."+e,r)}catch(o){this.bflog().log(i,`trap: ${e}() failed: ${o}`);return}}async trapOr(e,r,i="warn"){try{return this.bflog().trace(`trapOr ${e}()`),await r(),!0}catch(o){return this.bflog().log(i,`trapOr: ${e}() failed: ${o}`),!1}}trapSync(e,r){try{return this.bflog().trace(`trapSync ${e}()`),r()}catch(i){this.bflog().warn(`trapSync: ${e}() failed: ${i}`);return}}async exists(){return this.dirent!=null||await Ww(this.stat())}existsSync(){return this.dirent!=null||this.statSync()!=null}async notExists(){return ct(this.exists())}mtime(){return y(this.stat(),e=>e.mtime)}mtimeMs(){return y(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return y(this.stat(),e=>Ii(e.mtime))}async lastModifiedUtc(){return y(this.stat(),e=>e.mtime.toUTCString())}statTimes(){return y(this.stat(),e=>H([e.birthtimeMs,e.mtimeMs,e.ctimeMs].filter(r=>r!=null&&r!==0)))}maxStatMs(){return y(this.statTimes(),Au)}maxStatDate(){return y(this.maxStatMs(),e=>new Date(e))}minStatMs(){return y(this.statTimes(),aw)}minStatDate(){return y(this.minStatMs(),e=>new Date(e))}size(){return y(this.stat(),e=>e.size)}async access(e){try{return await $e.default.access(this.nativePath,e),!0}catch{return!1}}isExecutable(){return this.access(vr.default.constants.R_OK|(O?0:vr.default.constants.X_OK))}isReadable(){return this.access(vr.default.constants.R_OK)}isNotReadable(){return ct(this.isReadable())}isReadWritable(){return this.access(vr.default.constants.R_OK|vr.default.constants.W_OK)}isNotReadWritable(){return ct(this.isReadWritable())}isHiddenPosix(){return this.base.startsWith(".")}async isEmpty(e=0){if(await this.isDirectory())return _(await this.childNames());{let r=await this.size();return r==null||r<=e}}isNonEmpty(e=1){return ct(this.isEmpty(e))}async isNonEmptyFile(e=1){return await this.isFile()&&await this.isNonEmpty(e)}async modifiedGTE(e){return y(this.mtime(),r=>Ii(r)>=Ii(e))}async modifiedCloseTo(e,r){return y(this.mtimeMs(),i=>Math.abs(i-e)<=r)}async isRecent(e){let r=await this.maxStatMs();return r!=null&&r>Date.now()-e}async modifiedGT(e){if(e!=null)return y(this.mtime(),r=>Ii(r)>Ii(e))}async isDirectory(){return this.dirent!=null?this.dirent.isDirectory():ye(this.stat(),e=>e.isDirectory(),()=>!1)}async isNotDirectory(){return ct(this.isDirectory())}isDirectorySync(){return this.dirent!=null?this.dirent.isDirectory():Z(this.statSync(),e=>e.isDirectory(),()=>!1)}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile(){return this.dirent!=null?this.dirent.isFile():this.stat().then(e=>C(e).map(r=>r.isFile()).getOrElse(()=>!1))}isFileSync(){return this.dirent!=null?this.dirent.isFile():C(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>$e.default.rmdir(this.nativePath),e)}async mkdirp_(){try{await $e.default.mkdirp(this.nativePath)}catch(e){if(e.code!=="EEXIST")throw e}if(await Ve(()=>this.clear().isDirectory(),{timeoutMs:2*S,timeBetweenMs:200})===!1)throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return await this.clear().isDirectory()||this.isRoot?this:this.trap("mkdirp",async()=>this.mkdirp_())}mkdirpSync_(){return $e.default.mkdirpSync(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",()=>this.mkdirpSync_())}sha(){return y(this.shaResult(),e=>e.b64)}shaMs(){return y(this.shaResult(),e=>e.elapsedMs)}async writeStream_(e,r){return await $n(L([e,f(r?.onProgress,i=>new hd(i)),$e.default.createWriteStream(this.nativePath,r)])),this.clearThisAndParent()}async writeJsonMaybe(e,r={}){return this.trap("writeJsonMaybe",()=>this.writeJSON_(e,r))}async writeJSON_(e,r={}){return await this.parent().mkdirp(),await $e.default.writeFile(this.nativePath,k(e,r.replacer,r.spaces),b({flag:"w"},r)),this.clearThisAndParent()}readJson(e="warn"){return this.trap("readJson",()=>ti(async()=>await this.isNonEmptyFile()?$e.default.readJson(this.nativePath):void 0,{maxRetries:1,onRetryWaitUntil:()=>It(e==="warn"?250:25),errorIsRetriable:r=>r.errno!==-2}),e)}readJsonSync(){return this.trapSync("readJsonSync",()=>$e.default.readJsonSync(this.nativePath))}readFileSync_(){return $e.default.readFileSync(this.nativePath)}readFile_(){return $e.default.readFile(this.nativePath)}readFile(e="warn"){return this.trap("readFile",()=>this.readFile_(),e)}async zReadFile_(e){return sc(this.nativePath,e)}async zcat(e){return this.trap("zcat",()=>y(this.zReadFile_(e),h))}async zCopyFile(e,r){return this.trap("zCopyFile",async()=>(await e.parent().mkdirp(),await Dd(this.nativePath,vr.default.createWriteStream(e.nativePath),r),e))}readLines(){return y(this.readFile(),e=>zi(e.toString()))}readFileSync(){return it(()=>f(vr.default.readFileSync(this.nativePath),h))}writeTxt_(e){return this.writeFile_(Nx(e))}async writeFile_(e){return await this.parent().mkdirp(),await $e.default.writeFile(this.nativePath,e),this.clearThisAndParent()}wip(e=tT){return this.sibling(e+this.base)}async unwip_(e=tT){let r=this.sibling(Qe(this.base,e));return this.mv_(r,{overwrite:!0})}async dest(e){let r=e.clear();return M(this.ext)&&T(r.ext)||await r.isDirectory()?r.join(this.base):r}copyFile_(e){return pt("fs.copyFile",async()=>{let r=(await this.dest(e)).clear();if(this.nativePath===r.nativePath)return this;if(await r.parent().mkdirp()==null)return this.bflog().throw("Cannot mkdirp "+r.dir);try{return await this._copyFile(r)}catch(o){if(Nw(o))throw o;return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:r.nativePath,error:o}),await this._nativeCopyFile(r)}finally{this.clearThisAndParent()}})}async _copyFile(e){let r,i,o=e;try{let n=await Pe(this.stat(),()=>this.clear().stat());if(n==null)return this.bflog().throw("Can't copy missing files"+Vt);if(n.size===0)await e.touch(n.mtime,n.atime);else{if(u.verifyFileCopies.valueOrDefault&&await this.sha()==null)return this.bflog().throw("Can't copy file without SHA"+Vt);i=e.wip();let s=$e.default.copyFile(this.nativePath,i.nativePath);n.size>5*_i&&(r=new es({op:"Copying",path:this.nativePath,dest:e.nativePath},n.size,()=>i.clear().size())),await s;let a=await Ve(async()=>n.size===await i.clear().size(),{timeoutMs:q});if(u.verifyFileCopies.valueOrDefault){let m=a&&await Ve(()=>zn(this.sha(),i.clear().sha()),{timeoutMs:q});if(!m)return this.bflog().throw("copyFile_() failed",{sizeMatches:a,shaMatches:m})}if(!a)return this.bflog().throw("copyFile_() failed",{expectedSize:n.size,actualSize:await i.clear().size()});if(o=await i.unwip_(),o==null)return this.bflog().throw("copyFile_("+e+") failed: .unwip() was null");await $e.default.utimes(o.nativePath,n.atime,n.mtime)}try{await $e.default.chmod(o.nativePath,n.mode)}catch(s){this.bflog().debug(`copyFile_(${o.nativePath}) warning: couldn't chmod to ${n.mode}: ${s}`)}return this.bflog().debug(`copyFile_(${e.nativePath}): success`),nd(this.nativePath,e.nativePath),e}catch(n){throw this.bflog().warn(`copyFile_(${i?.nativePath}) failed: ${n}`),await i?.unlink(),await e.unlink(),n}finally{f(r,n=>n.end())}}async copyTimeoutMs(){return ye(this.size(),e=>Math.max(q,e*Ku),()=>q)}async _nativeCopyFile(e){let r;try{if(await e.parent().mkdirp()==null)return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});let i=await this.stat(),o=f(i,n=>n.size);return i==null||o==null?this.bflog().throw("Can't copy missing files"):(o>5*_i&&(r=new es({op:"Copying",path:this.nativePath,dest:e.nativePath},o,()=>e.clear().size())),O?await Te.instance().execute(`Copy-Item -LiteralPath ${is(this.nativePath)} -Destination ${is(e.nativePath)}`,n=>n):await se("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:await this.copyTimeoutMs()}),nd(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(i){return this.bflog().throw("_nativeCopyFile("+e+"): "+i)}finally{f(r,i=>i.end())}}async touch(e=Date.now(),r){return this.trap("touch",()=>y(this.ensureFile(),()=>this.utimes(e,r)))}async utimes(e,r){let i=x(e,Date.now()),o=x(r,i);return this.trap("utimes",()=>$e.default.utimes(this.nativePath,Ii(o),Ii(i)).then(()=>this.clearThisAndParent()))}async unlink(e="warn"){return this.trap("unlink",async()=>(await $e.default.unlink(this.nativePath),this.clearThisAndParent()),e)}async rmrf(e="info"){return this.trap("rmrf",async()=>(this.bflog().log(e,"rmrf()"),await $e.default.remove(this.nativePath),this.clearThisAndParent()))}async unlock(){return fe&&await this.clear().exists()&&await se("chflags",["nouchg",this.nativePath],{timeout:q}),this}async renameWithNameSuffix_(e){return y(this.withNameSuffix(e).ensureNew_({emptyIsNew:!0}),r=>r.unlink("debug").then(()=>this.mv_(r)))}async mv_(e,r={overwrite:!1}){let i=await this.dest(e);if(this.nativePath===i.nativePath)return this.bflog().warn("mv(): no-op",new Error("internal error")),this;await i.parent().mkdirp(),this.bflog().debug("mv",i);try{await $e.default.move(this.nativePath,i.nativePath,r)}catch(o){this.bflog().warn("mv() try #1 failed. Calling unlock() and waiting for source to be non-empty.",o),await Promise.all([this.unlock(),i.unlock()]),await Ve(()=>this.clear().isNonEmptyFile(),{timeoutMs:7*S}),await $e.default.move(this.nativePath,i.nativePath,r)}return await i.unlock(),this.clearThisAndParent(),i.clearThisAndParent()}async pipeTo(e,r){return this.trap("pipeTo("+e+")",async()=>{let i=await this.sibling(e).ensureNew_();return await $n([vr.default.createReadStream(this.nativePath),r,vr.default.createWriteStream(i.nativePath)]),await this.unlink(),i})}async gunzip(){return this.pipeTo(sr(this.base,".gz"),(0,rs.createGunzip)())}async gzip(){return this.pipeTo(this.base+".gz",(0,rs.createGzip)())}async compressBrotli(){return this.pipeTo(this.base+".br",(0,rs.createBrotliCompress)())}ensureFile(){return this.trap("ensureFile",()=>$e.default.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync_(){return $e.default.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return Ir(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get baseWithoutCountWithParent(){return this.parent().base+"/"+this.baseWithoutCount}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}async ensureNewNativePath(e){return $u(b({nativePath:this.nativePath},e))}ensureNew_(e={}){return this.ensureNewNativePath(e).then(r=>this.for(r))}async renameYMDHMS_(e){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");let r=hb(await Pe(this.mtime(),()=>new Date)),i=Z(e,o=>this.parent().join(o),()=>this.parent());return this.mv_(i.join(this.name+"-"+r+this.ext),{overwrite:!0})}async saveIfNewOrDelete(e){if(await this.clear().isEmpty()){await this.unlink("trace");return}let r=await this.siblingWithSameContents();if(r!=null)return await this.unlink(),r;let i=await this.sibling(e).ensureNew_();return this.mv_(i)}async chmod(e){return await $e.default.chmod(this.nativePath,e),this.clear()}zreadline(){return vr.default.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe((0,rs.createGunzip)()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)}).pipe(new Zn)}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return pt("fs.childWithSameContents",async()=>{if(await this.notExists()||!await this.isDirectory())return;let r=await e.size(),i=await this.children(),o=[];for(let s of D(i))await s.size()===r&&!e.eql(s)&&o.push(s);if(R(o))return;let n=await e.sha();for(let s of o.sort((a,m)=>oc(a.base,m.base)).reverse())if(await s.sha()===n)return s})}async applyWip(e,r=0,i=15*S){let o=this.wip();try{if(await o.parent().mkdirp(),(await o.clear().isRecent(i)||await this.clear().isRecent(i))&&(this.bflog().info("applyWip(): recent WIP exists. Waiting for a bit to see if someone else will do my work."),await Ve(()=>this.clear().isNonEmpty(r),{timeoutMs:i*2,timeBetweenMs:500}))){this.bflog().info("applyWip(): yay, someone else did my work.");return}await this.touch(),await o.unlink("trace");let n=await e(o);if(await Ve(()=>o.clear().isNonEmptyFile(),{timeoutMs:S}))return await o.unwip_(),n;throw new Error("applyWip(): empty after apply for "+this)}catch(n){throw await o.unlink(),await this.unlink(),n}}async applyIfEmpty_(e,r=0){return await this.clear().isNonEmpty(r)?this.bflog().debug("applyIfEmpty(): non-empty"):(this.bflog().debug("applyIfEmpty(): empty, applying..."),await this.applyWip(e,r)),this.touch()}firstMatchingLine(e){let r=new mt("firstMatchingLine("+this+")"),i=vr.default.createReadStream(this.nativePath,{flags:"r"});return i.on("error",o=>{o.errno===-2||o.code==="ENOENT"?(r.maybeResolve(void 0),i.close()):r.maybeReject(o)}),i.on("close",()=>r.maybeResolve(void 0)),Zo(i,ao,o=>{let n=e.exec(o);n!=null&&(r.maybeResolve(n),i.close())}),r.promise}contemporary(e,r){return ra(this.statTimes(),e.statTimes(),(i,o)=>{for(let n of i)for(let s of o)if(ab(n,s,r))return!0;return!1},()=>!1)}},ae=ii;ae.attrTTL=3*E,ae.projectRoot=l(()=>{let e=Rr.Root();if(e==null)throw new Error("Cannot find project path");return ii.for(e)});function cc(t){let e=L(t).filter(([r,i])=>r!=null&&i!=null);return new Map(e)}function Cl(t,e){return cc(L(t).map(e))}async function rT(t,e){if(t==null)return new Map;let r=await Promise.all(L(D(t)).map(i=>e(i)));return cc(r)}var os=v(require("process"));function yi(t){return h(t).replace(/[-.,\\^$*+?()|[\]{}]/g,"\\$&")}function iT(t,e){let r=[];for(let i of t)try{new RegExp(i),r.push(i)}catch{r.push(yi(i))}return new RegExp(r.join("|"),e)}var oT=class{constructor(e){this.h=e;this.text=x(e.text,h(e)),this.greedyLeft=x(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}},Bd=l(()=>p("Fixed"));function bo(t,e,r=!0){return new nT(t,e,r).entries}var nT=class{constructor(e,r,i=!0){this.warnIfMissingHeaders=i;let o=r.split(/[\r\n]{1,2}/);this.headerRow=o[0],this.rows=o.slice(1);let n=Math.max(...this.rows.map(s=>s.length));this.col2blanks=new Map(be(n,s=>[s,$r(this.rows,a=>T(a[s]))])),this.headers=this.extractHeaders(e.map(s=>new oT(s))),this.entries=this.rows.map(s=>this.headers.map(a=>a.toEntry(s))).map(s=>tt(s)).filter(s=>yt(s).some(M))}extractHeaders(e){let r=this.headerRow;te(e,s=>-s.text.length),e.forEach(s=>{let a=new RegExp(`\\b${yi(s.text)}\\b`,"i"),m=a.exec(r);m==null?this.warnIfMissingHeaders&&Bd().warn("extractHeaders(): Failed to find header!",{re:a,headerLine:r}):(s.indexOf=m.index,r=Hb(r,m.index,s.text.length," "))});let i=e.filter(s=>s.indexOf!=null),o=te(i,s=>s.indexOf);o.forEach((s,a)=>{let m=s.indexOf,c=o[a-1],d=a===0?0:c.indexOf+c.text.length-1,[w,P]=s.greedyLeft?[d,m]:[m,d];s.leftIdx=f(this.firstBlankColumn(w,P),A=>A+1),a===0&&s.leftIdx==null&&(s.leftIdx=0),s.leftIdx==null&&Bd().warn("no blank column for "+s.text+" between "+m+" and "+d)}),Ft(o,s=>s.leftIdx!=null),o.slice(0,-1).forEach((s,a)=>{let m=o[a+1];s.rightIdx=m.leftIdx-1});let n=D(sw(e.map(s=>s.text),o.map(s=>s.text)));return n.length>0&&Bd().warn("Missing headers",{missingHeaders:n}),o}firstBlankColumn(e,r){return so(e,r).find(i=>this.col2blanks.get(i)===this.rows.length)}};var fc=()=>"wmic",sT=()=>"fsutil";var aT=()=>"ping";var sI=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;function lT(t){let e=sI.exec(t);if(e==null)return;let r=e.slice(1,8).map(w=>U(w));if(!nu(r))return;let[i,o,n,s,a,m,c]=r,d=U(e[8],{defaultValue:0});return new Date(Date.UTC(i,o-1,n,s,a,m,c/1e3)-d*E)}var aI=/Date\((\d+)\)/;function mT(t){return C(t).flatMap(e=>aI.exec(e)).flatMap(e=>e[1]).flatMap(U).filter(e=>Ie(0,Date.now()+ht,e)).map(e=>new Date(e)).get()}var lI=l(()=>p("Ps"));function mI(t){return t!=null&&N(t.pid)&&t.start!=null&&M(t.cmd)}async function uT(t){return y(Vl([t]),e=>D(e).find(r=>r.pid===t))}async function cT(t){return R(t)||uu([os.default.pid],t)?D(t):y(Vl(t),e=>e.map(r=>r.pid))}async function Vl(t){let e=D(t).filter(N);if(R(e))throw new Error("Invalid pids: "+k(t));return xw(y(O?uI(e):cI(e),r=>r.filter(i=>mI(i)&&e.includes(i.pid))),r=>lI().debug("pidInfo()",{pids:e,result:r}))}function fI(t){return t.map(e=>({pid:e.Id,start:mT(e.StartTime),cmd:e.ProcessName}))}var pI="Get-Process",dI="| Select-Object -Property Id,ProcessName,StartTime";function fT(t){return H([...t.filter(N),os.default.pid]).join(",")}async function uI(t){if(K()||Te.instance().ended)return hI(t);let e=[pI,"-Id",fT(t),"-ErrorAction SilentlyContinue",dI].join(" ");return y(Te.instance().executeJsonToA(e),r=>fI(r))}var pT={maxBuffer:1024*1024,timeout:15*S,ignoreExitCode:!0,ignoreStderr:!0},dT=["CommandLine","CreationDate","ProcessId"];async function hI(t){let e=["process"];if(_(t)){let o=H([...t.filter(N),os.default.pid]).map(n=>`ProcessId=${n}`).join(" or ");e.push("where",o)}e.push("get",dT.join(","));let r=await We(fc(),e,pT),i=vb(bo(dT,r.result).map(o=>({pid:U(o.ProcessId,{defaultValue:-1}),start:lT(o.CreationDate),cmd:h(o.CommandLine)})));return i.find(o=>o.pid===os.default.pid)||i.push({pid:os.default.pid,start:new Date(Oi),cmd:"node "+os.default.title}),i}function gI(t){return bo(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],t).map(e=>({pid:U(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:h(e.COMMAND)}))}async function cI(t){let e=await We("ps",["-p",fT(t),"-wwwo","pid,lstart,command"],b(b({},pT),{ignoreExitCode:!0}));return gI(e.result)}var hT=v(require("path")),gT=v(require("process"));function oi(){return Kr(gT.env.PS_CONFIG_DIR,()=>(0,hT.resolve)(ca(),fi().toLowerCase()))}var Ui=l(()=>p("Pids")),yI=10*S;function bT(t,e){if(t==null||e==null)return!1;let r=f(e.start,o=>o.getTime()),i=t.startTime;return N(r)&&N(i)&&Math.abs(r-i)<yI}async function bI(t,e){return t==null||e==null||t.name!==h(e.pid)?!1:bT(await t.readJson(),e)}function wT(t,e=!1){let r=["/PID",h(U(t)),"/T"];e&&r.push("/F"),yT.default.execFile("taskkill",r)}async function wI(t,e=!1){if(K()||Te.instance().ended)return wT(t,e);try{let r=L(["Stop-Process","-Id",U(t),e?"-Force":void 0]).join(" ");await Te.instance().execute(r,Lr)}catch(r){Ui().warn("killWin(): pwsh error, using TASKKILL: "+r),wT(t,e)}}async function xI(t,e=!1){try{zl.default.kill(t,e?"SIGKILL":"SIGTERM")}catch(r){if(!String(r).includes("ESRCH"))throw r}}function ba(t,e=!1,r=!0){if(t===zl.default.pid||t===zl.default.ppid)throw new Error("cannot self-terminate");return e&&r&&Wi.instance().onKill(t),O?wI(t,e):xI(t,e)}async function Ul(t){return await uT(t)!=null}function xT(t){return ct(Ul(t))}var Cd=class{constructor(e=ae.for(oi()).join("pids")){this.pidsDir=e;this.p=new ut;this.recentPids=new ke(10*S);this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",async()=>{let r=x(e.everything,!1),i=x(e.force,O),o=await this.pidfiles(),n=await rT(o,P=>y(P.readJson(),A=>[A.pid,A])),s=H(ie(D(n.values()).map(P=>[P.pid,P.ppid])));if(R(s))return Ui().debug("killOldProcs(): no pidfiles"),[];let a=await Vl(s);if(Ui().debug("killOldProcs()",{pids:s,allEntries:a}),a==null){Y("Pids.killOldProcs(): failed to get process information");return}let m=new Set(a.map(P=>P.pid)),c=a.filter(P=>n.has(P.pid)),d=te(L(c.map(P=>f(n.get(P.pid),A=>bT(A,P)?b(b({},A),P):void 0))),P=>P.pid).filter(P=>zl.default.pid!==P.pid),w=r?d:d.filter(P=>!m.has(P.ppid)||!m.has(P.pid)||N(P.timeoutTime)&&Date.now()>=P.timeoutTime||e.everythingBefore!=null&&P.startTime<e.everythingBefore);Ui().debug("killOldProcs()",{trackedEntries:c,victims:w,pidfiles:D(n.values())});for(let P of w)Ui().debug("killOldProcs(): killing",{entry:P}),ba(P.pid,i,!1);return await this.vacuumPids(),te(w,P=>P.pid)})}async addPid(e,r,i=!1){if(e==null)throw new Error("undefined info");let o=e.pid;if(!N(o))throw new Error("undefined pid");let n=e.ppid+":"+e.pid;return i&&this.recentPids.delete(n),this.recentPids.getOrSet(n,async()=>{let s=this.pidsDir.join(e.pid+".json"),a=C(it(()=>hi(e.cmd).base)).filter(M).getOrElse(()=>e.cmd),m=r.getTime(),c=we(e.maxAgeMs,w=>m+w),d=b(b({},e),{cmd:a,startTime:m,timeoutTime:c});return await s.writeJsonMaybe(d)==null?Ui().throw("Failed to write to "+s,{info:e,force:i}):(Ui().debug("addPid() wrote "+s,d),s)})}pidfiles(){return this.pidsDir.clear().children(e=>e.ext===".json"&&U(e.name)!=null)}async onKill(e){let r=this.pidsDir.join(e+".json");return y(r.clear().readJson(),i=>this.addPid(b(b({},i),{maxAgeMs:1}),db(E),!0).catch(o=>{Ui().info("onKill(): failed to rewrite pidfile: "+o,{pid:e})}))}async vacuumPids(){let e=await this.pidfiles(),r=D(e).map(o=>U(o.name)).filter(N);if(R(r))return;let i=await Vl(r);if(i==null){Y("Failed to get pidInfo for pids "+r);return}Ui().debug("vacuumPids",{pids:r,pidfiles:D(e).map(o=>o.base),entries:i});for(let o of e){let n=i.find(s=>h(s.pid)===o.name);(n==null||!await bI(o,n))&&(Ui().debug("vacuumPids(): Removing old pidfile "+o.base,{psEntry:n,pidfile:await o.readFile().then(h).catch(s=>"(failed to read file: "+s+")")}),await o.unlink())}}},Wi=Cd;Wi.instance=l(()=>new Cd);function pc(t,e){return Wi.instance().addPid(t,e)}var TT=l(()=>{let t=[{everything:!1,force:!1,intervalMs:5*E},{everything:!1,force:!0,intervalMs:17*E}].map(e=>wr(()=>Wi.instance().killOldProcs(e),e.intervalMs));return new ze("ProcCleaner",()=>(t.map(clearInterval),Wi.instance().killOldProcs()),oe.predb)});var Wl=Me("AboveNormal","Normal","BelowNormal","Idle"),Vd=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19});var ns=class{constructor(e){this.ttlMs=e;this.expireListeners=[];this.delegate=new Map;this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,r=this.ttlMs){return this.delegate.set(e,Date.now()+(r-this.ttlMs)),this}addIfMissing(e,r){let i=this.delegate.get(e);if(i==null||this.isEntryExpired(e,i))return this.add(e),r()}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(let[r,i]of this.delegate)this.isEntryExpired(r,i)||e(r,r,this)}has(e){return!this.isEntryExpired(e,this.delegate.get(e))}values(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield i)}return r()}entries(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield[i,i])}return r()}toA(){return this.vacuum(),[...this.delegate.keys()]}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}on(e,r){this.expireListeners.push(r)}isEntryExpired(e,r){return Et(r==null||r+this.ttlMs<=Date.now(),i=>{r!=null&&i&&(this.expireListeners.forEach(o=>o(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,r)=>{this.isEntryExpired(r,e)})}};var vT=l(()=>p("Renice"));B(()=>W(()=>zd.prior()?.clear()));var zd=l(()=>new ns(E));async function dc(t){if(zd().has(t))return;zd().add(t);let e=u.processPriority.valueOrDefault;return we(t,async()=>{try{await(O?TI(t,e):vI(t,x(Vd[e],Vd.BelowNormal))),vT().info("Renice pid "+t+" to "+e)}catch(r){vT().info("Failed to renice pid "+t+"",r);return}})}async function TI(t,e){return we(t,r=>Wl.mapValid(e,i=>Te.instance().execute(`(Get-Process -Id ${t}).PriorityClass = "${e}"`,o=>o)))}async function vI(t,e=19){return We("renice",[e,"-p",t].map(h),{timeout:10*S,isIgnorableError:()=>!0,ignoreExitCode:!0,maxRetries:0})}var qd=v(require("process"));var MT=v(require("process"));var qi=class{constructor(e){this.a=e}async _map(e,r){let i=this.a!=null?await this.a():void 0,o=Ud(i)?await i.get():i;return o!=null?e(o):r()}async isDefined(){return this._map(()=>!0,()=>!1)}async isEmpty(){return this._map(()=>!1,()=>!0)}async get(){return this._map(e=>e,()=>{})}async getRequired(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}async exists(e){return this._map(e,()=>!1)}map(e){return new qi(async()=>this._map(e,()=>{}))}flatMap(e){return new qi(async()=>this._map(e,()=>{}))}filter(e){return new qi(async()=>this._map(async r=>await e(r)?r:void 0,()=>{}))}catch(e){return new qi(()=>this.get().catch(async r=>e(r)))}forEach(e){return new qi(async()=>{let r=await this.get();return await f(r,e),r})}async getOrElse(e){return x(await this.get(),e)}orElse(e){return new qi(async()=>{let r=await this.get(),i=r??await e();return Ud(i)?i.get():i})}};function Ud(t){return t instanceof qi}function bt(t){return Ud(t)?t:new qi(()=>t)}var ST;(function(r){r.and=async(...i)=>{for(let o of i)if(!I(await o()))return!1;return!0},r.or=async(...i)=>{for(let o of i)if(I(await o()))return!0;return!1}})(ST||(ST={}));async function Ut(...t){if(t!=null)for(let e of t){if(e==null)continue;let r=await e();if(r!=null)return r}}var PT="en",hc=l(async()=>Wd(await Ut(()=>ET(),()=>O?SI():void 0,()=>fe?MI():void 0,()=>ia?PI():void 0)));function ET(t=MT.default.env){return ib(t.LC_ALL,t.LC_MESSAGES,t.LANG,t.LANGUAGE)}var EI=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function Wd(t){if(T(t)||Ye("c",t)||Ye("posix",t))return PT;{let e=EI.exec(t);return e==null?PT:L([e[1],e[2]]).join("-")}}function SI(){return y(Te.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),t=>t.Name)}var DT={timeout:10*S};function MI(){return bt(se("defaults",["read","-globalDomain","AppleLocale"],DT)).flatMap(Wd).get()}var DI=/^([a-z_]+)\s*=\s*"(.+)"$/i;function PI(){return bt(se("locale",[],DT)).flatMap(t=>t.split(`
`).map(e=>f(e.match(DI),r=>[r[1],r[2]]))).flatMap(tt).flatMap(ET).flatMap(Wd).get()}function AT(){return{LANG:"C",LC_ALL:"C"}}var AI=l(()=>new Set(yt(u).map(t=>t.key)));function FT(){let t=AI();return Sb(Mb(qd.default.env,e=>e==="NODE_ENV"||t.has(e)))}var IT=l(()=>ql().filter(t=>t.hasValue()));function LI(){IT.unset()}var OT=l(()=>{try{return new RegExp(u.sensitiveEnvRegExp.valueOrDefault,"i")}catch(t){return console.error(`Invalid setting for "sensitiveEnvRegExp": ${t}. Using default value.`),new RegExp(u.sensitiveEnvRegExp.defaultValue,"i")}});B(()=>{u.sensitiveEnvRegExp.addListener(()=>{OT.unset(),kT.unset()});for(let t of ql())t.addListener(LI)});var kT=l(()=>{let t=OT();return Iu(qd.default.env,(e,r)=>t.exec(e)!=null?void 0:r)});function FI(){return IT().reduce((t,e)=>e.maybeAddToEnv(t),b(b({NODE_ENV:Bo},Oe()?{PS_IS_DOCKER:"1"}:{}),Xr?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}))}function Hd(t){let e=x(t,{}),r=x(e.forceCLocale,!0);return b(b({},Bt(e,"forceCLocale")),{env:jd(e.env,r),detached:!1,shell:!1})}function jd(t,e){let r=pi(b(b(b(b(b({},kT()),{PATH:LT()}),e?AT():{}),FI()),x(t,{})));return u.logStdout.deleteFromEnv(r),u.tailLogs.deleteFromEnv(r),r}var Wt=l(()=>p("ChildProcess"));function gc(t){return rt(t,"pid","killed","connected","exitCode","signalCode")}function RT(t,e){return Ve(()=>ct(Ul(t)),{timeoutMs:e})}async function jl(t,e=30*S){if(t==null)return!1;let r=t.pid;if(Wt().debug("endProcess("+r+")",{killed:t.killed,connected:t.connected}),r<=0)return Wt().warn("endProcess(): asked to end invalid pid",gc(t)),!1;if(r===Kd.default.pid)return Wt().warn("endProcess(): asked to end MY pid",gc(t)),!1;await It(250),await Qw(t);{let i=t.kill();Wt().debug("endProcess("+r+")",{killResult:i,childGotSigterm:t.killed}),i||await ba(r).catch(o=>{Wt().warn("endProcess(): kill("+r+",false) failed: "+o)})}if(it(()=>t.unref()),Cn())return!0;if(await RT(r,e))return Wt().debug("endProcess(): exitted",gc(t)),!0;{Wi.instance().onKill(r);let i=t.kill("SIGKILL");Wt().warn("endProcess("+r+") had to resort to SIGKILL",{killResult:i}),i||await ba(r,!0).catch(o=>{Wt().warn("endProcess(): kill("+r+",true) failed: "+o)})}return RT(r,5e3)}function II(t,e){return t!=="renice"&&t!=="which"&&t!=="where"&&[t,...e].every(r=>!r.endsWith("web.js")&&!r.endsWith("db.js")&&!r.includes("sqlite3"))}function _T(t,e,r,i){let o=new Date,n=!1;t.on("exit",()=>n=!0);let s=II(e,r);return $s(async()=>{if(n)return;await Ve(()=>N(t.pid),{timeoutMs:5*S});let a=t.pid;if(N(a))return s&&await dc(a),pc({pid:a,cmd:e,maxAgeMs:i,ppid:Kd.default.pid},o);Wt().info("newProc(): not writing pidfile, child_process has no pid",{cmd:e,cp:gc(t)})},O?500:250),t}function yc(t,e,r,i){let o=Hd(i);return Wt().debug("spawn()",{command:t,args:e,maxAgeMs:r,opts:o}),_T(Gd.default.spawn(t,e,o),t,e,r)}function tn(t,e,r,i){let o=Hd(i);return _T(Gd.default.execFile(t,e,o),t,e,r)}async function We(t,e,r){return ti(()=>OI(t,e,r),{timeoutMs:r.timeout,maxRetries:x(r.maxRetries,3),onRetryWaitUntil:i=>at(100*i),errorIsRetriable:i=>Wt().tap({msg:"stdoutResult.errorIsRetriable()",result:wx(i,/EPERM/),meta:{error:i,cmd:t,args:e}})})}async function OI(t,e,r){let i=x(r.quiet,!1),o=x(r.ignoreStderr,!1),n=x(r.ignoreExitCode,!1),s=[];Wt().debug("stdoutResult(): execFile",{cmd:t,args:e});let a=await tn(t,e,r.timeout,Bt(r,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(r.disconnect===!0)return a.disconnect(),{result:"",pid:a.pid};let m=k({cmd:t,args:e}),c=new mt(m);setTimeout(()=>{c.pending&&Wt().warn("stdoutResult(): SLOW COMMAND",{cmd:t,args:e})},r.timeout/3).unref(),c.setTimeout(r.timeout);let d=(w,P)=>{if(kt(P)||de(r.isIgnorableError)&&r.isIgnorableError(P)){Wt().debug("stdoutResult(): ignorable error for "+w,{cmd:t,args:e,opts:r,error:P});return}a.pid!=null&&jl(a),i||Wt().warn("stdoutResult(): "+w,{cmd:t,args:e,opts:r,error:P}),c.pending&&c.reject(P)};try{a.on("error",w=>d("on(error)",w)),a.on("close",w=>{let P=Date.now()-c.start,A=w!==0?"warn":"debug",V=s.join("");i||Wt().log(A,"stdoutResult(): on(close)",{cmd:t,code:w,args:e,elapsedMs:P,result:Jb(V,160,160)}),!n&&w!==0?c.reject(new Error("non-zero exit code: "+k({code:w,cmd:t,args:e}))):c.resolve({result:V,code:_s(w),pid:a.pid})}),Ci(a.stdin),a.stdout?.on("data",w=>{w!=null&&s.push(w)}),a.stderr?.on("error",w=>d("stderr(error)",w)),a.stderr?.on("data",w=>o?Wt().warn("stdoutResult(): stderr(data): "+h(w)):d("stderr(data)",w))}catch(w){d("try/catch",w)}return await c.promise}function se(t,e,r){return We(t,e,r).then(i=>i.result)}var Hl=class extends ze{constructor(e,r,i=oe.service,o=!1){super(e,()=>this.t.end(),i,()=>this.t.ended,e==="sync-file"?q:S);this.name=e;this.t=r;r.on("childStart",n=>{this.logger.info("Started child process "+e+":"+n.pid),dc(n.pid).catch(s=>this.onError("renice failed for "+e,s)),o&&n.on("exit",()=>jl(n,5*S)),pc({pid:n.pid,ppid:NT.default.pid,cmd:e,maxAgeMs:r.options.maxProcAgeMillis+E},new Date).catch(s=>this.onError("addPid failed for "+e,s))}),r.on("startError",n=>{this.lastStartError=n,this.onError("failed to start",n)}),r.on("taskError",(n,s)=>{this.lastTaskError=n,this.onError("failed to run "+f(s,a=>a.command),n)}),r.on("internalError",n=>{this.lastInternalError=n,this.onError("internal error",n)}),r.on("endError",n=>{this.logger.error("observeBatchCluster.endError()",n)})}onError(e,r){!this.t.ended&&!K()&&!kt(r)?Y(this.name+": "+e,r):this.logger.warn("onError() (ending or ignorable): "+e,r)}};var bc=24;function ss(t,e=2){if(e<=0)return t;if(t!=null)return iu(t)?t:Array.isArray(t)?kI(t):Hr(t)?t:Uu(t)?b(b({},t),{stack:ud(t.stack)}):ou(t)?Iu(t,(r,i)=>ss(i,e-1)):t}function kI(t,e=ss){if(t!=null)return t.length<=bc?t.map(e):[...t.slice(0,bc).map(e),`\u2026 (${t.length} total items)`]}var Rt=Me("error","warn","info","debug","trace"),BT=tt(Rt.values.map((t,e)=>[t,e]));function Gl(t){return BT[t]??BT.trace}var RI=l(()=>Rt.values.filter(t=>t!==Rt.trace)),_I=48,Jd=l(()=>tt(RI().map(t=>[t,new wl(_I)])));function CT(){yt(Jd()).forEach(t=>t.clear())}function VT(t){Jd()[t.l]?.push(t)}function zT(){let t=[];for(let e of yt(Jd()))t.push(...e.toA());return te(t,e=>e.ts)}function wa(t,e){return t>=e?"error":t>=e/2?"warn":t>=e/4?"info":"debug"}var NI=/^[a-z]*/i,Kl=class{constructor(e,r){this.context=e;this.loggers=r;this.error=(e,r)=>{this.log("error",e,r)};this.warn=(e,r)=>{this.log("warn",e,r)};this.info=(e,r)=>{this.log("info",e,r)};this.debug=(e,r)=>{this.log("debug",e,r)};this.trace=(e,r)=>{this.log("trace",e,r)};this.filterContext=Z(NI.exec(h(this.context)),i=>i[0],()=>this.context)}addContext(e){return new Kl(this.context+e,this.loggers)}throw(e,r){let i=Ni(e)||r?.fatal,n=!(r?.retriable===!1)&&cd(e),s=kt(e)||r?.ignorable;r=r==null?void 0:ss(Bt(r,"fatal","retriable","ignorable"));let a=new le({cause:zu(e),message:G([this.context,r==null?void 0:k(r)]).join(" "),fatal:i,retriable:n,ignorable:s});throw this.log(s===!0?"warn":"error",ur(e),r),a}tap(e){return this.log(x(e.level,"debug"),e.msg,b({result:e.result},e.meta)),e.result}log(e,r,i){if(i=ss(i),rn().enabled(e,this.context))for(let o of this.loggers())o.log(e,this.context,r,i);else e!=="trace"&&VT({ts:Date.now(),l:e,ctx:this.context,msg:r,meta:i})}async flush(){for(let e of this.loggers())await e.flush()}async end(){for(let e of this.loggers())await e.end()}};var BI=10*E,UT="{ready}",WT=" | ConvertTo-Json -Compress";function is(t){let e=t.replace(/['`"ââ#]/g,r=>"`"+r).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v");return'"'+e+'"'}function CI(){return[`function prompt {"${UT}"}`,...Ai(u.powerShellCulture.valueOrDefault,t=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${t}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${t}'`],[])].join(";")}B(()=>W(()=>Te.instance.prior()?.clearMockResults()));var $d=class{constructor(){this.name="PowerShell";this.logger=p("PowerShell");this.mockResults=new Map;this.bco=new Hl("PowerShell",new wc.BatchCluster({processFactory:()=>tn("powershell",u.powerShellArgs.values,BI),logger:()=>p("PowerShell"),versionCommand:CI(),pass:UT,fail:"Error",exitCommand:"exit",maxProcs:lt()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:q,cleanupChildProcs:!1}),oe.postdb),this.pwsh=this.bco.t}get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return y(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,r){this.pushMockResult(Mt(e,WT),r)}pushMockResult(e,r){this.mockResults.set(e,r)}clearMockResults(){this.mockResults.clear()}async execute(e,r){if(this.pwsh.ended||K()){this.logger.warn("execute() failed (ended)",{cmd:e});return}if(he&&this.mockResults.has(e)){let i=this.mockResults.get(e);return r(i.stdout,i.stderr,i.passed)}try{this.logger.debug("execute()",{cmd:e});let i=await ri(()=>this.pwsh.enqueueTask(new wc.Task(e,(o,n,s)=>r(f(o,a=>Qe(a,e)),n,s))));return this.logger.log(wa(i.elapsedMs,7*S),"execute()",{cmd:e,elapsedMs:i.elapsedMs}),i.result}catch(i){this.logger.warn("execute() failed: "+i,{cmd:e});return}}async executeJson(e){let r=await this.execute(Mt(e,WT),(i,o,n)=>({stdout:i,stderr:o,passed:n}));if(r==null){this.logger.warn("executeJson(): null result",{cmd:e});return}if(T(r.stdout)||M(r.stderr)||!r.passed){this.logger.warn("executeJson(): failed result",b({cmd:e},r));return}try{return JSON.parse(r.stdout)}catch(i){let o=r.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:Yt(r.stdout),after:Yt(o)}),JSON.parse(o)}}async executeJsonToA(e){return y(this.executeJson(e),r=>Array.isArray(r)?r:[r])}},Te=$d;Te.instance=l(()=>{if(!O)throw new Error("PowerShell isn't available on this platform");return new $d});async function VI(){return O?Te.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}var jT=l(async()=>{if(O){let t=await VI();if(M(t))return t}return xc()}),xc=l(()=>(0,qT.resolve)(gi(),"Pictures"));var HT=["7artisans","Bower","Canon","Carl Zeiss","Cosina","Fuji","Fujifilm","Goerz","Hasselblad","Hirox","Hoya","Konica","Leica","Leidolf","Lensbaby","Meike","Meopta","Minolta","Neewer","Nikon","Olympus","Opteka","Panasonic","Pentacon","Pentax","Ricoh","Rodenstock","Rokinon","Ross","Samsung","Samyang","Seiko","Sigma","Silor","Soligor","Sony","Sunpak","Tamron","Tiffen","Tokina","Topcon","Venus","Voigtl\xE4nder","Wray","Yongnuo","Zhong Yi","Zuiko"];var Jl=["EXIF","EXV","MIE","XMP"];var GT=v(require("path")),wo=v(require("process"));function Qd(t){return h(t).replace(/([A-Z])([a-z])/g,(e,r,i)=>"_"+r.toLowerCase()+i).replace(/[A-Z]+|[0-9]+/g,e=>"_"+e).replace(/^_/,"")}function zI(t){return"PS_"+Qd(t).toUpperCase()}var s7=C(b({},wo.env)).map(t=>nr?Object.freeze(t):t).get(),g=Me("Paths","Logging","Networking","Processes","Tools","Updates","Desktops","Volumes","Db","HealthChecks","Filters","Previews","Reporting","Deduping","Sidecars","Sync","Tagging","Web","Subscriptions"),$l=Object.freeze([g.Db,g.HealthChecks,g.Filters,g.Previews,g.Reporting,g.Deduping,g.Sidecars,g.Sync,g.Tagging,g.Web,g.Subscriptions]),Yd=Object.freeze(g.values.filter(t=>!$l.includes(t))),xo=t=>M(t)&&t!=="undefined"?h(t).trim():void 0,_r=class{constructor(e){this.opts=e;this._persist=!1;this.listeners=[]}hasValue(){return this._value!=null}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){let r=x(e,wo.env);for(let i of[this.key,...D(this.opts.envAliases)]){let o=f(r[i],n=>this.opts.fromEnv(n));if(o!=null)return o}}importFromEnv(e=wo.env){if(!this._persist)return f(this.readFromEnv(e),r=>this.setValue(r))}importFromFile(e){if(!(this.hasValue()&&!this._persist))return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){Ft(this.listeners,r=>r===e)}onChange(){let e=this.value;this.listeners.forEach(r=>r(e))}get name(){return this._name}_setName(e){if(this._name!=null)throw new Error("cannot set name twice");this._name=e,this._key=zI(e),this.importFromEnv()}get persist(){return this._persist}get key(){return this._key}get category(){return this.opts.category}get categoryType(){return $l.includes(this.category)?"library":"system"}get transient(){return this.opts.transient===!0}get advanced(){return Z(this.opts.advanced,e=>e(),()=>!0)}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}maybeSetValue(e){e!=null&&(this.value=e)}set valueAndEnv(e){this.value=e,this.addToEnv(wo.env,e)}get envValueOrDefault(){return this.opts.toEnv(this.valueOrDefault)}set tmpValue(e){this._persist=!1,this.addToEnv(wo.env,e),this.setValue(e)}set tmpValueIfUnset(e){this.isUnset()&&(this.tmpValue=e)}setValue(e){let r=this._value,i=this.opts.toEnv(e),o=this.opts.fromEnv(i);return this._value=o,br(r,this._value)||this.onChange(),this._value}get defaultValue(){return Ar(this.opts.defaultValue)}get exampleValue(){return C(this.opts.exampleValue).flatMap(e=>e()).filter(M).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return this.value!=null?this.value:this.defaultValue}maybeAddToEnv(e,r){let i=x(e,wo.env);return this.hasValue()&&(i[this.key]=xo(this.opts.toEnv(x(r,this.valueOrDefault)))),i}addToEnv(e,r){let i=x(e,wo.env);return i[this.key]=xo(this.opts.toEnv(x(r,this.valueOrDefault))),i}deleteFromEnv(e){let r=x(e,wo.env);return delete r[this.key],f(this.opts.envAliases,i=>i.forEach(o=>{delete r[o]})),r}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),p("Settings."+this.name).info(".unset()"),this}addToJSON(){return{}}toJSON(){return{key:this.key,value:this.value,defaultValue:this.opts.defaultValue}}},on=class extends _r{constructor(e){super(b({toEnv:xo,fromEnv:xo,defaultValue:void 0},e))}hasValue(){return M(this.value)}};function KT(t){return t==null?void 0:t.trim()}var Xe=class extends _r{constructor(e){super(b({toEnv:KT,fromEnv:KT},e))}hasValue(){return M(this.value)}};function Xd(t,e){let r=h(t).toLowerCase();return e.find(i=>i.toLowerCase()===r)}var To=class extends _r{constructor(e){super(b({toEnv:i=>Xd(i,e.validValues),fromEnv:i=>Xd(i,e.validValues)},e));if(this.validValues=e.validValues,this.defaultValue!=null&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}};function UI(t){return j(h(t).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return ie(JSON.parse(e)).map(h)}catch{}for(let r of["\xA6",GT.delimiter])if(e.includes(r))return e.split(r);return[e]})}function JT(t){return Ns(t)?void 0:De(UI(t),Ql)}function WI(t){return De(Ql(t),k)}function Ql(t){return H(Vs(t))}var Le=class extends _r{constructor(e){super(b({defaultValue:[],fromEnv:JT,toEnv:WI},e))}push(...e){this.value=Ql([...this.valueOrDefault,...e])}get values(){return Ql(this.valueOrDefault)}set values(e){this.value=Ql(e)}removeValueFromEnv(e){f(this.value,r=>this.tmpValue=r.filter(i=>i!==e))}};function qI(t,e){return $T(JT(t),e)}function $T(t,e){if(t==null)return;let r=[];for(let i of t){let o=Xd(i,e);o!=null&&r.push(o)}return r}var Zd=class extends _r{constructor(e){super(b({fromEnv:r=>qI(r,e.validValues),toEnv:r=>f(r,i=>k(H(i)))},e));this.validValues=e.validValues}asValidValues(e){return $T(e,this.validValues)}addToJSON(){return{validValues:this.validValues}}},Re=class extends _r{constructor(e){super(b(b({},e),{toEnv:xo,fromEnv:U}))}};var Tc=class extends _r{constructor(e){super(b(b({},e),{toEnv:xo,fromEnv:Jr}))}},_t=class extends _r{constructor(e){super(b(b({},e),{toEnv:xo,fromEnv:r=>C(r).flatMap(parseInt).map(i=>ee(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},as=class extends _r{constructor(e){super(b(b({},e),{toEnv:xo,fromEnv:r=>C(r).flatMap(parseFloat).map(i=>ee(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},F=class extends _r{constructor(e){super(b(b({},e),{toEnv:xo,fromEnv:gb}))}};var Ta=require("process"),YT=Object.freeze(["/usr/local/sbin","/usr/local/bin","/opt/local/sbin","/opt/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),vc=l(()=>nr),fr=()=>!vc(),jI=Object.freeze(O?[...Ai(Ta.env.SYSTEMROOT,t=>[t,(0,xa.join)(Ta.env.SYSTEMROOT,"System32"),(0,xa.join)(Ta.env.SYSTEMROOT,"System32","webm")],()=>[]),"C:\\cygwin64\\bin"]:YT),u={copyAssetsToLibrary:new F({category:g.Paths,description:`Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page's "May PhotoStructure organize your photos and videos?" section. Read more about this setting here: <https://photostructure.com/getting-started/automatic-library-organization/>.`,defaultValue:!0,advanced:()=>!1}),libraryPath:new on({envAliases:["PS_LIBRARY","PS_LIBRARY_DIR"],category:g.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>fr()?"/home/test/Pictures":Oe()?"/ps/library":xc(),defaultValue:()=>Oe()&&!fr()?"/ps/library":void 0,advanced:()=>!1}),previewsDir:new Xe({category:g.Paths,description:`This is the directory that PhotoStructure uses to store preview images. This defaults to the ".photostructure/previews" directory inside your PhotoStructure library. Absolute paths here are supported, but if you keep your library and previews directory separated, take care when you open your library on different computers, as this setting needs to be adjusted for those computers as well.
NOTE: "originalDirs" is recommended instead of this setting; If you get "previewsDir" wrong, your library won't work. If you get "originalsDir" wrong, you just break full-screen zoom and non-transcoded videos.`,defaultValue:()=>".photostructure/previews"}),originalsDir:new Xe({category:g.Paths,description:`This is the directory that PhotoStructure uses to store original images when "copyAssetsToLibrary" is enabled. Absolute paths are supported. Relative paths are evaluated from your libraryPath. This setting defaults to ".", which is the same as your PhotoStructure library directory.
If you open your PhotoStructure library on a different computer, and that computer doesn't have access to your originals volume, full-screen zoom won't work, and non-transcoded videos will not play.
This system setting needs to be set appropriately on different computers (it won't be set automatically!)
If you have a large library and want to use an SSD, we recommend you set your libraryPath to your SSD, and use this setting to store your originals on a larger volume, rather than using the "previewsDir" setting.`,defaultValue:()=>"."}),forceOpen:new F({category:g.Paths,description:"DANGEROUS: if set, all previously-existing library locks will be removed. This should only be necessary if the prior PhotoStructure process was not shut down gracefully.",defaultValue:!1,transient:!0}),scanAllDrives:new F({category:g.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new F({category:g.Paths,description:"Deprecated, and will be removed in the next version. If set, PhotoStructure will automatically add your pictures directory to your `scanPaths` setting.",defaultValue:!1,advanced:()=>!1}),scanPaths:new Le({category:g.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1,exampleValue:()=>fr()?["/path/one","/path/two"]:[xc()]}),cacheDir:new Xe({category:g.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free. Note that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory.",exampleValue:()=>fr()?"/tmp/ps_cache_dir":yd(),defaultValue:()=>yd()}),neverIgnored:new Le({category:g.Paths,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),pidfile:new on({envAliases:["PIDFILE"],category:g.Paths,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),scanLibraryFirst:new F({category:g.Paths,description:"Should PhotoStructure scan your library before all other paths are synchronized?",defaultValue:!1}),scanLibraryLast:new F({category:g.Paths,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!0}),logLevel:new Xe({envAliases:["PS_LOG","LOG"],category:g.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc').",defaultValue:()=>vc()?"error":"info"}),logDir:new Xe({category:g.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>px(),exampleValue:()=>fr()?"/var/log/photostructure":void 0}),logCompression:new F({category:g.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>vc()}),logElapsedMs:new F({category:g.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new F({category:g.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new on({category:g.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new F({envAliases:["LOG_STDOUT","PS_STDOUT"],category:g.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new F({category:g.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new F({category:g.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR is set, this defaults to false. See <https://no-color.org/>.",defaultValue:()=>T(Ta.env.NO_COLOR)}),logSql:new F({category:g.Logging,description:"Log SQL queries to the default log level. *This is really chatty* and impacts performance. Normally these log messages are completely disabled.",defaultValue:()=>!1}),localhost:new Xe({category:g.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). See <https://letsencrypt.org/docs/certificates-for-localhost/> and <https://photostructure.com/faq/troubleshooting/#windows-firewall-issues>.',defaultValue:()=>"127.0.0.1"}),httpPort:new Re({category:g.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),trustProxy:new Xe({category:g.Networking,description:`Support for PhotoStructure instances running behind a reverse proxy. See <http://expressjs.com/en/guide/behind-proxies.html>. This setting should either be "false" (don't trust any proxies), "loopback", (only trust localhost), a single subnet (like "127.0.0.0/8"), or a comma-delimited set of subnets.`,defaultValue:"false"}),exposeNetworkWithoutAuth:new F({category:g.Networking,description:`Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.
**Don't enable this unless you know what you are doing**.`,defaultValue:()=>Oe()&&!fr()}),rpcPort:new Re({category:g.Networking,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),exiftoolProcsPerChild:new _t({category:g.Processes,description:"Each PhotoStructure process spins up an ExifTool when needed. Note that the `web`, `sync`, and `sync-file` services all use exiftool, so the total number of exiftool processes can be many times larger than this value.",min:1,max:8,defaultValue:2}),sensitiveEnvRegExp:new Xe({category:g.Processes,description:'PhotoStructure spawns a number of processes (including "exiftool" and "ffmpeg"), and passes through environment variables, mostly to ensure locale and TZ settings are correct. To prevent environment values that contain sensitive information, like API access tokens, from either being logged, or being accessed by external tools, all environment variables whose key matches this setting will be removed. This regex is applied case-insensitively.',defaultValue:"key|secret|pass|_user|aws_"}),bounceMinutes:new Re({category:g.Processes,description:"PhotoStructure will bounce the web and sync processes periodically. Set to 0 to disable.",defaultValue:60*(fr()?5:fe?2:5)}),setupTimeoutMs:new Re({category:g.Processes,description:"To prevent unhealthy services running as zombies, they self-terminate if the setup processes are not complete within this amount of time. Note that only the environment variable value is used for this setting.",defaultValue:35*S}),probationMs:new Re({category:g.Processes,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*E}),minTimeBetweenServiceRestartsMs:new Re({category:g.Processes,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*S}),fatalErrorRatePerMinute:new Re({category:g.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),minDiskFreeGb:new Re({category:g.Processes,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new _t({category:g.Processes,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new To({category:g.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>Wl.BelowNormal,validValues:Wl.values}),maxMemoryMb:new _t({category:g.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.",defaultValue:500,min:256,max:8e3}),maxRssMemoryMb:new _t({category:g.Processes,description:"PhotoStructure will restart services if their' resident set size consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:250,max:8e3}),maxTasksPerProcess:new _t({category:g.Processes,description:"PhotoStructure will recycle sync-file processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>fr()?10:200,min:1,max:5e3}),pollIntervalMs:new Re({category:g.Processes,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>vc()?E:5*S}),inspect:new F({category:g.Processes,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,transient:!0,advanced:()=>!0}),ignoreUnhealthyVolumes:new F({category:g.Volumes,description:"When true, PhotoStructure ignores volumes that are not healthy (due to needing filesystem checks, or remote filesystems that are not available).",defaultValue:!0}),validateMountpoints:new F({category:g.Volumes,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist.",defaultValue:!0}),readVolumeUuidFiles:new F({category:g.Volumes,description:`When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume UUID, which can help with cross-host library portability. Set this to false if you don't want PhotoStructure to read these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),writeVolumeUuidFiles:new F({category:g.Volumes,description:`When true, PhotoStructure (tries to) write ".uuid" files into the root directory of volumes, which enables cross-host library portability. Set this to false if you don't want PhotoStructure to try to write these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),forceLocalDbReplica:new F({category:g.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:()=>Oe()&&!fr()}),dbBackupsCount:new Re({category:g.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",defaultValue:20}),maxBusyDbMs:new Re({category:g.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 2 minutes, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>2*E}),dbTimeoutMs:new Re({category:g.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",defaultValue:()=>S}),dbBackupIntervalMinutes:new as({category:g.Db,description:"How many minutes should elapse between backing of your library database? Note that PhotoStructure vacuums and optimizes the database before a backup is taken. You want this period to be frequent enough such that data loss isn't too painful. Note that backups can cause the webserver to be momentarily unresponsive. Default is every hour.",min:fr()?.5:1,max:60*12,defaultValue:()=>fr()?.5:30}),dbCacheSizeMb:new Re({category:g.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:192}),dbBatchSelectSize:new _t({category:g.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",defaultValue:128,min:1,max:900}),dbBatchUpsertSize:new _t({category:g.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",defaultValue:16,min:1,max:500}),healthCheckExiftool:new F({category:g.HealthChecks,description:"When true, PhotoStructure verifies ExifTool is available and a valid version.",defaultValue:!0}),healthCheckLibraryIsWritable:new F({category:g.HealthChecks,description:"When true, PhotoStructure verifies the library directory exists, and is writable.",defaultValue:!0}),healthCheckVolumes:new F({category:g.HealthChecks,description:"When true, PhotoStructure verifies volumes as part of periodic health checks.",defaultValue:!0}),healthCheckFreeSpace:new F({category:g.HealthChecks,description:"When true, PhotoStructure verifies that the library and cache volumes have sufficient free space.",defaultValue:!0}),healthCheckDb:new F({category:g.HealthChecks,description:"When true, PhotoStructure verifies that the library database can be read from and written to.",defaultValue:!0}),enableSIMD:new F({category:g.Tools,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to false on macOS due to instability on that platform.",defaultValue:()=>!(fr()||fe)}),enableVipsCache:new F({category:g.Tools,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations? This defaults to false to reduce memory consumption.",defaultValue:()=>!1}),showFileInFolderUsesThunar:new F({category:g.Tools,description:`If we're on Linux, should we use Thunar (via dbus) to "show file in folder"?`,defaultValue:!1}),showFileInFolderUsesFileUri:new F({category:g.Tools,description:"Does the showFileInFolderCommand expect a file: URI to the file? If this is false, the native path will be appended instead.",exampleValue:()=>!0,defaultValue:()=>ot}),showFileInFolderCommand:new Le({category:g.Tools,description:`If set, the first argument will be used as a command (or path to command), and the subsequent arguments (if present) will be used as arguments. The native path to the file or the file: URI will be appended, based on the value given to the "showFileInFolderUsesFileUri" setting. If this is set to an empty array, the default tool for your platform will be used instead: "nautilus -s" on linux, "open -R" on mac, and "explorer /select" on Windows.
This is provided to support Linux desktops that don't use Gnome.`,defaultValue:[]}),dcraw_emuPath:new Xe({category:g.Tools,description:'This should be the absolute, native path to the "dcraw_emu" binary on this system. If this is set to "dcraw_emu", PhotoStructure will search your $PATH. See <https://www.libraw.org/docs/Samples-LibRaw.html>.',defaultValue:"dcraw_emu"}),ffmpegPath:new Xe({category:g.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc. See <https://photostructure.com/getting-started/video-support/>.',defaultValue:"ffmpeg"}),ffmpegTranscodeArgs:new Le({category:g.Tools,description:`The following are the default arguments added to transcode requests made to ffmpeg (when ffmpeg is available). The following arguments will proceed the command: "-loglevel error -threads T -i INPUT_FILE_PATH" (where T is replaced by ~half the available CPU threads, and INPUT_FILE_PATH is the full native pathname to the source video). The following arguments will follow the arguments in this setting: "-b:v VIDEO_BITRATE_KBPS OUTPUT_FILE_PATH".
CAUTION: this is an advanced setting. Editing this may cause videos that require transcoding to not be imported, or not be viewable on all browsers and platforms. See <https://forum.photostructure.com/t/hardware-accelerated-encoding-transcoding/166> for more details.`,defaultValue:["-c:a","aac","-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high"]}),heifConvertPath:new Xe({category:g.Tools,description:'This should be the absolute, native path to the "heif-convert" binary on this system. If this is set to "heif-convert", PhotoStructure will search your $PATH. See <https://photostructure.com/getting-started/heif-support/>.',defaultValue:"heif-convert"}),powerShellArgs:new Le({category:g.Tools,description:`The following are the default arguments added to spin up PowerShell on Windows devices.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1> for all arguments that PowerShell.exe accepts.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-5.1> for a description of Bypass.
See <https://forum.photostructure.com/t/eliminate-powershell-profile-and-execution-policy-related-errors/184> for more details about why this needs to be configurable.
(Versions prior to v1.0.0 only specified "-NoLogo").`,defaultValue:["-NoLogo","-NoProfile","-ExecutionPolicy","Bypass"]}),powerShellCulture:new Xe({category:g.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),toolPaths:new Le({category:g.Tools,description:`These paths are appended to the PATH to ensure PhotoStructure can find and run external tools like ffmpeg. Use your operating system's separator to separate paths (":" for mac and linux, ";" for windows).`,defaultValue:()=>co("SETTINGS_IO_TEST")?YT:jI}),vlcPath:new Xe({category:g.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),openAtLogin:new F({category:g.Desktops,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!Xr}),updateChannel:new To({category:g.Desktops,description:'TL:DR; keep this on "latest." This setting only applies to PhotoStructure for Desktops, and controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds have not been thoroughly tested. Please only consider changing this if customer support asks you to, and that you have recent backups of your system.',defaultValue:()=>hx(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new F({category:g.Desktops,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new Re({category:g.Desktops,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:60*24}),autoHideMenuBar:new F({category:g.Desktops,description:"If true, PhotoStructure for Desktops on Windows and Linux will auto hide the menu bar unless the Alt key is pressed.",defaultValue:!1}),email:new on({category:g.Reporting,description:"If set, this email will be used for license subscriptions and added to error reports, so we can contact you to help debug the issue. It is not required. Setting a value here does not subscribe you to any marketing emails.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new F({category:g.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new Re({category:g.Reporting,description:`Set this to zero to remove all bugs in PhotoStructure.
HUR HUR #DADJOKE
If your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.`,defaultValue:3}),minStreamCorrPct:new _t({category:g.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),hiddenHomeTags:new Le({category:g.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", and "Keyword").',defaultValue:()=>["Type"]}),placeholderThumbs:new F({category:g.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),cspReportOnly:new F({category:g.Web,description:"Only report CSP violations. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>.",defaultValue:()=>!1}),cspDirective:new on({category:g.Web,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src>.",exampleValue:()=>"https://myphotos.example.com"}),readdirCacheSeconds:new Re({category:g.Sync,description:"readdir() can take a long time over slow network shares and when directories are very large. This setting controls how long to cache readdir results that are slow (which take >= .5 seconds). Set to 0 to disable readdir() caching.",defaultValue:300}),verifyFileCopies:new F({category:g.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new Xe({category:g.Sync,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:`If you chose to copy assets into your library, they will be copied into <originals directory>/<result of this pattern>/<original imagename>.
- See the originalsDir system setting for what your <originals directory> is (it defaults to your library root directory).
- Please encode this path with forward-slashes, even if you're on Windows.
- If you want to add a static path, escape the pathname with single quotes (like "'photos'/y/MM/dd").
- This will always be interpreted as a relative path from your PhotoStructure library.
- See <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.`,defaultValue:"y/y-MM-dd"}),transcodeVideos:new F({category:g.Sync,description:"Should videos that are not in a browser-supported format be transcoded during import? Note that this is a plus-only feature. FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),transcodeBitrateQVGA:new Re({category:g.Sync,description:"What max bitrate should PhotoStructure encode QVGA (320 \xD7 240) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:800}),transcodeBitrateUHD:new Re({category:g.Sync,description:"What max bitrate should PhotoStructure encode UHD (3840\u2009\xD7\u20092160) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:18e3}),doNotTranscodeMimetypes:new Le({category:g.Sync,description:`Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "['video/quicktime','video/mp4']").`,defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),doNotTranscodeVideoCodecs:new Le({category:g.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following video codecs. The video codec may be stored in the "VideoCodec", "CompressorID", or "CompressorName" tags.',defaultValue:()=>["avc1"]}),doNotTranscodeAudioCodecs:new Le({category:g.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following audio codecs. The audio codec is stored in the "AudioCodec" tag.',defaultValue:()=>["mp4a","sowt"]}),statTimeoutSeconds:new _t({category:g.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new F({category:g.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncIntervalHours:new Re({category:g.Sync,description:`This value controls both how often the sync process discovers new or changed files for any given volume.
Note that this value is the duration between the last completion time and when the next sync should be scheduled.
WARNING: Setting this value to a small value will mean PhotoStructure is constantly scanning your disks, which will add wear and tear and possibly reduce the lifespan of your storage media.
Note that setting this to a zero or negative value will disable automatic scheduling of the sync process.`,defaultValue:24}),rebuild:new F({category:g.Sync,description:"When set, all files in your library will be re-imported (caution: slow!).",defaultValue:!1,transient:!0}),forceSync:new F({category:g.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),skipModelUpdates:new F({category:g.Sync,description:"When set, skip any pending library database updates.",defaultValue:!1,transient:!0}),exitWhenDone:new F({category:g.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),matchSidecarsCaseInsensitively:new F({category:g.Sidecars,description:`If set to true, PhotoStructure will look for sidecar files that match file basenames (with or without the file extension), regardless of case (for example: "IMAGE.XMP" will be a sidecar for "image.jpg").
If set to false, sidecars must match case (so only "image.jpg.xmp" and "image.xmp" will match for "image.jpg").
This defaults to false just to be conservative, but true should be fine in normal cases.`,defaultValue:!1}),defaultSidecarType:new To({category:g.Sidecars,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:Jl}),writeMetadataToSidecarsIfImage:new F({category:g.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to images into sidecars. If set to false, PhotoStructure will overwrite original images with metadata changes.",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new F({category:g.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to videos into sidecars. If set to false, PhotoStructure will overwrite original videos with metadata changes. This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new F({category:g.Sync,description:'Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents. If this is set to false, the original file will be retained in the same directory. "image.jpg" will be stored as "image_original.jpg".',defaultValue:!1}),fuzzyDateParsing:new F({category:g.Sync,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),fuzzyYearParsing:new F({category:g.Sync,description:`When enabled, PhotoStructure will use directories starting with a number that looks year-like (four digits, 1826-the present) to infer the captured-at time, if all other date parsers have failed. Note that setting this to true "forces" the "fuzzyDateParsing" setting to be true.
To elaborate: PhotoStructure first looks for metadata with a date, then looks for an ISO-compliant YMD timestamp in the filename or path, and then, if "fuzzyDateParsing" or this setting is enabled, a YMD or YM datestamp, and then finally, if this setting is enabled, it looks for a directory that begins with a number that is between 1826-2020.`,defaultValue:!1}),minValidYear:new Re({category:g.Sync,description:"If PhotoStructure encounters a year that is less than this value, it will consider it invalid and look elsewhere for dates. The default value, 1826, is the first year a photograph was captured, as per <https://en.wikipedia.org/wiki/History_of_photography>. If you have paintings or other imagery from before this time, you'll want to make this value less than the earliest image in your library.",defaultValue:1826}),useStatToInferDates:new F({category:g.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in the file "birthtime" (on Windows), or the lesser value of "mtime" and "ctime" (on macOS and Linux). Note that these values are not very reliable, as file transfers and backups frequently don't retain these values correctly.`,defaultValue:!0}),usePathsToInferDates:new F({category:g.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.`,defaultValue:!0}),useLibraryPathsToInferDates:new F({category:g.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths *for files that are in your PhotoStructure library. This defaults to false, as prior versions of PhotoStructure may have placed files into incorrect datestamped directories.`,defaultValue:!1}),maxDuplicatePathElements:new Re({category:g.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),skipAssetFileUpdates:new F({category:g.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),skipAssetUpdates:new F({category:g.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new F({category:g.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>fr()?!0:(0,QT.cpus)().length>=8}),excludeNoMediaAssetsOnRebuild:new F({category:g.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),strictDeduping:new F({category:g.Deduping,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true.',defaultValue:!1}),useImageHashes:new F({category:g.Deduping,description:"Building image hashes slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing. If you set this from false to true, and you'd previously imported new assets, you may want to rebuild your library to re-aggregate your assets.",defaultValue:!0}),includeSharpDominantColor:new F({category:g.Deduping,description:"PhotoStructure's image library, sharp, computes the dominant color using a 4096-bin 3D histogram. This doubles image hashing time, but the most-dominant color might be more accurate.",defaultValue:!1}),minExposureSettingsCoeffPct:new _t({category:g.Deduping,description:"This is the minimum similarity coefficient between exposure setting values two images must be to be considered equivalent. Many cameras actually report different exposure setting values between JPG and RAW: values within 90% of each other should avoid false-positives.",defaultValue:()=>90,max:100,min:0}),minImageCoeffPct:new _t({category:g.Deduping,description:"This is the minimum image hash similarity coefficient for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image similarity. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minImageGreyscaleCoeffPct:new _t({category:g.Deduping,description:"This is the minimum image hash similarity coefficient for greyscale images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>93,max:100,min:0}),minColorCoeffPct:new _t({category:g.Deduping,description:"This is the minimum similarity coefficient found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 50% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minMeanCoeffPct:new _t({category:g.Deduping,description:"If the average of image and color similarity coefficients exceeds this score, the image will be considered a match.",defaultValue:()=>65,max:100,min:0}),fuzzyDateImageCoeffWeight:new as({category:g.Deduping,description:'Image similar, by default, is somewhat lax to ensure JPG+RAW and downsampled or edited images are matched together. This is OK when dates must match, and the date is exactly correct. When dates are manually set to something "fuzzy", with perhaps only the year, month, and day, or is inferred by siblings, we need to be more discriminate with image contents to prevent incorrectly grouping photos from that day into a single asset. This value is multiplied with minImageCorrPct and minColorCorrPct to make them more stringent. For example, by default, the minImageCorrPct is 80%, and when the dates are manually set, and this weight is 1.2, the minImageCorrPct for manually-set-date files will be 90%.',defaultValue:()=>1.4,max:2,min:.5}),greyscaleColorThreshold:new _t({category:g.Deduping,description:"When looking at each pixel in L*a*b* space, a greyscale image is expected to have a* and b* values around 0. If the absolute value of every a* and b* value is under this setting's value, the image will be considered to be greyscale. A value of 0 will force all images to be considered non-greyscale.",defaultValue:5,max:128,min:0}),modeCorrCieDiffWeight:new as({category:g.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to the CIE94 color delta e. Smaller values apply a larger discount to color deltas.",defaultValue:()=>.6,max:2,min:0}),modeCorrIndexDiffWeight:new as({category:g.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to difference between the color indexes. Smaller values apply a larger discount to index differences.",defaultValue:()=>.6,max:2,min:0}),gpsErrorMeters:new Re({category:g.Deduping,description:`What's the maximum number of meters between GPS fixpoints that should be considered equivalent locations? Note that JPG+RAW pairs from smartphones frequently have different GPS locations due to one being recorded from a rough WiFi fix, and another from aGPS.
GPS position error is ~10-100m. Cellular position error is ~500-750m.`,defaultValue:500}),lensMakes:new Le({category:g.Deduping,description:"Used to match lensId when Google Takeout has stripped metadata.",defaultValue:()=>HT}),variantSortCriteria:new Le({category:g.Previews,description:'How should PhotoStructure pick the "best" asset file variant for a given asset? You may reorder the default fields. Only "resolution", "fileSize", "mtime", "schemeIdx", "isCover", "count", and "isBrowserSupported" are understood: other field names will be ignored. Details about these fields are here: <https://photostructure.com/faq/what-do-you-mean-by-dedupe/#how-does-photostructure-pick-which-file-to-show>.',defaultValue:["resolution","mtime","schemeIdx","isCover","count","isBrowserSupported","fileSize"]}),variantSortCriteriaPower:new as({category:g.Deduping,description:'Larger variant sort criteria, "resolution" and "fileSize", are scaled to ignore smaller (irrelevant) differences. Scalars are raised to this power to reduce them, so a value of 1 means the criterion is unchanged from the "raw" value.',defaultValue:()=>.15,max:1,min:1e-6}),jpegQuality:new _t({category:g.Previews,description:"JPEG output quality for previews. Smaller values produce smaller images with lower quality. The default value of 85 strikes a balance that has almost no noticeable compression artifacts, yet still compresses images reasonably well. Values less than ~50-70 can produce noticeable artifacts (depending on the image).",defaultValue:()=>85,max:100,min:10}),dcrawEmuArgs:new Le({category:g.Previews,description:`What options do you want to pass to dcraw_emu? Note that "-T -o 1 -j -Z -" will always be added (as we need TIFF, sRGB, raw pixels send to stdout). The "-h" arg will be added if the preview image needed is less than half the resolution of the original.
Run "dcraw_emu" with no arguments to get usage help.
"-q 1" sets interpolation quality to "0".
"-H 2" turns on highlight blending.
"-w" uses the camera-set white balance.
Note: changing these values can dramatically (> 10x!) increase the time it takes to render RAW images.`,defaultValue:["-q","0","-w"]}),iccProfileMappings:new Le({category:g.Previews,description:`Maps an original image profile to a filename stored in the "icc" directory. See that directory's _info.md for more information about this settings.`,defaultValue:["Display P3:DisplayP3Compat-v2-magic.icc","Adobe RGB:AdobeCompat-v2.icc"]}),squareThumbStrategy:new To({category:g.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>.',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new Tc({category:g.Previews,description:`When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.
Note that if a video is shorter than this value, the frame will be captured from the middle of the video.`,defaultValue:1.5}),sharpen:new F({category:g.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new F({category:g.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new Zd({category:g.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:du(Yp,["uhd8k","uhd5k","qqvga"]),validValues:Yp}),embeddedPreviews:new Le({category:g.Previews,description:`For larger source images that are greater than 15MP, what embedded image preview tags should be used when present? Using these embedded images speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["PreviewImage","PreviewTIFF","JpgFromRaw"]}),embeddedThumbnails:new Le({category:g.Previews,description:`Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["ThumbnailImage","ThumbnailTIFF"]}),skipPreviews:new F({category:g.Previews,description:"No previews will be built. The UI will be broken if this is set.",defaultValue:!1}),requireMakeModel:new F({category:g.Filters,description:"Normally PhotoStructure requires images to have EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),minImageDimension:new Re({category:g.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new Re({category:g.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minVideoDurationSec:new Tc({category:g.Filters,description:"What's the minimum number of seconds for a video to be imported?",defaultValue:2}),minAssetFileSizeBytes:new Re({envAliases:["PS_MIN_ASSET_SIZE_BYTES","PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:g.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*ed}),maxAssetFileSizeBytes:new Re({envAliases:["PS_MAX_ASSET_SIZE_BYTES","PS_MAX_ASSET_SIZE","PS_MAX_FILE_SIZE_BYTES"],category:g.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library).",defaultValue:.5*fo}),validateJpegImages:new F({category:g.Filters,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateRawImages:new F({category:g.Filters,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateVideos:new F({category:g.Filters,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!fr()}),validationErrorBlocklist:new Le({category:g.Filters,description:`If any of the following patterns match a validation error found in a photo or video, the file will be considered corrupt and not be imported into your library.
Note the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message, so, for example, a value of "caution" will ignore any error message that contains the string "caution".`,defaultValue:()=>["Cannot determine format of input stream","corrupt","error","failed","invalid","not a .+ file","nothing was written into output file","partial file","Premature end of .+ file"]}),tagCamera:new F({category:g.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new F({category:g.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new F({category:g.Tagging,description:`Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you'll need to "Rebuild" your library to make the setting take effect).`,defaultValue:!0}),tagYMD:new To({category:g.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["y","ym","ymd",""]}),tagDateFromStat:new F({category:g.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!fr()}),tagKeywordsFromPath:new F({category:g.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new F({category:g.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new Xe({category:g.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new Xe({category:g.Tagging,description:`PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "Objects\u2283Tools\u2283Hammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don't want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.`,defaultValue:"/|>\u2283"}),tagFileType:new F({category:g.Tagging,envAliases:["PS_TAG_TYPE"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0}),tagWhoSynonyms:new Le({category:g.Tagging,description:'List hierarchical tags that PhotoStructure should interpret to be face names. Digicam uses "People". This is matched case-insensitively.',defaultValue:()=>["People","Face","Faces"]}),tagJsonFaces:new F({category:g.Tagging,description:'Google Takeout provides .json sidecars that may contain the names of the people (or pets) found in the image. Should PhotoStructure import these tags under "Who"?.',defaultValue:!0}),tagFaceRegions:new F({category:g.Tagging,description:'Picasa and other software supports embedding face names within "RegionInfo" metadata. If this setting is enabled, PhotoStructure will import these tags under "Who".',defaultValue:!0}),tagWhoNames:new Le({category:g.Tagging,description:`This is a list of tags that will be examined for strings or string arrays. All values associated to these fields will be interpreted as names. Note that "dotted notation" is supported.
Set this value to an empty array to disable scanning for person names.`,defaultValue:["People","PersonInImage","PersonInImageWDetails.PersonName","PersonInImageName"]}),tagNamesFormatter:new To({category:g.Tagging,description:`How should PhotoStructure format the "Who" tags for assets whose files are tagged with "people" strings?
"as-is" will tag names directly to "Who", so, "Who/Albert Einstein".
"family/given" will tag "Who/Einstein/Albert" (for regions that provide given names first). The default is "as-is," because discerning given and family names aren't reliably inferable.
See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"as-is",validValues:["as-is","family/given"]}),tagNamesDefaultFamily:new Xe({category:g.Tagging,description:'If a name is missing a family name, if this value is not blank, it will be provided as a default. If this value is blank, the name tag will be Who/given. Note that this setting is only used if "tagNamesFormatter" is set to "family/given".',defaultValue:"-"}),tagNamesCapitalizedAsFamily:new F({category:g.Tagging,description:"Assume uppercased names are family names (this is common practice in geneology).",defaultValue:!0}),tagNamesOrder:new To({category:g.Tagging,description:`How should PhotoStructure parse people's names? Note that this setting is only used if "tagNamesFormatter" is set to "family/given". See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"western",validValues:["western","eastern"]}),tagNamesSurnamePrefixes:new Le({category:g.Tagging,description:'List all family name prefixes to be considered part of the family name. These are matched case-insensitively. This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>["A","D\u2019","Da","De la","De las","De","Del","Della","Den","Des","Di","Du","La","Las","Le","Li","Lo","Mc","Mac","op de","ten","ter","Van \u2018t","van der","van","von der","von","z","zu"]}),tagNamesSurnames:new Le({category:g.Tagging,description:`List all family names you expect in tags that are not single words that are found at the end of a tagged name. Hyphenated family names (like "Ocasio-Cortez") do not need to be listed here: only compound family names, and if your language doesn't separate family names with whitespace. In the latter case, either include all family names, or include all givenNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesGiven:new Le({category:g.Tagging,description:`List all given names you expect in tags that are not single words. Hyphenated given names (like "Rose-Ann") do not need to be listed here. If your language doesn't separate family names and given names with whitespace, either include all given names, or include all familyNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesFamilySurrounds:new Le({category:g.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added as a family name. As an example, if you use the default "()", then "Michelle LaVaughn (Robinson) Obama" will be name tagged with both "Who/Robinson/Michelle LaVaughn" and "Who/Obama/Michell LaVaugn". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["()"]}),tagNamesGivenSurrounds:new Le({category:g.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added to the end of the given name with the surrounds retained. As an example, if you use the defaults of "[]" and double-quotes, then "Joe "Joey" Smith" will be name tagged with Who/Smith/Joe "Joey". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["[]",'""']}),tagNamesLexical:new F({category:g.Tagging,description:'Assume any name with a comma is in "lexical name order", which is always "lastname, given name(s)". If the given name is found to be "sr.", "senior", "jr.", or "junior", the name will be considered to be in western order ($givenNames $familyName, $modifier), and the $modifier will be added to the $givenNames. If this is set to false, commas are ignored.',defaultValue:!0}),excludedRootTags:new Le({category:g.Tagging,description:"Keywords starting with the given roots will be omitted from your PhotoStructure library.",defaultValue:()=>["http:","https:"]}),tagDisplayNameFS:new Xe({category:g.Tagging,description:`What should PhotoStructure call the "root" tag for browsing by filesystem paths? Note that this value is only for the UI, and will update the "_displayName" of the /fs/ tag: this value won't change the URL path from be "/tag/fs/.../". Reasonable options that have been suggested include "Folder", "Directory", "Drive", "File", "Path", "Volume", or "Computer".`,defaultValue:"Folder"}),tagAlbums:new F({category:g.Tagging,description:'Should PhotoStructure look for $tagJsonAlbumFilename (by default, "metadata.json") files in the same directory as asset files for album titles?',defaultValue:!0}),tagAlbumFilenames:new Le({category:g.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the file that PhotoStructure should look for with album metadata? This can be JSON, XMP, MIE, or EXIF encoded.`,defaultValue:["metadata.json"]}),tagAlbumTitle:new Xe({category:g.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.title"}),tagAlbumTitleHierarchies:new F({category:g.Tagging,description:'If true, album titles will be split as hierarchical keywords. If false, album titles will not be split, and all albums will be under the "Albums" root tag.',defaultValue:!1}),tagAlbumDescription:new Xe({category:g.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.description"}),tagAlbumDate:new Xe({category:g.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.date"}),tagAlbumsExcluded:new Le({category:g.Tagging,description:'For "metadata.json" albums, some are automatically generated. If the title or description includes any given string, it will be ignored.',defaultValue:["Album for automatically uploaded content"]}),pickPlanOnWelcome:new F({category:g.Subscriptions,description:'If set to true, the welcome page flow will redirect to https://account.photostructure.com/plans to have you pick between "plus" and "lite". If set to false, the welcome page will continue directly to the settings page with a "lite" license. You can still upgrade to a paid plan later from the main menu or the about page, even if this is false.',defaultValue:!0}),autoRefreshLicense:new F({category:g.Subscriptions,description:`PhotoStructure uses cryptographically signed licenses to locally store your current plan subscription status. These licenses are only valid for the current subscription period, and must be refreshed when your subscription renews or converts from a free trial to a paid subscription. To minimize the hassle of license renewals, PhotoStructure can automatically renew expired licenses in the background.
If the current license has expired and this value is true, PhotoStructure will make one secure POST request to https://account.photostructure.com/ that contains several lossy one-way hashes of current system metadata. We hash all identifying metadata to only 15 characters to alleviate any privacy concerns. If your plan subscription is active, a new license will be added to your library.
Set this to false and set the "reportErrors" setting to false if you don't want PhotoStructure "phoning home" for any reason.
Note that if this is disabled, license renewals will require manual intervention: click "Upgrade" from the main menu, pick your plan, authenticate, and the license will automatically refresh.`,defaultValue:!0}),license:new on({category:g.Subscriptions,description:`Subscription licenses are normally saved automatically into both your library and system configuration directories. This setting just provides users with an alternative way to provide a license, if it's more convenient. Any value provided to this setting will be considered in addition to existing license files when PhotoStructure is trying to find the "best" license available.`})};for(let[t,e]of Ke(u))e._setName(t);function HI(t){let e=(T(t)?"":t).split(xa.delimiter);if(O&&T(Ta.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return e.push(...u.toolPaths.valueOrDefault),H(e).filter(M).join(xa.delimiter)}var LT=l(()=>HI(Ta.env.PATH)),ql=l(()=>{let t=yt(u).filter(e=>!e.transient);return te(t,e=>[e.categoryType==="system"?0:1,g.indexOf(e.category),e.advanced,e.name])}),XT=l(()=>ql().filter(t=>Yd.includes(t.category))),ZT=l(()=>ql().filter(t=>$l.includes(t.category)));var ev;(function(o){o.highlight=()=>!1,o.silent=!1,o.enabled=()=>!o.silent,o.defaultLevelIndex=Gl("trace")})(ev||(ev={}));var GI=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i,tv=class{constructor(e){this.silent=!1;this.contexts=[];this.setup(e)}setup(e){this.contexts.length=0;let r=Gl(u.logLevel.defaultValue),i=M(e)?e:u.logLevel.valueOrDefault;G(i.split(",")).forEach(o=>{let n=GI.exec(o.trim());if(n==null)he||console.error("LogFilterImpl: Ignoring '"+o+"' from "+e);else{let s=h(n[1]).toLowerCase(),a=Gl(n[2]);T(s)?r=a:this.contexts.push({prefix:s,levelIndex:a})}}),this.defaultLevelIndex=r}contextOverride(e){if(this.contexts.length===0&&T(e))return;let r=h(e).toLowerCase();return this.contexts.find(i=>r.startsWith(i.prefix))}enabled(e,r){if(this.silent)return!1;let i=Gl(e);if(i<=this.defaultLevelIndex)return!0;let o=this.contextOverride(r);return o!=null&&i<=o.levelIndex}highlight(e){let r=this.contextOverride(e);return r!=null&&r.levelIndex>=this.defaultLevelIndex}},Sc;function rn(){return Sc==null&&(Sc=new tv,u.logLevel.addListener(()=>Sc.setup())),Sc}var rv=l(()=>Rt.values[rn().defaultLevelIndex],5*S);function nn(t,e){return rn().enabled(t)?e():void 0}var ls=class{constructor(e){this.valueOf=e;this.store=[]}get length(){return this.store.length}add(e){if(e==null)return;let r=this.valueOf(e);if(r!=null){if(this.store.length===0){this.store.push(e);return}if(ci(r,this.valueOf(this.store[0]))){this.store.unshift(e);return}for(let i=this.store.length-1;i>=0;i--)if(Ei(this.valueOf(e),this.valueOf(this.store[i]))){this.store.splice(i+1,0,e);return}this.store.unshift(e)}}shiftLt(e){if(this.length===0)return[];let r=0;if(ci(this.valueOf(hu(this.store)),e))r=this.store.length;else for(;ci(this.valueOf(this.store[r]),e);)r++;return r===0?[]:this.splice(0,r)}splice(e,r){return this.store.splice(e,r)}};var av=v(require("process"));var ov=v(require("util"));var iv=v(require("luxon"));var KI=Date.now();function Mc(t){let e=u.logElapsedMs.valueOrDefault?iv.Duration.fromMillis(t-KI).toFormat("hhhh:mm:ss.SSS"):new Date(t).toISOString();return u.logColor.valueOrDefault?u.logElapsedMs.valueOrDefault?Ws(e):qs(e):e}var sn=he?250:750;var eh=class{constructor(e={}){this.logLevels={trace:"trace",debug:qs("debug"),info:vu("info "),error:bb("error"),warn:wb("warn ")};this.inspectOptions=b(b({},eh.defaultInspectOptions()),e),he&&(this.inspectOptions.breakLength=255)}formatMeta(e){if(e==null)return;let r=ss(e);return r==null?void 0:(0,ov.inspect)(r,this.inspectOptions)}formatLogEntry(e){let r=rn().highlight(e.ctx)?Ws:xu;return G([Mc(e.ts),nv(x(e.from,()=>this.inspectOptions.processName())),this.logLevels[e.l],r(e.ctx),e.msg,this.formatMeta(e.meta)]).map(i=>h(i)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:Nr(),ctx:r,msg:i,meta:o})}},Pc=eh;Pc.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:bc+1,processName:Nr});var sv=v(require("util"));var th=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e;this.paddedLogLevels=tt(Rt.values.map(e=>[e,jb(e,5," ")]))}formatLogEntry(e){return G([Mc(e.ts),Nr(),this.paddedLogLevels[e.l],ki(e.ctx),ki(e.msg),f(e.meta,r=>(0,sv.inspect)(r,this.inspectOptions))]).map(r=>h(r)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:Nr(),ctx:r,msg:i,meta:o})}};var JI=l(()=>{u.logColor.addListener(()=>Yl.unset())}),Yl=l(()=>(av.env.NO_COLOR!=null&&(u.logColor.tmpValue=!1),JI(),u.logColor.valueOrDefault?new Pc({processName:()=>""}):new th));function va(t){return t?.ts}var lv=!1;function rh(t){lv=t}var mv=new ls(va);function Ec(...t){for(let e of t)lv?mv.add(e):console.log(Yl().formatLogEntry(e))}function ih(t=sn*2){return mv.shiftLt(Date.now()-t)}var oh=class{log(e,r,i,o){Ec({ts:Date.now(),l:e,from:Nr(),ctx:r,msg:i,meta:o})}enabled(e,r){return rn().enabled(e,r)}async flush(){}end(){}},ms=oh;ms.instance=l(()=>new oh);var fv=v(require("path")),pv=v(require("timers"));function uv(t){try{if(M(t))return JSON.parse(t)}catch{}}function cv(t,e){try{if(M(t))return e(JSON.parse(t))}catch{}}var $I=require("fs");var Dc=class{constructor(e,r={}){this.logDir=e;this.ended=!1;this.mutex=new ut;this._linesSinceRotate=0;this.pendingWrites=[];this._startIndex=0;this.endTimeoutMs=15*S;this.end=l(async()=>(this.ended=!0,f(this.flushInterval,pv.clearInterval),this.flushInterval=void 0,await this.flush(),this.mutex.serial("close",()=>this._closeCurrent())));this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",()=>this._flush());this.shouldRotate=()=>this._stream==null||this._linesSinceRotate>=this.opts.maxLinesPerFile;this.name="LogWriter("+e+")",this.opts=b({maxLinesPerFile:25e4,errorLogger:ms.instance(),flushEveryMs:sn,processName:Nr},r),this.flushInterval=wr(()=>this.maybeFlush(),this.opts.flushEveryMs),hw(this)}log(e,r,i,o){if(this.ended&&e==="error")this.opts.errorLogger.log(e,r,i,o);else{let n={ts:Date.now(),l:e,ctx:r,msg:i};o!=null&&(n.meta=o),e==="error"&&(this.writeRecentLogEntries(),this.flush()),this.pendingWrites.push(k(n)+`
`)}}writeRecentLogEntries(){this.pendingWrites.push(...zT().map(e=>k(e)+`
`)),CT()}async flush(){await this.mutex.serial("flush",()=>this._flush())}async _flush(){let e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this._rotate();let r=this._stream;if(r==null){this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");return}let i=this.opts.maxLinesPerFile-this._linesSinceRotate,o=e.splice(0,i);this._linesSinceRotate+=o.length,r.write(o.join(""))}}errback(e){return r=>this.opts.errorLogger.log("error","Caught error from "+e,r)}async _rotate(){await this._closeCurrent(),this._currentFile=await $u({nativePath:(0,fv.join)(this.logDir,yu(new Date),ki(this.opts.processName())+".log"),emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=$I.createWriteStream(this._currentFile).on("error",this.errback("file write stream"))}async _closeCurrent(){let e=this._stream;this._stream=void 0,this._linesSinceRotate=0;let r=this._currentFile;this._currentFile=void 0,await Ci(e),u.logCompression.valueOrDefault&&(await at(this.opts.flushEveryMs),await f(r,ax))}};async function dv(t,e){let r=Ir(t.name);return y(Wx(t.nativePath,e),i=>L(G(zi(i)).map(o=>cv(o,n=>b(b({},n),{from:r})))))}var nh=l(()=>[ms.instance()]);function Xu(){return nh().find(t=>t instanceof Dc)}function Xl(){let t=u.logDir.valueOrDefault,e=Xu();(e==null||e.logDir!==t)&&(mr(e),e=new Dc(t));let r=[e];(u.logStdout.valueOrDefault||u.tailLogs.valueOrDefault)&&r.push(ms.instance()),nh.set(r)}function Ac(){return Xu()?.writeRecentLogEntries()}function p(t){return new Kl(t,nh)}var Sa=Me("main","web","sync","sync-file","info","test","logcat","logtail","list","billing");function gv(t){let e=Sa.indexOf(t);return e<0?Sa.length+1:e}var QI=["main","test"],YI=["main","web","test","info"],XI=["sync","sync-file"];function Lc(t){switch(t){case"main":case"web":return E;case"sync":case"sync-file":default:return 10*S}}var bi="";function qt(){if(T(bi))throw Error("serviceName() is unset");return bi}function Ma(t){if(!he&&t!==bi&&bi!=="")throw new Error("Cannot set service name twice");bi=t,Nr.unset(),Xl()}var ZI=l(()=>[{re:/sync-file|billing/,f:vu},{re:/sync/,f:xu},{re:/web/,f:wu},{re:/db/,f:Tu},{re:/main/,f:Ws},{re:/info/,f:xb},{re:/test/,f:bu}]),Nr=l(()=>G([bi,h(hv.pid)]).join("-"));function nv(t){let e=ZI().find(r=>t.match(r.re));return e!=null?Tb(e.f(t)):t}function Tr(){return bi===Sa.main}function Fc(){return bi===Sa.web}function an(){return QI.includes(qt())}function Zl(){return!an()&&bi!=="info"}function eO(){return bi==="sync"}function em(){return bi==="sync-file"}function Ic(){return YI.includes(qt())}function yv(){return XI.includes(qt())}var bv=l(()=>eO()||he&&!em());var wv=v(require("process"));var tO=new Date().getFullYear(),rO=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.

Copyright \xA9 2017-${tO}, PhotoStructure Inc.

Running this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,xv={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",list:"List all paths in a Library.",logcat:"Chronologically sort and pretty-print PhotoStructure logfiles.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."};function Tv(t){return t.on("--help",()=>{console.log(`
`+lo(rO,{maxLineLen:wv.stdout.columns??78,prefix:""}).join(`
`)+`
`)})}var sh=class{constructor(e,r,i){this.serviceName=e;this.args=r;this.additionalDescription=i;this.plugins=[];Ma(e)}add(...e){return this.plugins.push(...e),this}async parse(){let e=Tv(vv.program.description(xv[this.serviceName]+Ai(this.additionalDescription,i=>`

`+i,()=>"")));f(this.args,i=>{e=e.arguments(i)});for(let i of this.plugins)e=i.beforeParse(e);e.version(ft,"--version","Output the version number (spoiler: it's "+ft+")"),e.parse(Sv.default.argv);let r=e.opts();for(let i of this.plugins)await i.afterParse(r);return e}};var Mv=v(require("process"));function Pa(t){return I(Mv.default.env.__is_daemon)||I(t?.daemon)||!T(t?.pidfile)}var ah={beforeParse:(t,e=!1)=>(t.option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.'),e||t.option("--info|--verbose",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.'),t.option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.').option("--color","Enable ASCII terminal colors",!0).option("--no-color","Disable ASCII terminal colors"),t),afterParse:t=>{f(t.color,o=>u.logColor.tmpValue=o);let e=I(t.warn),r=I(t.info)||I(t.verbose),i=I(t.debug);e&&(u.logLevel.tmpValue="warn"),r&&(u.logLevel.tmpValue="info"),i&&(u.logLevel.tmpValue="debug"),!Pa(t)&&(e||r||i)&&(u.logStdout.tmpValue=!0)}};var Pv={beforeParse:t=>{let e=!0;return t.option("--info",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--verbose",'Verbose logging from all processes. Shortcut for "--info --tail". Caution: noisy during imports!').option("--tail","Emit log messages from both this process and all other concurrently running PhotoStructure processes on this host to stdout. This can be really helpful in seeing how PhotoStructure's processes are coordinating work. Caution: very noisy especially during imports. Sets PS_TAIL_LOGS to true. Ignored if daemonized."),ah.beforeParse(t,e),t.option("--force-open,--forceOpen","DANGEROUS: removes all previously-existing library locks. This should only be necessary if the prior PhotoStructure process was not shut down gracefully."),t},afterParse:t=>{if(ah.afterParse(t),I(t.elapsed)&&(u.logElapsedMs.tmpValue=t.elapsed),Pa(t))u.logStdout.tmpValue=!1,u.tailLogs.tmpValue=!1;else{let e=I(t.verbose);e&&u.logLevel.isUnset()&&(u.logLevel.tmpValue="info"),(I(t.tail)||e)&&(u.tailLogs.tmpValue=!0),I(t.forceOpen)&&(u.forceOpen.tmpValue=!0)}}};var ZS=v(require("child_process")),Hi=v(require("process"));var qS=v(require("@iarna/toml"));var zS=v(require("path"));var iO=[[["360"],"GoPro 360 video (QuickTime-based)"],[["3FR"],"Hasselblad RAW (TIFF-based)"],[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["AVIF"],"AV1 Image File Format (QuickTime-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["CZI"],"Zeiss Integrated Software RAW (ZISRAW)"],[["DCP"],"DNG Camera Profile (DNG-like)"],[["DCR"],"Kodak Digital Camera RAW (TIFF-based)"],[["DNG"],"Digital Negative (TIFF-based)"],[["DV"],"Digital Video"],[["ERF"],"Epson RAW Format (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["FFF"],"Hasselblad Flexible File Format (TIFF-based)"],[["FFF"],"FLIR Systems thermal image File Format"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HDP","WDP","JXR"],"Windows HD Photo / Media Photo / JPEG XR (TIFF-based)"],[["HDR"],"Radiance RGBE High Dynamic-Range"],[["HEIC","HEIF","HIF"],"High Efficiency Image Format (QuickTime-based)"],[["IIQ"],"Phase One Intelligent Image Quality RAW (TIFF-based)"],[["INSP"],"Insta360 Picture (JPEG-based)"],[["INSV"],"Insta360 Video (QuickTime-based)"],[["J2C","J2K","JPC"],"JPEG 2000 codestream"],[["JP2","JPF","JPM","JPX"],"JPEG 2000 image [Compound/Extended]"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PEF"],"Pentax (RAW) Electronic Format (TIFF-based)"],[["PNG","JNG","MNG"],"Portable/JPEG/Multiple-image Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Kyocera Contax N Digital RAW"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["X3F"],"Sigma/Foveon RAW"],[["XMP"],"Extensible Metadata Platform sidecar file"]],wt=Me("RawImage","Sharp","Video","Sidecar","AssetFile","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser"),oO=l(()=>{let t=new jo,e=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"];for(let s of e)t.add(s,wt.RawImage);let r=L(["GIF","JPEG","PNG","PPM","TIFF","WEBP"]);for(let s of r)t.add(s,wt.Sharp);let i=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"];for(let s of i)t.add(s,wt.Video);let o=[...r,"HEIC",...e,...i];for(let s of o)t.add(s,wt.AssetFile);for(let s of Jl)t.add(s,wt.Sidecar);for(let s of[...o,...Jl])t.add(s,wt.Exif);for(let s of["GIF","JPEG","MP4","PNG","WEBM","WEBP"])t.add(s,wt.SupportedByCurrentBrowser);for(let s of["GIF","JPEG","MP4","PNG"])t.add(s,wt.SupportedByOldBrowser);let n=iO.map(s=>s[0]);for(let s of t.keys()){let a=n.find(m=>m.includes(s));if(a!=null&&a.length>0){let m=t.get(s);for(let c of a)t.has(c)||t.set(c,m)}}return t});function lh(t){return f(nO(t),e=>oO().get(e))}var sO=/\.?([a-z0-9]{2,4})$/i;function nO(t){return f(sO.exec(h(t)),e=>e[1].toUpperCase())}function Ea(t,e){return Z(lh(t),r=>r.includes(e),()=>!1)}function tm(t){return Ea(t,wt.Video)}function rm(t){return Ea(t,wt.Sidecar)}function Ev(t){return Ea(t,wt.Exif)}function Dv(t){return Ea(t,wt.SupportedByCurrentBrowser)}function mh(t,e){let r=aO(e);return r===""?t:t+"?"+r}function aO(t){if(t==null)return"";let e=Ke(t).filter(([,r])=>r!=null);return R(e)?"":e.map(r=>r.map(h).map(encodeURIComponent).join("=")).join("&")}var ji="pslib",vo="psfile",ni="psnet";var Oc=v(require("dns"));function wi(t,e){let r=0,i=new Vi(e),o=n=>(r++,i.getOrSetAsync(k(n),async()=>t(n)));return o.clear=n=>{if(n==null)i.clear();else{let s=k(n);i.deleteIf(a=>s===a)}},o.size=()=>i.size,o.callCount=()=>r,o}var lO=wi(async t=>{let e=O?await aT():"ping";return se(e,[O?"-n":"-c","1",t],{timeout:5*S})},{maxSize:255,timeoutMs:xr,clearEveryMs:10*E}),uh=new RegExp("\\b"+be(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),yY=wi(async t=>C(await lO(t).catch(e=>{console.warn("failed to ping: "+e)})).filter(M).flatMap(e=>uh.exec(h(e))).map(e=>e[0]).get(),{maxSize:255,timeoutMs:xr,clearEveryMs:10*E});var mO=new RegExp("^"+uh.source+"$"),uO=wi(async t=>{let e=mO.exec(t)==null?t:await Av(t);return h(e).toLowerCase().normalize()},{maxSize:128,timeoutMs:xr}),cO=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function ch(t){return cO.exec(t)!=null}function Lv(t){let e=t.split(".").map(r=>U(r)).filter(r=>Ie(0,255,r));return e.length===4?e:void 0}var Fv=wi(async t=>{if(!T(t)){if(Lv(t)!=null)return[t];try{return await Oc.promises.resolve4(t)}catch(e){kc().warn("No name found for "+t);return}}},{maxSize:256,timeoutMs:xr,clearEveryMs:10*E}),kc=l(()=>p("nslookup"));B(()=>W(()=>Av.clear()));var Av=wi(async t=>{try{let e=await Ae(()=>ch(t)?t.startsWith("127.")?["localhost"]:["127.0.0.1"]:Lv(t)!=null?Oc.promises.reverse(t):Oc.promises.resolve4(t),5*S);if(e==null)return kc().info("nslookup("+t+"): timeout"),t;let r=e.find(M);return r??(kc().warn("No name found for "+t),t)}catch(e){return kc().warn("Failed to look up "+t+", using name.",e),t}},{maxSize:256,timeoutMs:xr,clearEveryMs:10*E});async function Iv(t,e){return T(t)||T(e)?!1:Ye(t,e)||ch(t)&&ch(e)?!0:ra(Fv(t),Fv(e),(r,i)=>r.some(o=>i.includes(o)),()=>!1)}var fO=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;async function pO(){let t=await se("mount",[],{timeout:q});return L(t.split(`
`).map(e=>f(fO.exec(e),r=>{let[i,o,n]=r.slice(1),s=n.split(",").map(a=>a.trim());return{filesystem:i,mountpoint:o,options:s}})))}var Ov=l(async()=>Go(await pO(),async t=>t.options.includes("nobrowse")||t.options.includes("quarantine")||await dO(t.mountpoint)).then(t=>t.map(e=>e.filesystem)),cr);async function dO(t){let e=ae.for(t),r=await ye(await e.childNames(),i=>i.filter(o=>!o.startsWith(".")).map(o=>o.toLowerCase()).sort(),()=>[]);return br(r,["applications","photostructure.app"])}function fh(t){return U(t,{defaultValue:0})*1024}var hO=["devfs"],gO=["udev","tmpfs","devtmpfs","shm"],yO=fe?hO:gO,bO=["/boot/efi","/dev/shm"];async function us(t,e){let r=fe?await Ov():[],i=["-k","-P"];t&&i.push("-l"),M(e)&&i.push(e);let o=await se("df",i,{timeout:q,ignoreStderr:!0,ignoreExitCode:!0});return bo(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],o).map(s=>({filesystem:s.Filesystem,size:fh(s["1024-blocks"]),used:fh(s.Used),available:fh(s.Available),mountpoint:s["Mounted on"]})).filter(s=>{let a=h(s.filesystem),m=h(s.mountpoint);return M(m)&&!bO.includes(m)&&M(a)&&!r.includes(a)&&!yO.includes(a)})}var cs=l(async()=>{if(!ot||Oe())return!1;try{return(await We(Rc,["version"],{timeout:q,ignoreStderr:!0})).code===0}catch(t){return!1}}),Rc="gio",kv=["mount","--monitor","--anonymous"],wO=l(()=>p("Gio.gioVolumes()")),Da=l(()=>Ae(async()=>{let t=await TO(),e=(await Ml(t.map(async r=>{let i=await us(!1,r.nativePath).catch(n=>{wO().warn("Failed to df "+r+": "+n)}),o=f(i,n=>n[0]);return f(o,n=>n.mountpoint=r.nativePath),o}))).filter(r=>r.size>0);return Promise.all(e.map(async r=>ye(xO(r.mountpoint),i=>(r.remoteHost=i.remoteHost,r.remoteShare=i.remoteShare,r.label=i.displayName,r.remote=!0,r),()=>r)))},cr,()=>p("Gio.gioVolumes").warn("timed out after "+cr+"ms")),Jn),vO=p("Gio.getRemoteInfo()"),xO=wi(async t=>{try{let e=(await se(Rc,["info",t],{timeout:q})).split(/[\n\r]+/),r=j(e.find(i=>i.startsWith("uri: ")),i=>new URL(Qe(i,"uri: ")));return{displayName:f(e.find(i=>i.startsWith("display name: ")),i=>Qe(i,"display name: ")),remoteHost:f(r,i=>i.hostname),remoteShare:C(r).flatMap(i=>i.pathname).flatMap(i=>Qe(i,"/")).flatMap(i=>sr(i,"/")).flatMap(decodeURIComponent).filter(M).get()}}catch(e){vO.warn("gio info failed",{mountpoint:t,err:e});return}},{maxSize:255,timeoutMs:xr,clearEveryMs:10*E}),_c=l(async()=>y(ae.for("/proc/mounts").readLines(),t=>t.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1])),Jn);async function TO(){return await cs()?Ml(await y(_c(),t=>t.map(e=>ae.for(e).clear().childDirectories()))):[]}var fs=v(require("luxon"));function Rv(t,e,r){return t!=null&&e!=null&&Math.abs(t.getTime()-e.getTime())<=r}function Nc(t,e=2500){return t==null?!1:zs(t)?Rv(t,new Date,e):Math.abs(t-Date.now())<e}function ph(t,e=5*S){return N(t)&&Date.now()-t<=e}function _v(t=new Date){return[t.getFullYear(),Ct(t.getMonth()+1),Ct(t.getDate()),"-",Ct(t.getHours()),Ct(t.getMinutes()),Ct(t.getSeconds())].join("")}function dh(t=new Date){return[t.getUTCFullYear(),Ct(t.getUTCMonth()+1),Ct(t.getUTCDate()),"-",Ct(t.getUTCHours()),Ct(t.getUTCMinutes()),Ct(t.getUTCSeconds())].join("")}function hh(t){return fs.Duration.fromMillis(t).toFormat("m:s.S")}function gh(t){return C(t).filter(M).map(e=>fs.DateTime.fromISO(e)).filter(e=>e.isValid).map(e=>e.toMillis()).get()}function Nv(t){return f(SO(t),e=>e*100+Bc(t.millisecond))}function SO(t){return t==null||!t.isValid?void 0:U(t.toFormat("yMMddHHmmss"))}function Bc(t){return Math.floor(t/10)}function yh(t,e){if(t==null||t<0)return;let r=t,i=()=>{let w=r%100;return r=Math.floor(r/100),w},o=10*i(),n=i(),s=i(),a=i(),m=i(),c=i();return{year:r,month:c,day:m,hour:a,minute:s,second:n,millisecond:o,zone:f(e,w=>fs.Info.normalizeZone(w))}}function Cc(t,e){return f(yh(t,e),r=>fs.DateTime.fromObject(r))}function Bv(t,e){return f(Cc(t,e),r=>r.toMillis())}function Vc(t){let e=new Date(t);return U([e.getFullYear(),...[e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),Bc(e.getUTCMilliseconds())].map(Ct)].join(""))}function Uc(t){return new zc(b({name:L([t.cmd,...t.args]).join(" "),childFactory:()=>yc(t.cmd,t.args,30*E),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},t))}var zc=class{constructor(e){this.startMs=Date.now();this._stopped=!1;this.logger=l(()=>p("WatchedChild("+L([this.name,this.pid]).join(":")+")"));this.startRate=new Jo(2*E);this.mutex=new ut;this._ended=!1;this.onError=async(e,r)=>{let i=Ni(e)||Ni(r),o=new le({message:e+f(r,me),cause:Uu(r)?r:void 0}),n=kt(o),s={src:e,fatal:i,ignorable:n,errToS:me(r)};if(this.logger().log(n?"warn":"error","onError()",s),this._ended||n)return;if(this.lastError=o,Y(e,o),i)return this.end();if(this.opts.onError(e,r))return this.logger().warn("onError requested restart",s),this._restart()};this.name=e.name,this.opts=b({dataSep:`
`,maxErrorsPerMinute:3,endableRank:oe.first,exitCommand:"",restartOnExit:!0},e),this.endTimeoutMs=Lc(this.name),jn(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}async end(){return this._ended=!0,this._stop()}get proc(){return this.cp}get pid(){return f(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return Z(this.pid,e=>Ul(e),async()=>!1)}notRunning(){return ct(this.running())}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}async _stop(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});let e=this.cp;return this.cp=void 0,e==null?!0:this.stopChild(e)}async stopChild(e){return await C(this.opts.exitCommand).filter(M).flatMap(r=>C(e).flatMap(i=>i.stdin).filter(i=>i.writable).forEach(i=>it(()=>i.write(r+`
`))).map(Ci).get()),jl(e,this.endTimeoutMs)}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:Bs(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){if(this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),this._ended||K())return!1;if(!e&&this.startRate.msSinceLastEvent<u.minTimeBetweenServiceRestartsMs.valueOrDefault){this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:u.minTimeBetweenServiceRestartsMs.valueOrDefault});return}return this.mutex.serial(`WatchedChild(${this.name}).restart`,async()=>(await this._stop(),this._stopped=!1,this._start()))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,async()=>(this._stopped=!1,this._start()))}async _restart(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,async()=>(await this._stop(),this._stopped||this._ended?!1:this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),ph(this.startMs,u.probationMs.valueOrDefault)&&Y("Can't restart "+this.name+", failure rate is too high."+ce,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),this.opts.onRestart?.(),this._start())))}async _start(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended||await this.running())return!1;this.startRate.onEvent();let e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);let r="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:i,desc:o})=>{f(i,n=>n.on("error",s=>this.onError(r+o+".on(error)",s)))}),f(this.cp.stdout,i=>Zo(i,this.opts.dataSep,o=>{this.logger().trace("onDataChunked()",o),this.opts.onStdout(o)})),f(this.cp.stderr,i=>i.on("data",o=>{h(o).includes("Error: Cannot find module")&&Y("Failed to start "+this.name+ce,new Error(Yt(o,256))),this.opts.onStderr?.(o)===!0&&this.onError(r+".stderr.on(data)",o)})),this.cp.on("exit",async(i,o)=>{this.logger().info("onExit",{code:i,signal:o,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?(await this._restart(),this.logger().info("onExit(): finished setting up new child "+this.pid)):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending "+this.pid),this.end())}),!0}};var bh=v(require("timers"));function Wc(t,e){e=Math.ceil(e);let r,i=[],o=(...n)=>{i=n,f(r,bh.clearTimeout),r=$s(()=>t(...i),e)};return o.reset=()=>{f(r,bh.clearTimeout),r=void 0},o.now=()=>{o.reset(),t()},o}var MO=p("Mountpoints.localMountpointSetup()");async function Cv(){let t=await y(us(!1),e=>G(e.map(r=>r.mountpoint)));if(t!=null&&await cs())try{await y(Da(),e=>t.push(...e.map(r=>r.mountpoint)))}catch(e){MO.warn("Failed to fetch gio volumes",e)}return f(t,e=>e.filter(r=>!r.startsWith("/snap/")&&r!=="/dev"))}var PO=/\s([A-Z]:\\)/g,Vv=async()=>bt(Te.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(t=>t.map(e=>e.Root)).filter(_).orElse(()=>EO()).map(t=>t.sort()).getRequired(),EO=async()=>{let t=(await se(await sT(),["fsinfo","drives"],{timeout:10*S})).trim(),e=[],r;for(;(r=PO.exec(t))!==null;)e.push(r[1]);return e};var DO=()=>O?Vv():Cv(),zv;function Uv(t){zv=t,AO()}var AO=l(async()=>{an()?B(async()=>{let t=p("Mountpoints.localMountpointSetup()");fe&&(t.info("Setting up Mac diskutil activity watcher"),dt.setTTL(Jn),Wv()),ot&&(await cs()&&(t.info("Setting up Linux gio mount monitor"),dt.setTTL(Jn),qv()),await LO()&&(t.info("Setting up Linux findmnt mount monitor"),dt.setTTL(Jn),jv()))},30*S).unref():await Gu([mr(Wv.clear()),mr(qv.clear()),mr(jv.clear())])}),dt=l(async()=>(await ti(()=>Ut(zv,DO),{maxRetries:3,onRetryWaitUntil:r=>at(r*1500)}).catch(r=>{Y("mountpoints() failed",r)}))?.sort(),cr);B(()=>W(()=>dt.unset()));var Wv=l(()=>Uc({cmd:"diskutil",args:["activity"],onStdout:Wc(()=>dt.unset(),1.5*S)})),qv=l(()=>Uc({cmd:Rc,args:kv,onStdout:Wc(()=>{Da.unset(),_c.unset(),dt.unset()},1.5*S)})),LO=l(async()=>{if(!ot)return!1;try{return(await We("findmnt",["--version"],{timeout:q,ignoreStderr:!0})).code===0}catch(t){return!1}}),jv=l(()=>Uc({cmd:"findmnt",args:["--poll"],onStdout:Wc(()=>{_c.unset(),dt.unset()},1.5*S)}));function Br(t,e){let r=Ex("vol."+t,()=>ti(e,{maxRetries:2,timeoutMs:q,errorIsRetriable:i=>kt(i)}),Kw);return dt.onChange(()=>r.unset()),B(()=>W(()=>r.unset())),r}var FO=Br("localMountpoints",()=>y(us(!0),t=>t.map(e=>e.mountpoint))),Hv=Br("dfPosix",async()=>{let t=await us(!1);if(t!=null)return await y(FO(),e=>{t.forEach(r=>{r.remote=!e.includes(r.mountpoint)})}),await cs()&&await y(Da(),e=>t.push(...e)),t});async function Gv(t,e){if(!O)throw new Error("wtf");return await y(x(e,()=>IO()),r=>{let i=Cl(r,o=>[o.mountpoint,o]);t.forEach(o=>{f(i.get(o.mountpoint),n=>{o.remote=!0,o.remoteHost=n.host,o.remoteShare=n.share,o.ok=n.ok})})}),t}var Kv=["LocalName","RemoteName","Status"],OO=["NETUSE","get",Kv.join(",")],Jv=/^\\\\(.+?)\\(.+)$/,$v=/^[a-z]:\\?$/i;async function RO(){let t=await Te.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return t==null?kO():L(t.filter(e=>M(e.LocalName)).map(e=>f(wh(e.RemoteName),({host:r,share:i})=>f($v.exec(h(e.LocalName)),o=>({mountpoint:Mt(o[0],"\\"),host:r,share:i,ok:e.Status==="OK"&&e.ConnectionState==="Connected"})))))}function wh(t){if(!T(t))return C(t).flatMap(e=>Jv.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>C(t).flatMap(e=>it(()=>new URL(e))).filter(e=>M(e.hostname)).map(e=>({host:e.hostname,share:C(e.pathname).filter(M).getOrElse(()=>"/")}))).get()}async function kO(){let t=fc(),e=await se(t,OO,{timeout:15*S}),r=bo(Kv,e);return L(r.map(i=>f(Jv.exec(h(i.RemoteName)),o=>f($v.exec(h(i.LocalName)),n=>({mountpoint:Mt(n[0],"\\"),host:o[1],share:o[2],ok:i.Status==="OK"})))))}var IO=Br("netInfoWin",RO);var Qv=l(()=>p("DfWin")),Yv=Br("dfWin",async()=>(await _O()).filter(e=>e.ok!==!1&&N(e.size))),NO="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free";function BO(t){return M(t.Root)&&t.Free!=null&&t.Used!=null?b({mountpoint:t.Root,label:t.Description,size:t.Used+t.Free,used:t.Used,available:t.Free,remote:M(t.DisplayRoot)},f(wh(t.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))):void 0}var CO="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus,UniqueId",VO=/\{([-a-z0-9]{7,})\}/i;function zO(t){return Qv().tap({msg:"uniqueId2uuid",result:f(VO.exec(h(t)),e=>e[1]),meta:{s:t}})}function UO(t){if(t.DriveLetter==null||t.DriveLetter==="null"||t.FileSystemLabel==="System Reserved")return;let e=t.Size!=null&&t.SizeRemaining!=null&&M(t.DriveLetter)&&(Ap(t.HealthStatus,r=>Ye(r,"Healthy"))||Ap(t.OperationalStatus,r=>Ye(r,"OK")));return{mountpoint:t.DriveLetter+":\\",filesystem:t.FileSystem,label:t.FileSystemLabel,uuid:zO(t.UniqueId),size:t.Size,used:t.Size-t.SizeRemaining,available:t.SizeRemaining,remote:!1,ok:e}}async function _O(){let t=await ge(Te.instance().executeJsonToA(NO).catch(o=>(Y("volumeInfoWin(): LocalAndNetCmd failed",o),[])),o=>_p(BO(o))),e=await ge(Te.instance().executeJsonToA(CO).catch(o=>(Y("_localAndNet(): LocalCmd failed",o),[])),o=>_p(UO(o))),r=H([...t,...e].filter(o=>o.ok===!1).map(o=>o.mountpoint)),i=or(H([...t,...e].map(o=>o.mountpoint)).filter(o=>!r.includes(o)));return Qv().info("volumeInfoWin()",{getPsDrive:t,getVolumes:e,mountpoints:i,unhealthy:r}),i.map(o=>b(b({},t.find(n=>o===n.mountpoint)),e.find(n=>o===n.mountpoint)))}async function Xv(t){return y(WO(),e=>t.map(r=>Z(e.get(r.mountpoint),i=>b(b({},r),i),()=>r)))}var WO=Br("mnt2uuidMac",async()=>{let e=(await se("diskutil",["info","-all"],{timeout:q})).split(/^\s*\*{8,12}\s*$/m);return Cl(e,r=>{let i=Cl(r.split(/\s*\n+\s*/),a=>{let[m,c]=a.split(":").map(d=>d.trim());return Uo(["not applicable","no file system"],c)?void 0:[m.toLowerCase(),c]}),o=i.get("mount point"),n=i.get("volume name"),s=i.get("volume uuid");return T(o)?void 0:[o,{label:n,uuid:s}]})});function qc({input:t,lowerCaseKeys:e}){let r={},i;for(let o of zi(t).filter(n=>n.match(/^\s*#/)==null)){let n=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+|#.*?)/gim;for(;(i=n.exec(o))!=null;){let[,s,a,m]=i;r[e?s.toLowerCase():s]=Kb(m,a,a)}}return r}var qO=l(()=>p("LocalVolumesPosix"));async function Zv(t){return y(await jO(),e=>Up(H([...e.filter(i=>!i.ignorable).map(i=>i.mountpoint),...t.map(i=>i.mountpoint)])).map(i=>b(b({},t.find(o=>o.mountpoint===i)),e.find(o=>o.mountpoint===i))))}var jO=Br("localVolumeInfoPosix",async()=>{let t=await se("lsblk",["-P","-b","--output","mountpoint,label,fsused,fsavail,uuid"],{timeout:q}),e=zi(t).map(i=>qc({input:i,lowerCaseKeys:!0})).filter(i=>i!=null),r=await ta(e,async i=>{let o=T(i.mountpoint)||i.mountpoint.startsWith("/snap/")||i.mountpoint==="/boot"||i.mountpoint.startsWith("/boot/")||!await ix(i.mountpoint);return Rn(U(i.fsused),U(i.fsavail),(n,s)=>b({mountpoint:i.mountpoint,label:i.label,uuid:i.uuid,ignorable:o,used:n,available:s,size:n+s},Oe()?void 0:{remote:!1}))});return qO().tap({msg:"lsblk",result:r})});var HO=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i,GO=/^([^:\s]+):(\/.+)$/;async function eS(t){return t.filter(e=>e.remote).forEach(e=>{Z(HO.exec(h(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]},()=>f(GO.exec(h(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]}))}),t}async function tS(t,e){try{return await(e.timeoutMs==null?t():Ae(t,e.timeoutMs,()=>Y(e.message+": timeout",void 0,e.context)))}catch(r){Y(e.message,r,e.context);return}}var rS=v(require("crypto"));function KO(){let t=(0,rS.randomBytes)(16);t[6]=t[6]&15|64;let e=t.toString("hex");return[e.slice(0,8),e.slice(8,12),e.slice(12,16),e.slice(16,20),e.slice(20)].join("-")}function jc(){return Ol(KO)}var ute=l(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/);var im=l(()=>p("VolumeUUID")),iS=cr/2,xh=new Map;B(()=>{W(()=>xh.clear()),dt.onChange(()=>xh.clear())});async function oS(t){await Bi({name:"addVolumeUUIDs",laters:t.map(e=>()=>JO(e))})}async function JO(t){if(I(t.ignorable)){im().debug("volumeUUID(): ignorable is true for "+t.mountpoint);return}if(Qr(t.ok)){im().debug("volumeUUID(): remoteOK is false for "+t.mountpoint);return}await y(yr(xh,t.mountpoint,()=>fa(()=>tS(()=>$O(t),{message:"readVolumeUUID("+t.mountpoint+")"}),iS)),e=>t.uuid=e)}async function $O(t){let e=ne.for(t.mountpoint).join(".uuid");if(u.readVolumeUuidFiles.valueOrDefault){let r=await fa(()=>bt(e.readFile("debug")).map(i=>i.toString().trim()).filter(M).get(),iS);if(r!=null&&r.length>6)return im().debug("Serving UUID from .uuid",{uuid:r,mountpoint:t.mountpoint}),r}if(t.mountpoint==="/")return t.uuid;if(u.writeVolumeUuidFiles.valueOrDefault){let r=Kr(t.uuid,jc);if(await e.parent().isReadWritable())try{return await e.writeTxt_(r),im().info("volumeUUID(): Saved new UUID for "+t.mountpoint,{uuid:r}),r}catch(i){im().warn("volumeUUID(): Failed to save new UUID for "+t.mountpoint,i)}}return t.uuid}var om=l(()=>p("Volumes"));async function QO(){let t=await Ae(O?Yv():Hv(),cr,()=>Y("Timed out getting local volume metadata"));if(t==null){om().warn("df failed");return}let e=u.validateMountpoints.valueOrDefault?L(await Bi({name:"nonRpcVolumes: filter unhealthy volumes",laters:t.map(o=>async()=>{try{if(await ua(o.mountpoint,oa/2))return o;om().info("validateMountpoints(): "+o.mountpoint+" is not a directory")}catch(n){om().info("validateMountpoints(): failed to stat "+o.mountpoint,n)}})})):t;e.some(o=>o.remote&&T(o.remoteHost))&&await Ae(O?Gv(e):eS(e),10*S).catch(o=>{Y("Failed to get remote volume info",o)});let r=x(await(O?e:fe?Xv(e):Zv(e)),e);Ft(r,o=>!I(o.ignorable)),u.ignoreUnhealthyVolumes.valueOrDefault&&Ft(r,o=>!Qr(o.ok));for(let o of r)o.remote=I(o.remote),j(o.remoteHost,n=>o.remoteHost=n.toLowerCase().normalize().trim());for(let o of r)T(o.label)&&delete o.label;om().debug("nonRpcVolumes(): before addVolumeUUIDs",r),await oS(r);let i=te(r,o=>o.mountpoint);return om().debug("_volumes(): final result",{sorted:i}),Object.freeze(i)}var nS;function sS(t){nS=t}var aS=[],YO=async()=>{try{let t=await Ut(nS,QO);return De(t,e=>{let r=e.map(i=>i.mountpoint).sort();br(aS,r)||(Aw(),aS=r)}),t}catch(t){Y("volumes() failed",t);return}},Sr=Br("volumes",YO),ure=l(()=>O?C(Ne("SystemDrive")).filter(M).orElse(()=>"C:").map(t=>Mt(t,"\\")).get():"/");async function Aa(t){return y(Sr(),e=>Th(e,t))}function Th(t,e){let r=t.filter(i=>la(e,i.mountpoint));return Dt(r,i=>hl(i.mountpoint,e))}var Jc=v(require("path"));function Hc(t,e){let r=0,i=new ke(e.maxSize,e.ttlMs),o=n=>(r++,i.getOrSet(k(n),()=>t(n)));return o.clear=n=>n==null?i.clear():i.delete(k(n)),o.size=()=>i.size,o.callCount=()=>r,o}var Gc=v(require("path")),lS=v(require("punycode")),mS=v(require("util"));var X;(function(t){t[t.Null=0]="Null",t[t.Backspace=8]="Backspace",t[t.Tab=9]="Tab",t[t.LineFeed=10]="LineFeed",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.ExclamationMark=33]="ExclamationMark",t[t.DoubleQuote=34]="DoubleQuote",t[t.Hash=35]="Hash",t[t.DollarSign=36]="DollarSign",t[t.PercentSign=37]="PercentSign",t[t.Ampersand=38]="Ampersand",t[t.SingleQuote=39]="SingleQuote",t[t.OpenParen=40]="OpenParen",t[t.CloseParen=41]="CloseParen",t[t.Asterisk=42]="Asterisk",t[t.Plus=43]="Plus",t[t.Comma=44]="Comma",t[t.Dash=45]="Dash",t[t.Period=46]="Period",t[t.Slash=47]="Slash",t[t.Digit0=48]="Digit0",t[t.Digit1=49]="Digit1",t[t.Digit2=50]="Digit2",t[t.Digit3=51]="Digit3",t[t.Digit4=52]="Digit4",t[t.Digit5=53]="Digit5",t[t.Digit6=54]="Digit6",t[t.Digit7=55]="Digit7",t[t.Digit8=56]="Digit8",t[t.Digit9=57]="Digit9",t[t.Colon=58]="Colon",t[t.Semicolon=59]="Semicolon",t[t.LessThan=60]="LessThan",t[t.Equals=61]="Equals",t[t.GreaterThan=62]="GreaterThan",t[t.QuestionMark=63]="QuestionMark",t[t.AtSign=64]="AtSign",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.OpenSquareBracket=91]="OpenSquareBracket",t[t.Backslash=92]="Backslash",t[t.CloseSquareBracket=93]="CloseSquareBracket",t[t.Caret=94]="Caret",t[t.Underline=95]="Underline",t[t.BackTick=96]="BackTick",t[t.a=97]="a",t[t.b=98]="b",t[t.c=99]="c",t[t.d=100]="d",t[t.e=101]="e",t[t.f=102]="f",t[t.g=103]="g",t[t.h=104]="h",t[t.i=105]="i",t[t.j=106]="j",t[t.k=107]="k",t[t.l=108]="l",t[t.m=109]="m",t[t.n=110]="n",t[t.o=111]="o",t[t.p=112]="p",t[t.q=113]="q",t[t.r=114]="r",t[t.s=115]="s",t[t.t=116]="t",t[t.u=117]="u",t[t.v=118]="v",t[t.w=119]="w",t[t.x=120]="x",t[t.y=121]="y",t[t.z=122]="z",t[t.OpenCurlyBrace=123]="OpenCurlyBrace",t[t.Pipe=124]="Pipe",t[t.CloseCurlyBrace=125]="CloseCurlyBrace",t[t.Tilde=126]="Tilde",t[t.U_Combining_Grave_Accent=768]="U_Combining_Grave_Accent",t[t.U_Combining_Acute_Accent=769]="U_Combining_Acute_Accent",t[t.U_Combining_Circumflex_Accent=770]="U_Combining_Circumflex_Accent",t[t.U_Combining_Tilde=771]="U_Combining_Tilde",t[t.U_Combining_Macron=772]="U_Combining_Macron",t[t.U_Combining_Overline=773]="U_Combining_Overline",t[t.U_Combining_Breve=774]="U_Combining_Breve",t[t.U_Combining_Dot_Above=775]="U_Combining_Dot_Above",t[t.U_Combining_Diaeresis=776]="U_Combining_Diaeresis",t[t.U_Combining_Hook_Above=777]="U_Combining_Hook_Above",t[t.U_Combining_Ring_Above=778]="U_Combining_Ring_Above",t[t.U_Combining_Double_Acute_Accent=779]="U_Combining_Double_Acute_Accent",t[t.U_Combining_Caron=780]="U_Combining_Caron",t[t.U_Combining_Vertical_Line_Above=781]="U_Combining_Vertical_Line_Above",t[t.U_Combining_Double_Vertical_Line_Above=782]="U_Combining_Double_Vertical_Line_Above",t[t.U_Combining_Double_Grave_Accent=783]="U_Combining_Double_Grave_Accent",t[t.U_Combining_Candrabindu=784]="U_Combining_Candrabindu",t[t.U_Combining_Inverted_Breve=785]="U_Combining_Inverted_Breve",t[t.U_Combining_Turned_Comma_Above=786]="U_Combining_Turned_Comma_Above",t[t.U_Combining_Comma_Above=787]="U_Combining_Comma_Above",t[t.U_Combining_Reversed_Comma_Above=788]="U_Combining_Reversed_Comma_Above",t[t.U_Combining_Comma_Above_Right=789]="U_Combining_Comma_Above_Right",t[t.U_Combining_Grave_Accent_Below=790]="U_Combining_Grave_Accent_Below",t[t.U_Combining_Acute_Accent_Below=791]="U_Combining_Acute_Accent_Below",t[t.U_Combining_Left_Tack_Below=792]="U_Combining_Left_Tack_Below",t[t.U_Combining_Right_Tack_Below=793]="U_Combining_Right_Tack_Below",t[t.U_Combining_Left_Angle_Above=794]="U_Combining_Left_Angle_Above",t[t.U_Combining_Horn=795]="U_Combining_Horn",t[t.U_Combining_Left_Half_Ring_Below=796]="U_Combining_Left_Half_Ring_Below",t[t.U_Combining_Up_Tack_Below=797]="U_Combining_Up_Tack_Below",t[t.U_Combining_Down_Tack_Below=798]="U_Combining_Down_Tack_Below",t[t.U_Combining_Plus_Sign_Below=799]="U_Combining_Plus_Sign_Below",t[t.U_Combining_Minus_Sign_Below=800]="U_Combining_Minus_Sign_Below",t[t.U_Combining_Palatalized_Hook_Below=801]="U_Combining_Palatalized_Hook_Below",t[t.U_Combining_Retroflex_Hook_Below=802]="U_Combining_Retroflex_Hook_Below",t[t.U_Combining_Dot_Below=803]="U_Combining_Dot_Below",t[t.U_Combining_Diaeresis_Below=804]="U_Combining_Diaeresis_Below",t[t.U_Combining_Ring_Below=805]="U_Combining_Ring_Below",t[t.U_Combining_Comma_Below=806]="U_Combining_Comma_Below",t[t.U_Combining_Cedilla=807]="U_Combining_Cedilla",t[t.U_Combining_Ogonek=808]="U_Combining_Ogonek",t[t.U_Combining_Vertical_Line_Below=809]="U_Combining_Vertical_Line_Below",t[t.U_Combining_Bridge_Below=810]="U_Combining_Bridge_Below",t[t.U_Combining_Inverted_Double_Arch_Below=811]="U_Combining_Inverted_Double_Arch_Below",t[t.U_Combining_Caron_Below=812]="U_Combining_Caron_Below",t[t.U_Combining_Circumflex_Accent_Below=813]="U_Combining_Circumflex_Accent_Below",t[t.U_Combining_Breve_Below=814]="U_Combining_Breve_Below",t[t.U_Combining_Inverted_Breve_Below=815]="U_Combining_Inverted_Breve_Below",t[t.U_Combining_Tilde_Below=816]="U_Combining_Tilde_Below",t[t.U_Combining_Macron_Below=817]="U_Combining_Macron_Below",t[t.U_Combining_Low_Line=818]="U_Combining_Low_Line",t[t.U_Combining_Double_Low_Line=819]="U_Combining_Double_Low_Line",t[t.U_Combining_Tilde_Overlay=820]="U_Combining_Tilde_Overlay",t[t.U_Combining_Short_Stroke_Overlay=821]="U_Combining_Short_Stroke_Overlay",t[t.U_Combining_Long_Stroke_Overlay=822]="U_Combining_Long_Stroke_Overlay",t[t.U_Combining_Short_Solidus_Overlay=823]="U_Combining_Short_Solidus_Overlay",t[t.U_Combining_Long_Solidus_Overlay=824]="U_Combining_Long_Solidus_Overlay",t[t.U_Combining_Right_Half_Ring_Below=825]="U_Combining_Right_Half_Ring_Below",t[t.U_Combining_Inverted_Bridge_Below=826]="U_Combining_Inverted_Bridge_Below",t[t.U_Combining_Square_Below=827]="U_Combining_Square_Below",t[t.U_Combining_Seagull_Below=828]="U_Combining_Seagull_Below",t[t.U_Combining_X_Above=829]="U_Combining_X_Above",t[t.U_Combining_Vertical_Tilde=830]="U_Combining_Vertical_Tilde",t[t.U_Combining_Double_Overline=831]="U_Combining_Double_Overline",t[t.U_Combining_Grave_Tone_Mark=832]="U_Combining_Grave_Tone_Mark",t[t.U_Combining_Acute_Tone_Mark=833]="U_Combining_Acute_Tone_Mark",t[t.U_Combining_Greek_Perispomeni=834]="U_Combining_Greek_Perispomeni",t[t.U_Combining_Greek_Koronis=835]="U_Combining_Greek_Koronis",t[t.U_Combining_Greek_Dialytika_Tonos=836]="U_Combining_Greek_Dialytika_Tonos",t[t.U_Combining_Greek_Ypogegrammeni=837]="U_Combining_Greek_Ypogegrammeni",t[t.U_Combining_Bridge_Above=838]="U_Combining_Bridge_Above",t[t.U_Combining_Equals_Sign_Below=839]="U_Combining_Equals_Sign_Below",t[t.U_Combining_Double_Vertical_Line_Below=840]="U_Combining_Double_Vertical_Line_Below",t[t.U_Combining_Left_Angle_Below=841]="U_Combining_Left_Angle_Below",t[t.U_Combining_Not_Tilde_Above=842]="U_Combining_Not_Tilde_Above",t[t.U_Combining_Homothetic_Above=843]="U_Combining_Homothetic_Above",t[t.U_Combining_Almost_Equal_To_Above=844]="U_Combining_Almost_Equal_To_Above",t[t.U_Combining_Left_Right_Arrow_Below=845]="U_Combining_Left_Right_Arrow_Below",t[t.U_Combining_Upwards_Arrow_Below=846]="U_Combining_Upwards_Arrow_Below",t[t.U_Combining_Grapheme_Joiner=847]="U_Combining_Grapheme_Joiner",t[t.U_Combining_Right_Arrowhead_Above=848]="U_Combining_Right_Arrowhead_Above",t[t.U_Combining_Left_Half_Ring_Above=849]="U_Combining_Left_Half_Ring_Above",t[t.U_Combining_Fermata=850]="U_Combining_Fermata",t[t.U_Combining_X_Below=851]="U_Combining_X_Below",t[t.U_Combining_Left_Arrowhead_Below=852]="U_Combining_Left_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_Below=853]="U_Combining_Right_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below=854]="U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below",t[t.U_Combining_Right_Half_Ring_Above=855]="U_Combining_Right_Half_Ring_Above",t[t.U_Combining_Dot_Above_Right=856]="U_Combining_Dot_Above_Right",t[t.U_Combining_Asterisk_Below=857]="U_Combining_Asterisk_Below",t[t.U_Combining_Double_Ring_Below=858]="U_Combining_Double_Ring_Below",t[t.U_Combining_Zigzag_Above=859]="U_Combining_Zigzag_Above",t[t.U_Combining_Double_Breve_Below=860]="U_Combining_Double_Breve_Below",t[t.U_Combining_Double_Breve=861]="U_Combining_Double_Breve",t[t.U_Combining_Double_Macron=862]="U_Combining_Double_Macron",t[t.U_Combining_Double_Macron_Below=863]="U_Combining_Double_Macron_Below",t[t.U_Combining_Double_Tilde=864]="U_Combining_Double_Tilde",t[t.U_Combining_Double_Inverted_Breve=865]="U_Combining_Double_Inverted_Breve",t[t.U_Combining_Double_Rightwards_Arrow_Below=866]="U_Combining_Double_Rightwards_Arrow_Below",t[t.U_Combining_Latin_Small_Letter_A=867]="U_Combining_Latin_Small_Letter_A",t[t.U_Combining_Latin_Small_Letter_E=868]="U_Combining_Latin_Small_Letter_E",t[t.U_Combining_Latin_Small_Letter_I=869]="U_Combining_Latin_Small_Letter_I",t[t.U_Combining_Latin_Small_Letter_O=870]="U_Combining_Latin_Small_Letter_O",t[t.U_Combining_Latin_Small_Letter_U=871]="U_Combining_Latin_Small_Letter_U",t[t.U_Combining_Latin_Small_Letter_C=872]="U_Combining_Latin_Small_Letter_C",t[t.U_Combining_Latin_Small_Letter_D=873]="U_Combining_Latin_Small_Letter_D",t[t.U_Combining_Latin_Small_Letter_H=874]="U_Combining_Latin_Small_Letter_H",t[t.U_Combining_Latin_Small_Letter_M=875]="U_Combining_Latin_Small_Letter_M",t[t.U_Combining_Latin_Small_Letter_R=876]="U_Combining_Latin_Small_Letter_R",t[t.U_Combining_Latin_Small_Letter_T=877]="U_Combining_Latin_Small_Letter_T",t[t.U_Combining_Latin_Small_Letter_V=878]="U_Combining_Latin_Small_Letter_V",t[t.U_Combining_Latin_Small_Letter_X=879]="U_Combining_Latin_Small_Letter_X",t[t.LINE_SEPARATOR=8232]="LINE_SEPARATOR",t[t.PARAGRAPH_SEPARATOR=8233]="PARAGRAPH_SEPARATOR",t[t.NEXT_LINE=133]="NEXT_LINE",t[t.U_CIRCUMFLEX=94]="U_CIRCUMFLEX",t[t.U_GRAVE_ACCENT=96]="U_GRAVE_ACCENT",t[t.U_DIAERESIS=168]="U_DIAERESIS",t[t.U_MACRON=175]="U_MACRON",t[t.U_ACUTE_ACCENT=180]="U_ACUTE_ACCENT",t[t.U_CEDILLA=184]="U_CEDILLA",t[t.U_MODIFIER_LETTER_LEFT_ARROWHEAD=706]="U_MODIFIER_LETTER_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_RIGHT_ARROWHEAD=707]="U_MODIFIER_LETTER_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_UP_ARROWHEAD=708]="U_MODIFIER_LETTER_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_DOWN_ARROWHEAD=709]="U_MODIFIER_LETTER_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING=722]="U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING",t[t.U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING=723]="U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING",t[t.U_MODIFIER_LETTER_UP_TACK=724]="U_MODIFIER_LETTER_UP_TACK",t[t.U_MODIFIER_LETTER_DOWN_TACK=725]="U_MODIFIER_LETTER_DOWN_TACK",t[t.U_MODIFIER_LETTER_PLUS_SIGN=726]="U_MODIFIER_LETTER_PLUS_SIGN",t[t.U_MODIFIER_LETTER_MINUS_SIGN=727]="U_MODIFIER_LETTER_MINUS_SIGN",t[t.U_BREVE=728]="U_BREVE",t[t.U_DOT_ABOVE=729]="U_DOT_ABOVE",t[t.U_RING_ABOVE=730]="U_RING_ABOVE",t[t.U_OGONEK=731]="U_OGONEK",t[t.U_SMALL_TILDE=732]="U_SMALL_TILDE",t[t.U_DOUBLE_ACUTE_ACCENT=733]="U_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_RHOTIC_HOOK=734]="U_MODIFIER_LETTER_RHOTIC_HOOK",t[t.U_MODIFIER_LETTER_CROSS_ACCENT=735]="U_MODIFIER_LETTER_CROSS_ACCENT",t[t.U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR=741]="U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_HIGH_TONE_BAR=742]="U_MODIFIER_LETTER_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_MID_TONE_BAR=743]="U_MODIFIER_LETTER_MID_TONE_BAR",t[t.U_MODIFIER_LETTER_LOW_TONE_BAR=744]="U_MODIFIER_LETTER_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR=745]="U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK=746]="U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK=747]="U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_UNASPIRATED=749]="U_MODIFIER_LETTER_UNASPIRATED",t[t.U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD=751]="U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_UP_ARROWHEAD=752]="U_MODIFIER_LETTER_LOW_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD=753]="U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD=754]="U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RING=755]="U_MODIFIER_LETTER_LOW_RING",t[t.U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT=756]="U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT=757]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT=758]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_LOW_TILDE=759]="U_MODIFIER_LETTER_LOW_TILDE",t[t.U_MODIFIER_LETTER_RAISED_COLON=760]="U_MODIFIER_LETTER_RAISED_COLON",t[t.U_MODIFIER_LETTER_BEGIN_HIGH_TONE=761]="U_MODIFIER_LETTER_BEGIN_HIGH_TONE",t[t.U_MODIFIER_LETTER_END_HIGH_TONE=762]="U_MODIFIER_LETTER_END_HIGH_TONE",t[t.U_MODIFIER_LETTER_BEGIN_LOW_TONE=763]="U_MODIFIER_LETTER_BEGIN_LOW_TONE",t[t.U_MODIFIER_LETTER_END_LOW_TONE=764]="U_MODIFIER_LETTER_END_LOW_TONE",t[t.U_MODIFIER_LETTER_SHELF=765]="U_MODIFIER_LETTER_SHELF",t[t.U_MODIFIER_LETTER_OPEN_SHELF=766]="U_MODIFIER_LETTER_OPEN_SHELF",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROW=767]="U_MODIFIER_LETTER_LOW_LEFT_ARROW",t[t.U_GREEK_LOWER_NUMERAL_SIGN=885]="U_GREEK_LOWER_NUMERAL_SIGN",t[t.U_GREEK_TONOS=900]="U_GREEK_TONOS",t[t.U_GREEK_DIALYTIKA_TONOS=901]="U_GREEK_DIALYTIKA_TONOS",t[t.U_GREEK_KORONIS=8125]="U_GREEK_KORONIS",t[t.U_GREEK_PSILI=8127]="U_GREEK_PSILI",t[t.U_GREEK_PERISPOMENI=8128]="U_GREEK_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_PERISPOMENI=8129]="U_GREEK_DIALYTIKA_AND_PERISPOMENI",t[t.U_GREEK_PSILI_AND_VARIA=8141]="U_GREEK_PSILI_AND_VARIA",t[t.U_GREEK_PSILI_AND_OXIA=8142]="U_GREEK_PSILI_AND_OXIA",t[t.U_GREEK_PSILI_AND_PERISPOMENI=8143]="U_GREEK_PSILI_AND_PERISPOMENI",t[t.U_GREEK_DASIA_AND_VARIA=8157]="U_GREEK_DASIA_AND_VARIA",t[t.U_GREEK_DASIA_AND_OXIA=8158]="U_GREEK_DASIA_AND_OXIA",t[t.U_GREEK_DASIA_AND_PERISPOMENI=8159]="U_GREEK_DASIA_AND_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_VARIA=8173]="U_GREEK_DIALYTIKA_AND_VARIA",t[t.U_GREEK_DIALYTIKA_AND_OXIA=8174]="U_GREEK_DIALYTIKA_AND_OXIA",t[t.U_GREEK_VARIA=8175]="U_GREEK_VARIA",t[t.U_GREEK_OXIA=8189]="U_GREEK_OXIA",t[t.U_GREEK_DASIA=8190]="U_GREEK_DASIA",t[t.U_OVERLINE=8254]="U_OVERLINE",t[t.UTF8_BOM=65279]="UTF8_BOM"})(X||(X={}));var XO=/^\w[\w\d+.-]*$/,ZO=/^\//,ek=/^\/\//;function tk(t,e){if(!t.scheme&&e===!0)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${t.authority}", path: "${t.path}", query: "${t.query}", fragment: "${t.fragment}"}`);if(t.scheme&&!XO.test(t.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(t.path){if(t.authority){if(!ZO.test(t.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(ek.test(t.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}}function rk(t,e){return!t&&!e?"file":t}function ik(t,e){switch(t){case"https":case"http":case"file":e?e[0]!==Zt&&(e=Zt+e):e=Zt;break}return e}var Be="",Zt="/",ok=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,Ee=class{static isUri(e){return e instanceof Ee?!0:e==null?!1:typeof e.authority=="string"&&typeof e.fragment=="string"&&typeof e.path=="string"&&typeof e.query=="string"&&typeof e.scheme=="string"&&typeof e.fsPath=="function"&&typeof e.with=="function"&&typeof e.toString=="function"}constructor(e,r,i,o,n,s=!1){typeof e=="object"?(this.scheme=e.scheme||Be,this.authority=e.authority||Be,this.path=e.path||Be,this.query=e.query||Be,this.fragment=e.fragment||Be):(this.scheme=rk(e,s),this.authority=x(r,Be),this.path=ik(this.scheme,x(i,Be)),this.query=x(o,Be),this.fragment=x(n,Be),tk(this,s))}get fsPath(){return vh(this,!1)}with(e){if(e==null)return this;let{scheme:r,authority:i,path:o,query:n,fragment:s}=e;return r===void 0?r=this.scheme:r===null&&(r=Be),i===void 0?i=this.authority:i===null&&(i=Be),o===void 0?o=this.path:o===null&&(o=Be),n===void 0?n=this.query:n===null&&(n=Be),s===void 0?s=this.fragment:s===null&&(s=Be),r===this.scheme&&i===this.authority&&o===this.path&&n===this.query&&s===this.fragment?this:new La(r,i,o,n,s)}static parse(e,r=!1){let i=ok.exec(e);if(!i)return new La(Be,Be,Be,Be,Be);let o=i[2]||Be,n=Kc(i[4]||Be),s=(i[5]||Be).split("/").map(Kc).join("/"),a=o==="psfile"&&s.startsWith("//")?s.slice(1):s,m=Kc(i[7]||Be),c=Kc(i[9]||Be);return new La(o,n,a,m,c,r)}static file(e){let r=Be;if(O&&(e=e.replace(/\\/g,Zt)),e[0]===Zt&&e[1]===Zt){let i=e.indexOf(Zt,2);i===-1?(r=e.substring(2),e=Zt):(r=e.substring(2,i),e=e.substring(i)||Zt)}return new La("file",r,e,Be,Be)}static from(e){return new La(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...r){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let i;return O&&e.scheme==="file"?i=Ee.file(Gc.win32.join(vh(e,!0),...r)).path:i=Gc.posix.join(e.path,...r),e.with({path:i})}isRootPath(){return this.path==null||this.path===Zt}get pathBase(){return this.isRootPath()?"":f(this.path,e=>Lb(e.split(Zt),M))}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(Zt))})}join(...e){return this.with({path:Mt(this.path,Zt)+e.join(Zt)})}toString(e=!1){return Sh(this,e)}toJSON(){return this}[mS.inspect.custom](){return this.toString()}},nk=Hw?1:void 0,La=class extends Ee{constructor(){super(...arguments);this._formatted=null;this._fsPath=null}get fsPath(){return this._fsPath==null&&(this._fsPath=vh(this,!1)),this._fsPath}toString(e=!1){return e?Sh(this,!0):(this._formatted==null&&(this._formatted=Sh(this,!1)),this._formatted)}toJSON(){let e={$mid:1};return this._fsPath!=null&&(e.fsPath=this._fsPath,e._sep=nk),this._formatted!=null&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),this.query&&(e.query=this.query),this.fragment&&(e.fragment=this.fragment),e}},uS={[X.Colon]:"%3A",[X.Slash]:"%2F",[X.QuestionMark]:"%3F",[X.Hash]:"%23",[X.OpenSquareBracket]:"%5B",[X.CloseSquareBracket]:"%5D",[X.AtSign]:"%40",[X.ExclamationMark]:"%21",[X.DollarSign]:"%24",[X.Ampersand]:"%26",[X.SingleQuote]:"%27",[X.OpenParen]:"%28",[X.CloseParen]:"%29",[X.Asterisk]:"%2A",[X.Plus]:"%2B",[X.Comma]:"%2C",[X.Semicolon]:"%3B",[X.Equals]:"%3D",[X.Space]:"%20"};function cS(t,e){let r,i=-1;for(let o=0;o<t.length;o++){let n=t.charCodeAt(o);if(n>=X.a&&n<=X.z||n>=X.A&&n<=X.Z||n>=X.Digit0&&n<=X.Digit9||n===X.Dash||n===X.Period||n===X.Underline||n===X.Tilde||e&&n===X.Slash)i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r!==void 0&&(r+=t.charAt(o));else{r===void 0&&(r=t.substr(0,o));let s=uS[n];s!==void 0?(i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r+=s):i===-1&&(i=o)}}return i!==-1&&(r+=encodeURIComponent(t.substring(i))),r!==void 0?r:t}function sk(t){let e;for(let r=0;r<t.length;r++){let i=t.charCodeAt(r);i===X.Hash||i===X.QuestionMark?(e===void 0&&(e=t.substr(0,r)),e+=uS[i]):e!==void 0&&(e+=t[r])}return e!==void 0?e:t}function vh(t,e){let r;return t.authority&&t.path.length>1&&t.scheme==="file"?r=`//${t.authority}${t.path}`:t.path.charCodeAt(0)===X.Slash&&(t.path.charCodeAt(1)>=X.A&&t.path.charCodeAt(1)<=X.Z||t.path.charCodeAt(1)>=X.a&&t.path.charCodeAt(1)<=X.z)&&t.path.charCodeAt(2)===X.Colon?e?r=t.path.substr(1):r=t.path[1].toLowerCase()+t.path.substr(2):r=t.path,O&&(r=r.replace(/\//g,"\\")),r}function Sh(t,e){let r=e?sk:cS,i="",{scheme:o,query:n,fragment:s}=t,{authority:a,path:m}=t;if(o&&(i+=o,i+=":"),(a||o==="file")&&(i+=Zt,i+=Zt),a){let c=a.indexOf("@");if(c!==-1){let d=a.substr(0,c);a=a.substr(c+1),c=d.indexOf(":"),c===-1?i+=r(d,!1):(i+=r(d.substr(0,c),!1),i+=":",i+=r(d.substr(c+1),!1)),i+="@"}c=a.indexOf(":"),c===-1?i+=r(a,!1):(i+=r(a.substr(0,c),!1),i+=a.substr(c))}if(m){if(m.length>=3&&m.charCodeAt(0)===X.Slash&&m.charCodeAt(2)===X.Colon){let c=m.charCodeAt(1);c>=X.A&&c<=X.Z&&(m=`/${String.fromCharCode(c+32)}:${m.substr(3)}`)}else if(m.length>=2&&m.charCodeAt(1)===X.Colon){let c=m.charCodeAt(0);c>=X.A&&c<=X.Z&&(m=`${String.fromCharCode(c+32)}:${m.substr(2)}`)}i+=r(m,!0)}return n&&(i+="?",i+=r(n,!1)),s&&(i+="#",i+=e?s:cS(s,!1)),i}function fS(t){try{return decodeURIComponent(t)}catch{return t.length>3?t.substr(0,3)+fS(t.substr(3)):t}}var pS=/(%[0-9A-Za-z][0-9A-Za-z])+/g;function Kc(t){return t.startsWith("xn--")?(0,lS.toUnicode)(t):t.match(pS)?t.replace(pS,e=>fS(e)):t}function nm(t){return Ee.isUri(t)?t:Ee.parse(t)}var sm=Hc(t=>j(t,Or),{maxSize:128,ttlMs:E});B(()=>{W(()=>Mh.unset()),Sr.onChange(()=>Mh.unset())});var Mh=l(async()=>y(Sr(),t=>cc(t.map(e=>[sm(e.uuid),e.mountpoint]))));function dS(t,e){if(T(t)||e==null||T(e.uuid))return;let r=Zr(t),i=Zr(e.mountpoint);if(!r.normalize().startsWith(i.normalize()))return;let o=Li(r.slice(i.length),"/");return Ee.from({scheme:vo,authority:sm(e.uuid),path:o})}function Ph(t,e){return(0,Jc.join)(t,...e.split("/").slice(1))}async function hS(t,e){if(t.scheme!==vo)throw new Error("invalid URI: "+t+" (bad scheme)");if(T(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=e!=null&&e.includes(Jc.sep);if(r){let o=await Aa(e);if(o?.uuid!=null&&sm(o.uuid)===t.authority)return Ph(e,t.path)}let i=await y(Mh(),o=>o.get(t.authority));if(M(i))return Ph(i,t.path);if(r)return Ph(e,t.path)}var gS=v(require("path"));var qre=Ee.from({scheme:ji,path:""});function yS(t){let e=u.libraryPath.value;if(T(e)||T(t)||!t.startsWith(e))return;let r="/"+Ju({nativePath:e},{nativePath:t});return Ee.from({scheme:ji,path:r})}function bS(t){if(t.scheme!==ji)throw new Error("invalid URI: "+t+" (bad scheme)");let e=u.libraryPath.value;if(T(e))throw new Error("invalid URI: "+t+" (no library set)");return(0,gS.join)(e,...t.path.split("/"))}var ps=v(require("path"));function wS(t,e){if(!T(t)){if(e!=null&&e.remote===!0&&M(e.remoteHost)&&M(e.remoteShare))return Ee.from({scheme:ni,authority:e.remoteHost,path:ps.posix.join("/"+e.remoteShare,Qe(Zr(t),Zr(e.mountpoint)))});if(t.startsWith("\\\\"))return Ee.file(t).with({scheme:ni})}}async function xS(t,e){if(t.scheme!==ni)throw new Error("invalid URI: "+t+" (bad scheme)");if(T(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=t.path.split("/").slice(1),i=r[0];if(T(i))throw new Error("invalid URI: "+t+" (missing share)");if(O)return`\\\\${t.authority}\\${r.join(ps.sep)}`;let o=r.slice(1),n=await Sr();for(let s of D(n))if(!!s.remote&&Ye(s.remoteShare,i)&&await Iv(t.authority,s.remoteHost))return(0,ps.join)(s.mountpoint,...o);if(await ua(e))return(0,ps.join)(e,...o)}var ak=["http:","https:","file:",vo,ni].map(t=>t+"//");function TS(t){let e=h(t).toLowerCase();return ak.some(r=>e.startsWith(r))}var lk=l(()=>p("UriNormalization"));function vS(t){try{return Ee.parse(t).toString()}catch(e){return lk().warn("Failed to normalize invalid URI",{uri:t,err:e}),t}}function mk(t,e){try{if(t==null||e==null)return!1;let r=Ee.parse(t),i=Ee.parse(e);return r.scheme===i.scheme&&r.authority===i.authority&&r.path.normalize()===i.path.normalize()}catch{return!1}}async function SS(t,e){try{if(t==null||e==null)return!1;if(oo(t,e))return!0;let r=t.toString(),i=e.toString();return mk(r,i)?!0:await ra(ds(r),ds(i),(o,n)=>o.normalize()===n.normalize(),()=>!1)}catch{return!1}}var MS=l(()=>p("FileURI"));async function PS(t,e){if(t==null||T(t))return MS().throw("empty nativePath passed to nativePath2uri()",{retriable:!1});let r=l(()=>Pe(e,()=>Aa(t)));return Ut(()=>yS(t),async()=>dS(t,await r()),async()=>wS(t,await r()),()=>Ee.file(t))}function uk(t){try{return Ee.isUri(t)?t:Ee.parse(t,!0)}catch(e){MS().warn("bad URI",{uri:t,err:e});return}}async function ds(t,e){if(T(t))return;let r=uk(t);if(r!=null)switch(r.scheme){case"file":return r.fsPath;case vo:return hS(r,e);case ni:return xS(r,e);case ji:return bS(r);default:throw new Error("unsupported URI: "+t)}}async function ck(t){let e=await Te.instance().executeJsonToA(["Get-Item -Force -LiteralPath",is(t.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return C(e).flatMap(r=>r[0]).flatMap(r=>r.Mode).filter(M).flatMap(r=>r.includes("h")||r.includes("s")).getOrElse(()=>!1)}async function fk(t){try{let e=await se("stat",["-f","%f",t.nativePath],{timeout:10*S}),r=U(e);return r!=null?(r&32768)>0:!1}catch(e){return!1}}function $c(t){return t.base.startsWith(".")?!0:O?ck(t):fe?fk(t):!1}function DS(t,e,r){let i={};try{for(let o of t)for(let n of gt(o)){let s=o[n]();if(i[n]=x(s,!1),s===!0)return s}return!1}finally{ES(r,e,i)}}function ES(t,e,r){let i=r==null?"warn":"debug";t.log(i,e,r)}async function AS(t,e,r){let i={};try{for(let o of t)for(let n of gt(o)){let s=await o[n]();if(i[n]=s,s)return s}return!1}finally{ES(r,e,i)}}var Eh=class{constructor(){this.store=new Map}add(e,r){yr(this.store,e,()=>new Set).add(r)}delete(e,r){f(this.store.get(e),i=>{i.delete(r),i.size===0&&this.store.delete(e)})}find(e){return Wo(e.findIndex((r,i)=>this.store.get(r)?.has(e[i+1])),r=>e.slice(r,r+2))}has(e){return this.find(e)!=null}};var pk=l(()=>p("NeverIgnoredPaths")),dk=l(()=>{u.neverIgnored.addListener(()=>{am.clear(),Fr(),pk().info("Settings.neverIgnored changed",u.neverIgnored.value)}),u.scanPaths.addListener(()=>{am.clear(),Fr()}),W(()=>am.clear())}),am=l(()=>(dk(),new Set(G([...u.scanPaths.values,...u.neverIgnored.values]))));function Fa(t){return am().has(t)||am().has(t.toLowerCase())}function LS(t){return Fa(t)?{pathIsNeverIgnored:()=>!1}:void 0}var FS=v(require("path"));var hk=/^\.?NoMedia$/i,IS="NoMedia";function OS(t){return[t,t.toLowerCase(),t.toUpperCase()]}var gk=Object.freeze([...OS("."+IS),...OS(IS)]);function Qc(t){return hk.exec(t)!=null}var Yc=new Vi({maxSize:1024,timeoutMs:cr,clearEveryMs:E});B(()=>W(()=>Yc.clear()));B(()=>Xt(t=>{t==null?Yc.clear():Yc.deleteIf(e=>e.startsWith(t))}));var Xc=l(()=>p("hasNoMedia()"));async function ln(t){return t==null?!1:Fa(t.nativePath)?Xc().tap({msg:t+" is never ignored",result:!1}):t instanceof ae?ln(await t.directoryEntry()):Qc(t.base)?Xc().tap({msg:t+" basename is NoMedia",result:!0}):Ko(t.nativePath).some(Qc)?Xc().tap({msg:t+" parent path is NoMedia",result:!0}):await t.isDirectory()&&await Yc.getOrSetAsync(t.nativePath,async()=>{for(let r of gk)if(await ox((0,FS.join)(t.nativePath,r)))return Xc().tap({msg:t+" is a directory and has a noMedia child, "+r,result:!0});return!1})===!0?!0:t.isRoot?!1:y(t.parent(),ln)}function kS(t){let e=u.maxDuplicatePathElements.valueOrDefault;for(let r of new Set(t))if($r(t,i=>i===r)>e)return!0;return!1}var _e=class{constructor(e){this.apply=e}static lift(e){return new _e(e)}static and(...e){return new _e(async r=>{for(let i of e)if(!await i.apply(r))return!1;return!0})}static or(...e){return new _e(async r=>{for(let i of e)if(await i.apply(r))return!0;return!1})}static logged(e,...r){return Nb(r,i=>Ke(i).map(([o,n])=>n.asAsync().logged(e,o)))}static andLogged(e,...r){return this.and(...this.logged(e,...r))}static orLogged(e,...r){return this.or(...this.logged(e,...r))}static async andExplain(e,r){let i=[],o=[];for(let n of r)for(let[s,a]of Ke(n))(await a.apply(e)?i:o).push(s);return{accepted:i,rejected:o}}asAsync(){return this}and(...e){return _e.and(this,...e)}not(){return new _e(e=>ct(this.apply(e)))}or(e){return new _e(async r=>await this.apply(r)||await e.apply(r))}async filter(e){return Il(e,r=>this.apply(r))}logged(e,r){return new _e(async o=>{let n=await this.apply(o);return e.log(n?"debug":"info",[qs(r),n?wu("ACCEPT"):bu("REJECT"),Yt(o)].join(" ")),n})}};var yk=p("Snap"),_S=_e.lift(async t=>{if(!await RS())return!1;let r=Ko(t.nativePath).indexOf("snap");return r<0?!1:D(await bk()).includes(Ko[r+1])}),RS=l(async()=>{if(!ot||Oe())return!1;try{return await se("snap",["--version"],{timeout:10*S,quiet:!0,maxRetries:0}),!0}catch{return!1}}),bk=l(async()=>{if(!await RS())return[];try{return await bo(["Name","Version"],await se("snap",["list"],{timeout:10*S})).map(t=>t.Name)}catch(t){return yk.warn("snap failed",t),[]}},30*S);var NS=class{constructor(e=he){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize()));this.ignorableDirectories=new Set(["#snapshot","__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Support","Applications","arangodb","cache","caches","CacheClip","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iMovie Cache","iTunes Cache","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","SteamApps","System Volume Information","System32","temp","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase()));this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/resources\/media\/face/i,/\/facetile[-_]/i,/\/.*?\.photos?library\/(?!(masters?|originals)\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i];this.systemDirs=H(G([ca(),Ne("APPDATA"),Ne("SYSTEMROOT"),Ne("ProgramFiles"),Ne("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize()));this.ignorableSubdirs=new Eh;ot&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);let r=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",r),this.addIgnorableSubdirs("cygwin",r),this.addIgnorableSubdirs("cygwin64",r),this.addIgnorableSubdirs("local",r),this.addIgnorableSubdirs("Windows",["Boot","Containers","Cursors","Fonts","Help","Installer","Logs","Microsoft.NET","SoftwareDistribution","System","System32","SysWOW64","Temp"]),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...r]),this.addIgnorableSubdirs("lfs",["objects"]),this.addIgnorableSubdirs("var",["cache","crash","games","lib","local","lock","log","mail","run","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);let i=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",i),this.addIgnorableSubdirs("Perl64",i),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(Ne("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("temp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),O&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,r){if(T(e))return;let i=e.toLowerCase().normalize();G(r).forEach(o=>this.ignorableSubdirs.add(i,o.toLowerCase().normalize()))}ignorablePathPredicates(e){let r=LS(e);if(r!=null)return r;let i=e.toLowerCase().normalize(),o=G(Ko(i));return{hiddenPosix:()=>o.some(n=>n.startsWith(".")),systemDir:()=>this.systemDirs.some(n=>i.startsWith(n)),ignorableRoot:()=>this.ignorableRootDirectories.has(o[0]),ignorableDirectory:()=>o.some(n=>this.ignorableDirectories.has(n)),ignorablePath:()=>this.ignorableSubdirs.has(o),ignorablePattern:()=>{let n=Zr(e);return this.ignorableDirectoryPatterns.some(s=>s.test(n))}}}ignorablePath(e){return DS([this.ignorablePathPredicates(e)],e,p("ignorablePath()"))}},BS=l(()=>new NS);function wk(t){return b(b({},BS().ignorablePathPredicates(t)),{notExists:()=>ne.for(t).notExists()})}function lm(t){return BS().ignorablePath(t)}function CS(t){return lm(t.nativePath)}function xk(t){let e=t.nativePath.toLowerCase().normalize();return Fa(t.nativePath)||Fa(e)?{pathIsNeverIgnored:()=>!1}:b(b({},wk(t.nativePath)),{snapDirectory:async()=>ot&&await _S.apply(t),noMedia:async()=>await ln(t)===!0,hidden:()=>$c(t),seemsRecursive:()=>kS(t.pathnames),mountpoint:async()=>ye(dt(),r=>r.includes(t.nativePath),()=>!1)})}async function VS(t){return AS([xk(t)],t.nativePath,p("ignorableDirectory()"))}var US=new Nl;var ne=class extends ae{constructor(e,r){super(e,r);this.nativePath=e;this.pflog=l(()=>p("PosixFile("+this.nativePath+")"));this.uriObject=l(()=>PS(this.nativePath));this.uri=l(()=>y(this.uriObject(),h));this.fileuri=l(()=>Ee.file(this.nativePath).toString());this.mountpoint=l(()=>O&&this.nativePath.startsWith("\\\\")?this.for(this.nativePath.split("\\").slice(0,4).join("\\")):y(dt(),e=>this.bestMountpoint(e.map(r=>this.for(r)))));this.etag=l(()=>y(this.stat(),e=>[e.size,e.mtime.getTime()].map(r=>Qo.encode(r)).join("-")));this.isMountpoint=l(async()=>await this.isDirectory()&&await ye(dt(),e=>e.includes(this.nativePath),()=>!1));this.sidecars=l(async()=>{if(this.isSidecar())return[];let e=await this.parent().childDirectoryEntries(i=>i.base!==this.base&&rm(i.ext)&&(i.name===this.name||i.name===this.base||(u.matchSidecarsCaseInsensitively.valueOrDefault?Ye(i.name,this.name)||Ye(i.name,this.base):!1)||Ir(i.name)===Ir(this.name)||(u.matchSidecarsCaseInsensitively.valueOrDefault?Ye(Ir(i.name),Ir(this.name)):!1)));if(e==null)return[];let r=e.map(i=>this.parent()._directoryEntryChild(i));return Pl(r,i=>i.maxStatMs())});this.shaWithSidecars=l(async()=>{let e=[this,...await this.sidecars()].map(i=>i.nativePath);return(await nc(or(e))).toString("base64")},ae.attrTTL)}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(T(e))throw new Error("unexpectedly empty path");if(e instanceof ne)return e;if(e instanceof ae)return this.for(e.nativePath,r);if(TS(e))throw new Error("use forUri");let i=US.get(e);if(i!=null)return i;let o=ei(e);return US.getOrSet(o,()=>new ne(o,r))}static forPosix(e){return this.for(e.replace(/\//g,zS.sep))}static forUri(e,r){return y(ds(e,r),i=>this.for(i))}for(e,r){return ne.for(e,r)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.sidecars.unset(),this}bestMountpoint(e){return Dt(e.filter(r=>la(this.nativePath,r.toString())).map(r=>ne.for(r)),r=>C(hl(this.pathnames,r.pathnames)).filter(i=>i>=r.pathnames.length).get())}async isDeleted(e){if(e=await Kr(e,()=>this.uri()),this.isUNC)return this.pflog().tap({result:void 0,msg:"isDeleted(): UNC not supported"});if(await this.exists())return this.pflog().tap({result:!1,msg:"isDeleted(): file exists"});if(e==null)return this.pflog().tap({result:void 0,level:"warn",msg:"isDeleted(): missing URI"});if(e=nm(e),e.isRootPath())return this.pflog().tap({result:void 0,msg:"isDeleted(): uri isRootPath",meta:{uri:e}});if(h(e.pathBase).normalize()!==this.base.normalize())return this.pflog().tap({level:"warn",result:void 0,msg:"isDeleted(): uri isn't correct",meta:{uri:e,expectedBase:this.base,uriBase:e.pathBase}});let r=await this.parent().isDeleted(e.parent());return r==null?this.pflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{uri:e}}):this.pflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted, which means I am deleted.",meta:{parentDeleted:r,uri:e}})}async httpHeaders(){return{ETag:await this.etag(),"Last-Modified":await this.lastModifiedUtc()}}async hide(){let e=await(O?se("attrib",["+h",this.nativePath],{timeout:10*S}).catch(r=>r):fe?se("chflags",["hidden",this.nativePath],{timeout:10*S}).catch(r=>r):"");if(M(e)){this.pflog().warn("hide("+this.nativePath+") failed: "+e);return}else return this.clear()}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}async mkNoMedia_(){if(await this.isFile())throw new Error("mkNoMedia(): "+this+" is a file.");await this.mkdirp_();let e=this.join(".NoMedia");await e.isNotDirectory()&&await e.isEmpty()&&(await e.writeTxt_(["This directory's contents are excluded from PhotoStructure libraries.","","See <https://photostructure.com/nomedia/> for details."].join(`
`)),Fr(this.nativePath))}async mkNoMedia(){try{return await this.mkNoMedia_(),this}catch(e){this.pflog().warn("Could not add .NoMedia file to "+this,e);return}}hasNoMedia(){return ln(this)}ignorableCheap(){return lm(this.nativePath)}async ignorable(){return await this.isDirectory()?VS(this):CS(this)}hidden(){return $c(this)}isSidecar(){return rm(this.ext)}async sidecar(){return bt(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+Li(u.defaultSidecarType.valueOrDefault,".").toLowerCase()))}async jsonSidecars(){let e=await this.siblings(r=>Ye(r.ext,".json")&&(r.name===this.name||r.name===this.base||Ir(r.name)===Ir(this.name)));return this.pflog().tap({msg:"jsonSidecars()",result:e==null?void 0:await Pl(e,r=>r.maxStatMs())})}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",async()=>{let e=await this.mtimeMs(),r=await this.sidecars(),i=await Promise.all(D(r).map(n=>n.mtimeMs())),o=[e,...i].filter(N);return De(o,n=>Math.floor(Math.max(...n)))})}thisOrSidecareMaxMtimeSec(){return y(this.thisOrSidecareMaxMtimeMs(),e=>Ii(e))}};var WS=`
Hello, and thank you for using PhotoStructure!

The files in this folder support your PhotoStructure Library, including

  * a database with the filepaths to your photos and movies
  * previews and thumbnails of your photos and movies
  * content metadata about these assets, like ratings and sharing information
  * albums that both you and PhotoStructure Curators have assembled

Moving or deleting any files here will cause problems using your library.

If you have any questions, please visit <https://photostructure.com/support/>.

Sincerely,

Your Friendly Neighborhood PhotoStructure, v${ft}`;function xt(t=u.libraryPath.value){return j(t,e=>ne.for(e).join(".photostructure"))}function mm(t=u.libraryPath.value){return j(t,e=>ne.for(e).join(u.originalsDir.valueOrDefault))}async function Zc(t){let e=xt(t);if(e==null)throw new Error("empty dataDir");if(await e.mkdirp()==null)throw new Error("Could not mkdirp "+e);await e.mkNoMedia();let r=e.join("README.txt");return await r.size()!==WS.length&&await r.writeTxt_(WS),e}var um=p("SettingsIO"),jS="settings.toml";function Dh(){return ne.for(oi()).join(jS)}function ef(t){return Je([t,u.libraryPath.value],e=>j(e,r=>f(xt(r),i=>i.join(jS))))}async function Tk(){I(u.scanMyPictures.value)&&(u.scanMyPictures.value=!1,u.scanPaths.push(await jT()))}async function si(t=Dh()){let e=await Pe(HS(t),()=>[]);return await Tk(),jt.unset(),e}async function KS(){return GS(Dh())}async function JS(t){return f(ef(t),e=>GS(e))}var jt=l(()=>vk(),xr);B(()=>{W(()=>jt.unset()),u.libraryPath.addListener(()=>jt.unset())});function vk(t){let e=ef(t);return um.tap({msg:"_libraryHasSettings",result:x(e?.clear().existsSync(),!1),level:"info",meta:{libraryPath:t,settings:u.libraryPath.value,librarySettingsFile:e?.nativePath}})}var Sk=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;async function GS(t){return y(t.firstMatchingLine(Sk),e=>e[1])}var $S={maxLineLen:78,prefix:"# "};async function QS(t,e){let r=await t.clear().isNonEmpty(),i=r?await t.wip():t;await Mk(i,e,t),um.info("maybeWriteFile(): wrote settings",{dest:i,file:t,nonDefaults:e.filter(o=>o.hasValue()).map(o=>({name:o.name,value:o.value}))}),r&&(await ct(zn(tf(i),tf(t)))&&(um.info("Archiving prior, different contents",{dest:i,file:t}),await t.renameYMDHMS_("old")),await i.unwip_())}var Pk=l(()=>ft);async function Mk(t,e,r){let i=x(await tf(r),{}),o=ie(["","Hello!","",`These are ${e[0].categoryType} settings for PhotoStructure.`,""," - Please shut down PhotoStructure before editing this file.",""," - PhotoStructure has TWO settings files!",""," - Most settings have reasonable defaults, which are provided after the",'   description. Remove the "#" from the beginning of the line to override',"   the default.",""," - See <https://photostructure.com/getting-started/advanced-settings/>","   for more details","","Thanks for using PhotoStructure! Visit <https://photostructure.com/support> or email <support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+Pk()].map(s=>lo(s,$S)));o.push("","");let n="";e.forEach(s=>{let a=`${$b(s.categoryType)}.${s.category.toLowerCase()}`;a!==n&&(n=a,o.push("",Hs("#",78),"#","# Settings for "+a+":","#","",""));let m="# +"+Hs("-",s.name.length+4)+"+",c=Ke(b(b({env:s.key},De(s.opts.envAliases,A=>({"env aliases":A}))),s.addToJSON())).map(([A,V])=>`${A}: ${k(V)}`).join(", ");o.push(...lo([m,"|  "+s.name+"  |",m,"",`${s.opts.description.replace(/\n/g,`

`)}`,`(${c})`,""].join(`
`),$S));let d=i[s.name],w={},P=s.valueToPersist(d);P!=null?(w[s.name]=P,o.push(...YS(w))):(w[s.name]=s.exampleValue,o.push(...YS(w).map(A=>"# "+A))),o.push("","")}),await t.writeTxt_(`
`+o.map(s=>s.trimRight()).join(`
`)+`

`),Vu()}function YS(t){return zi(...Ke(t).map(([e,r])=>e+" = "+k(r,void 0,2)))}async function rf(t=Dh()){return QS(t,XT())}async function of(t){return f(ef(t),e=>HS(e))}async function XS(t){await Zc(su(t,u.libraryPath.value));let e=ef(t);return um.warn("writeLibrarySettings("+e+")"),await f(e,r=>QS(r,ZT())),jt.unset(),e}async function tf(t){return y(t.readFile(),e=>um.tap({msg:`read(${t})`,result:qS.default.parse(Wp(e.toString()))}))}async function HS(t){let e=p("SettingsIO.importFileSettings("+t.nativePath+")");try{let r=await tf(t);if(r==null){if(await t.isNonEmpty())throw new Error("Failed to read "+t);return[]}let i=new Map(Ke(u).filter(([,n])=>n instanceof _r&&!n.transient).map(([n,s])=>[n.toLowerCase(),s])),o=L(Ke(r).map(([n,s])=>{let a=i.get(h(n).toLowerCase());return a==null?e.warn("Failed to import (no setting with this name)",{key:n}):a.importFromFile(s),a}));return e.info("loaded",{tomlMap:r,imported:o.map(n=>rt(n,"name","value","persist"))}),o}catch(r){e.error("Cannot read"+ur(r));return}}var cse=l(()=>new Set([u.logLevel,u.httpPort,u.rpcPort,u.license].map(t=>t.key)));var eM={beforeParse:t=>t.option("-p, --pidfile PIDFILE",'Write a pidfile of the main process. PIDFILE must be an absolute path (like "/var/pids/photostructure.pid").').option("--stop","Shutdown daemonized PhotoStructure. Requires --pidfile").option("-d, --daemon","Run PhotoStructure as a daemon. Enabled by default when --pidfile is provided."),afterParse:async t=>{if(j(t.pidfile,r=>u.pidfile.tmpValue=r),I(t.stop)){if(!u.pidfile.hasValue()&&(await si(),!u.pidfile.hasValue()))return console.error("--stop requires --pidfile to be set."),Hi.default.exit(1);let r=ae.for(u.pidfile.value);if(await r.notExists())return console.error("Pidfile "+r+" does not exist."),Hi.default.exit(1);let i=U(await y(r.readFile(),o=>o.toString()));return N(i)?await xT(i)?(console.error("Pid "+i+" does not exist."),Hi.default.exit(1)):(await ba(i),Hi.default.exit(0)):(console.error("Pidfile "+r+" is invalid."),Hi.default.exit(1))}if(!I(Hi.default.env.__is_daemon)&&(I(t.daemon)||u.pidfile.hasValue())){let r=Hi.default.argv.findIndex(a=>!a.includes("npx")&&!a.includes("node")),i=Hi.default.argv.slice(r===-1?0:r),o=process.execPath,n=b(b({},jd(void 0,!1)),{__is_daemon:"1"}),s=(0,ZS.spawn)(o,i,{env:n,detached:!0,shell:!0,stdio:["ignore","ignore","ignore"]});return s.unref(),console.log("Daemonized PhotoStructure.",{pid:s.pid,args:i}),Hi.default.exit(0)}}};var tM={beforeParse:t=>t.option("--expose","Set PS_EXPOSE_NETWORK_WITHOUT_AUTH to true. Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network."),afterParse:t=>{I(t.expose)&&(u.exposeNetworkWithoutAuth.tmpValue=!0)}};var rM={beforeParse:t=>t.option("--pause-sync,--pauseSync","Pause sync processing until manually resumed via the system tray or nav menu."),afterParse:t=>{I(t.pauseSync)&&(u.startPaused.tmpValue=!0)}};var Ay=v(require("process"));var xi=class extends ze{constructor(e){super(e.name,()=>{f(this.timer,clearInterval),this.timer=void 0},x(e.rank,oe.first),()=>Z(e._isEnded,r=>r(),()=>!1),e.endTimeoutMs);this.setup(e)}async setup(e){N(e.initialDelayMs)&&await at(e.initialDelayMs),!this.ended&&(this.timer=wr(e.callback,Math.round(e.intervalMs),...D(e.args)))}};var af=v(require("process")),sM=v(require("timers"));function iM(t){return t!=null&&_(t.warn)||Ek(t)}function Ek(t){return t!=null&&_(t.bad)||Dk(t)}function Dk(t){return t!=null&&_(t.fail)}function oM(t){return H([...D(t?.bad),...D(t?.fail)])}function nf(t){return{ok:D(t.ok),warn:D(t.warn),bad:D(t.bad),fail:D(t.fail)}}function nM(...t){let e=L(t);return{ok:H(ie(e.map(r=>r.ok))),warn:H(ie(e.map(r=>r.warn))),bad:H(ie(e.map(r=>r.bad))),fail:H(ie(e.map(r=>r.fail)))}}function sf(...t){t=L(t);function e(r){return H(L(ie(t.map(r))))}return{ok:e(r=>r.ok),warn:e(r=>r.warn),bad:e(r=>r.bad),fail:e(r=>r.fail)}}var lf="--exit",Ak=l(()=>p("ChildService"));async function Lk(t){let e=Mt(t,".js"),r=ae.projectRoot(),i=ae.for((0,af.cwd)()),o=yo?[r.join("bin",e),r.join("app.asar",e)]:[i.join("dist","library",e),i.join("lib","library",e)];o.push(i.join("dist","app",e));let n=bl(o,async s=>await s.isNonEmpty(101)?s:void 0);return Ak().tap({msg:"pathToService()",level:"info",result:n,meta:{cmd:e,isPacked:yo,dirs:o.map(h)}})}var Fk=0;function Ik(t){switch(t){case"web":return 9223;case"sync":return 9224;case"sync-file":return 9225+Fk++%20;default:return 9222}}function Ok(t){let e=[];return u.inspect.valueOrDefault&&e.push("--inspect="+Ik(t)),e}var Ia=class{constructor(e,r,i){this.cmd=r;this.opts=i;this.restartCount=0;this.healthCheck=Vw("ChildService.healthCheck",async()=>{if(K()||this.ended)return;if(this.logger.debug("healthCheck(): running..."),de(this.opts.healthy)&&await this.opts.healthy()===!1){await this.restart();return}let e=this._lastStatus=new mt(this.name+" healthCheck at "+new Date).setTimeout(q);e.promise.catch(i=>(Y("healthCheck for "+this.name+": failed",i),this.restart())),await this.write("--status")||e.resolve(nf({fail:["write --status failed"]}));try{let i=await e.promise,o=oM(i);if(_(o)){this.logger.warn("healthCheck for "+this.name+": unhealthy"+Yr+Gn+", restarting ("+o.join(",")+")"),await this.restart();return}else return this.logger.debug("healthCheck: all is well",i),i}catch(i){this.logger.warn("healthCheck: failed",i);return}});this.name="ChildService("+e+")",this.logger=p(this.name);let o=[...D(i.nodeArgs),r.nativePath];_(i.args)&&o.push(...i.args),this.spawnOpts=rt(this.opts,"argv0","cwd","detached","env","gid","shell","stdio","timeout","uid","windowsHide","windowsVerbatimArguments","forceCLocale"),this.spawnOpts.forceCLocale=!1;let n=-1;this.wc=new zc(b({name:e,childFactory:async()=>(this.restartCount>0&&this.opts.onPreRestart!=null&&await this.opts.onPreRestart(),this.restartCount++,yc(af.execPath,o,n,this.spawnOpts)),endableRank:oe.service,onStdout:this.onStdout.bind(this),onError:x(this.opts.onError,()=>s=>!kt(s)),ignoreStopErrors:!1,exitCommand:lf},i)),this.healthCheckTimer=wr(()=>this.healthCheck(),E),Ru(this)}static async mk(e,r={}){let i=x(r.pathToService,await Lk(e));if(T(i))throw new Error("Failed to find path to "+e);return r.nodeArgs=[...Ok(e),...D(r.nodeArgs)],new Ia(e,i,r)}get startMs(){return this.wc.startMs}async onStdout(e){if(!T(e))try{let r=JSON.parse(e);if(M(r.fatal))this.wc.onError(this.name+".onStdout()",r.error);else if(r.healthChecks!=null){let i=this._lastStatus;i!=null&&i.pending&&i.resolve(b(b({},r.healthChecks),{ts:Date.now()}))}else this.opts.onData!=null&&this.opts.onData(r)}catch(r){console.log(e)}}start(){return this.wc.start()}stop(){return this.wc.stop()}restart(e){return this.wc.restart(e)}get ended(){return this.wc.ended}async end(){return(0,sM.clearInterval)(this.healthCheckTimer),this.wc.ended||await this.write("--quit"),this.wc.end()}get pid(){return this.wc.pid}get msSinceLastStart(){return this.wc.msSinceLastStart}running(){return this.wc.running()}notRunning(){return this.wc.notRunning()}async write(e,r=2){if(r<0)return this.logger.warn("write(): no more retries",{toStdin:e}),!1;try{let i=this.wc.proc;return i==null||i.stdin==null||!i.stdin.writable?(this.logger.warn("write(): childProc isn't open, ignoring",{toStdin:e}),!1):i.stdin.write(Mt(e,`
`))}catch(i){return this.logger.warn("write(): caught "+i),await this.wc.onError("onStdout()",i),this.write(e,r-1)}}};var Ah=class extends xi{constructor(e,r,i,o=!0){super({name:"TmpfileCleanup",intervalMs:ee(10*S,15*E,r/5),callback:()=>this.cleanup()});this.root=e;this.maxAgeMs=r;this.filter=i;this.scheduleCleanup=o;this.mutex=new ut;this.lastCleanupFinishTs=0}async cleanup(e=this.maxAgeMs){return this.ended||Date.now()-this.lastCleanupFinishTs<10*S?void 0:this.mutex.maybeRun("cleanup",()=>this._cleanup(e))}async _cleanup(e){let r=await this.root();if(r==null)return[];let i=Date.now()-e,o=[];await r.clear().visitDescendants(async s=>{let a=await s.maxStatMs();await s.isFile()&&a!=null&&!(s.parent().eql(r)&&Qc(s.base))&&await this.filter(s)&&a<i&&(o.push(s),await s.unlink().catch(m=>this.logger.warn("Failed to unlink "+s,m)))});let n=o.length;return this.logger.info("Removed "+n+" files."),await r.clear().visitDescendants(async s=>{if(s.clear(),await s.isDirectory()&&!await s.hasNoChildren()){let a=await s.childDirectoryEntries();_(a)&&a.map(d=>d.nativePath).every(d=>o.some(w=>w.nativePath===d))&&await Ve(()=>s.rmdir(),{timeoutMs:7*S})&&o.push(s)}await s.isDirectory()&&await s.hasNoChildren()&&(o.push(s),await s.rmdir().catch(a=>this.logger.warn("Failed to rmdir "+s,a)))}),this.logger.info("Pruned "+(o.length-n)+" empty directories."),this.lastCleanupFinishTs=Date.now(),o}};var lM=v(require("http"));var aM={success:t=>Ie(200,299,t),redirect:t=>Ie(300,399,t),clientError:t=>Ie(400,499,t),serverError:t=>Ie(500,599,t),error:t=>Ie(400,599,t)};var mM=l(()=>p("httping"));function uM(t,e,r,i){let o=Ee.from({scheme:"http",authority:t+":"+e,path:r}).toString(),n=new mt("ping "+o);return n.setTimeout(i),(0,lM.get)(o,{timeout:i},s=>{mM().log(aM.error(s.statusCode)?"warn":"debug","ping",{latencyMs:Date.now()-n.start,statusCode:s.statusCode}),s.resume(),n.resolve(s.statusCode)}).on("error",s=>{mM().warn("Failed to connect to "+o,s),n.resolve(void 0)}),n.promise}var kk=l(()=>p("Broadcaster")),Lh;(function(e){e.broadcast=async(r,i)=>(kk().warn("broadcast sent to no-op",{event:r,args:i}),!1)})(Lh||(Lh={}));var Fh=Lh;var mf=Fh;function cM(t){mf=t}function fM(t){mf===Fh&&(mf=t)}function hs(t,e){mf.broadcast(t,e)}var uf=v(require("process"));function cm(){return uf.stdout==null||uf.stdout.destroyed||uf.stdout.writableEnded}function Gi(t,...e){cm()||console.log(t,...e)}var fm=!1;function Ti(){return fm}function Oa(){fm||(fm=!0,Pw())}function pm(){fm&&(fm=!1,od(),Ew())}var So=11,mn=3;async function cf(t,e){let r=Date.now(),i=0,o=r+u.maxBusyDbMs.valueOrDefault;for(;Date.now()<o;)try{return await t()}catch(n){if(!Sl(n)||Date.now()>=o)throw n;e?.(),await It(ir(500,1500)*++i)}throw new Error("handleDbRetries(): timeout after "+u.maxBusyDbMs.valueOrDefault+"ms")}function ff(t,e=25){let r;for(let i=0;i<e;i++)try{return t()}catch(o){if(r=o,!Sl(o))throw o}throw r}var pM=v(require("fs-extra")),pf=v(require("os")),Ih=v(require("process"));var Rk=l(async()=>{if(u.forceOpen.valueOrDefault){let t=xt();t!=null&&await fa(async()=>Promise.all(D(await dM(t)).map(e=>e.unlink())),7*S)}}),hM=Pt;function _k(t){return f(t,e=>e.join("opened-by"))}function dM(t){return _k(t)?.clear().children(r=>r.ext===".json")}async function gM(){return Z(xt(),async t=>Np(df(t),Oh(),"hostname","pid"),async()=>!1)}var Oh=l(async()=>({hostname:(0,pf.hostname)(),pid:Ih.pid})),df=wi(t=>Nk(t),{maxSize:3,timeoutMs:q,clearEveryMs:ir(7*S,q)});async function Nk(t){await Rk();let e=!em(),r=p("currentLibraryLockOwner("+t+")"),i=(0,pf.hostname)(),o=await dM(t);if(R(o)){r.warn("no opened-by files found.");return}let n=await Kn(o.map(async Q=>{let Qt=await Q.readJson();if(e&&Qt==null&&await Q.modifiedCloseTo(Date.now(),q)!==!0){r.warn("unlinking old empty json file: "+Q),await Q.unlink("debug");return}else return b({file:Q},Qt)}));r.debug("read",{jsons:n});let s=Date.now()-hM,[a,m]=Eu(n,Q=>Q.updatedAt>s);e&&_(m)&&(r.debug("Unlinking expired opened-by files:",{minUpdatedAt:s,staleJsons:m}),await Promise.all(m.map(Q=>Q.file?.unlink("debug"))));let[c,d]=Eu(a,Q=>Q.hostname===i),w=c.map(Q=>Q.pid),P=x(await cT(w),w),[A,V]=Eu(c,Q=>P.includes(Q.pid));e&&_(V)&&(r.debug("Unlinking zombie opened-by files:",V),await Promise.all(V.map(Q=>Q.file?.unlink())));let Se=[...A,...d];if(R(Se)){r.debug("No valid opened-by files.");return}let $t=Vo(Se,Q=>Q.createdAt),He=Se.filter(Q=>Q.systemUID===$t.systemUID),J=Vo(He,Q=>[gv(Q.serviceName),x(Q.createdAt,()=>Date.now())]);return r.tap({msg:"currentLibraryLockOwner",level:"info",result:J})}W(()=>df.clear());var kh=class extends ze{constructor(e){super("OpenedByIO()",()=>this.onEnd(),oe.postdb);this.ldd=e;this.createdAt=Date.now();this.watchers=[];this.intervalMs=hM/4;this.file=l(()=>this.dir.join(Yo((0,pf.hostname)(),7)+"-"+Ih.pid+".json"));this.json=l(async()=>b({serviceName:qt(),createdAt:this.createdAt,updatedAt:Date.now()},await Oh()),this.intervalMs/2);this.write_=l(async()=>{let e=await this.json();await this.file().writeJSON_(e),df.clear()},this.intervalMs/2);this.setup=l(async()=>{if(await this.write_(),Tr())for(let e of this.file().selfAndParents(4))try{let r=(0,pM.watch)(e.nativePath,{persistent:!1,recursive:!1},()=>this.lockOwner.refresh()).on("error",i=>(this.logger.warn("watch().on(error):",i),this.lockOwner.refresh()));this.watchers.push(r)}catch(r){this.logger.warn("Failed to set up watch",{f:e.nativePath,err:r})}});this.lockOwner=l(async()=>{if(!K())return await this.setup(),df(this.ldd)},7*S);this.dir=e.join("opened-by"),this.timer=wr(()=>this.write_(),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write_.unset()}refresh_(){return this.clear(),this.write_()}async onEnd(){this.watchers.forEach(e=>e.close()),this.watchers.length=0,f(this.timer,clearInterval),this.timer=void 0,await this.file().unlink()}async deleteAllLocks(e=!1){e?await this.dir.rmrf():await this.dir.visitDescendants(r=>r.eql(this.file())?void 0:r.unlink())}async isLockOwner(){return Np(this.lockOwner(),Oh(),"hostname","pid")}async throwIfUnavailable(e){this.logger.debug("throwIfAvailable()",{from:e});let r=await this.lockOwner();if(this.logger.debug("throwIfAvailable()",{from:e,lockOwner:r}),r==null)return;let i=await this.json();if(this.logger.debug("throwIfAvailable()",{from:e,json:i}),r!=null&&r.hostname!==i.hostname)throw this.logger.warn("library is unavailable",{lockOwner:r,json:i}),new Error(`Library is already opened by ${r.hostname} (${r.serviceName}:${r.pid}) ${e}`+(Fc()?"":ce)+Yr+Vt)}};var TM=v(require("net"));var xM=v(require("process"));var yM=v(require("os")),bM=v(require("process"));var Bk=0,Ck=l(()=>Or((0,yM.hostname)()+String.fromCharCode(31)+bM.pid)+"-");function hf(){return Ck()+Yn.encode(++Bk)}var wM=v(require("util"));var Rh=class{constructor(e,r,i,o){this.id=e;this.method=r;this.params=i;this.timer=o;this.start=Date.now();this.name="rpc.RequestResponse("+r+")#"+e,this.d=new mt(this.name)}[wM.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),f(this.d.settledMs,r=>this.timer.push(this.method,r)))}reject(e){return this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}};var Vk=(he?7:30)*S,zk=he?500:5*S,Uk={requestTTL:Vk,retriesPerRequest:5,delayBetweenRetries:zk,maxPendingRequests:10},Wk=0,_h=class extends ze{constructor(e,r,i={}){super("rpc.Client("+e+"#"+Wk+++")",()=>this.onEnd(),oe.first);this.streamFactory=r;this.mkStreamRate=new Jo(E);this.pending=new Map;this.times=new ha;this.changeListeners=[()=>this.mkStreamRate.onEvent()];this.stream=l(async()=>{try{if(this.flapping)return this.onError("stream() is restarting too frequently (epm: "+this.mkStreamRate.eventsPerMinute+")");let e=await this.streamFactory();return e==null?this.onError("streamFactory() returned null"):(this.changeListeners.forEach(r=>r()),e.on("end",r=>this.onFinish("on(end)",r)),e.on("close",r=>this.onFinish("on(close)",r)),e.on("error",r=>this.onError("stream error",r)),Zo(e,`
`,r=>this.onData(r)),e)}catch(e){return this.onError("streamFactory rejection",e)}});this.ping=l(()=>this.request("ping",{serviceName:qt(),pid:xM.pid}),250);this.opts=b(b({},Uk),i),this.stream()}onEnd(){return this.logger.info("end()",{ending:K(),timings:this.times.report(),pendingSize:this.pending.size}),this.pending.clear(),this.close()}addChangeListener(e){this.changeListeners.push(e)}get flapping(){return this.logger.tap({level:he?"debug":"trace",msg:"flapping()",result:this.mkStreamRate.msSinceLastEvent<this.opts.delayBetweenRetries||Bs(this.mkStreamRate.eventsPerMinute,3),meta:{msSinceLastStream:this.mkStreamRate.msSinceLastEvent,mkStreamRatePerMin:this.mkStreamRate.eventsPerMinute}})}broadcast(e,r){return this.request("broadcast",{event:e,args:r})}sendRecentLogs(){return this.request("sendRecentLogs")}async ready(){return this.ended?(this.logger.debug("ready(): false (ended)"),!1):await this.stream()!=null}async request(e,r){if(this.ended){if(K())return;throw new Error("client is ending")}if(T(e))throw new Error("method cannot be blank");return this.submit(e,r)}async submit(e,r){let i=await this.stream();if(i==null)return this.onError("submit("+e+"): stream is closed");let o=hf(),n=new Rh(o,e,r,this.times);return n.setTimeout(this.opts.requestTTL),this.pending.set(o,n),n.d.finally(()=>this.pending.delete(o)),this.logger.log(he?"debug":"trace","sending request",{id:o,method:e,params:r}),i.write(k({id:o,method:e,params:r})+`
`),n.response}close(){return this.logger.info("close()",{ended:this.ended}),y(this.stream.clear(),Ci)}onData(e){if(!T(e))try{this.logger.log(he?"debug":"trace","onData()",{req:e});let r=JSON.parse(e);if(T(r.sid))throw new Error("response is missing server id");if(this.sid!==r.sid&&(this.sid!=null&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:r.sid}),ue.emit("rpcServerChange")),this.sid=r.sid,K()))return;if(r.id==null)if(M(r.event)){this.logger.trace("re-broadcasting event",r),ue.emit(r.event,r.args);return}else throw new Error("missing request id from response");let i=this.pending.get(r.id);this.pending.delete(r.id),i==null?this.logger.warn("unknown or stale request ID",{resp:r,pendingIds:[...this.pending.keys()]}):r.error!=null?(i.reject(r.error),this.logger.warn("Rejected",{resp:r,rr:i})):(i.resolve(r.result),this.logger.debug("Resolved",r.result))}catch(r){this.logger.warn("invalid input: "+e,r)}}async onError(e,r){return this.logger.warn(e+" onError(): "+f(r,i=>x(i.stack,i))),this.restart()}async restart(){if(this.logger.info("restart()",{ended:this.ended,flapping:this.flapping}),await this.close(),this.ended||K()){this.logger.warn("restart(): Ending. Rejecting new connection.");return}if(this.flapping){this.logger.warn("restart(): Too many recent errors, we'll try reconnecting again in a bit",{errPerMin:this.mkStreamRate.eventsPerMinute});return}let e=await this.stream();if(e!=null){let r=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+r.length+" jobs now."),r.forEach(i=>i.reject("restarting"+Zs)),e}else{this.logger.warn("restart(): stream() returned null");return}}onFinish(e,r){if(this.ended)return;let i=r==null||r===!1;return this.logger.info("onFinish",{source:e,error:r,restarting:i}),i?this.restart():this.onError(e,r)}};var Nh=p("RpcClient");function qk(t){let e=new Ot,r=new TM.default.Socket;return r.on("error",i=>e.reject(i)),r.connect(t,"localhost",()=>{Nh.debug("Connected to "+t),e.resolve()}),e.then(()=>r)}var cn=l(()=>{if(an())return;let t=u.rpcPort.valueOrDefault;Nh.debug("Creating new RPC client to "+t);let e=new _h("db@localhost:"+t,()=>qk(t));return e.addChangeListener(()=>un.unset()),e}),un=l(async()=>{try{if(an())return!1;let t=await Ae(f(cn(),e=>e.ping()),S);return M(t)}catch(t){return Nh.warn("rpcClientReady(): ping failed",t),!1}},E);var gf,ka=l(()=>p("Vacuum"));function dm(t){return t==null||t.schema==="models"?I(gf):!1}var vM=async t=>{typeof t!="boolean"&&ka().throw("invalid setVacuuming argument",{value:t}),ka().debug("setVacuuming()",{value:t}),gf=t};Iw(vM);async function SM(){return y(cn()?.request("isVacuuming"),t=>(ka().info("checkRemoteVacuuming() received RPC value",{value:t}),f(t,vM)))}async function Bh(t){if(!await gM()){ka().info("withVacuumEvent(): no-op, I'm not the lock owner.");return}ka().info("db vacuum starting...");try{return gf=!0,hs("vacuuming",!0),await t()}finally{gf=!1,hs("vacuuming",!1),ka().info("db vacuum finished.")}}var hm=l(()=>p("Transactions")),jk=E,MM=10,yf=!1;async function er(t,e,r=!1,i=!1){if(t.db==null)throw new Error("tx(): null db");try{return r&&(yf=!0),!i&&dm(t)&&await Ve(()=>!dm(t),{timeoutMs:jk})==null&&hm().throw("Timeout while waiting for external vacuum to complete"),await ti(async()=>t.inTransaction?e(t.db):cf(()=>t.db.transaction(()=>e(t.db)).deferred(),t.onRetry),{maxRetries:MM,errorIsRetriable:async o=>r||yf?!1:(hm().warn("errorIsRetriable()",o),Sl(o)||_w(o)?(t.closeDb(),hm().warn("Trying to reopen the db "+t.dbfile),!0):!1),timeoutMs:u.maxBusyDbMs.valueOrDefault/10,onRetryWaitUntil:o=>{let n=ir(10,u.maxBusyDbMs.valueOrDefault/(MM-o));return hm().warn("onRetryWaitUntil()",{retryCount:o,delayMs:n}),It(n)}})}catch(o){if(r||yf)return;throw hm().warn("tx(): raised",o),o}finally{r&&(yf=!1)}}var ym=v(require("luxon"));var Jh=v(require("exiftool-vendored"));var Tt=v(require("exiftool-vendored")),nt=v(require("luxon"));var PM=v(require("luxon"));var Ch=14,Hk=l(()=>PM.DateTime.local().offset,Pt);function EM(t){return t==null||Math.abs(t)>Ch*60?!1:t===0?Hk()===0:!0}function bf(t,e=2){return t==null?"":di(t,e,"0")}function pr(t){if(t==null||typeof t=="string"||t===0)return!1;let e=ai(t);return e==null||e===0||!DM(Mo(t),Po(t),Eo(t))?!1:Pr(t)?Z(Gk(t),r=>r.isValid,()=>!1):!0}function Ra(t,e){return pr(t)?e(t):void 0}var AM=l(()=>u.minValidYear.valueOrDefault,Pt),Vh=l(()=>new Date(Date.now()+ht).getFullYear(),Pt),LM=l(()=>new Date(Date.now()+ht).getMonth()+1,Pt);B(()=>W(()=>{AM.unset(),Vh.unset(),LM.unset()}));function Kk(t){return Ie(AM(),Vh(),t)}function Jk(t,e){return Ei(e,Vh())&&ml(t,LM())?!1:Ie(1,12,t)}function $k(t,e,r){return r!=null&&nt.DateTime.fromObject({year:t,month:e,day:r}).isValid}function DM(t,e,r){return Kk(t)&&(e==null||Jk(e,t)&&(r==null||$k(t,e,r)))}var _a=class{constructor(e,r,i){this.year=e;this.month=r;this.day=i}static for(e,r,i){return DM(e,r,i)?new _a(e,r,i):void 0}static localToday(){return zh(new Date)}toString(){return L([this.year,this.month,this.day]).map(e=>bf(e)).join("-")}toISOString(){return this.toString()}toDateTime(){return nt.DateTime.fromObject(this)}},FM=class{constructor(e,r,i,o,n){this.monthsToMonth=e;this.re=r;this.yearIndex=i;this.monthIndex=o;this.dayIndex=n}apply(e){let r=this.re.exec(e);if(r!=null){let i=parseInt(r[this.yearIndex],10),o=this.month(r),n=this.dayIndex==null?void 0:parseInt(r[this.dayIndex],10);return _a.for(i,o,n)}else return}month(e){if(this.monthIndex==null)return;let r=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(r)?this.monthsToMonth.get(r):U(r)}},Do="((?:19|20)[0-9]{2})",IM="(1[0-2]|0[1-9])",Qk="(1[0-2]|0?[1-9])",OM="([1-3][0-9]|0[1-9])",wf="([1-3][0-9]|0?[1-9])",Yk="(1[0-9]|2[0-3]|0[0-9])",kM="([0-5][0-9])",Xk=kM,Zk=kM,xf="([-\\.\\,:_/ |])",Tf=xf+"?",eR="(?:(\\.[0-9]+))?",RM="(?:(Z|UTC)|(?:([+-])([01][0-9]):?([0-5][0-9])))",tR=new RegExp("\\d\\d\\s*"+RM,"i");function Uh(t){return f(tR.exec(t),e=>_M(e.slice(1)))}function _M(t,e){if(R(t))return e;let[r,i]=t.splice(0,2),[o,n]=t.splice(0,2).map(s=>U(s));return Uo(["z","utc"],r)?0:Ab([i,o,n])?e:(i==="-"?-1:1)*(o*60+n)}function Wh(t){return j(t,e=>mw([()=>Tt.ExifDateTime.fromEXIF(e),()=>rR(e)],r=>pr(r)))}var iR=l(()=>p("FuzzyDate"));function NM(t,e=!1){if(!T(t))for(let{desc:r,f:i}of[{desc:"DateInterval.fromISO",f:()=>Mr.fromISO(t)},{desc:"parseDateTime",f:()=>Wh(t)},{desc:"DateTime.fromFormat(macOS)",f:()=>nt.DateTime.fromFormat(t,"y-M-d 'at' H.m.s")},{desc:"DateTime.fromFormat(gnome)",f:()=>nt.DateTime.fromFormat(t,"y-M-d H-m-s")},{desc:"DateTime.fromFormat(yMMdd_HHmmss)",f:()=>nt.DateTime.fromFormat(t,"yMMdd_HHmmss")},{desc:"ExifDate.fromEXIF",f:()=>Tt.ExifDate.fromEXIF(t)},{desc:"fuzzyDate.parseYMD",f:()=>Na().parseYMD(t)},{desc:"new Date()",f:()=>e?new Date(t):void 0}]){let o=i();if(pr(o)){let n=Uh(t);return n!=null&&(o.tzoffsetMinutes=n),iR().tap({msg:"parseDated()",result:o,meta:{s:t,desc:r,tzoffsetMinutes:n}})}}}var BM=class{constructor(e){this.locale=e;this.monthsToMonth=new Map;this.ymdPatterns=[];this.ymPatterns=[];this.yPatterns=[];this.setup()}parseYMD(e){return Je(this.ymdPatterns,r=>r.apply(e))}addParser(e,r,i,o){let n=new FM(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),r,i,o);o!=null&&i!=null?this.ymdPatterns.push(n):u.fuzzyYearParsing.valueOrDefault&&o==null&&i!=null?this.ymPatterns.push(n):u.fuzzyYearParsing.valueOrDefault&&o==null&&i==null&&this.yPatterns.push(n)}setup(){let e=["short","long"];for(let i of H([this.locale,"en-US"]))for(let o of e){let n=new Intl.DateTimeFormat(i,{month:o});be(12,s=>{let a=n.format(new Date(2017,s));this.monthsToMonth.set(a.toLowerCase(),s+1)})}let r="("+or([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(Do+xf+Qk+"\\2"+wf,1,3,4),this.addParser(Do+Tf+IM+"\\2"+OM,1,3,4),this.addParser(Do+Tf+r+"\\2"+wf,1,3,4),this.addParser(r+Tf+wf+",?\\2"+Do,4,1,3),this.addParser(wf+Tf+r+",?\\2"+Do,4,3,1),u.fuzzyDateParsing.valueOrDefault&&(this.addParser(r+xf+Do,3,1),this.addParser(Do+xf+r,1,3)),this.addParser(Do,1)}extractDateFromPath(e){if(!u.usePathsToInferDates.valueOrDefault)return;nR.forEach(i=>{cu(e,i)&&e.splice(0,i.length)}),e=e.filter(i=>M(i)&&e[0].match(oR)==null);let r=[...e].reverse();return Ri(()=>Je(r,i=>this.parseYMD(i)),()=>this.parseYMD(r.slice(0,4).join(" ")),()=>this.parseYMD(e.slice(0,4).join(" ")),...u.fuzzyDateParsing.valueOrDefault?[()=>Je(this.ymPatterns,i=>Je(r,o=>i.apply(o))),()=>Je(this.ymPatterns,i=>i.apply(e.join(" "))),()=>Je(this.yPatterns,i=>Je(r.slice(1),o=>i.apply(o)))]:[])}},oR=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P_?)\d+)$/i,sR=l(()=>{u.fuzzyDateParsing.addListener(()=>Na.unset()),u.fuzzyYearParsing.addListener(()=>Na.unset()),u.usePathsToInferDates.addListener(()=>Na.unset())}),Na=l(()=>(sR(),new BM(void 0))),nR=[];function CM(t){return Na().extractDateFromPath(t)}function qh(t){return Na().parseYMD(t)}function VM(t){return t!=null&&(t instanceof _a||t instanceof Tt.ExifDate||t instanceof Tt.ExifDateTime||t instanceof Date||t instanceof Mr||t instanceof nt.DateTime||nu([t.year,t.month,t.day]))}function Mo(t){return f(t,e=>e instanceof Date?e.getFullYear():e.year)}function Po(t){return f(t,e=>e instanceof Date?e.getMonth()+1:e.month)}function Eo(t){return f(t,e=>e instanceof Date?e.getDate():e.day)}function aR(t){return Pr(t)?t instanceof Date?t.getHours():t.hour:void 0}function zM(t){return Pr(t)?t instanceof Date?t.getMinutes():t.minute:void 0}function UM(t){return Pr(t)?t instanceof Date?t.getSeconds():t.second:void 0}function WM(t){return Pr(t)?t instanceof Date?t.getMilliseconds():t.millisecond:void 0}function qM(t){return Pr(t)&&(N(zM(t))||N(UM(t))||N(WM(t)))}function lR(t,e=!0){if(t==null)return;if(t===0)return e?"UTC":"";let r=t<0?"-":"+",i=et(t/15)*15,o=Math.abs(i),n=Math.floor(o/60),s=Math.floor(Math.abs(o%60));return`${e?"UTC":""}${r}${bf(n)}:${bf(s)}`}function fn(t){return t instanceof Tt.ExifDateTime?t.hasZone&&EM(t.tzoffsetMinutes):t instanceof nt.DateTime?t.zone!=null&&t.zone.type!=="local":!1}function jh(t){return t instanceof nt.DateTime?f(t.zone,e=>e.name):t instanceof Tt.ExifDateTime?t.zone:void 0}function rR(t,e=mR){let r=e.exec(t);if(r==null)return;let i=[...r.slice(1)],[o,n,s,a,m,c]=i.splice(0,6).map(V=>U(V));if(o==null||n==null||s==null||!u.fuzzyDateParsing.valueOrDefault&&(a==null||m==null))return;let d=ee(0,999,Jr(i.shift(),{defaultValue:0})*1e3),w=_M(i),P=lR(w),A=nt.DateTime.fromObject({year:o,month:n,day:s,hour:a,minute:m,second:c,millisecond:d,zone:P});return A.isValid?Ki(A,P):void 0}var uR="[-:_ ]?",mR=new RegExp([Do,IM,OM,Yk,Xk,Zk,eR].join(uR)+RM+"?","i");function Gk(t){if(t instanceof nt.DateTime)return t;if(t instanceof Tt.ExifDateTime)return t.toDateTime();if(t instanceof Mr)return t.middle.toDateTime();if(t instanceof Date)return nt.DateTime.fromJSDate(t)}function Ki(t,e){if(t==null||!Pr(t))return;if(t instanceof nt.DateTime)return Tt.ExifDateTime.fromDateTime(t);let r=ai(t);if(r==null)return;let i=T(e)?fn(t)?jh(t):void 0:e,o=j(i,s=>cR(r,s));if(e!=null&&o==null)return;let n=f(Mo(t),s=>f(Po(t),a=>f(Eo(t),m=>f(aR(t),c=>new Tt.ExifDateTime(s,a,m,c,x(zM(t),0),x(UM(t),0),WM(t),o,t.rawValue)))));return pr(n)?n:void 0}function jM(t){if(t==null)return;if(typeof t=="number")return new Date(t);if(t instanceof Date)return t;if(t instanceof nt.DateTime)return t.toJSDate();if(t.toDate!=null)return t.toDate();if(N(t.year)&&N(t.month)&&N(t.day))return new Date(t.year,x(t.month,1)-1,t.day,12);let e=h(t);if(M(e))return f(fR(e),jM)}function ai(t){if(!(t==null||St(t)))return re(t)?t:t instanceof Date?t.getTime():t instanceof nt.DateTime?t.toMillis():f(jM(t),e=>e.getTime())}function Hh(t){if(!(t==null||St(t)))return re(t)?Vc(t):t instanceof Tt.ExifDateTime||t instanceof nt.DateTime?pR(t):t instanceof Date?Vc(t.getTime()):f(ai(t),Vc)}function pR(t){return parseInt([t.year,t.month,t.day,t.hour,t.minute,t.second].map(e=>Ct(e)).join("")+"00")+Bc(t.millisecond??0)}function HM(t){return f(t,e=>e instanceof Tt.ExifDateTime?e.tzoffsetMinutes:e instanceof nt.DateTime?e.offset:void 0)}function Gh(t){return f(t,e=>e instanceof nt.DateTime||e instanceof Tt.ExifDateTime||e instanceof Date?0:e instanceof Tt.ExifDate?ht:e instanceof Mr?e.intervalMs:void 0)}function gm(t,e=!0){if(t==null)return;if(t instanceof Mr)return t.toString(e);let r=re(t)?new Date(t):t;return Pr(r)?f(Ki(r),i=>i.toISOString({includeOffset:e})):dR(r)}function fR(t,e){return typeof t!="string"||T(t)?void 0:C(Tt.ExifDateTime.fromISO(t,e)).orElse(()=>Tt.ExifDate.fromISO(t)).orElse(()=>Tt.ExifTime.fromEXIF(t)).get()}function dR(t,e="-"){return L([Mo(t),Po(t),Eo(t)]).map(r=>bf(r)).join(e)}function zh(t){return f(t,e=>f(Mo(e),r=>new _a(r,Po(e),Eo(e))))}function GM(t,e){return On(Kh(t,e),ht)}function Kh(t,e){let[r,i]=[t,e].map(ai);return r==null||i==null?void 0:r-i}function Pr(t){return t instanceof Date||t instanceof Tt.ExifDateTime||t instanceof nt.DateTime}function cR(t,e){let r=nt.Info.normalizeZone(e);return r.isValid?r.offset(t):void 0}function KM(t,e){return t instanceof nt.DateTime?t.setZone(e,{keepLocalTime:!0}):Ki(t,e)}var hR=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/,Mr=class{constructor(e,r,i,o=0,n=1){this.start=e;this.middle=r;this.end=i;this.index=o;this.splits=n;this.toISOString=this.toString.bind(this);this.year=Mo(this.middle),this.month=Po(this.middle),this.day=Eo(this.middle)}static fromISO(e){e=h(e).trim();let r=hR.exec(e);if(r==null)return;let i=Jh.ExifDateTime.fromISO(r[1]),o=Jh.ExifDateTime.fromISO(r[2]),n=U(r[3]),s=U(r[4]);return this.for(i,o,n,s)}static for(e,r,i=0,o=1){if(!pr(e)||!pr(r))return;let n=Ki(e),s=Ki(r);if(n==null||s==null)return;o=ee(1,1e3,U(o,{defaultValue:1})),i=ee(0,o-1,U(i,{defaultValue:0}));let a=f(n.toDateTime().until(s.toDateTime()).divideEqually(o+1)[i],m=>m.end);if(a!=null)return new Mr(n,Ki(a,x(n.zone,s.zone)),s,i,o)}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return x(this.start.zone,this.end.zone)}get hasTimes(){return Pr(this.start)&&Pr(this.end)}toString(e=!0){return`${gm(this.start,e)}/${gm(this.end,e)}`+(this.index===0&&this.splits===1?"":`/${this.index}/${this.splits}`)}includes(e){if(e==null)return!1;let r=Ki(e);return r!=null?this.interval().contains(r.toDateTime()):this.year===Mo(e)&&this.month===Po(e)&&this.day===Eo(e)}};function JM(t,e,r=ym.DateTime.DATETIME_MED){return Ra(t,i=>(j(e,o=>i=i.setLocale(o)),i.toLocaleString(r)))}var gR=/(\.\d\d\d)\d+/;function yR(t){if(!T(t))return C(ym.DateTime.fromISO(t.replace(gR,(e,r)=>r),{setZone:!0})).filter(e=>e.isValid).orElse(()=>f(Mr.fromISO(t),e=>e.middle.toDateTime())).get()}var bR=new Map;function $M(t,e="en-US"){return yr(bR,e,()=>new Intl.DateTimeFormat(e,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(ai(t))}function QM(t){return f(yR(t),Nv)}var wR=/^\d{1,4}-\d{2}-\d{2}$/;function YM(t){return j(t,e=>Ri(()=>f(Mr.fromISO(e),r=>r.intervalMs),()=>C(e.match(wR)).flatMap(()=>ym.DateTime.fromISO(e)).filter(pr).map(()=>ht).get(),()=>C(ym.DateTime.fromISO(e)).filter(pr).map(()=>0).get()))}function Ao(t){let e=t;return e==null?void 0:N(e)?e:Bs(e.id,-20)?e.id:N(e.assetId)?e.assetId:lu(e.tagId)?e.tagId:void 0}function XM(t,e){return In(Ao(t),Ao(e),(r,i)=>r===i,()=>!1)}var Ht=Me("fit","sq");var vf=class{constructor(e,r=""){this.query="";if(this.query=r,this.assetId=Ao(e),this.assetId==null)throw new Error("internal error: null asset id "+k({id:e}))}static onNewPage(){this.pageImageCount=0}get unset(){return this.assetId==null||this.assetId<=0}assetUrl(){return this.unset?"":`/asset/${this.assetId}${this.query}`}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,r){return`/img/${this.assetId}/${e}/${r}${this.query}`}imgActualLink(e){return`/img/${L([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e,r="m"){return b(b({},this.imgAttrs("sq",bw,e)),{sizes:r==="s"?"80px":r==="m"?"160px":"320px"})}imgAttrs(e,r,i,o){if(this.unset)return{src:"/images/clear-64.png"};let n=Math.min(...r),s={width:h(n)},a=this.imgLink(e,n);vf.pageImageCount++,i=x(i,()=>vf.pageImageCount>72),i?(s.src="/images/clear-64.png",s["data-src"]=a):s.src=a,e===Ht.sq&&(s.height=h(n));let m=r.map(c=>ZM(this.imgLink(e,c),c));return f(o,c=>m.push(ZM(this.imgActualLink(),c.width))),s[(i?"data-":"")+"srcSet"]=m.join(","),s}},pn=vf;pn.pageImageCount=0;function ZM(t,e){return t+" "+e+"w"}var qD=v(require("luxon"));var Lo=class{static lift(e){return new class extends Lo{apply(r){return e(r)}}}and(e){return Lo.lift(r=>this.apply(r)&&e.apply(r))}or(e){return Lo.lift(r=>this.apply(r)||e.apply(r))}filter(e){return e.filter(r=>this.apply(r))}asAsync(){return _e.lift(e=>Promise.resolve(this.apply(e)))}},Bue=Lo.lift(Di),Cue=Lo.lift(()=>!0);function bm(t){return Lo.lift(e=>Ea(e?.ext,t))}var jue=bm(wt.SupportedByCurrentBrowser),Hue=bm(wt.Video),Sf=bm(wt.AssetFile);var ED=v(require("exiftool-vendored")),DD=v(require("path"));var tP=v(require("file-type")),rP=v(require("fs-extra")),iP=v(require("path"));var dn=v(require("fs-extra"));async function eP(t,e=0,r){let i=-1;try{let o=await x(r,()=>y((0,dn.stat)(t),s=>s.size-e)),n=Buffer.alloc(o);return i=await(0,dn.open)(t,"r"),await(0,dn.read)(i,n,0,o,e)}finally{await Wo(i,dn.close)}}B(()=>{W(()=>Mf.prior()?.clear()),Xt(t=>t==null?Mf.prior()?.clear():Mf.prior()?.delete(t))});var Mf=l(()=>new ke(512,3*E));async function xm(t){return Mf().getOrSet(t,async()=>{let{buffer:e}=await eP(t,0,248);return bt((0,tP.fromBuffer)(e)).filter(r=>r.mime!=="image/tiff").orElse(()=>bt(pd((0,rP.stat)(t))).filter(r=>r).flatMap(()=>wm().readRaw(t,["-mimetype"])).flatMap(r=>r.MIMEType).filter(M).map(r=>({ext:xR(t),mime:r})).get()).get()})}function xR(t){return Qe((0,iP.extname)(t),".")}var $h=v(require("os"));async function Qh(t){let e=O?"where":"which";try{let r=await We(e,[t],{timeout:q,ignoreExitCode:!0,ignoreStderr:!0});return r.code===0&&M(r.result)?r.result.trim().split(`
`)[0]?.trim():void 0}catch{return}}async function Yh(t){return t!=null&&await t.exists()?t.nativePath:void 0}async function Pf(t,e){let r=f(Rr.Tools(),o=>ae.for(o));if(Xr&&(r==null||await r.isNotDirectory()))throw new Error("Cannot find project path for tools"+ce);function i(o){return r?.join(Gw+"-"+o,x(e,t),t+(O?".exe":""))}return Ut(()=>Yh(i($h.default.arch())),()=>$h.default.arch()==="x64"?Yh(i("ia32")):void 0,()=>TR(t))}async function TR(t){return Ut(()=>Qh(t),()=>Yh(ae.for(Rr.Bin())?.join(t)),()=>{throw new Error("Cannot find path for "+t)})}var oP=l(()=>Pf("dcraw_emu","libraw")),nP=l(()=>Pf("raw-identify","libraw")),Xh=l(()=>Pf("jpegtran")),sP=l(()=>Pf("sqlite3"));var Ef=new ke(512);W(()=>Ef.clear());Xt(t=>t==null?Ef.clear():Ef.delete(t));var aP=l(()=>p("RawInfo"));async function Df(t){return Ef.getOrSet(t.nativePath,async()=>{try{let e=await nP(),r=await se(e,["-s",t.nativePath],{timeout:oa});return j(r,vR)}catch(e){aP().warn("raw-identify failed",{file:t.nativePath,error:me(e)});return}})}function vR(t){let[e,r,i,o,n]=t.split("	");return aP().tap({msg:"parseRawInfoOutput()",result:Rn(U(o),U(n),(s,a)=>({Filename:e,Make:r,Model:i,ImageSize:{width:s,height:a}})),meta:{input:t}})}var hD=v(require("os"));function SR(t,e,r=.5){return(1-r)*t+r*e}function Tm(t,e,r){let i=e.x-t.x,n=(r-t.x)/i;return SR(t.y,e.y,n)}function dr(t){return M(t)&&(t.startsWith("video/")||t==="application/mp4"||t==="application/ogg")}function Ba(t){return f(t,e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(N))}function Zh(t){return re(t)&&[0,90,180,270].includes(t)}function eg(t){let e=f(t,r=>et(r+Math.ceil(-r/360)*360));return Zh(e)?e:void 0}function lP(t){let e=eg(t);return e===90||e===270}function hn(t){return f(t,e=>Ri(()=>mP(e.Orientation),()=>mP(e.CameraOrientation),()=>eg(e.Rotation)))}var MR=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function mP(t){return f(t,e=>MR.get(e))}var efe=new Map([[0,1],[90,6],[180,3],[270,8]]);function uP(t){return t!=null&&N(t.width)&&N(t.height)}function Cr(t){return`${t.width} \xD7 ${t.height}`}function cP(t){return ww(t.width*t.height)}function tg(t){return{width:t.height,height:t.width}}function fP(t,e){return lP(e)?tg(t):t}function pP(t){return t.width/t.height<1}function Er(t){return _u(t.width*t.height)}var PR=l(()=>p("SizeInfo"));function ys(t,e,r){let i=Je([r?.ImageSize,{width:t.ImageWidth,height:t.ImageHeight}],s=>uP(s)?s:void 0);if(PR().debug("extractSizeInfo()",{filename:t.FileName,mimetype:t.MIMEType,rawInfo:r,fileDimensions:i}),i==null)return;let o=fP(i,e),n=Ge(o.width/o.height,5);return{ImageHeight:o.height,ImageWidth:o.width,aspectRatio:n,dimensions:o,rotation:e,fileDimensions:i}}var ER=E,DR=15*E,AR=10,LR={p0:{x:.8*Ce,y:4*S},p1:{x:20*Ce,y:12*S}},rg={p0:{x:11*Ce,y:12*S},p1:{x:26*Ce,y:24*S}},dP={p0:{x:7*Ce,y:45*S},p1:{x:32*Ce,y:90*S}};function hP(t){return tm(t.ext)?Math.max(x(we(t.durationMs,e=>e*AR),0),Tm(dP.p0,dP.p1,t.bytes)):0}function gP(t){return y(FR(t),e=>e.result)}function FR(t){return y(IR(t),OR)}function IR(t){return y(t.size(),async e=>({bytes:e,ext:t.ext,durationMs:tm(t.ext)?await y(st(t),r=>we(r.Duration,i=>i*S)):void 0}))}function yP(t){return Tm(rg.p0,rg.p1,ee(11*Ce,100*Ce,x(t,0)))}function OR(t){let e=ee(.5*Ce,64*fo,t.bytes),r=5*S,i=q,o=2*e*Ku,n=P=>Tm(P.p0,P.p1,ee(.5*Ce,50*Ce,e)),s=n(LR),m=lh(t.ext)?.includes(wt.RawImage)===!0?n(rg):0,c=hP(t),d=u.validateVideos.valueOrDefault?c:0;return{result:ee(ER,DR,Math.round(r+i+o+s+m+c+d)),dbMs:r,tagMs:i,copyMs:o,thumbMs:s,rawDecodeMs:m,transcodeMs:c,validateMs:d}}var Af=new ke(256);B(()=>W(()=>Af.clear()));B(()=>Ys((t,e)=>{Af.getOrSet(t,()=>[]).push(e),Af.getOrSet(e,()=>[]).push(t)}));function kR(t){return[t.toString(),...D(Af.get(t.toString()))]}function bP(t,e,r){for(let o of kR(t)){let n=r.get(o);if(n!=null)return n}let i=e(t);return r.set(t.toString(),i),i}var Lf=Me("plus","lite");var RR=require("https");async function wP(t,e={}){return e.headers==null&&(e.headers={}),T(e.headers["user-agent"])&&(e.headers["user-agent"]=fi+" v"+ft),new Promise((r,i)=>{let o=RR.request(t.toString(),e);o.setTimeout(x(e.timeout,q),()=>{i(new le({message:"Timeout fetching <"+t+">",doNotSend:!0,retriable:!0}))}),o.on("response",n=>{let s=[];n.setEncoding("utf8"),n.on("data",a=>s.push(a)),n.on("end",()=>{r({ok:Ie(200,399,n.statusCode),headers:n.headers,body:s.join(""),statusCode:n.statusCode,statusMessage:n.statusMessage})})}).on("error",n=>{i(n)}),f(e.body,n=>o.write(n)),o.end()})}var xP=v(require("zlib"));var qfe=l(()=>JSON.parse(tc("H4sIAAAAAAAAA6tWylWyUqrKyUxS0lEqADKTivJLcjJdUpPzcwuKUouLgyvzkoFSeUCptKL8XCCzDKQqsTjVzATISQRySvKDS4oy89KB3Bwgt7QkzUKpFgCQWYV5WQAAAA==")));function Ji(t){return JSON.parse((0,xP.brotliDecompressSync)(Buffer.from(t,"base64")).toString("utf8"))}var ng=v(require("os"));var TP=v(require("fs/promises"));var _R=l(()=>p("ReadFile"));async function ig(t){try{return await(0,TP.readFile)(t)}catch(e){_R().info(".readFileMaybe("+t+")",e);return}}var og=class{constructor(e,r,i){this.file=e;this.mkObject=r;this.onWrite=i;this.prior=l(()=>this.file.readJson("debug"))}async read(){let e=await this.prior();return p("JsonFileStore").debug("prior "+this.file,e),e??y(this.mkObject(),r=>this.write(r))}async write(e){try{return await this.file.writeJSON_(e,{spaces:2}),await this.prior.set(Promise.resolve(e)),p("JsonFileStore").info("wrote to "+this.file,e),this.onWrite!=null&&await this.onWrite(this.file,e),e}catch(r){throw new le({cause:r,message:"Failed to write to "+this.file})}}};function NR(){return ic.safeRandomUid(16,4)}var vP=class extends og{constructor(e,r){super(e.join("."+r+"-uid.json"),()=>({uid:NR(),version:ft,type:this.type,createdAt:Date.now()}),i=>i.hide());this.rootDir=e;this.type=r;this.read_=l(()=>ye(this.read(),e=>e.uid,()=>"missing!").catch(e=>{throw new le({cause:e,fatal:!0,message:"Failed to read "+this.rootDir})}))}},Ff=l(()=>f(xt(),t=>new vP(t,"library")));B(()=>{W(()=>{Ff.unset()}),u.libraryPath.addListener(()=>Ff.unset())});var SP=v(require("os"));var BR=/^(?:[0:]+|[f:]+)$/i,MP=l(()=>H(ie(yt((0,SP.networkInterfaces)()).map(t=>D(t).map(e=>e.mac))).filter(t=>M(t)&&BR.exec(t)==null)));var CR=l(()=>Ji("G7kAIIzUYs0Z7qRuS32pmsUk/UyD8OFBrsHUYemDqh3/zMuNBya1K0GYBazpDR8puUeR5pOPDwrAyLrH9L4GAhPQPWicizajRNayvHKU52siIpE9GddV7bjtHChhuc6wwPIkg/x4NH0P")),li=Me("cu","lc","lm","mp","wm","li","cm","ma","vl");function PP(t){return te(H(t.filter(VR)),e=>[li.indexOf(e.split(":")[0]),e])}function EP(t){return CR()[t]}var DP=15;async function $i(t,e){try{let r=h(await e);return T(r)||r.match(/^[\s0:_\/-]*$/)!=null?void 0:t+":"+Or(r.trim(),DP,Qo)}catch(r){p("toUID").warn("failed",{pfx:t,err:r});return}}var zR=l(()=>new RegExp(`^(${li.values.join("|")}):[0-9a-zA-Z]{${DP}}$`));function VR(t){return t!=null&&zR().exec(t)!=null}var Fo=l(()=>Ji("GwkBABwHdoyzjXCwzccdzUv9+g11VQzlNQjNotPVt0S2zHa8CLMs19auq91f4APvhhMIPZZ0m49e3qooFMQq6ej4jJBRUbv5BmSQzUeTCzW5mdaimgkX4ZqrHjPAjQ8XSSsp+cYQ79EXELnYMzlJwyYHVTq/nMkq900q5+mx2ayLgl3s6O7FgGooQh++7vpBI+Qpw3dCNqYDIfr6zPvUur259BmFMDQjV/hviADXURsBk2HJBesB")),If=l(()=>p(Fo().n));async function UR(){return $i(li.li,await Ff()?.read_())}function WR(){return $i(li.cm,(0,ng.cpus)()[0].model)}function qR(){return MP().map(t=>$i(li.ma,t))}async function jR(){return D(await Sr()).map(t=>$i(li.vl,t.uuid))}async function HR(){let t=await se(Fo().c,["-1"],{timeout:5*S});return If().tap({msg:Fo().c,result:t.match(/serial.*=\s*([a-z0-9-]{12,})/i)?.[1]})}async function GR(){try{return j(await HR(),t=>$i(li.lc,t+":"+(0,ng.cpus)()[0].model))}catch(t){If().info(Fo().c+" failed",t);return}}async function JR(){try{let t=await KR();return $i(li.mp,t)}catch(t){If().info("ioreg failed",t);return}}async function KR(){return(await se(Fo().i,Fo().ia,{timeout:5*S})).match(/uuid" = "([a-z0-9-]{12,})"/i)?.[1]}async function $R(){return(await Te.instance().executeJson(Fo().w))?.MachineGuid}async function QR(){let t=await $R();return $i(li.wm,t)}var YR=l(async()=>Oe()?[]:ot?[$i(li.lm,ig(Fo().lv)),$i(li.lm,ig(Fo().le)),GR()]:fe?[JR()]:O?[QR()]:[]);async function Of(){let t=await Promise.all([UR,WR,jR,qR,YR].map(async e=>{try{return await Ae(e(),5*S)}catch(r){return If().warn(r)}}));return PP(H(await Ml(t)))}var Ca=class{constructor(e,r,i,o){this.s=e;this._l=r;this._sids=i;this.meta={src:o}}get l(){return this._l}get ok(){if(this._l==null)return!1;let e=Bp(this._sids,this._l.uids),r=H(e.map(s=>s.split(":")[0])),i=L(r.map(s=>EP(s))),o=i.length>=this._l.mat,n=Ie(this._l.iat?.getTime(),this._l.exp?.getTime()+ht,Date.now());return this.meta[ve().o]=n,this.meta[ve().u]=o,this.meta[ve().m]=i,n&&o}cmpVal(){return[this.ok,-Lf.indexOf(this.l?.[ve().T]),this.l?.exp?.getTime()??1,this.meta.matchedSchemes]}cmp(e){return Lt(this.cmpVal(),e.cmpVal())}};var kf=l(()=>p("writeLicense"));async function LP(t){let e=await sg(t,"candidate");if(e==null)return kf().error("!ok",t);await AP(e,xt()?.join(ve().d)),await AP(e,ae.for(oi()).join(ve().d)),Va.unset()}async function XR(t){return(await ge(t.childFiles(),async e=>sg((await e.readFile())?.toString().trim(),e.nativePath))).filter(e=>e.ok&&e instanceof Ca)}async function AP(t,e){if(e==null)return;if((await XR(e)).some(i=>i.cmp(t)>=0)){kf().info("saveIfBetter(): no-op for "+e);return}else{let i=e.join(Or(t.s)+".txt");return await i.writeFile_(t.s).then(()=>(kf().info("saveIfBetter(): wrote to "+i),i)).catch(o=>{kf().error("saveIfBetter(): failed to save license to "+e,o)})}}var Io=l(()=>p(Qi().l)),Qi=l(()=>Ji("G9YAwIzTFfOihHWPgG6m/h0h65IqCersIGkdlq6+6ra6+PjQ8mHlRTkDg6UJJqPJEIU6WaIUNodfF2xPB7iLWJDlIN8z6xhOKyn4qqHpZlh6qCZUoQghd4BVMkz3A0IIevFn+7UO7uM+VGJb/MeZXfHngpQWZzk=")),FP=l(async()=>{let t=Qi().s+": ";try{if(!u[Qi().s].valueOrDefault)return Io().debug(t+"no-op (settings disabled)");let e=(await Va()).filter(n=>n.l!=null&&M(n.s)),r=new Date,i=e.find(n=>n.ok&&r<n.l.exp);if(i!=null)return Io().debug(t+"no-op: ",i);let o=await ae.for(oi()).join(Qi().s).mkdirp_();for(let n of e){if(T(n.s)||n.l==null||r<n.l.exp)continue;let s=n.l.uids.find(a=>a.startsWith("cu:"));if(s==null){Io().debug(t+"skipping (no cu)",n);continue}await o.join(Yo(n.s,14)+".txt").applyIfEmpty_(async a=>{await ZR(s),await a.writeJSON_({l:n.l,at:Date.now()}),Io().warn(t+"requested",n)})}}catch(e){Io().warn(t+"failed",e)}},15*E);async function ZR(t){try{let e=await Of();if(R(e))return Io().warn("no-op: empty sids");let r=k({uids:[...e,t]}),i=b(b({},Qi().r),{body:r}),o=await wP(Qi().u,i);Io().info(Qi().u,{req:i,response:o}),o.ok?await LP(JSON.parse(o.body)?.[Qi().a]):Io().warn(Qi().u,{req:i,response:o})}catch(e){Io().warn(Qi().u,e)}}var BE=v(NE());var Ua=l(()=>Ji("G9AAICwK7KZhK2gx/dEjjDHuEVVxShG2PVDGAcBqBqP3binicrOwzdRXMfMKd00dlj6bnSYcBaK1S8KWhAGGv73Zu73eMMKnXGoKt4NsAefjf3tdIWcHCM4FdbL+J+haq7GA2/ps1jHled6Oe+3j+k+BBQbgzzJmnLDvnTnXr11NbkL3X+vvWdyYILH9urnb+EV39HOm4Y5Hcrfqyt5i5iCfpGaVUqOnNfYDdeWC8wV2OWE=")),yhe=l(()=>{try{return require(Ua().c)[Ua().m](Ua().o)}catch(t){Y(Ua().m+ce,t)}});function CE(t){return BE.V2[Ua().w](t,Ua().o)}var ve=l(()=>Ji("GwwBABwHdkzj5qg5WDnubFuq7NaxSKjiobwK4iGSLDp98J87fqD679bWgnaVtCVBQAEFBJm7aiN4y7puJw8PPz+CHDoAhk5Fd0AhTjKYPbo8F5freFUJHhQHc2xp4qfyoqKKAmGb7IkFZwkajH7uJCR829lmguhEXw/iusqUQE4nk7LeJyad4wmdptoVln0otnUOO3UHnEyjrxtXUr7B")),VE=l(()=>p(ve().l));async function WN(t){let e=await CE(Li(h(t).trim(),ve().p)),r=gh(e[ve().i]);if(r==null)throw new Error("bad "+ve().i+": "+e[ve().i]+" ("+t+")");let i=gh(e[ve().r]);if(i==null)throw new Error("bad "+ve().r+": "+e[ve().r]+" ("+t+")");return e[ve().a]=e[ve().a]>=0?e[ve().a]:2,e[ve().i]=new Date(r),e[ve().r]=new Date(i),e[ve().b]=h(e.uids).split(","),e}async function bg(t,e){try{return new Ca(t,await WN(t),await Of(),e)}catch(r){return VE().tap({msg:ve().v,result:{s:t,ok:!1,meta:{err:r}}})}}async function sg(t,e){if(T(t))return;let r=await bg(t,e);return I(r?.ok)&&r instanceof Ca?r:void 0}var Va=l(async()=>{let t=L([xt()?.join(ve().d),ae.for(oi()).join(ve().d)]),e=ie(await ta(t,o=>o.childFiles())),r=ie(await ta(e,async o=>j(D(await o.readLines()).map(n=>n.trim()).join(""),n=>bg(n,o.nativePath))));await j(u[ve().L].value,async o=>r.push(await bg(o,"Settings")));let i=qN(r);return B(FP),VE().tap({msg:ve().d+"()",result:i})});async function qN(t){return te(t,e=>[!e.ok,Lf.indexOf(e.l?.[ve().T]),-(e.l?.exp?.getTime()??1)])}B(()=>Va[ve().n]=()=>null);function jN(){return y(Va(),t=>t[0]?.ok?t[0]:void 0)}async function HN(){return bt(jN()).flatMap(t=>t.l?.[ve().T]).getOrElse(()=>ve().f)}async function Wa(){try{return await HN()===ve().f}catch{return!0}}var GN=l(()=>{u.cacheDir.addListener(()=>Oo.unset())}),Oo=l(()=>{try{GN();let t=ne.for(u.cacheDir.valueOrDefault);return t.mkNoMedia_(),t}catch(t){throw Y("Failed to set up cacheDir"+ce,t),t}},E);var KN=["image/gif","image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"];function Vf(t){return KN.includes(h(t).toLowerCase())}var JN=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);function wn(t){return JN.has(h(t).toLowerCase())}var $N=/^\(?Binary data (\d+).*use -b option to extract\)?$/i,zf=class{constructor(e){this.binaryDataBytes=e}};function zE(t){if(typeof t!="string")return;let e=t.match($N);return e==null?void 0:new zf(U(e[1],{defaultValue:0}))}function Uf(t,e){return fl(t.width,e.width)&&fl(t.height,e.height)}function UE(t,e){return On(t.width,e.width)&&On(t.height,e.height)}function Si(t){return y(qa(t.nativePath),e=>({width:e.ImageWidth,height:e.ImageHeight}))}var WE=l(()=>p("HeifConvert"));B(()=>W(()=>Wf.unset()));var Wf=l(async()=>Qh(u.heifConvertPath.valueOrDefault));async function QN(){let t=await Wf();return WE().tap({msg:"isHeifConvertSupported()",result:M(t),meta:{heifConvertPath:t}})}async function qE(t){if(!!await QN())return y(Yi(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await We(u.heifConvertPath.valueOrDefault,["-q",String(u.jpegQuality.valueOrDefault),t.nativePath,r.nativePath],{timeout:q})}catch(i){WE().warn("heif2jpeg(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var jE=l(()=>p("sips")),HE=l(async()=>{try{return await se("command",["-v","sips"],{timeout:xr})}catch(t){let e=ae.for("/usr/bin/sips");if(await e.isExecutable())return e.nativePath;jE().info("sips is missing from $PATH",t);return}});async function GE(t){return y(Yi(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await We("sips",["-s","format","jpeg","-s","formatOptions",String(u.jpegQuality.valueOrDefault),t.nativePath,"--out",r.nativePath],{timeout:q})}catch(i){jE().warn("sips(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var YN=l(()=>p("Heif")),KE=l(async()=>{try{if(fe)try{let e=await HE();if(!T(e))return{ok:!0,msg:e}}catch(e){YN().error("Failed to find the sips tool (either in PATH or /usr/bin).",e)}let t=await Wf();return{ok:M(t),msg:Kr(t,u.heifConvertPath.valueOrDefault+": not installed")}}catch(t){return{ok:!1,msg:Qn(t)}}});async function qf(){return(await KE()).ok}B(()=>W(()=>KE.unset()));var XN=/^image\/hei[fc]$/i;function ws(t){return XN.exec(h(t))!=null}async function JE(t,e,r,i=1e3){let o=await Ve(()=>_(t.listeners(e)),{timeoutMs:i});return o&&t.emit(e,r),o}var QE=v(require("util"));function $E(t,e){let r=t.width/t.height,i=e.width/e.height;if(r>=i){let o=Math.min(e.width,t.width);return{width:o,height:Math.ceil(o/r)}}else{let o=Math.min(e.height,t.height);return{width:Math.ceil(e.height*r),height:o}}}var ZN=Me("cover","contain","fill","inside","outside"),xn;(function(o){let t=l(()=>p("Reducers.Square"));o.name=Ht.sq,o.fit="cover";function i(n,s){let a=UE(n,s)?b(b({},n),{fit:ZN.cover}):void 0;return t().tap({msg:"reduce()",result:a,meta:{max:n,input:s}})}o.reduce=i})(xn||(xn={}));var Vr;(function(o){let t=l(()=>p("Reducers.Fit"));o.name=Ht.fit,o.fit="inside";function i(n,s){if(Uf(s,n)){t().trace(`reduce(): input ${Cr(s)} is too small for ${Cr(n)}`);return}return $E(s,n)}o.reduce=i})(Vr||(Vr={}));var bye=require("sharp"),tr=class{constructor(e,r,i,o,n=!0){this.name=e;this.maxWidth=r;this.maxHeight=i;this.reducer=o;this.rotational=n;this.megapixels=l(()=>_u(this.maxWidth*this.maxHeight));this.max={width:r,height:i},tr._Sizes.push(this)}static sq(){return this._Sizes.filter(e=>e.reducer===xn)}static largestSq(){return Dt(this.sq(),e=>e.megapixels())}static fit(){let e=u.previewResolutions.valueOrDefault;return this._Sizes.filter(r=>r.reducer===Vr&&e.includes(r.name))}static largestFit(){return Dt(this.fit(),e=>e.megapixels())}[QE.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"\xD7"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&pP(e)?tg(this.max):this.max,e)}resize(e,r){return r=r.resize(b(b({},e),{fit:this.reducer.fit,withoutEnlargement:!0})),r}toJpeg({path:e,sh:r,outputSize:i}){return(Er(i)<2||u.sharpen.valueOrDefault)&&(r=r.sharpen()),r.jpeg({quality:u.jpegQuality.valueOrDefault,progressive:u.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}},qe=tr;qe._Sizes=[],qe.UHD8k=new tr("uhd8k",7680,4320,Vr,!1),qe.UHD5k=new tr("uhd5k",5120,2880,Vr,!1),qe.UHD=new tr("uhd4k",4096,2160,Vr),qe.QHD=new tr("qhd",3120,1440,Vr),qe.FHD=new tr("fhd",1920,1080,Vr),qe.HD=new tr("hd",1280,720,Vr),qe.WVGA=new tr("wvga",720,480,Vr),qe.QVGA=new tr("qvga",320,240,Vr),qe.QQVGA=new tr("qqvga",160,120,Vr),qe.S480=new tr("s480",480,480,xn),qe.S240=new tr("s240",240,240,xn),qe.S120=new tr("s120",120,120,xn),qe.S60=new tr("s60",60,60,xn);var jf=p("libraw");var e1=["-T"],t1=["-Z","-"],r1=["-o","1"],i1=["-t","0","-j"];async function YE(t){let e=Date.now(),r=await Si(t);if(r==null)return jf.throw("Cannot decode RAW "+t+": no EXIF dimensions."+Yr+Vt);let i=qe.largestFit().outputSize(r),o=[];i!=null&&4*Er(i)<Er(r)&&(jf.debug("Large original source: using -h"),o.push("-h"));let n=await oP(),s=[...e1,...t1,...r1,...o,...i1,...u.dcrawEmuArgs.values,t.nativePath],a=5*E,m={encoding:"buffer",timeout:a,maxBuffer:250*Ce};jf.debug("dcraw_emu()",{cmd:n,args:s,opts:m});let c=await tn(n,s,a,m),d=async A=>{await JE(c.stdout,"error","Problem from "+t+": "+xx(A,t.nativePath))||jf.error("No listeners for error when reading "+t,A),c.kill("SIGINT")};c.on("error",d),c.stderr.on("data",d);let w=yP(await t.size())/7,P=new es({path:t.nativePath,op:"Converting raw image"},w,()=>Date.now()-e);return c.on("close",()=>P.end()),c.stdout}var wg=require("sharp"),xs=p("SharpReadable");async function n1(t,e,r,i){let o=e?.[r];if(!(o instanceof zf))return;let n=i.width*i.height*.1;if(o.binaryDataBytes==null||o.binaryDataBytes<n){xs.debug("imgFromExif(): rejecting (too small) "+r,{minBytes:n,val:o});return}let s=await o1(t,r),a=await f(s,Si);return xs.tap({msg:"imgFromExif()",meta:{src:t.baseWithGrandparent,tag:r,dim:a,minDim:i},result:a!=null&&Uf(i,a)?s:void 0})}var s1=l(()=>{wg.simd(u.enableSIMD.valueOrDefault),wg.cache(u.enableVipsCache.valueOrDefault),wg.concurrency(md())});function Ts(t,e,r=!1){return pt(`img.sharpReadable${t.ext.toUpperCase()}`,()=>a1(t,e,r))}async function a1(t,e,r=!1){s1();let o=await st(t,!r),n=o?.MIMEType;if(o==null||T(n))throw new Error(t+" is not supported (missing mimetype)");if(ws(n)&&!await qf()){xs.warn("sharpReadable(): HEIF file, but heif support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}if(dr(n)&&!await Em()){xs.warn("sharpReadable(): video file, but video support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}let s=[],a=hn(o),m=ys(o,a,wn(n)?await Df(t):void 0);if(m!=null){let w=x(e,{width:m.dimensions.width*.95,height:m.dimensions.height*.95});if(Er(w)>15&&(r||a==null||a===0)&&!dr(n)){let A=u.embeddedPreviews.valueOrDefault;e!=null&&Er(e)<1&&A.unshift(...u.embeddedThumbnails.values),s.push(...A.map(V=>()=>n1(t,o,V,w)))}}ws(n)&&(fe&&s.push(()=>GE(t)),s.push(()=>qE(t))),Vf(n)&&s.push(async()=>t),m!=null&&wn(n)&&s.push(()=>(xs.info("sharpReadable() -> dcraw()",{src:t.nativePath,minDim:e}),ZE({src:t,desc:"dcraw",suffix:".tiff",f:()=>YE(t)}))),n.startsWith("video/")&&s.push(()=>ti(()=>Pm(t,n),{maxRetries:1}));let c=[],d=await qw(s,w=>{xs.warn("strategy failed for "+t+": "+w),c.push(w)});if(d==null)throw x(c[0],new Error("Cannot read "+t+" ("+n+")"));return d}function o1(t,e){let r=e.toLowerCase().endsWith("tiff")?".tiff":".jpg";return y(Yi(t,e,r),i=>i.applyIfEmpty_(async o=>{try{return await XE(e,t.nativePath,o.nativePath)}catch(n){xs.warn("Failed to extract embedded "+e+" from "+t.nativePath+": "+n);return}}))}var Obe=require("sharp"),l1=l(()=>p("ImgCache")),m1="imgcache";async function Dm(){return Oo().join(m1).mkdirp_().catch(t=>{Y("Failed to create imgCache directory"+ce,t)})}async function Yi(t,e,r){let i=await t.stat();if(i==null)throw new Error(`cachedImgFile(${t}): unreadable`);let o=await Dm();if(o==null)throw new Error("imgcache dir is missing");let n=await xm(t.nativePath);if(n==null)throw new Error("Cannot read filetype for "+t);let s=Yo(k({basename:t.base.toLowerCase(),mimetype:n.mime,size:i.size}));r=Li(r,".");let a=o.join(...zo(s.slice(0,24),2,3),e+r);if(await a.parent().mkdirp()==null)throw new Error("Cannot make dest dir, "+a.parent());return l1().debug("cachedImgFile("+t.baseWithGrandparent+")",{desc:e,ext:r,result:a}),a}async function ZE({src:t,desc:e,suffix:r,f:i}){try{return await y(Yi(t,e,r),o=>o.applyIfEmpty_(async n=>y(i(),s=>n.writeStream_(s))))}catch(o){throw new le({cause:o,message:"readableToFile() failed"})}}var u1=O?"NUL":"/dev/null",c1=l(()=>p("jpegtran"));async function eD(t){let e=await Xh();try{await We(e,["-outfile",u1,t.nativePath],{timeout:30*S,isIgnorableError:Am})}catch(r){throw new le({cause:r,doNotSend:!0,fatal:!1,retriable:!1})}}async function tD(t,e){let r=t.wip();c1().info("rotateInPlace("+t+")",e),await f1(t,r,e),await r.unwip_(),Fr(t.nativePath)}async function f1(t,e,r){let i=await Xh();if(!Zh(r))throw new Error("refusing to rotate("+t+", "+r+")");await se(i,["-copy","all","-trim","-rotate",r.toFixed(0),"-outfile",e.nativePath,t.nativePath],{timeout:E})}var p1=require("sharp"),xg=l(()=>p("ValidFile")),Hf=l(()=>new ke(1024,E));B(()=>W(()=>Hf.prior()?.clear()));B(()=>Xt(t=>C(t).forEach(e=>{Hf.prior()?.delete(e)}).orElse(()=>{Hf.prior()?.clear()})));var d1=l(()=>iT(u.validationErrorBlocklist.values,"i"));function Am(t){return xg().tap({msg:"isIgnorableValidationError",result:d1().exec(me(t))==null})}async function iD(t){if(await Wa()||!u.validateJpegImages.valueOrDefault&&!u.validateVideos.valueOrDefault){xg().debug("no validation for "+t,{validateJpegImages:u.validateJpegImages.valueOrDefault,validateVideos:u.validateVideos.valueOrDefault});return}return bP(t,h1,Hf())}async function h1(t){let e=ne.for(t);try{let r=await gs(e);if(r==null)throw new Error("Cannot validate, no mimetype");if(dr(r))u.validateVideos.valueOrDefault&&(xg().debug("validating "+e),await rD(e,r));else if(r.startsWith("image/")){if(r==="image/jpeg"){if(u.validateJpegImages.valueOrDefault)return await eD(e)}else if(u.validateRawImages.valueOrDefault){let i=await Ts(e);if(i==null)throw new Error("Cannot read");await p1(i.nativePath,{failOnError:!0}).tiff().toBuffer()}}else throw new Error("Unsupported mimetype, "+r)}catch(r){throw new le({cause:r,message:"invalid file "+e,retriable:!1,doNotSend:!0,ignorable:!0})}}var oD=l(()=>p("ffmpeg")),g1=l(()=>ee(1,8,et(lt()/2))),y1=/ffmpeg version (\S+)/i,Lm=l(async()=>{try{let t=await We(u.ffmpegPath.valueOrDefault,["-version"],{timeout:q,ignoreStderr:!0,isIgnorableError:()=>!0}),e=y1.exec(t.result)?.[1];return oD().info("ffmpegVersion",{version:e,code:t.code,stdout:t.result.split(`
`,1)[0]}),t.code===0&&M(e)?e:void 0}catch(t){return}}),nD=l(()=>ye(Lm(),t=>"version "+t,()=>"(not found)"));B(()=>W(()=>Lm.unset()));async function sD(){return Pe(Lm.prior(),()=>Lm.refresh())}async function Gf(){return await Lm()!=null}async function aD(t){return await t.dest.exists()&&await t.dest.isEmpty()&&await t.dest.unlink(),We(u.ffmpegPath.valueOrDefault,L(["-loglevel","error","-i",t.src.nativePath,...Gs(t.startAtSec,e=>["-ss",e.toFixed(1)])??[],"-vframes","1","-f","singlejpeg","-y",t.dest.nativePath]),{timeout:E,isIgnorableError:Am})}async function lD(t){return oD().tap({msg:"ffmpegValidVideo",meta:{src:t.nativePath},result:await We(u.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",h(g1()),"-i",t.nativePath,"-f","null","-"],{timeout:x(await gP(t),2*E),isIgnorableError:Am,ignoreExitCode:!0,quiet:!1})})}var mD=v(require("path"));var ja=l(()=>p("vlc"));function uD(){return ye(Ha().catch(()=>{}),t=>"version "+t.version,()=>"(not found)")}var b1=/VLC (?:version|media player) ([0-9.]+)/i,cD=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"],Ha=l(()=>w1());B(()=>W(()=>Ha.unset()));async function fD(){return Pe(Ha.prior(),()=>Ha.refresh())}async function pD(){return!dd&&await ye(Ha(),t=>t.version!=null,()=>!1)}function x1(){return y(Ha(),t=>t.version==null?void 0:t.path)}async function T1(t){return y(We(t,[...cD,"--version"],{timeout:q,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),e=>C(e.result).filter(M).map(r=>r.trim()).flatMap(r=>b1.exec(r)).flatMap(r=>r[1]).get())}function v1(t){return y(Te.instance().execute(`(Get-Item -path ${is(t)}).VersionInfo.FileVersion`,e=>e).catch(e=>{ja().warn("Failed to run vlcInfoWin: "+t+": "+e)}),e=>_s(e.trim()))}async function w1(){let t=[];function e(...r){t.push(ne.for((0,mD.join)(...r)))}if((!O||u.vlcPath.hasValue())&&t.push(u.vlcPath.valueOrDefault),fe){let r="/Applications/VLC.app/Contents/MacOS/VLC";j(Ne("HOME"),i=>e(i+r)),e(r)}if(O){let r=["VideoLAN","VLC","vlc.exe"];j(Ne("LOCALAPPDATA"),i=>{e(i,"Apps",...r)}),j(Ne("ProgramFiles"),i=>{e(i,...r)}),j(Ne("ProgramFiles(x86)"),i=>{e(i,...r)})}for(let r of t)try{if(r instanceof ne&&await r.clear().notExists())continue;let i=r.toString(),o=await(O?v1(i):T1(i));if(T(o)){ja().info("vlcInfo(): no VLC version found for "+r);continue}else return Et({path:i,version:o},n=>ja().info("vlcInfo()",n))}catch(i){ja().warn("vlcInfo(): err:"+i,{path:r})}}async function dD(t){let e=await x1();if(T(e))return ja().throw("vlcFrame(): empty vlcPath",b(b({},t),{ignorable:!0}));let r=Qe(t.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(r))return ja().throw("vlcFrame(): Invalid destination extension"+Vt,{format:r,args:t});let i=t.startAtSec??0,o=i+1,n=await We(e,L([...cD,"--avcodec-hw=none","--video-filter=scene","--scene-format="+r,"--scene-replace","--scene-ratio=500","--scene-path="+t.dest.dir,"--scene-prefix="+t.dest.name,"--start-time="+i.toFixed(1),"--stop-time="+o.toFixed(1),t.src.nativePath,"vlc://quit"]),{timeout:E,ignoreStderr:!0});if(t.dest.clear(),N(n.code))throw new Error("vlc failed: "+k(n));return n}var Uxe=l(async()=>(0,hD.totalmem)()>16*rd&&lt()>5&&await Gf()?2:1);async function S1(t){return await Ut(()=>I(t?.ignoreffmpeg)&&!nr?void 0:y(sD(),e=>({ok:!0,msg:"FFmpeg "+e})),()=>I(t?.ignorevlc)?void 0:y(fD(),e=>({ok:!0,msg:"VLC "+e.version})),()=>({ok:!1,msg:"(no video tools were found)"}))}var Em=l(async()=>(await S1()).ok);B(()=>W(()=>Em.unset()));async function Pm(t,e,r){if(!dr(e))return;let i=I(r?.useVlc)?!1:I(await Pe(r?.useFfmpeg,()=>Gf())),o=!i&&I(await Pe(r?.useVlc,()=>pD()));if(!i&&!o)return;let n=p("img/Video.extractVideoFrame("+t+")"),s=await Yi(t,"frame",".jpg");n.debug("extractVideoFrame",{dest:s.nativePath,mimetype:e});let a=await t.mtimeMs();if(a==null)return n.throw("null mtime");let m=await st(t);if(m==null)return n.throw("no tags");let c=hn(m);n.debug("video orientation:"+c);let d=ys(m,c)?.dimensions,w=await s.stat(),P=w==null?void 0:await Si(s);if(w!=null&&w.mtimeMs>a&&P!=null&&(d==null||P.height===d.height&&P.width===d.width))return n.debug("prior dest, "+s+" seems reasonable",{srcDim:d,destDim:P}),s;let A=Ba(m),V=Math.min(A??0,u.videoFrameAtSec.valueOrDefault);return n.info("extracted metadata",{startAtSec:V,duration:A}),await s.applyWip(async Se=>{let $t=b({src:t,dest:Se,startAtSec:V},d);await(i?aD($t):dD($t)),await gD(Se),o&&c!=null&&c!==0&&(n.info("rotating in place..."+Se,{rot:c}),await tD(Se,c))}),s}async function rD(t,e){let r=p("img/Video.validVideo("+t+")");if(await Pm(t,e)==null&&r.throw("Could not extract a video frame"),await Gf())return lD(t)}var M1=p("ExposureSettings");function yD(t){let e={focalLength:t.FocalLength,iso:Hp(t.ISO,t.ISOSpeed,t.SonyISO),aperture:Hp(t.FNumber,t.Fnumber,t.ApertureValue,t.SonyFNumber),shutterSpeed:su(t.ExposureTime,t.ShutterSpeed,t.SonyExposureTime)};return M1.debug("extracted from "+t.FileName,{exposureSettings:e}),yl(e)}function bD(t,e){let r=Math.pow(2,e),i=[];for(;t>0;)i.unshift(t%r),t=Math.floor(t/r);return i}function Kf(t){t.dims.forEach(r=>r.value=ee(r.min,r.max,r.value));let e=0;for(let r=0;r<t.bitDepth;r++){e*=2;let i=r%t.dims.length,o=t.dims[i],n=ar([o.min,o.max]);o.value>n?(e+=1,o.min=n):o.max=n}return e}function Tg(t,e){if(e.bitDepth>52||e.bitDepth<0)return;let r=P1(t);for(let i=0;i<e.bitDepth;i++){let o=i%e.dims.length,n=e.dims[o],s=ar([n.min,n.max]);r.includes(e.bitDepth-i-1)?n.min=s:n.max=s}return e.dims.map(i=>ar([i.min,i.max]))}function P1(t){return t.toString(2).split("").reverse().map((e,r)=>e==="1"?r:-1).filter(e=>e!==-1)}var E1=30;function D1(t){return Math.floor(t/5)*5}function vg(t){return re(t)&&t!==0&&Ie(-90,90,t)}function Sg(t){return re(t)&&t!==0&&Ie(-180,180,t)}function A1(t,e){return vg(t)&&Sg(e)}function wD(t,e){return L1(t,e,30)}function L1(t,e,r=E1){return A1(t,e)?Kf({dims:[{min:-180,value:e,max:180},{min:-90,value:t,max:90}],bitDepth:D1(r)}):void 0}function Mg(t){return Cs(t?.timestamp,e=>Ra(new Date(e*1e3),r=>r))}async function Pg(t){return y(t.readJson("info"),e=>pi({Title:Dp(e.title),Description:Dp(e.description),GPSLatitude:Je([e?.geoData?.latitude,e?.geoData?.latitude],r=>vg(r)?r:void 0),GPSLongitude:Je([e?.geoData?.longitude,e?.geoData?.longitude],r=>Sg(r)?r:void 0),GPSAltitude:Je([e?.geoData?.altitude,e?.geoData?.altitude],r=>re(r)?r:void 0),favorited:e.favorited==null?void 0:I(e.favorited),peopleNames:De([...D(e.people),...D(e.person)],r=>G(r.map(i=>i.name))),creationTime:Mg(e.creationTime),modificationTime:Mg(e.modificationTime),photoTakenTime:Mg(e.photoTakenTime),imageViews:Cs(e.imageViews,r=>r)}))}function Eg(t,e,r=""){let i=t.replace(e,r);return i===t?t:Eg(i,e,r)}var F1=["BenQ","GoPro","HTC","LG","NEC","OnePlus","Sony","TrueHDR"],I1=new Map(F1.map(t=>[t.toLowerCase(),t]));function O1(t){let e=t.trim(),r=I1.get(e.toLowerCase());return r??(e.length<4?e:e.toLowerCase().replace(/(?:^|\s|-)\S/g,i=>i.toUpperCase()))}var xD=class{constructor(){this.ignorables=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|");this.ignorableSep="[\\s\\.,_-]*";this.IgnorableMakePatterns=new RegExp(`${this.ignorableSep}(?:${this.ignorables})${this.ignorableSep}$`,"i");this.IgnorableModelPatterns=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i];this.samsungPatterns=[[/^PL150 /,"PL150"],[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-G98[01]/,"Galaxy S20"],[/^SM-G98[56]/,"Galaxy S20+"],[/^SM-G988/,"Galaxy S20 Ultra"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]];this.lgPatterns=[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]];this.onePlusPatterns=[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]];this.CommonNamesByMake={Samsung:this.samsungPatterns,LG:this.lgPatterns,OnePlus:this.onePlusPatterns}}},Dg=l(()=>new xD);function Fm(t){return j(t,e=>(e=qp(e),e=Eg(e,Dg().IgnorableMakePatterns),e=e.replace(/\s+app on Apple iDevice$/i,""),e=e.replace(/\bLGE\b/,"LG"),e=O1(e),e))}var k1=/<(.+?)[,/].+>/;function TD(t,e){if(T(t)||T(e))return;let r=qp(e);if(t==="Samsung"){let o=k1.exec(r);o!=null&&(r=o[1])}let i=f(Dg().CommonNamesByMake[t],o=>o.find(([n])=>r.match(n)!=null));if(i!=null)return i[1].trim();t==="Sony"&&(r=r.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"\u03B1").replace(/7CL/i,"7c").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V").replace(/M6$/," VI").replace(/M7$/," VII").replace(/M8$/," VIII").replace(/M9$/," IX").replace(/M10$/," X").replace(/M11$/," XI")),t==="Olympus"&&(r=Z(/^(.+?\d)mark(i.+?)$/i.exec(r),o=>`${o[1]} Mark ${o[2]}`,()=>r)),t==="Canon"&&(r=r.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel"));for(let o of Dg().IgnorableModelPatterns)r=Eg(r,o).trim();return r=r.replace(new RegExp(`^${yi(t)}\\s+`,"i"),""),t.match(/^HP|Hewlett.Packard$/i)!=null&&r.match(/^hp\b/i)!=null&&(r=r.slice(2).trim()),r}var R1=/\b(n\/a|unknown)\b/i;function _1(t){return t.filter(e=>M(e)&&R1.exec(e)==null)}var vD=l(()=>p("LensMakeModel"));function Jf(t){let e=Fm(t.LensMake),r=Fm(t.Make),i=_1([e,t.LensMake,r,t.Make]),o=a=>(a=MD(a),i.reduce((m,c)=>Lu(m,c).trim(),a)),n=Je([t.LensInfo,t.LensSpec,t.LensModel,t.LensID],SD),s=L([t.LensID,t.LensModel,t.LensSpec,t.LensInfo]);vD().debug("extractLensMakeModel",{lensMake:e,lensInfo:n,lensModels:s});for(let a of s){let m=SD(a)!=null;if(vD().debug("extractLensMakeModel",{lensModel:a,hasLengthAndAperture:m}),!!m){if(M(e))return{lensMake:e,lensModel:o(a),lensInfo:n};if(a.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:o(a),lensInfo:n};for(let c of G([e,r,...u.lensMakes.values]))if(a.toLowerCase().includes(c.toLowerCase()))return i.unshift(c),{lensMake:c,lensModel:o(a),lensInfo:n}}}}function SD(t){if(T(t)||h(t).toLowerCase().includes("unknown"))return;let e=N1(t.replace(/\b(AF-S|DG|Digital|DI|DX|E|ED|HSM|LM|OIS|Pro|R|XF)\b/gi,"")),r=/[\d.-]+mm/.exec(e)?.[0],i=/f\/[\d.-]+/.exec(e)?.[0];if(!(r==="0mm"||i==="f/0"))return Rs(r,i,(o,n)=>`${o} ${n}`)}function MD(t,e=3){return t.replace(/\d+\.\d+/g,r=>Z(Jr(r),i=>String(Ge(i,e)),r))}function N1(t){return MD(t).replace(/(\d) - (\d)/g,(e,r,i)=>`${r}-${i}`).replace(/(\d)\s+mm\b/,(e,r)=>r+"mm").replace(/\s+f\/?(\d)/i,(e,r)=>" f/"+r)}function PD(t){let e=H(["OLYMPUS DIGITAL CAMERA",t.originalMake,t.originalModel,t.Model,t.Make,t.CameraID]).map(i=>j(i,o=>o.trim().toLowerCase().normalize())),r=(...i)=>{for(let o of i){let n=h(t[o]).trim();if(M(n)&&!e.includes(n.toLowerCase().normalize()))return n}};return pi({title:r("XPTitle","Title","ObjectName"),description:r("XPSubject","Description","ImageDescription","Caption-Abstract")})}var Xi=l(()=>p("ExifTags")),B1=!1;function C1(){return u.exiftoolProcsPerChild.value??(lt()>4?3:2)}var Ag=l(()=>new Hl("ExifTool",new ED.ExifTool({logger:()=>p("ExifTool"),maxProcs:C1(),maxIdleMsPerProcess:5*E,maxTasksPerProcess:u.maxTasksPerProcess.valueOrDefault,cleanupChildProcs:!1}),oe.service,!0).t);function wm(){let t=Ag();return t.ended?Ag.refresh():t}function FD(){return f(Ag.prior(),t=>t.ended?void 0:Ae(t.version(),q,()=>{throw new Error("ExifTool timed out")}))}Ys((t,e)=>y(ID(t),r=>{let i=ne.for(e);return $f.getOrSetAsync(i.nativePath,()=>Promise.resolve(b(b({},r),{SourceFile:i.nativePath,FileName:i.base,Directory:i.dir})))}));function XE(t,e,r){return wm().extractBinaryTag(t,e,r)}var $f=new Vi({maxSize:128,timeoutMs:E}),Qf=new Vi({maxSize:128,timeoutMs:E});function OD(){$f.clear(),Qf.clear()}B(()=>W(OD));Xt(t=>{T(t)?OD():($f.deleteIf(e=>e.startsWith(t)),Qf.deleteIf(e=>e.startsWith(t)))});var kD=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];async function RD(t,e){let r=i=>y(st(i,!1),o=>Bt(o,...kD));return await zn(t.clear().sha(),e.clear().sha())||await zn(r(t),r(e))}async function Im(t){if(t==null)return;let e=ne.for(t);if(!(await e.isEmpty()||await e.isNotReadable()))return pt("tags.readTags",async()=>y(st(e),r=>V1(e,r)))}async function ID(t){return $f.get(String(t))}async function gs(t){if(T(t))return;let e=ne.for(t);return Ut(()=>y(Qf.get(e.nativePath),r=>r.MIMEType),()=>y(ID(e),r=>r.MIMEType),()=>y(xm(e.nativePath),r=>r.mime==="image/tiff"?void 0:r.mime),()=>Ev(e.ext)?y(st(e,!1),r=>r.MIMEType):void 0)}async function qa(t,e){let r=ne.for(t),i=e==null||T(e.ImageHeight)?await st(r):e;if(i==null)return;let o=x(hn(e),()=>hn(i)),n=wn(i.MIMEType)?await Df(r).catch(a=>{Xi().warn("Failed to read raw info",{file:r.nativePath,err:me(a)})}):void 0,s=ys(i,o,n);if(s!=null)return s;if(dr(i.MIMEType))return y(Pm(r,i.MIMEType),a=>qa(a,i))}async function gD(t){await wm().deleteAllTags(t.nativePath),await t.sibling(t.base+"_original").unlink("trace")}async function st(t,e=!0){let r=ne.for(t);if(!!await r.isFile())return pt("tags.readRawTags",async()=>{let i=await _D(r.nativePath);if(i==null||!e)return i;let o=ea(r.jsonSidecars(),Pg),n=ea(r.sidecars(),a=>_D(a.nativePath)),s=b({},i);for(let[a,m]of[...await o,...await n]){let c=Bt(a,...kD);_(yt(c))?((s.sidecars??(s.sidecars=[])).push(m.base),Js(s,c),Xi().debug("readRawTags() sidecar had values",{sidecar:m.base,safeTags:c})):Xi().debug("readRawTags() sidecar was empty",{sidecar:m.base})}return s})}var Lg=new Ot,Fg=new Ot;O||(Lg.resolve(),Fg.resolve());async function _D(t){return Qf.getOrSetAsync(t,async()=>{Xi().debug("_readRawTags("+t+") not cached, reading now.");let e=Lg.pending;e?Lg.resolve():await Fg.promise;let r=tm((0,DD.extname)(t))?[]:void 0,i=await pt("exiftool.read()",()=>Ae(da(wm().read(t,r).catch(o=>{Xi().info("Failed to read "+t,o)})),q));return e&&Fg.resolve(),f(i,o=>(Xi().debug("_readRawTags("+t+") in "+o.elapsedMs+"ms"),f(o.result,n=>{for(let a of gt(n)){let m=n[a];if(typeof m=="string"){let c=zE(m);c!=null&&(n[a]=c)}}let s=G([n.Error,...x(n.errors,[]),n.Warning].map(h));return _(s)&&(n.problems=s),n.exiftoolMs=o.elapsedMs,B1&&(n.instance=jc()),n})))})}async function V1(t,e){if(e==null)return;let r=e.MIMEType,i=t.nativePath;if(T(r)){Xi().debug("No mimetype for "+t);return}let o=t.nativePath.startsWith(u.cacheDir.valueOrDefault)||t.pathnames.includes(".photostructure");o||await LD(t,e);let n=e;n.originalMake=e.Make,n.originalModel=e.Model,e.Make=Fm(e.Make),e.Model=TD(e.Make,e.Model);let s=Jf(e),a=await AD(t,e,o);if(a==null){Xi().info("No capturedAt for "+t);return}let m=yD(e),c=await qa(t,e);if(c==null){Xi().info("No size info for "+i);return}let d=r.startsWith("video/")?Ba(e):void 0,w=b(b(b(b({mimetype:r,exposureSettings:m},PD(n)),s),c),{duration:d,capturedAt:a,tz:e.tz});return Xi().debug("parsedTags",b(b({nativePath:i},w),{capturedAt:f(a,P=>({date:P.date,src:P.src}))})),b(b({},n),w)}var Zi=l(()=>p("TagInference"));async function LD(t,e){if(M(e.Make)&&M(e.Model))return;if(T(e.Make)&&(h(e.HandlerDescription)+h(e.CompressorName)).includes("GoPro")){e.Make="GoPro";return}let r=vs(t),i=await Ig(t);if(i==null)return;let o=L(ie(Un(i.younger,i.older))).slice(0,50).filter(n=>oc(vs(n),r)>.7).slice(0,10);Zi().info("inferMakeAndModel("+t+"): looking at nearby siblings",o.map(n=>n.base));for(let n of o){let s=await st(n);if(s!=null&&Pu(s.Make,s.Model)){Zi().info("inferMakeAndModel("+t+")",{sibling:n.base,Make:s.Make,Model:s.Model}),e.Make=s.Make,e.Model=s.Model;return}}}async function ND(t){return y(z1(t),({before:e,after:r,index:i,slots:o})=>{if(!GM(e.date,r.date)){Zi().debug("inferCapturedAtFromSiblings(): rejecting, not same day",{file:t.nativePath,before:h(e),after:h(r)});return}return f(Mr.for(e.date,r.date,i,o),n=>({date:n,src:`before:${e.src},after:${r.src}`}))})}async function BD(t,e=7){return bl(D(t).slice(0,e),(r,i)=>y(st(r),o=>y(Yf(o),n=>b(b({},n),{index:i}))))}async function U1(t,e=7){return bl(t.slice(0,e),(r,i)=>y(st(r),o=>y(Yf(o),n=>C(n).filter(s=>fn(s.date)).flatMap(s=>jh(s.date)).map(s=>({zoneName:s,index:i})).get())))}B(()=>W(()=>CD.prior()?.clear()));var CD=l(()=>new ke(1024));function z1(t){return CD().getOrSet(t.nativePath,async()=>{let e=await Ig(t),r=await BD(e?.younger),i=await BD(e?.older);return r==null||i==null?void 0:{before:r,after:i,index:r.index,slots:r.index+i.index+1}})}B(()=>W(()=>VD.prior()?.clear()));var VD=l(()=>new ke(2048,E));function vs(t){let e=St(t)?t:t.name;return VD().getOrSet(e,()=>(f(/(?:burst)(.{8,})$/i.exec(e),r=>e=r[1]),f(/^(?:(?:dsc[0f]?|img|mov|mvi|mvimg|vid|gpfr|gopro?|gp|gf|p)(?:[-_ ])?)(\S.+)$/i.exec(e),r=>e=r[1]),e.replace(/\s*-?\s*copy( \(?\d+\)?)?\s*$/i,"").replace(/\s*\((another |\d+[a-z]{2} )?copy\)\s*$/i,"").replace(/^[-\s_0]+/,"").replace(/[\s-_][\d\s]{0,2}$/,"").replace(/_cover$/i,"").toLowerCase().normalize()))}var W1=bm(wt.AssetFile);async function Ig(t,e=7){let r=await t.parent().childDirectoryEntries(d=>d.isFile()&&!d.name.startsWith(".")&&!rm(d.ext)&&W1.apply(d));if(r==null){Zi().info("nearestSiblings(): can't readdir parent, "+t.parent());return}let i=await t.statTimes();if(R(i)){Zi().info("nearestSiblings(): statTimes() missing from "+t);return}let o=te(r,d=>vs(d)),n=o.findIndex(d=>d.base===t.base);if(n<0){Zi().warn("nearestSiblings(): can't find self in siblings: "+t);return}let[s,a]=[o.slice(n-e*2,n),o.slice(n+1,n+1+e*2)],m=[],c=[];for(;_(s)&&m.length<e;){let d=ne.forDirectoryEntry(s.pop());await zD(t,d)&&m.push(d)}for(;_(a)&&c.length<e;){let d=ne.forDirectoryEntry(a.shift());await zD(t,d)&&c.push(d)}return{younger:m,older:c}}function zD(t,e,r=2*ht){let i=Kh(qh(t.base),qh(e.base));return i!=null&&Math.abs(i)>r?!1:t.contemporary(e,r)}async function UD(t){let e=await Ig(t),r=Cb(D(e?.younger),D(e?.older)).slice(0,10);return Zi().tap({msg:"nearestSiblingTzOffset("+t+")",result:await y(U1(r),i=>i.zoneName),meta:{zipped:r}})}async function WD(t){let e=Wh(vs(t)),r=f(e,ai);if(e==null||r==null){Zi().debug("extractStatBname() bname isn't dated",{bname:vs(t),fromName:e,fromNameMs:r});return}let i=await t.stat();if(i==null){Zi().debug("extractStatBname() no stat",{fromName:e,fromNameMs:r});return}return Zi().tap({msg:"extractStatBname()",result:Je(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],o=>Math.abs(i[o]-r)<Ch?{src:o,date:e}:void 0),meta:{fromName:e,fromNameMs:r,stat:i}})}var q1=l(()=>p("CapturedAt"));function j1(t){return h(t).toLowerCase().startsWith("tags")}var Ga=class{constructor(e,r,i,o,n){this.nativePath=e;this.date=r;this.src=i;this.mtime=o;this.precisionMs=n;this.toISOString=l(()=>gm(this.date))}spread(e){let r=b(b({},this),e);return new Ga(r.nativePath,r.date,r.src,r.mtime)}toLocal(){return Hh(this.date)}toOffset(){return HM(this.date)}get isFromTags(){return j1(this.src)}toPrecisionMs(){return x(this.precisionMs,()=>Gh(this.date))}toString(){return k({nativePath:this.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return fn(this.date)}hasTime(){return Pr(this.date)}};async function G1(t,e,r,i){let o=await r;if(!!pr(o))return fn(o)?o:e!=null&&e.tz!=null&&qD.Info.isValidIANAZone(e.tz)?KM(o,e.tz):i?o:H1(t,o)}async function H1(t,e){if(!pr(e))return;if(fn(e))return e;let r=await UD(t);if(r!=null){let i=Ki(e,r);if(pr(i))return i}return e}function K1(t,e){return t==null||e||!u.usePathsToInferDates.valueOrDefault||!u.useLibraryPathsToInferDates.valueOrDefault&&la(t.nativePath,u.libraryPath.value)}async function AD(t,e,r){let i=await t.mtime(),o=async(n,s)=>y(s,a=>y(G1(t,e,a.date,r),m=>new Ga(t.nativePath,m,G([n,a.src]).join(":"),i,a.precisionMs)));return Ut(()=>o("tags",Yf(e)),()=>o("bname+stat",WD(t)),()=>r?void 0:o("siblings",ND(t)),()=>r||!u.usePathsToInferDates.valueOrDefault?void 0:o("bname",f(NM(vs(t)),n=>({date:n,src:"",precisionMs:Au([Gh(n),S])}))),()=>K1(t,r)?void 0:o("path",f(CM(t.pathnamesWithoutDrive),n=>({src:"",date:n}))),()=>u.useStatToInferDates.valueOrDefault?o("stat",y(t.minStatDate(),n=>({src:"",date:n}))):void 0)}var jD=["SubSecDateTimeOriginal","SubSecCreateDate","SubSecTimeDigitized","SubSecMediaCreateDate","DateTimeOriginal","OriginalCreateDateTime","CreateDate","DateTimeCreated","DateCreated","DateTimeDigitized","MediaCreateDate","DateTime","SubSecTime","ModifyDate","photoTakenTime"];function HD(t,e){return Ra(t[e],r=>({src:e,date:r}))}function Yf(t){if(t==null)return;let e=L(jD.map(i=>({date:t[i],src:i,ts:f(ai(t[i]),o=>Math.floor(o/1e3))}))),r=e.filter(i=>pr(i.date)&&i.ts!=null);return nn(Rt.debug,()=>{q1().debug("capturedAtFromTags()",{rawArr:e,validArr:r})}),Ri(()=>Dt(r,i=>f(Hh(i.ts),o=>[-Math.floor(o/1e8),Pr(i.date)?1:0,qM(i.date)?1:0,fn(i.date)?1:0,-jD.indexOf(i.src)])),()=>HD(t,"DateTimeUTC"),()=>HD(t,"GPSDateTime"))}var GD=128,KD=8;var Ue=Object.freeze({When:"When",Who:"Who",Where:"Where",What:"What",Camera:"Camera",Lens:"Lens",Albums:"Albums",Keywords:"Keywords",Type:"Type",FS:"fs"}),NSe=[Ue.When,Ue.Camera,Ue.Lens,Ue.Type,Ue.FS];var JD=l(async()=>new Intl.DateTimeFormat(await hc(),{month:"short"})),$D=l(async()=>{let t=await JD();return so(0,12,e=>t.format(new Date(2016,e,1))).map(e=>sr(e,"."))});W(()=>{JD.unset(),$D.unset()});function J1(t){return 1e4-t}function $1(t){return 13-t}function QD(t){return 13-t}function Q1(t){return 33-t}function Y1(t){return we(t,e=>({name:h(e),ordinal:J1(e)}))}async function Og(t){if(!!Ie(1,12,t))return f((await $D())[t-1],e=>({name:String(t),displayName:e,ordinal:$1(t)}))}function X1(t){return we(t,e=>({name:h(e),ordinal:Q1(e)}))}async function YD(t){let e=h(u.tagYMD.valueOrDefault).toLowerCase();if(t==null||e===""||e==="off"||e.startsWith("disable"))return;let r=[Ue.When];if(e.startsWith("y")){let i=f(Mo(t),Y1);if(i==null)return;r.push(i)}if(e.startsWith("ym")){let i=await f(Po(t),Og);if(i==null)return r;r.push(i)}if(e.startsWith("ymd")){let i=f(Eo(t),X1);if(i==null)return r;r.push(i)}return r}var bMe=l(()=>p("Names"));var CMe=p("WhoTagger");var ko=String.fromCharCode(31),Xf="Library",ZD=[{name:Ue.When,ordinal:1},{name:Ue.Albums,ordinal:2},{name:Ue.FS,ordinal:3},{name:Ue.Who,ordinal:4},{name:Ue.Camera,ordinal:5},{name:Ue.Lens,ordinal:6},{name:Ue.Keywords,ordinal:7},{name:Ue.Type,ordinal:8}];function XD(t){return f(t,e=>x(e.name,h(e)))}function Z1(t){return t.map(XD)}function zr(t,e=ko){return Z1(t).join(e)+(e===ko?e:"")}function eA(t){return hu(Tn(t))}function Tn(t,e=ko){return h(t).split(e).filter(M)}function tA(t){return zr(Tn(t))}var uA=v(require("util"));var kg=l(()=>p("AssetFileSorter")),eB=[ni,"file",vo,ji];function tB(t){return f(t,e=>Rn(e.width,e.height,(r,i)=>rA(r*i)))}function rA(t){return Math.round(Math.pow(t,u.variantSortCriteriaPower.valueOrDefault))}function rB(t){return Math.round(t/(2*E))}function iA(t){for(let i of H(t.map(o=>o.sha))){let o=t.filter(s=>s.sha===i),n=Math.max(...L(o.map(s=>s.mtime)));o.forEach(s=>s.mtime=n)}let e=L(t.map(i=>f(iB(i),o=>f(oB(o),n=>({f:i,crit:n,pojo:o}))))),r=te(e,({crit:i})=>i);return De(r,i=>i.map(o=>o.f))}function iB(t){let e=tB(t),r=Ee.parse(t.uri);if(T(r.scheme)||T(r.path)||t.mtime==null){kg().debug("assetFileSortCriteriaPojo(): skipping",{af:t,parsedURI:r});return}let i=eB.indexOf(r.scheme);if(i===-1){kg().debug("assetFileSortCriteriaPojo(): skipping",{af:t,schemeIdx:i,parsedURI:r});return}let o=Zw(r.path),n=o.base.toLowerCase().includes("cover"),s=Dv(o.ext),a=x(rx(o.name),0),m=rB(t.mtime),c=no(t.fileSize,rA),d={resolution:e,mtime:m,schemeIdx:i,fileSize:c,isCover:n,count:a,isBrowserSupported:s},w={};for(let P of u.variantSortCriteria.values)f(d[P],A=>w[P]=A);return w.uri=t.uri,w}function oB(t){let e=yt(t);if(e.some(r=>r==null)){kg().debug("pojoToCriteria(): skipping",{pojo:t});return}else return e}function oA(t,e,r){let o=qe.fit().map(a=>[a.outputSize(t),a]).filter(([a])=>a!=null),n=t;function s(a,m){let c=Er(n)/Er(a),w=m===0&&(r!=="image/jpeg"||N(e))||c>3||Er(a)-Er(n)>2.5;return w&&(n=a),w}return o.filter(([a],m)=>s(a,m))}function nA(t){return t==="qhd"?"wvga":t==="uhd"?"uhd4k":t}function sA(t,e){return fu(G(t).map(nA),G(e).map(nA))}var aA=v(require("sharp"));var nB=l(()=>p("Sharp"));async function lA(t){try{let{data:e,info:r}=await t.raw().toBuffer({resolveWithObject:!0});return sB(e,r)}catch(e){return nB().info("Failed to buffer-clone sharp",e),t.clone()}}function sB(t,e){return(0,aA.default)(t,{raw:e})}var OPe=require("sharp"),aB=l(async()=>{let t=ne.for(Rr.ICC()),e={};for(let r of u.iccProfileMappings.valueOrDefault){let[i,o]=r.split(":"),n=t.join(o);await n.isNonEmptyFile()?e[i]=n.nativePath:p("SharpColorspace").warn(" iccProfileMappings has an invalid ICC profile filename: "+o)}return Object.freeze(e)});async function mA(t,e){let o=(await st(t,!1))?.ProfileDescription;if(!T(o)){let n=await aB();for(let s of gt(n))if(o.includes(s))return e.withMetadata({icc:n[s]})}return e.toColorspace("srgb")}var lB=require("sharp"),Rg=class{constructor(e,r){this.ap=e;this.assetFiles=r;this.badShas=new ns(2*E);this.logger=p("AssetPreviewBuilder("+e.assetId+")")}[uA.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build_(e){return pt("img.AssetPreviewBuilder.build()",async()=>{let r=L(await iA(await this.assetFiles));for(this.logger.info("build_(): asset file candidates:",r.map(i=>i.uri).reverse());_(r);){let i=r.pop(),o=await ne.forUri(i.uri);if(o==null)continue;let n=await o.sha();if(!(n==null||this.badShas.has(n)))try{return await this._build(o,i,e)}catch(s){this.badShas.add(n),this.logger.warn("Failed to set shown file to "+i,me(s))}}return this.logger.throw("none of the files are valid",{ignorable:!0,retriable:!1})})}async _build(e,r,i){this.logger.info("_build("+e+")",{uri:r.uri}),I(i.validate)&&await iD(e);let o=await e.size(),n=await e.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:o,mtime:n,best:r}),o==null||n==null)return this.logger.throw("build(): missing stat info for best file",{ignorable:!0,best:r});if(r.width==null||r.height==null||r.mimetype==null||r.sha==null)return this.logger.throw("IE build(): missing fields for best file "+e,{ignorable:!0,best:r});let s=oA(r,r.rotation,r.mimetype),a=b(b({assetFileId:r.id},rt(r,"assetId","uri","width","height","mimetype","sha","rotation")),{path:e.nativePath,mtime:n,filesize:o,fitSizes:s.map(([,J])=>J.name).join(",")});if(i.force!==!0&&!u.forceSync.valueOrDefault){let J=await this.ap.readInfo.refresh();if(J!=null){if(J.assetId!==a.assetId)throw new Error("IE build(): Mismatched asset IDs for "+r+": "+k({priorInfo:J,info:a}));let Q=J.fitSizes.split(","),Qt=a.fitSizes.split(",");if(J.sha!=null&&J.sha===a.sha&&J.rotation===a.rotation&&sA(Q,Qt)){let Dr=du(Q,Qt);if(_(Dr)){this.logger.info("build(): removing previews that aren't required anymore.",{leftovers:Dr});for(let gr of Dr){let Pi=s.find(([,Fn])=>Fn.name===gr);if(Pi==null)this.logger.warn("build(): Failed to clean up: missing fit size",{fitsize:Pi,fits:s});else{let Fn=this.ap.fileForWidth(Pi[1].reducer.name,Pi[0].width);this.logger.debug("build(): unlinking unwanted preview "+Fn,{fitsize:Pi}),await Fn.unlink("warn")}}}return this.logger.debug("build(): SHA and rotation match, and previews exist.",{info:a,priorInfo:J}),await this.ap.writeInfo(a),a}}}let m=new Xo({path:e.nativePath,op:"Building previews for"},qe.sq().length+qe.fit().length);if(this.logger.debug("Rebuilding all previews from "+r.uri,{assetId:r.assetId,best:r,info:a}),await this.ap.parent.mkdirp()==null)throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+r);let c=await this.ap.existingFiles(),d=await Ts(e,qe.largestFit().max);if(d==null)throw new le({message:"AssetPreviewBuilder.build(): "+r.uri+", "+e.nativePath+", is not readable by sharp.",retriable:!1});let w=await mA(e,lB(d.nativePath));r.mimetype.startsWith("image/")&&!ws(r.mimetype)&&r.rotation!=null&&r.rotation!==0&&(w.rotate(r.rotation),this.logger.debug("build(): rotating "+r.rotation+"\xB0")),d.name.toLowerCase().includes("thumbnail")&&it(()=>w.trim(1));let P=[],A,V,Se=qe.largestSq(),$t=Vo(s,([J,Q])=>f(Se.outputSize(J),()=>Q.megapixels()))?.[1].name,He=rt(r,"width","height");{let J=w.clone(),Q=He;for(let[Qt,Dr]of s){let gr=Date.now(),Pi=Q,Fn=this.ap.fileForWidth(Dr.reducer.name,Qt.width).wip();J=Dr.resize(Qt,J),Q=Qt,Dr.name===$t&&(V=J.clone(),A=Qt),await Dr.toJpeg({path:Fn.nativePath,sh:J,outputSize:Qt}),m.onProgress(),this.logger.debug("resize("+Dr.name+") "+Cr(Pi)+" -> "+Cr(Qt)+" in "+(Date.now()-gr)+" ms"),P.push(Fn)}}{V==null?(this.logger.debug("square resize(): resorting to ",{origDim:He,bestFitNameForSq:$t}),V=w,A=He):this.logger.debug("square resize(): using to ",{sqDim:A,bestFitNameForSq:$t});let J=!1;for(let Q of qe.sq()){let Qt=Date.now(),Dr=A,gr=Q.outputSize(x(A,He));if(gr==null){this.logger.debug("skipping square output for "+Q.max);continue}J||(gr.position=u.squareThumbStrategy.valueOrDefault,J=!0),this.logger.debug("Applying ",{outputSize:gr});let Pi=this.ap.fileForWidth(Q.reducer.name,gr.width).wip();Q.resize(gr,V),gr.position!=null&&(this.logger.debug("Cloning square crop to make position consistent",{outputSize:gr}),V=await lA(V)),A=gr,await Q.toJpeg({path:Pi.nativePath,sh:V,outputSize:gr}),m.onProgress(),P.push(Pi),this.logger.debug("resize("+Q.name+") "+Cr(Dr)+" -> "+Cr(gr)+" in "+(Date.now()-Qt)+" ms")}}try{await Promise.all(c.map(J=>J.unlink())),await Promise.all(P.map(J=>J.unwip_())),await this.ap.writeInfo(a),this.logger.debug("Previews unwipped and info written",{info:a})}catch(J){throw await ge(P,Q=>Q.unlink()),new le({cause:J,fatal:!1,message:"Failed to create previews from "+e})}return a}};var mB=p("extractPreviewInfo");function Om(t,e){let r=e.posixPathFrom(t).replace(/\//g,"").split("-"),i=U(r[0]),o=r[1],n=Ht.validOrElse(o,void 0),s=tw(r[2]);if(N(i))return{file:e,assetId:i,reducer:n,width:s};mB.warn("Failed to extract preview info",{file:e,previewsRoot:t,arr:r,assetId:i,reducer:n,width:s})}async function cA(t,e){return Rs(e.assetId,e.width,(r,i)=>y(Si(e.file),o=>{let n=cP(o),s=sr(t,ex(t));return{size:n,basename:`${s}-${n}${e.file.ext}`,title:_g(e.file,n,"image",o),description:`Download ${n}`,details:`(${Cr(o)} ${e.file.ext})`,href:new pn(r).imgLink(Ht.fit,i)}}))}function _g(t,e,r,i){return`Download ${e} ${t.ext} ${r} (${Cr(i)})`}var zEe=new ha,Ng=class{constructor(e,r,i){this.previewsRoot=e;this.alp=i;this.readInfo=l(()=>this.infoJson().readJson("debug"));this.logger=p("AssetPreviews(assetId:"+Ao(r)+")"),this.assetId=Ao(r),this.urls=new pn(r);let o=di(this.assetId,8,"0"),n=zo(o,3);this.basename=n.pop()+"-",this.parent=e.join(...n)}existingFiles(){return Pe(this.parent.childFiles(e=>e.base.startsWith(this.basename)),()=>[])}existingJpgs(){return Pe(this.parent.childFiles(e=>e.base.startsWith(this.basename)&&e.ext===".jpg"),()=>[])}async previews(){let e=await this.existingFiles();return Pl(L(e.map(r=>Om(this.previewsRoot,r))),r=>r?.file.size())}async deleteAll(){this.parent.clear();let e=await this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return await Promise.all(e.map(r=>r.unlink())),e}file(e){return this.parent.join(this.basename+e)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(e){return this.readInfo.unset(),this.infoJson().writeJsonMaybe(e,{spaces:2})}fileForWidth(e,r){return this.file(e+"-w"+r+".jpg")}filesForReducer(e){let r=this.basename+e+"-";return this.existingFiles().then(i=>i.filter(o=>o.base.startsWith(r)))}async smallestFileForReducer(e){return Vo(await this.filesForReducer(e),r=>x(f(Om(this.previewsRoot,r),i=>i.width),0))}async largestFileForReducer(e){return Dt(await this.filesForReducer(e),r=>x(f(Om(this.previewsRoot,r),i=>i.width),0))}async widths(e){let r=await this.filesForReducer(e);return or(L(r.map(i=>f(Om(this.previewsRoot,i),o=>o.width))))}async posterLink(){let e=await this.widths(Ht.fit);return this.urls.imgLink(Ht.fit,Math.max(...e))}async imgAttrs(e,r=!1,i=!0){if(!r&&e===Ht.sq)return this.urls.sqImgAttrs(i);{let o=e===Ht.fit?await this.readInfo():void 0;return this.urls.imgAttrs(e,await this.widths(e),i,o)}}};var Bg=class{constructor(e,r){this.root=e;this.alp=r;this.id2ap=new ke(512)}async build_(e){return this.apb(e.assetId,e.assetFiles).build_(e)}apb(e,r){return new Rg(this.ap(e),r)}ap(e){let r=h(Ao(e)),i=this.id2ap.get(r);if(i!=null&&XM(e,i.assetId))return i;{let o=new Ng(this.root,e,this.alp);return re(e)||this.id2ap.set(r,o),o}}clearAssetId(e){this.id2ap.delete(h(e))}};var fA=v(require("process"));var uB=require("net"),Ur=p("rpc.Server"),cB=({params:t,conn:e})=>(j(t.serviceName,r=>{T(e.serviceName)&&(e.serviceName=r)}),we(t.pid,r=>{T(e.pid)&&(e.pid=r)}),`pong to ${e.serviceName}@${e.pid} from ${qt()}@${fA.pid} at ${new Date}`),pA=class{constructor(e){this.socket=e}toString(){return T(this.serviceName)?sa(this.socket):`${this.serviceName}:${this.pid}`}},Cg=class{constructor(e,r=!0){this.port=e;this.unref=r;this._ended=!1;this._ready=new Ot;this.connections=[];this.onPause=()=>this.broadcast("pause");this.onResume=()=>this.broadcast("resume");this.handlers=new Map;this.sid=l(()=>Qo.randomChars(12));this.start=Bl(async()=>{if(!this.ended)return Ur.debug("start("+this.port+")"),this.server=uB.createServer(this.onConnect.bind(this)),this.server.on("listening",()=>{Ur.info("listening on "+this.port),this._ready.resolve()}),this.server.on("error",async e=>{Ur.warn("error, rejecting ready"),this._ready.reject(),await this.onError("createServer"+ce,e)}),this.server.listen(this.port,u.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise},5e3);this.end=l(async()=>{this._ended=!0,ue.removeListener("pause",this.onPause),ue.removeListener("resume",this.onResume),await this.closeAllConnections(),await $w(this.server)});this.name="Server:"+e,this.addHandler("ping",cB),this.addSimpleHandler("broadcast",i=>(ue.emit(i.event,i.args),this.broadcast(i.event,i.args))),Qs(this.onPause),Ho(this.onResume),Ru(this),cM(this)}get connectionCount(){return this.connections.length}async serialize(e){return k(b({sid:this.sid()},e))+`
`}addHandler(e,r){let i=this.handlers.get(e);i!=null&&Ur.warn("addHandler(): overwriting",{method:e,prior:i,newHandler:r}),this.handlers.set(e,r)}addSimpleHandler(e,r){this.addHandler(e,({params:i})=>r(i))}addSimpleHandlers(e){Ke(e).forEach(([r,i])=>this.addSimpleHandler(r,i))}get ended(){return this._ended||K()}get ready(){return this._ready.promise}closeAllConnections(){let e=this.connections.map(r=>Ci(r.socket));return this.connections.length=0,Promise.all(e)}broadcast(e,r){return this.sendAll({event:e,args:r})}async sendAll(e,r="write"){let i=await this.serialize(e),o=[...this.connections],n=o.length;Ur.debug("sendAll()",{pojo:e,method:r});for(let s of o)try{s.socket.writableEnded?n--:s.socket[r](i,()=>n--)}catch{n--}return Ve(()=>n<=0,{timeoutMs:S})}onConnect(e){Ur.info("Connection from "+sa(e)),this.unref&&e.unref();let r=new pA(e);this.connections.push(r),e.on("end",()=>{Ur.info("Closing connection from "+sa(e)),Ft(this.connections,i=>i.socket!==e)}),e.on("error",async i=>{Ur.warn("on error from "+sa(e)+": "+i),await this.onError("socket",i),e.end()});try{Zo(e,`
`,i=>this.onRequest(i,r))}catch(i){Ur.warn("Caught error from "+sa(e)+": "+i),e.end()}}async onRequest(e,r){if(Ur.debug("onRequest()",e),T(e))return;let i="missing",o="missing";try{let n=JSON.parse(e);return j(n.id,s=>i=s),j(n.method,s=>o=s),await pt("rpc."+o,()=>this.handle(i,o,n.params,r))}catch(n){Ur.warn("invalid request",{line:e,error:n}),r.socket.write(await this.serialize({id:i,error:x(n.message,()=>h(n))}))}}async handle(e,r,i,o){let n=this.handlers.get(r);if(n==null)throw Ur.warn("bad handler request",{method:r,params:i,supported:gt(this.handlers)}),new Error("No handler for "+r);let{elapsedMs:s,result:a}=await ri(()=>n({id:e,method:r,params:i,conn:o}));Ur.log(wa(s,S),"handle()",{method:r,conn:h(o),elapsedMs:s,id:e,params:i,result:a}),o.socket.write(await this.serialize({id:e,result:a}))}async onError(e,r){this.ended||Y(e,r)}};var Nm=v(require("process"));var Vg=v(require("process"));function zg(){let t=(0,Vg.memoryUsage)();return qo([t.external,t.heapUsed,t.arrayBuffers])}function dA(){return Ge(zg()/Ce,2)}function Ug(){return(0,Vg.memoryUsage)().rss}function hA(){return Ge(Ug()/Ce,2)}var fB=l(()=>new ze("memoryCheck on exit",()=>{let t=p("PromiseTimer"),e=gA();t.log(iM(e)?"warn":"info","memory use on exit:",e)},oe.service));function gA(){fB();let t=[],e=[],r=[];function i(o,n,s){if(!N(o))return Y("memoryCheck(): invalid bytesUsed. "+k({bytesUsed:o,desc:s})+Gn);let a=o/Ce,m=`used by ${qt()} (${Hn(o,2)})`;a>=n?r.push(`${s} ${m} is high`):a>=n*.8?e.push(`${s} ${m} is high`):t.push(`${s} ${m} is OK`)}return i(zg(),u.maxMemoryMb.valueOrDefault,"Used memory"),i(Ug(),u.maxRssMemoryMb.valueOrDefault,"RSS memory"),{ok:t,warn:e,bad:r}}function yA(){return!he&&!u.scanAllDrives.valueOrDefault&&R(u.scanPaths.values)?{warn:["Nothing to scan: scanAllDrives is false and scanPaths is empty."]}:{}}async function km(){try{return sf(await Ss(),gA())}catch(t){return nf({fail:[Kr(me(t),"healthChecks failed")]})}}async function bA(){if(Ti()||K())return!0;let t=await km();return t==null||_(t.fail)||_(t.bad)||_(t.warn)}var LA=v(require("util"));var wA=v(require("knex"));var eo=(0,wA.default)({client:"sqlite3",useNullAsDefault:!0});var pB=".sqlite3";function Ms(t,e){return t.join(e,"db"+pB)}var xA,vn=()=>xA;function TA(t){xA=t}function vA(){return f(xt(),t=>Ms(t,"models"))}var Wg=new Map;function qg(t){Wg.set(t.$ctor,t)}var dB=([t,e])=>t!=null&&e!=null;function SA(t,e){if(e==null)throw new Error("json is null");if(t!=null&&M(t.$ctor)&&!Wg.has(t.$ctor)&&qg(t),e instanceof t)return e;let r=C(e.$ctor).flatMap(o=>Wg.get(o)).getOrElse(()=>t);if(e instanceof r)return e;let i=new r;return e==null?i:Ro(i,e,H([t.tableName+".",r.tableName+"."]))}function Ro(t,e,r=[]){let i=t.class();return gt(e).filter(n=>n!=="$ctor").filter(n=>e[n]!=null).map(n=>{let s=e[n];return r.forEach(a=>n=Qe(n,a)),mo(i.booleanFields,n)?[n,I(s)]:[n,s]}).filter(dB).forEach(([n,s])=>t[n]=s),t}function MA(t){return t===null||mo(["number","string"],typeof t)}function jg(t){return t!=null&&Array.isArray(t)?t.every(jg):Ke(t).every(([,e])=>MA(e))}function PA(t){return Co(t,(e,r)=>{if(!e.startsWith("$")){if(typeof r=="boolean")return[e,r?1:0];if(MA(r))return[e,r];if(VM(r))return[e,ai(r)]}})}function hB(t){return t!=null&&St(t.sql)&&(t.bindings==null||jg(t.bindings))}function Zf(t){if(t==null)throw new Error("null sql");if(hB(t))return t;if(St(t))return{sql:t};if(de(t.toSQL))return Bt(t.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+k(t))}function EA(t){return t.replace(/\s*--.*?\n/g,"").split(";").map(e=>e.replace(/\s+/g," ").trim()).filter(M)}var DA=he?25:1e3,AA=l(()=>p("DbRequest")),Rm=class{constructor(e,r){this.db=e;this.tableName=r;this.cachedStatements=new ke(256)}qb(){return eo(this.tableName)}prep(e,r,i=!1){let o=Zf(r);try{let n=this.cachedStatements.getOrSet((i===!0?"pluck:":"")+o.sql,()=>{let s=e.prepare(o.sql);return i===!0?s.pluck():s});return n.database.open?{sq:o,stmt:n}:(this.cachedStatements.clear(),this.prep(e,r,i))}catch(n){return AA().throw("prep() failed",{error:n,sqlQuery:o,retriable:!1})}}async wrap({q:e,pluck:r,m:i}){try{return await er(this.db(),o=>{let{sq:n,stmt:s}=this.prep(o,e,r),a=s[i].bind(s);return n.bindings==null?a():a(n.bindings)})}catch(o){if(String(o.message).includes("AdvisoryLock"))throw o;AA().throw(o,b({method:i},Zf(e)))}}run(e){return this.wrap({q:e,m:"run"})}async runScript(e,r=""){let i=Px("runScript()");for(let o of e){if(T(o)||o.trim().startsWith("--"))continue;await this.run({sql:o});let n=dl(Yt(o,60),r,"");i.elapsed(n)}}mapRun(e){return er(this.db(),r=>e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return Z(o.bindings,s=>n.run(s),()=>n.run())}))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}updateOrIgnore(e){let r=Zf(e(this.qb()));return r.sql=r.sql.replace(/update /i,"UPDATE OR IGNORE "),this.wrap({q:r,m:"run"})}first(e){return this.wrap({q:e,m:"get"})}firstf(e){return this.wrap({q:e(this.qb()),m:"get"})}mapAll(e){return er(this.db(),r=>ie(e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return Z(o.bindings,s=>n.all(s),()=>n.all())})))}all(e){return this.wrap({q:e,m:"all"})}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}async batched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(DA),m:"all"}),_(r)&&await e.onResults(r);while(_(r)&&!K())}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}async pluckBatched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(DA),pluck:!0,m:"all"}),_(r)&&await e.onResults(r);while(_(r))}};var Hg=class{constructor(e,r){this.model=e;this.db=r;this.columnNames=l(()=>ff(()=>this.db().pragma(`table_info(${this.tableName})`).map(e=>e.name)));this.logger=p(`ModelOps(${e.tableName})`),qg(e),this.dbl=new Rm(this.db,e.tableName)}get dbOpen(){return Z(this.db(),e=>e.open,()=>!1)}get tableName(){return this.model.tableName}query(){return this.model.query()}async toDbValued(e){let r=this.model.fromJSON(e),i=PA(r);return rt(i,...await this.columnNames())}run(e){return this.dbl.run(e)}fromJSON(e){return y(e,r=>this.model.fromJSON(r))}async fromJSONs(e){return(await Kn(e)).map(o=>this.model.fromJSON(o))}first(e){return this.fromJSON(this.dbl.first(e))}firstf(e){return this.first(e(this.query()))}all(e=this.query()){return this.fromJSONs(this.dbl.all(e))}allf(e){return this.all(e(this.query()))}findOne(e){return this.fromJSON(this.dbl.first(e))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e,r){return this.findOneBy(b(b({},r),{id:e}))}async findByIds(e){let r=await er(this.db(),async()=>ge(js(D(e).filter(N),u.dbBatchSelectSize.valueOrDefault),i=>this.dbl.all(this.query().whereIn("id",i))));return te(await this.fromJSONs(ie(r)),i=>e.indexOf(i.id))}findBy(e){return this.all(this.model.queryBy(e))}findWhereIn(e,r){return this.all(this.model.query().whereIn(e,r))}rows(e){return this.count(x(e,()=>this.model.query()))}count(e){return Pe(this.dbl.pluckFirst(e.count()),()=>0)}countf(e){return this.count(e(this.query()))}async insert(e){return er(this.model.db(),()=>ge(e,r=>this.insertOne(r)))}async upsertOne(e){return this.modelSupportsUpsert?(await this.upsert([e]))[0]:e.id==null?this.insertOne(e):this.updateOne(e)}async insertOne(e){if(e.id!=null)throw new Error("insert called for "+k(e)+Vt);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames()),o=await this.dbl.runf(s=>s.insert(i)),n=await Ks(U(o.lastInsertRowid),s=>this.findById(s),()=>{this.logger.throw("internal error: lastInsertedRowId was non-numeric",{runInfo:o})});return e instanceof this.model&&Ro(e,n),n}async updateOne(e){if(e.id==null)throw new Error("update called for "+k(e)+Vt);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames());return await this.dbl.runf(o=>o.where({id:e.id}).update(i)),r}get ucn(){return this.model.uniqueColumnName}get ucnFieldNames(){return x(this.ucn,"id").split(",")}get modelSupportsUpsert(){return this.ucn!=null&&this.ucn!=="id"}get ucnConstraint(){return`(${this.ucn})`}onConflictClause(e){let r=[...this.ucn.split(","),"id","createdAt"],i=e.filter(n=>!r.includes(n)).sort().map(n=>`${n}=excluded.${n}`).join(","),o=["ON CONFLICT",this.ucnConstraint];return T(i)?o.push("DO NOTHING"):o.push("DO UPDATE SET",i),o.join(" ")}async upsertDbJson(e){let r=this.query().insert(e).toSQL(),i=new Set;for(let n of e)for(let s of gt(n))i.add(s);let o={sql:`${r.sql} ${this.onConflictClause([...i.values()])}`,bindings:r.bindings};await this.run(o)}pickModelUcn(e){return rt(e,...this.ucnFieldNames)}async reload(e){return await ge(e,async r=>y(this.findOneBy(this.pickModelUcn(r)),i=>Ro(r,i))),e}async upsert(e,r=!1){if(this.modelSupportsUpsert){let i=await this.columnNames(),o=await er(this.db(),async()=>zw(D(e),u.dbBatchUpsertSize.valueOrDefault,async n=>{let s=n.map(a=>this.model.fromJSON(a));return s.forEach(a=>a.$beforeUpsert()),await this.upsertDbJson(s.map(a=>a.$toDbJSON(i))),s}));return r?o:this.reload(o)}else return er(this.db(),()=>ge(e,i=>this.upsertOne(i)))}async delete(e){return De(e.filter(N),r=>this.run(this.model.query().delete().whereIn("id",r)))}async batched(e){let r=u.dbBatchSelectSize.valueOrDefault,i,o;do i=await this.allf(n=>(n=e.qb(n),o!=null&&(n=n.andWhere("id",">",o)),n.orderBy("id","asc").limit(r))),_(i)&&(o=Math.max(...i.map(n=>n.id)),await e.onResults(i));while(_(i))}};var _o=class{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return this._logger==null&&(this._logger=p(this.tableName)),this._logger}static query(){return eo(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static ops(){return this._ops==null&&(this._ops=new Hg(this,this.db)),this._ops}static get dbl(){return this.ops().dbl}static async txOp(e){return er(this.db(),()=>e(this.ops()))}static async tx(e,r=!1){return er(this.db(),()=>e(this.dbl),r)}static rows(){return this.ops().rows()}static truncate(){if(nr)throw new Error("rejecting attempt to truncate in prod");return this.dbl.run("DELETE FROM "+this.tableName)}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return h(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${x(this.id,this[this.class().uniqueColumnName])})`}logger(){return p(h(this.valueOf()))}[LA.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return SA(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}$toShallowJSON(){return this.$_toJSON(I)}$toDbJSON(e){let r=this.$_toJSON(yb,!1);return M(e)?rt(r,...e):r}toJSON(){return this.$_toJSON(I)}$_toJSON(e,r=!0){let i=this.class();return Co(this,(o,n)=>{if(!(n==null||!Hr(n)))return mo(i.booleanFields,o)?[o,e(n)]:[o,n]},r?{$ctor:i.$ctor}:{})}upsert(e){return e!=null&&Ro(this,e),this.class().ops().upsertOne(this)}$beforeUpsert(){}async reload(){return y(this.class().ops().findById(this.id),e=>Ro(this,e))}delete(){return f(this.id,e=>this.class().ops().delete([e]))}};_o.schema="models",_o.db=vn;var hr=class extends _o{static touch(e){return De(D(e).filter(N),r=>this.dbl.runf(i=>i.whereIn("id",r).update("updatedAt",Date.now())))}toID(){return"updateCount"in this&&(this.updateCount=Ks(this.updateCount,e=>e,1)),Ka(this)}get createdAtDate(){return we(this.createdAt,e=>new Date(e))}get updatedAtDate(){return we(this.updatedAt,e=>new Date(e))}$beforeUpsert(){if(this.createdAt==null&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this){let e=this;e.updateCount=Ks(e.updateCount,r=>r+1,1)}}};function Ka(t){return f(t,e=>({id:e.id,v:ub(e.updateCount,0)}))}var ep=class extends hr{static ping(e="ping"){return ep.ops().upsertOne({name:e})}static async assertPing(e){let r=Date.now();try{if(ep.db()==null)throw new Error("db is undefined");let i=await this.ping(e);if(this.logger().debug("assertPing()",{heartbeat:i}),Math.abs(r-i.updatedAt)>20*S)throw new Error("Heartbeat.updatedAt wasn't updated")}catch(i){throw new le({cause:i,message:"Failed to write to the library database"})}}},_m=ep;_m.tableName="Heartbeat",_m.uniqueColumnName="name";var Gg=0;function FA(t=2*E){Gg=Date.now()+t}function IA(){Gg=0}function OA(){return Date.now()<=Gg}var Ja=p("LibraryHealthChecks"),Ss=l(()=>gB(),15*S);function Kg(){kA.unset(),Ss.unset()}function RA(){return Kg(),Ss.refresh()}B(()=>{u.libraryPath.addListener(Kg),Lw(RA),Fw(RA),Cu(Kg)});async function gB(){if(OA())return{ok:["Library health checks are paused"]};if(!u.libraryPath.hasValue()&&!jt())return{ok:["Library isn't set up yet"]};let t=Wr.instance();if(t==null)return jt()?{fail:["Missing library at "+u.libraryPath.value]}:{};if(t.isPendingSetup){t.ready.then(()=>Ss.unset());let a=Date.now()-t.start;return a<q?{ok:["Library is setting up..."]}:a<3*E?{warn:["Library is taking a long time to set up..."]}:{fail:["Library took too long time to set up."]}}else try{await t.ready}catch(a){return{fail:["Library setup failed: "+Qn(a)]}}let e=[],r=[],i=[],o=[],n=[],s=async a=>{try{return await a()}catch(m){n.push(m),Ja.warn("trap(): failed to run "+a.name+": "+ur(m)),o.push(Qn(m));return}};if(await s(()=>t.openedBy().throwIfUnavailable("(library health check)")),u.healthCheckExiftool.valueOrDefault&&await s(()=>FD()),u.healthCheckLibraryIsWritable.valueOrDefault&&await s(()=>kA().catch(a=>{throw new le({cause:a,message:"Cannot write to "+mm(),fatal:!0})})),O)try{let a=await Te.instance().version();T(a)&&o.push("PowerShell isn't working (can't get version).")}catch(a){n.push(a),o.push(`PowerShell isn't working (${Qn(a)}).`)}if(u.healthCheckFreeSpace.valueOrDefault||u.healthCheckVolumes.valueOrDefault){let a=await s(()=>Sr());if(R(a))o.push("Failed to scan system volumes."+ce);else if(u.healthCheckFreeSpace.valueOrDefault)for(let m of await t.requiredFiles())try{let c=await m.file();if(c==null)continue;if(c.clear(),m.isDir&&!await c.isDirectory())o.push(`${m.desc}, ${c}, is missing`+ce);else if(_(a)){let d=Th(a,c.nativePath);Ja.debug("checkDir()",{dir:c.nativePath,desc:m.desc,bestVolume:d,vols:a.map(w=>w.mountpoint)}),d==null?c.isUNC?r.push(`${m.desc}, ${c}: cannot be monitored for sufficient free space. Consider using a mapped network drive instead.`):o.push(`${m.desc}, ${c}, doesn't seem to have a mountpoint (?!)`):d.available<u.minDiskFreeGb.valueOrDefault*fo&&r.push(`Only ${Hn(d.available)} are available on ${d.mountpoint}.`)}}catch(c){n.push(c),o.push("Failed to check "+m.desc+": "+Qn(c))}}return R(o)&&R(r)&&e.push("Library and support directories are OK"),M(Nm.env.TEST_FAIL)&&o.unshift(...Nm.env.TEST_FAIL.split(",")),M(Nm.env.TEST_WARN)&&r.unshift(...Nm.env.TEST_WARN.split(",")),u.healthCheckDb.valueOrDefault&&await s(()=>_m.assertPing()),o.map(a=>Y(a+Gn)),sf({ok:e,warn:r,bad:i,fail:o},yA())}var kA=l(async()=>yB(mm()),Pt);async function yB(t){if(t==null)return Ja.throw("copyExampleImageToLibraryDir(): undefined rootDir");let e=D(await ae.for(Rr.Public()).join("images").children()).find(o=>o.name.startsWith("splash"));if(e==null)return Ja.throw("copyExampleImageToLibraryDir(): missing validation image");t=ae.for(t);let r=t.join(".tmp-"+pl(6)),i=r.join("write-test"+e.ext);try{await e.copyFile_(i);let o=await e.sha(),n=await i.sha();if(o!==n)return Ja.throw("Failed to copy sample file to library. Is "+t+" writable?",{ignorable:!0});Ja.debug(`Library root directory, ${t}, is writable`)}finally{await r.rmrf("debug")}}var bB=l(()=>p("RpcServiceHandlers")),_A=l(()=>({libraryPath:()=>u.libraryPath.value,healthChecks:()=>Ss(),isVacuuming:()=>bB().tap({msg:"isVacuuming",result:dm()}),mountpoints:()=>dt(),volumes:()=>Sr(),paused:()=>Ti()}));var NA=l(()=>p("RpcServer")),tp=l(async()=>{if(!await an())return;NA().info("Setting up RPC...");let t=u.rpcPort.valueOrDefault,e=!0,r=new Cg(t,e);return r.addSimpleHandlers(_A()),await r.start(),NA().info("RPC service serving port "+r.port),r});var BA={broadcast:(t,e)=>ye(tp(),r=>r.broadcast(t,e),()=>y(cn(),r=>r.broadcast(t,e)))};var ZLe=`
SELECT
  al1.name,
  al1.lockId
FROM
  AdvisoryLock AS al1
  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name
  AND al1.createdAt > al2.createdAt
WHERE
  al2.createdAt IS NULL
`.replace(/\s+/," "),Jg=class extends _o{static vacuum(e=30*E){return this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async currentAcquiredLocks(){return this.dbl.pluckAllf(e=>e.select("name").where({acquired:1}))}static async allLocks(){return this.dbl.pluckAllf(e=>e.select("name"))}static async withLocks({lockNames:e,f:r,timeoutMs:i}){let o=Date.now(),n={},s=hf();this.logger().debug("withLocks()",{lockNames:e,lockId:s});let a=n.locks=e.map(c=>({name:c,lockId:s,acquired:0,createdAt:Date.now()}));await this.tx(c=>c.runf(d=>d.insert(a)));let m=l(()=>this.logger().warn("long wait time for",e));try{let c=await Ve(async()=>{let d=!0,w=await this.tx(P=>P.runf(A=>A.where({lockId:s}).update({acquired:1})),d);return w==null&&!Nc(o,5*S)&&m(),w!=null},{timeoutMs:i,timeBetweenMs:ir(5,500)});if(this.logger().info("withLocks()",{lockNames:e,acquired:c}),c){n.acquireMs=Date.now()-o;let d=await ri(async()=>r(s));n.result=d.result,n.runMs=d.elapsedMs}}finally{let c=await ri(()=>Jg.tx(d=>d.runf(w=>w.where({lockId:s}).delete())));n.releaseMs=c.elapsedMs,n.released=!0}return n}},Sn=Jg;Sn.tableName="AdvisoryLock",Sn.uniqueColumnName="name,lockId";var wB=(t,e)=>Sn.withLocks({lockNames:t,f:e,timeoutMs:E}).then(r=>r.result),CA={withAdvisoryLocks:wB};function VA(t,e){return t.map((r,i)=>r*e[i])}function zA(t,e){return t.map((r,i)=>{if(r.length!==e.length)throw new Error("misshaped matrix on row "+i);return qo(r.map((o,n)=>o*e[n]))})}var xB=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]];function rp(t){return vB(TB(t))}function SB(t){return[t[0],t[1],t[2]].map(e=>ee(0,255,e))}function TB(t){let e=SB(t).map(r=>r/255).map(r=>r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92);return zA(xB,e)}var $g={X:.95047,Y:1,Z:1.08883},MB=216/24389,PB=24389/27;function vB(t){let[e,r,i]=VA(t,[1/$g.X,1/$g.Y,1/$g.Z]).map(o=>o>MB?Math.pow(o,1/3):(PB*o+16)/116);return[116*r-16,500*(e-r),200*(r-i)]}function Bm(t,e){return Kf({dims:[{value:t[0],min:0,max:100},{value:t[1],min:-80,max:80},{value:t[2],min:-80,max:80}],bitDepth:e})}function UA(t,e){return Tg(t,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:e})}var ip=require("sharp"),Cm=12,Mn=7;var EB=p("ImageHash"),DB=250,$a=new ke(DB);W(()=>$a.clear());Xt(t=>M(t)?$a.delete(t):$a.clear());Ys((t,e)=>f($a.get(t),r=>$a.getOrSet(e,()=>r)));var op=8,WA={width:96,height:96};function AB(t){return Ax(BigInt("0b0"+t.map(e=>e===1?1:0).join("")))}function LB(t){let e=[[],[],[]];for(let r=0;r<t.length;r+=3){let i=rp([t[r],t[r+1],t[r+2]]);e[0].push(i[0]),e[1].push(i[1]),e[2].push(i[2])}return e}function FB(t){let e=u.greyscaleColorThreshold.valueOrDefault;for(let r of t)if(Math.abs(r[1])>e||Math.abs(r[2])>e)return!1;return!0}function qA(t){return 1<2?ar(t):ar([ar(t),$p(t)])}async function IB(t){let e=p("ImageHash("+t+")");try{let i=await Ts(t,WA,!0);if(i==null){e.warn("Cannot build readable stream");return}if(await Si(t)==null){e.warn("Can't extract dimensions");return}let n=ip(i.nativePath).removeAlpha();i.isDescendantOf(await Dm())&&ci(await i.size(),2*Ce)&&(n=n.trim(4)),n=n.resize(b(b({},WA),{fit:ip.fit.fill,kernel:ip.kernel.lanczos3,fastShrinkOnLoad:!0,withoutEnlargement:!0}));let{data:s,info:a}=await n.raw().toBuffer({resolveWithObject:!0}),m=Nn(0,s.length,3,J=>rp([s[J],s[J+1],s[J+2]])),c=FB(m),d=Jp(m.map(J=>Bm(J,Cm)),Mn);if(!c&&u.includeSharpDominantColor.valueOrDefault){let J=await pt(`img.imageHash.stats ${t.ext.toUpperCase()}`,()=>n.stats()),Q=Bm(rp([J.dominant.r,J.dominant.g,J.dominant.b]),Cm);d=H([Q,...d]).slice(0,Mn)}let w=ip(s,{raw:b(b({},a),{channels:3})}).resize({width:op,height:op}),{data:P}=await w.raw().toBuffer({resolveWithObject:!0}),A=LB(P),V=c?[qA(A[0]),0,0]:be(3,J=>qA(A[J])),$t=(c?[A[0]]:A).map((J,Q)=>{let Qt=V[Q];return J.map(Dr=>Dr>=Qt?1:0)});if(c){let J=be(op*op,()=>0);$t.push(J,J)}return{meanHash:AB(ie($t)),isGreyscale:c,modes:d}}catch(r){e.warn("Failed to imageHash("+t.nativePath+")",r);return}}async function jA(t){return $a.getOrSet(t.nativePath,()=>ri(()=>pt(`img.imageHash${t.ext.toUpperCase()}`,()=>IB(t))).then(({elapsedMs:e,result:r})=>EB.tap({level:wa(e,4*S),msg:"imageHash()",result:r,meta:{file:t.nativePath,elapsedMs:e}})))}var to=l(()=>p("Migrations")),OB=new RegExp(`^(${yi(ni)}://.*?/)(.*)$`),kB=t=>C(t).filter(St).flatMap(e=>OB.exec(e)).map(e=>e[1].toLowerCase()+e[2]).getOrElse(()=>t);function RB(t,e=Cm){return bD(t,e).map(r=>UA(r,e))}function _B(t,e){return we(t,()=>f(RB(t,6)[e],r=>Bm(r,Cm)))}function NB(t){return t.endsWith(ko)?t:t+ko}function HA(t,e){R(e)&&to().warn("mergeTags(): empty tagIds",{tagIds:e});function r(w){return t.prepare(w).run()}let i=new Map(t.prepare("SELECT id, _path FROM Tag WHERE id IN ("+e.join(",")+")").all().map(({id:w,_path:P})=>[w,P])),o=te(e.map(w=>{let P=i.get(w);return{id:w,path:P,base:eA(P)}}),w=>[w.base,w.path]);o.reverse(),to().info("mergeTags()",{arr:o});let n=o[0],s=n.id;if(R(o)||!N(s)){to().warn("mergeTags(): empty array, or missing winner",{arr:o,winner:n,winnerId:s});return}let a=o.slice(1);if(_(a)){let w=a.map(P=>P.id).join(",");r(`UPDATE OR IGNORE AssetTag SET tagId = ${s} WHERE tagId in (${w})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${w})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${w})`),r(`DELETE FROM AssetTag WHERE tagId in (${w})`),r(`DELETE FROM Tag WHERE id in (${w})`)}let m=t.prepare("select _path from Tag where id = :id").get({id:s})._path,c=Tn(m),d=t.prepare("SELECT id, _path FROM Tag WHERE id = :winnerId OR _path LIKE :like COLLATE NOCASE").all({winnerId:s,like:Mt(m,ko)+"%",winnerPath:m});for(let w of d){let P=zr([...c,...Tn(Lu(w._path,m))]);w._path!==P&&(to().info("mergeTags(): repairing tag path",{ea:w,newPath:P}),t.prepare("UPDATE OR IGNORE Tag SET _path = :path, updatedAt = :updatedAt WHERE id = :id").run({id:w.id,updatedAt:Date.now(),path:P}))}return to().tap({msg:"mergeTags()",level:"info",result:{winner:n,losers:a},meta:{tagIds:e,winnerPath:m}})}function GA(t){let e=t.prepare(["SELECT","rtrim(_path, char(31)) as path,","count(*) AS cnt,","group_concat(id) AS ids","FROM Tag","GROUP BY path","COLLATE NOCASE","HAVING cnt > 1"].join(" ")).all();for(let r of e)r.ids=L(h(r.ids).split(",").map(i=>U(i)));return _n(e,r=>r.path).reverse(),to().tap({msg:"dedupeTags()",result:e.map(r=>HA(t,r.ids)),meta:{rows:e}})}var Qg={lowercase_psnet_hostname:t=>{t.function("lowercase_psnet_hostname",{deterministic:!0},kB),t.transaction(()=>{t.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),t.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),t.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")})()},force_stable_channel:async()=>{try{await si();let t=u.updateChannel.value;t!=="stable"&&(u.updateChannel.value="stable",await rf(),to().info("force_stable_channel(): reset updateChannel",{priorValue:t}))}catch(t){to().error("force_stable_channel(): failed: "+t)}},numeric_captured_at:t=>{t.function("isoToLocal",{deterministic:!0},QM),t.function("isoToOffsetMinutes",{deterministic:!0},Uh),t.function("isoToPrecisionMs",{deterministic:!0},YM),t.transaction(()=>{t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),t.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),t.exec("DROP INDEX asset_captured_at_geohash_idx"),t.exec("DROP INDEX assetfile_exifuid_idx"),t.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")})()},spread_modes:t=>{t.function("plucklabmodeb6",{deterministic:!0},_B),t.transaction(()=>{be(Mn,e=>t.exec(`ALTER TABLE AssetFile ADD COLUMN mode${e} integer`)),t.exec("UPDATE AssetFile SET "+be(Mn,e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`).join(", "))})()},normalize_asset_file_uris:t=>{t.function("normalizeURI",{deterministic:!0},vS),t.transaction(()=>{let e=t.prepare("SELECT normalizeURI(uri) AS nuri, count(*) AS cnt, GROUP_CONCAT(id) AS ids FROM AssetFile GROUP BY nuri HAVING cnt > 1").all(),r=[];for(let i of e){let o=h(i.ids).split(","),n=t.prepare("SELECT id, shown, version, updatedAt FROM AssetFile WHERE id in ("+o.join(",")+")").all(),s=Dt(n,m=>[m.shown,m.version,m.updatedAt]),a=n.filter(m=>m.id!==s.id);r.push(...a.map(m=>m.id))}for(let i of js(r,256))t.exec("DELETE FROM AssetFile WHERE id in ("+i.join(",")+")");t.exec("UPDATE AssetFile SET uri = normalizeURI(uri)")})()},dedupe_tag_paths:t=>{t.transaction(()=>GA(t))()},suffix_tag_paths:t=>(t.function("tag_path_suffix",{deterministic:!0},NB),t.transaction(()=>{GA(t),t.exec("UPDATE Tag SET _path = tag_path_suffix(_path)")})()),normalize_tag_paths:t=>{let e=t.prepare("SELECT id, _path FROM Tag WHERE _path LIKE '%' || char(31) || char(31) || '%'").all();to().info("normalize_tag_paths():",{badTags:e});for(let r of e){let i=tA(r._path);HA(t,L([r.id,...t.prepare("SELECT id FROM Tag WHERE _path = ?").pluck().all(i)]))}},drop_tc_tables:t=>{let e=/^(ct|taf|tag_counts)_[a-z0-9]{6}$/i,r=t.prepare("SELECT name FROM sqlite_master WHERE type='table'").pluck().all(),i=r.filter(o=>e.exec(o)!=null);to().info("drop_tc_tables()",{tables:r,victims:i});for(let o of i)t.exec("DROP TABLE "+o)}};var BB=`
CREATE TABLE IF NOT EXISTS migrations (
  id integer NOT NULL PRIMARY KEY, 
  name varchar(255) NOT NULL, 
  migration_time integer NOT NULL 
)
`;function CB(t){return t.name.includes("_nofk")}var Yg=class{constructor(e,r,i){this.migrationsDir=e;this.db=r;this.fsMigrations=l(()=>this.migrationsDir.children(e=>e.ext===".sql"));this.migrationsInDatabase=l(()=>this.db.prepare("SELECT name from migrations").pluck().all());this.assertKnownMigrations=l(()=>{if(!yo)return;let e=this.migrationsInDatabase().filter(r=>{let[i,o,n]=[r.slice(0,4),r.slice(4,6),r.slice(6,8)].map(a=>U(a)),s=new Date(i,o-1,n);return this.logger.debug("migration filter",{migrationName:r,migrationDate:s,gitDate:wd}),wd.getTime()<s.getTime()});if(_(e))throw new le({fatal:!0,doNotSend:!0,message:"PhotoStructure is not forward-compatible with newer libraries. Please upgrade to open this library",cause:new Error("Unknown migrations: "+e.join(","))})});this.logger=p("Migration("+k({schema:e.base,db:i.nativePath})+")"),r.exec(BB),this.addMigrationStmt=r.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}async apply(e){this.assertKnownMigrations();let r=await this.fsMigrations();if(r==null)throw new Error("no migration files found for "+this.migrationsDir);let i=[],o=this.migrationsInDatabase();for(let n of r)o.includes(n.name)?this.logger.debug("latest(): already applied "+n.base):(await f(e,s=>s(n)),await Ae(this.applyMigration(n),5*E,()=>{throw new le({fatal:!0,ignorable:!1,message:"Migration "+n.name+" timed out."})}),i.push(n.base));return this.logger.info("up to latest!",{appliedMigrations:i}),i}async applyMigration(e){Bu(e.name);try{let r=Date.now(),i=(await e.readLines()).filter(s=>T(s)||s.trim().startsWith("--")),o=Qg[e.name.replace(/^[\d_-]+/,"")],n=de(o);if(R(i)&&n)throw new le({message:"empty migration "+e.name,fatal:!0});return n?await o.bind(Qg)(this.db):await this.applySqlMigration(e),this.logger.debug("applyMigration() completed",{elapsedMs:Date.now()-r,codeMigration:n,migration:e.baseWithParent}),this.db.transaction(()=>{this.addMigrationStmt.run(e.name,Date.now())})()}catch(r){return this.logger.throw("Failed to apply migration "+e.baseWithParent,ur(r))}}async applySqlMigration(e){let r=CB(e);try{let i=h(await e.readFile());if(T(i)){this.logger.error("Empty migration: "+e);return}r&&this.db.pragma("foreign_keys = OFF");for(let o of G(i.split(";")))try{this.db.exec(o)}catch(n){throw new le({cause:n,fatal:!0,message:`Failed to apply: ${o}`})}if(r){let o=this.db.pragma("foreign_key_check");if(_(o))throw this.logger.error("foreign_key_check failed",o),new Error("Foreign key checks failed during migration "+e.name)}}finally{r&&this.db.pragma("foreign_keys = ON")}}};var Zg=v(require("path"));var Xg=v(require("fs-extra"));function np(t){try{return C(t).filter(M).flatMap(Xg.statSync).flatMap(e=>Number(e.size)).get()}catch{return}}var VB=require("better-sqlite3");function Vm(t,e=u.dbTimeoutMs.valueOrDefault){let r;if(u.logSql.valueOrDefault){let i=p("SQLite("+t.split(Zg.sep).slice(-2).join(Zg.sep)+")"),o=rv();r=n=>i.log(o,n.replace(/\s{2,}/g," "))}return f(np(t),i=>{u.dbCacheSizeMb.tmpValue=Math.max(u.dbCacheSizeMb.valueOrDefault,Math.ceil(1.1*i/_i)),p("mkdb("+t+")").info("Dynamically setting dbCacheSize to "+u.dbCacheSizeMb.value,{dbFileSize:i})}),zB(new VB(t,{fileMustExist:!1,readonly:!1,timeout:e,verbose:r}))}function zB(t){let e=['encoding = "UTF-8"',"threads = "+ee(1,4,lt()),"foreign_keys = ON","page_size = "+16*td,"trusted_schema = 0","cache_size = -"+u.dbCacheSizeMb.valueOrDefault*_i/1024,"locking_mode = NORMAL","journal_mode = WAL","busy_timeout = "+u.dbTimeoutMs.valueOrDefault,"synchronous = NORMAL","auto_vacuum = NONE"];return ff(()=>{for(let r of e)t.pragma(r)}),t}var KA=["-wal","-journal"];var qIe=l(()=>p("SQLiteFiles"));function Qa(t){return[t,...KA.map(e=>t.sibling(t.base+e))].filter(e=>e.clear().existsSync())}function JA(t,e,r=u.dbTimeoutMs.valueOrDefault){let i=Vm(h(t),r);try{return e(i)}finally{i.close()}}async function $A(t,e,r=u.dbTimeoutMs.valueOrDefault){let i=Vm(h(t),r);try{return await e(i)}finally{i.close()}}var hOe=require("better-sqlite3"),Pn=p("SQLite");async function QA(t,e){try{await e.parent().mkdirp_();let r=new Xo({path:h(t),op:"Backing up"},100);await $A(t,i=>i.backup(h(e),{progress({totalPages:o,remainingPages:n}){return r.onProgress((o-n)/o*100),100}}),q)}catch(r){throw new le({cause:r,fatal:!0,message:`Could not back up db ${t} -> ${e}`})}}var UB=[{integrity_check:"ok"}];function YA(t){try{let e=t.pragma("integrity_check");if(oo(e,UB))return Pn.info("verifyDb("+t.name+"): OK"),!0;throw new Error(k(e))}catch(e){throw new le({cause:e,fatal:!0,retriable:!1,message:"verifyDb("+t.name+") failed"})}}function XA(t){try{return YA(t)}catch{return!1}}function ey(t){return JA(t,YA,q)}var ZA=["wal_checkpoint(RESTART)","optimize"];function e0(t){Pn.warn("optimizeDb() starting...",t.name);for(let e of ZA)t.pragma(e);Pn.warn("optimizeDb() finished.")}async function t0(t,e="recover",r=!0){let o=(await t.parent().join(e).mkdirpSync_()).join(t.base);Pn.info(`repairDbFile_(${t} -> ${o})`);try{let n=await sP(),s=3*Ce+await t.size()*1.25,a=10*s,m=new Xo({path:h(t),op:"Repairing db"},s),c=new Ot,d=tn(n,[t.nativePath,"."+e],5*E,{encoding:"buffer",maxBuffer:a});d.stdout.on("error",A=>Y("sqlite "+e+" failed for "+t,new le({cause:A,fatal:r})));let w=tn(n,[o.nativePath],5*E,{encoding:"buffer",maxBuffer:a});w.on("exit",()=>c.resolve()),d.stdout.on("end",()=>{w.stdin.end(ZA.map(A=>"PRAGMA "+A+";").join(`
`))}),d.stdout.on("data",A=>{let V=A.length;m.incrProgress(V),w.stdin.write(A)}),await c,await ey(o),Pn.info(`repairDbFile_(): ${o} is valid, finishing repair.`);let P=await ge(Qa(t),A=>A.renameYMDHMS_("needed-repair"));return await ge(Qa(o),A=>A.mv_(t.parent())),P.find(A=>A.ext===".db"||A.ext.startsWith(".sqlite"))}catch(n){return Pn.throw("failed to recover DB via dump and restore. Please see <https://photostructure.com/faq/restore-db-from-backup/> "+ce,n)}}async function r0(t){if(await t.notExists())return;let e=await t.parent().join("version-backup").mkdirp(),r=await e?.childWithSameContents(t);if(e==null||r!=null)return r;let i=e.join(_v()+"-"+t.base);return await ty(t,i),i}async function ty(t,e){Pn.info("coldDbBackup(): copying "+t+" to "+e);let r=Qa(t).filter(i=>!i.eql(t));await t.copyFile_(e),await ge(r,i=>i.copyFile_(e)).catch(i=>Pn.warn("Failed to copy aux db files",i))}var zm=class extends ze{constructor(e,r,i=()=>{}){super("Db("+e+")",()=>this.closeDb(),oe.db);this.schema=e;this._dataDir=r;this._onMigration=i;this.endTimeoutMs=E;this.migrate=l(async()=>{let e=this.dbfile;if(this.db==null||e==null)throw new Error("Cannot migrate database: missing db");await this.maybeRepair();let r=l(async()=>(this._onMigration(),r0(e))),i=new Yg(ae.for(Rr.Migrations()).join(this.schema),this.db,e);return{appliedMigrations:await i.apply(r),migration:i}});this.onRetry=l(()=>this.closeDb(),u.maxBusyDbMs.valueOrDefault/4)}get datadir(){return x(this._dataDir,xt())}get dbfile(){return Ms(this.datadir,this.schema)}get open(){return this._db!=null&&this._db.open}get inTransaction(){return this.open&&this._db?.inTransaction===!0}prepare(e){return this.db.prepare(e)}pragma(e,r){return this.db.pragma(e,r)}get db(){let e=this._db==null;if(!this.open){this.logger.info("setting up new db connection to "+this.dbfile,{priorWasNull:e});try{this.dbfile.parent().mkdirpSync_(),this._db=Vm(this.dbfile.nativePath);let r=this._db.pragma("quick_check",{simple:!0});if(r!=="ok")throw new Error("Quick integrity check failed: "+r+ce)}catch(r){throw new le({cause:r,fatal:!0,message:"Failed to set up "+this.dbfile})}}return this._db}closeDb(){try{this._db?.open===!0&&(this.logger.info("closing db",this._db),this._db?.close())}catch(e){this.logger.warn("closeDb(): .close() failed",e)}this._db=void 0}async maybeRepair(){let e=!0;try{e=XA(this.db)}catch{e=!1}e||(this.logger.warn("maybeRepair(): database failed validation. Trying to restore with dump/load."),await this.repair_())}async vacuum(){await Bh(()=>this._vacuum())}async _vacuum(){try{await cf(()=>{e0(this.db),this.db.exec("VACUUM")},this.onRetry)}catch(e){this.logger.warn("vacuum(): vacuum failed, trying to recover by dump-load",e),await this.repair_()}}async repair_(){this.logger.warn("repair_(): Attemping restore of "+this.dbfile),this.closeDb(),await Bh(()=>t0(this.dbfile)),this.logger.info("repair_(): Database restoration was successful!")}};var ry=class{constructor(e,r,i,o=dh()){this.seq=e;this.set=r;this.name=i;this.stamp=o}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return this.fromBasename(e.base)}static fromBasename(e){return f(this.parseRe.exec(e),r=>new ry(parseInt(r[2],10),parseInt(r[3],10),r[4],r[1]))}},Um=ry;Um.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;var Ya=class{constructor(e,r,i){this.dir=e;this.sets=r;this.seq=i;this.mods=l(()=>be(this.sets,e=>Math.pow(2,e)).reverse())}static async for(e,r){return new Ya(e,r,x(await Ya.maxSeq(e),-1))}static async maxSeq(e){return lw([...D(await y(e.childNames(),r=>r.map(i=>Um.fromBasename(i)?.seq)))])}set(e){return this.sets-this.mods().findIndex(r=>e%r==0)}next(e){let r=++this.seq;return new Um(r,this.set(r),e)}async hanoiFiles(){let e=await this.dir.clear().childNames();return L(e?.map(r=>Um.fromBasename(r)))}async validHanoiFiles(e){let r=await Pe(e,()=>this.hanoiFiles()),i=Qp(r,n=>n.set),o=[];for(let n of i.keys())f(Dt(i.get(n),s=>s.seq),s=>o.push(s));return o}async staleHanoiFiles(e){let r=await Pe(e,()=>this.hanoiFiles()),o=(await this.validHanoiFiles(e)).map(n=>n.seq);return r.filter(n=>!o.includes(n.seq))}async staleFiles(){return this.staleHanoiFiles().then(e=>e.map(r=>r.toFile(this.dir)))}};var nke=1*Pt;var iy=class extends xi{constructor(e,r,i,o,n,s=()=>{},a=()=>{}){super({name:"DbBackup("+i+")",callback:()=>this.backup(),intervalMs:u.dbBackupIntervalMinutes.valueOrDefault*E,rank:oe.predb});this.db=e;this.isLockOwner=r;this.srcDbFile=i;this.backupsDir=o;this.replaceDir=n;this.beforeBackup=s;this.onBackupFinished=a;this.endTimeoutMs=E;this.mutex=new ut;this.hanoi=l(()=>Ya.for(this.backupsDir,u.dbBackupsCount.valueOrDefault));Cn()||this.onEnds.push(async()=>{await this.mutex.serial("DbBackup.end()",async()=>{Tr()&&Gi("Verifying & backing up "+e.dbfile+"..."),await this._backup(!0),Tr()&&Gi("PhotoStructure library db has been backed up to "+o+".")})})}backup(){return this.mutex.maybeRun("DbBackup.backup()",()=>this._backup())}async _backup(e=this.ended){if(!await this.isLockOwner()){this.logger.info("backup(): not lock owner, no-op.");return}if(!e&&!this.db.open){this.logger.warn("backup(): db is already closed.",this.db.name);return}if(await this.srcDbFile.clear().isEmpty()){this.logger.warn("backup(): db is missing.",this.srcDbFile.nativePath);return}try{this.logger.info("backup(): beforeBackup...",{srcDb:this.srcDbFile.nativePath,backupsDir:this.backupsDir.nativePath}),await this.beforeBackup(),e&&this.db.open&&(this.logger.info("backup(): closing db before backup..."),await this.db.closeDb());let r=this.srcDbFile.parent().join("backup",this.srcDbFile.base);this.logger.info("backup(): starting backup to "+r),await QA(this.srcDbFile,r),this.logger.info("backup(): backup taken. Verifying "+r),await ey(r),this.replaceDir!=null&&(this.logger.info("backup(): Copying to "+this.replaceDir),await ty(r,this.replaceDir));let i=await Qa(r),o=await this.hanoi(),s=o.next("").toFilename();this.logger.info("backup(): Rotating files to "+this.backupsDir.join(s));for(let a of i)await a.mv_(this.backupsDir.join(s+a.base),{overwrite:!0});for(let a of await o.staleFiles())this.logger.info("backup(): removing stale backup "+a),await a.unlink();this.logger.info("backup(): finished successfully"),await this.onBackupFinished()}catch(r){this.logger.throw(r,{from:"DbBackup._backup() failed",fatal:!0,srcDb:this.srcDbFile.nativePath})}}};var i0=l(async()=>{let t=Oo().join("local-db");return await t.join("README.txt").writeTxt_(`
This folder is only used when your library is on a remote filesystem.

You will corrupt your library if you remove this directory while PhotoStructure is
running.

If you have any questions, please visit <https://photostructure.com/support/>.`),t});var o0=v(require("fs-extra"));var n0=l(()=>p("StatsDbDir"));var WB="sync-state-";async function Xa(t=!0){let e=[];e.push(["Asset version",mn]),e.push(["Asset file version",So]),e.push(["Library path",u.libraryPath.value]);let r=Or(k(e),10,ic),i=Oo().join(WB+r);return t&&(await(0,o0.mkdirp)(i.nativePath),await i.join("README.txt").applyIfEmpty_(o=>o.writeTxt_(`This folder holds state for library synchronization of

${u.libraryPath.value}

If you delete or modify the contents of this directory, you will need to
restart PhotoStructure. The next sync will rescan all your drives.

If you have any questions, please visit <https://photostructure.com/support/>.

`+e.map(([n,s])=>`${n}: ${s}`).join(`
`)).catch(n=>{n0().warn("Failed to write README to "+i,n)})),n0().info("Set up statsDbDir dir "+i)),i}var oy=4,ny=8,s0=oy**ny;function a0(t,e,r){let[i,o,n,s,a]=qB(t),m=e,c=`(${i}*${m}*${m}+${o}*${m})%${r}`,d=`(${n}*${m}+${s})%${r}`;return`((${c})*(${d})+${a})%${r}`}var jB=[[353868013,472882027,479001599,517294153],[1012573,1230587,1355297,1572751],[756065159,812182027,899809343,989450477],[3959297,4514113,4823201,5133127],[573259391,666101999,694847533,746151647],[2275327,2770513,3073703,3511973],[173313197,182557181,203457869,222230231],[6054613,6189107,7752103,9852103]],l0=[1012573,1101689,1183811,1196089,1230587,1355297,1419641,1483733,1572751,2275327,2770513,3010349,3073703,3118691,3174823,3511973,3959297,4514113,4690451,4823201,5133127,5375327,6019889,6054613,6189107,7752103,7752103,9852103];function HB(t){return Md(oy,t,ny).map((r,i)=>jB[i][r])}var qB=Hc(t=>{let[e,r,i,o,n,s,a,m]=HB(t%s0),c=[e/r,i/o,n/s,a/m].map(d=>Ge(d,7));return c.push(l0[t%l0.length]),c},{maxSize:128,ttlMs:E});var sy=class{constructor(e){this.id=e}nextAssetBatch(e){let r={};return f(e,i=>r.capturedAtLt=i.getTime()),mh(`/tag-gallery/${this.id}`,r)}};var mi=class extends _o{$pk(){return[x(this.assetId,()=>f(this.asset,e=>e.id)),x(this.tagId,()=>f(this.tag,e=>e.id))].join(":")}static addTagsToAsset(e,r){let i=Fp(e);if(i==null){this.logger().warn("addTagsToAsset(): got null assetId");return}let o=L(r.map(Fp));if(R(o)){this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:r});return}let n="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+o.map(s=>`(${i},${s})`).join(",");return this.dbl.run(n)}static removeTagsFromAsset(e,r){r=L(r);let i=this.query().whereIn("tagId",r).andWhere({assetId:e}).delete();return this.dbl.run(i)}};mi.tableName="AssetTag",mi.uniqueColumnName="assetId,tagId";function sp(t){return{id:t.id,at:t.capturedAtLocal}}var ay=class{constructor(e,r,i,o){this.tags=e;this.before=r;this.after=i;this.limit=o;this.logger=()=>p("TaggedAssetStream("+this.toString()+")");this.logger().info("new",this.toJSON())}vacuum(){_n(this.before,e=>[-e.capturedAtLocal,-e.id]),Bb(this.before,this.limit),_n(this.after,e=>[-e.capturedAtLocal,-e.id]),Du(this.after,this.limit)}toString(){return this.tags.map(e=>e.path.join("/")).join(",")}valueOf(){return this.toString()}get length(){return D(this.before).length+D(this.after).length}leftPad(e){return[...be(this.limit-e.length,r=>({id:-(r+1),v:0})),...e]}rightPad(e){return[...e,...be(this.limit-e.length,r=>({id:-(r+this.limit+1),v:0}))]}toJSON(){return{tags:this.tags.map(e=>e.toString()),assetIdsAfter:this.after.map(sp),assetIdsBefore:this.before.map(sp)}}mergeWith(e){pu(this.tags,e.tags,r=>r.path),pu(this.before,e.before,r=>r.id),pu(this.after,e.after,r=>r.id),this.logger().debug("mergeWith() complete",{tas:e.toJSON(),tags:this.tags.map(r=>r.path),beforeIds:this.before.map(sp),afterIds:this.after.map(sp)})}async toApi(){return this.vacuum(),this.logger().tap({msg:"toApi()",result:{tags:await ge(this.tags,e=>e.toApiTag()),assetIdsAfter:this.leftPad(this.after.map(e=>e.toID())),assetIdsBefore:this.rightPad(this.before.map(e=>e.toID()))}})}streamCoeff(e){return this.logger().tap({msg:"streamCoeff",meta:{this:this.tags.map(r=>r.path),tas:e.tags.map(r=>r.path)},result:Ob([...this.before,...this.after],[...e.before,...e.after],r=>r.id)})}};function m0(t){let e=u.minStreamCorrPct.valueOrDefault/100,r=[],i=t.filter(o=>o.length>5);for(let o of i){let n=Dt(r,s=>mb(s.streamCoeff(o),e));n==null?r.push(o):n.mergeWith(o)}return r}function u0(t){return t.orderByRaw("COALESCE(ordinal, _path) COLLATE NOCASE")}W(()=>Fe.clear());async function c0(t){let e=await t;return e!=null&&Fe.cacheTag(e),e}var pe=class extends hr{constructor(){super(...arguments);this.urls=l(()=>new sy(this.id));this.displayPath=l(async()=>{let e=await this.getParent();return[...e==null?[]:await e?.displayPath(),this.displayName]});this.descendantIds=l(async()=>pe.dbl.pluckAll({sql:Fi("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT id ","FROM descendants","WHERE id <> :tagId"),bindings:{tagId:this.id}}),7*S);this.ancestorIds=l(async()=>this.parentId===0||this.parentId==null?[]:pe.dbl.pluckAll({sql:Fi(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT id","FROM Tag","WHERE Tag.id in ancestors","  AND Tag.id <> :tagId","ORDER BY _path DESC"].join(" ")),bindings:{tagId:this.id}}))}static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this.recentTagsByPath.clear(),this.tagById.clear()}static cacheTags(e){return e.map(r=>this.cacheTag(r))}static cacheTag(e){return e!=null&&this.recentTagsByPath.set(e._path,Promise.resolve(e)),e?.id!=null&&this.tagById.set(e.id,Promise.resolve(e)),e}static newTag(e){let r=new pe;r._path=zr(e);let i=e[e.length-1];return i!=null&&ou(i)&&(f(i.displayName,o=>r._displayName=o),f(i.ordinal,o=>r.ordinal=o),f(i.description,o=>r.description=o),f(i.releasedAt,o=>r.releasedAt=o)),r}static findByIdOrPath(e,r){return e===0?pe.root():N(e)?this.findById(e):this.findByPath(r)}static findById(e){return e===0?pe.root():pe.tagById.getOrSet(e,()=>c0(this.ops().findById(e)))}static async findByPath(e){let r=zr(e);return T(r)?pe.root():pe.recentTagsByPath.getOrSet(r,()=>y(this.ops().firstf(i=>i.where("_path","like",r)),i=>pe.cacheTag(i)))}static getPagedAssets(e,r){let i=new pe;return i.id=e,i.getPagedAssetIds(r)}static async findOrCreate(e){if(R(e))throw new Error("empty tagPath");let r=zr(e,"/"),i=await this.findByPath(e);if(this.logger().debug("_findOrCreate("+r+")",{prior:i}),i!=null)return i;let o=this.newTag(e),n=o.depth<=1?void 0:await this.findOrCreate(e.slice(0,-1));f(n,a=>o.parentId=a.id);let s=await c0(this.ops().upsertOne(o));return this.logger().debug("_findOrCreate("+r+") upserted",{newTag:o,result:s,parent:n}),s}clear(){return this.parent=void 0,this.root=void 0,this.children=void 0,this.ancestors=void 0,this.assets=void 0,this.relatedAssets=void 0,this.ancestorIds.unset(),this.descendantIds.unset(),this}siblingPath(e){return zr([...this.parentPath,e])}async changeName(e){return this.changePath(this.siblingPath(e))}maybeUpsertDisplayName(e){return T(e)||e===this._displayName?void 0:this.upsert({_displayName:e})}async changePath(e,r=!0){let i=this._path,o=await pe.findByPath(Tn(e));this.logger().info("changePath(): ",{priorPath:i,newPath:e,existingSibling:o});try{o==null?(await pe.tx(async()=>{await pe.dbl.runf(n=>n.where("_path","LIKE",i+"%").update({updatedAt:Date.now(),_path:eo.raw("REPLACE(_path, ?, ?)",[i,e])}))}),this._path=e):(e=o._path,this.logger().info("changePath(): replacing with sibling",e),await mi.dbl.updateOrIgnore(n=>n.where({tagId:this.id}).update({tagId:o.id})),await mi.dbl.runf(n=>n.where({tagId:this.id}).delete()),await ge(this.getChildren(),n=>n.changePath(zr([...o.path,n.name]),!1)),await pe.dbl.runf(n=>n.where({parentId:this.id}).update({parentId:o.id})),await this.delete())}finally{r&&pe.clear()}}get name(){let e=this.path;return e[e.length-1]}get path(){return Tn(this._path)}get displayName(){return M(this._displayName)?this._displayName:this.name}get isRoot(){return this.id===0}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}get sortBy(){return[this.ordinal==null?2**51:this.ordinal,this.path.map(e=>e.toLowerCase())]}$childrenQuery(){return u0(pe.query().where({parentId:this.id}))}$assetsQuery(){return Nt.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],f(this.parent,r=>r.setAncestors(e.slice(0,-1)))}async toApiPathElements(){return ge(this.getAncestorsAndSelf(),e=>({tagPath:e.path,displayName:e.displayName}))}async toApiTag(){return{tagId:this.id,tagPath:this.path,displayPath:await this.displayPath(),description:this.description,assetCount:this.assetCount,assetFileCount:this.assetFileCount}}toStringId(){return"Tag("+this.path.join("/")+")"}async getParent(){if(!this.isRoot)return this.parentId!=null&&this.parent==null?this.parent=await pe.findById(this.parentId):this.parent}async getPagedChildren(e){if(this.id===0){let o=x(e.offset,0),n=o+x(e.limit,this.children.length);return[...this.children].slice(o,n)}let r=this.$childrenQuery();we(e.offset,o=>{r.offset(o)}),we(e.limit,o=>void r.limit(o));let i=await pe.ops().all(r);for(let o of i)pe.cacheTag(o);return i}async getDescendants(){return pe.ops().all({sql:Fi("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN descendants","  AND Tag.id <> :tagId"),bindings:{tagId:this.id}})}async getChildrenCount(){return this.children!=null?this.children.length:pe.dbl.pluckFirstf(e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count())}async getChildren(){return this.children=await pe.ops().all(this.$childrenQuery()),this.children.forEach(e=>{e.parent=this}),this.children}link(){return"/tag/"+this.path.map(encodeURIComponent).join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}async getAncestors(){if(this.ancestors==null){let e=Vb(this.parentPath).map(o=>zr(o)),r=await Promise.all(e.map(o=>pe.recentTagsByPath.get(o)));if(r.every(o=>o!=null))return this.ancestors=r;let i=pe.query().whereIn("_path",e).orderBy("_path");this.ancestors=await pe.ops().all(i),pe.cacheTags(this.ancestors),this.parent=x(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}async getAncestorsAndSelf(){return[...await this.getAncestors(),this]}async _getAncestors(){return this.parentId===0||this.parentId==null?[]:pe.ops().all({sql:Fi(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN ancestors","  AND Tag.id <> :tagId","ORDER BY Tag._path DESC"].join(" ")),bindings:{tagId:this.id}})}getPagedAssetIds(e){let r=this.$assetsQuery().select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal"),i="desc";return Wo(e.capturedAtLt,o=>{r=r.where("capturedAtLocal","<",o)}),Wo(e.capturedAtGt,o=>{r=r.where("capturedAtLocal",">",o),i="asc"}),Wo(e.limit,o=>{r=r.limit(o)}),r=r.orderBy("capturedAtLocal",i),Nt.dbl.all(r)}getAssets(){let e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return Nt.ops().all(e)}async assetCountDesc(e){let r=this.assetCount;return(r==null||e==null||e.length===r||e.length===0?"":Zp(e.length)+" of ")+Nu(r,"asset")}$assetStreamQuery(e,r,i){let o=this.path[0]===Ue.When?Nt.shownUnhidden():this.$assetsQuery();return o=o.distinct().where("capturedAtLocal",i,e.capturedAtLocal).andWhereNot("Asset.id",e.id).limit(i==="="?r*2:r),i==="="?o.orderByRaw(`ABS(Asset.id-${e.id})`):o.orderBy([{column:"capturedAtLocal",order:i===">"?"asc":"desc"},"Asset.id"])}async getAssetStream(e,r){r=N(r)?r:KD;let[i,o,n]=await ge(["<","=",">"],s=>Nt.ops().all(this.$assetStreamQuery(e,r,s)));for(let s of o)s.id<e.id?i.push(s):n.push(s);return new ay([this],i,n.reverse(),r)}async getRelatedAssetIds(e,r=GD){let i=Math.max(256,await GB()),o=await mi.dbl.allf(n=>n.select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal").distinct().join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).andWhere("Asset.excluded",0).andWhere("Asset.hidden",0).orderByRaw(a0(e+x(this.id,0),"Asset.id",i)).limit(r));return this.logger().debug(this.path+": Found "+o.length+" related assets",o),o}get attrs(){return{href:this.link(),title:this.name}}},Fe=pe;Fe.tableName="Tag",Fe.uniqueColumnName="_path",Fe.recentTagsByPath=new ke(256),Fe.tagById=new ke(256,E),Fe.cmp=(e,r)=>Lt([x(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[x(r.ordinal,Number.MAX_SAFE_INTEGER),...r.path]),Fe.root=l(async()=>{let e=new pe;return e.id=0,e._path=ko,e.parentId=void 0,e.children=(await pe.roots()).filter(r=>!Uo(u.hiddenHomeTags.valueOrDefault,r.name)),e.ancestors=[],e.assetCount=await Nt.shownAssetCounts(),e.upsert=()=>{throw new Error("upsert not supported on root")},e},7*S),Fe._upsertDefaultRoots=l(()=>pe.ops().upsert(ZD.map(e=>({_path:zr([e.name]),ordinal:e.ordinal})))),Fe.roots=l(async()=>{await pe._upsertDefaultRoots();let e=await pe.ops().all(u0(pe.query().whereNull("parentId")));return e.forEach(r=>{r.parentId=void 0,r.ancestors=[],pe.cacheTag(r)}),e});var GB=l(()=>Nt.dbl.pluckFirstf(t=>t.count()),E);var KB=`'${Ue.When}' || char(31)`,JB=KB+" || '%' || char(31)",f0=JB+" || '%' || char(31)",$B=f0+" || '%' || char(31)",p0=l(()=>p("DateTagNormalizer"));async function QB(){return Fe.ops().allf(t=>t.whereNotNull("ordinal").andWhereRaw("_path LIKE "+f0+" AND _path NOT LIKE "+$B).limit(200*12))}async function d0(){await Fe.tx(async()=>ge(QB(),YB))}async function YB(t){let e=await we(t.ordinal,r=>Og(QD(r)));e==null?p0().warn("failed to fix tag (no monthTagRef)",{t}):e.name!==t.name&&(p0().info("Fixing month name",{tagRef:e,tag:t}),await t.changeName(e.name)),await t.maybeUpsertDisplayName(e?.displayName)}var h0=v(require("os")),g0=v(require("process"));var Wm=Me("rebuildLibrary","forceRestartSync","enqueueAssetFileUpdates","enqueueAssetUpdates","applyNewTagger"),ly=class extends hr{static incomplete(){return this.ops().allf(e=>e.whereIn("id",r=>r.table(ly.tableName).min("id").whereNull("completedAt")))}static async getFirstPendingOp(e){return this.logger().tap({msg:"getFirstPendingOp",level:"info",result:await this.ops().firstf(r=>{let i=r.whereNull("completedAt").orderBy("createdAt","asc");return e!=null?i.andWhere(e):i}),meta:{pojo:e}})}static markOpCompleted(e){return T(e?.name)?this.logger().throw("markOpCompleted(): bad query",{query:e}):this.dbl.runf(r=>r.whereNull("completedAt").andWhere(e).update({completedAt:Date.now()}))}static async applyOnce(e,r,i=Lr){let o=await this.ops().firstf(a=>i(a.whereNotNull("completedAt").andWhere(e)));if(o!=null){this.logger().info("applyOnce(): already done",{prior:o});return}let n=await this.ops().insertOne(e),s=await r(n);return K()||await n.upsert({completedAt:Date.now()}),s}},Ps=ly;Ps.tableName="Operation",Ps.uniqueColumnName="id";var GRe=Me("lastScannedDirectory","scannedDirectoryCount","completedDirectoryScan","enqueuedStaleFiles","processedImageCount","processedVideoCount"),En=class extends hr{};En.tableName="ProgressMeta",En.uniqueColumnName="progressId,name";var c_e=l(()=>S*(lt()<=3?3:1.5)),XB=Fi(`
SELECT
  p1.uri as uri,
  p1.lastUpdatedAt as lastUpdatedAt,
  p1.lastCompletedAt as lastCompletedAt,
  min(p2.createdAt) AS lastStartedAt
FROM
  (
    SELECT
      uri,
      max(updatedAt) AS lastUpdatedAt,
      max(completedAt) AS lastCompletedAt
    FROM
      Progress
    WHERE
      createdAt > :minCreatedAt
    GROUP BY
      uri
  ) AS p1
  JOIN Progress AS p2
    ON 
      p2.uri = p1.uri AND 
      p2.createdAt > :minCreatedAt AND
      (p2.createdAt > ifnull(p1.lastCompletedAt, 0) OR p2.completedAt = lastCompletedAt)
GROUP BY
  1,2,3
`),ZB=Fi(`
SELECT
  *
FROM
  ProgressMeta
WHERE
  id IN (
    SELECT
      max(pm.id)
    FROM
      ProgressMeta pm
      JOIN Progress p ON pm.progressId = p.id
      AND p.createdAt > :minCreatedAt
    WHERE
      p.uri = :uri
      AND p.hostname = :hostname
    GROUP BY
      p.uri,
      pm.name
  )
`),lp=class extends hr{static async vacuum(e=90*ht){await En.dbl.runf(r=>r.whereIn("progressId",i=>i.table("Progress").select("id").where("createdAt","<=",Date.now()-e)).delete()),await this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async minCreatedAt(){let e=await Ps.getFirstPendingOp({name:Wm.forceRestartSync});return lp.logger().tap({msg:"minCreatedAt",level:"info",result:x(e?.createdAt,0),meta:{op:e}})}static async times(){let e=await this.minCreatedAt();return this.dbl.all({sql:XB,bindings:{minCreatedAt:e}})}static async saveSyncState(e){return ge(D(await e.progress()),r=>(r.state==="done"&&r.completedAt==null&&(this.logger().warn("caller saved done sync state without setting completedAt",ec()),r.completedAt=Date.now()),r.id==null?this.logger().throw(e.name+" returned an unsaved Progress",r):r.upsert()))}static async insertNew(e,r){return this.ops().insertOne({uri:e,volume:r,pid:g0.pid,hostname:(0,h0.hostname)()})}toSyncState(){return{id:this.id,uri:this.uri,volume:this.volume,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return x(j(this.dekJSON,()=>G(JSON.parse(this.dekJSON))),()=>[])}set dek(e){this.dekJSON=k(G(e))}assignFromPojo(e){return Ro(this,e)}getThisMeta(){return En.ops().allf(e=>e.where({progressId:this.id}).orderBy("createdAt"))}async getMeta(){return En.ops().all({sql:ZB,bindings:{minCreatedAt:await lp.minCreatedAt(),uri:this.uri,hostname:this.hostname}})}setMeta(e,r){return En.ops().upsertOne({progressId:this.id,name:e,value:r})}async getMetaAsRecord(){return tt((await this.getMeta()).map(e=>[e.name,e.value]))}},ap=lp;ap.tableName="Progress";var Es=v(require("path"));var N_e=_e.lift(t=>t.isFile()),B_e=_e.lift(t=>t.isReadable());function qm(t){return _e.lift(async e=>ye(st(e,!1),t,()=>!1))}function y0(t){return qm(e=>Pu(...t.map(r=>e[r])))}var eC=_e.lift(async t=>{let e=await gs(t);if(e==null||!e.startsWith("image/")&&!e.startsWith("video/"))return!1;let r=e.startsWith("video/")?u.minVideoDimension.valueOrDefault:u.minImageDimension.valueOrDefault;return ye(qa(t),i=>kn(i.ImageWidth,r)&&kn(i.ImageHeight,r),()=>!1)}),tC=_e.lift(async t=>{let e=await gs(t);if(e==null)return!1;if(!e.startsWith("video/"))return!0;let r=await st(t,!1);return r==null?!1:kn(Ba(r),u.minVideoDurationSec.valueOrDefault)}),rC=y0(["MIMEType"]),iC=y0(["Make","Model"]),oC=qm(t=>U(t.Rating,{defaultValue:0})>=0),C_e=qm(t=>mo(["image/jpeg","image/png"],h(t.MIMEType))),nC=qm(t=>h(t.MIMEType).startsWith("image/")),sC=qm(t=>h(t.MIMEType).startsWith("video/")),aC=nC.and(iC).or(sC);async function lC(t){return!T(t)&&(Vf(t)||wn(t)||dr(t)&&await Em()||ws(t)&&await qf())}var mC=_e.lift(async t=>ye(gs(t.nativePath),lC,()=>!1)),my=_e.lift(async t=>!lm(t.nativePath)),b0=_e.lift(async t=>ct(ln(t))),w0=_e.lift(async t=>ye(t.size(),e=>Ie(u.minAssetFileSizeBytes.valueOrDefault,u.maxAssetFileSizeBytes.valueOrDefault,e),()=>!1)),V_e=_e.andLogged(p("fileFilterNoStat"),{exifExtFilter:Sf},{notHiddenCheap:my}),z_e=_e.andLogged(p("fileFilterCheap"),{exifExtFilter:Sf},{notHiddenCheap:my},{noMediaFilter:b0},{fileSizeFilter:w0}),uC=l(()=>L([{exifExtFilter:Sf},{fileSizeFilter:w0},{notHiddenCheap:my},{noMediaFilter:b0},{hasMimeType:rC},{supportedMimeTypeFilter:mC},u.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:aC}:void 0,{notRejected:oC},{minDimensionsFilter:eC},u.minVideoDurationSec.valueOrDefault>0?{minVideoDurationFilter:tC}:void 0])),x0=l(()=>_e.andLogged(p("fileFilterExpensive"),...uC())),U_e=_e.lift(async t=>T(t.ext)),W_e=_e.lift(async t=>t.isDirectory());function uy(t,e){for(let r of e){let i=t[r];if(M(i))return r+":"+h(i).trim()}}function T0(t){return uy(t,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"])}function v0(t){{let e=uy(t,["LensSerialNumber","LensID"]);if(e!=null)return e}return f(Jf(t),({lensMake:e,lensModel:r})=>`${e.toLowerCase()}/${r.toLowerCase()}`)}function S0(t){return uy(t,["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"])}var M0=[{ms:pb,s:"year",p:"years"},{ms:30.4*ht,s:"month",p:"months"},{ms:gu,s:"week",p:"weeks"},{ms:ht,s:"day",p:"days"},{ms:Pt,s:"hour",p:"hours"},{ms:E,s:"minute",p:"minutes"},{ms:S,s:"second",p:"seconds"}];function cy(t,e=2,r){if(!lu(t))return re(t)?"-"+cy(Math.abs(t),e):"";let i=M0.findIndex(s=>s.ms<=t);if(i===-1)return"";let o=t,n=L(M0.slice(i,i+e).map(s=>{if(!(s.ms>o)){let a=Math.floor(o/s.ms);return o-=a*s.ms,{i:a,s:Nu(a,s.s,s.p)}}}));return R(n)?"":n.map(s=>s.s).join(", ")+Z(r,s=>" "+(n[n.length-1].i!==1?s.singular:s.plural),"")}var SNe=l(()=>p("FilePathTagger"));function P0(t){let e=nm(t),r=e.scheme===ji?Xf:e.authority,i=e.path.split("/").slice(0,-1);return G([Ue.FS,r,...i])}var fy=class extends hr{constructor(){super(...arguments);this.posixFile=l(()=>ne.forUri(this.uri,this.mountpoint))}static async recentAssetIdsByUriRoot(e,r,i=64){let o=Date.now()-r,n=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",o).andWhere("Asset.shown",1).andWhere("Asset.hidden",0);return M(e)&&(n=n.andWhere("AssetFile.uri","like",e+"%")),n=n.orderBy("AssetFile.updatedAt","desc").limit(i),this.logger().debug("recentAssetIdsByUriRoot",n.toSQL()),this.dbl.pluckAll(n)}static assetCountByMimetype(e){let r=this.query().select(eo.raw("mimetype, count(*) as count")).join("Asset","Asset.id","AssetFile.assetId").where("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0);return M(e)&&(r=r.andWhere("uri","like",e+"%")),r=r.groupBy("mimetype").orderBy("mimetype"),this.dbl.all(r)}static async assetCountByMimetypeRoot(e){let r=await this.assetCountByMimetype(e);return or(H(r.map(o=>o.mimetype.split("/")[0]))).map(o=>({mimetypeRoot:o,count:mu(r,n=>n.mimetype.startsWith(o+"/")?n.count:0)}))}static children(e,r){let i=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${yi(e)}/[^/]+$}`);return this.ops().all(Z(r,o=>o(i),()=>i))}get capturedAtDateTime(){return Cc(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return JM(this.capturedAtDateTime,e)}static outdatedQuery(e){let r=this.query().where("version","<",So).orderBy("id");return R(e)?r:r.andWhere(i=>i.whereIn("mountpoint",e).orWhereNull("mountpoint"))}static async nextOutdated(e=Lr){return this.ops().findOne(e(this.outdatedQuery(await dt())))}static async outdatedCount(e=Lr){let r=this.outdatedQuery(await dt());return this.dbl.pluckFirst(e(r.count("id")))}static async setShown(e,r){if(this.logger().info("setShown()",{assetId:e,assetFileId:r}),!N(e)||!N(r))throw new Error("setShown(): invalid IDs: "+k({assetId:e,assetFileId:r}));await this.dbl.runf(n=>n.update("shown",0).where("assetId",e));let i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),o={assetId:e,assetFileId:r,updatedAt:Date.now()};return this.dbl.run({sql:i,bindings:o})}static async findByAsset(e,r){let i=this.query().select("AssetFile.*");return f(pi(e),o=>i.join("Asset","Asset.id","AssetFile.assetId").where(Co(o,(n,s)=>["Asset."+n,s]))),f(pi(r),o=>i.where(Co(o,(n,s)=>["AssetFile."+n,s]))),this.ops().all(i)}get modes(){return L(be(Mn,e=>this["mode"+e]))}set modes(e){be(Mn,r=>this["mode"+r]=e[r])}async matchesFile(e){if(this.version==null||this.version<So||u.forceSync.valueOrDefault)return!1;let r=await this.fileFields(e);return uw(r,this)}fileFields(e){return bt(e).orElse(()=>this.posixFile()).filter(r=>r.exists()).flatMap(async r=>({uri:await r.uri(),fileSize:await r.size(),mtime:await r.thisOrSidecareMaxMtimeMs()})).filter(Su).get()}isVersionUpToDate(){return Ei(this.version,So)}async siblingCount(){return fy.dbl.pluckFirstf(e=>e.count().where({assetId:this.assetId}).andWhereNot({id:this.id}))}async upsertIfNeeded(){let e=u.forceSync.valueOrDefault;if(await this.matchesFile()&&N(this.id)&&!e)return this.upsert();if(await this.isFileDeleted()){this.deleted=!0,await this.delete();return}if(!await this.notExists())return y(this.updateFromFile(),()=>this.upsert())}async maybeUpdateStats(e){return y(this.fileFields(e),r=>Js(this,r))}async updateFromFile(e){let r=Date.now(),i=this.logger().addContext(".updateFromFile()");if(i.debug("before",this),this.id!=null&&await this.matchesFile(e)){i.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");return}if(e!=null&&await this.setFile(e),e==null&&(e=await this.posixFile()),e==null||await e.notExists()){i.info("no-op, "+e+" is missing");return}if(this.mountpoint==null&&await y(e.mountpoint(),w=>this.mountpoint=w.nativePath),await this.maybeUpdateStats(e)==null){i.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});return}let o=e.sha(),n={},s=await Im(e);if(s==null){i.error("missing tags for "+e);return}if(T(s.MIMEType)){i.error("missing MIMEType for "+e);return}n.mimetype=s.MIMEType;let a=s.capturedAt,m=a.toLocal();if(m==null)return i.throw("bad CapturedAt",a);n.capturedAtLocal=m,n.capturedAtOffset=a.toOffset(),n.capturedAtPrecisionMs=a.toPrecisionMs(),n.capturedAtSrc=a.src,f(s.exposureSettings,w=>{n.focalLength=w.focalLength,n.aperture=w.aperture,n.shutterSpeed=w.shutterSpeed,n.iso=w.iso});let c=s.dimensions;if(n.width=c.width,n.height=c.height,n.rotation=s.rotation,n.make=s.Make,n.model=s.Model,n.cameraId=T0(s),n.imageId=f(S0(s),h),n.lensId=v0(s),n.geohash=wD(s.GPSLatitude,s.GPSLongitude),n.durationMs=f(s.duration,w=>Math.round(w*1e3)),n.fps=f(Jr(s.VideoFrameRate),et),n.sha=await o,n.sha==null){i.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri});return}(u.useImageHashes.valueOrDefault||u.strictDeduping.valueOrDefault)&&await y(jA(e),w=>{n.meanHash=w.meanHash,n.modes=w.modes}),Js(this,n),this.version=So;let d=Date.now()-r;return i.log(d>S?"info":"debug","after ("+d+"ms)",this),this}async updateFromShaSibling(e){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:e.sha==null||!e.isVersionUpToDate()||this.sha!=null&&e.sha!==this.sha?this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e}):(Js(this,Bt(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt")),this)}async getAsset(){return this.assetId==null||this.asset!=null?this.asset:this.asset=await Nt.ops().findById(this.assetId)}async exists(){return ye(this.posixFile(),e=>e.exists(),()=>!1)}async notExists(){return ct(this.exists())}async isFileDeleted(){return ye(this.posixFile(),e=>e.isDeleted(this.uri),()=>!1)}async isFiltered(){return bt(this.posixFile()).filter(e=>e.exists()).flatMap(e=>x0().apply(e)).map(e=>!e).getOrElse(()=>!1)}async hasNoMedia(){return ye(this.posixFile(),e=>e.hasNoMedia(),()=>!1)}async setFile(e){let r=await e.uri();if(r==null)return this.logger().throw("setFile(): no URI for "+e);let i=await e.mountpoint();if(i==null)return this.logger().throw("setFile(): no mountpoint for "+e);if(this.uri!=null&&!await SS(r,this.uri))return this.logger().throw("setFile(): cannot reassign non-equivalent URI",{prior:this.uri,new:r,file:e.nativePath});if(await e.uriObject()==null)throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);return this.uri=r,this.mountpoint=i.nativePath,this.posixFile.set(Promise.resolve(e)),r}nativePath(){return y(this.posixFile(),e=>e.nativePath)}toCapturedAt(){return f(Cc(this.capturedAtLocal,this.capturedAtOffset),e=>y(this.posixFile(),r=>new Ga(r.nativePath,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}async downloadables(e,r){try{let i=await this.posixFile();if(i==null)return[];let o=e.ap(this.assetId),n=[];if(await i.isNonEmpty()&&n.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:_g(i,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:i.base,description:"Download original",details:`(${Cr(this)} ${i.ext})`}),this.isVideo||!(I(this.shown)||this.sha===r))return n;let a=L(await Promise.all([...await o.previews()].reverse().filter(m=>m.reducer===Ht.fit).map(m=>cA(i.base,m))));return n.push(...uo(a,m=>m.size)),n}catch(i){return Y("AssetFile.downloadables failed",i,{context:this}),[]}}async pathInfo(){try{let e=Ee.parse(this.uri),r=await ds(e,this.mountpoint);if(r==null){this.logger().warn("pathInfo(): failed to build nativePath",{uri:this.uri});return}let i=e.fsPath,o=sr(r,i).split(Es.sep),n=o.pop(),s=i.split(Es.sep),a=P0(e),m=await Fe.findByPath(a);if(m==null){this.logger().warn("pathInfo(): failed to find existing Tag",{tagPath:a});return}let c=await m.toApiPathElements();this.logger().info("pathInfo()",{uri:this.uri,fsPath:i,nativePath:r,mountpointParent:o,pathAfterMountpointParent:s,mountpointName:n,tag_path:m.path,pathElements:c}),c.shift(),T(n)?c.shift():c[0].displayName=n,s.splice(0,c.length);let d={nativePath:r,nativePathPrefixWbr:Yb(o.join(Es.sep)+Es.sep),pathElements:c,nativePathSuffix:s.join(Es.sep),pathSep:Es.sep,exists:await this.exists()};return this.logger().info("pathInfo()",{result:d}),d}catch(e){this.logger().warn("pathInfo(): failed",e);return}}async toApi(e,r){return y(this.pathInfo(),async i=>yl(b(b({assetId:this.assetId,assetFileId:this.id},i),{mimetype:this.mimetype,shown:I(this.shown),width:this.width,height:this.height,rotation:x(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:await this.downloadables(e,r),createdAtLocale:E0(this.createdAt),updatedAtLocale:E0(this.updatedAt)})))}get isVideo(){return dr(this.mimetype)}},Kt=fy;Kt.tableName="AssetFile",Kt.uniqueColumnName="uri",Kt.booleanFields=["shown"];function E0(t){return f(t,e=>cy(Date.now()-e,1)+" ago")}var Ds=l(()=>p("TagSql")),py,dy=l(()=>new Rm(vn,"Tag")),mp=l(async()=>{if(nr&&Date.now()-Oi<20*S)return;await fC();let t=await dy().pluckFirst({sql:"SELECT MAX(rowid) FROM AssetTag"});Ds().info("updateTagCounts()",{newMax:t,lastMax:py}),t!==py&&(py=t,await pt("db.updateTagCounts",()=>cC()))},7*S);function pC(t=pl(6)){let e=`temp.ct_${t}`,r=`temp.taf_${t}`,i=`temp.tag_counts_${t}`;return EA(`
CREATE TABLE ${e} AS
SELECT
  DISTINCT t.id AS parentId,
  kid.id AS childId
FROM
  Tag t
  JOIN Tag kid ON kid._path LIKE (t._path || '%');

CREATE INDEX ${e}_idx ON ${e.replace(/^temp\./,"")}(parentId, childId);

CREATE TABLE ${r} AS
SELECT
  DISTINCT AssetTag.tagId as tagId,
  Asset.id AS assetId,
  AssetFile.id AS assetFileId
FROM
  AssetTag
  JOIN Asset ON AssetTag.assetId = Asset.id
  JOIN AssetFile ON AssetFile.assetId = Asset.id
WHERE
  Asset.hidden = 0
  AND Asset.excluded = 0
  AND Asset.shown = 1;

CREATE INDEX ${r}_idx ON ${r.replace(/^temp\./,"")}(tagId, assetId, assetFileId);

CREATE TABLE ${i} AS
SELECT
  parentId AS tagId,
  count(DISTINCT assetId) AS ac,
  count(DISTINCT assetFileId) AS afc
FROM
  ${e}
  JOIN ${r} ON childId = tagId
GROUP BY
  1;

CREATE INDEX ${i}_idx ON ${i.replace(/^temp\./,"")}(tagId, ac, afc);

-- Update used tags:

UPDATE Tag SET 
  assetCount = NULL,
  assetFileCount = NULL;

UPDATE Tag
SET
  assetCount = ac,
  assetFileCount = afc
FROM ${i}
WHERE tagId = id;

-- Clean up:

DROP INDEX IF EXISTS ${e}_idx;
DROP INDEX IF EXISTS ${r}_idx;
DROP INDEX IF EXISTS ${i}_idx;
DROP TABLE ${e};
DROP TABLE ${r};
DROP TABLE ${i};
`)}async function cC(){dy().db()==null&&Ds().throw("updateTagCounts(): modelDb is unset",{retriable:!1});try{let t=pl(6),e="_"+t,r=await da(dy().runScript(pC(t),e)),i=ee(7*S,5*E,r.elapsedMs*20);Ds().info("Updated tag counts",{elapsedMs:r.elapsedMs,newTTL:i}),mp.setTTL(i),await dC()}catch(t){Ds().warn("Failed to update tag counts",t)}}async function dC(t=Date.now()-10*E){let e=[-1];for(let r of so(0,5)){let i=await hC(t);if(R(i)||oo(e,i))return;e=i}}async function hC(t){let e=await Fe.dbl.pluckAllf(r=>r.select("Tag.id").leftOuterJoin("AssetTag","AssetTag.tagId","Tag.id").leftOuterJoin(eo.raw("Tag AS child ON child.parentId = Tag.id")).whereNull("AssetTag.assetId").andWhere(i=>i.whereNull("child.id")).andWhere(i=>i.whereNull("Tag.assetCount")).andWhere("Tag.createdAt","<",t).orderBy("Tag._path","asc"));Ds().debug("vacuumLeafTags()",{candidates:e});for(let r of e)try{await Fe.dbl.runf(i=>i.where({id:r}).delete())}catch(i){Ds().info("vacuumLeafTags(): failed to delete",{tagId:r,err:i})}return Ds().info("vacuumLeafTags() complete.",{candidates:e}),e}async function fC(){let t=p("updateTagMountpoints()"),e=await Fe.findByPath([Ue.FS]);if(e==null){t.info("No root filesystem tag");return}await e.maybeUpsertDisplayName(u.tagDisplayNameFS.valueOrDefault);let r=await Sr();if(r==null){t.warn("no-op: volumes() returned null");return}for(let i of await e.getChildren()){if(i.name===Xf){i.ordinal!==1&&await i.upsert({ordinal:1});continue}let o,n=r.find(s=>M(s.uuid)&&sm(s.uuid)===i.name);n!=null?o=Kr(n.label,n.mountpoint):o=await Kt.dbl.pluckFirstf(s=>s.select("mountpoint").where("uri","LIKE","psfile://"+i.name+"/%").limit(1)),o!=null?(await i.maybeUpsertDisplayName(o),t.info("updated tag",{id:i.id,path:i.path,displayName:o}),Fe.clear()):t.debug("cannot update tag: no current volume.",{id:i.id,path:i.path})}}var jm=class{constructor(e,r,i){this.dataDir=e;this.isLockOwner=r;this.localDbDir=i;this.endTimeoutMs=E;this.end=l(()=>f(this.backup.value,e=>e.end()));this.setup=l(async()=>{try{await this._setup(),this.logger.info("ModelDb reading from "+this.db.value?.dbfile)}catch(e){this.db.reject(e),this.backup.reject(e),this.logger.throw(e,{fatal:!0,from:"ModelDbJanitor.setup"})}});this.beforeBackup=async()=>{K()||!he&&Tr()&&await er(vn(),async()=>{await Sn.vacuum(),await ap.vacuum(),await mp()})};this.onBackupFinished=async()=>{!K()};this.onMigration=l(async()=>{this.logger.info("onMigration: removing prior stats db to clear prior work queues"),await y(Xa(!1),r=>r.rmrf("info"))});this.backupAndMigrate=async()=>Tr()||await this.isLockOwner();this.name="ModelDbJanitor("+e+")",this.logger=p(this.name),this.db=new mt(this.name+".db"),this.backup=new mt(this.name+".backup"),this.srcDbFile=Ms(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),dw(this),this.setup()}static async for(e,r,i=i0){let o=new jm(e,r,i);return await o.setup(),o}get ended(){return this.end.prior()!=null}async _setup(){if(u.forceLocalDbReplica.valueOrDefault||await y(Aa(this.srcDbFile.nativePath),r=>r.remote)===!0){let r=await this.localDbDir();return this.localDbReplica=Ms(r,"models"),this.logger.info("Library on remote drive. Using local db replica.",{src:this.srcDbFile.nativePath,local:this.localDbReplica}),await this.backupAndMigrate()&&(this.logger.info("Setting up local model db replica...."),await this.localDbReplica.parent().rmrf("info"),await this.srcDbFile.clear().exists()&&(await this.srcDbFile.copyFile_(this.localDbReplica),await this.localDbReplica.chmod(420)),this.logger.info("Local model db replica set up at "+this.localDbReplica)),this._finishSetup(r,this.srcDbFile.parent())}else return this._finishSetup(this.dataDir)}async _finishSetup(e,r){let i=await this.backupDir.mkdirp();if(i==null)throw new Error("Failed to create models DB backup dir "+this.backupDir);let o=new zm("models",e,this.onMigration),n=await this.backupAndMigrate();n?(await o.migrate(),this.backup.resolve(new iy(o,this.backupAndMigrate,o.dbfile,i,r,this.beforeBackup,this.onBackupFinished))):this.backup.resolve(void 0),TA(o),this.db.resolve(o),n&&(await d0(),await mp()),this.logger.info("Finished setup",{primaryDbDir:e,replaceDbDir:r,backupDir:i})}};var D0=l(()=>{Uv(Zl()?gC:void 0),sS(Zl()?yC:void 0)}),gC=async()=>await un()?f(cn(),t=>t.request("mountpoints")):void 0,yC=async()=>await un()?f(cn(),t=>t.request("volumes")):void 0;var A0;function L0(){return A0}function F0(t){A0=t}async function I0(t){let e=new zm("stats",t);return bv()&&(await e.migrate(),new xi({name:"statsDbJanitor vacuum",callback:()=>e.vacuum(),intervalMs:he?20*S:5*E,rank:oe.service})),F0(e),e}function bC(t){return t.toDateTime().toFormat(u.assetSubdirectoryDatestampFormat.valueOrDefault).split("/")}var hy=class{constructor(e,r){this.root=e;this.copyAssets=r;this.logger=p("AssetFileRepository")}directoryForDate(e){return this.root.join(...bC(e))}async importFile(e){let r=this.copyAssets();if(this.logger.debug("importFile()",{file:e,copyAssets:r}),!r||await Wa())return e;if(await e.isDescendantOf(this.root))return this.logger.debug("no-op: "+e+" already contained by "+this.root),e;this.logger.debug("importing "+e);let i=await Im(e);if(i==null)throw new Error(e.nativePath+" has no tags (so, no createdAt)");let o=f(i.capturedAt,w=>zh(w.date));if(o==null)throw new Error(e.nativePath+" has no capturedAt");if(o.year==null||o.month==null||o.day==null)return this.logger.warn("Insufficient capturedAt precision to copy "+e+" into library.",{capturedAt:i.capturedAt}),e;let n=this.directoryForDate(o);if(await n.mkdirp()==null)throw new Error("Cannot create destination directory, "+n.nativePath+" for "+e.nativePath);let s=await n.children(),a=await e.size(),m=await Il(s,w=>w.size().then(P=>P===a)),c=await e.sha();if(m.length>0){let w=await Il(m,P=>P.sha().then(A=>A===c));if(w.length>0){let P=w[0];return this.logger.info(e+" matches "+P),this.handleSidecars(e,P)}}let d=await n.join(e.base).ensureNew_();return this.logger.info("Copying...",{src:e.nativePath,dest:d.nativePath}),await e.copyFile_(d),this.handleSidecars(e,d)}async handleSidecars(e,r){let i=x(await e.sidecars(),[]);for(let o of i)await this.handleSidecar(o,r);return _(i)&&Fr(r.nativePath),r}async handleSidecar(e,r){for(let o of x(await r.sidecars(),[]))if(await RD(e,o)){this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:o,dest:r});return}let i=await r.parent().join(r.name+e.ext).ensureNew_({emptyIsNew:!0});return e.copyFile_(i)}};var Wr=class extends ze{constructor(e){super(`Library(${e})`,()=>this.onEnd(),oe.predb);this.start=Date.now();this._ready=new Ot;this.setup=l(async()=>{let e=()=>{if(this.ended||K())throw new Error};try{if(this.logger.debug("setup() started"),!jt()){if(!Ic())throw new Error("Cannot run "+qt()+" without a library"+ce+Yr);this.logger.warn("Library settings don't exist yet. Skipping setup.");return}await this.openedBy().throwIfUnavailable("(library setup)"),e(),await Zc(this.rootDir),await of(this.rootDir.nativePath);let r=this.originalsDir();if(r==null||await r.mkdirp()==null||!await r.isReadWritable())throw new Error(`Invalid value for ${u.originalsDir.key}: ${r} must be readable and writable.`);await this.statsDbDir(),await Dm(),e(),fM(BA),Zl()&&await un()&&(await SM(),D0()),e(),await this.modelDb(),e(),yv()&&await this.statsDb()}catch(r){!this.ended&&!K()&&(Y("Library.setup() failed"+(Fc()?"":ce),r),this._ready.reject(r))}finally{this._ready.pending&&(this.logger.info("Library.setup() finished."),this._ready.resolve())}});this.openedBy=l(()=>new kh(this.dataDir));this.statsDbDir=l(()=>Xa());this.previews=l(()=>new Bg(this.rootDir.join(u.previewsDir.valueOrDefault),CA));this.originalsDir=l(()=>mm(this.rootDir));this.assetFileRepository=l(()=>new hy(this.originalsDir(),()=>u.copyAssetsToLibrary.valueOrDefault));this.modelDbJanitor=l(async()=>jm.for(this.dataDir,()=>this.openedBy().isLockOwner()));this.modelDb=l(async()=>(await this.modelDbJanitor()).db.promise);this.statsDb=l(async()=>I0(await this.statsDbDir()));this.statsDbFile=l(()=>this.statsDb().then(e=>e.dbfile));this.onEnd=l(async()=>{for(let{ea:e,t:r}of[{ea:this.statsDb,t:q},{ea:this.modelDbJanitor,t:E},{ea:this.openedBy,t:q}])await f(await e.clear(),i=>mr(i,r));this.logger.info("onEnd(): finished.")});this.rootDir=ne.for(e),this.dataDir=xt(this.rootDir),this.logger.info("new()")}static libraryPathChanged(){let e=f(u.libraryPath.value,ei),r=f(this.priorInstance,i=>i.rootDir.nativePath);return e!==r}static instance(){let e=this.libraryPathChanged(),r=I(this.priorInstance?.ended),i;return(e||r)&&(i=mr(this.priorInstance,E),this.priorInstance=void 0),this.priorInstance==null&&jt()&&(this.priorInstance=j(u.libraryPath.value,o=>Et(new Wr(o),async n=>(await i,n.setup())))),this.priorInstance}static instanceRequired(){let e=Wr.instance();if(e==null)throw new Error("Library is undefined"+ce);return e}get isPendingSetup(){return this._ready.pending}get ready(){return this._ready.promise}async requiredFiles(){let e=[];return await ua(u.cacheDir.valueOrDefault)&&e.push({desc:"Cache directory",isDir:!0,file:()=>Oo()}),this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library model DB",isDir:!1,file:()=>y(this.modelDbJanitor(),r=>r.srcDbFile)},{desc:"Library model DB (local replica)",isDir:!1,file:()=>y(this.modelDbJanitor(),r=>r.localDbReplica)}),e}};var At=class extends hr{constructor(){super(...arguments);this.attrs={};this.urls=l(()=>new pn(this.toID()))}static shownUnhidden(e){return x(e,()=>At.query()).andWhere({shown:1,hidden:0,excluded:0})}static shownCount(){return this.ops().countf(e=>e.where({shown:1,excluded:0}))}static outdatedQuery(){return this.query().where("version","<",mn).andWhere({shown:1,excluded:0})}static deletePreviews(e){return Wr.instance().previews().ap(e).deleteAll()}static async delete(e){this.logger().warn("Deleting asset "+e),await mi.dbl.runf(r=>r.delete().where({assetId:e})),await Kt.dbl.runf(r=>r.delete().where({assetId:e})),await At.dbl.runf(r=>r.delete().where({id:e})),await At.deletePreviews(e)}static async exclude(e){return this.logger().info("Excluding asset "+e),{dbResult:await At.dbl.runf(r=>r.update({excluded:1}).where({id:e})),deletedPreviews:await At.deletePreviews(e)}}static nextOutdated(e=Lr){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=Lr){return this.dbl.pluckFirst(e(this.outdatedQuery()).count())}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static async addTags(e,r){let i=uo(r.filter(_),o=>zr(o));return this.logger().debug("addTags()",{assetId:e,tagPaths:r,uniqTagPaths:i}),R(i)?void 0:At.tx(async()=>{let n=(await ge(i,s=>Fe.findOrCreate(s))).map(s=>s.id);return mi.addTagsToAsset(e,n)})}static async removeTags(e,r){if(R(r))return;let i=await ge(r,o=>Fe.findByPath(o));return this.logger().info("removeTags()",{assetId:e,tags:i.map(o=>rt(o,"id","path")),tagPaths:r}),mi.removeTagsFromAsset(e,L(i.map(o=>o.id)))}static unshownAssetIds(){return this.dbl.pluckAll(`
        SELECT DISTINCT af1.assetId
        FROM AssetFile af1
          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 
            ON af1.assetId = af2.assetId
        WHERE af2.assetId IS NULL`)}static archive(e){return this.tx(async()=>{await At.ops().findById(e)!=null&&(await mi.dbl.runf(i=>i.where({assetId:e}).delete()),await Kt.dbl.runf(i=>i.where({assetId:e}).delete()),await At.dbl.runf(i=>i.where({id:e}).delete()))})}get capturedAt(){return yh(this.capturedAtLocal)}get capturedAtMs(){return Bv(this.capturedAtLocal)}markUnshownAndUpsert(){return this.shown=!1,this.version=mn,this.upsert()}markShownAndUpsert(){return this.shown=!0,this.excluded==null&&(this.excluded=!1),this.version=mn,this.upsert()}toAssetId(){return{assetId:this.id,capturedAtLocal:this.capturedAtLocal}}renderCaption(e){return f(this.capturedAtMs,r=>"Taken "+$M(r,e))}async whenApiTag(){return bt(this.capturedAt).flatMap(e=>YD(e)).flatMap(e=>Fe.findOrCreate(e)).flatMap(e=>e.toApiTag()).get()}addTagPaths(e){return At.addTags(this.id,e)}async findAssetFileByUri(e){return await this.getFiles(),this.files.find(r=>r.uri===e)}async addAssetFile(e){return await this.findAssetFileByUri(e.uri)==null&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}static getTags(e){return Fe.ops().all(Fe.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}async getTags(){return this.tags==null&&(this.tags=await At.getTags(this.id)),this.tags}static getTagPaths(e){let r=Fe.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return Fe.dbl.pluckAll(r)}async tagPaths(){return(await this.getTags()).map(r=>r.path.join("/")).sort()}async getStreams(e){if(this.streams==null){let r=await this.getTags();this.logger().info("getStreams(): fetched tags "+r,{limit:e});let i=await ge(r,o=>o.getAssetStream(this,e));this.streams=m0(L(i));for(let o of this.streams)for(let n of o.tags)await n.getAncestors()}return this.streams}async getBeforeAfterId(){let e=await At.dbl.all(At.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id"));this.afterId=f(e.find(r=>r.id>this.id),Ka),this.beforeId=f(e.reverse().find(r=>r.id<this.id),Ka),await Pe(this.beforeId,()=>this.getBeforeId()),await Pe(this.afterId,()=>this.getAfterId())}async getBeforeId(){return y(At.dbl.first(At.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}])),e=>this.beforeId=Ka(e))}async getAfterId(){return y(At.dbl.first(At.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}])),e=>this.afterId=Ka(e))}async getTagPaths(){return(await this.getTags()).map(r=>r.path)}async getFiles(){if(this.files!=null)return this.files;if(this.id==null)return this.files=[];let e=await Kt.ops().findBy({assetId:this.id});return this.files=te(e,r=>[!I(r.shown),-r.mtime])}async setShown(e){return Kt.setShown(this.id,e)}async getShown(){if(this.files!=null){let e=this.files.find(r=>I(r.shown));if(e!=null)return e}return y(Kt.ops().findOneBy({assetId:this.id,shown:1}),e=>Et(e,r=>r.asset=this))}async getCapturedAts(){return ge(this.getFiles(),e=>e.toCapturedAt())}link(){return"/asset/"+this.id}sqAttrs(e=!0){return b(b(b({},this.urls().sqImgAttrs(e)),{title:this.renderCaption()}),this.attrs)}async getImgAttrs(e,r,i=!1){if(this.imgAttrs==null&&(this.imgAttrs=new Map),this.imgAttrs.get(r)==null){let o=e.ap(this.toID());await y(o.readInfo(),async s=>{s.mimetype.startsWith("video/")&&(this.poster=await o.posterLink())});let n=!0;this.imgAttrs.set(r,await o.imgAttrs(r,n,i))}return this.imgAttrs.get(r)}async fitAttrs(e){return b(b({},await this.getImgAttrs(e,Ht.fit)),this.attrs)}isVideo(){if(this.files==null)throw new Error(".video called before getFiles()");return this.files.some(e=>e.isVideo)}videoAttrs(){return b({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(this.existingFiles==null)throw new Error(".videoSources called before getExistingFiles()");let e=this.existingFiles.filter(i=>i.isVideo).map(i=>({src:this.urls().videoLink(i.id),type:i.mimetype})),r=uo(e,i=>i.type);if(r.every(i=>i.type!=="video/mp4")){let i=this.existingFiles[0];r.unshift({src:this.urls().videoLink(i.id)+".mp4",type:"video/mp4"})}return r}async getPosixFiles(){let e=await this.getFiles();return L(await Promise.all(e.map(r=>r.posixFile())))}async getExistingAssetFiles(){return this.existingFiles==null&&(this.existingFiles=await Go(await this.getFiles(),e=>ye(e.posixFile(),r=>r.exists(),()=>!1))),this.existingFiles}async findOrCreateByFile(e){let r=await e.uri();if(r==null)return;let i=D(await Kt.findByAsset({id:this.id},{uri:r}))[0];return x(i,async()=>{let o=new Kt;return o.asset=this,o.assetId=this.id,await o.setFile(e),o})}clear(){return this.existingFiles=void 0,this.files=void 0,this.imgAttrs=void 0,this.streams=void 0,this.tags=void 0,this}async setHidden(e){return this.hidden=e,this.upsert()}},Nt=At;Nt.tableName="Asset",Nt.uniqueColumnName="id",Nt.booleanFields=["shown","hidden","excluded"],Nt.shownAssetCounts=l(()=>At.dbl.pluckFirst({sql:Fi("SELECT","  COUNT(DISTINCT Asset.id)","FROM Asset","WHERE","  Asset.shown = 1","  AND Asset.excluded = 0","  AND hidden = 0")}),7*S);function O0(){return er(vn(),async()=>{await Nt.dbl.runf(t=>t.update({version:0})),await Kt.dbl.runf(t=>t.update({version:0})),await Ps.dbl.runf(t=>t.where({name:Wm.enqueueAssetFileUpdates,version:So}).orWhere({name:Wm.enqueueAssetUpdates,version:mn}).delete())})}var Ze=v(require("process"));var k0=v(require("fs")),gy=v(require("fs-extra")),Hm=v(require("path")),Gm=v(require("process")),Za=v(require("timers"));var yy=class extends ze{constructor(){super("LogTail",()=>this.onEnd(),oe.logger);this.watchers=new Map;this.file2pos=new Map;this.lastReadFiles=new ns(5*S);this.mutex=new ut;this.setup=l(async()=>{await si();let e=u.logDir.valueOrDefault;he&&console.log("tailing "+e+"..."),await(0,gy.mkdirp)(e),this.root=await kr.for(e),await this.scan(!0)});this.ignorableFilename=Hm.sep+qt()+"-"+Gm.pid+"-",!Gm.stdout.writableFinished&&(rh(!0),this.flushTimeout=(0,Za.setInterval)(()=>this.flush(),sn/2),this.scanTimeout=(0,Za.setInterval)(()=>this.scan(),E),Gm.stdout.on("end",()=>this.end()),this.setup())}async flush(){this.write(ih())}readable(e){return e.endsWith(".log")&&!e.includes(this.ignorableFilename)}watchDir(e){K()||this.ended||yr(this.watchers,e,()=>{nn(Rt.debug,()=>console.log("LogTail(): watching "+e));try{return(0,k0.watch)(e,(r,i)=>this.watchListener(r,(0,Hm.join)(e,i)))}catch(r){nn(Rt.warn,()=>console.error("LogTail(): failed to read "+e,r));return}})}async scan(e=!1){if(!(K()||this.ended)&&(await this.root.visitDescendantFiles(async r=>{!this.readable(r.nativePath)||(e&&await y(r.size(),i=>this.file2pos.set(r.nativePath,i)),Nc(await r.mtimeMs())&&this.watchDir(r.dir))}),!(K()||this.ended))){try{let r=(0,Hm.join)(this.root.nativePath,yu(new Date));await(0,gy.mkdirp)(r),this.watchDir(r)}catch(r){nn(Rt.warn,()=>console.error("LogTail(): Failed to create the current log dir",r))}K()||this.ended||e&&console.log("LogTail(): Tailing "+this.root+"/**/*.log...")}}async onEnd(){rh(!1),f(this.flushTimeout,Za.clearInterval),this.flushTimeout=void 0,f(this.scanTimeout,Za.clearInterval),this.scanTimeout=void 0;for(let e of this.watchers.values())e.close();this.watchers.clear();for(let e of this.lastReadFiles)await this.watchListener("onEnd",e);try{this.write(ih(-1))}catch{}}write(e){for(let r of e)console.log(Yl().formatLogEntry(r))}async watchListener(e,r){!this.readable(r)||await this.mutex.serialByName(r,async()=>{try{let i=await kr.for(r);if(i==null){nn(Rt.warn,()=>console.error("watchListener: missing file",{event:e,filename:r}));return}let o=await i.size();if(o==null||o<=0)return;let n=x(this.file2pos.get(i.nativePath),()=>0);if(Ei(n,o))return;await y(dv(i,{start:n,end:o}),s=>Ec(...s)),this.lastReadFiles.add(i.nativePath),this.file2pos.set(i.nativePath,o)}catch(i){nn(Rt.warn,()=>console.error("Failed to read "+r+": "+ur(i)))}})}},up=yy;up.instance=l(()=>cm()?void 0:new yy);var by=class{constructor(){this.arr=[];this.iterIdx=0}get size(){return this.arr.length}count(e){return $r(this.arr,e)}unshift(...e){this.arr.splice(this.iterIdx,0,...e)}push(...e){this.unshift(...e),this.incrIdx(e.length)}remove(e){return this.filterInPlace(r=>r!==e)}filterInPlace(e){let r=!1;return Ft(this.arr,(i,o,n)=>{let s=e(i,o,n);return s||(r=!0,o<this.iterIdx&&this.iterIdx--),s}),this.incrIdx(0),r}next(e=()=>!0){if(this.size===0)return{value:void 0,done:!0};for(let r=0;r<this.size;r++){let i=this.arr[this.iterIdx];if(this.incrIdx(),i!=null&&e(i))return{value:i,done:!1}}return{value:void 0,done:!0}}toA(e=()=>!0){if(R(this.arr))return[];let r=[];for(let i=0;i<this.size;i++){let o=this.arr[(this.iterIdx+i)%this.arr.length];e(o)&&r.push(o)}return r}incrIdx(e=1){this.iterIdx=this.arr.length===0?0:(this.iterIdx+e)%this.arr.length}};Ho(()=>Km());Sw(()=>B(Km));var wC=new ut,R0=new ut,wy=new by,zVe=new xi({name:"Idle",callback:Km,intervalMs:7*S,initialDelayMs:20*S}),_0=async()=>!1;function N0(t){_0=t}async function B0(){return Ti()||K()||wy.size===0||R0.pendingCount>=lt()||await _0()}var xC=lt()>4?250:750;async function Km(){return await B0()?void 0:wC.maybeRun("runOnIdle",async()=>{if(await B0())return;let{value:t}=wy.next(e=>e.runnable);t!=null&&R0.push(t.name,async()=>t.onIdle()).finally(()=>Km),wy.size>0&&B(Km,xC)})}var nL=v(require("@sentry/node"));var Jm=l(()=>p("EventStore")),C0=7;function cp(t){return Bt(t,"breadcrumbs")}var xy=class{constructor(){this.root=ae.for(oi()).join("events")}datedRoot(e=new Date){return this.root.joinYMD(e)}rmrf(){return this.root.rmrf()}msg2file(e){return this.datedRoot(new Date(e.timestamp*S)).join(Or(e.message,8,Yn)+".json")}async eventsFrom(e=new Date){return D(await this.datedRoot(e).childFiles(r=>r.ext===".json"&&!r.isHiddenPosix()))}async eventQuotaExceeded(e){let r=h(e).includes(ho)||h(e.message).includes(ho),i=await this.eventCount(),o=u.maxErrorsPerDay.valueOrDefault+(r?C0:0);return i>=o}async eventCount(e=new Date){return(await this.eventsFrom(e)).length}async maybeSendEvent(e){if(K())return Jm().error("maybeSendEvent(): REJECT: we're ending.",{event:cp(e)}),null;try{let r=ju(e.message),i=await this.eventCount(),o=u.maxErrorsPerDay.valueOrDefault+(r?C0:0);return i>=o?(Jm().error("maybeSendEvent(): REJECT: too many events sent in the last day.",{recentEventCount:i,pleaseSend:r,maxErrorsPerDay:o,event:cp(e)}),null):await this.writeEvent(e)==null?(Jm().error("maybeSendEvent(): REJECT: event was already sent in the last day.",{event:cp(e)}),null):(Jm().error("maybeSendEvent(): ACCEPT",{event:cp(e),pleaseSend:r,recentEventCount:i,maxErrorsPerDay:o}),e)}catch(r){return Jm().error("maybeSendEvent(): Failed to determine if we should squelch the event. Failing closed.",r),null}}async writeEvent(e){let r=this.msg2file(e);return y(r.ensureNew_({maxVersions:u.maxErrorsPerDay.valueOrDefault,emptyIsNew:!1}).catch(()=>{}),i=>i.writeJsonMaybe(e))}},el=xy;el.instance=l(()=>new xy);var As=l(()=>co("ENABLE_SENTRY")||nr&&yo&&u.reportErrors.valueOrDefault);u.reportErrors.addListener(()=>As.clear());var Qm=v(require("@sentry/node")),Ym=v(G0()),gp=v(require("os")),yp=v(require("process"));var Ty=class{constructor(e,r){this.maxLength=e;this.toValue=r;this.sortedArray=new ls(r)}toArray(){return this.sortedArray.store}vacuum(){return this.sortedArray.length>this.maxLength&&Du(this.sortedArray.store,this.maxLength),this.toArray()}get min(){return this.sortedArray.length>=this.maxLength?this.toValue(this.sortedArray[0]):void 0}add(...e){let r=this.min;for(let i of e)if(i!=null){let o=this.toValue(i);o!=null&&(tb(o,r)||this.sortedArray.add(i))}this.sortedArray.length>=2*this.maxLength&&this.vacuum()}};var K0=v(require("fs")),hp=v(require("zlib"));var J0=2048,LC=J0/4,vy=class{constructor(e,r){this.f=e;this.lines=new ls(va);this._hasFirstLine=!1;this._ended=!1;this._paused=!1;this._errors=!1;this.from=Ir(e.name),this.fileStream=(0,K0.createReadStream)(e.nativePath,{autoClose:!0}),this.stream=(e.ext.toLowerCase().endsWith(".gz")?this.fileStream.pipe((0,hp.createGunzip)()):e.ext.toLowerCase().endsWith(".br")?this.fileStream.pipe((0,hp.createBrotliDecompress)()):this.fileStream).pipe(new Zn).on("error",i=>{r(i),this._errors=!0}),this.stream.on("data",this.onData.bind(this)),this.stream.on("end",()=>{this._ended=!0})}onData(e){let r=uv(e);r!=null&&(this.lines.add(b(b({},r),{from:this.from})),this._hasFirstLine=!0),this.lines.length>J0&&!this._paused&&(this.fileStream.pause(),this._paused=!0)}toString(){return"LogReader("+this.f.nativePath+")"}hasFirstLine(){return this._hasFirstLine}hasErrors(){return this._errors}ended(){return this._ended&&this.lines.length===0}peek(){return this.lines.store[0]}shift(){let e=this.lines.store.shift();return e!=null&&this.lines.length<LC&&this._paused&&(this.fileStream.resume(),this._paused=!1),e}};function FC(t=10*E){let e=Date.now()-t;return y(kr.for(u.logDir.valueOrDefault),r=>r.filterDescendantFiles(async i=>[".log",".log.gz"].includes(i.ext)&&Ei(await i.mtimeMs(),e)))}async function $0(t=50){await Ac();let e=tt(Rt.values.map(n=>[n,new Ty(t,va)])),r=Date.now()-Pt,i=p("allRecentLogEntries()");return await y(FC(),n=>Bi({name:"allRecentLogEntries()",laters:n.map(s=>async()=>{try{let a=[],m=new vy(s,c=>a.push(c));for(await Ve(()=>m.hasFirstLine(),{timeoutMs:10*S});!m.ended()&&!m.hasErrors();){let c=m.shift();c==null?await It(5):c.ts>r&&e[c.l]?.add(c)}_(a)&&(i.warn("Read error(s) for "+s,a),a.some(c=>c.code==="Z_BUF_ERROR"||me(c).includes("unexpected end of file"))&&ci(await s.mtimeMs(),Date.now()-E)&&(i.warn("Unlinking corrupt logfile "+s),await s.unlink_()))}catch(a){i.warn("Failed to read entries from "+s,a)}})})),ie(yt(e).map(n=>n.vacuum())).sort((n,s)=>Lt(n.ts,s.ts))}var Q0=v(require("child_process")),Y0=v(require("fs")),ro=v(require("os"));var Sy=l(()=>p("os")),X0=l(()=>[IC(),"on",(0,ro.arch)()].join(" "));function IC(){switch((0,ro.platform)()){case"linux":return OC();case"darwin":return kC();case"win32":return RC();default:return $m()}}function $m(){return(0,ro.platform)()+" "+(0,ro.release)()}function OC(){try{let t=(0,Y0.readFileSync)("/etc/os-release").toString(),e=qc({input:t,lowerCaseKeys:!0});if(M(e.pretty_name))return e.pretty_name;let r=x(e.version,e.version_id);return In(e.name,r,(i,o)=>i+" "+o,$m)}catch(t){return Sy().warn("Failed to fetch /etc/os-release",t),$m()}}function Z0(t){return t.split(".").slice(0,2).join(".")}var _C={"10.6":"Snow Leopard","10.7":"Lion","10.8":"Mountain Lion","10.9":"Mavericks","10.10":"Yosemite","10.11":"El Capitan","10.12":"Sierra","10.13":"High Sierra","10.14":"Mojave","10.15":"Catalina","11.1":"Big Sur"},eL=l(()=>(0,Q0.execSync)("sw_vers -productVersion").toString().trim());function NC(t=eL()){return _C[Z0(t)]}function kC(t=eL()){try{return Ai(NC(t),e=>`macOS ${e} (${t})`,$m)}catch(e){return Sy().warn("osNameMac(): unknown release",e),$m()}}var BC={"10.0":"10","6.3":"8.1","6.2":"8","6.1":"7","6.0":"Vista","5.2":"Server 2003","5.1":"XP","5.0":"2000","4.9":"ME","4.1":"98","4.0":"95"};function RC(t=(0,ro.release)()){let e=BC[Z0(t)];return e!=null?`Windows ${e} (${t})`:(Sy().warn("osNameWin(): unknown release: "+t),`Windows (${t})`)}var tL=l(()=>_b((0,ro.cpus)().map(t=>t.model)).map(t=>`${t.count} \xD7 ${t.t}`).join(", "),E);var bp=p("Sentry"),CC=100;async function rL(t){try{return As()?(Qm.default.init({dsn:Xr?"https://0652cdd351054fe9853ff944b1f54e2c@sentry.io/289071":"https://408e2f8d62c3494d8ed663d9e488d67a@sentry.io/1828379",shutdownTimeout:Lc(t.name),release:dx,environment:Bo,maxBreadcrumbs:CC,integrations:()=>[],beforeSend:VC().beforeSend,onFatalError:e=>Y("sentry.onFatalError",e)}),!0):!1}catch(e){return bp.warn("Failed to set up sentry: "+e),!1}}function iL(t,e){As()&&(e!=null&&!Hu(e)?Qm.default.captureException(Tx(e,t)):Hu(t)||Qm.default.captureMessage(t))}var VC=l(()=>new oL),oL=class{constructor(){this.eventStore=el.instance();this.beforeSend=async(e,r)=>{if(!As())return bp.warn("Sentry.beforeSend(): not sending event",e),null;if(await this.eventStore.eventQuotaExceeded(e))return bp.warn("Sentry.beforeSend(): event quota exceeded",e),null;let i=zC(e,r);if(Hu(i))return bp.info("Sentry.beforeSend(): event not sendable. vetoing",{event:e,hint:r,msg:i}),null;T(e.message)&&(e.message=Yt(i,256));let o=await My(e);return this.eventStore.maybeSendEvent(o)};Cu(iL),Dw(iL),new ze("EventFilter",()=>this.end(),oe.first)}end(){return f(Qm.default.getCurrentHub().getClient(),e=>e.close(5*S))}};function zC(t,e){return H(Vs([t.message,...D(UC(t.exception?.values)),me(e?.originalException)])).join(": ")}function UC(t){return De(t,e=>G(e.map(WC)))}function WC(t){return De(G([t?.type,t?.value].filter(e=>h(e).toLowerCase()!=="error")),e=>e.join(": "))}async function My(t){let e=u.email.value;M(e)&&(t.user==null&&(t.user={}),t.user.email=e),R(t.breadcrumbs)&&(t.breadcrumbs=await Py());let r=x(t.extra,{});return r.pid=yp.default.pid,r.serviceName=qt(),r.serviceEnding=K(),r.runtimeMs=Date.now()-Oi,r.version=ft,r.os=X0(),r.isDocker=Oe(),r.nodeVersion=yp.default.versions.node,r.locale=await hc(),r.cpus=tL(),r.memoryUsageMb=dA(),r.memoryUsageRssMb=hA(),r.systemMemory=Hn((0,gp.freemem)())+" / "+Hn((0,gp.totalmem)()),r.ffmpeg=await nD(),r.vlc=await uD(),r.argv=k(yp.default.argv),t.extra=r,b({timestamp:Date.now()/S},t)}async function Py(){await hs("writeRecentLogEntries"),await It(sn*3);let t=await $0();return L(t.map(qC))}function qC(t){return f(jC(t.l),e=>({timestamp:t.ts/S,level:e,category:x(t.from,Nr()),message:ki(t.ctx+": "+t.msg),data:typeof t.meta=="object"?t.meta:{value:St(t.meta)?ki(t.meta):t.meta}}))}function jC(t){switch(t){case"error":return Ym.Severity.Error;case"warn":return Ym.Severity.Warning;case"info":return Ym.Severity.Info;case"debug":return Ym.Severity.Debug;default:return}}function HC(){return"User requested recent logs at "+new Date().toISOString()+ho}async function sL(){let t=HC(),e=await My({message:t,breadcrumbs:await Py()});return As()?nL.default.captureEvent(e):await el.instance().writeEvent(e),e}var Ey=v(require("process"));function Dn(t,e=em()){cm()||(p("stdoutWrite").debug("()",{obj:t,ready:e}),Ey.stdout.write(k(t)+`
`),e&&Ey.stdout.write(GC+`
`))}var GC=k({ready:!0});var KC=l(()=>{Ow(()=>Ac()),Ho(()=>pm()),Qs(()=>Oa())}),Dy=class{constructor(e){this.opts=e;this._exitted=!1;this._ready=new Ot;this.jobs=new ut;this.onFatalHandlers=[];this.inputHandlers=new Map;this.setup=l(async()=>{this.logger.info("setup()");let e=()=>!this._exitted&&!K();try{j(Ne("PS_FATAL_"+this.name),i=>{throw new le({fatal:!0,message:i})}),j(Ne("PS_CRASH_"+this.name),i=>{B(()=>{throw new le({message:i})},5*S)});{let i=fi()+(this.name===Sa.main?"":` ${this.name}`),o=Ze.default;try{o.title=i}catch{}}if(await si(),jt()&&await of(),await this.setupErrorHandling(),this.logStartup(),Tr()&&(await this.maybeUpgradeSystemSettings(),await this.maybeUpgradeLibrarySettings()),KC(),N0(bA),await this.stdinReadline(),e()){let i=Wr.instance();if(i==null&&!Ic())throw new Error("Cannot start, library path is unset"+ce);i!=null&&await i.ready}un();let r=!e();this.logger.debug("setup done.",{reject:r}),r?this._ready.reject():this._ready.resolve()}catch(r){console.error(ur(r)),this._ready.reject(r),this.exit({reason:Wu(this.name+" setup failed: "+me(r),ce),status:14,waitForJobs:!1})}});this.stdinReadline=l(()=>{let e=Ze.default.stdin.pipe(new Zn);return e.on("data",r=>this.onLine(h(r))),e});Ma(this.name=this.opts.name),Xl(),u.logDir.addListener(()=>Xl()),u.tailLogs.valueOrDefault&&up.instance(),this.logger=p("Service("+this.name+")"),this.addDefaultInputHandlers(),this.jobs.push("Service.setupOrTimeout",()=>this.setupOrTimeout())}async setupOrTimeout(){{let r=await Ae(this.setup().then(()=>!0),u.setupTimeoutMs.valueOrDefault);if(I(r))return}let e=np(vA()?.nativePath);if(e!=null){let r=e/10,i=r-(Date.now()-Oi);i>0&&this.logger.warn("Startup is taking a while, but the database looks like it's large, so we're going to wait for another "+hh(i),{dbFileSize:e,timeoutMs:r,setupTimeoutMs:u.setupTimeoutMs.valueOrDefault});let o=await Ae(this.setup().then(()=>!0),i);if(I(o))return}return this.exit({reason:"Setup timed out after "+hh(Date.now()-Oi)+`.
Please visit https://photostructure.com/troubleshooting for help.`,status:13,waitForJobs:!1})}get ready(){return this._ready.promise}get isReady(){return this._ready.resolved}get exitted(){return this._exitted}onFatal(e){this.onFatalHandlers.push(e)}logStartup(){this.logger.info("setup()",b({version:ft,start:Oi,argv:Ze.default.argv,arch:Ze.default.arch,platform:Ze.default.platform,isDocker:Oe(),isPacked:yo,isElectron:Xr,versions:Ze.default.versions,settings:{logLevel:u.logLevel.valueOrDefault,httpPort:u.httpPort.valueOrDefault,rpcPort:u.rpcPort.valueOrDefault,libraryPath:u.libraryPath.valueOrDefault}},FT()))}async maybeUpgradeSystemSettings(){ft!==await KS()&&await rf()}async maybeUpgradeLibrarySettings(){jt()&&ft!==await JS()&&await XS()}async setupErrorHandling(){if(ue.on("fatal",({message:e,error:r})=>this.exit({reason:e+f(r,i=>": "+me(i)),status:12,waitForJobs:!1})),this.setInputHandler("--send-recent-logs",()=>sL()),Ze.default.on("unhandledRejection",e=>f(e,r=>Y("unhandledRejection",r))),Ze.default.on("uncaughtException",e=>f(e,r=>Y("uncaughtException",r))),Ze.default.on("SIGINT",()=>this.exit({reason:"SIGINT",status:0,waitForJobs:!1})),Ze.default.on("SIGTERM",()=>this.exit({reason:"SIGTERM",status:0,waitForJobs:!1})),Ze.default.on("SIGCHLD",(...e)=>this.logger.debug("Received SIGCHLD",e)),Ze.default.on("disconnect",()=>this.exit({reason:"disconnect",status:0,waitForJobs:!1})),Pa()||Tr()&&Oe())this.logger.info("setupErrorHandling(): not adding stdin/stdout/stderr close handlers: we're daemonized or in docker.");else{let e=!0;Ze.default.stdin.on("close",()=>this.exit({reason:"stdin.close",status:0,waitForJobs:e})),Ze.default.stdin.on("error",r=>this.logger.warn("stdin.error: "+r)),Ze.default.stdin.on("disconnect",()=>this.exit({reason:"stdin.disconnect",status:0,waitForJobs:e})),Ze.default.stdout.on("disconnect",()=>this.exit({reason:"stdout.disconnect",status:0,waitForJobs:e})),Ze.default.stdout.on("error",r=>this.logger.warn("stdout.error: "+r)),Ze.default.stderr.on("disconnect",()=>this.exit({reason:"stderr.disconnect",status:0,waitForJobs:e})),Ze.default.stderr.on("error",r=>this.logger.warn("stderr.error: "+r))}await rL(this)}async exit({reason:e,status:r,waitForJobs:i}){if(this._exitted=!0,this.logger.info("exit()",{status:r,reason:e,waitForJobs:i,ending:K()}),i&&(await It(250),await Ve(()=>(this.logger.info("exit(): waiting for enqueued jobs to complete...",{pendingNames:this.jobs.pendingNames()}),this.jobs.settled),{timeoutMs:void 0,timeBetweenMs:S}),this.logger.info("exit(): enqueued jobs finished.")),r!==0){await Promise.all(this.onFatalHandlers.map(n=>n(e)));let o={fatal:!0,exit:!0,status:r,pid:Ze.default.pid,ppid:Ze.default.ppid};o.error=e,it(()=>Dn(o,!1))}return await yw(),Ze.default.exit(r)}setInputHandler(e,r){this.inputHandlers.set(e.trim().toLowerCase(),r)}addDefaultInputHandlers(){this.setInputHandler("--version",async()=>{Dn({version:ft})}),this.setInputHandler("--status",async()=>{let e=await km();return this.logger.debug("--status",e),Dn({healthChecks:e})}),this.setInputHandler("--quit",()=>B(()=>this.exit({reason:"--quit from stdin",status:0,waitForJobs:!0}))),this.setInputHandler(lf,()=>B(()=>this.exit({reason:lf+" from stdin",status:0,waitForJobs:!0}))),this.setInputHandler("--pause",()=>(Oa(),Dn({paused:Ti()},!1))),this.setInputHandler("--resume",()=>(pm(),Dn({paused:Ti()},!1)))}onLine(e){return this.logger.debug("onLine()",{line:e,ending:this._exitted||K()}),this.jobs.serial("Service.onLine("+e+")",async()=>{if(await this.setup(),e.trim().startsWith("--")){let r=e.split(" ",1)[0],i=this.inputHandlers.get(r);i==null?(this.logger.error("onLine(): unknown command",{line:e}),console.warn("unknown command "+e)):await i(e.substr(r.length).trim())}else try{await f(this.opts.stdinReceiver,r=>r(e))}catch(r){this.logger.error("onLine(): failed to process",{line:e,error:r})}})}};var Ly=class{constructor(){this.start=Date.now();this.logger=l(()=>p("MainService"));this.httpPort=new mt("MainService.httpPort");this.libraryPath=new mt("MainService.libraryPath");this.setup=l(async()=>{await j(u.pidfile.value,async i=>{let o=ae.for(i);this.logger().info("Writing to pidfile "+o,{pid:Ay.pid}),await o.writeTxt_(h(Ay.pid)),new ze("remove pidfile",()=>o.unlink(),oe.postdb)});let e=i=>Gi(i.op+" ("+i.pct+"%)");Jx(e);let r=l(()=>Gi("Upgrading your library database..."));if(Mw(r),await this.service.ready,u.startPaused.valueOrDefault&&(this.logger().info("Settings.startPaused: pausing on startup."),Oa()),await tp(),this.service.setInputHandler("--restart-sync",()=>this.restartSync()),this.service.setInputHandler("--bounce",()=>this.bounce()),this.service.setInputHandler("--status",async()=>{let i=await km(),o=await Pe(this.web.healthCheck(),()=>({fail:["could not reach web"]})),n=await y(this.sync,s=>Pe(s.healthCheck(),()=>({fail:["could not reach sync"]})));Dn(nM(i,o,n))}),this.web=await Ia.mk("web",{onData:i=>this.onWebData(i),healthy:()=>this.webHealthCheck()}),this.web==null)return Y("Failed to start webservice"+ce);jt()&&(await Sn.vacuum(0),await this.restartSync()),Qs(()=>this.onPause()),Ho(()=>this.onResume()),TT(),this.httpPort.promise.then(i=>{Gi(`PhotoStructure is ready: <http://localhost:${i}/>`)}),this.libraryPath.promise.then(i=>{Gi(`Your library is at ${i}`)}),new ze("shutdown notice",()=>Gi(`
Shutting down PhotoStructure...`),oe.first),$x(e),ue.removeListener("migration",r),new Ah(()=>ne.for(u.logDir.valueOrDefault),gu,i=>[".log",".log.gz"].includes(i.ext))});this.setupBounceInterval=l(async()=>(await si(),we(u.bounceMinutes.valueOrDefault,e=>new xi({name:"web/sync bounce",intervalMs:e*E,callback:()=>this.bounce()}))));this.bounce=Cw("MainService.bounce()",async()=>{let e=p("MainService.bounce()");if(await si(),!jt())return e.warn("no library set up yet: no-op.");if(this.web==null)return e.error("web service was null");if(await xt()==null)return e.throw("libraryDataDir() returned null",{libraryPath:u.libraryPath.value});e.info("shutting down sync..."),await y(this.sync,o=>o.stop()),e.info("sync stopped.");let i=f(this.web,o=>o.pid);e.info("shutting down web...",{priorWebPid:i}),await f(this.web,o=>o.stop()),e.info("web stopped.",{priorWebPid:i}),e.info("killing old procs..."),await Wi.instance().killOldProcs({everything:!0}),await y(Wr.instance()?.modelDb(),o=>o.maybeRepair()),e.info("restarting web..."),await this.web.start()});this.service=new Dy({name:"main"}),this.setup(),It(4*S).then(()=>{this.httpPort.pending&&!K()&&Gi("Please wait, setting up...")})}async webHealthCheck(){let e=this.httpPort.value;if(e==null){this.logger().info("webHealthCheck(): no-op, no http port set (web is starting up still)");return}try{let r=await uM("localhost",e,"/ping",q);return Ie(200,299,r)?!0:(this.logger().warn("webHealthCheck(): web service returned "+r),!1)}catch(r){return this.logger().warn("webHealthCheck(): httping error: "+r),!1}}async onWebData(e){T(e)||(await f(e[u.libraryPath.key],async r=>{u.libraryPath.value!==r&&(this.logger().info("Got new library path from web service:"+r),u.libraryPath.tmpValue=r,await f(Wr.instance(),i=>i.ready),this.libraryPath.maybeResolve(r),Vu())}),f(e[u.httpPort.key],r=>{this.logger().info("Got HTTP port number from web service:"+r),u.httpPort.tmpValue=r,this.httpPort.maybeResolve(r)}),j(e.migration,Bu),Rp(e.pauseHealthChecks,r=>r?FA():IA()),Rp(e.pause,r=>r?Oa():pm()),await gl(e.shutdown,()=>this.service.exit({reason:"shutdown requested",status:0,waitForJobs:!0})),await gl(e.shutdownSync,()=>this.shutdownSync()),await gl(e.restartSync,()=>this.restartSync()),await gl(e.forceRestartSync,()=>this.forceRestartSync()),j(e.event,r=>hs(r,e.args)))}shutdownSync(){this.logger().info("shutdownSync()",{syncWasDefined:this.sync!=null}),mr(this.sync),this.sync=void 0}async rebuildLibrary(){return this.restartSync(()=>O0())}async forceRestartSync(){return this.restartSync(async()=>{f(L0(),r=>r.closeDb()),await y(Xa(!1),r=>r.rmrf("info"))})}async restartSync(e){await y(this.setupBounceInterval.clear(),mr),await this.setupBounceInterval();let r=p("MainService.restartSync()");if(K()){r.info("ending, no-op");return}let i=await this.sync;if(r.info("priorSync",f(i,n=>rt(n,"pid","name"))),await mr(i),this.sync=void 0,await si(),!jt()){r.info("restartSync(): no library settings",{libraryPath:u.libraryPath.value});return}if(e!=null&&await e(),Ti()){r.info("paused. no-op");return}let o=await(this.sync=Ia.mk("sync"));r.info("Started sync",f(o,n=>rt(n,"pid","name")))}async onPause(){return this.sendToChildren("--pause")}async sendToChildren(e){return Promise.all([y(this.web,r=>r.write(e)),y(this.sync,r=>r.write(e))])}async onResume(){await this.sendToChildren("--resume"),await this.sync==null&&await this.webHealthCheck()===!0&&(this.logger().info("onResume(): starting sync."),await this.restartSync())}};try{zL().install()}catch{}async function LV(){Ma("main"),await new sh("main").add(Pv,tM,rM,eM).parse(),new Ly}LV();
//# sourceMappingURL=main.js.map
