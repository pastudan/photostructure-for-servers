#!/usr/bin/env node
/* Copyright Â© 2021, PhotoStructure Inc. */
/* By using this software, you accept the terms in <https://photostructure.com/eula>. */
/* If you don't accept them, do not use this software. */
var oR=Object.create,Rd=Object.defineProperty,nR=Object.getPrototypeOf,Ew=Object.prototype.hasOwnProperty,sR=Object.getOwnPropertyNames,aR=Object.getOwnPropertyDescriptor,Dw=Object.getOwnPropertySymbols,lR=Object.prototype.propertyIsEnumerable;var y=Object.assign,mR=t=>Rd(t,"__esModule",{value:!0});var ni=(t,e)=>{var r={};for(var i in t)Ew.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(t!=null&&Dw)for(var i of Dw(t))e.indexOf(i)<0&&lR.call(t,i)&&(r[i]=t[i]);return r},Q=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports);var uR=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of sR(e))!Ew.call(t,i)&&i!=="default"&&Rd(t,i,{get:()=>e[i],enumerable:!(r=aR(e,i))||r.enumerable});return t},T=t=>uR(mR(Rd(t!=null?oR(nR(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var Ci=Q((Ype,Vn)=>{var kN={PasetoNotSupported:"ERR_PASETO_NOT_SUPPORTED",PasetoDecryptionFailed:"ERR_PASETO_DECRYPTION_FAILED",PasetoInvalid:"ERR_PASETO_INVALID",PasetoVerificationFailed:"ERR_PASETO_VERIFICATION_FAILED",PasetoClaimInvalid:"ERR_PASETO_CLAIM_INVALID",PasetoWorkerFailure:"ERR_PASETO_WORKER_FAILURE"},zn=class extends Error{constructor(e){super(e);this.name=this.constructor.name,this.code=kN[this.constructor.name],Error.captureStackTrace(this,this.constructor)}};Vn.exports.PasetoError=zn;Vn.exports.PasetoNotSupported=class extends zn{};Vn.exports.PasetoDecryptionFailed=class extends zn{};Vn.exports.PasetoInvalid=class extends zn{};Vn.exports.PasetoVerificationFailed=class extends zn{};Vn.exports.PasetoClaimInvalid=class extends zn{};Vn.exports.PasetoWorkerFailure=class extends zn{}});var up=Q((Xpe,lE)=>{lE.exports=t=>!!t&&t.constructor===Object});var cp=Q((Zpe,mE)=>{var _N=up();mE.exports=function(e){if(typeof e=="undefined")return Buffer.from("");if(Buffer.isBuffer(e))return e;if(_N(e))return Buffer.from(JSON.stringify(e),"utf8");if(typeof e!="string")throw new TypeError("options.footer must be a string, Buffer, or a plain object");return Buffer.from(e,"utf8")}});var jg=Q((ede,uE)=>{var cE=1e3,fE=cE*60,pE=fE*60,qg=pE*24,NN=qg*7,BN=qg*365.25,CN=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;uE.exports=t=>{let e=CN.exec(t);if(!e)throw new TypeError(`invalid time period format ("${t}")`);let r=parseFloat(e[1]);switch(e[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r*cE);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(r*fE);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(r*pE);case"day":case"days":case"d":return Math.round(r*qg);case"week":case"weeks":case"w":return Math.round(r*NN);case"year":case"years":case"yr":case"yrs":case"y":return Math.round(r*BN)}}});var gE=Q((tde,dE)=>{var hE=jg();dE.exports=({audience:t,expiresIn:e,iat:r=!0,issuer:i,jti:o,kid:n,notBefore:s,now:a=new Date,subject:m},u)=>{if(!(a instanceof Date)||!a.getTime())throw new TypeError("options.now must be a valid Date object");let p=a.getTime();if(r!==void 0){if(typeof r!="boolean")throw new TypeError("options.iat must be a boolean");r&&(u.iat=new Date(p))}if(e!==void 0){if(typeof e!="string")throw new TypeError("options.expiresIn must be a string");u.exp=new Date(p+hE(e))}if(s!==void 0){if(typeof s!="string")throw new TypeError("options.notBefore must be a string");u.nbf=new Date(p+hE(s))}if(t!==void 0){if(typeof t!="string")throw new TypeError("options.audience must be a string");u.aud=t}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.issuer must be a string");u.iss=i}if(m!==void 0){if(typeof m!="string")throw new TypeError("options.subject must be a string");u.sub=m}if(n!==void 0){if(typeof n!="string")throw new TypeError("options.kid must be a string");u.kid=n}if(o!==void 0){if(typeof o!="string")throw new TypeError("options.jti must be a string");u.jti=o}return u}});var fp=Q((rde,yE)=>{var VN=gE(),zN=up(),UN=t=>JSON.parse(JSON.stringify(t));yE.exports=(t,e)=>{if(Buffer.isBuffer(t)){if(Object.keys(e).length!==0)throw new TypeError("options cannot contain claims when payload is a Buffer");return t}if(!zN(t))throw new TypeError("payload must be a Buffer or a plain object");return t=UN(t),t=VN(e,t),Buffer.from(JSON.stringify(t),"utf-8")}});var wE=Q((ide,bE)=>{var{PasetoNotSupported:WN}=Ci();bE.exports=t=>{if(!Number.isSafeInteger(t))throw new WN("message is too long for Node.js to safely process");let e=~~(t/4294967295),r=t%4294967295-e,i=Buffer.allocUnsafe(8);return i.writeUInt32LE(e,4),i.writeUInt32LE(r,0),i}});var pp=Q((ode,xE)=>{var TE=wE();xE.exports=(...t)=>{let e=TE(t.length);for(let r of t){r=Buffer.from(r,"utf8");let i=TE(Buffer.byteLength(r));e=Buffer.concat([e,i,r])}return e}});var lu=Q((nde,Hg)=>{var qN=t=>t.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),jN=t=>t.replace(/-/g,"+").replace(/_/g,"/"),HN=t=>qN(t.toString("base64")),GN=t=>Buffer.from(jN(t),"base64");Hg.exports.decode=GN;Hg.exports.encode=HN});var Kg=Q((sde,vE)=>{var{encode:Gg}=lu();vE.exports=function(e,r,i){return i.length!==0?`${e}${Gg(Buffer.concat(r))}.${Gg(i)}`:`${e}${Gg(Buffer.concat(r))}`}});var PE=Q((ade,SE)=>{var{timingSafeEqual:KN}=require("crypto"),ME=(t,e)=>{if(t.length===e)return t;let r=Buffer.alloc(e);return t.copy(r),r},JN=(t,e)=>{let r=Math.max(t.length,e.length);return KN(ME(t,r),ME(e,r))};SE.exports=JN});var mu=Q((mde,EE)=>{var Ks=require("crypto"),$N=require("util"),{PasetoWorkerFailure:lde}=Ci(),DE=pp(),Sl;if(Ks.hkdf){let t=$N.promisify(Ks.hkdf);Sl=(e,r,i,o)=>t("sha384",e,i,o,r)}else Sl=(t,e,r,i)=>{let o=Un.hmac("sha384",t,r),n=Buffer.from(i),s=Buffer.from(""),a=Buffer.from(""),m;for(let p=1;Buffer.byteLength(s)<e;++m){m=Buffer.from(String.fromCharCode(p));let g=Buffer.concat([a,n,m]);a=Un.hmac("sha384",g,o),s=Buffer.concat([s,a])}return Buffer.from(s).slice(0,e)};var QN=Kg(),YN=PE(),Un={async"aes-256-ctr-hmac-sha-384-encrypt"(t,e,r,i){let o=Un.hmac("sha384",t,i);o=o.slice(0,32),e=Buffer.from(e);let n=o.slice(0,16),[s,a]=await Promise.all([Sl(r,32,n,"paseto-encryption-key"),Sl(r,32,n,"paseto-auth-key-for-aead")]),m=Un.encrypt("aes-256-ctr",t,s,o.slice(16)),u=DE("v1.local.",o,m,e),p=Un.hmac("sha384",u,a);return QN("v1.local.",[o,m,p],e)},async"aes-256-ctr-hmac-sha-384-decrypt"(t,e,r){let i=t.slice(0,32),o=t.slice(-48),n=t.slice(32,-48),s=i.slice(0,16),[a,m]=await Promise.all([Sl(r,32,s,"paseto-encryption-key"),Sl(r,32,s,"paseto-auth-key-for-aead")]),u=DE("v1.local.",i,n,e),p=Un.hmac("sha384",u,m),g=Un.decrypt("aes-256-ctr",n,a,i.slice(16));return!YN(o,p)||!g?!1:g},hmac(t,e,r){let i=Ks.createHmac(t,r);return i.update(e),i.digest()},verify(t,e,r,i){return Ks.verify(t,e,r,i)},sign(t,e,r){return Ks.sign(t,e,r)},encrypt(t,e,r,i){let o=Ks.createCipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])},decrypt(t,e,r,i){let o=Ks.createDecipheriv(t,r,i);return Buffer.concat([o.update(e),o.final()])}};EE.exports=Un});var Jg=Q((ude,AE)=>{var{sign:XN}=mu(),ZN=pp(),eB=Kg();AE.exports=async function(e,r,i,o,n,s){let a=ZN(e,r,i),m=await XN(o,a,n);if(m.length!==s)throw new TypeError(`invalid ${e.slice(0,-1)} signing key bit length`);return eB(e,[r,m],i)}});var LE=Q((cde,FE)=>{var{constants:{RSA_PKCS1_PSS_PADDING:tB,RSA_PSS_SALTLEN_DIGEST:rB},createPrivateKey:iB,KeyObject:oB}=require("crypto"),nB=cp(),sB=fp(),aB=Jg();function lB(t){if(t instanceof oB||(t=iB(t)),t.type!=="private"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public signing key must be a private RSA key");return t}FE.exports=async function(e,r,n={}){var{footer:i}=n,o=ni(n,["footer"]);let s=sB(e,o),a=nB(i);return r=lB(r),aB("v1.public.",s,a,"sha384",{key:r,padding:tB,saltLength:rB},256)}});var dp=Q((fde,IE)=>{var{PasetoClaimInvalid:or}=Ci(),RE=jg();IE.exports=({ignoreExp:t,ignoreNbf:e,ignoreIat:r,maxTokenAge:i,subject:o,issuer:n,clockTolerance:s,audience:a,now:m=new Date},u)=>{if(!(m instanceof Date)||!m.getTime())throw new TypeError("options.now must be a valid Date object");let p=m.getTime();if("iss"in u&&typeof u.iss!="string")throw new or("payload.iss must be a string");if(n!==void 0){if(typeof n!="string")throw new TypeError("options.issuer must be a string");if(u.iss!==n)throw new or("issuer mismatch")}if("sub"in u&&typeof u.sub!="string")throw new or("payload.sub must be a string");if(o!==void 0){if(typeof o!="string")throw new TypeError("options.subject must be a string");if(u.sub!==o)throw new or("subject mismatch")}if("aud"in u&&typeof u.aud!="string")throw new or("payload.aud must be a string");if(a!==void 0){if(typeof a!="string")throw new TypeError("options.audience must be a string");if(u.aud!==a)throw new or("audience mismatch")}if(s!==void 0&&typeof s!="string")throw new TypeError("options.clockTolerance must be a string");let g=s?RE(s):0,v;if("iat"in u){if(typeof u.iat!="string")throw new or("payload.iat must be a string");if(v=new Date(u.iat).getTime(),!v)throw new or("payload.iat must be a valid ISO8601 string");if(!r&&v>p+g)throw new or("token issued in the future")}if("nbf"in u){if(typeof u.nbf!="string")throw new or("payload.nbf must be a string");let D=new Date(u.nbf).getTime();if(!D)throw new or("payload.nbf must be a valid ISO8601 string");if(!e&&D>p+g)throw new or("token is not active yet")}if("exp"in u){if(typeof u.exp!="string")throw new or("payload.exp must be a string");let D=new Date(u.exp).getTime();if(!D)throw new or("payload.exp must be a valid ISO8601 string");if(!t&&D<=p-g)throw new or("token is expired")}if(i!==void 0){if(typeof i!="string")throw new TypeError("options.maxTokenAge must be a string");if(!("iat"in u))throw new or("missing iat claim");if(v+RE(i)<p+g)throw new or("maxTokenAge exceeded")}}});var uu=Q((pde,OE)=>{var{PasetoInvalid:mB}=Ci(),{strict:uB}=require("assert"),cB=up();OE.exports=t=>{try{let e=JSON.parse(t);return uB(cB(e)),e}catch(e){throw new mB("All PASETO payloads MUST be a JSON object")}}});var Qg=Q((dde,kE)=>{var{PasetoInvalid:$g,PasetoVerificationFailed:fB}=Ci(),{decode:_E}=lu(),{verify:pB}=mu(),dB=pp();kE.exports=async function(e,r,i,o,n){if(typeof r!="string")throw new TypeError("token must be a string");if(r.substr(0,e.length)!==e)throw new $g(`token is not a ${e.slice(0,-1)} token`);let{0:s,1:a,length:m}=r.substr(e.length).split(".");if(m!==1&&m!==2)throw new $g("token value is not a PASETO formatted value");let u,p;try{p=_E(s),u=_E(a||"")}catch(Ae){throw new $g("token value is not a PASETO formatted value")}let g=p.slice(0,-o),v=p.slice(-o),D=dB(e,g,u);if(!await pB(i,D,n,v))throw new fB("invalid signature");return{m:g,footer:u.length?u:void 0}}});var BE=Q((hde,NE)=>{var{constants:{RSA_PKCS1_PSS_PADDING:hB,RSA_PSS_SALTLEN_DIGEST:gB},createPublicKey:yB,KeyObject:bB}=require("crypto"),wB=dp(),xB=uu(),TB=Qg();function vB(t){if((!(t instanceof bB)||t.type==="private")&&(t=yB(t)),t.type!=="public"||t.asymmetricKeyType!=="rsa")throw new TypeError("v1.public verify key must be a public RSA key");return t}NE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=ni(s,["complete","buffer"]);r=vB(r);let{m:a,footer:m}=await TB("v1.public.",e,"sha384",256,{key:r,padding:hB,saltLength:gB});if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let u=xB(a);return wB(n,u),i?{payload:u,footer:m,version:"v1",purpose:"public"}:u}});var Yg=Q((gde,CE)=>{var{createSecretKey:SB,KeyObject:MB}=require("crypto");CE.exports=function(e,r){if(r instanceof MB||(r=SB(r)),r.type!=="secret"||r.symmetricKeySize!==32)throw new TypeError(`${e} secret key must be 32 bytes long symmetric key`);return r}});var Xg=Q((yde,VE)=>{var PB=require("crypto"),{promisify:EB}=require("util"),DB=EB(PB.randomFill);VE.exports=async function(e){let r=Buffer.allocUnsafe(e);return DB(r)}});var UE=Q((bde,zE)=>{var AB=cp(),FB=Yg().bind(void 0,"v1.local"),LB=fp(),IB=Xg(),{"aes-256-ctr-hmac-sha-384-encrypt":RB}=mu();zE.exports=async function(e,r,s={}){var{footer:i,nonce:o}=s,n=ni(s,["footer","nonce"]);let a=LB(e,n);r=FB(r);let m=AB(i),u=r.export();return(o&&process.env.NODE_ENV!=="test"||!o)&&(o=await IB(32)),RB(a,m,u,o)}});var HE=Q((wde,WE)=>{var{decode:qE}=lu(),{"aes-256-ctr-hmac-sha-384-decrypt":OB}=mu(),{PasetoDecryptionFailed:kB,PasetoInvalid:jE}=Ci(),_B=dp(),NB=Yg().bind(void 0,"v1.local"),BB=uu(),Zg="v1.local.";WE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=ni(s,["complete","buffer"]);if(typeof e!="string")throw new TypeError(`token must be a string, got: ${typeof e}`);if(r=NB(r),e.substr(0,Zg.length)!==Zg)throw new jE("token is not a v1.local PASETO");let{0:a,1:m="",length:u}=e.substr(Zg.length).split(".");if(u>2)throw new jE("token value is not a PASETO formatted value");let p=qE(m),g=qE(a),v=r.export(),D=await OB(g,p,v);if(!D)throw new kB("decryption failed");if(o){if(Object.keys(n).length!==0)throw new TypeError("options cannot contain claims when options.buffer is true");return i?{payload:D,footer:p.length?p:void 0,version:"v2",purpose:"local"}:D}let W=BB(D);return _B(n,W),i?{payload:W,footer:p.length?p:void 0,version:"v1",purpose:"local"}:W}});var JE=Q((xde,GE)=>{var KE=require("crypto"),{promisify:CB}=require("util"),{PasetoNotSupported:VB}=Ci(),zB=Xg(),UB=CB(KE.generateKeyPair),WB=32,qB=["rsa",{modulusLength:2048}];async function jB(t){switch(t){case"local":return KE.createSecretKey(await zB(WB));case"public":{let{privateKey:e}=await UB(...qB);return e}default:throw new VB("unsupported v1 purpose")}}GE.exports=jB});var QE=Q((Tde,$E)=>{var HB=LE(),GB=BE(),KB=UE(),JB=HE(),$B=JE();$E.exports={sign:HB,verify:GB,encrypt:KB,decrypt:JB,generateKey:$B}});var XE=Q((vde,YE)=>{var{createPrivateKey:QB,KeyObject:YB}=require("crypto"),XB=cp(),ZB=fp(),e1=Jg();function t1(t){if(t instanceof YB||(t=QB(t)),t.type!=="private"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public signing key must be a private ed25519 key");return t}YE.exports=async function(e,r,n={}){var{footer:i}=n,o=ni(n,["footer"]);let s=ZB(e,o);r=t1(r);let a=XB(i);return e1("v2.public.",s,a,void 0,r,64)}});var eD=Q((Sde,ZE)=>{var{createPublicKey:r1,KeyObject:i1}=require("crypto"),o1=dp(),n1=uu(),s1=Qg();function a1(t){if((!(t instanceof i1)||t.type==="private")&&(t=r1(t)),t.type!=="public"||t.asymmetricKeyType!=="ed25519")throw new TypeError("v2.public verify key must be a public ed25519 key");return t}ZE.exports=async function(e,r,s={}){var{complete:i=!1,buffer:o=!1}=s,n=ni(s,["complete","buffer"]);r=a1(r);let{m:a,footer:m}=await s1("v2.public.",e,void 0,64,r);if(o)return i?{payload:a,footer:m,version:"v2",purpose:"public"}:a;let u=n1(a);return o1(n,u),i?{payload:u,footer:m,version:"v2",purpose:"public"}:u}});var rD=Q((Mde,tD)=>{var l1=require("crypto"),{promisify:m1}=require("util"),{PasetoNotSupported:u1}=Ci(),c1=m1(l1.generateKeyPair);async function f1(t){switch(t){case"public":{let{privateKey:e}=await c1("ed25519");return e}default:throw new u1("unsupported v2 purpose")}}tD.exports=f1});var oD=Q((Pde,iD)=>{var p1=XE(),d1=eD(),h1=rD();iD.exports={sign:p1,verify:d1,generateKey:h1}});var mD=Q((Ede,nD)=>{var{PasetoInvalid:sD,PasetoNotSupported:aD}=Ci(),{decode:lD}=lu(),g1=uu();nD.exports=(t,{parse:e=!0}={})=>{if(typeof t!="string")throw new TypeError("token must be a string");let{0:r,1:i,2:o,3:n,length:s}=t.split(".");if(s!==3&&s!==4)throw new sD("token value is not a PASETO formatted value");if(r!=="v1"&&r!=="v2")throw new aD("unsupported PASETO version");if(i!=="local"&&i!=="public")throw new aD("unsupported PASETO purpose");let a={footer:n?lD(n):void 0,payload:void 0,version:r,purpose:i};if(i==="local")return a;let m=r==="v1"?256:64,u;try{u=lD(o).slice(0,-m)}catch(p){throw new sD("token value is not a PASETO formatted value")}return e?a.payload=g1(u):a.payload=u,a}});var cD=Q((Dde,uD)=>{var y1=mD();uD.exports={decode:y1}});var pD=Q((Ade,fD)=>{var b1=Ci(),w1=QE(),x1=oD(),{decode:T1}=cD();fD.exports={decode:T1,V1:w1,V2:x1,errors:b1}});var hL=Q(ad=>{Object.defineProperty(ad,"__esModule",{value:!0});var QV;(function(t){t[t.None=0]="None",t[t.Error=1]="Error",t[t.Debug=2]="Debug",t[t.Verbose=3]="Verbose"})(QV=ad.LogLevel||(ad.LogLevel={}))});var gL=Q(ld=>{Object.defineProperty(ld,"__esModule",{value:!0});var YV;(function(t){t.Ok="ok",t.Exited="exited",t.Crashed="crashed",t.Abnormal="abnormal"})(YV=ld.SessionStatus||(ld.SessionStatus={}))});var bL=Q(jl=>{Object.defineProperty(jl,"__esModule",{value:!0});var yL;(function(t){t.Fatal="fatal",t.Error="error",t.Warning="warning",t.Log="log",t.Info="info",t.Debug="debug",t.Critical="critical"})(yL=jl.Severity||(jl.Severity={}));(function(t){function e(r){switch(r){case"debug":return t.Debug;case"info":return t.Info;case"warn":case"warning":return t.Warning;case"error":return t.Error;case"fatal":return t.Fatal;case"critical":return t.Critical;case"log":default:return t.Log}}t.fromString=e})(yL=jl.Severity||(jl.Severity={}))});var xL=Q(Hl=>{Object.defineProperty(Hl,"__esModule",{value:!0});var wL;(function(t){t.Unknown="unknown",t.Skipped="skipped",t.Success="success",t.RateLimit="rate_limit",t.Invalid="invalid",t.Failed="failed"})(wL=Hl.Status||(Hl.Status={}));(function(t){function e(r){return r>=200&&r<300?t.Success:r===429?t.RateLimit:r>=400&&r<500?t.Invalid:r>=500?t.Failed:t.Unknown}t.fromHttpCode=e})(wL=Hl.Status||(Hl.Status={}))});var TL=Q(md=>{Object.defineProperty(md,"__esModule",{value:!0});var XV;(function(t){t.Explicit="explicitly_set",t.Sampler="client_sampler",t.Rate="client_rate",t.Inheritance="inheritance"})(XV=md.TransactionSamplingMethod||(md.TransactionSamplingMethod={}))});var vL=Q(sa=>{Object.defineProperty(sa,"__esModule",{value:!0});var ZV=hL();sa.LogLevel=ZV.LogLevel;var ez=gL();sa.SessionStatus=ez.SessionStatus;var tz=bL();sa.Severity=tz.Severity;var rz=xL();sa.Status=rz.Status;var iz=TL();sa.TransactionSamplingMethod=iz.TransactionSamplingMethod});var PI=Q(ow=>{var MI="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");ow.encode=function(t){if(0<=t&&t<MI.length)return MI[t];throw new TypeError("Must be between 0 and 63: "+t)};ow.decode=function(t){var e=65,r=90,i=97,o=122,n=48,s=57,a=43,m=47,u=26,p=52;return e<=t&&t<=r?t-e:i<=t&&t<=o?t-i+u:n<=t&&t<=s?t-n+p:t==a?62:t==m?63:-1}});var aw=Q(nw=>{var EI=PI(),sw=5,DI=1<<sw,AI=DI-1,FI=DI;function Kz(t){return t<0?(-t<<1)+1:(t<<1)+0}function Jz(t){var e=(t&1)==1,r=t>>1;return e?-r:r}nw.encode=function(e){var r="",i,o=Kz(e);do i=o&AI,o>>>=sw,o>0&&(i|=FI),r+=EI.encode(i);while(o>0);return r};nw.decode=function(e,r,i){var o=e.length,n=0,s=0,a,m;do{if(r>=o)throw new Error("Expected more digits in base 64 VLQ value.");if(m=EI.decode(e.charCodeAt(r++)),m===-1)throw new Error("Invalid base64 digit: "+e.charAt(r-1));a=!!(m&FI),m&=AI,n=n+(m<<s),s+=sw}while(a);i.value=Jz(n),i.rest=r}});var $l=Q(br=>{function $z(t,e,r){if(e in t)return t[e];if(arguments.length===3)return r;throw new Error('"'+e+'" is a required argument.')}br.getArg=$z;var LI=/^(?:([\w+\-.]+):)?\/\/(?:(\w+:\w+)@)?([\w.-]*)(?::(\d+))?(.*)$/,Qz=/^data:.+\,.+$/;function Xu(t){var e=t.match(LI);return e?{scheme:e[1],auth:e[2],host:e[3],port:e[4],path:e[5]}:null}br.urlParse=Xu;function Kl(t){var e="";return t.scheme&&(e+=t.scheme+":"),e+="//",t.auth&&(e+=t.auth+"@"),t.host&&(e+=t.host),t.port&&(e+=":"+t.port),t.path&&(e+=t.path),e}br.urlGenerate=Kl;function lw(t){var e=t,r=Xu(t);if(r){if(!r.path)return t;e=r.path}for(var i=br.isAbsolute(e),o=e.split(/\/+/),n,s=0,a=o.length-1;a>=0;a--)n=o[a],n==="."?o.splice(a,1):n===".."?s++:s>0&&(n===""?(o.splice(a+1,s),s=0):(o.splice(a,2),s--));return e=o.join("/"),e===""&&(e=i?"/":"."),r?(r.path=e,Kl(r)):e}br.normalize=lw;function II(t,e){t===""&&(t="."),e===""&&(e=".");var r=Xu(e),i=Xu(t);if(i&&(t=i.path||"/"),r&&!r.scheme)return i&&(r.scheme=i.scheme),Kl(r);if(r||e.match(Qz))return e;if(i&&!i.host&&!i.path)return i.host=e,Kl(i);var o=e.charAt(0)==="/"?e:lw(t.replace(/\/+$/,"")+"/"+e);return i?(i.path=o,Kl(i)):o}br.join=II;br.isAbsolute=function(t){return t.charAt(0)==="/"||LI.test(t)};function Yz(t,e){t===""&&(t="."),t=t.replace(/\/$/,"");for(var r=0;e.indexOf(t+"/")!==0;){var i=t.lastIndexOf("/");if(i<0||(t=t.slice(0,i),t.match(/^([^\/]+:\/)?\/*$/)))return e;++r}return Array(r+1).join("../")+e.substr(t.length+1)}br.relative=Yz;var RI=function(){var t=Object.create(null);return!("__proto__"in t)}();function OI(t){return t}function Xz(t){return kI(t)?"$"+t:t}br.toSetString=RI?OI:Xz;function Zz(t){return kI(t)?t.slice(1):t}br.fromSetString=RI?OI:Zz;function kI(t){if(!t)return!1;var e=t.length;if(e<9||t.charCodeAt(e-1)!==95||t.charCodeAt(e-2)!==95||t.charCodeAt(e-3)!==111||t.charCodeAt(e-4)!==116||t.charCodeAt(e-5)!==111||t.charCodeAt(e-6)!==114||t.charCodeAt(e-7)!==112||t.charCodeAt(e-8)!==95||t.charCodeAt(e-9)!==95)return!1;for(var r=e-10;r>=0;r--)if(t.charCodeAt(r)!==36)return!1;return!0}function eU(t,e,r){var i=Jl(t.source,e.source);return i!==0||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0||r)||(i=t.generatedColumn-e.generatedColumn,i!==0)||(i=t.generatedLine-e.generatedLine,i!==0)?i:Jl(t.name,e.name)}br.compareByOriginalPositions=eU;function tU(t,e,r){var i=t.generatedLine-e.generatedLine;return i!==0||(i=t.generatedColumn-e.generatedColumn,i!==0||r)||(i=Jl(t.source,e.source),i!==0)||(i=t.originalLine-e.originalLine,i!==0)||(i=t.originalColumn-e.originalColumn,i!==0)?i:Jl(t.name,e.name)}br.compareByGeneratedPositionsDeflated=tU;function Jl(t,e){return t===e?0:t===null?1:e===null?-1:t>e?1:-1}function rU(t,e){var r=t.generatedLine-e.generatedLine;return r!==0||(r=t.generatedColumn-e.generatedColumn,r!==0)||(r=Jl(t.source,e.source),r!==0)||(r=t.originalLine-e.originalLine,r!==0)||(r=t.originalColumn-e.originalColumn,r!==0)?r:Jl(t.name,e.name)}br.compareByGeneratedPositionsInflated=rU;function iU(t){return JSON.parse(t.replace(/^\)]}'[^\n]*\n/,""))}br.parseSourceMapInput=iU;function oU(t,e,r){if(e=e||"",t&&(t[t.length-1]!=="/"&&e[0]!=="/"&&(t+="/"),e=t+e),r){var i=Xu(r);if(!i)throw new Error("sourceMapURL could not be parsed");if(i.path){var o=i.path.lastIndexOf("/");o>=0&&(i.path=i.path.substring(0,o+1))}e=II(Kl(i),e)}return lw(e)}br.computeSourceURL=oU});var cw=Q(_I=>{var mw=$l(),uw=Object.prototype.hasOwnProperty,ua=typeof Map!="undefined";function mn(){this._array=[],this._set=ua?new Map:Object.create(null)}mn.fromArray=function(e,r){for(var i=new mn,o=0,n=e.length;o<n;o++)i.add(e[o],r);return i};mn.prototype.size=function(){return ua?this._set.size:Object.getOwnPropertyNames(this._set).length};mn.prototype.add=function(e,r){var i=ua?e:mw.toSetString(e),o=ua?this.has(e):uw.call(this._set,i),n=this._array.length;(!o||r)&&this._array.push(e),o||(ua?this._set.set(e,n):this._set[i]=n)};mn.prototype.has=function(e){if(ua)return this._set.has(e);var r=mw.toSetString(e);return uw.call(this._set,r)};mn.prototype.indexOf=function(e){if(ua){var r=this._set.get(e);if(r>=0)return r}else{var i=mw.toSetString(e);if(uw.call(this._set,i))return this._set[i]}throw new Error('"'+e+'" is not in the set.')};mn.prototype.at=function(e){if(e>=0&&e<this._array.length)return this._array[e];throw new Error("No element indexed by "+e)};mn.prototype.toArray=function(){return this._array.slice()};_I.ArraySet=mn});var CI=Q(NI=>{var BI=$l();function nU(t,e){var r=t.generatedLine,i=e.generatedLine,o=t.generatedColumn,n=e.generatedColumn;return i>r||i==r&&n>=o||BI.compareByGeneratedPositionsInflated(t,e)<=0}function Ed(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}Ed.prototype.unsortedForEach=function(e,r){this._array.forEach(e,r)};Ed.prototype.add=function(e){nU(this._last,e)?(this._last=e,this._array.push(e)):(this._sorted=!1,this._array.push(e))};Ed.prototype.toArray=function(){return this._sorted||(this._array.sort(BI.compareByGeneratedPositionsInflated),this._sorted=!0),this._array};NI.MappingList=Ed});var fw=Q(VI=>{var Zu=aw(),It=$l(),Dd=cw().ArraySet,sU=CI().MappingList;function Ei(t){t||(t={}),this._file=It.getArg(t,"file",null),this._sourceRoot=It.getArg(t,"sourceRoot",null),this._skipValidation=It.getArg(t,"skipValidation",!1),this._sources=new Dd,this._names=new Dd,this._mappings=new sU,this._sourcesContents=null}Ei.prototype._version=3;Ei.fromSourceMap=function(e){var r=e.sourceRoot,i=new Ei({file:e.file,sourceRoot:r});return e.eachMapping(function(o){var n={generated:{line:o.generatedLine,column:o.generatedColumn}};o.source!=null&&(n.source=o.source,r!=null&&(n.source=It.relative(r,n.source)),n.original={line:o.originalLine,column:o.originalColumn},o.name!=null&&(n.name=o.name)),i.addMapping(n)}),e.sources.forEach(function(o){var n=o;r!==null&&(n=It.relative(r,o)),i._sources.has(n)||i._sources.add(n);var s=e.sourceContentFor(o);s!=null&&i.setSourceContent(o,s)}),i};Ei.prototype.addMapping=function(e){var r=It.getArg(e,"generated"),i=It.getArg(e,"original",null),o=It.getArg(e,"source",null),n=It.getArg(e,"name",null);this._skipValidation||this._validateMapping(r,i,o,n),o!=null&&(o=String(o),this._sources.has(o)||this._sources.add(o)),n!=null&&(n=String(n),this._names.has(n)||this._names.add(n)),this._mappings.add({generatedLine:r.line,generatedColumn:r.column,originalLine:i!=null&&i.line,originalColumn:i!=null&&i.column,source:o,name:n})};Ei.prototype.setSourceContent=function(e,r){var i=e;this._sourceRoot!=null&&(i=It.relative(this._sourceRoot,i)),r!=null?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[It.toSetString(i)]=r):this._sourcesContents&&(delete this._sourcesContents[It.toSetString(i)],Object.keys(this._sourcesContents).length===0&&(this._sourcesContents=null))};Ei.prototype.applySourceMap=function(e,r,i){var o=r;if(r==null){if(e.file==null)throw new Error(`SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map's "file" property. Both were omitted.`);o=e.file}var n=this._sourceRoot;n!=null&&(o=It.relative(n,o));var s=new Dd,a=new Dd;this._mappings.unsortedForEach(function(m){if(m.source===o&&m.originalLine!=null){var u=e.originalPositionFor({line:m.originalLine,column:m.originalColumn});u.source!=null&&(m.source=u.source,i!=null&&(m.source=It.join(i,m.source)),n!=null&&(m.source=It.relative(n,m.source)),m.originalLine=u.line,m.originalColumn=u.column,u.name!=null&&(m.name=u.name))}var p=m.source;p!=null&&!s.has(p)&&s.add(p);var g=m.name;g!=null&&!a.has(g)&&a.add(g)},this),this._sources=s,this._names=a,e.sources.forEach(function(m){var u=e.sourceContentFor(m);u!=null&&(i!=null&&(m=It.join(i,m)),n!=null&&(m=It.relative(n,m)),this.setSourceContent(m,u))},this)};Ei.prototype._validateMapping=function(e,r,i,o){if(r&&typeof r.line!="number"&&typeof r.column!="number")throw new Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.");if(!(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0&&!r&&!i&&!o)){if(e&&"line"in e&&"column"in e&&r&&"line"in r&&"column"in r&&e.line>0&&e.column>=0&&r.line>0&&r.column>=0&&i)return;throw new Error("Invalid mapping: "+JSON.stringify({generated:e,source:i,original:r,name:o}))}};Ei.prototype._serializeMappings=function(){for(var e=0,r=1,i=0,o=0,n=0,s=0,a="",m,u,p,g,v=this._mappings.toArray(),D=0,W=v.length;D<W;D++){if(u=v[D],m="",u.generatedLine!==r)for(e=0;u.generatedLine!==r;)m+=";",r++;else if(D>0){if(!It.compareByGeneratedPositionsInflated(u,v[D-1]))continue;m+=","}m+=Zu.encode(u.generatedColumn-e),e=u.generatedColumn,u.source!=null&&(g=this._sources.indexOf(u.source),m+=Zu.encode(g-s),s=g,m+=Zu.encode(u.originalLine-1-o),o=u.originalLine-1,m+=Zu.encode(u.originalColumn-i),i=u.originalColumn,u.name!=null&&(p=this._names.indexOf(u.name),m+=Zu.encode(p-n),n=p)),a+=m}return a};Ei.prototype._generateSourcesContent=function(e,r){return e.map(function(i){if(!this._sourcesContents)return null;r!=null&&(i=It.relative(r,i));var o=It.toSetString(i);return Object.prototype.hasOwnProperty.call(this._sourcesContents,o)?this._sourcesContents[o]:null},this)};Ei.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return this._file!=null&&(e.file=this._file),this._sourceRoot!=null&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e};Ei.prototype.toString=function(){return JSON.stringify(this.toJSON())};VI.SourceMapGenerator=Ei});var zI=Q(ca=>{ca.GREATEST_LOWER_BOUND=1;ca.LEAST_UPPER_BOUND=2;function pw(t,e,r,i,o,n){var s=Math.floor((e-t)/2)+t,a=o(r,i[s],!0);return a===0?s:a>0?e-s>1?pw(s,e,r,i,o,n):n==ca.LEAST_UPPER_BOUND?e<i.length?e:-1:s:s-t>1?pw(t,s,r,i,o,n):n==ca.LEAST_UPPER_BOUND?s:t<0?-1:t}ca.search=function(e,r,i,o){if(r.length===0)return-1;var n=pw(-1,r.length,e,r,i,o||ca.GREATEST_LOWER_BOUND);if(n<0)return-1;for(;n-1>=0&&i(r[n],r[n-1],!0)===0;)--n;return n}});var WI=Q(UI=>{function dw(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}function aU(t,e){return Math.round(t+Math.random()*(e-t))}function hw(t,e,r,i){if(r<i){var o=aU(r,i),n=r-1;dw(t,o,i);for(var s=t[i],a=r;a<i;a++)e(t[a],s)<=0&&(n+=1,dw(t,n,a));dw(t,n+1,a);var m=n+1;hw(t,e,r,m-1),hw(t,e,m+1,i)}}UI.quickSort=function(t,e){hw(t,e,0,t.length-1)}});var jI=Q(Ad=>{var j=$l(),gw=zI(),Ql=cw().ArraySet,lU=aw(),ec=WI().quickSort;function Qe(t,e){var r=t;return typeof t=="string"&&(r=j.parseSourceMapInput(t)),r.sections!=null?new Wi(r,e):new nr(r,e)}Qe.fromSourceMap=function(t,e){return nr.fromSourceMap(t,e)};Qe.prototype._version=3;Qe.prototype.__generatedMappings=null;Object.defineProperty(Qe.prototype,"_generatedMappings",{configurable:!0,enumerable:!0,get:function(){return this.__generatedMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__generatedMappings}});Qe.prototype.__originalMappings=null;Object.defineProperty(Qe.prototype,"_originalMappings",{configurable:!0,enumerable:!0,get:function(){return this.__originalMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__originalMappings}});Qe.prototype._charIsMappingSeparator=function(e,r){var i=e.charAt(r);return i===";"||i===","};Qe.prototype._parseMappings=function(e,r){throw new Error("Subclasses must implement _parseMappings")};Qe.GENERATED_ORDER=1;Qe.ORIGINAL_ORDER=2;Qe.GREATEST_LOWER_BOUND=1;Qe.LEAST_UPPER_BOUND=2;Qe.prototype.eachMapping=function(e,r,i){var o=r||null,n=i||Qe.GENERATED_ORDER,s;switch(n){case Qe.GENERATED_ORDER:s=this._generatedMappings;break;case Qe.ORIGINAL_ORDER:s=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var a=this.sourceRoot;s.map(function(m){var u=m.source===null?null:this._sources.at(m.source);return u=j.computeSourceURL(a,u,this._sourceMapURL),{source:u,generatedLine:m.generatedLine,generatedColumn:m.generatedColumn,originalLine:m.originalLine,originalColumn:m.originalColumn,name:m.name===null?null:this._names.at(m.name)}},this).forEach(e,o)};Qe.prototype.allGeneratedPositionsFor=function(e){var r=j.getArg(e,"line"),i={source:j.getArg(e,"source"),originalLine:r,originalColumn:j.getArg(e,"column",0)};if(i.source=this._findSourceIndex(i.source),i.source<0)return[];var o=[],n=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",j.compareByOriginalPositions,gw.LEAST_UPPER_BOUND);if(n>=0){var s=this._originalMappings[n];if(e.column===void 0)for(var a=s.originalLine;s&&s.originalLine===a;)o.push({line:j.getArg(s,"generatedLine",null),column:j.getArg(s,"generatedColumn",null),lastColumn:j.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n];else for(var m=s.originalColumn;s&&s.originalLine===r&&s.originalColumn==m;)o.push({line:j.getArg(s,"generatedLine",null),column:j.getArg(s,"generatedColumn",null),lastColumn:j.getArg(s,"lastGeneratedColumn",null)}),s=this._originalMappings[++n]}return o};Ad.SourceMapConsumer=Qe;function nr(t,e){var r=t;typeof t=="string"&&(r=j.parseSourceMapInput(t));var i=j.getArg(r,"version"),o=j.getArg(r,"sources"),n=j.getArg(r,"names",[]),s=j.getArg(r,"sourceRoot",null),a=j.getArg(r,"sourcesContent",null),m=j.getArg(r,"mappings"),u=j.getArg(r,"file",null);if(i!=this._version)throw new Error("Unsupported version: "+i);s&&(s=j.normalize(s)),o=o.map(String).map(j.normalize).map(function(p){return s&&j.isAbsolute(s)&&j.isAbsolute(p)?j.relative(s,p):p}),this._names=Ql.fromArray(n.map(String),!0),this._sources=Ql.fromArray(o,!0),this._absoluteSources=this._sources.toArray().map(function(p){return j.computeSourceURL(s,p,e)}),this.sourceRoot=s,this.sourcesContent=a,this._mappings=m,this._sourceMapURL=e,this.file=u}nr.prototype=Object.create(Qe.prototype);nr.prototype.consumer=Qe;nr.prototype._findSourceIndex=function(t){var e=t;if(this.sourceRoot!=null&&(e=j.relative(this.sourceRoot,e)),this._sources.has(e))return this._sources.indexOf(e);var r;for(r=0;r<this._absoluteSources.length;++r)if(this._absoluteSources[r]==t)return r;return-1};nr.fromSourceMap=function(e,r){var i=Object.create(nr.prototype),o=i._names=Ql.fromArray(e._names.toArray(),!0),n=i._sources=Ql.fromArray(e._sources.toArray(),!0);i.sourceRoot=e._sourceRoot,i.sourcesContent=e._generateSourcesContent(i._sources.toArray(),i.sourceRoot),i.file=e._file,i._sourceMapURL=r,i._absoluteSources=i._sources.toArray().map(function(D){return j.computeSourceURL(i.sourceRoot,D,r)});for(var s=e._mappings.toArray().slice(),a=i.__generatedMappings=[],m=i.__originalMappings=[],u=0,p=s.length;u<p;u++){var g=s[u],v=new qI;v.generatedLine=g.generatedLine,v.generatedColumn=g.generatedColumn,g.source&&(v.source=n.indexOf(g.source),v.originalLine=g.originalLine,v.originalColumn=g.originalColumn,g.name&&(v.name=o.indexOf(g.name)),m.push(v)),a.push(v)}return ec(i.__originalMappings,j.compareByOriginalPositions),i};nr.prototype._version=3;Object.defineProperty(nr.prototype,"sources",{get:function(){return this._absoluteSources.slice()}});function qI(){this.generatedLine=0,this.generatedColumn=0,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}nr.prototype._parseMappings=function(e,r){for(var i=1,o=0,n=0,s=0,a=0,m=0,u=e.length,p=0,g={},v={},D=[],W=[],Ae,sr,Ye,J,Z;p<u;)if(e.charAt(p)===";")i++,p++,o=0;else if(e.charAt(p)===",")p++;else{for(Ae=new qI,Ae.generatedLine=i,J=p;J<u&&!this._charIsMappingSeparator(e,J);J++);if(sr=e.slice(p,J),Ye=g[sr],Ye)p+=sr.length;else{for(Ye=[];p<J;)lU.decode(e,p,v),Z=v.value,p=v.rest,Ye.push(Z);if(Ye.length===2)throw new Error("Found a source, but no line and column");if(Ye.length===3)throw new Error("Found a source and line, but no column");g[sr]=Ye}Ae.generatedColumn=o+Ye[0],o=Ae.generatedColumn,Ye.length>1&&(Ae.source=a+Ye[1],a+=Ye[1],Ae.originalLine=n+Ye[2],n=Ae.originalLine,Ae.originalLine+=1,Ae.originalColumn=s+Ye[3],s=Ae.originalColumn,Ye.length>4&&(Ae.name=m+Ye[4],m+=Ye[4])),W.push(Ae),typeof Ae.originalLine=="number"&&D.push(Ae)}ec(W,j.compareByGeneratedPositionsDeflated),this.__generatedMappings=W,ec(D,j.compareByOriginalPositions),this.__originalMappings=D};nr.prototype._findMapping=function(e,r,i,o,n,s){if(e[i]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+e[i]);if(e[o]<0)throw new TypeError("Column must be greater than or equal to 0, got "+e[o]);return gw.search(e,r,n,s)};nr.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var r=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var i=this._generatedMappings[e+1];if(r.generatedLine===i.generatedLine){r.lastGeneratedColumn=i.generatedColumn-1;continue}}r.lastGeneratedColumn=Infinity}};nr.prototype.originalPositionFor=function(e){var r={generatedLine:j.getArg(e,"line"),generatedColumn:j.getArg(e,"column")},i=this._findMapping(r,this._generatedMappings,"generatedLine","generatedColumn",j.compareByGeneratedPositionsDeflated,j.getArg(e,"bias",Qe.GREATEST_LOWER_BOUND));if(i>=0){var o=this._generatedMappings[i];if(o.generatedLine===r.generatedLine){var n=j.getArg(o,"source",null);n!==null&&(n=this._sources.at(n),n=j.computeSourceURL(this.sourceRoot,n,this._sourceMapURL));var s=j.getArg(o,"name",null);return s!==null&&(s=this._names.at(s)),{source:n,line:j.getArg(o,"originalLine",null),column:j.getArg(o,"originalColumn",null),name:s}}}return{source:null,line:null,column:null,name:null}};nr.prototype.hasContentsOfAllSources=function(){return this.sourcesContent?this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return e==null}):!1};nr.prototype.sourceContentFor=function(e,r){if(!this.sourcesContent)return null;var i=this._findSourceIndex(e);if(i>=0)return this.sourcesContent[i];var o=e;this.sourceRoot!=null&&(o=j.relative(this.sourceRoot,o));var n;if(this.sourceRoot!=null&&(n=j.urlParse(this.sourceRoot))){var s=o.replace(/^file:\/\//,"");if(n.scheme=="file"&&this._sources.has(s))return this.sourcesContent[this._sources.indexOf(s)];if((!n.path||n.path=="/")&&this._sources.has("/"+o))return this.sourcesContent[this._sources.indexOf("/"+o)]}if(r)return null;throw new Error('"'+o+'" is not in the SourceMap.')};nr.prototype.generatedPositionFor=function(e){var r=j.getArg(e,"source");if(r=this._findSourceIndex(r),r<0)return{line:null,column:null,lastColumn:null};var i={source:r,originalLine:j.getArg(e,"line"),originalColumn:j.getArg(e,"column")},o=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",j.compareByOriginalPositions,j.getArg(e,"bias",Qe.GREATEST_LOWER_BOUND));if(o>=0){var n=this._originalMappings[o];if(n.source===i.source)return{line:j.getArg(n,"generatedLine",null),column:j.getArg(n,"generatedColumn",null),lastColumn:j.getArg(n,"lastGeneratedColumn",null)}}return{line:null,column:null,lastColumn:null}};Ad.BasicSourceMapConsumer=nr;function Wi(t,e){var r=t;typeof t=="string"&&(r=j.parseSourceMapInput(t));var i=j.getArg(r,"version"),o=j.getArg(r,"sections");if(i!=this._version)throw new Error("Unsupported version: "+i);this._sources=new Ql,this._names=new Ql;var n={line:-1,column:0};this._sections=o.map(function(s){if(s.url)throw new Error("Support for url field in sections not implemented.");var a=j.getArg(s,"offset"),m=j.getArg(a,"line"),u=j.getArg(a,"column");if(m<n.line||m===n.line&&u<n.column)throw new Error("Section offsets must be ordered and non-overlapping.");return n=a,{generatedOffset:{generatedLine:m+1,generatedColumn:u+1},consumer:new Qe(j.getArg(s,"map"),e)}})}Wi.prototype=Object.create(Qe.prototype);Wi.prototype.constructor=Qe;Wi.prototype._version=3;Object.defineProperty(Wi.prototype,"sources",{get:function(){for(var t=[],e=0;e<this._sections.length;e++)for(var r=0;r<this._sections[e].consumer.sources.length;r++)t.push(this._sections[e].consumer.sources[r]);return t}});Wi.prototype.originalPositionFor=function(e){var r={generatedLine:j.getArg(e,"line"),generatedColumn:j.getArg(e,"column")},i=gw.search(r,this._sections,function(n,s){var a=n.generatedLine-s.generatedOffset.generatedLine;return a||n.generatedColumn-s.generatedOffset.generatedColumn}),o=this._sections[i];return o?o.consumer.originalPositionFor({line:r.generatedLine-(o.generatedOffset.generatedLine-1),column:r.generatedColumn-(o.generatedOffset.generatedLine===r.generatedLine?o.generatedOffset.generatedColumn-1:0),bias:e.bias}):{source:null,line:null,column:null,name:null}};Wi.prototype.hasContentsOfAllSources=function(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})};Wi.prototype.sourceContentFor=function(e,r){for(var i=0;i<this._sections.length;i++){var o=this._sections[i],n=o.consumer.sourceContentFor(e,!0);if(n)return n}if(r)return null;throw new Error('"'+e+'" is not in the SourceMap.')};Wi.prototype.generatedPositionFor=function(e){for(var r=0;r<this._sections.length;r++){var i=this._sections[r];if(i.consumer._findSourceIndex(j.getArg(e,"source"))!==-1){var o=i.consumer.generatedPositionFor(e);if(o){var n={line:o.line+(i.generatedOffset.generatedLine-1),column:o.column+(i.generatedOffset.generatedLine===o.line?i.generatedOffset.generatedColumn-1:0)};return n}}}return{line:null,column:null}};Wi.prototype._parseMappings=function(e,r){this.__generatedMappings=[],this.__originalMappings=[];for(var i=0;i<this._sections.length;i++)for(var o=this._sections[i],n=o.consumer._generatedMappings,s=0;s<n.length;s++){var a=n[s],m=o.consumer._sources.at(a.source);m=j.computeSourceURL(o.consumer.sourceRoot,m,this._sourceMapURL),this._sources.add(m),m=this._sources.indexOf(m);var u=null;a.name&&(u=o.consumer._names.at(a.name),this._names.add(u),u=this._names.indexOf(u));var p={source:m,generatedLine:a.generatedLine+(o.generatedOffset.generatedLine-1),generatedColumn:a.generatedColumn+(o.generatedOffset.generatedLine===a.generatedLine?o.generatedOffset.generatedColumn-1:0),originalLine:a.originalLine,originalColumn:a.originalColumn,name:u};this.__generatedMappings.push(p),typeof p.originalLine=="number"&&this.__originalMappings.push(p)}ec(this.__generatedMappings,j.compareByGeneratedPositionsDeflated),ec(this.__originalMappings,j.compareByOriginalPositions)};Ad.IndexedSourceMapConsumer=Wi});var GI=Q(HI=>{var mU=fw().SourceMapGenerator,Fd=$l(),uU=/(\r?\n)/,cU=10,Yl="$$$isSourceNode$$$";function oi(t,e,r,i,o){this.children=[],this.sourceContents={},this.line=t??null,this.column=e??null,this.source=r??null,this.name=o??null,this[Yl]=!0,i!=null&&this.add(i)}oi.fromStringWithSourceMap=function(e,r,i){var o=new oi,n=e.split(uU),s=0,a=function(){var v=W(),D=W()||"";return v+D;function W(){return s<n.length?n[s++]:void 0}},m=1,u=0,p=null;return r.eachMapping(function(v){if(p!==null)if(m<v.generatedLine)g(p,a()),m++,u=0;else{var D=n[s]||"",W=D.substr(0,v.generatedColumn-u);n[s]=D.substr(v.generatedColumn-u),u=v.generatedColumn,g(p,W),p=v;return}for(;m<v.generatedLine;)o.add(a()),m++;if(u<v.generatedColumn){var D=n[s]||"";o.add(D.substr(0,v.generatedColumn)),n[s]=D.substr(v.generatedColumn),u=v.generatedColumn}p=v},this),s<n.length&&(p&&g(p,a()),o.add(n.splice(s).join(""))),r.sources.forEach(function(v){var D=r.sourceContentFor(v);D!=null&&(i!=null&&(v=Fd.join(i,v)),o.setSourceContent(v,D))}),o;function g(v,D){if(v===null||v.source===void 0)o.add(D);else{var W=i?Fd.join(i,v.source):v.source;o.add(new oi(v.originalLine,v.originalColumn,W,D,v.name))}}};oi.prototype.add=function(e){if(Array.isArray(e))e.forEach(function(r){this.add(r)},this);else if(e[Yl]||typeof e=="string")e&&this.children.push(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};oi.prototype.prepend=function(e){if(Array.isArray(e))for(var r=e.length-1;r>=0;r--)this.prepend(e[r]);else if(e[Yl]||typeof e=="string")this.children.unshift(e);else throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);return this};oi.prototype.walk=function(e){for(var r,i=0,o=this.children.length;i<o;i++)r=this.children[i],r[Yl]?r.walk(e):r!==""&&e(r,{source:this.source,line:this.line,column:this.column,name:this.name})};oi.prototype.join=function(e){var r,i,o=this.children.length;if(o>0){for(r=[],i=0;i<o-1;i++)r.push(this.children[i]),r.push(e);r.push(this.children[i]),this.children=r}return this};oi.prototype.replaceRight=function(e,r){var i=this.children[this.children.length-1];return i[Yl]?i.replaceRight(e,r):typeof i=="string"?this.children[this.children.length-1]=i.replace(e,r):this.children.push("".replace(e,r)),this};oi.prototype.setSourceContent=function(e,r){this.sourceContents[Fd.toSetString(e)]=r};oi.prototype.walkSourceContents=function(e){for(var r=0,i=this.children.length;r<i;r++)this.children[r][Yl]&&this.children[r].walkSourceContents(e);for(var o=Object.keys(this.sourceContents),r=0,i=o.length;r<i;r++)e(Fd.fromSetString(o[r]),this.sourceContents[o[r]])};oi.prototype.toString=function(){var e="";return this.walk(function(r){e+=r}),e};oi.prototype.toStringWithSourceMap=function(e){var r={code:"",line:1,column:0},i=new mU(e),o=!1,n=null,s=null,a=null,m=null;return this.walk(function(u,p){r.code+=u,p.source!==null&&p.line!==null&&p.column!==null?((n!==p.source||s!==p.line||a!==p.column||m!==p.name)&&i.addMapping({source:p.source,original:{line:p.line,column:p.column},generated:{line:r.line,column:r.column},name:p.name}),n=p.source,s=p.line,a=p.column,m=p.name,o=!0):o&&(i.addMapping({generated:{line:r.line,column:r.column}}),n=null,o=!1);for(var g=0,v=u.length;g<v;g++)u.charCodeAt(g)===cU?(r.line++,r.column=0,g+1===v?(n=null,o=!1):o&&i.addMapping({source:p.source,original:{line:p.line,column:p.column},generated:{line:r.line,column:r.column},name:p.name})):r.column++}),this.walkSourceContents(function(u,p){i.setSourceContent(u,p)}),{code:r.code,map:i}};HI.SourceNode=oi});var KI=Q(Ld=>{Ld.SourceMapGenerator=fw().SourceMapGenerator;Ld.SourceMapConsumer=jI().SourceMapConsumer;Ld.SourceNode=GI().SourceNode});var $I=Q((l9e,JI)=>{var fU=Object.prototype.toString,yw=typeof Buffer.alloc=="function"&&typeof Buffer.allocUnsafe=="function"&&typeof Buffer.from=="function";function pU(t){return fU.call(t).slice(8,-1)==="ArrayBuffer"}function dU(t,e,r){e>>>=0;var i=t.byteLength-e;if(i<0)throw new RangeError("'offset' is out of bounds");if(r===void 0)r=i;else if(r>>>=0,r>i)throw new RangeError("'length' is out of bounds");return yw?Buffer.from(t.slice(e,e+r)):new Buffer(new Uint8Array(t.slice(e,e+r)))}function hU(t,e){if((typeof e!="string"||e==="")&&(e="utf8"),!Buffer.isEncoding(e))throw new TypeError('"encoding" must be a valid string encoding');return yw?Buffer.from(t,e):new Buffer(t,e)}function gU(t,e,r){if(typeof t=="number")throw new TypeError('"value" argument must not be a number');return pU(t)?dU(t,e,r):typeof t=="string"?hU(t,e):yw?Buffer.from(t):new Buffer(t)}JI.exports=gU});var iR=Q((fa,bw)=>{var yU=KI().SourceMapConsumer,ww=require("path"),So;try{So=require("fs"),(!So.existsSync||!So.readFileSync)&&(So=null)}catch(t){}var bU=$I();function QI(t,e){return t.require(e)}var YI=!1,XI=!1,xw=!1,tc="auto",pa={},rc={},wU=/^data:application\/json[^,]+base64,/,is=[],os=[];function Tw(){return tc==="browser"?!0:tc==="node"?!1:typeof window!="undefined"&&typeof XMLHttpRequest=="function"&&!(window.require&&window.module&&window.process&&window.process.type==="renderer")}function xU(){return typeof process=="object"&&process!==null&&typeof process.on=="function"}function Id(t){return function(e){for(var r=0;r<t.length;r++){var i=t[r](e);if(i)return i}return null}}var vw=Id(is);is.push(function(t){if(t=t.trim(),/^file:/.test(t)&&(t=t.replace(/file:\/\/\/(\w:)?/,function(i,o){return o?"":"/"})),t in pa)return pa[t];var e="";try{if(So)So.existsSync(t)&&(e=So.readFileSync(t,"utf8"));else{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),r.readyState===4&&r.status===200&&(e=r.responseText)}}catch(i){}return pa[t]=e});function Sw(t,e){if(!t)return e;var r=ww.dirname(t),i=/^\w+:\/\/[^\/]*/.exec(r),o=i?i[0]:"",n=r.slice(o.length);return o&&/^\/\w\:/.test(n)?(o+="/",o+ww.resolve(r.slice(o.length),e).replace(/\\/g,"/")):o+ww.resolve(r.slice(o.length),e)}function TU(t){var e;if(Tw())try{var r=new XMLHttpRequest;r.open("GET",t,!1),r.send(null),e=r.readyState===4?r.responseText:null;var i=r.getResponseHeader("SourceMap")||r.getResponseHeader("X-SourceMap");if(i)return i}catch(a){}e=vw(t);for(var o=/(?:\/\/[@#][\s]*sourceMappingURL=([^\s'"]+)[\s]*$)|(?:\/\*[@#][\s]*sourceMappingURL=([^\s*'"]+)[\s]*(?:\*\/)[\s]*$)/mg,n,s;s=o.exec(e);)n=s;return n?n[1]:null}var Mw=Id(os);os.push(function(t){var e=TU(t);if(!e)return null;var r;if(wU.test(e)){var i=e.slice(e.indexOf(",")+1);r=bU(i,"base64").toString(),e=t}else e=Sw(t,e),r=vw(e);return r?{url:e,map:r}:null});function Pw(t){var e=rc[t.source];if(!e){var r=Mw(t.source);r?(e=rc[t.source]={url:r.url,map:new yU(r.map)},e.map.sourcesContent&&e.map.sources.forEach(function(o,n){var s=e.map.sourcesContent[n];if(s){var a=Sw(e.url,o);pa[a]=s}})):e=rc[t.source]={url:null,map:null}}if(e&&e.map&&typeof e.map.originalPositionFor=="function"){var i=e.map.originalPositionFor(t);if(i.source!==null)return i.source=Sw(e.url,i.source),i}return t}function ZI(t){var e=/^eval at ([^(]+) \((.+):(\d+):(\d+)\)$/.exec(t);if(e){var r=Pw({source:e[2],line:+e[3],column:e[4]-1});return"eval at "+e[1]+" ("+r.source+":"+r.line+":"+(r.column+1)+")"}return e=/^eval at ([^(]+) \((.+)\)$/.exec(t),e?"eval at "+e[1]+" ("+ZI(e[2])+")":t}function vU(){var t,e="";if(this.isNative())e="native";else{t=this.getScriptNameOrSourceURL(),!t&&this.isEval()&&(e=this.getEvalOrigin(),e+=", "),t?e+=t:e+="<anonymous>";var r=this.getLineNumber();if(r!=null){e+=":"+r;var i=this.getColumnNumber();i&&(e+=":"+i)}}var o="",n=this.getFunctionName(),s=!0,a=this.isConstructor(),m=!(this.isToplevel()||a);if(m){var u=this.getTypeName();u==="[object Object]"&&(u="null");var p=this.getMethodName();n?(u&&n.indexOf(u)!=0&&(o+=u+"."),o+=n,p&&n.indexOf("."+p)!=n.length-p.length-1&&(o+=" [as "+p+"]")):o+=u+"."+(p||"<anonymous>")}else a?o+="new "+(n||"<anonymous>"):n?o+=n:(o+=e,s=!1);return s&&(o+=" ("+e+")"),o}function eR(t){var e={};return Object.getOwnPropertyNames(Object.getPrototypeOf(t)).forEach(function(r){e[r]=/^(?:is|get)/.test(r)?function(){return t[r].call(t)}:t[r]}),e.toString=vU,e}function tR(t,e){if(e===void 0&&(e={nextPosition:null,curPosition:null}),t.isNative())return e.curPosition=null,t;var r=t.getFileName()||t.getScriptNameOrSourceURL();if(r){var i=t.getLineNumber(),o=t.getColumnNumber()-1,n=/^v(10\.1[6-9]|10\.[2-9][0-9]|10\.[0-9]{3,}|1[2-9]\d*|[2-9]\d|\d{3,}|11\.11)/,s=n.test(process.version)?0:62;i===1&&o>s&&!Tw()&&!t.isEval()&&(o-=s);var a=Pw({source:r,line:i,column:o});e.curPosition=a,t=eR(t);var m=t.getFunctionName;return t.getFunctionName=function(){return e.nextPosition==null?m():e.nextPosition.name||m()},t.getFileName=function(){return a.source},t.getLineNumber=function(){return a.line},t.getColumnNumber=function(){return a.column+1},t.getScriptNameOrSourceURL=function(){return a.source},t}var u=t.isEval()&&t.getEvalOrigin();return u&&(u=ZI(u),t=eR(t),t.getEvalOrigin=function(){return u}),t}function SU(t,e){xw&&(pa={},rc={});for(var r=t.name||"Error",i=t.message||"",o=r+": "+i,n={nextPosition:null,curPosition:null},s=[],a=e.length-1;a>=0;a--)s.push(`
    at `+tR(e[a],n)),n.nextPosition=n.curPosition;return n.curPosition=n.nextPosition=null,o+s.reverse().join("")}function rR(t){var e=/\n    at [^(]+ \((.*):(\d+):(\d+)\)/.exec(t.stack);if(e){var r=e[1],i=+e[2],o=+e[3],n=pa[r];if(!n&&So&&So.existsSync(r))try{n=So.readFileSync(r,"utf8")}catch(a){n=""}if(n){var s=n.split(/(?:\r\n|\r|\n)/)[i-1];if(s)return r+":"+i+`
`+s+`
`+new Array(o).join(" ")+"^"}}return null}function MU(t){var e=rR(t);process.stderr._handle&&process.stderr._handle.setBlocking&&process.stderr._handle.setBlocking(!0),e&&(console.error(),console.error(e)),console.error(t.stack),process.exit(1)}function PU(){var t=process.emit;process.emit=function(e){if(e==="uncaughtException"){var r=arguments[1]&&arguments[1].stack,i=this.listeners(e).length>0;if(r&&!i)return MU(arguments[1])}return t.apply(this,arguments)}}var EU=is.slice(0),DU=os.slice(0);fa.wrapCallSite=tR;fa.getErrorSource=rR;fa.mapSourcePosition=Pw;fa.retrieveSourceMap=Mw;fa.install=function(t){if(t=t||{},t.environment&&(tc=t.environment,["node","browser","auto"].indexOf(tc)===-1))throw new Error("environment "+tc+" was unknown. Available options are {auto, browser, node}");if(t.retrieveFile&&(t.overrideRetrieveFile&&(is.length=0),is.unshift(t.retrieveFile)),t.retrieveSourceMap&&(t.overrideRetrieveSourceMap&&(os.length=0),os.unshift(t.retrieveSourceMap)),t.hookRequire&&!Tw()){var e=QI(bw,"module"),r=e.prototype._compile;r.__sourceMapSupport||(e.prototype._compile=function(n,s){return pa[s]=n,rc[s]=void 0,r.call(this,n,s)},e.prototype._compile.__sourceMapSupport=!0)}if(xw||(xw="emptyCacheBetweenOperations"in t?t.emptyCacheBetweenOperations:!1),YI||(YI=!0,Error.prepareStackTrace=SU),!XI){var i="handleUncaughtExceptions"in t?t.handleUncaughtExceptions:!0;try{var o=QI(bw,"worker_threads");o.isMainThread===!1&&(i=!1)}catch(n){}i&&xU()&&(XI=!0,PU())}};fa.resetRetrieveHandlers=function(){is.length=0,os.length=0,is=EU.slice(0),os=DU.slice(0),Mw=Id(os),vw=Id(is)}});var GS=T(require("commander")),KS=T(require("process"));var VS=T(require("process"));function Xl(t){return t!=null&&typeof t!="string"&&typeof t[Symbol.iterator]=="function"}function h(t){return t==null?"":typeof t=="string"?t:Array.isArray(t)?t.map(h).join(","):t.toString()}var cR=["number","string","boolean"];function si(t){return cR.indexOf(typeof t)!==-1||t instanceof Date}function ic(t){return Array.isArray(t)&&t.every(si)}var Aw=["boolean","number","bigint","symbol","string","object","function"];function Vt(t,e){if(t==null&&e==null)return 0;if(t==null)return-1;if(e==null)return 1;let r=typeof t,i=typeof e;return(r==="string"||r==="symbol")&&(i==="string"||i==="symbol")?h(t).localeCompare(h(e)):Array.isArray(t)&&Array.isArray(e)?fR(t,e):r!==i?Aw.indexOf(r)-Aw.indexOf(i):t>e?1:t<e?-1:0}function Di(t,e){return Vt(t,e)<0}function Fw(t,e){return Vt(t,e)<=0}function ji(t,e){return Vt(t,e)>=0}function Zl(t,e){return Vt(t,e)>0}function fR(t,e){if(R(t)&&R(e))return 0;let r=Math.min(t.length,e.length);for(let i=0;i<r;i++){let o=Vt(t[i],e[i]);if(o!==0)return o}return Vt(t.length,e.length)}var ai;(function(t){t[t.Empty=0]="Empty",t[t.Primitive=1]="Primitive",t[t.Symbol=2]="Symbol",t[t.Object=3]="Object",t[t.Array=4]="Array",t[t.Iterable=5]="Iterable",t[t.Instance=6]="Instance",t[t.Function=7]="Function",t[t.Unknown=8]="Unknown"})(ai||(ai={}));function pR(t){return typeof t=="symbol"}function ve(t){return typeof t=="function"}function oc(t){return dR(t)===3}function dR(t){return t==null?0:pR(t)?2:si(t)?1:Array.isArray(t)?4:Xl(t)?5:ve(t)?7:typeof t=="object"?t.constructor!=null&&t.constructor.name==="Object"?3:6:8}function Ir(t){return ve(t)?t():t}var Hi=()=>{};function f(t,e){return t==null?void 0:e(t)}function ss(t,e,r){return t==null||e==null?void 0:r(t,e)}function Lw(t,e,r,i){return t==null||e==null||r==null?void 0:i(t,e,r)}function x(t,e){return t??Ir(e)}function $(t,e,r){return t!=null?e(t):Ir(r)}function un(t,e,r,i){return x(ss(t,e,r),i)}function Gi(t){return t!=null}function nc(t){return t!=null&&t.every(Gi)}function Iw(...t){return t.find(Gi)}function da(t){return t==null||h(t)==="null"?void 0:t}function S(t){if(t==null)return!0;let e=h(t);return e.length===0||e.trim().length===0}var hR=/^\s*(?:null|undefined)?\s*$/i;function ha(t){return t==null||hR.exec(t)!=null}function P(t){return!S(t)}function Od(t){if(t==null)return;let e=h(t);return e.length===0||e.trim().length===0?void 0:e}function Rr(t,e){if(t==null)return Ir(e);let r=h(t).trim();return r.length>0?r:Ir(e)}function kd(t,e){return S(t)?!1:e(t)}function U(t,e){if(t===!1||t==null||t==="")return;let r=h(t);return P(r)?e(r):void 0}function li(t,e,r){return x(U(t,e),r)}function ga(...t){for(let e of t)if(P(e))return e}function O(t,e,r,i){return JSON.stringify(t,gR(e,i),da(r))}function gR(t,e){let r=[],i=[],o=e??((n,s)=>r[0]===s?"[Circular ~]":"[Circular ~."+i.slice(0,r.indexOf(s)).join(".")+"]");return function(n,s){if(r.length>0){let m=r.indexOf(this);m>=0?(r.splice(m+1),i.splice(m,Infinity,n)):(r.push(this),i.push(n)),r.indexOf(s)>=0&&(s=o.call(this,n,s))}else r.push(s);return t==null?s:t.call(this,n,s)}}function Ai(t,e){return O(t)===O(e)}function Rw(t){return t!=null&&(Array.isArray(t)||isFinite(t.length)&&ve(t[Symbol.iterator])&&ve(t.push)&&ve(t.pop)&&ve(t.forEach)&&ve(t.some))}function lr(t,e,r){if(e==null)throw new Error("null key");if(t.has(e))return t.get(e);{let i=r();return i!=null&&t.set(e,i),i}}var _d;(function(W){W.isDefined=!1,W.isEmpty=!0,W.get=()=>{},W.exists=()=>!1;let o=()=>W;W.map=o,W.flatMap=o,W.filter=o,W.forEach=o,W.getOrElse=Ae=>Ae(),W.orElse=Ae=>z(Ae()),W.zip1=o,W.zip2=o,W.zip3=o})(_d||(_d={}));var Ow=_d,em=class{constructor(e){this.a=e;this.isDefined=!0;this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new em(e(this.a))}flatMap(e){let r=e(this.a);return kw(r)?r:z(r)}filter(e){return z(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,r){return z(e).flatMap(i=>r(this.a,i))}zip2(e,r,i){return z(e).flatMap(o=>z(r).flatMap(n=>i(this.a,o,n)))}zip3(e,r,i,o){return z(e).flatMap(n=>z(r).flatMap(s=>z(i).flatMap(a=>o(this.a,n,s,a))))}};function kw(t){return t instanceof em||t===Ow}function z(t){return kw(t)?t:t!=null?new em(t):Ow}function ne(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function tm(t,e){return ne(t)?e(t):void 0}var sc=t=>(e,r)=>ne(e)&&ne(r)&&t(e,r),rm=sc((t,e)=>t<e),as=sc((t,e)=>t<=e),ya=sc((t,e)=>t>e),Fi=sc((t,e)=>t>=e);function _w(t,e,r){return t==null||e==null?!1:Math.abs(t-e)<r}function yR(t){if(!ne(t))return;let e=Math.trunc(t);return e===0?Math.abs(e):e}function bR(t){return ve(t.toNumber)}function Nw(t,e){if(S(t))return e.defaultValue;if(ne(t))return e.nton(t);if(bR(t))return e.nton(t.toNumber());try{let r=e.ston(h(t));return ne(r)?e.nton(r):e.defaultValue}catch{return e.defaultValue}}function k(t,e){return Nw(t,y({defaultValue:void 0,nton:r=>yR(r),ston:parseInt},e))}function mi(t,e){return Nw(t,y({defaultValue:void 0,nton:r=>r,ston:parseFloat},e))}function B(t){return ne(t)&&t>0}function Bw(t,e){return ne(t)&&ne(e)&&t>e?t:void 0}function ac(t){return ne(t)&&t>=0}function ba(t,e){return z(t).flatMap(r=>k(r)).flatMap(e).get()}function Nd(t){let e=k(t);return B(e)?String(e):void 0}function wr(t,e){return ne(t)?e(t):void 0}function ls(t,e,r){return wr(t,i=>wr(e,o=>r(i,o)))}function Bd(t,e,r){return ne(t)?e(t):r}function Cw(t,e){return ne(t)?t:Ir(e)}function Xe(t){return t<0?-Math.round(-t):Math.round(t)}function Fe(t,e){if(t===0||e===0)return 0;let r=e-Xe(Math.ceil(Math.log10(Math.abs(t)))),i=Math.pow(10,Math.abs(r));return r<0?Xe(t/i)*i:Xe(t*i)/i}function Y(t,e,r){if(t>e||!ne(t)||!ne(e))throw new Error(`invalid clamp(${t}, ${e}, ${r})`);return ne(r)?r<t?t:r>e?e:r:Xe((t+e)/2)}function ye(t,e){if(!B(t))return[];let r=Math.round(t);return r<=0?[]:[...Array(r)].map((i,o)=>e(o))}function mr(t,e,r=[]){if(t=Math.ceil(t),e=Math.floor(e),e<t)return t;if(_(r)&&r.length+10>e-t){let o=Mo(t,e).filter(n=>!r.includes(n));return Oe(o,n=>n[mr(0,o.length)])}let i=Math.floor(Math.random()*(e-t))+t;return r.includes(i)?mr(t,e,r):i}var Vw="0123456789abcdefghijkmnopqrstuvwxyz";function im(t,e=Vw){let r="";for(let i=0;i<t;i++)r+=wR(e);return r}function wR(t=Vw){return t[mr(0,t.length)]}function Rt(t){return typeof t=="string"}function ui(t,e){return t=h(t),e=h(e),t.startsWith(e)?t:e+t}function Ht(t,e){return t=h(t),e=h(e),t.endsWith(e)?t:t+e}function ur(t,e=80){if(t==null)return"";let r=h(t);return r.length<=e?r:r.slice(0,e-1)+"\u2026"}var Po=/\r?\n/gm;function xR(t,e,r){r==null&&(r=t.length);for(let i=r;i>=0;i--)if(t.substr(i).startsWith(e))return i;return-1}function Eo(t,e={maxLineLen:75,prefix:""}){if(t.includes(`
`))return ae(t.split(Po).map(i=>Eo(i,e)));if(t=ui(h(t),e.prefix).trim(),t.length<=e.maxLineLen)return[t];let r=xR(t," ",e.maxLineLen);if(r>e.prefix.length)return[t.slice(0,r),...Eo(t.slice(r+1),e)];{let i=t.indexOf(" ",e.prefix.length+1);return i>0&&i<t.length-1?[t.slice(0,i),...Eo(t.slice(i+1),e)]:[t]}}function om(t,e,r){return e===""?t:t.split(e).join(r)}function Ki(...t){return t.join(" ").replace(/\s+/g," ").trim()}function A(t){return t==null?[]:Array.isArray(t)?t:Xl(t)?Array.from(t):[t]}function _(t){return Rw(t)&&t.length>0&&t.some(e=>e!=null)}function R(t){return!_(t)}function Oe(t,e){return _(t)?e(t):void 0}function zw(t,e,r){return _(t)?e(t):Ir(r)}function TR(t){return si(t)||ic(t)?t:t.valueOf()}function ae(t,e=[]){if(t==null)return e;for(let r of t)if(r!=null)if(Array.isArray(r))for(let i of r)i!=null&&e.push(i);else e.push(r);return e}function xr(t){return Do(F(t),TR)}function Cd(t,e){for(let r=0;r<t.length;r++)e[r]=t[r];return e.length=t.length,e}function Do(t,e){return Cd(te(t,e),t)}function te(t,e){return A(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:f(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>Vt(r.cmp,i.cmp)).map(r=>r.item)}function lc(t,e){return t!=null&&e!=null&&t.length===e.length&&t.every((r,i)=>r===e[i])}function mc(t,e){return lc(t.slice(0,e.length),e)}function wt(t,e){for(let r=0;r<t.length;)e(t[r],r,t)?r++:t.splice(r,1);return t}function Ao(t,e){if(t==null)return!1;for(let r of t)if(e.valueOf()===r.valueOf())return!0;return!1}function uc(t,e){return t==null||e==null?!1:e.every(r=>Ao(t,r))}function cc(t,e,r){let i=t.map(r);for(let o of e){let n=r(o);i.includes(n)||(t.push(o),i.push(n))}return t}function F(t){if(t==null)return[];let e=A(t);return e.every(Gi)?e:e.filter(Gi)}function cn(t){let e=A(t).filter(r=>!ha(h(r)));return Rt(e[0])?e.map(r=>h(r).trim()):e}function V(t){return A(t).map(e=>h(e).trim()).filter(e=>e.length>0)}function K(t){return Ji(F(t),e=>O(e))}function Ji(t,e=r=>O(r)){if(R(t))return[];let r=new Map;for(let i of t)if(i!=null){let o=e(i);o!=null&&lr(r,o,()=>i)}return[...r.values()]}function ci(t,e){return t.reduce((r,i,o)=>r+(e(i,o)?1:0),0)}function wa(t,e){return t.reduce((r,i,o)=>r+e(i,o),0)}function nm(t,e){if(t==null||e==null)return 0;if(t===e||(typeof t=="string"&&(t=t.split("")),typeof e=="string"&&(e=e.split("")),lc(t,e)))return t.length;let r=0;for(;t[r]===e[r];)r++;return r}function Mo(t,e,r=i=>i){return ms(t,e,1,r)}function ms(t,e,r=1,i=o=>o){let o=[];if(t<e)for(let n=t;n<e;n+=r)o.push(i(n));else for(let n=t;n>e;n-=r)o.push(i(n));return o}function fc(t,e){let r=new Set(e);return t.filter(i=>!r.has(i))}function pc(t){return t!=null?t[t.length-1]:void 0}function l(t,e){return new Uw(t,e).asMemoizedThunk()}var Uw=class{constructor(e,r){this.thunk=e;this.ttlMs=r;this.lastSet=0;this.listeners=[]}asMemoizedThunk(){let e=this.apply.bind(this);return e.set=this.set.bind(this),e.clear=this.clear.bind(this),e.unset=this.unset.bind(this),e.prior=this.prior.bind(this),e.refresh=this.refresh.bind(this),e.ttl=this.ttl.bind(this),e.setTTL=this.setTTL.bind(this),e.onChange=this.onChange.bind(this),e.toJSON=this.toJSON.bind(this),e.lastSetAgoMs=this.lastSetAgoMs.bind(this),e}async onSetResult(e,r){if(R(this.listeners))return;let i=await e,o=await r;if(!Ai(i,o))for(let n of this.listeners)n(o,i)}setResult(e){return this.lastSet=Date.now(),this.onSetResult(this.result,e),this.result=e}apply(){return(this.lastSet===0||this.ttlMs!=null&&this.lastSet+this.ttlMs<=Date.now())&&this.setResult(this.thunk()),this.result}set(e){return this.setResult(e)}unset(){this.setResult(void 0),this.lastSet=0}clear(){let e=this.result;return this.unset(),e}prior(){return this.result}refresh(){return this.setResult(this.thunk())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=e}onChange(e){this.listeners.push(e),f(this.result,e)}toJSON(){return"(Lazy)"}lastSetAgoMs(){return Date.now()-this.lastSet}};var M=1e3,E=60*M,Ot=60*E,xt=24*Ot,Ww=7*xt,qw=365.25*xt,QW=l(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));function xa(t){return t instanceof Date}function jw(t,e){return new Date(x(e,new Date).getTime()-t)}function $i(t){let e=xa(t)?t.getTime():ne(t)?t:Date.now();return Math.floor(e/M)}function us(t){let e=String(t);return e.length>=2?e:("0"+e).slice(-2)}function Hw(t){let e=xa(t)?t:new Date(t);return e.getFullYear()+us(e.getMonth()+1)+us(e.getDate())+us(e.getHours())+us(e.getMinutes())+us(e.getSeconds())}function fn(t){let e=xa(t)?t:new Date(t);return e.getFullYear()+"-"+us(e.getMonth()+1)+"-"+us(e.getDate())}function Se(...t){let e=Object.freeze(t),r={};for(let a of e)r[a]=a;let i=a=>a!=null&&e.includes(a),o=a=>a==null?-1:e.indexOf(a),n=(a,m)=>i(a)?a:Ir(m),s=(a,m)=>i(a)?m(a):void 0;return y(y({},r),{values:e,length:e.length,has:i,indexOf:o,validOrElse:n,mapValid:s})}var va=T(require("process"));function Vd(t){return typeof t=="boolean"}function L(t){if(typeof t=="boolean")return t;if(t==null)return!1;if(t===1)return!0;let e=String(t).toLowerCase();return["true","1"].includes(e)}function dc(t){return L(t)?!0:qr(t)?!1:void 0}function Gw(t){return L(t)?1:0}function qr(t){if(typeof t=="boolean")return!t;if(t==null)return!1;if(t===0)return!0;let e=String(t).toLowerCase();return["false","0"].includes(e)}function Ta(t,e){return L(t)?e():void 0}function vR(){switch(h(va.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return va.argv.some(t=>t.endsWith("mocha")||t.endsWith(".spec.js"))?"test":"production"}}var Fo=(()=>{let t=vR();return va.env.NODE_ENV=t,t})(),Kw=Fo==="development",fe=Fo==="test",Tt=Fo==="production";function cs(){return fe&&L(va.env.SINGLE_SPEC_TESTS)}var fi=Date.now();var Lo="PhotoStructure",Tr=l(()=>Lo+(Tt?"":`-${Fo}`));function Pe(t,e){return r=>`[${t}m${r}[${e}m`}var lq=Pe(30,39),fs=Pe(31,39),Sa=Pe(32,39),pn=Pe(33,39),hc=Pe(34,39),gc=Pe(35,39),yc=Pe(36,39),Jw=Pe(37,39),Ma=Pe(90,39),$w=Pe(91,39),mq=Pe(92,39),Qw=Pe(93,39),Yw=Pe(94,39),uq=Pe(95,39),cq=Pe(96,39),fq=Pe(97,39),Xw=Pe(40,49),pq=Pe(41,49),dq=Pe(42,49),hq=Pe(43,49),gq=Pe(44,49),yq=Pe(45,49),bq=Pe(46,49),wq=Pe(47,49),xq=Pe(100,49),Tq=Pe(101,49),vq=Pe(102,49),Sq=Pe(103,49),Mq=Pe(104,49),Pq=Pe(105,49),Eq=Pe(106,49),Dq=Pe(107,49);var ix=T(require("process"));function nt(t,e){return e!=null?e(t):typeof t=="string"?console.log(t):console.dir(t,{depth:3}),t}function vt(t){return t==null||typeof t!="object"?[]:Object.keys(t).filter(e=>typeof e=="string"&&(t.propertyIsEnumerable==null||t.propertyIsEnumerable(e)===!0))}function ct(t){return vt(t).map(e=>t[e])}function Ze(t){return vt(t).map(e=>[e,t[e]])}function ft(t,e){return typeof e!="object"&&(e={}),F(t).reduce((r,[i,o])=>nt(r,()=>{i!=null&&o!=null&&(r[i]=o)}),e)}function Li(t){if(t==null)return;let e=Ze(t).filter(([r,i])=>r!=null&&i!=null);return R(e)?void 0:ft(e)}function zd(t){if(t==null)return;let e=Ze(t).filter(([r,i])=>r!=null&&P(i));return R(e)?void 0:ft(e)}function dn(t,e,r={}){let i=F(Ze(t).sort(([o],[n])=>o.localeCompare(n,void 0,{sensitivity:"base"})).map(([o,n])=>e(o,n)));return ft(i.filter(([o,n])=>o!=null&&n!=null),r)}function et(t,...e){if(t==null)return t;if(!e.every(i=>typeof i=="string"))throw new Error("bad keys: "+O(e));if(R(e))return{};let r={};for(let i of e){let o=t[i];o!=null&&(r[i]=o)}return r}function Gt(t,...e){if(t==null||e.every(i=>S(t[i])))return t;let r=Ze(t).filter(([i])=>!e.includes(i));return R(r)?void 0:ft(r)}function bc(t){return ct(t).every(e=>e!=null)}function ps(t){return bc(t)?t:void 0}function Zw(t){return t.filter(bc)}function ex(t){return ft(te(Ze(t),([e])=>e.toLowerCase()))}function tx(t,e){return t==null?t:ft(Ze(t).filter(([r,i])=>e(r,i)))}function wc(t,e,...r){return t!=null&&ve(t[e])?t[e].bind(t)(...r):void 0}function rx(t,e){if(S(e))return;if(t[e]!=null)return t[e];let r=e.toLocaleLowerCase().normalize();for(let i of vt(t))if(r===i.toLocaleLowerCase().normalize()&&t[i]!=null)return t[i]}function Ve(t){return rx(ix.env,t)}function Io(t){return L(Ve(t))}var ox=T(require("util"));var SR=require("deep-eql");function kt(t,e){return SR(t,e)}async function ds(t,e){return un(await t,await e,kt,()=>!1)}async function Ud(t,e,...r){return un(await t,await e,(i,o)=>kt(et(i,...r),et(o,...r)),()=>!1)}function xc(...t){return t!=null&&t.every(P)}function nx(t){return t==null||t.some(e=>e==null)}function tt(t,e){if(t!=null)for(let r of F(t)){let i=e(r);if(i!=null)return i}}async function Tc(t,e){if(t!=null){let r=-1;for(let i of t){r++;try{if(i==null)continue;let o=await e(i,r);if(o!=null)return o}catch(o){}}}}function sx(t,e){for(let r=t.length-1;r>=0;r--)if(e(t[r]))return t[r]}function vc(...t){let e=[];for(let r of t)if(Array.isArray(r))for(let i of r)i!=null&&e.push(i);else r!=null&&e.push(r);return e}function sm(t,...e){let r=t.length;return wt(t,i=>e.every(o=>!kt(i,o))),r!==t.length}var ax=t=>{if(si(t))return t;if(Array.isArray(t))return O(t);if(ve(t.valueOf))return t.valueOf();throw new Error("Cannot get primitive value for "+(0,ox.inspect)(t))};function Wd(t,e,r=ax){let i=new Set(e.map(r));return t.filter(o=>i.has(r(o)))}function lx(t,e,r=ax){return R(t)&&R(e)?1:Wd(t,e,r).length*2/(t.length+e.length)}function mx(t,e=r=>O(r)){Cd(Ji(t,e),t)}function Pa(t,e){let r=[],i=[];return t.forEach((o,n)=>(e(o,n)?r:i).push(o)),[r,i]}function cx(t){return ux(t.sort())}function ux(t){if(t==null||t.length===0)return[];let e=t[0],r=t.lastIndexOf(e);return[{t:e,count:r+1},...ux(t.slice(r+1))]}function fx(t,e){return t.reduce((r,i)=>r.concat(...F(e(i))),[])}function Sc(t,e){return t.length>e&&t.splice(0,t.length-e),t}function px(t,e){return t.length=Math.min(t.length,e),t}function hs(...t){let e=Math.max(...t.map(r=>r.length));return ye(e,r=>t.map(i=>i[r]))}function dx(...t){let e=Math.max(...t.map(i=>i.length)),r=[];return ye(e,i=>t.map(o=>r.push(o[i]))),r}function hx(t){return ye(t.length,e=>t.slice(0,e+1))}function qd(t){return Mc(t,e=>e.valueOf())}function Pc(t){return t[gx(t)]}function gx(t){return yx(t,e=>e.valueOf())}function Mc(t,e){return bx(t,e,(r,i)=>Di(r,i))}function yx(t,e){return bx(t,e,(r,i)=>Zl(r,i))}function Ii(t,e){return t[Mc(t,e)]}function st(t,e){return t[yx(t,e)]}function bx(t,e,r){if(R(t))return-1;let i=-1,o;for(let n=0;n<t.length;n++){let s=t[n];if(s!=null){let a=e(s);a!=null&&(o==null||r(a,o)===!0)&&(i=n,o=a)}}return i}function Ea(t,e){return e<=0&&(e=1),ms(0,t.length,e,r=>t.slice(r,r+e))}var Lx=T(require("util"));var gs=class{constructor(e){this.maxLength=e;this._length=0;this._firstIndex=0;if(e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...ye(e,()=>null))}mapIndex(e,r){return e=Math.trunc(e)??0,e<0&&(e+=this._length),e<0||e>this._length-1?void 0:r((e+this._firstIndex+this.maxLength)%this.maxLength)}item(e){return this.mapIndex(e,r=>this.store[r])}set(e,r){return this.mapIndex(e,i=>this.store[i]=r)}get length(){return this._length}set length(e){this._length=Y(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){let e=this;function*r(){for(let i=0;i<e.length;i++)yield e.mapIndex(i,o=>e.store[o])}return r()}push(...e){for(let r of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,i=>{this.store[i]=r});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(let r of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,i=>{this.store[i]=r,this._firstIndex=i});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}shiftOrFirst(){return this.length>1?this.shift():this.item(0)}every(e){for(let r=0;r<this._length;r++)if(!e(this.item(r),r))return!1;return!0}some(e){for(let r=0;r<this._length;r++)if(e(this.item(r),r))return!0;return!1}forEach(e){for(let r=0;r<this._length;r++)e(this.item(r),r)}map(e){let r=[];for(let i=0;i<this._length;i++)r.push(e(this.item(i),i));return r}reduce(e,r){let i=r;for(let o=0;o<this._length;o++)i=e(i,this.item(o),o);return i}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,r=>{this.mapIndex(this._length-1-e,i=>{let o=this.store[i];this.store[i]=this.store[r],this.store[r]=o})});return this}toA(){return[...this]}slice(e,r){return[...this].slice(e,r)}};var MR=require("he"),am={};function ys(t,e){if(e<1)return"";for(am[t]==null&&(am[t]=t);e>am[t].length;)am[t]+=t;return am[t].substring(0,e)}function cr(t,e,r){if(r.length===0)throw new Error("leftPad() given empty pad");if(typeof t=="number"&&t<0)return"-"+cr(String(-t),e-1,r);let i=String(t);return ys(r,e-i.length)+i}function wx(t,e,r){if(r.length===0)throw new Error("rightPad() given empty pad");let i=String(t);return i+ys(r,e-i.length)}function Kt(t){return cr(t,2,"0")}function xx(t,e,r,i){return t.substr(0,e)+ys(i,r)+t.substr(e+r)}function Qi(t,e,r){let i=Math.min(Math.ceil(t.length/e),x(r,()=>t.length))-1;return i<=0?[t]:[...ye(i,o=>t.slice(o*e,(o+1)*e)),t.slice(i*e)]}function jd(t,e){let r=e.exec(t);if(r==null||r[1]==null)return;let i=r[0].indexOf(r[1])+r.index;return{captured:r[1],uncaptured:t.substring(0,i)+t.substring(i+r[1].length),unmatched:t.substring(0,r.index)+t.substring(r.index+r[0].length),matchedIndex:i}}function Ge(t,e){let r=h(t),i=h(e);return i.length>0&&r.startsWith(i)?r.slice(i.length):r}function Ec(t,e){return t=h(t),e=h(e),Tx(t,e)?t.slice(e.length):t}function zt(t,e){if(e==null)return t;let r=h(t),i=h(e);return i.length>0&&r.endsWith(i)?r.slice(0,-i.length):r}function vx(t,e,r){return e==null?zt(t,r):(t=h(t),t.endsWith(r)&&t.startsWith(e)?t.slice(e.length,-r.length):t)}function Sx(t,e=80,r=80){let i=h(t),o=i.length-(e+r);return o<=0?i:i.slice(0,e).trim()+" \u2026(+"+o+" chars)\u2026"+i.slice(-r).trim()}function Dc(t){t=h(t);let e=t.normalize().split("");return S(t)?t:e[0].toLocaleUpperCase()+e.slice(1).join("")}function Hd(t,e){return t.localeCompare(e,void 0,{sensitivity:"base"})}function at(t,e){if(t==null||e==null)return!1;let r=h(t),i=h(e);return r.length!==i.length?!1:r===i||r.toLowerCase()===i.toLowerCase()?!0:r.localeCompare(i,void 0,{sensitivity:"base"})===0||Hd(r.normalize(),i.normalize())===0}function Gd(t){return t.sort(Hd)}function Mx(t,e){return A(t).filter(r=>r!=null).map((r,i)=>({item:r,cmp:f(e(r,i),o=>[o,i])})).filter(r=>r.cmp!=null).sort((r,i)=>{let o=Hd(r.cmp[0],i.cmp[0]);return o!==0?o:Vt(r.cmp[1],i.cmp[1])}).map(r=>r.item)}function Tx(t,e){return t==null||e==null||e.length===0||t.length===0?!1:at(t.substring(0,e.length),e)}function hn(t,e){return R(t)||S(e)?!1:t.some(r=>at(e,r))}function Yi(t){return h(t).replace(/\u001b\[[0-9;]+[a-z]/gi,"")}var PR=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function Kd(t){return PR.reduce((e,[r,i])=>e.replace(r,i),t).normalize()}var ER=/^(['"]).+\1$/;function Jd(t){return S(t)||(t=h(t).trim(),ER.exec(Kd(t))!=null&&(t=t.slice(1,-1).trim())),t}function Da(t){return t.split(/(?<=[\\/_,:=-]+)/).map(e=>MR.escape(e.normalize())).join("<wbr>")}function $d(t){return h(t).normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function Px(t){return h(t).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")}function Ex(t){let e=Gd(V(t)),r=e.filter((i,o)=>!Tx(e[o+1],i));return te(r,i=>t.indexOf(i))}function bs(...t){return t.find(B)}function Qd(...t){for(let e of ae(t)){let r=mi(e);if(r!=null&&r!==0)return r}}function Ro(t,e){return ba(t,r=>r>=0?e(r):void 0)}function Dx(t,e,r){return x(Ro(t,e),r)}function Aa(t,e){return wr(t,r=>r>=0?e(r):void 0)}function we(t,e){return ba(t,r=>r>0?e(r):void 0)}function ws(t,e,r){return x(we(t,e),r)}function St(t,e,r){return r==null||!ne(r)?!1:([t,e]=[Math.min(t,e),Math.max(t,e)],Fi(r,t)&&as(r,e))}var DR=/[+-]?[0-9\,\.]+/;function lm(t){if(ne(t))return t;if(S(t))return;let e=String(t);return f(DR.exec(e),r=>mi(e.substr(r.index)))}function Ax(t){return k(lm(t))}function Fx(t,e){if(t===e)return 1;if(t.length!==e.length)throw new Error(`hammRatioBinaryString(${t}, ${e}): invalid lengths`);let r=0;for(let i=0;i<t.length;i++)t[i]===e[i]&&r++;return Y(0,1,2*r/t.length-1)}var vr=class{constructor(e=20){this.maxSamples=e;this._n=0,this._samples=new gs(e)}static merge(e,r){if(e.n===0&&r.n===0)return new vr(Math.max(e.maxSamples,r.maxSamples));if(e.n===0)return r.clone();if(r.n===0)return e.clone();if(e.n<=e.maxSamples){let i=r.clone();return i.pushAll(e.samples),i}else if(r.n<=r.maxSamples){let i=e.clone();return i.pushAll(r.samples),i}else{let i=new vr(Math.max(e.maxSamples,r.maxSamples));i._n=e.n+r.n,i._avg=e._avg*e.n/i.n+r._avg*r.n/i.n,i._min=Math.min(e._min,r._min),i._max=Math.max(e._max,r._max),i._m=e._m*e.n/i.n+r._m*r.n/i.n,i._s=e._s*e.n/i.n+r._s*r.n/i.n;let o=ae(hs(e.samples,r.samples));return i._samples.push(...o),i._weightedTotalAvg=mm([i._avg,...o]),i}}[Lx.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=this._min==null?e:Math.min(e,this._min),this._max=this._max==null?e:Math.max(e,this._max),this._n===1||this._m==null||this._s==null||this._avg==null||this._weightedTotalAvg==null)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{let r=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-r)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return nt(new vr(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){return e.forEach(r=>this.push(r)),this}stats(e=2){let r=o=>f(o,n=>Fe(n,e)),i={};return this.empty||(i.sum=r(this.sum),i.mean=r(this.avg),i.sd=r(this.stdDev)),i.k=Fe(this.n,e),i}get empty(){return this._n===0}get n(){return this._n}get avg(){return this.empty?void 0:Fe(this._avg,4)}get sum(){return this._avg==null||this.empty?0:this._avg*this._n}get max(){return this._max}get min(){return this._min}get p84(){return we(this.avg,e=>we(this.stdDev,r=>e+r))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return f(this.variance,Math.sqrt)}get sampleMode(){return f(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;let r=new xs;return this._samples.forEach(i=>r.incr(i)),r.topKeys(e)}get sampleStdDev(){return Oe(this._samples,Rx)}get sampleAvg(){return Oe(this._samples,_t)}get sampleSlope(){return x(Oe(this._samples,Ix),0)}get samples(){return[...this._samples]}p(e){if(this._samples.length===0)return 0;let r=[...this._samples].sort((o,n)=>o-n),i=Math.floor(r.length*(e/100));return r[i]}get weightedSampleAvg(){return Oe(this._samples,e=>Fe(mm(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}};var xs=class{constructor(){this.m=new Map}incr(e,r=1){let i=this.get(e)+r;return i===0?this.m.delete(e):this.m.set(e,i),this}get(e){return x(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){let e=new vr(0);for(let r of this.keys())if(ne(r))e.push(r);else return;return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){let e=this.keyAvg();return te([...this.entries()],([r,i])=>[-i,Bd(e,o=>Math.abs(r-o),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(r=>r[0])}get averageCounts(){return nt(new vr(this.size),e=>[...this.m.values()].forEach(r=>e.push(r)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return xr([...this.keys()]).map(e=>e+" "+this.get(e)).join(`
`)}};function Ox(t){return t instanceof Set?t:new Set(A(t))}function Ac(t,e){return new Set([...t,...e])}function Yd(t,e){let r=Ox(e);return new Set([...t].filter(i=>r.has(i)))}function kx(t,e){let r=Ox(e);return new Set([...t].filter(i=>!r.has(i)))}function Fc(t){let e;for(let r of t)r!=null&&(e==null||r<e)&&(e=r);return e}function _x(t){let e;for(let r of t)r!=null&&(e==null||r>e)&&(e=r);return e}function Xd(t,e){let r=new xs;return A(t).forEach(i=>tm(i,o=>r.incr(o))),r.topKeys(e)}function Zd(t){return Xd(t,1)[0]}function gn(t){return A(t).reduce((e,r)=>ne(r)?e+r:e,0)}function _t(t){let e=F(A(t));return R(e)?void 0:e.reduce((r,i,o)=>o===0?i:r*o/(o+1)+i/(o+1),0)}function Ix(t){let e=A(t);return f(_t(e),r=>{let i=(e.length-1)/2,o=gn(e.map((s,a)=>(s-r)*(a-i))),n=gn(e.map(s=>(s-r)**2));return n===0?0:o/n})}function AR(t){return f(_t(t),e=>_t(t.map(r=>Math.pow(r-e,2))))}function Rx(t){return f(AR(t),e=>Math.sqrt(e))}function mm(t){let e;for(let r of t)e=e==null?r:(e+r)/2;return e??NaN}function eh(t,e){let r=0;return t.reduce((i,o,n)=>{let s=ws(e[n],a=>a,1);return r+=s,i+o*s},0)/r}var yn=class{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return gn([...this.store.values()].map(e=>e.length))}add(e,...r){let i=lr(this.store,e,()=>[]);return i.push(...r),i}set(e,r){this.store.set(e,r)}delete(e,r){if(r==null)return this.store.delete(e);{let i=this.store.get(e);if(i==null)return!1;{let o=sm(i,r);return o&&i.length===0&&this.store.delete(e),o}}}clear(){return this.store.clear(),this}keys(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield i)}return r()}values(){let e=this;function*r(){for(let[,i]of e.store.entries())i.length>0&&(yield i)}return r()}flatValues(){let e=this;function*r(){for(let[,i]of e.store.entries())if(i.length>0)for(let o of i)yield o}return r()}entriesArray(){return[...this.store.entries()].filter(([,e])=>_(e))}entries(){let e=this;function*r(){for(let[i,o]of e.store.entries())o.length>0&&(yield[i,o])}return r()}tuples(){let e=this;function*r(){for(let[i,o]of e.store.entries())for(let n of A(o))n!=null&&(yield[i,n])}return r()}filterInPlace(e){let r=!1;for(let[i,o]of this.store.entries()){let n=o.length;wt(o,s=>e(i,s)),r=r||n!==o.length}return r}};function th(t,e){let r=new yn;return t.forEach(i=>f(e(i),o=>r.add(o,i))),r}function Xi(...t){for(let e of t){let r=e();if(r!=null)return r}}function Nx(t,e){for(let r of t){let i=r();if(i!=null&&(e==null||e(i)))return i}}function ze(t,e){try{return t()}catch(r){return e!=null?e(r):void 0}}function jr(t){return t}function Fa(t,e){if(e==null)return t;for(let[r,i]of Ze(e))i!=null&&(t[r]=i);return t}function La(t,e){let r={};for(let i of vt(t)){let o=e(i,t[i]);o!=null&&(r[i]=o)}return r}function Bx(t,e){return t==null?!1:vt(t).every(r=>kt(t[r],e[r]))}async function Cx(t){let e=await t;return ve(e)?e():e}function gt(t){return Vx(t,!0)}function fr(t){return Vx(t,!1)}function Vx(t,e){return new Promise(r=>{if(t<=0)r();else{let i=setTimeout(()=>r(),Math.ceil(t+.5));e&&i.unref!=null&&ve(i.unref)&&i.unref()}})}function C(t,e=1){return setTimeout(t,Math.max(1,Math.ceil(e)))}async function xe(t,e,r=()=>{},i=()=>{}){let o=!1,n=!1,s;return await Promise.race([Cx(t).then(a=>{if(!n)return s=a,o=!0,a}),gt(e).then(()=>{o||(n=!0)})]),o?await i(s):await r(),s}var Lc=T(require("timers"));function Ia(t,e,...r){return nt((0,Lc.setTimeout)(t,Math.round(e),...r),i=>i.unref())}function Hr(t,e,...r){return nt((0,Lc.setInterval)(t,Math.round(e),...r),i=>i.unref())}var Ts=l(()=>d(gc("Endable"))),Ic=new yn;Hr(()=>zx(),1*E);var FR=5*M,ue=Se("first","service","predb","db","postdb","logger");function um(t){return bn(ue.first,t)}function Ux(t){return bn(ue.service,t)}function Wx(t){return bn(ue.db,t)}function qx(t){return bn(ue.logger,t)}function bn(t,e){return ue.validOrElse(t,()=>{throw new Error("internal error: invalid rank "+t)}),Ic.add(t,e),e}var jx=!1;function G(){return jx}async function Ri(t,e){let r=await t;if(r==null||r.ended)return;let i=fe&&Io("SINGLE_SPEC_TESTS")?100:bs(e,r.endTimeoutMs,FR);return Ts().debug(r.name+" ending...",{timeoutMs:i}),xe(r.end(),i,()=>Ts().warn(r.name+".end() timed out"),()=>Ts().debug(r.name+".end() completed")).catch(o=>{ze(()=>Ts().warn(r.name+".end() rejected: "+o))})}function zx(){Ic.filterInPlace((t,e)=>!e.ended),Ts().debug("vacuumEndables()",Ic.entriesArray().map(([t,e])=>[t,e.map(r=>r.name)]))}var Hx=l(async()=>{let t=cs()?250:void 0;Ts().info("endEndables()",{isTest:fe,isSingleSpecTests:cs}),fe||(jx=!0),zx();for(let e of ue.values){let r=x(Ic.get(e),[]);_(r)&&(Ts().debug("endEndables(): ending "+e),await Promise.all(r.map(i=>Ri(i,t))))}});var wS=T(require("os")),il=T(require("path"));var LR=Se("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),rh=LR.values,jj=Se("s480","s240","s120","s60"),Gx=[60,120,240,480];var ih=l(()=>new Intl.NumberFormat),Xj=l(()=>om(ih().format(1111),"1","").charAt(0)),Zj=l(()=>om(ih().format(1.1),"1","").charAt(0));function Rc(t){return ih().format(t)}var oh=1e3,qe=oh*1e3,Sr=qe*1e3,eH=Sr*1e3,nh=1024,Zi=nh*1024,cm=Zi*1024,tH=cm*1024,IR=["B","KB","MB","GB","TB","PB"];function Ut(t,e=3){if(t===0)return"0";if(!ne(t))return"-";let r=Math.floor(Math.log10(t)),i=Math.floor(r/3),o=Math.pow(10,i*3),n=IR[i];return Fe(t/o,e)+" "+n}var RR=1e6;function Oc(t){return Fe(t/RR,2)}var rH=Se("tiny","small","medium","large","original");function Kx(t){return t<320*240?"tiny":t<720*480?"small":t<1920*1080?"medium":"large"}function kc(t,e,r=e+"s"){return Rc(t)+" "+(t===1?e:r)}function _c(t,e,r=e+"s"){return{count:Rc(t),desc:t===1?e:r}}var ja=T(require("fs")),Tm=T(require("fs-extra")),Zt=T(require("path")),MT=T(require("zlib"));async function b(t,e){let r=await t;return r==null?void 0:e(r)}async function le(t,e){let r=[];for(let i of A(await t))if(i!=null){let o=await i;if(o!=null){let n=await e(o);n!=null&&r.push(n)}}return r}async function Jx(t,e=console.dir.bind(console)){let r=await t;return await e(r),r}var Wt=class{constructor(e){this.id=e;this._state="pending";this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i})}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve(),r=>this.reject(r)),this}observeQuietly(e){return e.then(()=>this.resolve(),()=>this.resolve()),this}get pending(){return this._state==="pending"}get settled(){return!this.pending}get resolved(){return this._state==="resolved"}get rejected(){return this._state==="rejected"}get state(){return this._state}then(e,r){return this.promise.then(e,r)}};var ka=T(require("os"));var Qx=T(require("events"));var $x=T(require("events")),sh=class extends $x.EventEmitter{constructor(){super(...arguments);this.events=[]}emit(e,...r){return super.emit(e,...r),this.events.push({name:e,args:r}),!0}clear(){this.events.length=0}};var cH=l(()=>new sh),OR=l(()=>{let t=new Qx.EventEmitter;return t.setMaxListeners(50),t}),Me=OR();function fm(){d("EventEmitter").info("emitClearCache()"),Me.emit("clearCache")}function q(t){Me.on("clearCache",t)}function Yx(t){Me.on("idle",t)}function Xx(t){Me.emit("migration",t)}function Zx(){Me.emit("pause")}function Ra(t){Me.on("pause",t)}function eT(){Me.emit("resume")}function wn(t){Me.on("resume",t)}function Or(t){Me.emit("fileChanged",t)}function Oa(t){Me.on("fileCopied",t)}function ah(t,e){Me.emit("fileCopied",t,e)}function pr(t){Me.on("fileChanged",t)}function tT(t){Me.on("fatal",({message:e,error:r})=>t(e,r))}function Nc(t){Me.on("nonFatal",({message:e,error:r})=>t(e,r))}function rT(){Me.emit("volumesChanged")}function iT(t){Me.on("volumesChanged",t)}function oT(){Me.emit("settingsChanged")}function nT(t){Me.on("settingsChanged",t)}function sT(t){Me.on("vacuuming",t)}function aT(t){Me.on("writeRecentLogEntries",t)}C(()=>{q(()=>{lh.unset(),mh.unset(),yt.unset(),lT.unset(),pm.unset(),dm.unset(),kR.unset()})});var lh=l(()=>((0,ka.freemem)()*2+(0,ka.totalmem)())/3),mh=l(()=>(0,ka.cpus)().length),yt=l(()=>{let t=1*Sr,e=Math.max(1,Math.floor(lh()/t)),r=c.cpuLoadPercent.valueOrDefault/100*mh();return Y(1,e,Math.floor(r))}),lT=l(()=>{let t=500*qe,e=Math.floor(lh()/t),r=Math.max(1,Math.floor(1.5*mh()*(c.cpuLoadPercent.valueOrDefault/100)));return Y(1,r,e)}),pm=l(()=>Y(1,24,yt())),dm=l(()=>Y(1,6,Math.ceil(lT()/pm()))),kR=pm;var fh=T(require("timers")),fT=T(require("util"));function ce(t){if(ha(t))return"";let e=t instanceof Error?K(cn([h(t.name).trim(),U(t.code,r=>`code ${r.trim()}`),h(t.message).trim()])).join(": "):h(t);return ur(e,255)}function Jt(t){return t==null?"(undefined)":[ce(t),...A(uh(t.stack))].join(`
`)}function uh(t){return S(t)?void 0:h(t).split(`
`).slice(0,6)}function Bc(t){if(S(t))throw new Error("undefined error");if(t instanceof Error)return t;if(Array.isArray(t)){let e=t[0];return e instanceof Error?(t.length>1&&(e.errors=t.slice(1)),e):new Error(t.map(r=>h(r)).filter(P).join(", "))}else{let e=ce(t),r=e.indexOf(":");if(r>2&&r<15){let i=new Error(e.slice(r+1).trim());return i.name=e.slice(0,r).trim(),i}else return new Error(e)}}function Cc(t){return t instanceof Error}var Oo=Se("pending","resolved","rejected");var pe="\xB9",$t="\xB2",hm="\xB3",ko="\u2074",_a="\u2075",Gr="\u2076",Na="\u2077",_R=[pe,$t,hm,ko,_a,Gr,Na];function Vc(t,...e){return t+e.filter(r=>r!=null&&!t.includes(r)).join("")}var NR=/[â°Â¹Â²Â³â´âµâ¶â·â¸â¹ââââââââââ]/g;function zc(t){return t.replace(NR,"")}function mT(t){return t.split("").filter(e=>_R.includes(e)).join("")}function Uc(t){return ce(t).includes(ko)}var BR=[hm,"0 output files created","BatchCluster has ended, cannot enqueue","called while not idle","Can't set headers after they are sent","debugger attached","debugger listening on","diskutil: interrupted","ECONNRESET","end() called before task completed","EPIPE","for help","Format error in file","https://nodejs.org/en/docs/inspector","Invalid data found when processing input","Missing expected status message","net::ERR_","onExit(exit) called end()","This socket has been ended by the other party","Unexpected error while trimming","Warning"].map(t=>t.toLowerCase());function Qt(t){if(t==null)return!0;let e=ce(t).toLowerCase(),r=BR.some(i=>e.includes(i));return G()||!Uc(t)&&!eo(t)&&r}var CR=/SQLITE_BUSY|database is locked/i;function gm(t){return t.code==="SQLITE_BUSY"||ce(t).match(CR)!=null}function uT(t){return ce(t).match(/database .+ not open/i)!=null}function VR(t){return ce(t).match(/SQLITE_CONSTRAINT|constraint failed/i)!=null}function ch(t){return!eo(t)&&!ce(t).includes($t)&&!VR(t)&&!qr(t.retriable)}function cT(t){return!ch(t)}function Wc(t){if(Uc(t))return!1;if(L(t?.doNotSend))return!0;let e=ce(t).toLowerCase();return zR.some(r=>e.includes(r))||Qt(e)}var zR=[Gr,"Corrupt JPEG data","premature end of data segment","VipsJpeg"],UR=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+pe,"i");function eo(t){return t==null?!1:L(t.fatal)?!0:UR.exec(ce(t))!=null}var Mr=class{constructor(e){this.name=e;this.start=Date.now();this.state=Oo.pending;this.promise=new Promise((r,i)=>{this._resolve=r,this._reject=i}),this.logger=d("Deferred("+this.toString()+")")}toString(){return Rt(this.name)?this.name:O(this.name)}[fT.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(r=>{this.resolve(r)}).catch(r=>{this.logger.warn("observeQuietly.reject()",r),this.resolve(void 0)}),this}observe(e){return e.then(r=>{this.maybeResolve(r)}).catch(r=>{this.maybeReject(r)}),this}setTimeout(e){return f(this.priorTimeout,fh.clearTimeout),this.priorTimeout=Ia(()=>{if(this.pending){let r="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(r)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===Oo.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==Oo.pending}get resolved(){return this.state===Oo.resolved}get rejected(){return this.state===Oo.rejected}get settledMs(){return this.end==null?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=Oo.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(Qt(e)?"info":"warn",".reject()",e);let r=Bc(e);return this.settle(()=>{this._error=r,this.state=Oo.rejected,this._reject(r)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(r=>e(r))}settle(e){if(this.state===Oo.pending){f(this.priorTimeout,fh.clearTimeout),e(),this.end=Date.now();let r=this.settledMs;if(this.resolved&&r>5e3){let i=r>5e3?"info":"debug";this.logger.log(i,"Completed in "+r+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}};var Yt=class{constructor(){this._pushCount=0;this.lastPushTs=0;this._arr=[];this.nextSettledLatches=[];this.serialLatencyAvg=new vr;this.applyListeners=[]}get arr(){return wt(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}onApply(e){this.applyListeners.push(e)}_emitApply(e){for(let r of this.applyListeners)r(e)}push(e,r){return this._emitApply(e),this._push(e,r)}_push(e,r){this._pushCount++,this.lastPushTs=Date.now();let i=ve(r)?r():r;return this.arr.push(new Mr(e).observeQuietly(i).finally(()=>this.emitSettled())),i}emitSettled(){for(let e of this.nextSettledLatches)e.resolve();this.nextSettledLatches.length=0}awaitNextSettled(){let e=new Wt;return this.nextSettledLatches.push(e),e}serial(e,r){let i=Date.now();return this._push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}serialByName(e,r){let i=Date.now();return this._push(e,this.awaitAllByName(e).then(()=>(this.serialLatencyAvg.push(Date.now()-i),this._emitApply(e),r())))}oneRunAtATime(e,r){return this.pending?this.awaitAll():this.serial(e,r)}maybeRun(e,r){return this.maybeRunConcurrent(e,r,1)}maybeRunConcurrent(e,r,i=yt()){return this.pendingCount>=i?void 0:this.push(e,r)}get pendingCount(){return ci(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return this.arr.length===0}async awaitAll(){for(let e of[...this.arr])await e.promise}async awaitAllByName(e){for(let r of[...this.arr])r.name===e&&await r.promise}async pushAll({name:e,laters:r,maxConcurrent:i=yt()}){i=Y(1,yt()*2,i);let o=[];for(let n of r){for(;this.pendingCount>=i;)await this.awaitNextSettled();o.push(this.push(e,n))}return Promise.all(o)}};async function pi({name:t,laters:e,maxConcurrent:r}){return new Yt().pushAll({name:t,laters:e,maxConcurrent:r})}async function pT(t,e,r){let i=[];for(let o of Ea(A(await t),e)){let n=[];for(let s of o)if(s!=null){let a=await s;a!=null&&n.push(a)}for(let s of A(await r(n)))s!=null&&i.push(s)}return i}function dT(t,e){return Promise.race([t.then(()=>!0),gt(e).then(()=>!1)]).catch(()=>!1)}async function Ba(t){try{return await t,!0}catch(e){return!1}}async function hT(t){return!await Ba(t)}async function gT(t){return await t!=null}async function qc(t){let e=F(t);_(e)&&await Promise.all(e)}async function ym(t){let e=[];for(let r of A(await t)){let i=await r;if(i!=null)if(Array.isArray(i))for(let o of i){let n=await o;n!=null&&e.push(n)}else e.push(i)}return e}async function vs(t){let e=F(await t);return R(e)?[]:F(await Promise.all(e))}async function Ca(t,e,r){if(t==null)return[];let i=F(await t);return R(i)?[]:(await pi({name:"thenCollectParallel",laters:i.map((n,s)=>async()=>[await e(n,s),n]),maxConcurrent:r})).filter(([n,s])=>n!=null&&s!=null)}async function Va(t,e,r){return(await Ca(t,e,r)).map(i=>i[0])}async function xn(t,e,r){return(await Ca(F(t),e,r)).filter(([o])=>o).map(([,o])=>o)}var c5=30*M;async function Mt(t,e=!0){if(t==null)return e;let r=await t;return r==null?e:!L(r)}async function he(t,e,r){let i=await t;if(i==null)return r();let o=await e(i);return o??r()}async function za(t,e,r,i){let o=await t;if(o==null)return i();let n=await e;if(n==null)return i();let s=await r(o,n);return s??i()}async function Ee(t,e){return x(await t,e)}async function yT(t,e){for(let r of t)try{let i=await r();if(i!=null)return i}catch(i){e(i)}}async function bm(t,e){return te(await Ca(t,e),r=>r[0]).map(r=>r[1])}var bT=T(require("fs")),wm=T(require("os")),_o=T(require("process"));var xm=(0,wm.platform)(),w5=_o.default.argv.includes("--inspect")||L(_o.default.env.NODE_INSPECT),No=!h(__filename).includes("Platform"),I=xm==="win32"||xm==="cygwin",wT=I&&P(_o.default.env.PORTABLE_EXECUTABLE_DIR),re=xm==="darwin",Ue=xm==="linux",x5=Ue&&(0,wm.arch)()==="x64",ph=(0,wm.arch)()==="arm",WR=Ue&&ph,T5=Ue&&(P(_o.default.env.APPIMAGE)||P(_o.default.env.APPDIR)),v5=Ue&&P(_o.default.env.SNAP_USER_DATA),Ua=re||Ue,qR="PS_IS_ELECTRON",jR="PS_IS_DOCKER",Xt=_o.default.versions.electron!=null||L(_o.default.env[qR]);function de(){return Ue&&(Io(jR)||Io("PS_DOCKER"))}var S5=l(()=>WR&&h(dh()).startsWith("Raspberry Pi")),dh=l(()=>{try{return Ue?f((0,bT.readFileSync)("/proc/device-tree/model"),h):void 0}catch{return}}),xT=I?"win":re?"mac":Ue?"linux":xm;var Pr=15*M,Ss=5*E,H=35*M,kr=7*M,TT=1*Ot,jc=M/(2*Zi);var Wa=25*M;var qa=T(require("stream")),vT=T(require("util"));async function di(t){t!=null&&(ze(()=>wc(t,"unref")),G()?t.end(null):await new Promise(e=>t.end(null,e)),await gt(50),ze(()=>wc(t,"destroy")))}async function Hc(t){t!=null&&(ze(()=>wc(t,"unref")),G()?t.close(Hi):await new Promise(e=>t.close(e)))}function ST(t){for(let e of[t?.stdin,t?.stdout,t?.stderr])try{e?.destroy()}catch{}}var Ms=(0,vT.promisify)(qa.pipeline);function Tn(t){return t.destroyed?"destroyed":`${t.remoteFamily}:${t.remoteAddress}:${t.remotePort}`}var hh=class extends qa.Transform{constructor(e){super({transform:(r,i,o)=>{this.onProgress(this.bytes+=r.length),o(r)}});this.onProgress=e;this.bytes=0}};var vm=Zt.default.posix;function HR(t,e){if(S(t)||Zt.default.sep===vm.sep)return t;let r=P(e)?Zt.default.sep+Zt.default.sep+e+Zt.default.sep:"",i=t.split(vm.sep);return at(i[0],e)&&i.unshift(),r+i.join(Zt.default.sep)}function hi(t){return S(t)||Zt.default.sep===vm.sep||vm.sep===Zt.default.sep?t:t.split(Zt.default.sep).join(vm.sep)}var PT=/^([A-Z]:)[\\/]?(.*)$/i;function GR(t){let e=PT.exec(t);return e!=null?e[1].toUpperCase()+"\\"+e[2]:t}function _r(...t){let e=Zt.default.join(...t);return Zt.default.resolve(I?GR(e):e)}function ET(t){return Oi(HR(t))}function DT(t){return Oi(t).ext}var KR=/(\.(?:gz|z|7z|xz|bz2))$/i;function Oi(t){let e=jd(t,KR),r=Zt.default.parse(x(e?.uncaptured,t));return y(y({},r),e==null?{}:{ext:r.ext+e.captured,base:r.base+e.captured})}function Ha(t,e){return P(t)&&P(e)&&(t===e||t.startsWith(Ht(e,Zt.default.sep)))}function vn(t){return Ge(t,Zt.default.sep).split(Zt.default.sep)}function Gc(t,e){return t.nativePath===e.nativePath?"":Ge(hi(e.nativePath),Ht(hi(t.nativePath),"/"))}var AT=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function Kr(t){return $(h(t).match(AT),e=>e[1],()=>t).toLowerCase().normalize()}function FT(t){return f(h(t).match(AT),e=>tt([e[2],e[3]],k))}function Ga(t){if(S(t))return!1;try{return ja.default.statSync(t).isDirectory()}catch{return!1}}async function Sm(t){if(!S(t))try{return await xe(Tm.default.stat(t),Pr)}catch{return}}async function LT(t){return he(Sm(t),e=>e.isDirectory(),()=>!1)}async function IT(t){if(S(t))return!1;try{return await Sm(t)!=null}catch{return!1}}async function Ka(t,e=Wa){if(S(t))return!1;try{let r=await xe(Sm(t),e);return r==null||!r.isDirectory()?!1:await dT(Tm.default.access(t,ja.default.constants.R_OK|(I?0:ja.default.constants.X_OK)),e)}catch{return!1}}function gh(t){return t.startsWith("\\\\")}function RT(t){return Ua&&t.startsWith("/")||I&&(gh(t)||t.match(PT)!=null)}var JR=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});function OT(t){return t==null||t.isFile()&&t.size===0}async function Kc(t){let e=y(y({},JR),t),r=Oi(e.nativePath);await Tm.default.mkdirp(r.dir);{let i=await Sm(e.nativePath);if(!e.requireNumber&&(i==null||e.emptyIsNew&&OT(i)))return e.nativePath}for(let i=e.startIndex;i<=e.maxVersions;i++){let o=Zt.default.join(r.dir,`${r.name}-${cr(i,e.leftPad,"0")}${r.ext}`),n=await Sm(o);if(n==null||e.emptyIsNew&&OT(n))return o}throw new Error("There are already more than "+e.maxVersions+" of "+e.nativePath)}async function kT(t){if(t.endsWith(".gz"))return t;let e=t+".gz";return await Ms([ja.default.createReadStream(t),(0,MT.createGzip)(),ja.default.createWriteStream(e)]),await Tm.default.unlink(t),e}var _T=T(require("os")),NT=T(require("path"));var ki=l(()=>{let t=[];I?t.push(Ve("USERPROFILE")):t.push(Ve("HOME"));for(let e of V(t)){let r=(0,NT.resolve)(e);if(Ga(r))return r}return(0,_T.homedir)()});function yh(){if(de()&&Ga("/ps/cache"))return"/ps/cache";if(I){for(let t of V([Ve("TEMP"),Ve("LOCALAPPDATA")]))if(Ga(t))return _r(t,Tr())}if(re){let t=_r(ki(),"Library","Caches");if(Ga(t))return _r(t,Tr())}return _r(ki(),".cache",Tr().toLowerCase())}var bh=T(require("path"));var BT=T(require("fs")),CT=T(require("fs-extra")),Jc=T(require("path")),VT=T(require("process"));var Ja=l(()=>{let t=[VT.env.PS_CONFIG_DIR,de()?"/ps/config":void 0];I&&(t.push(Ve("APPDATA")),t.push((0,Jc.resolve)(ki(),"AppData","Roaming"))),re&&t.push((0,Jc.resolve)(ki(),"Library","Application Support")),!re&&Ua&&t.push(Ve("XDG_DATA_HOME"),Ve("XDG_CONFIG_HOME"),(0,Jc.resolve)(ki(),".config"));let e=V(t);for(let r of e)try{if((0,BT.statSync)(r).isDirectory())return r}catch{}for(let r of e)try{return(0,CT.mkdirpSync)(r),r}catch{console.error("Failed to mkdirp "+r)}throw new Error("Cannot determine appData"+pe)});function zT(){return de()?"/ps/logs":re?(0,bh.resolve)(ki(),"Library","Logs",Lo.toLowerCase()):$R()}function $R(){return(0,bh.resolve)(Ja(),Lo.toLowerCase(),"logs")}var Ke="1.0.0-alpha.1",UT="1.0.0-alpha.1+20210314162034";var wh=new Date(1615764034e3);var QR=()=>Ke.includes("-alpha"),YR=()=>Ke.includes("-beta"),WT=()=>QR()?"alpha":YR()?"beta":"latest";var pS=T(require("path"));var wf=T(require("batch-cluster"));async function $c(t,{timeoutMs:e,timeBetweenMs:r,acceptable:i,timeoutResult:o,unref:n}){let s=e==null?void 0:e+Date.now();for(;s==null||Date.now()<s;){let a=Date.now(),m=await t();if(m==null||(ve(i)?!i(m):m===!1)){let u=Date.now()-a,p=x(r,()=>Y(100,5e3,u*mr(4,10)));await(qr(n)?fr(p):gt(p))}else return m}return o}async function je(t,e){return $c(t,y(y({},e),{acceptable:r=>L(r),timeoutResult:!1}))}var nS=T(require("process"));var lt=class{constructor(e,r,i,o,n){this.name=e;this._isEnded=o;this.endTimeoutMs=n;this.onEnds=[];this._ended=!1;this.logger=d(e),this.onEnds.push(r),bn(i,this)}get ended(){return $(this._isEnded,e=>e(),()=>!1)||this._ended}end(){if(!this._ended)return this._ended=!0,qc(this.onEnds.map(e=>e()))}};var Hh=T(require("child_process")),Gh=T(require("process"));async function $a(t,e){let r;return Promise.race([t().then(i=>{if(r==null)return r=!0,i}),gt(e).then(()=>{if(r==null)throw r=!1,new Error("timeout")})])}function gi(t,e){let r=B(e.timeoutMs)?()=>$a(t,e.timeoutMs):t;if(e.maxRetries<=0)return r();let i=z(e.onRetryWaitUntil).getOrElse(()=>s=>gt((e.retryDelay??250)*x(s,1))),o=0,n=async()=>{try{return await r()}catch(s){if(await e.errorIsRetriable?.(s)===!1||o>e.maxRetries)throw s;return o++,await i(o),n()}};return n()}var qT=T(require("util"));var xh=class{constructor(e,r){this.ttlMs=e;this.maxLength=r;this.times=[];this.a=[]}[Symbol.iterator](){this.vacuum();let e=[...this.a];function*r(){for(let i of e)yield i}return r()}push(...e){ye(e.length,()=>this.times.push(Date.now())),this.a.push(...e),this.maxLength!=null&&this.vacuum()}pushUniq(...e){e.forEach(r=>{this.includes(r)||this.push(r)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(this.a.length===0)return;if(this.maxLength!=null){let i=this.a.length-this.maxLength;this.times.splice(0,i),this.a.splice(0,i)}let e=Date.now()-this.ttlMs,r=this.times.findIndex(i=>i>e);r===-1?this.clear():r>0&&(this.times.splice(0,r),this.a.splice(0,r))}};var Sn=class{constructor(e){this.ttlMs=e;this._eventCount=0;this._lastEventTime=0;if(e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new xh(e)}[qT.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){let e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return we(this.eventDeltas.length,()=>mm(this.eventDeltas))}get msPerEvent(){return _t(this.eventDeltas)}get eventsPerMs(){return Aa(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return Aa(this.eventsPerMs,e=>Fe(M*e,3))}get eventsPerMinute(){return Aa(this.eventsPerMs,e=>Fe(E*e,3))}};function jT(t){let e=zt(h(t).trim().toUpperCase(),":");return $(XR[e],r=>r.description,()=>t)}var XR=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}});var ZR=Date.now(),Yc=l(()=>d("Error")),HT=new Sn(E),Th=new Sn(E);function GT(t,e){return e.exec(ce(t))!=null}function eO(){let t=Date.now()>ZR+c.probationMs.valueOrDefault,e=rm(Th.eventsPerMinute,c.fatalErrorRatePerMinute.valueOrDefault);return Yc().tap({level:"info",msg:"isFatalErrorAllowed()",result:Nr()&&t&&e,meta:{mainService:Nr(),postProbation:t,lowErrorRate:e,fatalErrorRatePerMin:Th.eventsPerMinute,errorRatePerMin:HT.eventsPerMinute,fatalErrorRatePerMinuteSetting:c.fatalErrorRatePerMinute.valueOrDefault}})}function Xc(){let t={};return Error.captureStackTrace(t,Xc),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)}var tO=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function rO(t){let e=zc(Yi(t)),r=e;do r=e,e=tO.reduce((i,o)=>i.replace(o,""),e).trim();while(r!==e);return V(e.split(/\s+/).map(i=>{if(i.startsWith("E")){let o=jT(i);return e.toLowerCase().includes(o.toLowerCase())?"":o+":"}return i})).join(" ")}function yi(t,e=256){let r=ce(t),i=mT(r);return ur(rO(r),e-i.length)+i}function KT(t,e){return h(t).split(/\r?\n/).map(r=>Ge(r,e)).map(r=>r.replace(/: ?/,"")).filter(P).join(", ")}function X(t,e,r){if(S(t)&&e==null){Yc().warn("onError() with empty args",Xc());return}let i=ce(t)+ce(e)+ce(r),o=eo(e)||eo(i)||L(r?.fatal);if(!o&&Qt(i)){Yc().info("onError(): (ignorable): "+Jt(e),y({message:t},r));return}f(Qc(),s=>s.writeRecentLogEntries()),HT.onEvent(),o&&Th.onEvent();let n=!o||eO()?"nonFatal":"fatal";Yc().log(n==="fatal"?"error":"warn","onError(): "+Jt(e),y({event:n,message:t},x(r,{}))),G()||Me.emit(n,{message:t,error:e})}function JT(t,e){return t==null?new Error(e):(P(e)&&(t.message.toLowerCase().includes(e.toLowerCase())||(t.message+=": "+e)),t)}var Wv=T(require("child_process")),Rm=T(require("process"));var $T=T(require("util"));function Qa(t){return t==null?[]:Object.keys(t)}var ke=class{constructor(e,r){this.maxSize=e;this.clearEveryMs=r;this.setsSinceLastSpill=0;this.expireListeners=[];if(e<1)throw new Error("maxSize must be positive");if(e>3e4)throw new Error("maxSize is too big");this.clear(),B(r)&&(this.clearInterval=Hr(()=>{this.spill()},Xe(r/2)))}spill(){if(this.priorCache!=null&&this.currentCache!=null&&_(this.expireListeners)){for(let e in this.priorCache)if(this.currentCache[e]==null){let r=this.priorCache[e];if(r!=null)for(let i of this.expireListeners)i(e,r)}}this.priorCache=this.currentCache??Object.create(null),this.currentCache=Object.create(null),this.setsSinceLastSpill=0}[$T.inspect.custom](){return y(y({},this.priorCache),this.currentCache)}end(){this.clearInterval!=null&&clearInterval(this.clearInterval)}clear(){return this.visit((e,r)=>{for(let i of this.expireListeners)i(e,r)}),this.currentCache=Object.create(null),this.priorCache=Object.create(null),this.setsSinceLastSpill=0,this}get size(){if(this.currentCache==null||this.priorCache==null)return 0;let e=0;for(let r of Ac(Qa(this.priorCache),Qa(this.currentCache)))this.has(r)&&e++;return e}has(e){return this.currentCache[e]!=null||this.priorCache[e]!=null}keys(){return K([...Qa(this.priorCache),...Qa(this.currentCache)]).filter(e=>this.currentCache[e]!=null)}delete(e){let r=this.currentCache[e];if(r!=null){this.currentCache[e]=void 0;for(let o of this.expireListeners)o(e,r)}let i=this.priorCache[e];if(i!=null&&(this.priorCache[e]=void 0,r==null))for(let o of this.expireListeners)o(e,i)}visit(e){for(let r of Ac(Qa(this.priorCache),Qa(this.currentCache))){let i=this.currentCache[r]??this.priorCache[r];i!=null&&e(r,i)}}deleteIf(e){for(let r of this.keys()){let i=x(this.currentCache[r],this.priorCache[r]);i!=null&&e(r,i)&&this.delete(r)}}get(e){return e=h(e),this.currentCache[e]??this.priorCache[e]}set(e,r){e=h(e),this.currentCache[e]==null&&(this.setsSinceLastSpill>=this.maxSize&&this.spill(),this.setsSinceLastSpill++),this.currentCache[e]=r}getOrSet(e,r){e=h(e);let i=this.get(e);if(i!=null)return i;let o=r();return this.set(e,o),o}on(e,r){this.expireListeners.push(r)}},to=class{constructor(e){this.opts=e;this.uid=0;this.cacheSyncHits=0;this.cacheAsyncHits=0;this.cacheMisses=0;this.timeouts=0;this.cache=new ke(e.maxSize,e.clearEveryMs)}get size(){return this.cache.size}stats(){return{size:this.size,cacheSyncHits:this.cacheSyncHits,cacheAsyncHits:this.cacheAsyncHits,cacheMisses:this.cacheMisses,timeouts:this.timeouts}}get(e){let r=this.cache.get(e);return r==null||r.__uid!=null?void 0:r}clear(){this.cache.clear(),this.cacheSyncHits=0,this.cacheAsyncHits=0,this.cacheMisses=0,this.timeouts=0}deleteIf(e){for(let r of this.cache.keys())e(r)&&this.cache.delete(r)}async getOrSetAsync(e,r,i=1){e=h(e);{let a=this.get(e);if(a!=null)return this.cacheSyncHits++,a}let o=this.uid++,n=Date.now(),s=this.cache.getOrSet(e,()=>({__uid:o,__start:n}));if(s.__uid===o)return this.cacheMisses++,xe(r,this.opts.timeoutMs,()=>{this.timeouts++,this.cache.get(e)?.__uid===o&&this.cache.delete(e)},a=>{this.cache.set(e,a)});{let a=s.__start;if(a!=null){let u=a+this.opts.timeoutMs-Date.now();if(u>0){let p=$c(()=>this.get(e),{timeoutMs:u});if(p!=null)return this.cacheAsyncHits++,p}}return i>0?this.getOrSetAsync(e,r,i-1):void 0}}};var Br=T(require("fs")),it=T(require("fs-extra")),Fn=T(require("path")),Pv=T(require("util")),Ls=T(require("zlib"));async function Mm(t,e){return t==null||e==null?$(t,F,()=>[]):xn(t,e)}async function QT(t,e){return t==null||e==null||await e(t)?t:void 0}var vh=class{constructor(e,r){this.l=e;this.listener=r;this.ts=Date.now()}elapsed(e){let r=Date.now(),i=r-this.ts;this.ts=r,f(this.listener,o=>o(e,i)),i>2&&this.l.log(i>500?"warn":i>100?"info":"debug",e,{elapsedMs:i})}};async function bi(t){let e=Date.now(),r=await t();return{elapsedMs:Date.now()-e,result:r}}async function Ya(t){let e=Date.now(),r=await t;return{elapsedMs:Date.now()-e,result:r}}var iO=15,Xa=class{constructor(){this.errors=new xs;this.times=new Map}async time(e,r,i){let o=Date.now();try{let n=await r(),s=Date.now()-o;return i!=null&&i(n,s),this.push(e,s),s>2*M&&d("time("+e+")").warn("slow",{elapsed:s}),n}catch(n){throw this.errors.incr(e),i!=null&&i(n,Date.now()-o),n}}get entriesBySumDesc(){return te([...this.times.entries()],([,e])=>-e.sum)}stats(e){let r=this.entriesBySumDesc.filter(([n])=>n.startsWith(e)),i=r.reduce((n,s)=>vr.merge(s[1],n),new vr),o=r.map(([n,s])=>[n,s.stats()]);return ft([["merged",i.stats()],...o])}mkElapsed(e){return new vh(e,(r,i)=>this.push(r,i))}push(e,r){r>iO&&lr(this.times,e,()=>new vr).push(r)}weightedAvg(e){return z(this.times.get(e)).map(r=>r.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[r,i])=>y(y({},e),{[r]:i.n}),{})}weightedAvgs(){return Li([...this.times.entries()].reduce((e,[r,i])=>y(y({},e),{[r]:tm(i.weightedSampleAvg,Xe)}),{}))}report(){return this.entriesBySumDesc.reduce((e,[r,i])=>y(y({},e),{[r]:y({sumSec:Fe(i.sum/M,3)},Gt(i.stats(),"sum"))}),{})}},YT=l(()=>nt(new Xa,t=>new lt("PromiseTimer",()=>{let e=d("PromiseTimer");e.info(`timings:
`,t.report()),Oe(t.errorCounts(),r=>e.warn(`error counts:
`,r))},ue.service)));function XT(t){return YT().mkElapsed(d(t))}function rt(t,e,r){return YT().time(t,e,r)}function ZT(t,e,r){return l(async()=>rt(t,e),r)}var sv=T(require("crypto"));var Sh=T(require("zlib"));var ev="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function Mh(t){if(typeof t=="number"&&t<ev.length)return ev[t];let e=t.toString(16);return e.length%2==1&&(e="0"+e),Buffer.from(e,"hex").toString("base64")}function tv(t){return BigInt("0x0"+Buffer.from(t,"base64").toString("hex"))}function Zc(t){return(0,Sh.gunzipSync)(Buffer.from(t,"base64")).toString("utf8")}var rv=l(()=>Zc("H4sIAAAAAAAAA1WcgZarLM+Fb8ibQkWlInhA2rFX/+8nOPN+/1qnAa1jEUKydxLP0oZPGtxcB3ecg0t5cMXpo+OqflV7bYNrP4P7fofRxWEcP8M4bcPodRynYcx5GNuhT9HnHsZ7HyZXh2lSG69hOtTP6udDn6TPzzC1qI+O72mYdd3s4zCHn2E+dHxNg/dl8CUP/h2Hxa36JH3+Dct8DovfhyUs+qjd9dG9l+scVncNa9Anz/rEYb3PYdPxpv7WXsPLncMrrPp8h1dpw66/3RufQ5+izzXsHzdEjT3q2eJ5DVHjPJY8HKEOR16GpL9P4RxSHvWZhnQdQy7HcLqmzz2cGtOpa0+N6dTznpqbM5/6XMP5rwxnScPZZn2CPvfw71/Qpw3FjfrUoeT3UDTn5e2GOu9D9T9D3YI+11B176rfrf/iUO9luMZjuPR81+camubwPR/DR/f55FWfc/hoHT/VD59rGX5+foY7zMOd2/B1kz778PXr4FyaBxdKGNzLaYmPaUXsEru0IGm5dQU9TZpLTdqQvjo8T/XKgbLoF1wdda6iO5ce2jU05sPf3nxxFy/FKYvEVyoyV+mKv5zEZxzGgCqFVYfh0nXhR708SqXyhEjrMF5c0qK+bRy2S0rlJiexIgqHHynYJg2QeEtIB6atrQidC6eui5qrKXGY0cwcdS6bPp63hLR9KlKRqXHnlhLiGma3ZokjSUfp+SoNDahs2L1EUu8lTZgj5/JUJTxCI53zqUuK9E/iHOZ2jBIay/zWnM63buBnjcr/SCzOo+MFZa8b4ishPVgmKeniJ4SfpfYa38IIFmZtCZqXJejXlqCHWYIecIlSuyWlW3tDPyShS7JUcvVTkJByr/5wEkmH4dTesW+zNGbNWgWJNqwl12FtI0JbcXOvIKHRb67MEh8deqeeH72EHyViRLDv9JNbdkVCa7llT0/zsuWDLw7OFXpSPYldomqrXtrHW+OLj3ZT2D9+CIcWJSRtwhcDfwWpj7awellDe+WQhlfVk7/eWtDdjQhpzu7iKCG12FmoPWXtcBZ+z1rVnYXfWe6dRd5bDcPOekSv4UZ0MvJnMRy3xFu9rEeN3CAypxJNYqEn/YuZS5o2U2x6jsNJ+Q8XEJpnCZkPl7xE1aFviyyKbiWBbXkhos5lbcsj77dE1LmcHGKV0JQcuZrQrdqiixvfMvqjXXVITgNPPHlyxyHxDUPyMpXJaycn/9El/uca0iqlSVljSXX5DKlpoVLTuuWo+cuHliwXXSJxS1x50MLIWPFEp1u9xMtJ7JzTIE+vG0jQi/SSCX3rpSqnL+/h3KTAEv9kGqW7Jw99Bu7Ck59BfucMiUP+NpwmdIMgIy1jKmsaLq7Ttj/ZYGf2WFTN/Zk3bKzm+WRBz1wmBD2twlmCDotMgYTOXZsOm5T1bDtCz3s2bt+qLHe7OLz4Qr/27588zr8WDplljVSa4ofi/SVR6GlfliyjXt7atZVpr04qUCeZoOo1fxKrhGxi3eTAKrapYpskvth0hIxCxepVFL1G3b5G7d96yDTXQ3uhHhwmWZCKblR0rWY5qXrKildNJWJF6It/fpNo+rbwbeEnL0TTqlbsmoR+qGm1apNa1Dvpuq++veQJJKRXl1urhLTuYp9f3snNeL8gvhJ6tsufTUJTfPk2DtemObhYwSuPiBMhj3qVkCWaH65LT3k17vfRgNqY76FFPVY7NNLGZLcqG9HadA5vr4vfq4zRO4xFwpv4DO8sF/bGQL0vjfTDICX24eMv+T3m9MOcfsJL3wap6OfUrv2wyD9yZsMP8/yTtdI3f3a7HOQGx3v4Bm2Xbwzj8D00yG/W7375oS+T6MaxTZKYXyRnckM2vN+M7XPzEcBRbdGZ1Um33OZBUhEL4KLXyrl4buofURMuj3qZX8VXpq8eUaY/6G+LedTrcsHkLf/puP7Wk8qDrltEyjSPLlRzrHK5oy5akQW3OnOllod+0++OYcF5hgO3GsybBhZkjFlrPWbmUVIPLqe76XxeuYMsgnlgjU3yy3m7ZzZXXLxmRtL6bB7N0YZcZdKRDXc9c6ZeQoXtm3DWk/ltrkR6yaUgV/t2xR+7TVo0+Vq79CaDyYx/l2GXxOtvwXuTBZmAAJhpycy3LLQAgAzUFKwf2PPIYFJ3i15zO0VM65RX7pM37pkxOcIIhg9yBCAURijJeczulO8Msv0KEE0FyyYpTZsqRkowQkZhat5k0ead2tcBJdCK2RVZ+dm7KKjgRxkwScGVOUTtzTkUPfucWa85Z6GBubhFWKRgA+fy1dadG7MnNCET720+tR7yrX7STAxezisKQRd5PS+ToPOy4pIXltDLaAE4ouYBmZGaAaEPrdTiLgf+uDTbgh2y+4uP0pnFVmSxFVlsRRZbEWGRDQiymswLZ+waDdaZVF+2Tecj9nWRXiGTvNai+QxIYfAl25X5+iKbfMFSnOzTUjKoRfs3IeV3V4dLWgUxhfR9kUVfQ/rmYY3A2TVJQQVhGMNq91wzJm6VruqaErR/hW1kSiRl1iXbCdCR1q0N/y8p27be+QT2zIZ7Xl1+BXBc1viFf4TXNy2dAJGvevYtvKTtklrfLSetr4BNQlZDP29pzmb6sMkg6fwnaNW2+9C6hFkKKpQzC+9Lao1CejXJyty+3Et/Jbkjd5nNl4wK8pImvPwoG4q8kMLoL/+RpXptTqv8EvgrkptG8sqs4Cu3oDNt1d5/tWtvQCf5EMEm8JCbZM0lAU1u0ZW7gIvO+CTLv/sit7uHQ5q2B55xj1lOfM97BkahUbvtekEqrf5uc7jf5YRXjcEkHEvbLknydFEuJUoWaX701fDXoTEjAV+HXFs0qxWPRTtIIIzr82Lga1nAZlr/Ido8x9wceKxJk2MbtRaxMQOxYdOkgLvhMd1ZUvMsKbsn2LNx/nqB0a7Et5d296HlQs4B2IY10MhmZ1JXrlgMSe0yWX/Nj6QY1iGYCIZLF/ito7jTwBu7T7LRx4oeZj00Ao1ZkrFVLJUQnjT8aKwX0pvsZzKAj9G26+pyE9xz+wX8Mxk0wuT+aZYkZT2SZ5ySxZn0JoPJDECUrU72LEl7WXfIYMtke1CESTuIaRYwfOGZ5RD0i+IK9AtzKxCv6wWBgXNuBhXK4SUkkNDszOkSEM8lsJYU085c9MvK9XXnW+EOwCQs2m87mDJ0ZHmAJSMs2uMfT9Ew5KVfl2yb5BeMJ5sPVESHJTdDm8HOVOs30GSMAEvWS9KuP8GqkkDPAi4MP7KfZ/hqJk9ZlYq8dWVs0nyhUO5svhIJx9fOk4xv+kXzfBag4Fk8AFPzQx/ierY0wf35xX/hlqX9F6FSstFuQcqPSHrrS0/+NfRBhnAOAy5XfRl35CmvpNuDSYOdl0JVycS37002sLzrvg7lRouqA5NUN4eKFGaojuurw8tU3Z8zBXhoq6B9qKdA6tsJtoj0JoNJzh+AUp3W9f7UTtdoZEsFcaVj1fxvDdg6ra68c93BTnUH+SCBu4aaIxRcJE66XeW66RfQarbx5Aq8zlcRiNX07YBaERHJHQk3EsKIAFtseG1oI5IzUZahyksCcYViJHu/6IkusbHV5I7U6gst27cGVyWD5A/A1rPiQsDyWYLAWnddZ0jY7iPJed0DeTmTXCMnLYnfF0jW7F2mLZcY5C0ZhfGujB5ewhgVWQ0/C9brsWbAMyGOq8AYhaa1o+XAgzPpkdH6kSvzj/qtguNb3W5kFUz/gIuuD4il7YQhZJ6lXbpQI38bHns77NvbLbrbW5S+yyzJM76DnQl2RrweeV0NKQ/1ztjnd4tiREgvRI4V/WxEMT4BuvnRjruHT4Hq3H4VQbk91u8OyyLsLdvlgOHEpAJWAinorf2ob203idazUTVa9pPT7r8KzTodajQaAfNDAwRFCx3fwGhCFWr0oL0hOqWOwPWbjhC1AD4weiSWpIYQkPq7NHgE1AO3E/ZNjYFgV7+yTKP7ws9G7+wkjeCtl4UEde+7NVK70Bvd0xu+FyJvMnWjEIXmyhpPk1ZdKZAgMCMH2dH5YoA95jzfYHKLluUlGB7f2AJjtj2vBhUQVIfTjUKMAeBeO4pXA7wX0+MPGs8uh5i4i6w3gF6GiWcXTyPYJvjaG6D6WMzKWcOVOdmROZ1RHknEXojfRtbMd4D5efa2i1GC+nF81vje6DHv/nx3rAG4r2Fkawz2282sgRAIgAiNuzg3Loky6WIAmfDCtAYeU6PTZNOklcYbtdgCqIfmDVkQgTSGYFSDJhhfaEYYFmfNYY3tTJjDyZX5NE5hLlAUwvjK1vpdWr9LA/6oOflzbU0ZVrkaPJ6aekIuAjhbjZ3ML3wZbCJwVIyRqPla4HHa4Q8epzoVw65TafZE5WESnTQJ3fjOLhjEbT87uw3ANLuDvQi3kEbS6Idm1FwEIsyzBjHnFagk8+96c1isMusf0UomeS5ifzpZKlBpvv2ivTt/w0dHPkkvxSg04QJN2oXEI7Rc1Y1qtg+coyWMnv85+W5h0IXYpjaumiPoZqITl/GJAzck4oCGSLkxvSIQxgJC7Ucywat4gy2xBjKH3txQhDn04CbTCqnIH5iEID9N4WeFAkunEdp4S9d50U24pjUcaY1mOEY1kjHiE4VHMUarAKKMx7p1uiFgIDUVxxB+FskIWTZ5zVLoH2uMbewCv5AOZmnN5oLUGBMpzo5EQjZjIQxp7ctoTYN2YBXXJiNL0PVgUdePY9uvH0+zObftRGBv0Ow2em/0IxEt2CAOxFVn4ghiIKvRjoQy0NjJvNvJgs0SGXnriTZhTZ0MMjefNog43nLt2hSrBhEOW0ZZCRhRSFpBkRUNXZgqpOrtu9q/e2PeA+jhVFPFoURQbB1e7k3IA4oCC/Efwj+QlGoMpIqC7ERUIowDoEkTelOgIVEOvze7moOJFKBwRlGSfoTmgoDwe1xyVaMyHxjiLgPhv6IrZqXEVy7ojFhLgreITx5Egomh7m3BJEBXOlNxH5EIwEAxZgLJEIOmCdN+GPEgDhS1pS/ISGcgLByR37HpFw43BSC+C+AvsTYCgYfmgVCvmkxj0QM12ULEBVOpphEXdrYRDnDJqKbpn5obO6FmNEZyjFziE6iLBlpA8xyF3uhm/kr8rBwmVwZNuf48dEYTXu63IRz9JUxx7K5xMo/ByMqELtEEO5K5UjOHhZOCeJEm+gNyY0ynzEkO89A9CHa3qO0BhUHn4TCM+tvS2uAv2odqRIp3GAwEIQmaRphMAW4k33CtuuGhOUtB8Fh8JXbaEo2DpSzuv6rJjJNG40wQsESg265scxC+TC3KMqmpOKJ0HyIOEBtjNimiYMJfJCJkoAU6Bxlrwa/e6MrLj7K7+RI2hcjMzTjPvpP6c4l4FIwmd0oDs/HmzkRtnAXJvf4ZuXGcTPnL0entSlEq0YTgF4LUQQAfKvM6rTlwKGcwBRN3MQIS5IAsWp4tuP7tf/6dCbpnP/J3wggTR1JbIt1jJDAujqfdWLSjiwW4ySEVP13aD8XLWXA0Ey8uYiMavAwmwLp46DMNOQ/REAxEkeuWH1PTxOsFV2eZ7dJ3XAnHy32syeNQqnAhZEWOYVJjeAnSItUQSBMtGMpX1m0yrmJx9QXFtIajKJWkwc6rwV1XnoGmsVfgLA91Me6y+QBt2cLroom+0Yj10uSFkyWc1mTXG0LyNKE38BpRo03NhE5Uby7LGl3io2YN0rMRmJdt9nZ0G/uRo0jWwIvgnAXSA/OF9TBcGh0lg0Y1T8ISNCxxlWM+OhuykwVoVLW5oEWncY9aN4KFVZooVazE94j6tzNollp5c+uPwzfWW6bkINz/gsvg6i4122aRf5tBET9nzMc0S7oOYL14TNcbOE1M/J0ur9lYUCdDWkKYDubCGhgPCGS4grToJD/ADrhCwUqpweRd2Ri8mBAPJspzkTUA/dBc9rNy3lJTWV2imFcHpWqEdGkapEcgQc4G1ZPRaefMMzTtG43z7UxprfEQGoyVuEzPLrgiWPEOYdfUvUHSRXxm1ROquQGJajAzb9tPw0ecQLqkRv/EagSvaWRYLmM6uhKqwyXEEtLwkWuFC7XvVyd/NGd66B//Yw0BlHm4nZwNtGh8C3WJC836g6+zaB5N4GQkafx1B8vxldUedQkh3tSbIq60kv+DMsGiWlj57uNQIrGbkR3kFrkJnXYiYLcmyoGYtWru5bckbXH/fPnXYFAa5kZq/4J2Da7+tC+ZD8G76P4N7ofHmY045TeUSXhxIhMRLiMjDhwCT0or0Ug9STEqYI7UW/t7bNxAliOLP8OkRmfE6srLAnuKJNZowWi07EU9xY5NJcMBI4ZCGZUKGCFaLQEZjZj1r9J+sDxjbOKeB5kOU1Mo1Byy5TkwgbQkZa29LPMxERlWOxNvUBucnZcmkj2RfQlWoyB9hQZBrfxDseBDco9VqGK8utsdZRTxE6NQBvo6NoNHEKYdKEO2pPV8Sb/f133jkycB+03uAIOqFWeznAlteFq+T57nmYi0GYVK5vx7y/nz6nmXs0W7nzat/N2k6cBSTphya2U1Xs6I1eRua5P0CCSvR1OrOxr1IddgzMv0Gs5FVItMDNli2rUzLMP0cKt+Pa0xqNlRcCEmZZkXqNRMfkZEmfHpz43uya8Fy728YAW0UhsyL+I+lp/R0yy+t4cVdezBvj/9Zd/Lc61GuVIzBqb2eo6ZH2vtvEVsJykZ66LFf4hbs4gh+Z5o973778saQ++NoG0PX+O5oG3cx1r/tL/nYXL972FmRs386nj+2YtSyKAI/GvD3OSCLBqlNUVVaVlitXUiozkf3YfOOax2XY6izpYlMgM6l3trh5WdiHuI38l1EYntbYbM5SA9EqRoo7E6jB75osm4qYbRosYrKheJsfmv7By1Vw62a9miUD25o76Pe0tWKDJwiN3a61K0T5OxuIMSkCUGc/q9haXJJ/QKlYt9Sh6IfGJv/dOGp4XqtTIGY3eyVJ3lYatpdSujbcbb5MzOnjMSuMm0KzmJFVdOPojM6cnxreebxfPazf5YY5+/NWfbbyv7XOssqF9mOfOVXBz0kP0Nm5L5YdyboD7QxihXodRFOMLa6u37fGnLUYu2es3VwOIwL1sjlu6GYBGMJM41+ilE2JYn2yhmlSHmL2E47OJL9s/acGhqN8vkUImxP/vaaM83kKWROlbyNGKzDeaTg1GflMl57Llm4re0PE+UNaQGJLoNlGuMxxnlUXv3FqdNKEacbwC3sK9lXmMgCyMt4jk1DZvlPITXkrWrBe8Otz2MKM7BjqPtzwO04WpnQ790iKwLUNttlmsJRnCYfve03tr814beVve0z/n6ex72U2L70taKPRcNKladA6WbKrkbTNjTPgSH41zMDx2PPTgKK04VDtSQbAxoSdTCvcTLvmrrdW/kVYrdr7fkXK4PlU5GOmRfZXSqwXI5YKAteRLG31v/tOFp7ftW7LpkfoNcCnaOPAp1YqesL/PR22DUgwCSUZDN2kzxXm8hHH1/CqjMlrmRIeglPIKXo7W7HWOfd2obmUgohtyrZVa6HzpBdhF2IsNcezYlJ/e0/mmDZVAg/mds+l3KeIrFvs/cViKpJ/s5WHuxr09RjCB/fWLPLJcS3g7+QkudTsmGktS+AODS/kzEvrcZgrP5XtQDrn1aMipOW5wsSzAi+6/pdnETBZpCtVzLYTUPxX1v6lm0zQv4Q2woUYWnViwlWQaG+S/+n+WLBS0jNRQiOodxKS0i+0McR/thJj/DziArcxYyF24XzBcZcawQ1EbjO51xFIq+qhyY5VFo4RLWPpRE81LJwWv/yOZEsgTWUje6CaYC+0V8WHe1bDVox9kJhz8ApxAPxg/l6GQDDa6WgbHzJ3EvCoxkOMi3aMKMt1zO9EZtAqzWC8NNKxLJeIB70rPe+qd9uIn2n3aHEAYVSMR6YCmnccj6zjFDgT7B8AD5GsKvl1sCGXcyNz0vcz7HRRD0JnMjXqPWHx47ARnphKWUzliKRVTIyQQ77viztzomzCQ9uvD+E9mZMxKZMuZhWRZtNGfVTCg8rS74sRxMZyi0/mk7K3lIShN/Fi8ZzY9czRCPWhHvXg5l9RCCBXhMEZfV/GA7pV4F6gJ88pZnIQBJq97wcRC5WTQkmt1Ru3DdZ+sx88/2UJHPZ0ZvfqQUdYI/jCQByLR4YY2nFWlYwcXesi48z1f6wPx+Zd+FgNV2vCtWoS18Uu+0eGmeCIUFqsUQIgSF/IzGaXEZLYy3YoxODoKzaiUoZ6cFxeqXCpULEIXyzZZW6B3/2wm/nWwkIRGXHgHVBvs9X9mZ+wHYYR0t0CGkf5y7ZUJAZCQeegewLi0hNy2U33mm5mRycEu0LRCENABviN+QvJW1C4Iat+kdA/EOtTI0329ocN7OiOejQAB51pAMh2G6DuWPsWP6DjKFeN++V0BlwqzkOhxPS0dmx1kShESCfdWhyQSxE3keAJjCJwbSWSVnqHzrcFzGiuik5UJcT4NY6uu383cm/HYsY7IUtPTp5A7nD8P9dHx6gL191VKH2oLuHWuHabJN8XT8b0c/QRrd7mMd7pP7YKm8iv2veufvDOA88lO1d74d7gdTto7rwwO002x1Vm9fLUsio2QpES/obOBYNtHQjpRXvM7OUKBhnaqNNwGwtYBUfwlpkz6mEOvEBFLsfTnL5Qlky4f5kQJvoRIqwgE55CXm000XBnkuD1KgOssK5Py6PUmS4+ixFWEOb6hgEdsVIK8PbA6WyggrjhRAXC/LY5TRyicohcKK/XZIarBPZI1Bt2ytYfUhJuoHMDpiChR3a6JcPUhMvC0EsOJyrdC7kKK0hMQz5rU54JT77fydIU0RSKCStijFqPBKkU+xaqjRbZaLyDiXclmOIeAWgb0bcyg8GwzQvlyIBAuG3VcmZLdSIotz779Ksv8qCahVDmaloMiZf1bH74Rt6chsUGVUZBxvIOOyy1TFHm7v0XTrBKv5iQ0Y5wReekw94eEs4n4FkPMhwp0pETy0KMVi1l5o7uMJsqfZomFCiwJvVrbNFBJq7x0C6iLw1GkcBPEMivaO/+38fQWaFOun0PGAdJMMOmTNtOWX4SDWz/ZM7RiTFXcDGeGmOW55BjRIdSkvXYd8suAaYT5RBet8YUSJwm0hpEi4mviVJvwkHWe1K8KS5jwEHvscCjUGC3wKc8w2G4AP0qJWotNYXHWuBKU5nZwGCnD6ieKfHtKu2/l5UCQ/0TvZKnbkN4J13s6qeoR8iSwLf5zle09gSk340kFleFDlZCnup/N3Jvx2cg9oGwTO6QZeghnfsGiBPUieZp4ygMKLEoVyjtOB5+ZAnNsC2qZ12n66Axf7dpkxl3+6NUeHOpRL3J7O+cC5pJUTP+qdVnsUGuRX4TmUMtYeC7Eosv8YWDJODQoDs9abAnEZOXCmBZVJSpBTD+RJqyGVtQLpUq/DkW+u985LQKWHTi2IzMBqyh9zoxYsttKa3glP52shY4xNAtNJWSkEInpMtI0nZ4NSWgM+Dh3nfYk39w4ILuA+gW6lYzMzjwSbatPerWKH9S2PZCU3VI1YBc4HT71bqNmV5Kbfzt6hXQ8xw8J7yPnK7WuoLvYORkOmnk6xJbAOeYlrK97zgoiAwNi8FZ4nwSuqzUlthmJxYzl+qtiLHCz46QLF9zOSROgsjGzhaOtc7rfzdyb8dqzApvO8jtsAbmO85SH3QQQQKntYkYyZ07e08vRtV4f50sxbeJkCFYNx7LiPv+ZCdf1X7nXCNH2pxaIc69sIeeoMNSIyTlSEL4t4F0Nzi57EIiguLt4SYdSRE/Pk/axiA57dXw9YJrxmMUAA86sFi9bOTrvTKl96LxsiI6tqsVb3tXH3KKvFSQloJN6KEZrSvOOMx1wNM3GOXIBMEThKeNqgHjb0sLpyQ1IG7Tqmqv6Jj1pk1nqY/bFdVGUYMIqaDWbFemGmrls+eLSY1QQkjwdvGXqL1yaLWybtjJifSKQBiqfn/3od6xhMfVBP6iDHafGO3KFMsbiifnYOb+BWwYcVasoNWLClZirCSo/bGaJoBil8nX37oRcOqwWZ/SlLF+06bRFL+RDRs2mlJ1IfrOY7m6+iAMOtVACm3iPpMPiX25tF1aQWbW1WhVFhRnbuZ/KnQY/FTcL0MlTUUwRBZKu6DpeGT8St4wjqn/XUxOuopf4mM/0W52oUsMqbh3KbTRGlXLQ60ohNPmG0Oq4NQH4xG1v+XHkPvPTVtHr1+rmGMCat11aeeFajdliQN1i+SRhAbgvITFTLU7tXh9DzCrrulZuLKLzVH39aqR0j7Jsl/gMFWPrxYZfY2rvN1ku9VpmKysCv9fgUG71PLbp7iLJOHwhJn+R+LuIaZoMEa49tH8AsA5VEn85cLT4ltm4Yi2S8G3vqvV4NAiI8sM6AVcMKl596nl0udArXE4OyKDb5NeJM/okvWYTs6f13DoAwy69fVBTri5siSkMGlfSL5dDfxFPJn0slqGFQL/QnJ0VOmX8ZSHkH27/ZMsKsea6EkXg9LV+H7BaFCPlq3zGUyaJML8EP8/JJ+opGCBOI4+FS6AkTpN6jwgAQUA/3QAYZtWyVtN612X+1p6WDgciaf+JG0U+/vfD05FroiXUaVDu1UjslKfh12yjEhsoFHiaaM4bJqsDOW1poOEK7BBNDTMViNFehIlYmAFb11+PbQ26O2SjdkenXfnvy43kEZ0t3S85bp5KVzNdMlK6KGUglSJz2BBZZVt043h+854SbZ9Ysz2zkDOfvf3siXlQGqfdR7/tEcw7z4E+PDHLi3pZZTr+oYCuhx4dr+On/6F13Mie7S0spEwQHjKPFj397mQiPp55SfxuDqP5FCtr8g8WTes/+ovf+Oxf+errLKZ43WUb9xITwOqPFeE5LxBMGmWIbSTZTrgFuaSO59JG6W2bXUSncfmecNHTMH4vsnOF1kYHvMRzL3gq3S0+1p827V94TVS8723kyuqe3yjfqZZvvL5ul9Zt9d/Gpxu62ZSRmXhHtfhvbfrXj7B7XPDfB6Sfmwqh+e2GQMoXLKidbyXr2aDWxK2U8VL5qTqsUpA7vmxoN7czh5i8/+K2ve5GqvahmrZBRzZV6BXQ9DWIVnrejqGb9vbNboh97Qhan3HWL6Ibsn1APYQ0o5uODF6HACrGR3yAoa9ESzZiefBettBDI0xV3LKm72tiEknopKe9MgBjdbygETfjrhv+6hEgKGU8CF1Y0+kR0xH6A61boKcd2vVln+etpI9hTLaTReM/H/UYlemQAvnHaG1Tmba2SyAhhtWyr/aoo1ux7XIHlWYdJNil6Mh2PG7aIlkUOPvkviKCuhRH+QV2BGRMKDm0kFvAHiWbvzq5KxAPcmlt3x/6/s6tdamfNXRP9ATuTQM3pt1v4HwqkA6uR0gEEMIFbq7yywE+zH8YLFGLW3goko3CA6B6WMLrFm7e+8E8iHJRA6saooJF9fU1Chy5zQw5KSpCl5dBwPQ6vNIQqT53kq/3mqQSc9qXYO1my57x/gyMQFX9zr4tXtN857Y0XnLcWKq+c8T6QNPeWfjVeEGrC5FZHs3vpociHTKH4t9xe7gz8b9b3/2Z9/29+rV6O0DC5o8OLiDElkfjKaW+UaZcU2YK1J3l69CB1H9qJ7kEIXTO00P1+5fKpKnmIdfePTxcHmbdDBsAK0qjyttXERe6b0ecE3p9attKx2+89xJBPXkHoLrHJCDXLPZ5OE8yOtHSLUPLByPCAbDNzhnV/vCtB+Bg8BcUnGmJpmacrU9O7V1gJ5tD9uvLlbCA6FShiUXf/65orhBVZHZdrb7v2O9+8soDn03AOK9d8iBlRwn+EYDaAifgs78xEY6veH2evnBRNHZkrmKbjRQ6rXa0U1ImK8v6G9ol/OOBvN/fSKdd0E7m5ItoYe8Zhc4bhzYEZzorJfJmMGdaoTnJ5BADWP2+2mYsrT2iOtzwSaEgX5GURybiMlz5dXus4jRZZvkFeHH7H68eQntqsJEmzmCxx/del7kgOuqevhASP8WuZSwqIQi/mwBpunWh3T2Au96/bo/QLM8XrEkXL7HjnSaaezcR9eR0ixPzm7Qb5Ja0Fr/dD4/xlSPIrS9u6pf2lafydEDOZIntdyx1Hd4T2qu9sil/5XzPkW128Og3yo1EJUp68okt5607AnDzw//TD0yeYPAUULPc48KuXZWKJhBjYaljSwq2sbIKyiqkXNlufmDQUioCRdDdxT/qPYzLD+Wc5BUhkyY3mGGmWxyq30RbKp1nB2SqMea1p68bR4lGiJz59wqmtB33RnsyweFGjBWKpJaN05s/+BfuPLHhEdSv9Ovsesuj91V5NWm2iqXN/7KFMNlB0ha3O3Z79EpVg/9uECMrR7CW1gF2eZOyq78XKZtopQLbnauzKvQdevr4Rb0x/Fg6z9rtGkSz9FCjiGX4nATqhH1wslAxgN8ogzZ7sdUKfrL61WFyR8iYLP8oXHIyfVHcWgyyYfMC+pjtZ1XGPDVKHsciWBYpUZT8pQz2/iZziq6d/J00yzI+K0uR4D8+skf5WA76K6/0lOvs/DgRhHVGbp66UV1aCX+21OOF4sn4GuwVDjEiemGWZTQtMmR3ZHkOiqQkvCwzaLl5dYC0ssrR5m/O+pb1b7eWsKHzenYdujjaF11MRGP3b/lZ96UYvu/rbq4SJmuWkLd1ztU1mrzUKRmUg5MKdhf7k8HiR6IIuv0UgzkXPThWclc1clnJziyz/rstlGfhvajK1NBmKP0bA1hPAHzMPfPY6bvvjg7ePiTZsRLC/Wz7v8ORBeO/Ikity+ddu5qeXNpF81br3g6OfekIJv1vWDo5eoj/LV5U9CLePwWIKrbh+tznIibI8+VP7QbUkwvfZe8K8Vr8zzRsBQw3jJGBQqG5ITBne4XS52WtzlP383XoR08fImBVbhboJXFhN5qpl8RYBdPWXwGs7UOKfnugmIPR/DsL/HmTtK5t/3gPutSeXtFULIyIPVfO7Mw+8U+22l9uG84ck0m1F8nIheF2C7P8dsKWApPjn1f/BCLJM/2GKX7reD+yby3Vg7quF9Vdi/Nn+XycA/mJGnhrw1eqzeKvgz19bjJlibfmLkO7Xn/vWXN0ULOgZJgu/U41w+u/cU9k9wlz6CKg24l0jS0b3nfREs6ggFmvoSyILQkeTyzd/B7jj/w7+3zfhfw8yseJKXiZZzXAM+xFeicLSgczKbASOu/134P/3IPzvweOgtdHFCP72tuubu8mPyjKTZiIOrF2Vq6Y8921cn/LJTti0TYk8/DI1s7x/LpjHfmcKg39p13e2185kk8P/AUrqYkahTAAA").split(","));function ov(t){return iv(t.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}function iv(t){let e=t.indexOf("1");if(e===-1)return[t];{let r=t.substr(0,e),i=iv(t.substr(e+1));return ae(i.map(o=>[r+"l"+o,r+"i"+o]))}}var nO=l(()=>nv(rv())),ef=3;function nv(t){let e=new yn,r=[];for(let i of t)i.length<ef?r.push(i):e.add(i.slice(0,ef),i);return{trie:e,small:r}}function sO(t,e){let r=Px($d(t.toLowerCase().normalize())),{small:i,trie:o}=e==null?nO():nv(e);for(let n of[r.replace(/[^a-z]/gi,""),...ov(r)]){let s=i.find(a=>n.includes(a));if(s!=null)return s;for(let a=0;a<n.length-(ef-1);a++){let m=o.get(n.substr(a,ef));if(m!=null){let u=n.substr(a),p=m.find(g=>u.startsWith(g));if(p!=null)return p}}}}function aO(t){return sO(t)!=null}function Pm(t){let e=10,r="";do r=t();while(e-- >0&&aO(r.replace(/[^a-z]/gi,"")));return r}var av=BigInt(0);function Ph(t,e,r=0){if(!isFinite(e)||t<=1)return[];let i=[];if(e===0)i.push(0);else for(;e>0;)i.push(e%t),e=Math.floor(e/t);for(;i.length<r;)i.push(0);return i.reverse()}var Mn=class{constructor(e,r,i=jr){this.name=e;this.numerals=r;this.decodePreparser=i;this.base=r.length}digitsToNumerals(e){return e.map(r=>this.numerals[r]).join("")}encode(e,r=0){if(!isFinite(e))return"";let i=e<0;return i&&(e=Math.abs(e),r--),(i?"-":"")+this.digitsToNumerals(Ph(this.base,e,r))}encodeBigInt(e){if(typeof e!="bigint")throw new Error("bad input");if(e===av)return this.numerals[0];let r=[],i=BigInt(this.base),o=e;for(;o>av;)r.push(Number(o%i)),o=o/i;return this.digitsToNumerals(r.reverse())}encodeBuffer(e){if(e==null||e.length===0)return"";let r=[0];for(let i of e)for(r.forEach((o,n)=>{i+=o<<8,r[n]=i%this.base,i=Math.floor(i/this.base)});i>0;)r.push(i%this.base),i=Math.floor(i/this.base);return this.digitsToNumerals(r.reverse())}decode(e){return f(this.decodeBigInt(e),r=>{if(r>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(r)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(e==null||S(e))return;e=ve(this.decodePreparser)?this.decodePreparser(e):e;let r=e[0]==="-";r&&(e=e.slice(1));let i=BigInt(this.base),o=BigInt(0);for(let n of e){let s=this.numerals.indexOf(n);if(s<0)return;o=o*i+BigInt(s)}return r?BigInt(-1)*o:o}randomChars(e){return this.encodeBuffer((0,sv.randomBytes)(e+3)).slice(1,e+1)}safeRandomChars(e){return Pm(()=>this.randomChars(e))}randomUid(e=20,r=5,i="-"){return Qi(this.randomChars(e),r).join(i)}safeRandomUid(e,r=5,i="-"){return Pm(()=>this.randomUid(e,r,i))}tokenEql(e,r,i){let o=this.normalizeToken(e),n=this.normalizeToken(r);return o.length>=i&&o===n}normalizeToken(e){return this.decodePreparser(e.trim()).split("").filter(r=>this.numerals.includes(r)).join("")}},D6=new Mn("hex","0123456789abcdef",t=>t.toLowerCase()),Pn=new Mn("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),lO=new Mn("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",t=>t.toLowerCase()),Ps=new Mn("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",t=>t.toLowerCase()),tf=new Mn("TokenRadix","0123456789abcdefhjkmnpqrtuvwxy",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9")),A6=new Mn("AlphaRadix","abcdefghjkmnpqrtuvwxyz"),F6=new Mn("NumericRadix","0123456789",t=>t.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[z]/g,"2").replace(/[s]/g,"5").replace(/[g]/g,"9"));function rf(t,e){let r=t.toUpperCase().normalize(),i=e.toUpperCase().normalize();return Xi(()=>r===i?1:void 0,()=>S(t)!==S(e)?0:void 0,()=>t.length===1&&e.length===1?0:void 0,()=>{let o=lv(r),n=lv(i),s=mO(o,n).length;return 2*s/(o.length+n.length)})}function lv(t){return t==null||t.length===0?[]:t.slice(0,-1).split("").map((e,r)=>e+t[r+1])}function mO(t,e){let r=Yd(t,e),i=[];return r.forEach(o=>{let n=Math.min(ci(t,s=>s===o),ci(e,s=>s===o));ye(n,()=>i.push(o))}),i}function mv(t){let e=t+`
`;return I?e.replace(Po,`\r
`):e}function ro(...t){return ae(t.map(e=>h(e).split(Po)))}var bv=T(require("fs")),Dm=T(require("fs-extra")),Es=T(require("path"));var el=T(require("fs-extra")),Fh=T(require("path"));var Eh=T(require("crypto")),uv=T(require("fs"));var cv=192;async function of(t,e){let r=Eh.default.createHash("sha512"),i=0,o=x(e?.msbits,cv)/8;return await le(t,n=>new Promise((s,a)=>{let m=uv.default.createReadStream(n,{autoClose:!0});m.on("error",u=>a(u)),m.on("data",u=>{i+=u.length,e?.observer?.onProgress(i),r.update(u)}),m.on("end",()=>s())})),r.digest().slice(0,o)}function uO(t,e=cv){return Eh.default.createHash("sha512").update(t).digest().slice(0,e/8)}function Jr(t,e=9,r=Pn,i=224){return r.encodeBuffer(uO(t,i)).substring(0,e)}function En(t,e=24,r=Ps,i=224){return Jr(t,e,r,i)}var pv=T(require("fs")),Em=T(require("fs-extra")),dv=T(require("util")),Za=T(require("zlib"));function cO({message:t,cause:e,retriable:r,ignorable:i,fatal:o,doNotSend:n}){let s=[t];U(Ge(ce(e),"Error: "),m=>s.push(m));let a=Ex(V(s)).join(": ");return o=o||a.includes(pe),r=(r||a.includes(Na))&&!a.includes($t),n=n||!a.includes(ko),i=i||a.includes(hm),Vc(zc(a),o?pe:void 0,n?Gr:void 0,i&&!o?hm:void 0,!r&&!o?$t:void 0,r&&!o?Na:void 0)}var me=class extends Error{constructor({cause:e,message:r,retriable:i=!0,ignorable:o=!1,fatal:n=!1,doNotSend:s=!1}){super(cO({message:r,cause:e,retriable:i,ignorable:o,fatal:n,doNotSend:s}));this.cause=e,e!=null&&(this.stack=e.stack),this.retriable=i,this.fatal=n}};var fv=T(require("stream"));var Dh=class extends fv.Writable{constructor(e){super(e);this.deferred=new Mr("WritableToBuffer");this._buf=[];this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",r=>{this.deferred.reject(r)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,r,i){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,r)),i()}};var fO=l(()=>d("zcat"));async function hv(t,e){try{return b(nf(t,e),h)}catch(r){fO().warn("zcat failed to read "+t,r);return}}async function Ah(t,e,r){if((await(0,Em.stat)(t)).size===0)return;let o=[],n=[(0,pv.createReadStream)(t,y({autoClose:!0},r)).on("error",s=>o.push(s))];if(t.toLowerCase().endsWith(".gz")?n.push((0,Za.createGunzip)().on("error",s=>o.push(s))):t.toLowerCase().endsWith(".br")&&n.push((0,Za.createBrotliDecompress)().on("error",s=>o.push(s))),n.push(e),await Ms(n),_(o))throw new me({message:"zReadFile("+t+") failed",cause:o[0]})}async function nf(t,e){if((await(0,Em.stat)(t)).size===0)return Buffer.from([]);let i=new Dh;return await Ah(t,i,e),await i.buffer}async function gv(t){return JSON.parse((await nf(t)).toString())}var pO=(0,dv.promisify)(Za.gzip);async function yv(t,e){let r=O(e),i=await pO(r);return(0,Em.outputFile)(t,i)}var dO="readdircache",hO=l(async()=>{let t=(0,Fh.join)(c.cacheDir.valueOrDefault,dO);return await(0,el.mkdirp)(t),t},E);async function gO(t){return(0,Fh.join)(await hO(),...Qi(En(t)+".json.gz",2,3))}var Lh=l(()=>d("Readdir"));function Ih(t){return t!=null&&P(t.basename)&&Vd(t.isFile)&&Vd(t.isDirectory)}C(()=>{q(()=>sf.prior()?.clear()),pr(t=>{t==null?sf.prior()?.clear():sf.prior()?.deleteIf(e=>e.startsWith(t))})});var sf=l(()=>new to({maxSize:500,timeoutMs:H,clearEveryMs:E}));async function Rh(t){let e=await sf().getOrSetAsync(t,()=>yO(t));if(e==null)throw new Error("readdir() timeout for "+t);return e}async function yO(t){let e=await gO(t);try{let o=(await(0,el.stat)(e)).mtimeMs;if(Date.now()-o<c.readdirCacheSeconds.valueOrDefault*M){let n;if(await je(async()=>(n=await gv(e),n!=null&&Array.isArray(n)&&n.every(Ih)),{timeoutMs:H-M,timeBetweenMs:250}))return n}}catch(o){o.code!=="ENOENT"&&Lh().debug("Failed to read from readdir cache",o)}let r=await Ya((0,el.readdir)(t,{withFileTypes:!0})),i=Mx(r.result.map(o=>({basename:o.name,isFile:o.isFile(),isDirectory:o.isDirectory()})),o=>o.basename);if(r.elapsedMs>=500)try{await yv(e,i),Lh().debug("Wrote readdir cache for slow directory",{nativePath:t,elapsedMs:r.elapsedMs})}catch(o){Lh().debug("Failed to write to readdir cache",o)}return i}var Am=class{constructor(e,r){this.base=e;Ih(r)?(this.isFile=r.isFile,this.isDirectory=r.isDirectory):(this.isFile=r.isFile(),this.isDirectory=r.isDirectory()),r instanceof bv.Stats&&(this.size=r.size,this.mtimeMs=r.mtimeMs)}},wv=l(()=>d("DirectoryEntry")),$r=class{constructor(e,r){this.dir=e;this.dirent=r;this.nativePath=(0,Es.join)(this.dir,r.base),this.ext=Oi(r.base).ext}static async for(e){let r=Oi(e);try{let i=await(0,Dm.stat)(e);return new $r(r.dir,new Am(r.base,i))}catch{return}}async join(...e){return $r.for((0,Es.join)(this.nativePath,...e))}get base(){return this.dirent.base}get name(){return zt(this.base,this.ext)}get pathnames(){return this.nativePath.split(Es.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}get isRoot(){return this.dir===(0,Es.parse)(this.dir).dir}parent(){let e=Oi(this.dir);return e.dir===this.dir?this:new $r(e.dir,{base:e.base,isFile:!1,isDirectory:!0,mtimeMs:void 0,size:void 0})}async childNames(){try{return this.isDirectory()?(await Rh(this.nativePath)).map(e=>e.basename):void 0}catch(e){wv().warn("childNames() failed to readdir("+this.nativePath+")",e);return}}async children(){try{return this.isDirectory()?(await Rh(this.nativePath)).map(r=>new $r(this.nativePath,new Am(r.basename,r))):void 0}catch(e){wv().warn("children() failed to readdir("+this.nativePath+")",e);return}}async visitDescendantFiles(e){for(let r of A(await this.children()))await(r.isFile()?e(r):r.isDirectory()?r.visitDescendantFiles(e):void 0)}async filterDescendantFiles(e){let r=[];return await this.visitDescendantFiles(async i=>{await e(i)===!0&&r.push(i)}),r}stat(){return(0,Dm.stat)(this.nativePath).catch(()=>{})}async size(){return Ee(this.dirent.size,()=>b(this.stat(),e=>e.size))}async mtimeMs(){return Ee(this.dirent.mtimeMs,()=>b(this.stat(),e=>e.mtimeMs))}unlink_(){return(0,Dm.unlink)(this.nativePath)}};var bO=64,Fm=class extends ke{constructor(){super(bO);C(()=>pr(e=>this.clearFromPath(e))),C(()=>q(()=>this.clear())),this.on("expire",(e,r)=>r?.clear())}clearFromPath(e){S(e)?this.clear():this.visit((r,i)=>{r.startsWith(e)&&i.clear()})}};var xv=T(require("stream"));var Ds=class extends xv.Transform{constructor(){super({objectMode:!1,autoDestroy:!0})}async _transform(e,r,i){let o=(h(this._prior)+h(e)).split(Po),n=o.pop();this._prior=n===""?void 0:n;for(let s of o)this.push(s)||await gt(1);i()}_flush(e){this._prior!=null&&this.push(this._prior),this._prior=void 0,e()}};var af=T(require("timers"));function wO(t){return t!=null&&P(t.path)&&P(t.op)&&St(0,100,t.pct)}var xO="progress";function Oh(t){wO(t)&&Me.emit(xO,y(y({},t),{pct:Xe(Y(0,100,t.pct))}))}function Lm(t,e,r=!1){let i=r?Date.now()+e:0,o=0,n=(...s)=>{let a=Date.now();if(a>=i)return i=a+e,o++,t(...s)};return n.count=()=>o,n}var lf=500,Dn=class{constructor(e,r,i=lf){this.context=e;this.total=r;this.throttleMs=i;this.start=Date.now();this.emit=Lm(()=>{Oh(y(y({},this.context),{pct:this.pct,elapsedMs:this.elapsedMs}))},this.throttleMs,!0)}incrProgress(e){this.onProgress(e+x(this.current,0))}onProgress(e){this.current=Y(0,this.total,x(e,x(this.current,0)+1)),this.emit()}get pct(){return Xe(100*x(this.current,0)/this.total)}get elapsedMs(){return Date.now()-this.start}},As=class{constructor(e,r,i,o=lf){this.ctx=e;this.total=r;this.progress=i;this.throttleMs=o;this.start=Date.now();this.onInterval=Lm(()=>b(this.progress(),n=>this.emit(n)),this.throttleMs),this.timer=(0,af.setInterval)(()=>this.onInterval(),lf)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){f(e,r=>Oh(y(y({},this.ctx),{pct:100*Y(0,this.total,r)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>lf&&this.emit(this.total),this.end()}end(){f(this.timer,e=>(0,af.clearInterval)(e)),this.timer=void 0}};var Fs=T(require("path")),Sv=T(require("process"));var Tv=T(require("fs")),kh=T(require("path"));function vv(t){let e=[];for(;t!==(0,kh.dirname)(t);)t=(0,kh.dirname)(t),e.push(t);return e}function TO(t){try{return(0,Tv.readdirSync)(t)}catch(e){return[]}}function mf(t,e){let r=TO(t);return e.every(i=>r.includes(i))}var _h=l(()=>(0,Fs.dirname)(process.execPath)),dr;(function(u){u.Root=l(()=>{let p=["icc","migrations","public","views"],g=[];de()&&g.push("/ps/app"),Xt&&g.push((0,Fs.join)(_h(),"resources"),(0,Fs.join)(_h(),"..","Resources")),g.push(...V([_h(),(0,Sv.cwd)(),__dirname])),mx(g);for(let v of g){if(mf(v,p))return v;for(let D of vv(v).slice(0,4)){if(mf(D,p))return D;let W=(0,Fs.join)(v,"node_modules","photostructure");if(mf(W,p))return W}}throw new Error("Failed to find project root. Looked in "+g)});let e=p=>l(()=>(0,Fs.join)(u.Root(),p));u.Bin=e("bin"),u.ICC=e("icc"),u.Migrations=e("migrations"),u.Public=e("public"),u.Tools=e("tools"),u.Views=e("views");async function m(p=u.Root()){return re?new RegExp(`^\\/Volumes\\/${Lo}[^\\/]*\\/${Lo}.app\\/`,"i").exec(p)!=null:!1}u.isInDMG=m})(dr||(dr={}));function An(t,e,r){let i=new Mv(e,r,!0);return i.read(t),i.done}var Mv=class{constructor(e,r,i=!0){this.sep=e;this.onData=r;this.filterBlanks=i;this.incompleteChunk="";this.done=new Wt}onChunk(e){if(e==null)return;let i=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=i.pop(),i.forEach(o=>{(!this.filterBlanks||P(o))&&this.onData(o)})}clear(){this.onChunk(""),P(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",r=>this.onChunk(r)),e.on("end",()=>{this.clear(),this.done.resolve()}),this}};var Ev=I?"wip-":".",Nh=new Fm,wi=class{constructor(e,r){this.dirent=r;this.bflog=l(()=>d("BaseFile("+this.nativePath+")"));this._childDirectoryEntries=l(()=>b(this.directoryEntry(),e=>e.children()));this.stat=l(()=>this.trap("stat",()=>it.default.stat(this.nativePath).catch(()=>{})),wi.attrTTL);this.statSync=l(()=>this.trapSync("statSync",()=>ze(()=>Br.default.statSync(this.nativePath))),wi.attrTTL);this.shaResult=l(async()=>{let e=await this.size();if(e===0||e==null)return;let r=e>5*Zi?new Dn({op:"Computing SHA of",path:this.nativePath},e):void 0,i=await bi(()=>this.trap("sha",()=>of([this.nativePath],{observer:r}))),o=f(i.result,n=>n.toString("base64"));return{elapsedMs:i.elapsedMs,buffer:i.result,b64:o}},wi.attrTTL);if(r!=null)this.nativePath=r.nativePath,this.dir=r.dir,this.base=r.base,this.name=r.name,this.ext=r.ext;else{this.nativePath=_r(e);let i=Oi(this.nativePath);this.dir=i.dir,this.base=i.base,this.name=i.name,this.ext=i.ext}this.posixPath=hi(this.nativePath),Nh.set(e,this)}toJSON(){return{nativePath:this.nativePath}}[Pv.inspect.custom](){return this.toJSON()}static async withFastestAccess(e){let r=F(e),i=await Promise.all(r.map(o=>o.shaMs()));return r[qd(i)]}static forPosix(e){return e instanceof wi?e:this.for(e.split("/").join(Fn.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(e instanceof wi)return e;let i=Nh.get(e);if(i!=null)return i;let o=_r(e);return Nh.getOrSet(o,()=>new wi(o,r))}static clear(e){Or(e)}for(e,r){return wi.for(e,r)}clear(){return this.dirent=void 0,this._childDirectoryEntries.unset(),this.stat.unset(),this.statSync.unset(),this.shaResult.unset(),this}clearThisAndParent(){return Or(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return e==null?!1:e instanceof wi?this.nativePath===e.nativePath:this.nativePath===wi.for(e).nativePath}get isUNC(){return gh(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return Gc(e,this)}async directoryEntry(){return this.dirent==null&&(this.dirent=await b(this.stat(),e=>new $r(this.dir,new Am(this.base,e)))),this.dirent}async childDirectoryEntries(e){let r=await this._childDirectoryEntries();return r==null||e==null||R(r)?r:await xn(r,e)}_directoryEntryChild(e){return this.for((0,Fn.join)(this.nativePath,e.base),e)}childNames(){return b(this.childDirectoryEntries(),e=>e.map(r=>r.base))}async children(e){return(await this.childDirectoryEntries(e))?.map(r=>this._directoryEntryChild(r))}async childFiles(e){let r=[];for(let i of A(await this.childDirectoryEntries()))if(i.isFile()){let o=this._directoryEntryChild(i);(e==null||await e(o))&&r.push(o)}return r}async childDirectories(e){return b(this.childDirectoryEntries(),r=>vs(r.filter(i=>i.isDirectory()).map(async i=>QT(this._directoryEntryChild(i),e))))}childrenSync(){return x(this.trapSync("childrenSync",()=>Br.default.readdirSync(this.nativePath).map(e=>this.join(e))),[])}async hasChildren(e){let r=await this.childNames();return _(e)?uc(r,e):_(r)}async hasNoChildren(){return await this.isFile()||R(await this.childNames())}async visitDescendants(e){return b(this.children(),async r=>{for(let i of r)await i.visitDescendants(e),await e(i)})}async descendants(e){let r=[];for(let o of A(await this.childFiles()))await e(o)&&r.push(o);let i=await this.childDirectories();if(i!=null)return await pi({name:"descendants",laters:i.map(o=>()=>b(o.descendants(e),n=>r.push(...n)))}),r}async ancestorWithChildren(e){return await this.hasChildren(e)?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}async siblings(e){let r=this.parent();return(await this.siblingDirectoryEntries(e))?.map(i=>r._directoryEntryChild(i))}async siblingDirectoryEntries(e){return this.parent().childDirectoryEntries(async r=>r.base!==this.base&&(e==null||await e(r)))}async selfAndSiblings(){return this.parent().children()}async firstExistingSelfOrAncestor(){return this.isRoot||await this.exists()?this:this.parent().firstExistingSelfOrAncestor()}get pathnames(){return this.nativePath.split(Fn.sep).filter(e=>e!=null&&e!=="")}get pathnamesWithoutDrive(){return I?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(I?1:0)}get isRoot(){return this.pathnames.length===(I?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return e!=null&&(this.nativePath===e.nativePath||mc(e.pathnames,this.pathnames))}isDescendantOf(e){return e!=null&&e.isAncestorOf(this)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){let e=this.parent();return this.isRoot?[]:[...e.parents(),e]}async normalize(){return this.isUNC?this:await this.exists()||this.isRoot?this:b(this.parent().normalize(),async e=>{let r=await e.childNames();if(_(r)){for(let o of r)if(o===this.base)return e.join(o);let i=this.base.normalize();for(let o of r)if(o.normalize()===i)return e.join(o);if(re||I){for(let o of r)if(at(o,this.base))return e.join(o)}}})}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return R(e)||kt(["."],e)?this:RT(e[0])?this.for((0,Fn.join)(...e)):this.for((0,Fn.join)(this.nativePath,...e))}joinYMD(e=new Date){return Lw(e?.getFullYear(),e?.getMonth(),e?.getDate(),(r,i,o)=>this.join(h(r),Kt(i+1),Kt(o)))}child(...e){if(R(e))return this;let r=ae(e.map(i=>i.split(Fn.sep))).filter(i=>i!=="..");return this.join(...r)}async trap(e,r,i="warn"){try{return await rt("fs."+e,r)}catch(o){this.bflog().log(i,`trap: ${e}() failed: ${o}`);return}}async trapOr(e,r,i="warn"){try{return this.bflog().trace(`trapOr ${e}()`),await r(),!0}catch(o){return this.bflog().log(i,`trapOr: ${e}() failed: ${o}`),!1}}trapSync(e,r){try{return this.bflog().trace(`trapSync ${e}()`),r()}catch(i){this.bflog().warn(`trapSync: ${e}() failed: ${i}`);return}}async exists(){return this.dirent!=null||await gT(this.stat())}existsSync(){return this.dirent!=null||this.statSync()!=null}async notExists(){return Mt(this.exists())}mtime(){return b(this.stat(),e=>e.mtime)}mtimeMs(){return b(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return b(this.stat(),e=>$i(e.mtime))}async lastModifiedUtc(){return b(this.stat(),e=>e.mtime.toUTCString())}statTimes(){return b(this.stat(),e=>K([e.birthtimeMs,e.mtimeMs,e.ctimeMs].filter(r=>r!=null&&r!==0)))}maxStatMs(){return b(this.statTimes(),Pc)}maxStatDate(){return b(this.maxStatMs(),e=>new Date(e))}minStatMs(){return b(this.statTimes(),Fc)}minStatDate(){return b(this.minStatMs(),e=>new Date(e))}size(){return b(this.stat(),e=>e.size)}async access(e){try{return await it.default.access(this.nativePath,e),!0}catch{return!1}}isExecutable(){return this.access(Br.default.constants.R_OK|(I?0:Br.default.constants.X_OK))}isReadable(){return this.access(Br.default.constants.R_OK)}isNotReadable(){return Mt(this.isReadable())}isReadWritable(){return this.access(Br.default.constants.R_OK|Br.default.constants.W_OK)}isNotReadWritable(){return Mt(this.isReadWritable())}isHiddenPosix(){return this.base.startsWith(".")}async isEmpty(e=0){if(await this.isDirectory())return _(await this.childNames());{let r=await this.size();return r==null||r<=e}}isNonEmpty(e=1){return Mt(this.isEmpty(e))}async isNonEmptyFile(e=1){return await this.isFile()&&await this.isNonEmpty(e)}async modifiedGTE(e){return b(this.mtime(),r=>$i(r)>=$i(e))}async modifiedCloseTo(e,r){return b(this.mtimeMs(),i=>Math.abs(i-e)<=r)}async isRecent(e){let r=await this.maxStatMs();return r!=null&&r>Date.now()-e}async modifiedGT(e){if(e!=null)return b(this.mtime(),r=>$i(r)>$i(e))}async isDirectory(){return this.dirent!=null?this.dirent.isDirectory():he(this.stat(),e=>e.isDirectory(),()=>!1)}async isNotDirectory(){return Mt(this.isDirectory())}isDirectorySync(){return this.dirent!=null?this.dirent.isDirectory():$(this.statSync(),e=>e.isDirectory(),()=>!1)}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile(){return this.dirent!=null?this.dirent.isFile():this.stat().then(e=>z(e).map(r=>r.isFile()).getOrElse(()=>!1))}isFileSync(){return this.dirent!=null?this.dirent.isFile():z(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>it.default.rmdir(this.nativePath),e)}async mkdirp_(){try{await it.default.mkdirp(this.nativePath)}catch(e){if(e.code!=="EEXIST")throw e}if(await je(()=>this.clear().isDirectory(),{timeoutMs:2*M,timeBetweenMs:200})===!1)throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return await this.clear().isDirectory()||this.isRoot?this:this.trap("mkdirp",async()=>this.mkdirp_())}mkdirpSync_(){return it.default.mkdirpSync(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",()=>this.mkdirpSync_())}sha(){return b(this.shaResult(),e=>e.b64)}shaMs(){return b(this.shaResult(),e=>e.elapsedMs)}async writeStream_(e,r){return await Ms(F([e,f(r?.onProgress,i=>new hh(i)),it.default.createWriteStream(this.nativePath,r)])),this.clearThisAndParent()}async writeJsonMaybe(e,r={}){return this.trap("writeJsonMaybe",()=>this.writeJSON_(e,r))}async writeJSON_(e,r={}){return await this.parent().mkdirp(),await it.default.writeFile(this.nativePath,O(e,r.replacer,r.spaces),y({flag:"w"},r)),this.clearThisAndParent()}readJson(e="warn"){return this.trap("readJson",()=>gi(async()=>await this.isNonEmptyFile()?it.default.readJson(this.nativePath):void 0,{maxRetries:1,onRetryWaitUntil:()=>fr(e==="warn"?250:25),errorIsRetriable:r=>r.errno!==-2}),e)}readJsonSync(){return this.trapSync("readJsonSync",()=>it.default.readJsonSync(this.nativePath))}readFileSync_(){return it.default.readFileSync(this.nativePath)}readFile_(){return it.default.readFile(this.nativePath)}readFile(e="warn"){return this.trap("readFile",()=>this.readFile_(),e)}async zReadFile_(e){return nf(this.nativePath,e)}async zcat(e){return this.trap("zcat",()=>b(this.zReadFile_(e),h))}async zCopyFile(e,r){return this.trap("zCopyFile",async()=>(await e.parent().mkdirp(),await Ah(this.nativePath,Br.default.createWriteStream(e.nativePath),r),e))}readLines(){return b(this.readFile(),e=>ro(e.toString()))}readFileSync(){return ze(()=>f(Br.default.readFileSync(this.nativePath),h))}writeTxt_(e){return this.writeFile_(mv(e))}async writeFile_(e){return await this.parent().mkdirp(),await it.default.writeFile(this.nativePath,e),this.clearThisAndParent()}wip(e=Ev){return this.sibling(e+this.base)}async unwip_(e=Ev){let r=this.sibling(Ge(this.base,e));return this.mv_(r,{overwrite:!0})}async dest(e){let r=e.clear();return P(this.ext)&&S(r.ext)||await r.isDirectory()?r.join(this.base):r}copyFile_(e){return rt("fs.copyFile",async()=>{let r=(await this.dest(e)).clear();if(this.nativePath===r.nativePath)return this;if(await r.parent().mkdirp()==null)return this.bflog().throw("Cannot mkdirp "+r.dir);try{return await this._copyFile(r)}catch(o){if(cT(o))throw o;return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:r.nativePath,error:o}),await this._nativeCopyFile(r)}finally{this.clearThisAndParent()}})}async _copyFile(e){let r,i,o=e;try{let n=await Ee(this.stat(),()=>this.clear().stat());if(n==null)return this.bflog().throw("Can't copy missing files"+$t);if(n.size===0)await e.touch(n.mtime,n.atime);else{if(c.verifyFileCopies.valueOrDefault&&await this.sha()==null)return this.bflog().throw("Can't copy file without SHA"+$t);i=e.wip();let s=it.default.copyFile(this.nativePath,i.nativePath);n.size>5*Zi&&(r=new As({op:"Copying",path:this.nativePath,dest:e.nativePath},n.size,()=>i.clear().size())),await s;let a=await je(async()=>n.size===await i.clear().size(),{timeoutMs:H});if(c.verifyFileCopies.valueOrDefault){let m=a&&await je(()=>ds(this.sha(),i.clear().sha()),{timeoutMs:H});if(!m)return this.bflog().throw("copyFile_() failed",{sizeMatches:a,shaMatches:m})}if(!a)return this.bflog().throw("copyFile_() failed",{expectedSize:n.size,actualSize:await i.clear().size()});if(o=await i.unwip_(),o==null)return this.bflog().throw("copyFile_("+e+") failed: .unwip() was null");await it.default.utimes(o.nativePath,n.atime,n.mtime)}try{await it.default.chmod(o.nativePath,n.mode)}catch(s){this.bflog().debug(`copyFile_(${o.nativePath}) warning: couldn't chmod to ${n.mode}: ${s}`)}return this.bflog().debug(`copyFile_(${e.nativePath}): success`),ah(this.nativePath,e.nativePath),e}catch(n){throw this.bflog().warn(`copyFile_(${i?.nativePath}) failed: ${n}`),await i?.unlink(),await e.unlink(),n}finally{f(r,n=>n.end())}}async copyTimeoutMs(){return he(this.size(),e=>Math.max(H,e*jc),()=>H)}async _nativeCopyFile(e){let r;try{if(await e.parent().mkdirp()==null)return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});let i=await this.stat(),o=f(i,n=>n.size);return i==null||o==null?this.bflog().throw("Can't copy missing files"):(o>5*Zi&&(r=new As({op:"Copying",path:this.nativePath,dest:e.nativePath},o,()=>e.clear().size())),I?await Te.instance().execute(`Copy-Item -LiteralPath ${Is(this.nativePath)} -Destination ${Is(e.nativePath)}`,n=>n):await se("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:await this.copyTimeoutMs()}),ah(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(i){return this.bflog().throw("_nativeCopyFile("+e+"): "+i)}finally{f(r,i=>i.end())}}async touch(e=Date.now(),r){return this.trap("touch",()=>b(this.ensureFile(),()=>this.utimes(e,r)))}async utimes(e,r){let i=x(e,Date.now()),o=x(r,i);return this.trap("utimes",()=>it.default.utimes(this.nativePath,$i(o),$i(i)).then(()=>this.clearThisAndParent()))}async unlink(e="warn"){return this.trap("unlink",async()=>(await it.default.unlink(this.nativePath),this.clearThisAndParent()),e)}async rmrf(e="info"){return this.trap("rmrf",async()=>(this.bflog().log(e,"rmrf()"),await it.default.remove(this.nativePath),this.clearThisAndParent()))}async unlock(){return re&&await this.clear().exists()&&await se("chflags",["nouchg",this.nativePath],{timeout:H}),this}async renameWithNameSuffix_(e){return b(this.withNameSuffix(e).ensureNew_({emptyIsNew:!0}),r=>r.unlink("debug").then(()=>this.mv_(r)))}async mv_(e,r={overwrite:!1}){let i=await this.dest(e);if(this.nativePath===i.nativePath)return this.bflog().warn("mv(): no-op",new Error("internal error")),this;await i.parent().mkdirp(),this.bflog().debug("mv",i);try{await it.default.move(this.nativePath,i.nativePath,r)}catch(o){this.bflog().warn("mv() try #1 failed. Calling unlock() and waiting for source to be non-empty.",o),await Promise.all([this.unlock(),i.unlock()]),await je(()=>this.clear().isNonEmptyFile(),{timeoutMs:7*M}),await it.default.move(this.nativePath,i.nativePath,r)}return await i.unlock(),this.clearThisAndParent(),i.clearThisAndParent()}async pipeTo(e,r){return this.trap("pipeTo("+e+")",async()=>{let i=await this.sibling(e).ensureNew_();return await Ms([Br.default.createReadStream(this.nativePath),r,Br.default.createWriteStream(i.nativePath)]),await this.unlink(),i})}async gunzip(){return this.pipeTo(zt(this.base,".gz"),(0,Ls.createGunzip)())}async gzip(){return this.pipeTo(this.base+".gz",(0,Ls.createGzip)())}async compressBrotli(){return this.pipeTo(this.base+".br",(0,Ls.createBrotliCompress)())}ensureFile(){return this.trap("ensureFile",()=>it.default.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync_(){return it.default.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return Kr(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get baseWithoutCountWithParent(){return this.parent().base+"/"+this.baseWithoutCount}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}async ensureNewNativePath(e){return Kc(y({nativePath:this.nativePath},e))}ensureNew_(e={}){return this.ensureNewNativePath(e).then(r=>this.for(r))}async renameYMDHMS_(e){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");let r=Hw(await Ee(this.mtime(),()=>new Date)),i=$(e,o=>this.parent().join(o),()=>this.parent());return this.mv_(i.join(this.name+"-"+r+this.ext),{overwrite:!0})}async saveIfNewOrDelete(e){if(await this.clear().isEmpty()){await this.unlink("trace");return}let r=await this.siblingWithSameContents();if(r!=null)return await this.unlink(),r;let i=await this.sibling(e).ensureNew_();return this.mv_(i)}async chmod(e){return await it.default.chmod(this.nativePath,e),this.clear()}zreadline(){return Br.default.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe((0,Ls.createGunzip)()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)}).pipe(new Ds)}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return rt("fs.childWithSameContents",async()=>{if(await this.notExists()||!await this.isDirectory())return;let r=await e.size(),i=await this.children(),o=[];for(let s of A(i))await s.size()===r&&!e.eql(s)&&o.push(s);if(R(o))return;let n=await e.sha();for(let s of o.sort((a,m)=>rf(a.base,m.base)).reverse())if(await s.sha()===n)return s})}async applyWip(e,r=0,i=15*M){let o=this.wip();try{if(await o.parent().mkdirp(),(await o.clear().isRecent(i)||await this.clear().isRecent(i))&&(this.bflog().info("applyWip(): recent WIP exists. Waiting for a bit to see if someone else will do my work."),await je(()=>this.clear().isNonEmpty(r),{timeoutMs:i*2,timeBetweenMs:500}))){this.bflog().info("applyWip(): yay, someone else did my work.");return}await this.touch(),await o.unlink("trace");let n=await e(o);if(await je(()=>o.clear().isNonEmptyFile(),{timeoutMs:M}))return await o.unwip_(),n;throw new Error("applyWip(): empty after apply for "+this)}catch(n){throw await o.unlink(),await this.unlink(),n}}async applyIfEmpty_(e,r=0){return await this.clear().isNonEmpty(r)?this.bflog().debug("applyIfEmpty(): non-empty"):(this.bflog().debug("applyIfEmpty(): empty, applying..."),await this.applyWip(e,r)),this.touch()}firstMatchingLine(e){let r=new Mr("firstMatchingLine("+this+")"),i=Br.default.createReadStream(this.nativePath,{flags:"r"});return i.on("error",o=>{o.errno===-2||o.code==="ENOENT"?(r.maybeResolve(void 0),i.close()):r.maybeReject(o)}),i.on("close",()=>r.maybeResolve(void 0)),An(i,Po,o=>{let n=e.exec(o);n!=null&&(r.maybeResolve(n),i.close())}),r.promise}contemporary(e,r){return za(this.statTimes(),e.statTimes(),(i,o)=>{for(let n of i)for(let s of o)if(_w(n,s,r))return!0;return!1},()=>!1)}},ie=wi;ie.attrTTL=3*E,ie.projectRoot=l(()=>{let e=dr.Root();if(e==null)throw new Error("Cannot find project path");return wi.for(e)});function uf(t){let e=F(t).filter(([r,i])=>r!=null&&i!=null);return new Map(e)}function Rs(t,e){return uf(F(t).map(e))}async function Dv(t,e){if(t==null)return new Map;let r=await Promise.all(F(A(t)).map(i=>e(i)));return uf(r)}var Os=T(require("process"));function _i(t){return h(t).replace(/[-.,\\^$*+?()|[\]{}]/g,"\\$&")}function Av(t,e){let r=[];for(let i of t)try{new RegExp(i),r.push(i)}catch{r.push(_i(i))}return new RegExp(r.join("|"),e)}var Fv=class{constructor(e){this.h=e;this.text=x(e.text,h(e)),this.greedyLeft=x(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}},Bh=l(()=>d("Fixed"));function Bo(t,e,r=!0){return new Lv(t,e,r).entries}var Lv=class{constructor(e,r,i=!0){this.warnIfMissingHeaders=i;let o=r.split(/[\r\n]{1,2}/);this.headerRow=o[0],this.rows=o.slice(1);let n=Math.max(...this.rows.map(s=>s.length));this.col2blanks=new Map(ye(n,s=>[s,ci(this.rows,a=>S(a[s]))])),this.headers=this.extractHeaders(e.map(s=>new Fv(s))),this.entries=this.rows.map(s=>this.headers.map(a=>a.toEntry(s))).map(s=>ft(s)).filter(s=>ct(s).some(P))}extractHeaders(e){let r=this.headerRow;te(e,s=>-s.text.length),e.forEach(s=>{let a=new RegExp(`\\b${_i(s.text)}\\b`,"i"),m=a.exec(r);m==null?this.warnIfMissingHeaders&&Bh().warn("extractHeaders(): Failed to find header!",{re:a,headerLine:r}):(s.indexOf=m.index,r=xx(r,m.index,s.text.length," "))});let i=e.filter(s=>s.indexOf!=null),o=te(i,s=>s.indexOf);o.forEach((s,a)=>{let m=s.indexOf,u=o[a-1],p=a===0?0:u.indexOf+u.text.length-1,[g,v]=s.greedyLeft?[p,m]:[m,p];s.leftIdx=f(this.firstBlankColumn(g,v),D=>D+1),a===0&&s.leftIdx==null&&(s.leftIdx=0),s.leftIdx==null&&Bh().warn("no blank column for "+s.text+" between "+m+" and "+p)}),wt(o,s=>s.leftIdx!=null),o.slice(0,-1).forEach((s,a)=>{let m=o[a+1];s.rightIdx=m.leftIdx-1});let n=A(kx(e.map(s=>s.text),o.map(s=>s.text)));return n.length>0&&Bh().warn("Missing headers",{missingHeaders:n}),o}firstBlankColumn(e,r){return Mo(e,r).find(i=>this.col2blanks.get(i)===this.rows.length)}};var cf=()=>"wmic",Iv=()=>"fsutil";var Rv=()=>"ping";var vO=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;function Ov(t){let e=vO.exec(t);if(e==null)return;let r=e.slice(1,8).map(g=>k(g));if(!nc(r))return;let[i,o,n,s,a,m,u]=r,p=k(e[8],{defaultValue:0});return new Date(Date.UTC(i,o-1,n,s,a,m,u/1e3)-p*E)}var SO=/Date\((\d+)\)/;function kv(t){return z(t).flatMap(e=>SO.exec(e)).flatMap(e=>e[1]).flatMap(k).filter(e=>St(0,Date.now()+xt,e)).map(e=>new Date(e)).get()}var MO=l(()=>d("Ps"));function PO(t){return t!=null&&B(t.pid)&&t.start!=null&&P(t.cmd)}async function _v(t){return b(Im([t]),e=>A(e).find(r=>r.pid===t))}async function Nv(t){return R(t)||lc([Os.default.pid],t)?A(t):b(Im(t),e=>e.map(r=>r.pid))}async function Im(t){let e=A(t).filter(B);if(R(e))throw new Error("Invalid pids: "+O(t));return Jx(b(I?EO(e):DO(e),r=>r.filter(i=>PO(i)&&e.includes(i.pid))),r=>MO().debug("pidInfo()",{pids:e,result:r}))}function AO(t){return t.map(e=>({pid:e.Id,start:kv(e.StartTime),cmd:e.ProcessName}))}var FO="Get-Process",LO="| Select-Object -Property Id,ProcessName,StartTime";function Bv(t){return K([...t.filter(B),Os.default.pid]).join(",")}async function EO(t){if(G()||Te.instance().ended)return IO(t);let e=[FO,"-Id",Bv(t),"-ErrorAction SilentlyContinue",LO].join(" ");return b(Te.instance().executeJsonToA(e),r=>AO(r))}var Cv={maxBuffer:1024*1024,timeout:15*M,ignoreExitCode:!0,ignoreStderr:!0},Vv=["CommandLine","CreationDate","ProcessId"];async function IO(t){let e=["process"];if(_(t)){let o=K([...t.filter(B),Os.default.pid]).map(n=>`ProcessId=${n}`).join(" or ");e.push("where",o)}e.push("get",Vv.join(","));let r=await Je(cf(),e,Cv),i=Zw(Bo(Vv,r.result).map(o=>({pid:k(o.ProcessId,{defaultValue:-1}),start:Ov(o.CreationDate),cmd:h(o.CommandLine)})));return i.find(o=>o.pid===Os.default.pid)||i.push({pid:Os.default.pid,start:new Date(fi),cmd:"node "+Os.default.title}),i}function RO(t){return Bo(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],t).map(e=>({pid:k(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:h(e.COMMAND)}))}async function DO(t){let e=await Je("ps",["-p",Bv(t),"-wwwo","pid,lstart,command"],y(y({},Cv),{ignoreExitCode:!0}));return RO(e.result)}var zv=T(require("path")),Uv=T(require("process"));function xi(){return Rr(Uv.env.PS_CONFIG_DIR,()=>(0,zv.resolve)(Ja(),Tr().toLowerCase()))}var io=l(()=>d("Pids")),OO=10*M;function qv(t,e){if(t==null||e==null)return!1;let r=f(e.start,o=>o.getTime()),i=t.startTime;return B(r)&&B(i)&&Math.abs(r-i)<OO}async function kO(t,e){return t==null||e==null||t.name!==h(e.pid)?!1:qv(await t.readJson(),e)}function jv(t,e=!1){let r=["/PID",h(k(t)),"/T"];e&&r.push("/F"),Wv.default.execFile("taskkill",r)}async function _O(t,e=!1){if(G()||Te.instance().ended)return jv(t,e);try{let r=F(["Stop-Process","-Id",k(t),e?"-Force":void 0]).join(" ");await Te.instance().execute(r,jr)}catch(r){io().warn("killWin(): pwsh error, using TASKKILL: "+r),jv(t,e)}}async function NO(t,e=!1){try{Rm.default.kill(t,e?"SIGKILL":"SIGTERM")}catch(r){if(!String(r).includes("ESRCH"))throw r}}function ff(t,e=!1,r=!0){if(t===Rm.default.pid||t===Rm.default.ppid)throw new Error("cannot self-terminate");return e&&r&&Ln.instance().onKill(t),I?_O(t,e):NO(t,e)}async function pf(t){return await _v(t)!=null}var Ch=class{constructor(e=ie.for(xi()).join("pids")){this.pidsDir=e;this.p=new Yt;this.recentPids=new ke(10*M);this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",async()=>{let r=x(e.everything,!1),i=x(e.force,I),o=await this.pidfiles(),n=await Dv(o,v=>b(v.readJson(),D=>[D.pid,D])),s=K(ae(A(n.values()).map(v=>[v.pid,v.ppid])));if(R(s))return io().debug("killOldProcs(): no pidfiles"),[];let a=await Im(s);if(io().debug("killOldProcs()",{pids:s,allEntries:a}),a==null){X("Pids.killOldProcs(): failed to get process information");return}let m=new Set(a.map(v=>v.pid)),u=a.filter(v=>n.has(v.pid)),p=te(F(u.map(v=>f(n.get(v.pid),D=>qv(D,v)?y(y({},D),v):void 0))),v=>v.pid).filter(v=>Rm.default.pid!==v.pid),g=r?p:p.filter(v=>!m.has(v.ppid)||!m.has(v.pid)||B(v.timeoutTime)&&Date.now()>=v.timeoutTime||e.everythingBefore!=null&&v.startTime<e.everythingBefore);io().debug("killOldProcs()",{trackedEntries:u,victims:g,pidfiles:A(n.values())});for(let v of g)io().debug("killOldProcs(): killing",{entry:v}),ff(v.pid,i,!1);return await this.vacuumPids(),te(g,v=>v.pid)})}async addPid(e,r,i=!1){if(e==null)throw new Error("undefined info");let o=e.pid;if(!B(o))throw new Error("undefined pid");let n=e.ppid+":"+e.pid;return i&&this.recentPids.delete(n),this.recentPids.getOrSet(n,async()=>{let s=this.pidsDir.join(e.pid+".json"),a=z(ze(()=>Oi(e.cmd).base)).filter(P).getOrElse(()=>e.cmd),m=r.getTime(),u=we(e.maxAgeMs,g=>m+g),p=y(y({},e),{cmd:a,startTime:m,timeoutTime:u});return await s.writeJsonMaybe(p)==null?io().throw("Failed to write to "+s,{info:e,force:i}):(io().debug("addPid() wrote "+s,p),s)})}pidfiles(){return this.pidsDir.clear().children(e=>e.ext===".json"&&k(e.name)!=null)}async onKill(e){let r=this.pidsDir.join(e+".json");return b(r.clear().readJson(),i=>this.addPid(y(y({},i),{maxAgeMs:1}),jw(E),!0).catch(o=>{io().info("onKill(): failed to rewrite pidfile: "+o,{pid:e})}))}async vacuumPids(){let e=await this.pidfiles(),r=A(e).map(o=>k(o.name)).filter(B);if(R(r))return;let i=await Im(r);if(i==null){X("Failed to get pidInfo for pids "+r);return}io().debug("vacuumPids",{pids:r,pidfiles:A(e).map(o=>o.base),entries:i});for(let o of e){let n=i.find(s=>h(s.pid)===o.name);(n==null||!await kO(o,n))&&(io().debug("vacuumPids(): Removing old pidfile "+o.base,{psEntry:n,pidfile:await o.readFile().then(h).catch(s=>"(failed to read file: "+s+")")}),await o.unlink())}}},Ln=Ch;Ln.instance=l(()=>new Ch);function df(t,e){return Ln.instance().addPid(t,e)}var $7=l(()=>{let t=[{everything:!1,force:!1,intervalMs:5*E},{everything:!1,force:!0,intervalMs:17*E}].map(e=>Hr(()=>Ln.instance().killOldProcs(e),e.intervalMs));return new lt("ProcCleaner",()=>(t.map(clearInterval),Ln.instance().killOldProcs()),ue.predb)});var Om=Se("AboveNormal","Normal","BelowNormal","Idle"),Vh=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19});var ks=class{constructor(e){this.ttlMs=e;this.expireListeners=[];this.delegate=new Map;this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,r=this.ttlMs){return this.delegate.set(e,Date.now()+(r-this.ttlMs)),this}addIfMissing(e,r){let i=this.delegate.get(e);if(i==null||this.isEntryExpired(e,i))return this.add(e),r()}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(let[r,i]of this.delegate)this.isEntryExpired(r,i)||e(r,r,this)}has(e){return!this.isEntryExpired(e,this.delegate.get(e))}values(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield i)}return r()}entries(){let e=this;function*r(){for(let[i,o]of e.delegate.entries())e.isEntryExpired(i,o)||(yield[i,i])}return r()}toA(){return this.vacuum(),[...this.delegate.keys()]}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}on(e,r){this.expireListeners.push(r)}isEntryExpired(e,r){return nt(r==null||r+this.ttlMs<=Date.now(),i=>{r!=null&&i&&(this.expireListeners.forEach(o=>o(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,r)=>{this.isEntryExpired(r,e)})}};var Hv=l(()=>d("Renice"));C(()=>q(()=>zh.prior()?.clear()));var zh=l(()=>new ks(E));async function hf(t){if(zh().has(t))return;zh().add(t);let e=c.processPriority.valueOrDefault;return we(t,async()=>{try{await(I?BO(t,e):CO(t,x(Vh[e],Vh.BelowNormal))),Hv().info("Renice pid "+t+" to "+e)}catch(r){Hv().info("Failed to renice pid "+t+"",r);return}})}async function BO(t,e){return we(t,r=>Om.mapValid(e,i=>Te.instance().execute(`(Get-Process -Id ${t}).PriorityClass = "${e}"`,o=>o)))}async function CO(t,e=19){return Je("renice",[e,"-p",t].map(h),{timeout:10*M,isIgnorableError:()=>!0,ignoreExitCode:!0,maxRetries:0})}var qh=T(require("process"));var Kv=T(require("process"));var oo=class{constructor(e){this.a=e}async _map(e,r){let i=this.a!=null?await this.a():void 0,o=Uh(i)?await i.get():i;return o!=null?e(o):r()}async isDefined(){return this._map(()=>!0,()=>!1)}async isEmpty(){return this._map(()=>!1,()=>!0)}async get(){return this._map(e=>e,()=>{})}async getRequired(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}async exists(e){return this._map(e,()=>!1)}map(e){return new oo(async()=>this._map(e,()=>{}))}flatMap(e){return new oo(async()=>this._map(e,()=>{}))}filter(e){return new oo(async()=>this._map(async r=>await e(r)?r:void 0,()=>{}))}catch(e){return new oo(()=>this.get().catch(async r=>e(r)))}forEach(e){return new oo(async()=>{let r=await this.get();return await f(r,e),r})}async getOrElse(e){return x(await this.get(),e)}orElse(e){return new oo(async()=>{let r=await this.get(),i=r??await e();return Uh(i)?i.get():i})}};function Uh(t){return t instanceof oo}function Pt(t){return Uh(t)?t:new oo(()=>t)}var Gv;(function(r){r.and=async(...i)=>{for(let o of i)if(!L(await o()))return!1;return!0},r.or=async(...i)=>{for(let o of i)if(L(await o()))return!0;return!1}})(Gv||(Gv={}));async function er(...t){if(t!=null)for(let e of t){if(e==null)continue;let r=await e();if(r!=null)return r}}var Jv="en",gf=l(async()=>Wh(await er(()=>$v(),()=>I?VO():void 0,()=>re?zO():void 0,()=>Ua?UO():void 0)));function $v(t=Kv.default.env){return Iw(t.LC_ALL,t.LC_MESSAGES,t.LANG,t.LANGUAGE)}var WO=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function Wh(t){if(S(t)||at("c",t)||at("posix",t))return Jv;{let e=WO.exec(t);return e==null?Jv:F([e[1],e[2]]).join("-")}}function VO(){return b(Te.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),t=>t.Name)}var Qv={timeout:10*M};function zO(){return Pt(se("defaults",["read","-globalDomain","AppleLocale"],Qv)).flatMap(Wh).get()}var qO=/^([a-z_]+)\s*=\s*"(.+)"$/i;function UO(){return Pt(se("locale",[],Qv)).flatMap(t=>t.split(`
`).map(e=>f(e.match(qO),r=>[r[1],r[2]]))).flatMap(ft).flatMap($v).flatMap(Wh).get()}function Yv(){return{LANG:"C",LC_ALL:"C"}}var jO=l(()=>new Set(ct(c).map(t=>t.key)));function Zv(){let t=jO();return ex(tx(qh.default.env,e=>e==="NODE_ENV"||t.has(e)))}var eS=l(()=>km().filter(t=>t.hasValue()));function HO(){eS.unset()}var tS=l(()=>{try{return new RegExp(c.sensitiveEnvRegExp.valueOrDefault,"i")}catch(t){return console.error(`Invalid setting for "sensitiveEnvRegExp": ${t}. Using default value.`),new RegExp(c.sensitiveEnvRegExp.defaultValue,"i")}});C(()=>{c.sensitiveEnvRegExp.addListener(()=>{tS.unset(),rS.unset()});for(let t of km())t.addListener(HO)});var rS=l(()=>{let t=tS();return La(qh.default.env,(e,r)=>t.exec(e)!=null?void 0:r)});function GO(){return eS().reduce((t,e)=>e.maybeAddToEnv(t),y(y({NODE_ENV:Fo},de()?{PS_IS_DOCKER:"1"}:{}),Xt?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}))}function jh(t){let e=x(t,{}),r=x(e.forceCLocale,!0);return y(y({},Gt(e,"forceCLocale")),{env:KO(e.env,r),detached:!1,shell:!1})}function KO(t,e){let r=Li(y(y(y(y(y({},rS()),{PATH:Xv()}),e?Yv():{}),GO()),x(t,{})));return c.logStdout.deleteFromEnv(r),c.tailLogs.deleteFromEnv(r),r}var tr=l(()=>d("ChildProcess"));function yf(t){return et(t,"pid","killed","connected","exitCode","signalCode")}function iS(t,e){return je(()=>Mt(pf(t)),{timeoutMs:e})}async function _m(t,e=30*M){if(t==null)return!1;let r=t.pid;if(tr().debug("endProcess("+r+")",{killed:t.killed,connected:t.connected}),r<=0)return tr().warn("endProcess(): asked to end invalid pid",yf(t)),!1;if(r===Gh.default.pid)return tr().warn("endProcess(): asked to end MY pid",yf(t)),!1;await fr(250),await ST(t);{let i=t.kill();tr().debug("endProcess("+r+")",{killResult:i,childGotSigterm:t.killed}),i||await ff(r).catch(o=>{tr().warn("endProcess(): kill("+r+",false) failed: "+o)})}if(ze(()=>t.unref()),cs())return!0;if(await iS(r,e))return tr().debug("endProcess(): exitted",yf(t)),!0;{Ln.instance().onKill(r);let i=t.kill("SIGKILL");tr().warn("endProcess("+r+") had to resort to SIGKILL",{killResult:i}),i||await ff(r,!0).catch(o=>{tr().warn("endProcess(): kill("+r+",true) failed: "+o)})}return iS(r,5e3)}function JO(t,e){return t!=="renice"&&t!=="which"&&t!=="where"&&[t,...e].every(r=>!r.endsWith("web.js")&&!r.endsWith("db.js")&&!r.includes("sqlite3"))}function oS(t,e,r,i){let o=new Date,n=!1;t.on("exit",()=>n=!0);let s=JO(e,r);return Ia(async()=>{if(n)return;await je(()=>B(t.pid),{timeoutMs:5*M});let a=t.pid;if(B(a))return s&&await hf(a),df({pid:a,cmd:e,maxAgeMs:i,ppid:Gh.default.pid},o);tr().info("newProc(): not writing pidfile, child_process has no pid",{cmd:e,cp:yf(t)})},I?500:250),t}function Kh(t,e,r,i){let o=jh(i);return tr().debug("spawn()",{command:t,args:e,maxAgeMs:r,opts:o}),oS(Hh.default.spawn(t,e,o),t,e,r)}function In(t,e,r,i){let o=jh(i);return oS(Hh.default.execFile(t,e,o),t,e,r)}async function Je(t,e,r){return gi(()=>$O(t,e,r),{timeoutMs:r.timeout,maxRetries:x(r.maxRetries,3),onRetryWaitUntil:i=>gt(100*i),errorIsRetriable:i=>tr().tap({msg:"stdoutResult.errorIsRetriable()",result:GT(i,/EPERM/),meta:{error:i,cmd:t,args:e}})})}async function $O(t,e,r){let i=x(r.quiet,!1),o=x(r.ignoreStderr,!1),n=x(r.ignoreExitCode,!1),s=[];tr().debug("stdoutResult(): execFile",{cmd:t,args:e});let a=await In(t,e,r.timeout,Gt(r,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(r.disconnect===!0)return a.disconnect(),{result:"",pid:a.pid};let m=O({cmd:t,args:e}),u=new Mr(m);setTimeout(()=>{u.pending&&tr().warn("stdoutResult(): SLOW COMMAND",{cmd:t,args:e})},r.timeout/3).unref(),u.setTimeout(r.timeout);let p=(g,v)=>{if(Qt(v)||ve(r.isIgnorableError)&&r.isIgnorableError(v)){tr().debug("stdoutResult(): ignorable error for "+g,{cmd:t,args:e,opts:r,error:v});return}a.pid!=null&&_m(a),i||tr().warn("stdoutResult(): "+g,{cmd:t,args:e,opts:r,error:v}),u.pending&&u.reject(v)};try{a.on("error",g=>p("on(error)",g)),a.on("close",g=>{let v=Date.now()-u.start,D=g!==0?"warn":"debug",W=s.join("");i||tr().log(D,"stdoutResult(): on(close)",{cmd:t,code:g,args:e,elapsedMs:v,result:Sx(W,160,160)}),!n&&g!==0?u.reject(new Error("non-zero exit code: "+O({code:g,cmd:t,args:e}))):u.resolve({result:W,code:da(g),pid:a.pid})}),di(a.stdin),a.stdout?.on("data",g=>{g!=null&&s.push(g)}),a.stderr?.on("error",g=>p("stderr(error)",g)),a.stderr?.on("data",g=>o?tr().warn("stdoutResult(): stderr(data): "+h(g)):p("stderr(data)",g))}catch(g){p("try/catch",g)}return await u.promise}function se(t,e,r){return Je(t,e,r).then(i=>i.result)}var Nm=class extends lt{constructor(e,r,i=ue.service,o=!1){super(e,()=>this.t.end(),i,()=>this.t.ended,e==="sync-file"?H:M);this.name=e;this.t=r;r.on("childStart",n=>{this.logger.info("Started child process "+e+":"+n.pid),hf(n.pid).catch(s=>this.onError("renice failed for "+e,s)),o&&n.on("exit",()=>_m(n,5*M)),df({pid:n.pid,ppid:nS.default.pid,cmd:e,maxAgeMs:r.options.maxProcAgeMillis+E},new Date).catch(s=>this.onError("addPid failed for "+e,s))}),r.on("startError",n=>{this.lastStartError=n,this.onError("failed to start",n)}),r.on("taskError",(n,s)=>{this.lastTaskError=n,this.onError("failed to run "+f(s,a=>a.command),n)}),r.on("internalError",n=>{this.lastInternalError=n,this.onError("internal error",n)}),r.on("endError",n=>{this.logger.error("observeBatchCluster.endError()",n)})}onError(e,r){!this.t.ended&&!G()&&!Qt(r)?X(this.name+": "+e,r):this.logger.warn("onError() (ending or ignorable): "+e,r)}};var bf=24;function _s(t,e=2){if(e<=0)return t;if(t!=null)return ic(t)?t:Array.isArray(t)?QO(t):si(t)?t:Cc(t)?y(y({},t),{stack:uh(t.stack)}):oc(t)?La(t,(r,i)=>_s(i,e-1)):t}function QO(t,e=_s){if(t!=null)return t.length<=bf?t.map(e):[...t.slice(0,bf).map(e),`\u2026 (${t.length} total items)`]}var qt=Se("error","warn","info","debug","trace"),sS=ft(qt.values.map((t,e)=>[t,e]));function Bm(t){return sS[t]??sS.trace}var YO=l(()=>qt.values.filter(t=>t!==qt.trace)),XO=48,Jh=l(()=>ft(YO().map(t=>[t,new gs(XO)])));function aS(){ct(Jh()).forEach(t=>t.clear())}function lS(t){Jh()[t.l]?.push(t)}function mS(){let t=[];for(let e of ct(Jh()))t.push(...e.toA());return te(t,e=>e.ts)}function tl(t,e){return t>=e?"error":t>=e/2?"warn":t>=e/4?"info":"debug"}var uS={log:Hi,flush:()=>Promise.resolve(),end:Hi,error:Hi,warn:Hi,info:Hi,debug:Hi,trace:Hi};var ZO=/^[a-z]*/i,Cm=class{constructor(e,r){this.context=e;this.loggers=r;this.error=(e,r)=>{this.log("error",e,r)};this.warn=(e,r)=>{this.log("warn",e,r)};this.info=(e,r)=>{this.log("info",e,r)};this.debug=(e,r)=>{this.log("debug",e,r)};this.trace=(e,r)=>{this.log("trace",e,r)};this.filterContext=$(ZO.exec(h(this.context)),i=>i[0],()=>this.context)}addContext(e){return new Cm(this.context+e,this.loggers)}throw(e,r){let i=eo(e)||r?.fatal,n=!(r?.retriable===!1)&&ch(e),s=Qt(e)||r?.ignorable;r=r==null?void 0:_s(Gt(r,"fatal","retriable","ignorable"));let a=new me({cause:Bc(e),message:V([this.context,r==null?void 0:O(r)]).join(" "),fatal:i,retriable:n,ignorable:s});throw this.log(s===!0?"warn":"error",Jt(e),r),a}tap(e){return this.log(x(e.level,"debug"),e.msg,y({result:e.result},e.meta)),e.result}log(e,r,i){if(i=_s(i),Rn().enabled(e,this.context))for(let o of this.loggers())o.log(e,this.context,r,i);else e!=="trace"&&lS({ts:Date.now(),l:e,ctx:this.context,msg:r,meta:i})}async flush(){for(let e of this.loggers())await e.flush()}async end(){for(let e of this.loggers())await e.end()}};var ek=10*E,cS="{ready}",fS=" | ConvertTo-Json -Compress";function Is(t){let e=t.replace(/['`"ââ#]/g,r=>"`"+r).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v");return'"'+e+'"'}function tk(){return[`function prompt {"${cS}"}`,...li(c.powerShellCulture.valueOrDefault,t=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${t}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${t}'`],[])].join(";")}C(()=>q(()=>Te.instance.prior()?.clearMockResults()));var $h=class{constructor(){this.name="PowerShell";this.logger=d("PowerShell");this.mockResults=new Map;this.bco=new Nm("PowerShell",new wf.BatchCluster({processFactory:()=>In("powershell",c.powerShellArgs.values,ek),logger:()=>d("PowerShell"),versionCommand:tk(),pass:cS,fail:"Error",exitCommand:"exit",maxProcs:yt()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:H,cleanupChildProcs:!1}),ue.postdb),this.pwsh=this.bco.t}get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return b(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,r){this.pushMockResult(Ht(e,fS),r)}pushMockResult(e,r){this.mockResults.set(e,r)}clearMockResults(){this.mockResults.clear()}async execute(e,r){if(this.pwsh.ended||G()){this.logger.warn("execute() failed (ended)",{cmd:e});return}if(fe&&this.mockResults.has(e)){let i=this.mockResults.get(e);return r(i.stdout,i.stderr,i.passed)}try{this.logger.debug("execute()",{cmd:e});let i=await bi(()=>this.pwsh.enqueueTask(new wf.Task(e,(o,n,s)=>r(f(o,a=>Ge(a,e)),n,s))));return this.logger.log(tl(i.elapsedMs,7*M),"execute()",{cmd:e,elapsedMs:i.elapsedMs}),i.result}catch(i){this.logger.warn("execute() failed: "+i,{cmd:e});return}}async executeJson(e){let r=await this.execute(Ht(e,fS),(i,o,n)=>({stdout:i,stderr:o,passed:n}));if(r==null){this.logger.warn("executeJson(): null result",{cmd:e});return}if(S(r.stdout)||P(r.stderr)||!r.passed){this.logger.warn("executeJson(): failed result",y({cmd:e},r));return}try{return JSON.parse(r.stdout)}catch(i){let o=r.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:ur(r.stdout),after:ur(o)}),JSON.parse(o)}}async executeJsonToA(e){return b(this.executeJson(e),r=>Array.isArray(r)?r:[r])}},Te=$h;Te.instance=l(()=>{if(!I)throw new Error("PowerShell isn't available on this platform");return new $h});async function rk(){return I?Te.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}var rl=l(async()=>{if(I){let t=await rk();if(P(t))return t}return xf()}),xf=l(()=>(0,pS.resolve)(ki(),"Pictures"));var dS=["7artisans","Bower","Canon","Carl Zeiss","Cosina","Fuji","Fujifilm","Goerz","Hasselblad","Hirox","Hoya","Konica","Leica","Leidolf","Lensbaby","Meike","Meopta","Minolta","Neewer","Nikon","Olympus","Opteka","Panasonic","Pentacon","Pentax","Ricoh","Rodenstock","Rokinon","Ross","Samsung","Samyang","Seiko","Sigma","Silor","Soligor","Sony","Sunpak","Tamron","Tiffen","Tokina","Topcon","Venus","Voigtl\xE4nder","Wray","Yongnuo","Zhong Yi","Zuiko"];var Vm=["EXIF","EXV","MIE","XMP"];var hS=T(require("path")),Co=T(require("process"));function Qh(t){return h(t).replace(/([A-Z])([a-z])/g,(e,r,i)=>"_"+r.toLowerCase()+i).replace(/[A-Z]+|[0-9]+/g,e=>"_"+e).replace(/^_/,"")}function ik(t){return"PS_"+Qh(t).toUpperCase()}var nY=z(y({},Co.env)).map(t=>Tt?Object.freeze(t):t).get(),w=Se("Paths","Logging","Networking","Processes","Tools","Updates","Desktops","Volumes","Db","HealthChecks","Filters","Previews","Reporting","Deduping","Sidecars","Sync","Tagging","Web","Subscriptions"),zm=Object.freeze([w.Db,w.HealthChecks,w.Filters,w.Previews,w.Reporting,w.Deduping,w.Sidecars,w.Sync,w.Tagging,w.Web,w.Subscriptions]),Yh=Object.freeze(w.values.filter(t=>!zm.includes(t))),Vo=t=>P(t)&&t!=="undefined"?h(t).trim():void 0,Qr=class{constructor(e){this.opts=e;this._persist=!1;this.listeners=[]}hasValue(){return this._value!=null}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){let r=x(e,Co.env);for(let i of[this.key,...A(this.opts.envAliases)]){let o=f(r[i],n=>this.opts.fromEnv(n));if(o!=null)return o}}importFromEnv(e=Co.env){if(!this._persist)return f(this.readFromEnv(e),r=>this.setValue(r))}importFromFile(e){if(!(this.hasValue()&&!this._persist))return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){wt(this.listeners,r=>r===e)}onChange(){let e=this.value;this.listeners.forEach(r=>r(e))}get name(){return this._name}_setName(e){if(this._name!=null)throw new Error("cannot set name twice");this._name=e,this._key=ik(e),this.importFromEnv()}get persist(){return this._persist}get key(){return this._key}get category(){return this.opts.category}get categoryType(){return zm.includes(this.category)?"library":"system"}get transient(){return this.opts.transient===!0}get advanced(){return $(this.opts.advanced,e=>e(),()=>!0)}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}maybeSetValue(e){e!=null&&(this.value=e)}set valueAndEnv(e){this.value=e,this.addToEnv(Co.env,e)}get envValueOrDefault(){return this.opts.toEnv(this.valueOrDefault)}set tmpValue(e){this._persist=!1,this.addToEnv(Co.env,e),this.setValue(e)}set tmpValueIfUnset(e){this.isUnset()&&(this.tmpValue=e)}setValue(e){let r=this._value,i=this.opts.toEnv(e),o=this.opts.fromEnv(i);return this._value=o,kt(r,this._value)||this.onChange(),this._value}get defaultValue(){return Ir(this.opts.defaultValue)}get exampleValue(){return z(this.opts.exampleValue).flatMap(e=>e()).filter(P).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return this.value!=null?this.value:this.defaultValue}maybeAddToEnv(e,r){let i=x(e,Co.env);return this.hasValue()&&(i[this.key]=Vo(this.opts.toEnv(x(r,this.valueOrDefault)))),i}addToEnv(e,r){let i=x(e,Co.env);return i[this.key]=Vo(this.opts.toEnv(x(r,this.valueOrDefault))),i}deleteFromEnv(e){let r=x(e,Co.env);return delete r[this.key],f(this.opts.envAliases,i=>i.forEach(o=>{delete r[o]})),r}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),d("Settings."+this.name).info(".unset()"),this}addToJSON(){return{}}toJSON(){return{key:this.key,value:this.value,defaultValue:this.opts.defaultValue}}},On=class extends Qr{constructor(e){super(y({toEnv:Vo,fromEnv:Vo,defaultValue:void 0},e))}hasValue(){return P(this.value)}};function gS(t){return t==null?void 0:t.trim()}var mt=class extends Qr{constructor(e){super(y({toEnv:gS,fromEnv:gS},e))}hasValue(){return P(this.value)}};function Xh(t,e){let r=h(t).toLowerCase();return e.find(i=>i.toLowerCase()===r)}var zo=class extends Qr{constructor(e){super(y({toEnv:i=>Xh(i,e.validValues),fromEnv:i=>Xh(i,e.validValues)},e));if(this.validValues=e.validValues,this.defaultValue!=null&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}};function ok(t){return U(h(t).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return ae(JSON.parse(e)).map(h)}catch{}for(let r of["\xA6",hS.delimiter])if(e.includes(r))return e.split(r);return[e]})}function yS(t){return ha(t)?void 0:Oe(ok(t),Um)}function nk(t){return Oe(Um(t),O)}function Um(t){return K(cn(t))}var _e=class extends Qr{constructor(e){super(y({defaultValue:[],fromEnv:yS,toEnv:nk},e))}push(...e){this.value=Um([...this.valueOrDefault,...e])}get values(){return Um(this.valueOrDefault)}set values(e){this.value=Um(e)}removeValueFromEnv(e){f(this.value,r=>this.tmpValue=r.filter(i=>i!==e))}};function sk(t,e){return bS(yS(t),e)}function bS(t,e){if(t==null)return;let r=[];for(let i of t){let o=Xh(i,e);o!=null&&r.push(o)}return r}var Zh=class extends Qr{constructor(e){super(y({fromEnv:r=>sk(r,e.validValues),toEnv:r=>f(r,i=>O(K(i)))},e));this.validValues=e.validValues}asValidValues(e){return bS(e,this.validValues)}addToJSON(){return{validValues:this.validValues}}},Be=class extends Qr{constructor(e){super(y(y({},e),{toEnv:Vo,fromEnv:k}))}};var Tf=class extends Qr{constructor(e){super(y(y({},e),{toEnv:Vo,fromEnv:mi}))}},jt=class extends Qr{constructor(e){super(y(y({},e),{toEnv:Vo,fromEnv:r=>z(r).flatMap(parseInt).map(i=>Y(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},Ns=class extends Qr{constructor(e){super(y(y({},e),{toEnv:Vo,fromEnv:r=>z(r).flatMap(parseFloat).map(i=>Y(e.min,e.max,i)).get()}));this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}},N=class extends Qr{constructor(e){super(y(y({},e),{toEnv:Vo,fromEnv:dc}))}};var ol=require("process"),xS=Object.freeze(["/usr/local/sbin","/usr/local/bin","/opt/local/sbin","/opt/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),vf=l(()=>Tt),Er=()=>!vf(),ak=Object.freeze(I?[...li(ol.env.SYSTEMROOT,t=>[t,(0,il.join)(ol.env.SYSTEMROOT,"System32"),(0,il.join)(ol.env.SYSTEMROOT,"System32","webm")],()=>[]),"C:\\cygwin64\\bin"]:xS),c={copyAssetsToLibrary:new N({category:w.Paths,description:`Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page's "May PhotoStructure organize your photos and videos?" section. Read more about this setting here: <https://photostructure.com/getting-started/automatic-library-organization/>.`,defaultValue:!0,advanced:()=>!1}),libraryPath:new On({envAliases:["PS_LIBRARY","PS_LIBRARY_DIR"],category:w.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>Er()?"/home/test/Pictures":de()?"/ps/library":xf(),defaultValue:()=>de()&&!Er()?"/ps/library":void 0,advanced:()=>!1}),previewsDir:new mt({category:w.Paths,description:`This is the directory that PhotoStructure uses to store preview images. This defaults to the ".photostructure/previews" directory inside your PhotoStructure library. Absolute paths here are supported, but if you keep your library and previews directory separated, take care when you open your library on different computers, as this setting needs to be adjusted for those computers as well.
NOTE: "originalDirs" is recommended instead of this setting; If you get "previewsDir" wrong, your library won't work. If you get "originalsDir" wrong, you just break full-screen zoom and non-transcoded videos.`,defaultValue:()=>".photostructure/previews"}),originalsDir:new mt({category:w.Paths,description:`This is the directory that PhotoStructure uses to store original images when "copyAssetsToLibrary" is enabled. Absolute paths are supported. Relative paths are evaluated from your libraryPath. This setting defaults to ".", which is the same as your PhotoStructure library directory.
If you open your PhotoStructure library on a different computer, and that computer doesn't have access to your originals volume, full-screen zoom won't work, and non-transcoded videos will not play.
This system setting needs to be set appropriately on different computers (it won't be set automatically!)
If you have a large library and want to use an SSD, we recommend you set your libraryPath to your SSD, and use this setting to store your originals on a larger volume, rather than using the "previewsDir" setting.`,defaultValue:()=>"."}),forceOpen:new N({category:w.Paths,description:"DANGEROUS: if set, all previously-existing library locks will be removed. This should only be necessary if the prior PhotoStructure process was not shut down gracefully.",defaultValue:!1,transient:!0}),scanAllDrives:new N({category:w.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new N({category:w.Paths,description:"Deprecated, and will be removed in the next version. If set, PhotoStructure will automatically add your pictures directory to your `scanPaths` setting.",defaultValue:!1,advanced:()=>!1}),scanPaths:new _e({category:w.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1,exampleValue:()=>Er()?["/path/one","/path/two"]:[xf()]}),cacheDir:new mt({category:w.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free. Note that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory.",exampleValue:()=>Er()?"/tmp/ps_cache_dir":yh(),defaultValue:()=>yh()}),neverIgnored:new _e({category:w.Paths,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),pidfile:new On({envAliases:["PIDFILE"],category:w.Paths,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),scanLibraryFirst:new N({category:w.Paths,description:"Should PhotoStructure scan your library before all other paths are synchronized?",defaultValue:!1}),scanLibraryLast:new N({category:w.Paths,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!0}),logLevel:new mt({envAliases:["PS_LOG","LOG"],category:w.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc').",defaultValue:()=>vf()?"error":"info"}),logDir:new mt({category:w.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>zT(),exampleValue:()=>Er()?"/var/log/photostructure":void 0}),logCompression:new N({category:w.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>vf()}),logElapsedMs:new N({category:w.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new N({category:w.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new On({category:w.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new N({envAliases:["LOG_STDOUT","PS_STDOUT"],category:w.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new N({category:w.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new N({category:w.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR is set, this defaults to false. See <https://no-color.org/>.",defaultValue:()=>S(ol.env.NO_COLOR)}),logSql:new N({category:w.Logging,description:"Log SQL queries to the default log level. *This is really chatty* and impacts performance. Normally these log messages are completely disabled.",defaultValue:()=>!1}),localhost:new mt({category:w.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). See <https://letsencrypt.org/docs/certificates-for-localhost/> and <https://photostructure.com/faq/troubleshooting/#windows-firewall-issues>.',defaultValue:()=>"127.0.0.1"}),httpPort:new Be({category:w.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),trustProxy:new mt({category:w.Networking,description:`Support for PhotoStructure instances running behind a reverse proxy. See <http://expressjs.com/en/guide/behind-proxies.html>. This setting should either be "false" (don't trust any proxies), "loopback", (only trust localhost), a single subnet (like "127.0.0.0/8"), or a comma-delimited set of subnets.`,defaultValue:"false"}),exposeNetworkWithoutAuth:new N({category:w.Networking,description:`Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.
**Don't enable this unless you know what you are doing**.`,defaultValue:()=>de()&&!Er()}),rpcPort:new Be({category:w.Networking,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),exiftoolProcsPerChild:new jt({category:w.Processes,description:"Each PhotoStructure process spins up an ExifTool when needed. Note that the `web`, `sync`, and `sync-file` services all use exiftool, so the total number of exiftool processes can be many times larger than this value.",min:1,max:8,defaultValue:2}),sensitiveEnvRegExp:new mt({category:w.Processes,description:'PhotoStructure spawns a number of processes (including "exiftool" and "ffmpeg"), and passes through environment variables, mostly to ensure locale and TZ settings are correct. To prevent environment values that contain sensitive information, like API access tokens, from either being logged, or being accessed by external tools, all environment variables whose key matches this setting will be removed. This regex is applied case-insensitively.',defaultValue:"key|secret|pass|_user|aws_"}),bounceMinutes:new Be({category:w.Processes,description:"PhotoStructure will bounce the web and sync processes periodically. Set to 0 to disable.",defaultValue:60*(Er()?5:re?2:5)}),setupTimeoutMs:new Be({category:w.Processes,description:"To prevent unhealthy services running as zombies, they self-terminate if the setup processes are not complete within this amount of time. Note that only the environment variable value is used for this setting.",defaultValue:35*M}),probationMs:new Be({category:w.Processes,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*E}),minTimeBetweenServiceRestartsMs:new Be({category:w.Processes,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*M}),fatalErrorRatePerMinute:new Be({category:w.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),minDiskFreeGb:new Be({category:w.Processes,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new jt({category:w.Processes,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new zo({category:w.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>Om.BelowNormal,validValues:Om.values}),maxMemoryMb:new jt({category:w.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.",defaultValue:500,min:256,max:8e3}),maxRssMemoryMb:new jt({category:w.Processes,description:"PhotoStructure will restart services if their' resident set size consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:250,max:8e3}),maxTasksPerProcess:new jt({category:w.Processes,description:"PhotoStructure will recycle sync-file processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>Er()?10:200,min:1,max:5e3}),pollIntervalMs:new Be({category:w.Processes,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>vf()?E:5*M}),inspect:new N({category:w.Processes,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,transient:!0,advanced:()=>!0}),ignoreUnhealthyVolumes:new N({category:w.Volumes,description:"When true, PhotoStructure ignores volumes that are not healthy (due to needing filesystem checks, or remote filesystems that are not available).",defaultValue:!0}),validateMountpoints:new N({category:w.Volumes,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist.",defaultValue:!0}),readVolumeUuidFiles:new N({category:w.Volumes,description:`When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume UUID, which can help with cross-host library portability. Set this to false if you don't want PhotoStructure to read these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),writeVolumeUuidFiles:new N({category:w.Volumes,description:`When true, PhotoStructure (tries to) write ".uuid" files into the root directory of volumes, which enables cross-host library portability. Set this to false if you don't want PhotoStructure to try to write these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.`,defaultValue:!0}),forceLocalDbReplica:new N({category:w.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:()=>de()&&!Er()}),dbBackupsCount:new Be({category:w.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",defaultValue:20}),maxBusyDbMs:new Be({category:w.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 2 minutes, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>2*E}),dbTimeoutMs:new Be({category:w.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",defaultValue:()=>M}),dbBackupIntervalMinutes:new Ns({category:w.Db,description:"How many minutes should elapse between backing of your library database? Note that PhotoStructure vacuums and optimizes the database before a backup is taken. You want this period to be frequent enough such that data loss isn't too painful. Note that backups can cause the webserver to be momentarily unresponsive. Default is every hour.",min:Er()?.5:1,max:60*12,defaultValue:()=>Er()?.5:30}),dbCacheSizeMb:new Be({category:w.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:192}),dbBatchSelectSize:new jt({category:w.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",defaultValue:128,min:1,max:900}),dbBatchUpsertSize:new jt({category:w.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",defaultValue:16,min:1,max:500}),healthCheckExiftool:new N({category:w.HealthChecks,description:"When true, PhotoStructure verifies ExifTool is available and a valid version.",defaultValue:!0}),healthCheckLibraryIsWritable:new N({category:w.HealthChecks,description:"When true, PhotoStructure verifies the library directory exists, and is writable.",defaultValue:!0}),healthCheckVolumes:new N({category:w.HealthChecks,description:"When true, PhotoStructure verifies volumes as part of periodic health checks.",defaultValue:!0}),healthCheckFreeSpace:new N({category:w.HealthChecks,description:"When true, PhotoStructure verifies that the library and cache volumes have sufficient free space.",defaultValue:!0}),healthCheckDb:new N({category:w.HealthChecks,description:"When true, PhotoStructure verifies that the library database can be read from and written to.",defaultValue:!0}),enableSIMD:new N({category:w.Tools,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to false on macOS due to instability on that platform.",defaultValue:()=>!(Er()||re)}),enableVipsCache:new N({category:w.Tools,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations? This defaults to false to reduce memory consumption.",defaultValue:()=>!1}),showFileInFolderUsesThunar:new N({category:w.Tools,description:`If we're on Linux, should we use Thunar (via dbus) to "show file in folder"?`,defaultValue:!1}),showFileInFolderUsesFileUri:new N({category:w.Tools,description:"Does the showFileInFolderCommand expect a file: URI to the file? If this is false, the native path will be appended instead.",exampleValue:()=>!0,defaultValue:()=>Ue}),showFileInFolderCommand:new _e({category:w.Tools,description:`If set, the first argument will be used as a command (or path to command), and the subsequent arguments (if present) will be used as arguments. The native path to the file or the file: URI will be appended, based on the value given to the "showFileInFolderUsesFileUri" setting. If this is set to an empty array, the default tool for your platform will be used instead: "nautilus -s" on linux, "open -R" on mac, and "explorer /select" on Windows.
This is provided to support Linux desktops that don't use Gnome.`,defaultValue:[]}),dcraw_emuPath:new mt({category:w.Tools,description:'This should be the absolute, native path to the "dcraw_emu" binary on this system. If this is set to "dcraw_emu", PhotoStructure will search your $PATH. See <https://www.libraw.org/docs/Samples-LibRaw.html>.',defaultValue:"dcraw_emu"}),ffmpegPath:new mt({category:w.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc. See <https://photostructure.com/getting-started/video-support/>.',defaultValue:"ffmpeg"}),ffmpegTranscodeArgs:new _e({category:w.Tools,description:`The following are the default arguments added to transcode requests made to ffmpeg (when ffmpeg is available). The following arguments will proceed the command: "-loglevel error -threads T -i INPUT_FILE_PATH" (where T is replaced by ~half the available CPU threads, and INPUT_FILE_PATH is the full native pathname to the source video). The following arguments will follow the arguments in this setting: "-b:v VIDEO_BITRATE_KBPS OUTPUT_FILE_PATH".
CAUTION: this is an advanced setting. Editing this may cause videos that require transcoding to not be imported, or not be viewable on all browsers and platforms. See <https://forum.photostructure.com/t/hardware-accelerated-encoding-transcoding/166> for more details.`,defaultValue:["-c:a","aac","-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high"]}),heifConvertPath:new mt({category:w.Tools,description:'This should be the absolute, native path to the "heif-convert" binary on this system. If this is set to "heif-convert", PhotoStructure will search your $PATH. See <https://photostructure.com/getting-started/heif-support/>.',defaultValue:"heif-convert"}),powerShellArgs:new _e({category:w.Tools,description:`The following are the default arguments added to spin up PowerShell on Windows devices.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1> for all arguments that PowerShell.exe accepts.
See <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-5.1> for a description of Bypass.
See <https://forum.photostructure.com/t/eliminate-powershell-profile-and-execution-policy-related-errors/184> for more details about why this needs to be configurable.
(Versions prior to v1.0.0 only specified "-NoLogo").`,defaultValue:["-NoLogo","-NoProfile","-ExecutionPolicy","Bypass"]}),powerShellCulture:new mt({category:w.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),toolPaths:new _e({category:w.Tools,description:`These paths are appended to the PATH to ensure PhotoStructure can find and run external tools like ffmpeg. Use your operating system's separator to separate paths (":" for mac and linux, ";" for windows).`,defaultValue:()=>Io("SETTINGS_IO_TEST")?xS:ak}),vlcPath:new mt({category:w.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),openAtLogin:new N({category:w.Desktops,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!Xt}),updateChannel:new zo({category:w.Desktops,description:'TL:DR; keep this on "latest." This setting only applies to PhotoStructure for Desktops, and controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds have not been thoroughly tested. Please only consider changing this if customer support asks you to, and that you have recent backups of your system.',defaultValue:()=>WT(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new N({category:w.Desktops,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new Be({category:w.Desktops,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:60*24}),autoHideMenuBar:new N({category:w.Desktops,description:"If true, PhotoStructure for Desktops on Windows and Linux will auto hide the menu bar unless the Alt key is pressed.",defaultValue:!1}),email:new On({category:w.Reporting,description:"If set, this email will be used for license subscriptions and added to error reports, so we can contact you to help debug the issue. It is not required. Setting a value here does not subscribe you to any marketing emails.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new N({category:w.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new Be({category:w.Reporting,description:`Set this to zero to remove all bugs in PhotoStructure.
HUR HUR #DADJOKE
If your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.`,defaultValue:3}),minStreamCorrPct:new jt({category:w.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),hiddenHomeTags:new _e({category:w.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", and "Keyword").',defaultValue:()=>["Type"]}),placeholderThumbs:new N({category:w.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),cspReportOnly:new N({category:w.Web,description:"Only report CSP violations. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>.",defaultValue:()=>!1}),cspDirective:new On({category:w.Web,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src>.",exampleValue:()=>"https://myphotos.example.com"}),readdirCacheSeconds:new Be({category:w.Sync,description:"readdir() can take a long time over slow network shares and when directories are very large. This setting controls how long to cache readdir results that are slow (which take >= .5 seconds). Set to 0 to disable readdir() caching.",defaultValue:300}),verifyFileCopies:new N({category:w.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new mt({category:w.Sync,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:`If you chose to copy assets into your library, they will be copied into <originals directory>/<result of this pattern>/<original imagename>.
- See the originalsDir system setting for what your <originals directory> is (it defaults to your library root directory).
- Please encode this path with forward-slashes, even if you're on Windows.
- If you want to add a static path, escape the pathname with single quotes (like "'photos'/y/MM/dd").
- This will always be interpreted as a relative path from your PhotoStructure library.
- See <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.`,defaultValue:"y/y-MM-dd"}),transcodeVideos:new N({category:w.Sync,description:"Should videos that are not in a browser-supported format be transcoded during import? Note that this is a plus-only feature. FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),transcodeBitrateQVGA:new Be({category:w.Sync,description:"What max bitrate should PhotoStructure encode QVGA (320 \xD7 240) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:800}),transcodeBitrateUHD:new Be({category:w.Sync,description:"What max bitrate should PhotoStructure encode UHD (3840\u2009\xD7\u20092160) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:18e3}),doNotTranscodeMimetypes:new _e({category:w.Sync,description:`Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "['video/quicktime','video/mp4']").`,defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),doNotTranscodeVideoCodecs:new _e({category:w.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following video codecs. The video codec may be stored in the "VideoCodec", "CompressorID", or "CompressorName" tags.',defaultValue:()=>["avc1"]}),doNotTranscodeAudioCodecs:new _e({category:w.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following audio codecs. The audio codec is stored in the "AudioCodec" tag.',defaultValue:()=>["mp4a","sowt"]}),statTimeoutSeconds:new jt({category:w.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new N({category:w.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncIntervalHours:new Be({category:w.Sync,description:`This value controls both how often the sync process discovers new or changed files for any given volume.
Note that this value is the duration between the last completion time and when the next sync should be scheduled.
WARNING: Setting this value to a small value will mean PhotoStructure is constantly scanning your disks, which will add wear and tear and possibly reduce the lifespan of your storage media.
Note that setting this to a zero or negative value will disable automatic scheduling of the sync process.`,defaultValue:24}),rebuild:new N({category:w.Sync,description:"When set, all files in your library will be re-imported (caution: slow!).",defaultValue:!1,transient:!0}),forceSync:new N({category:w.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),skipModelUpdates:new N({category:w.Sync,description:"When set, skip any pending library database updates.",defaultValue:!1,transient:!0}),exitWhenDone:new N({category:w.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),matchSidecarsCaseInsensitively:new N({category:w.Sidecars,description:`If set to true, PhotoStructure will look for sidecar files that match file basenames (with or without the file extension), regardless of case (for example: "IMAGE.XMP" will be a sidecar for "image.jpg").
If set to false, sidecars must match case (so only "image.jpg.xmp" and "image.xmp" will match for "image.jpg").
This defaults to false just to be conservative, but true should be fine in normal cases.`,defaultValue:!1}),defaultSidecarType:new zo({category:w.Sidecars,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:Vm}),writeMetadataToSidecarsIfImage:new N({category:w.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to images into sidecars. If set to false, PhotoStructure will overwrite original images with metadata changes.",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new N({category:w.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to videos into sidecars. If set to false, PhotoStructure will overwrite original videos with metadata changes. This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new N({category:w.Sync,description:'Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents. If this is set to false, the original file will be retained in the same directory. "image.jpg" will be stored as "image_original.jpg".',defaultValue:!1}),fuzzyDateParsing:new N({category:w.Sync,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),fuzzyYearParsing:new N({category:w.Sync,description:`When enabled, PhotoStructure will use directories starting with a number that looks year-like (four digits, 1826-the present) to infer the captured-at time, if all other date parsers have failed. Note that setting this to true "forces" the "fuzzyDateParsing" setting to be true.
To elaborate: PhotoStructure first looks for metadata with a date, then looks for an ISO-compliant YMD timestamp in the filename or path, and then, if "fuzzyDateParsing" or this setting is enabled, a YMD or YM datestamp, and then finally, if this setting is enabled, it looks for a directory that begins with a number that is between 1826-2020.`,defaultValue:!1}),minValidYear:new Be({category:w.Sync,description:"If PhotoStructure encounters a year that is less than this value, it will consider it invalid and look elsewhere for dates. The default value, 1826, is the first year a photograph was captured, as per <https://en.wikipedia.org/wiki/History_of_photography>. If you have paintings or other imagery from before this time, you'll want to make this value less than the earliest image in your library.",defaultValue:1826}),useStatToInferDates:new N({category:w.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in the file "birthtime" (on Windows), or the lesser value of "mtime" and "ctime" (on macOS and Linux). Note that these values are not very reliable, as file transfers and backups frequently don't retain these values correctly.`,defaultValue:!0}),usePathsToInferDates:new N({category:w.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.`,defaultValue:!0}),useLibraryPathsToInferDates:new N({category:w.Sync,description:`When enabled, and the "captured-at" time isn't found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths *for files that are in your PhotoStructure library. This defaults to false, as prior versions of PhotoStructure may have placed files into incorrect datestamped directories.`,defaultValue:!1}),maxDuplicatePathElements:new Be({category:w.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),skipAssetFileUpdates:new N({category:w.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),skipAssetUpdates:new N({category:w.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new N({category:w.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>Er()?!0:(0,wS.cpus)().length>=8}),excludeNoMediaAssetsOnRebuild:new N({category:w.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),strictDeduping:new N({category:w.Deduping,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true.',defaultValue:!1}),useImageHashes:new N({category:w.Deduping,description:"Building image hashes slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing. If you set this from false to true, and you'd previously imported new assets, you may want to rebuild your library to re-aggregate your assets.",defaultValue:!0}),includeSharpDominantColor:new N({category:w.Deduping,description:"PhotoStructure's image library, sharp, computes the dominant color using a 4096-bin 3D histogram. This doubles image hashing time, but the most-dominant color might be more accurate.",defaultValue:!1}),minExposureSettingsCoeffPct:new jt({category:w.Deduping,description:"This is the minimum similarity coefficient between exposure setting values two images must be to be considered equivalent. Many cameras actually report different exposure setting values between JPG and RAW: values within 90% of each other should avoid false-positives.",defaultValue:()=>90,max:100,min:0}),minImageCoeffPct:new jt({category:w.Deduping,description:"This is the minimum image hash similarity coefficient for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image similarity. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minImageGreyscaleCoeffPct:new jt({category:w.Deduping,description:"This is the minimum image hash similarity coefficient for greyscale images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>93,max:100,min:0}),minColorCoeffPct:new jt({category:w.Deduping,description:"This is the minimum similarity coefficient found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 50% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minMeanCoeffPct:new jt({category:w.Deduping,description:"If the average of image and color similarity coefficients exceeds this score, the image will be considered a match.",defaultValue:()=>65,max:100,min:0}),fuzzyDateImageCoeffWeight:new Ns({category:w.Deduping,description:'Image similar, by default, is somewhat lax to ensure JPG+RAW and downsampled or edited images are matched together. This is OK when dates must match, and the date is exactly correct. When dates are manually set to something "fuzzy", with perhaps only the year, month, and day, or is inferred by siblings, we need to be more discriminate with image contents to prevent incorrectly grouping photos from that day into a single asset. This value is multiplied with minImageCorrPct and minColorCorrPct to make them more stringent. For example, by default, the minImageCorrPct is 80%, and when the dates are manually set, and this weight is 1.2, the minImageCorrPct for manually-set-date files will be 90%.',defaultValue:()=>1.4,max:2,min:.5}),greyscaleColorThreshold:new jt({category:w.Deduping,description:"When looking at each pixel in L*a*b* space, a greyscale image is expected to have a* and b* values around 0. If the absolute value of every a* and b* value is under this setting's value, the image will be considered to be greyscale. A value of 0 will force all images to be considered non-greyscale.",defaultValue:5,max:128,min:0}),modeCorrCieDiffWeight:new Ns({category:w.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to the CIE94 color delta e. Smaller values apply a larger discount to color deltas.",defaultValue:()=>.6,max:2,min:0}),modeCorrIndexDiffWeight:new Ns({category:w.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to difference between the color indexes. Smaller values apply a larger discount to index differences.",defaultValue:()=>.6,max:2,min:0}),gpsErrorMeters:new Be({category:w.Deduping,description:`What's the maximum number of meters between GPS fixpoints that should be considered equivalent locations? Note that JPG+RAW pairs from smartphones frequently have different GPS locations due to one being recorded from a rough WiFi fix, and another from aGPS.
GPS position error is ~10-100m. Cellular position error is ~500-750m.`,defaultValue:500}),lensMakes:new _e({category:w.Deduping,description:"Used to match lensId when Google Takeout has stripped metadata.",defaultValue:()=>dS}),variantSortCriteria:new _e({category:w.Previews,description:'How should PhotoStructure pick the "best" asset file variant for a given asset? You may reorder the default fields. Only "resolution", "fileSize", "mtime", "schemeIdx", "isCover", "count", and "isBrowserSupported" are understood: other field names will be ignored. Details about these fields are here: <https://photostructure.com/faq/what-do-you-mean-by-dedupe/#how-does-photostructure-pick-which-file-to-show>.',defaultValue:["resolution","mtime","schemeIdx","isCover","count","isBrowserSupported","fileSize"]}),variantSortCriteriaPower:new Ns({category:w.Deduping,description:'Larger variant sort criteria, "resolution" and "fileSize", are scaled to ignore smaller (irrelevant) differences. Scalars are raised to this power to reduce them, so a value of 1 means the criterion is unchanged from the "raw" value.',defaultValue:()=>.15,max:1,min:1e-6}),jpegQuality:new jt({category:w.Previews,description:"JPEG output quality for previews. Smaller values produce smaller images with lower quality. The default value of 85 strikes a balance that has almost no noticeable compression artifacts, yet still compresses images reasonably well. Values less than ~50-70 can produce noticeable artifacts (depending on the image).",defaultValue:()=>85,max:100,min:10}),dcrawEmuArgs:new _e({category:w.Previews,description:`What options do you want to pass to dcraw_emu? Note that "-T -o 1 -j -Z -" will always be added (as we need TIFF, sRGB, raw pixels send to stdout). The "-h" arg will be added if the preview image needed is less than half the resolution of the original.
Run "dcraw_emu" with no arguments to get usage help.
"-q 1" sets interpolation quality to "0".
"-H 2" turns on highlight blending.
"-w" uses the camera-set white balance.
Note: changing these values can dramatically (> 10x!) increase the time it takes to render RAW images.`,defaultValue:["-q","0","-w"]}),iccProfileMappings:new _e({category:w.Previews,description:`Maps an original image profile to a filename stored in the "icc" directory. See that directory's _info.md for more information about this settings.`,defaultValue:["Display P3:DisplayP3Compat-v2-magic.icc","Adobe RGB:AdobeCompat-v2.icc"]}),squareThumbStrategy:new zo({category:w.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>.',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new Tf({category:w.Previews,description:`When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.
Note that if a video is shorter than this value, the frame will be captured from the middle of the video.`,defaultValue:1.5}),sharpen:new N({category:w.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new N({category:w.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new Zh({category:w.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:fc(rh,["uhd8k","uhd5k","qqvga"]),validValues:rh}),embeddedPreviews:new _e({category:w.Previews,description:`For larger source images that are greater than 15MP, what embedded image preview tags should be used when present? Using these embedded images speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["PreviewImage","PreviewTIFF","JpgFromRaw"]}),embeddedThumbnails:new _e({category:w.Previews,description:`Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.
Order matters here: the first embedded image with sufficient resolution will be used.
Set this to an empty array to disable using embedded previews.`,defaultValue:["ThumbnailImage","ThumbnailTIFF"]}),skipPreviews:new N({category:w.Previews,description:"No previews will be built. The UI will be broken if this is set.",defaultValue:!1}),requireMakeModel:new N({category:w.Filters,description:"Normally PhotoStructure requires images to have EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),minImageDimension:new Be({category:w.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new Be({category:w.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minVideoDurationSec:new Tf({category:w.Filters,description:"What's the minimum number of seconds for a video to be imported?",defaultValue:2}),minAssetFileSizeBytes:new Be({envAliases:["PS_MIN_ASSET_SIZE_BYTES","PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:w.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*oh}),maxAssetFileSizeBytes:new Be({envAliases:["PS_MAX_ASSET_SIZE_BYTES","PS_MAX_ASSET_SIZE","PS_MAX_FILE_SIZE_BYTES"],category:w.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library).",defaultValue:.5*Sr}),validateJpegImages:new N({category:w.Filters,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateRawImages:new N({category:w.Filters,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateVideos:new N({category:w.Filters,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!Er()}),validationErrorBlocklist:new _e({category:w.Filters,description:`If any of the following patterns match a validation error found in a photo or video, the file will be considered corrupt and not be imported into your library.
Note the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message, so, for example, a value of "caution" will ignore any error message that contains the string "caution".`,defaultValue:()=>["Cannot determine format of input stream","corrupt","error","failed","invalid","not a .+ file","nothing was written into output file","partial file","Premature end of .+ file"]}),tagCamera:new N({category:w.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new N({category:w.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new N({category:w.Tagging,description:`Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you'll need to "Rebuild" your library to make the setting take effect).`,defaultValue:!0}),tagYMD:new zo({category:w.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["y","ym","ymd",""]}),tagDateFromStat:new N({category:w.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!Er()}),tagKeywordsFromPath:new N({category:w.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new N({category:w.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new mt({category:w.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new mt({category:w.Tagging,description:`PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "Objects\u2283Tools\u2283Hammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don't want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.`,defaultValue:"/|>\u2283"}),tagFileType:new N({category:w.Tagging,envAliases:["PS_TAG_TYPE"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0}),tagWhoSynonyms:new _e({category:w.Tagging,description:'List hierarchical tags that PhotoStructure should interpret to be face names. Digicam uses "People". This is matched case-insensitively.',defaultValue:()=>["People","Face","Faces"]}),tagJsonFaces:new N({category:w.Tagging,description:'Google Takeout provides .json sidecars that may contain the names of the people (or pets) found in the image. Should PhotoStructure import these tags under "Who"?.',defaultValue:!0}),tagFaceRegions:new N({category:w.Tagging,description:'Picasa and other software supports embedding face names within "RegionInfo" metadata. If this setting is enabled, PhotoStructure will import these tags under "Who".',defaultValue:!0}),tagWhoNames:new _e({category:w.Tagging,description:`This is a list of tags that will be examined for strings or string arrays. All values associated to these fields will be interpreted as names. Note that "dotted notation" is supported.
Set this value to an empty array to disable scanning for person names.`,defaultValue:["People","PersonInImage","PersonInImageWDetails.PersonName","PersonInImageName"]}),tagNamesFormatter:new zo({category:w.Tagging,description:`How should PhotoStructure format the "Who" tags for assets whose files are tagged with "people" strings?
"as-is" will tag names directly to "Who", so, "Who/Albert Einstein".
"family/given" will tag "Who/Einstein/Albert" (for regions that provide given names first). The default is "as-is," because discerning given and family names aren't reliably inferable.
See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"as-is",validValues:["as-is","family/given"]}),tagNamesDefaultFamily:new mt({category:w.Tagging,description:'If a name is missing a family name, if this value is not blank, it will be provided as a default. If this value is blank, the name tag will be Who/given. Note that this setting is only used if "tagNamesFormatter" is set to "family/given".',defaultValue:"-"}),tagNamesCapitalizedAsFamily:new N({category:w.Tagging,description:"Assume uppercased names are family names (this is common practice in geneology).",defaultValue:!0}),tagNamesOrder:new zo({category:w.Tagging,description:`How should PhotoStructure parse people's names? Note that this setting is only used if "tagNamesFormatter" is set to "family/given". See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.`,defaultValue:"western",validValues:["western","eastern"]}),tagNamesSurnamePrefixes:new _e({category:w.Tagging,description:'List all family name prefixes to be considered part of the family name. These are matched case-insensitively. This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>["A","D\u2019","Da","De la","De las","De","Del","Della","Den","Des","Di","Du","La","Las","Le","Li","Lo","Mc","Mac","op de","ten","ter","Van \u2018t","van der","van","von der","von","z","zu"]}),tagNamesSurnames:new _e({category:w.Tagging,description:`List all family names you expect in tags that are not single words that are found at the end of a tagged name. Hyphenated family names (like "Ocasio-Cortez") do not need to be listed here: only compound family names, and if your language doesn't separate family names with whitespace. In the latter case, either include all family names, or include all givenNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesGiven:new _e({category:w.Tagging,description:`List all given names you expect in tags that are not single words. Hyphenated given names (like "Rose-Ann") do not need to be listed here. If your language doesn't separate family names and given names with whitespace, either include all given names, or include all familyNames (whatever's easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".`,defaultValue:()=>[]}),tagNamesFamilySurrounds:new _e({category:w.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added as a family name. As an example, if you use the default "()", then "Michelle LaVaughn (Robinson) Obama" will be name tagged with both "Who/Robinson/Michelle LaVaughn" and "Who/Obama/Michell LaVaugn". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["()"]}),tagNamesGivenSurrounds:new _e({category:w.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added to the end of the given name with the surrounds retained. As an example, if you use the defaults of "[]" and double-quotes, then "Joe "Joey" Smith" will be name tagged with Who/Smith/Joe "Joey". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["[]",'""']}),tagNamesLexical:new N({category:w.Tagging,description:'Assume any name with a comma is in "lexical name order", which is always "lastname, given name(s)". If the given name is found to be "sr.", "senior", "jr.", or "junior", the name will be considered to be in western order ($givenNames $familyName, $modifier), and the $modifier will be added to the $givenNames. If this is set to false, commas are ignored.',defaultValue:!0}),excludedRootTags:new _e({category:w.Tagging,description:"Keywords starting with the given roots will be omitted from your PhotoStructure library.",defaultValue:()=>["http:","https:"]}),tagDisplayNameFS:new mt({category:w.Tagging,description:`What should PhotoStructure call the "root" tag for browsing by filesystem paths? Note that this value is only for the UI, and will update the "_displayName" of the /fs/ tag: this value won't change the URL path from be "/tag/fs/.../". Reasonable options that have been suggested include "Folder", "Directory", "Drive", "File", "Path", "Volume", or "Computer".`,defaultValue:"Folder"}),tagAlbums:new N({category:w.Tagging,description:'Should PhotoStructure look for $tagJsonAlbumFilename (by default, "metadata.json") files in the same directory as asset files for album titles?',defaultValue:!0}),tagAlbumFilenames:new _e({category:w.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the file that PhotoStructure should look for with album metadata? This can be JSON, XMP, MIE, or EXIF encoded.`,defaultValue:["metadata.json"]}),tagAlbumTitle:new mt({category:w.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.title"}),tagAlbumTitleHierarchies:new N({category:w.Tagging,description:'If true, album titles will be split as hierarchical keywords. If false, album titles will not be split, and all albums will be under the "Albums" root tag.',defaultValue:!1}),tagAlbumDescription:new mt({category:w.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.description"}),tagAlbumDate:new mt({category:w.Tagging,description:`If you have enabled "tagJsonAlbums", what's the name of the field encoded in the album file? Object hierarchies are separated with a ".".`,defaultValue:"albumData.date"}),tagAlbumsExcluded:new _e({category:w.Tagging,description:'For "metadata.json" albums, some are automatically generated. If the title or description includes any given string, it will be ignored.',defaultValue:["Album for automatically uploaded content"]}),pickPlanOnWelcome:new N({category:w.Subscriptions,description:'If set to true, the welcome page flow will redirect to https://account.photostructure.com/plans to have you pick between "plus" and "lite". If set to false, the welcome page will continue directly to the settings page with a "lite" license. You can still upgrade to a paid plan later from the main menu or the about page, even if this is false.',defaultValue:!0}),autoRefreshLicense:new N({category:w.Subscriptions,description:`PhotoStructure uses cryptographically signed licenses to locally store your current plan subscription status. These licenses are only valid for the current subscription period, and must be refreshed when your subscription renews or converts from a free trial to a paid subscription. To minimize the hassle of license renewals, PhotoStructure can automatically renew expired licenses in the background.
If the current license has expired and this value is true, PhotoStructure will make one secure POST request to https://account.photostructure.com/ that contains several lossy one-way hashes of current system metadata. We hash all identifying metadata to only 15 characters to alleviate any privacy concerns. If your plan subscription is active, a new license will be added to your library.
Set this to false and set the "reportErrors" setting to false if you don't want PhotoStructure "phoning home" for any reason.
Note that if this is disabled, license renewals will require manual intervention: click "Upgrade" from the main menu, pick your plan, authenticate, and the license will automatically refresh.`,defaultValue:!0}),license:new On({category:w.Subscriptions,description:`Subscription licenses are normally saved automatically into both your library and system configuration directories. This setting just provides users with an alternative way to provide a license, if it's more convenient. Any value provided to this setting will be considered in addition to existing license files when PhotoStructure is trying to find the "best" license available.`})};for(let[t,e]of Ze(c))e._setName(t);var TS="SUGGESTED_DIRS";function lk(t){let e=(S(t)?"":t).split(il.delimiter);if(I&&S(ol.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return e.push(...c.toolPaths.valueOrDefault),K(e).filter(P).join(il.delimiter)}var Xv=l(()=>lk(ol.env.PATH)),km=l(()=>{let t=ct(c).filter(e=>!e.transient);return te(t,e=>[e.categoryType==="system"?0:1,w.indexOf(e.category),e.advanced,e.name])}),vS=l(()=>km().filter(t=>Yh.includes(t.category))),SS=l(()=>km().filter(t=>zm.includes(t.category)));var MS;(function(o){o.highlight=()=>!1,o.silent=!1,o.enabled=()=>!o.silent,o.defaultLevelIndex=Bm("trace")})(MS||(MS={}));var mk=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i,PS=class{constructor(e){this.silent=!1;this.contexts=[];this.setup(e)}setup(e){this.contexts.length=0;let r=Bm(c.logLevel.defaultValue),i=P(e)?e:c.logLevel.valueOrDefault;V(i.split(",")).forEach(o=>{let n=mk.exec(o.trim());if(n==null)fe||console.error("LogFilterImpl: Ignoring '"+o+"' from "+e);else{let s=h(n[1]).toLowerCase(),a=Bm(n[2]);S(s)?r=a:this.contexts.push({prefix:s,levelIndex:a})}}),this.defaultLevelIndex=r}contextOverride(e){if(this.contexts.length===0&&S(e))return;let r=h(e).toLowerCase();return this.contexts.find(i=>r.startsWith(i.prefix))}enabled(e,r){if(this.silent)return!1;let i=Bm(e);if(i<=this.defaultLevelIndex)return!0;let o=this.contextOverride(r);return o!=null&&i<=o.levelIndex}highlight(e){let r=this.contextOverride(e);return r!=null&&r.levelIndex>=this.defaultLevelIndex}},Sf;function Rn(){return Sf==null&&(Sf=new PS,c.logLevel.addListener(()=>Sf.setup())),Sf}var ES=l(()=>qt.values[Rn().defaultLevelIndex],5*M);function no(t,e){return Rn().enabled(t)?e():void 0}var Bs=class{constructor(e){this.valueOf=e;this.store=[]}get length(){return this.store.length}add(e){if(e==null)return;let r=this.valueOf(e);if(r!=null){if(this.store.length===0){this.store.push(e);return}if(Di(r,this.valueOf(this.store[0]))){this.store.unshift(e);return}for(let i=this.store.length-1;i>=0;i--)if(ji(this.valueOf(e),this.valueOf(this.store[i]))){this.store.splice(i+1,0,e);return}this.store.unshift(e)}}shiftLt(e){if(this.length===0)return[];let r=0;if(Di(this.valueOf(pc(this.store)),e))r=this.store.length;else for(;Di(this.valueOf(this.store[r]),e);)r++;return r===0?[]:this.splice(0,r)}splice(e,r){return this.store.splice(e,r)}};var IS=T(require("process"));var AS=T(require("util"));var DS=T(require("luxon"));var uk=Date.now();function Mf(t){let e=c.logElapsedMs.valueOrDefault?DS.Duration.fromMillis(t-uk).toFormat("hhhh:mm:ss.SSS"):new Date(t).toISOString();return c.logColor.valueOrDefault?c.logElapsedMs.valueOrDefault?pn(e):Ma(e):e}var kn=fe?250:750;var eg=class{constructor(e={}){this.logLevels={trace:"trace",debug:Ma("debug"),info:yc("info "),error:$w("error"),warn:Qw("warn ")};this.inspectOptions=y(y({},eg.defaultInspectOptions()),e),fe&&(this.inspectOptions.breakLength=255)}formatMeta(e){if(e==null)return;let r=_s(e);return r==null?void 0:(0,AS.inspect)(r,this.inspectOptions)}formatLogEntry(e){let r=Rn().highlight(e.ctx)?pn:hc;return V([Mf(e.ts),FS(x(e.from,()=>this.inspectOptions.processName())),this.logLevels[e.l],r(e.ctx),e.msg,this.formatMeta(e.meta)]).map(i=>h(i)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:Yr(),ctx:r,msg:i,meta:o})}},Pf=eg;Pf.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:bf+1,processName:Yr});var LS=T(require("util"));var tg=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e;this.paddedLogLevels=ft(qt.values.map(e=>[e,wx(e,5," ")]))}formatLogEntry(e){return V([Mf(e.ts),Yr(),this.paddedLogLevels[e.l],Yi(e.ctx),Yi(e.msg),f(e.meta,r=>(0,LS.inspect)(r,this.inspectOptions))]).map(r=>h(r)).join(" ")}format(e,r,i,o){return this.formatLogEntry({ts:Date.now(),l:e,from:Yr(),ctx:r,msg:i,meta:o})}};var ck=l(()=>{c.logColor.addListener(()=>Wm.unset())}),Wm=l(()=>(IS.env.NO_COLOR!=null&&(c.logColor.tmpValue=!1),ck(),c.logColor.valueOrDefault?new Pf({processName:()=>""}):new tg));function nl(t){return t?.ts}var RS=!1;function rg(t){RS=t}var OS=new Bs(nl);function Ef(...t){for(let e of t)RS?OS.add(e):console.log(Wm().formatLogEntry(e))}function ig(t=kn*2){return OS.shiftLt(Date.now()-t)}var og=class{log(e,r,i,o){Ef({ts:Date.now(),l:e,from:Yr(),ctx:r,msg:i,meta:o})}enabled(e,r){return Rn().enabled(e,r)}async flush(){}end(){}},Cs=og;Cs.instance=l(()=>new og);var NS=T(require("path")),BS=T(require("timers"));function kS(t){try{if(P(t))return JSON.parse(t)}catch{}}function _S(t,e){try{if(P(t))return e(JSON.parse(t))}catch{}}var fk=require("fs");var sl=class{constructor(e,r={}){this.logDir=e;this.ended=!1;this.mutex=new Yt;this._linesSinceRotate=0;this.pendingWrites=[];this._startIndex=0;this.endTimeoutMs=15*M;this.end=l(async()=>(this.ended=!0,f(this.flushInterval,BS.clearInterval),this.flushInterval=void 0,await this.flush(),this.mutex.serial("close",()=>this._closeCurrent())));this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",()=>this._flush());this.shouldRotate=()=>this._stream==null||this._linesSinceRotate>=this.opts.maxLinesPerFile;this.name="LogWriter("+e+")",this.opts=y({maxLinesPerFile:25e4,errorLogger:Cs.instance(),flushEveryMs:kn,processName:Yr},r),this.flushInterval=Hr(()=>this.maybeFlush(),this.opts.flushEveryMs),qx(this)}log(e,r,i,o){if(this.ended&&e==="error")this.opts.errorLogger.log(e,r,i,o);else{let n={ts:Date.now(),l:e,ctx:r,msg:i};o!=null&&(n.meta=o),e==="error"&&(this.writeRecentLogEntries(),this.flush()),this.pendingWrites.push(O(n)+`
`)}}writeRecentLogEntries(){this.pendingWrites.push(...mS().map(e=>O(e)+`
`)),aS()}async flush(){await this.mutex.serial("flush",()=>this._flush())}async _flush(){let e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this._rotate();let r=this._stream;if(r==null){this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");return}let i=this.opts.maxLinesPerFile-this._linesSinceRotate,o=e.splice(0,i);this._linesSinceRotate+=o.length,r.write(o.join(""))}}errback(e){return r=>this.opts.errorLogger.log("error","Caught error from "+e,r)}async _rotate(){await this._closeCurrent(),this._currentFile=await Kc({nativePath:(0,NS.join)(this.logDir,fn(new Date),Yi(this.opts.processName())+".log"),emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=fk.createWriteStream(this._currentFile).on("error",this.errback("file write stream"))}async _closeCurrent(){let e=this._stream;this._stream=void 0,this._linesSinceRotate=0;let r=this._currentFile;this._currentFile=void 0,await di(e),c.logCompression.valueOrDefault&&(await gt(this.opts.flushEveryMs),await f(r,kT))}};async function CS(t,e){let r=Kr(t.name);return b(hv(t.nativePath,e),i=>F(V(ro(i)).map(o=>_S(o,n=>y(y({},n),{from:r})))))}var ng=l(()=>[Cs.instance()]);function Qc(){return ng().find(t=>t instanceof sl)}function qm(){let t=c.logDir.valueOrDefault,e=Qc();(e==null||e.logDir!==t)&&(Ri(e),e=new sl(t));let r=[e];(c.logStdout.valueOrDefault||c.tailLogs.valueOrDefault)&&r.push(Cs.instance()),ng.set(r)}function Df(){return Qc()?.writeRecentLogEntries()}function d(t){return new Cm(t,ng)}var al=Se("main","web","sync","sync-file","info","test","logcat","logtail","list","billing");function zS(t){let e=al.indexOf(t);return e<0?al.length+1:e}var pk=["main","test"],dk=["main","web","test","info"],hk=["sync","sync-file"];function Af(t){switch(t){case"main":case"web":return E;case"sync":case"sync-file":default:return 10*M}}var Ni="";function rr(){if(S(Ni))throw Error("serviceName() is unset");return Ni}function Ff(t){if(!fe&&t!==Ni&&Ni!=="")throw new Error("Cannot set service name twice");Ni=t,Yr.unset(),qm()}var gk=l(()=>[{re:/sync-file|billing/,f:yc},{re:/sync/,f:hc},{re:/web/,f:Sa},{re:/db/,f:gc},{re:/main/,f:pn},{re:/info/,f:Yw},{re:/test/,f:fs}]),Yr=l(()=>V([Ni,h(VS.pid)]).join("-"));function FS(t){let e=gk().find(r=>t.match(r.re));return e!=null?Xw(e.f(t)):t}function Nr(){return Ni===al.main}function ll(){return Ni===al.web}function _n(){return pk.includes(rr())}function jm(){return!_n()&&Ni!=="info"}function yk(){return Ni==="sync"}function Hm(){return Ni==="sync-file"}function Lf(){return dk.includes(rr())}function US(){return hk.includes(rr())}var WS=l(()=>yk()||fe&&!Hm());var qS=T(require("process"));var bk=new Date().getFullYear(),wk=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.

Copyright \xA9 2017-${bk}, PhotoStructure Inc.

Running this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,jS={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",list:"List all paths in a Library.",logcat:"Chronologically sort and pretty-print PhotoStructure logfiles.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."};function HS(t){return t.on("--help",()=>{console.log(`
`+Eo(wk,{maxLineLen:qS.stdout.columns??78,prefix:""}).join(`
`)+`
`)})}var sg=class{constructor(e,r,i){this.serviceName=e;this.args=r;this.additionalDescription=i;this.plugins=[];Ff(e)}add(...e){return this.plugins.push(...e),this}async parse(){let e=HS(GS.program.description(jS[this.serviceName]+li(this.additionalDescription,i=>`

`+i,()=>"")));f(this.args,i=>{e=e.arguments(i)});for(let i of this.plugins)e=i.beforeParse(e);e.version(Ke,"--version","Output the version number (spoiler: it's "+Ke+")"),e.parse(KS.default.argv);let r=e.opts();for(let i of this.plugins)await i.afterParse(r);return e}};var JS=T(require("process"));function ml(t){return L(JS.default.env.__is_daemon)||L(t?.daemon)||!S(t?.pidfile)}var ag={beforeParse:(t,e=!1)=>(t.option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.'),e||t.option("--info|--verbose",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.'),t.option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.').option("--color","Enable ASCII terminal colors",!0).option("--no-color","Disable ASCII terminal colors"),t),afterParse:t=>{f(t.color,o=>c.logColor.tmpValue=o);let e=L(t.warn),r=L(t.info)||L(t.verbose),i=L(t.debug);e&&(c.logLevel.tmpValue="warn"),r&&(c.logLevel.tmpValue="info"),i&&(c.logLevel.tmpValue="debug"),!ml(t)&&(e||r||i)&&(c.logStdout.tmpValue=!0)}};var $S={beforeParse:t=>{let e=!0;return t.option("--info",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--verbose",'Verbose logging from all processes. Shortcut for "--info --tail". Caution: noisy during imports!').option("--tail","Emit log messages from both this process and all other concurrently running PhotoStructure processes on this host to stdout. This can be really helpful in seeing how PhotoStructure's processes are coordinating work. Caution: very noisy especially during imports. Sets PS_TAIL_LOGS to true. Ignored if daemonized."),ag.beforeParse(t,e),t.option("--force-open,--forceOpen","DANGEROUS: removes all previously-existing library locks. This should only be necessary if the prior PhotoStructure process was not shut down gracefully."),t},afterParse:t=>{if(ag.afterParse(t),L(t.elapsed)&&(c.logElapsedMs.tmpValue=t.elapsed),ml(t))c.logStdout.tmpValue=!1,c.tailLogs.tmpValue=!1;else{let e=L(t.verbose);e&&c.logLevel.isUnset()&&(c.logLevel.tmpValue="info"),(L(t.tail)||e)&&(c.tailLogs.tmpValue=!0),L(t.forceOpen)&&(c.forceOpen.tmpValue=!0)}}};var QS={beforeParse:t=>t.option("--expose","Set PS_EXPOSE_NETWORK_WITHOUT_AUTH to true. Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network."),afterParse:t=>{L(t.expose)&&(c.exposeNetworkWithoutAuth.tmpValue=!0)}};var TI=T(require("crypto")),rw=T(require("process"));var YS=T(require("express")),XS=T(require("on-finished"));function ul(t){let e=ui(t.originalUrl,"/");return new URL(t.protocol+"://"+t.headers.host+e)}function xk(t){switch(Math.floor(t/100)){case 2:return Sa;case 3:return Jw;case 4:return pn;default:return fs}}var lg=class{constructor(){this.logger=d("WebRequest");this.accessLogger=c.logWebRequests.valueOrDefault?new sl(ga(c.logWebDir.valueOrDefault,c.logDir.valueOrDefault),{processName:()=>"webrequest"}):uS;this.router=(0,YS.Router)().use((e,r,i)=>{let o=Date.now();no("debug",()=>f(e.session,n=>this.logger.debug(e.originalUrl,{session_before:n}))),(0,XS.default)(r,(n,s)=>{let a=Date.now()-o,m=`${e.method} ${ul(e)}`;this.logger.info((n!=null?fs:xk(s.statusCode))(m),{ms:a,status:s.statusCode,session_after:e.session,ip:e.ip,stale:e.stale,error:n}),this.accessLogger.log("info","",m,{elapsedMs:a,ip:e.ip,statusCode:s.statusCode})}),i()})}};var iM=T(require("mime-types"));var mg=4,ug=8,cg=mg**ug;function fg(){return mr(0,cg)}var If=l(()=>d("Handler.wrap()"));function Le(t,e){return async(r,i,o)=>{let n=Date.now();try{return await e(r,i,o)}catch(s){X("handler("+r.path+")",s,{name:t,url:r.url,params:r.params,method:r.method}),i.headersSent?If().debug("Can't send the 500: headers were already sent."):ze(()=>i.sendStatus(x(s.httpStatus,500)))}finally{Date.now()-n>10&&If().debug("perf",{elapsedMs:Date.now()-n,url:r.baseUrl})}}}function Rf(t){return If().info("getOrPrngSeed()",t.query.seed),k(h(t.query.seed),{defaultValue:fg()})}function ZS(t,e){return nt(k(h(t.query.seed)),r=>{if(r==null){let i=ul(t);i.searchParams.append("seed",h(fg())),e.redirect(i.toString())}})}function eM(t){let e=V(t.split("/").slice(2).map(decodeURIComponent));return If().info(t+": request for ",e),e}function pg(t){let e=t.headers["accept-language"];return Tk(Array.isArray(e)?e.join(","):e)}function Tk(t){return z(t).filter(P).map(h).map(e=>e.split(",")).map(V).map(e=>e.map(r=>r.split(";").map(i=>i.trim()))).flatMap(e=>st(e,([,r])=>bs(lm(r),1))).map(([e])=>e).get()}function tM(t,e){return $(t.query[e],r=>!qr(r),()=>!1)}function rM(t){t.setHeader("Cache-Control","no-store, max-age=0"),t.setHeader("Pragma","no-cache"),t.setHeader("Expires","Fri, 01 Jan 1990 00:00:00 GMT")}var vk=/\.asar\/?/i;async function oM(t){let e=d("serveStaticGz"),r=ie.for(t),i=await r.descendants(n=>n.ext.endsWith(".gz")),o=Rs(i,n=>U((0,iM.lookup)(zt(n.base,".gz")),s=>["/"+zt(n.posixPathFrom(r),".gz"),{contentType:s,nativePath:n.nativePath}]));return e.debug("serveStaticGz ready to serve",[...o.keys()]),Le("serveStaticGz",async(n,s,a)=>{if(n.path.match(vk)!=null)return s.sendStatus(404);let m=o.get(h(n.path));return m==null?a():(e.debug("serveStaticGz",{path:n.path,result:m}),s.set("Content-Encoding","gzip"),s.set("Content-Type",m.contentType),s.sendFile(m.nativePath))})}var TP=T(require("path"));var Sk=[[["360"],"GoPro 360 video (QuickTime-based)"],[["3FR"],"Hasselblad RAW (TIFF-based)"],[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["AVIF"],"AV1 Image File Format (QuickTime-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["CZI"],"Zeiss Integrated Software RAW (ZISRAW)"],[["DCP"],"DNG Camera Profile (DNG-like)"],[["DCR"],"Kodak Digital Camera RAW (TIFF-based)"],[["DNG"],"Digital Negative (TIFF-based)"],[["DV"],"Digital Video"],[["ERF"],"Epson RAW Format (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["FFF"],"Hasselblad Flexible File Format (TIFF-based)"],[["FFF"],"FLIR Systems thermal image File Format"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HDP","WDP","JXR"],"Windows HD Photo / Media Photo / JPEG XR (TIFF-based)"],[["HDR"],"Radiance RGBE High Dynamic-Range"],[["HEIC","HEIF","HIF"],"High Efficiency Image Format (QuickTime-based)"],[["IIQ"],"Phase One Intelligent Image Quality RAW (TIFF-based)"],[["INSP"],"Insta360 Picture (JPEG-based)"],[["INSV"],"Insta360 Video (QuickTime-based)"],[["J2C","J2K","JPC"],"JPEG 2000 codestream"],[["JP2","JPF","JPM","JPX"],"JPEG 2000 image [Compound/Extended]"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PEF"],"Pentax (RAW) Electronic Format (TIFF-based)"],[["PNG","JNG","MNG"],"Portable/JPEG/Multiple-image Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Kyocera Contax N Digital RAW"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["X3F"],"Sigma/Foveon RAW"],[["XMP"],"Extensible Metadata Platform sidecar file"]],Et=Se("RawImage","Sharp","Video","Sidecar","AssetFile","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser"),Mk=l(()=>{let t=new yn,e=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"];for(let s of e)t.add(s,Et.RawImage);let r=F(["GIF","JPEG","PNG","PPM","TIFF","WEBP"]);for(let s of r)t.add(s,Et.Sharp);let i=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"];for(let s of i)t.add(s,Et.Video);let o=[...r,"HEIC",...e,...i];for(let s of o)t.add(s,Et.AssetFile);for(let s of Vm)t.add(s,Et.Sidecar);for(let s of[...o,...Vm])t.add(s,Et.Exif);for(let s of["GIF","JPEG","MP4","PNG","WEBM","WEBP"])t.add(s,Et.SupportedByCurrentBrowser);for(let s of["GIF","JPEG","MP4","PNG"])t.add(s,Et.SupportedByOldBrowser);let n=Sk.map(s=>s[0]);for(let s of t.keys()){let a=n.find(m=>m.includes(s));if(a!=null&&a.length>0){let m=t.get(s);for(let u of a)t.has(u)||t.set(u,m)}}return t});function dg(t){return f(Pk(t),e=>Mk().get(e))}var Ek=/\.?([a-z0-9]{2,4})$/i;function Pk(t){return f(Ek.exec(h(t)),e=>e[1].toUpperCase())}function cl(t,e){return $(dg(t),r=>r.includes(e),()=>!1)}function Gm(t){return cl(t,Et.Video)}function Km(t){return cl(t,Et.Sidecar)}function nM(t){return cl(t,Et.Exif)}function sM(t){return cl(t,Et.SupportedByCurrentBrowser)}function Jm(t,e){let r=Dk(e);return r===""?t:t+"?"+r}function Dk(t){if(t==null)return"";let e=Ze(t).filter(([,r])=>r!=null);return R(e)?"":e.map(r=>r.map(h).map(encodeURIComponent).join("=")).join("&")}var so="pslib",Uo="psfile",Ti="psnet";var Of=T(require("dns"));function Bi(t,e){let r=0,i=new to(e),o=n=>(r++,i.getOrSetAsync(O(n),async()=>t(n)));return o.clear=n=>{if(n==null)i.clear();else{let s=O(n);i.deleteIf(a=>s===a)}},o.size=()=>i.size,o.callCount=()=>r,o}var Ak=Bi(async t=>{let e=I?await Rv():"ping";return se(e,[I?"-n":"-c","1",t],{timeout:5*M})},{maxSize:255,timeoutMs:kr,clearEveryMs:10*E}),hg=new RegExp("\\b"+ye(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),ote=Bi(async t=>z(await Ak(t).catch(e=>{console.warn("failed to ping: "+e)})).filter(P).flatMap(e=>hg.exec(h(e))).map(e=>e[0]).get(),{maxSize:255,timeoutMs:kr,clearEveryMs:10*E});var Fk=new RegExp("^"+hg.source+"$"),Lk=Bi(async t=>{let e=Fk.exec(t)==null?t:await aM(t);return h(e).toLowerCase().normalize()},{maxSize:128,timeoutMs:kr}),Ik=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function gg(t){return Ik.exec(t)!=null}function lM(t){let e=t.split(".").map(r=>k(r)).filter(r=>St(0,255,r));return e.length===4?e:void 0}var mM=Bi(async t=>{if(!S(t)){if(lM(t)!=null)return[t];try{return await Of.promises.resolve4(t)}catch(e){kf().warn("No name found for "+t);return}}},{maxSize:256,timeoutMs:kr,clearEveryMs:10*E}),kf=l(()=>d("nslookup"));C(()=>q(()=>aM.clear()));var aM=Bi(async t=>{try{let e=await xe(()=>gg(t)?t.startsWith("127.")?["localhost"]:["127.0.0.1"]:lM(t)!=null?Of.promises.reverse(t):Of.promises.resolve4(t),5*M);if(e==null)return kf().info("nslookup("+t+"): timeout"),t;let r=e.find(P);return r??(kf().warn("No name found for "+t),t)}catch(e){return kf().warn("Failed to look up "+t+", using name.",e),t}},{maxSize:256,timeoutMs:kr,clearEveryMs:10*E});async function uM(t,e){return S(t)||S(e)?!1:at(t,e)||gg(t)&&gg(e)?!0:za(mM(t),mM(e),(r,i)=>r.some(o=>i.includes(o)),()=>!1)}var Rk=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;async function Ok(){let t=await se("mount",[],{timeout:H});return F(t.split(`
`).map(e=>f(Rk.exec(e),r=>{let[i,o,n]=r.slice(1),s=n.split(",").map(a=>a.trim());return{filesystem:i,mountpoint:o,options:s}})))}var cM=l(async()=>xn(await Ok(),async t=>t.options.includes("nobrowse")||t.options.includes("quarantine")||await kk(t.mountpoint)).then(t=>t.map(e=>e.filesystem)),Pr);async function kk(t){let e=ie.for(t),r=await he(await e.childNames(),i=>i.filter(o=>!o.startsWith(".")).map(o=>o.toLowerCase()).sort(),()=>[]);return kt(r,["applications","photostructure.app"])}function yg(t){return k(t,{defaultValue:0})*1024}var _k=["devfs"],Nk=["udev","tmpfs","devtmpfs","shm"],Bk=re?_k:Nk,Ck=["/boot/efi","/dev/shm"];async function Vs(t,e){let r=re?await cM():[],i=["-k","-P"];t&&i.push("-l"),P(e)&&i.push(e);let o=await se("df",i,{timeout:H,ignoreStderr:!0,ignoreExitCode:!0});return Bo(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],o).map(s=>({filesystem:s.Filesystem,size:yg(s["1024-blocks"]),used:yg(s.Used),available:yg(s.Available),mountpoint:s["Mounted on"]})).filter(s=>{let a=h(s.filesystem),m=h(s.mountpoint);return P(m)&&!Ck.includes(m)&&P(a)&&!r.includes(a)&&!Bk.includes(a)})}var zs=l(async()=>{if(!Ue||de())return!1;try{return(await Je(_f,["version"],{timeout:H,ignoreStderr:!0})).code===0}catch(t){return!1}}),_f="gio",fM=["mount","--monitor","--anonymous"],Vk=l(()=>d("Gio.gioVolumes()")),fl=l(()=>xe(async()=>{let t=await Uk(),e=(await ym(t.map(async r=>{let i=await Vs(!1,r.nativePath).catch(n=>{Vk().warn("Failed to df "+r+": "+n)}),o=f(i,n=>n[0]);return f(o,n=>n.mountpoint=r.nativePath),o}))).filter(r=>r.size>0);return Promise.all(e.map(async r=>he(zk(r.mountpoint),i=>(r.remoteHost=i.remoteHost,r.remoteShare=i.remoteShare,r.label=i.displayName,r.remote=!0,r),()=>r)))},Pr,()=>d("Gio.gioVolumes").warn("timed out after "+Pr+"ms")),Ss),Wk=d("Gio.getRemoteInfo()"),zk=Bi(async t=>{try{let e=(await se(_f,["info",t],{timeout:H})).split(/[\n\r]+/),r=U(e.find(i=>i.startsWith("uri: ")),i=>new URL(Ge(i,"uri: ")));return{displayName:f(e.find(i=>i.startsWith("display name: ")),i=>Ge(i,"display name: ")),remoteHost:f(r,i=>i.hostname),remoteShare:z(r).flatMap(i=>i.pathname).flatMap(i=>Ge(i,"/")).flatMap(i=>zt(i,"/")).flatMap(decodeURIComponent).filter(P).get()}}catch(e){Wk.warn("gio info failed",{mountpoint:t,err:e});return}},{maxSize:255,timeoutMs:kr,clearEveryMs:10*E}),Nf=l(async()=>b(ie.for("/proc/mounts").readLines(),t=>t.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1])),Ss);async function Uk(){return await zs()?ym(await b(Nf(),t=>t.map(e=>ie.for(e).clear().childDirectories()))):[]}var Nn=T(require("luxon"));function pM(t,e,r){return t!=null&&e!=null&&Math.abs(t.getTime()-e.getTime())<=r}function Bf(t,e=2500){return t==null?!1:xa(t)?pM(t,new Date,e):Math.abs(t-Date.now())<e}function $m(t,e=5*M){return B(t)&&Date.now()-t<=e}function dM(t=new Date){return[t.getFullYear(),Kt(t.getMonth()+1),Kt(t.getDate()),"-",Kt(t.getHours()),Kt(t.getMinutes()),Kt(t.getSeconds())].join("")}function bg(t=new Date){return[t.getUTCFullYear(),Kt(t.getUTCMonth()+1),Kt(t.getUTCDate()),"-",Kt(t.getUTCHours()),Kt(t.getUTCMinutes()),Kt(t.getUTCSeconds())].join("")}function wg(t){return Nn.Duration.fromMillis(t).toFormat("m:s.S")}function hM(t){return Nn.Duration.fromMillis(Xe(t/M)*M).toFormat("h:mm:ss")}function xg(t){return z(t).filter(P).map(e=>Nn.DateTime.fromISO(e)).filter(e=>e.isValid).map(e=>e.toMillis()).get()}function gM(t){return f(qk(t),e=>e*100+Cf(t.millisecond))}function qk(t){return t==null||!t.isValid?void 0:k(t.toFormat("yMMddHHmmss"))}function Cf(t){return Math.floor(t/10)}function Tg(t,e){if(t==null||t<0)return;let r=t,i=()=>{let g=r%100;return r=Math.floor(r/100),g},o=10*i(),n=i(),s=i(),a=i(),m=i(),u=i();return{year:r,month:u,day:m,hour:a,minute:s,second:n,millisecond:o,zone:f(e,g=>Nn.Info.normalizeZone(g))}}function Vf(t,e){return f(Tg(t,e),r=>Nn.DateTime.fromObject(r))}function yM(t,e){return f(Vf(t,e),r=>r.toMillis())}function zf(t){let e=new Date(t);return k([e.getFullYear(),...[e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),Cf(e.getUTCMilliseconds())].map(Kt)].join(""))}function Uf(t){return new vg(y({name:F([t.cmd,...t.args]).join(" "),childFactory:()=>Kh(t.cmd,t.args,30*E),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},t))}var vg=class{constructor(e){this.startMs=Date.now();this._stopped=!1;this.logger=l(()=>d("WatchedChild("+F([this.name,this.pid]).join(":")+")"));this.startRate=new Sn(2*E);this.mutex=new Yt;this._ended=!1;this.onError=async(e,r)=>{let i=eo(e)||eo(r),o=new me({message:e+f(r,ce),cause:Cc(r)?r:void 0}),n=Qt(o),s={src:e,fatal:i,ignorable:n,errToS:ce(r)};if(this.logger().log(n?"warn":"error","onError()",s),this._ended||n)return;if(this.lastError=o,X(e,o),i)return this.end();if(this.opts.onError(e,r))return this.logger().warn("onError requested restart",s),this._restart()};this.name=e.name,this.opts=y({dataSep:`
`,maxErrorsPerMinute:3,endableRank:ue.first,exitCommand:"",restartOnExit:!0},e),this.endTimeoutMs=Af(this.name),bn(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}async end(){return this._ended=!0,this._stop()}get proc(){return this.cp}get pid(){return f(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return $(this.pid,e=>pf(e),async()=>!1)}notRunning(){return Mt(this.running())}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}async _stop(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});let e=this.cp;return this.cp=void 0,e==null?!0:this.stopChild(e)}async stopChild(e){return await z(this.opts.exitCommand).filter(P).flatMap(r=>z(e).flatMap(i=>i.stdin).filter(i=>i.writable).forEach(i=>ze(()=>i.write(r+`
`))).map(di).get()),_m(e,this.endTimeoutMs)}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:ya(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){if(this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),this._ended||G())return!1;if(!e&&this.startRate.msSinceLastEvent<c.minTimeBetweenServiceRestartsMs.valueOrDefault){this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:c.minTimeBetweenServiceRestartsMs.valueOrDefault});return}return this.mutex.serial(`WatchedChild(${this.name}).restart`,async()=>(await this._stop(),this._stopped=!1,this._start()))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,async()=>(this._stopped=!1,this._start()))}async _restart(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,async()=>(await this._stop(),this._stopped||this._ended?!1:this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),$m(this.startMs,c.probationMs.valueOrDefault)&&X("Can't restart "+this.name+", failure rate is too high."+pe,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),this.opts.onRestart?.(),this._start())))}async _start(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended||await this.running())return!1;this.startRate.onEvent();let e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);let r="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:i,desc:o})=>{f(i,n=>n.on("error",s=>this.onError(r+o+".on(error)",s)))}),f(this.cp.stdout,i=>An(i,this.opts.dataSep,o=>{this.logger().trace("onDataChunked()",o),this.opts.onStdout(o)})),f(this.cp.stderr,i=>i.on("data",o=>{h(o).includes("Error: Cannot find module")&&X("Failed to start "+this.name+pe,new Error(ur(o,256))),this.opts.onStderr?.(o)===!0&&this.onError(r+".stderr.on(data)",o)})),this.cp.on("exit",async(i,o)=>{this.logger().info("onExit",{code:i,signal:o,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?(await this._restart(),this.logger().info("onExit(): finished setting up new child "+this.pid)):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending "+this.pid),this.end())}),!0}};var Sg=T(require("timers"));function Wf(t,e){e=Math.ceil(e);let r,i=[],o=(...n)=>{i=n,f(r,Sg.clearTimeout),r=Ia(()=>t(...i),e)};return o.reset=()=>{f(r,Sg.clearTimeout),r=void 0},o.now=()=>{o.reset(),t()},o}var jk=d("Mountpoints.localMountpointSetup()");async function bM(){let t=await b(Vs(!1),e=>V(e.map(r=>r.mountpoint)));if(t!=null&&await zs())try{await b(fl(),e=>t.push(...e.map(r=>r.mountpoint)))}catch(e){jk.warn("Failed to fetch gio volumes",e)}return f(t,e=>e.filter(r=>!r.startsWith("/snap/")&&r!=="/dev"))}var Hk=/\s([A-Z]:\\)/g,wM=async()=>Pt(Te.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(t=>t.map(e=>e.Root)).filter(_).orElse(()=>Gk()).map(t=>t.sort()).getRequired(),Gk=async()=>{let t=(await se(await Iv(),["fsinfo","drives"],{timeout:10*M})).trim(),e=[],r;for(;(r=Hk.exec(t))!==null;)e.push(r[1]);return e};var Kk=()=>I?wM():bM(),xM;function TM(t){xM=t,Jk()}var Jk=l(async()=>{_n()?C(async()=>{let t=d("Mountpoints.localMountpointSetup()");re&&(t.info("Setting up Mac diskutil activity watcher"),bt.setTTL(Ss),vM()),Ue&&(await zs()&&(t.info("Setting up Linux gio mount monitor"),bt.setTTL(Ss),SM()),await $k()&&(t.info("Setting up Linux findmnt mount monitor"),bt.setTTL(Ss),MM()))},30*M).unref():await qc([Ri(vM.clear()),Ri(SM.clear()),Ri(MM.clear())])}),bt=l(async()=>(await gi(()=>er(xM,Kk),{maxRetries:3,onRetryWaitUntil:r=>gt(r*1500)}).catch(r=>{X("mountpoints() failed",r)}))?.sort(),Pr);C(()=>q(()=>bt.unset()));var vM=l(()=>Uf({cmd:"diskutil",args:["activity"],onStdout:Wf(()=>bt.unset(),1.5*M)})),SM=l(()=>Uf({cmd:_f,args:fM,onStdout:Wf(()=>{fl.unset(),Nf.unset(),bt.unset()},1.5*M)})),$k=l(async()=>{if(!Ue)return!1;try{return(await Je("findmnt",["--version"],{timeout:H,ignoreStderr:!0})).code===0}catch(t){return!1}}),MM=l(()=>Uf({cmd:"findmnt",args:["--poll"],onStdout:Wf(()=>{Nf.unset(),bt.unset()},1.5*M)}));function Xr(t,e){let r=ZT("vol."+t,()=>gi(e,{maxRetries:2,timeoutMs:H,errorIsRetriable:i=>Qt(i)}),TT);return bt.onChange(()=>r.unset()),C(()=>q(()=>r.unset())),r}var Qk=Xr("localMountpoints",()=>b(Vs(!0),t=>t.map(e=>e.mountpoint))),PM=Xr("dfPosix",async()=>{let t=await Vs(!1);if(t!=null)return await b(Qk(),e=>{t.forEach(r=>{r.remote=!e.includes(r.mountpoint)})}),await zs()&&await b(fl(),e=>t.push(...e)),t});async function EM(t,e){if(!I)throw new Error("wtf");return await b(x(e,()=>Yk()),r=>{let i=Rs(r,o=>[o.mountpoint,o]);t.forEach(o=>{f(i.get(o.mountpoint),n=>{o.remote=!0,o.remoteHost=n.host,o.remoteShare=n.share,o.ok=n.ok})})}),t}var DM=["LocalName","RemoteName","Status"],Xk=["NETUSE","get",DM.join(",")],AM=/^\\\\(.+?)\\(.+)$/,FM=/^[a-z]:\\?$/i;async function e_(){let t=await Te.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return t==null?Zk():F(t.filter(e=>P(e.LocalName)).map(e=>f(Mg(e.RemoteName),({host:r,share:i})=>f(FM.exec(h(e.LocalName)),o=>({mountpoint:Ht(o[0],"\\"),host:r,share:i,ok:e.Status==="OK"&&e.ConnectionState==="Connected"})))))}function Mg(t){if(!S(t))return z(t).flatMap(e=>AM.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>z(t).flatMap(e=>ze(()=>new URL(e))).filter(e=>P(e.hostname)).map(e=>({host:e.hostname,share:z(e.pathname).filter(P).getOrElse(()=>"/")}))).get()}async function Zk(){let t=cf(),e=await se(t,Xk,{timeout:15*M}),r=Bo(DM,e);return F(r.map(i=>f(AM.exec(h(i.RemoteName)),o=>f(FM.exec(h(i.LocalName)),n=>({mountpoint:Ht(n[0],"\\"),host:o[1],share:o[2],ok:i.Status==="OK"})))))}var Yk=Xr("netInfoWin",e_);var LM=l(()=>d("DfWin")),IM=Xr("dfWin",async()=>(await t_()).filter(e=>e.ok!==!1&&B(e.size))),r_="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free";function i_(t){return P(t.Root)&&t.Free!=null&&t.Used!=null?y({mountpoint:t.Root,label:t.Description,size:t.Used+t.Free,used:t.Used,available:t.Free,remote:P(t.DisplayRoot)},f(Mg(t.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))):void 0}var o_="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus,UniqueId",n_=/\{([-a-z0-9]{7,})\}/i;function s_(t){return LM().tap({msg:"uniqueId2uuid",result:f(n_.exec(h(t)),e=>e[1]),meta:{s:t}})}function a_(t){if(t.DriveLetter==null||t.DriveLetter==="null"||t.FileSystemLabel==="System Reserved")return;let e=t.Size!=null&&t.SizeRemaining!=null&&P(t.DriveLetter)&&(kd(t.HealthStatus,r=>at(r,"Healthy"))||kd(t.OperationalStatus,r=>at(r,"OK")));return{mountpoint:t.DriveLetter+":\\",filesystem:t.FileSystem,label:t.FileSystemLabel,uuid:s_(t.UniqueId),size:t.Size,used:t.Size-t.SizeRemaining,available:t.SizeRemaining,remote:!1,ok:e}}async function t_(){let t=await le(Te.instance().executeJsonToA(r_).catch(o=>(X("volumeInfoWin(): LocalAndNetCmd failed",o),[])),o=>zd(i_(o))),e=await le(Te.instance().executeJsonToA(o_).catch(o=>(X("_localAndNet(): LocalCmd failed",o),[])),o=>zd(a_(o))),r=K([...t,...e].filter(o=>o.ok===!1).map(o=>o.mountpoint)),i=xr(K([...t,...e].map(o=>o.mountpoint)).filter(o=>!r.includes(o)));return LM().info("volumeInfoWin()",{getPsDrive:t,getVolumes:e,mountpoints:i,unhealthy:r}),i.map(o=>y(y({},t.find(n=>o===n.mountpoint)),e.find(n=>o===n.mountpoint)))}async function RM(t){return b(l_(),e=>t.map(r=>$(e.get(r.mountpoint),i=>y(y({},r),i),()=>r)))}var l_=Xr("mnt2uuidMac",async()=>{let e=(await se("diskutil",["info","-all"],{timeout:H})).split(/^\s*\*{8,12}\s*$/m);return Rs(e,r=>{let i=Rs(r.split(/\s*\n+\s*/),a=>{let[m,u]=a.split(":").map(p=>p.trim());return hn(["not applicable","no file system"],u)?void 0:[m.toLowerCase(),u]}),o=i.get("mount point"),n=i.get("volume name"),s=i.get("volume uuid");return S(o)?void 0:[o,{label:n,uuid:s}]})});function qf({input:t,lowerCaseKeys:e}){let r={},i;for(let o of ro(t).filter(n=>n.match(/^\s*#/)==null)){let n=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+|#.*?)/gim;for(;(i=n.exec(o))!=null;){let[,s,a,m]=i;r[e?s.toLowerCase():s]=vx(m,a,a)}}return r}var m_=l(()=>d("LocalVolumesPosix"));async function OM(t){return b(await u_(),e=>Gd(K([...e.filter(i=>!i.ignorable).map(i=>i.mountpoint),...t.map(i=>i.mountpoint)])).map(i=>y(y({},t.find(o=>o.mountpoint===i)),e.find(o=>o.mountpoint===i))))}var u_=Xr("localVolumeInfoPosix",async()=>{let t=await se("lsblk",["-P","-b","--output","mountpoint,label,fsused,fsavail,uuid"],{timeout:H}),e=ro(t).map(i=>qf({input:i,lowerCaseKeys:!0})).filter(i=>i!=null),r=await Va(e,async i=>{let o=S(i.mountpoint)||i.mountpoint.startsWith("/snap/")||i.mountpoint==="/boot"||i.mountpoint.startsWith("/boot/")||!await LT(i.mountpoint);return ls(k(i.fsused),k(i.fsavail),(n,s)=>y({mountpoint:i.mountpoint,label:i.label,uuid:i.uuid,ignorable:o,used:n,available:s,size:n+s},de()?void 0:{remote:!1}))});return m_().tap({msg:"lsblk",result:r})});var c_=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i,f_=/^([^:\s]+):(\/.+)$/;async function kM(t){return t.filter(e=>e.remote).forEach(e=>{$(c_.exec(h(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]},()=>f(f_.exec(h(e.filesystem)),r=>{e.remoteHost=r[1],e.remoteShare=r[2]}))}),t}async function _M(t,e){try{return await(e.timeoutMs==null?t():xe(t,e.timeoutMs,()=>X(e.message+": timeout",void 0,e.context)))}catch(r){X(e.message,r,e.context);return}}var NM=T(require("crypto"));function p_(){let t=(0,NM.randomBytes)(16);t[6]=t[6]&15|64;let e=t.toString("hex");return[e.slice(0,8),e.slice(8,12),e.slice(12,16),e.slice(16,20),e.slice(20)].join("-")}function jf(){return Pm(p_)}var Yoe=l(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/);var Qm=l(()=>d("VolumeUUID")),BM=Pr/2,Pg=new Map;C(()=>{q(()=>Pg.clear()),bt.onChange(()=>Pg.clear())});async function CM(t){await pi({name:"addVolumeUUIDs",laters:t.map(e=>()=>d_(e))})}async function d_(t){if(L(t.ignorable)){Qm().debug("volumeUUID(): ignorable is true for "+t.mountpoint);return}if(qr(t.ok)){Qm().debug("volumeUUID(): remoteOK is false for "+t.mountpoint);return}await b(lr(Pg,t.mountpoint,()=>$a(()=>_M(()=>h_(t),{message:"readVolumeUUID("+t.mountpoint+")"}),BM)),e=>t.uuid=e)}async function h_(t){let e=oe.for(t.mountpoint).join(".uuid");if(c.readVolumeUuidFiles.valueOrDefault){let r=await $a(()=>Pt(e.readFile("debug")).map(i=>i.toString().trim()).filter(P).get(),BM);if(r!=null&&r.length>6)return Qm().debug("Serving UUID from .uuid",{uuid:r,mountpoint:t.mountpoint}),r}if(t.mountpoint==="/")return t.uuid;if(c.writeVolumeUuidFiles.valueOrDefault){let r=Rr(t.uuid,jf);if(await e.parent().isReadWritable())try{return await e.writeTxt_(r),Qm().info("volumeUUID(): Saved new UUID for "+t.mountpoint,{uuid:r}),r}catch(i){Qm().warn("volumeUUID(): Failed to save new UUID for "+t.mountpoint,i)}}return t.uuid}var Ym=l(()=>d("Volumes"));async function g_(){let t=await xe(I?IM():PM(),Pr,()=>X("Timed out getting local volume metadata"));if(t==null){Ym().warn("df failed");return}let e=c.validateMountpoints.valueOrDefault?F(await pi({name:"nonRpcVolumes: filter unhealthy volumes",laters:t.map(o=>async()=>{try{if(await Ka(o.mountpoint,Wa/2))return o;Ym().info("validateMountpoints(): "+o.mountpoint+" is not a directory")}catch(n){Ym().info("validateMountpoints(): failed to stat "+o.mountpoint,n)}})})):t;e.some(o=>o.remote&&S(o.remoteHost))&&await xe(I?EM(e):kM(e),10*M).catch(o=>{X("Failed to get remote volume info",o)});let r=x(await(I?e:re?RM(e):OM(e)),e);wt(r,o=>!L(o.ignorable)),c.ignoreUnhealthyVolumes.valueOrDefault&&wt(r,o=>!qr(o.ok));for(let o of r)o.remote=L(o.remote),U(o.remoteHost,n=>o.remoteHost=n.toLowerCase().normalize().trim());for(let o of r)S(o.label)&&delete o.label;Ym().debug("nonRpcVolumes(): before addVolumeUUIDs",r),await CM(r);let i=te(r,o=>o.mountpoint);return Ym().debug("_volumes(): final result",{sorted:i}),Object.freeze(i)}var VM;function zM(t){VM=t}var UM=[],y_=async()=>{try{let t=await er(VM,g_);return Oe(t,e=>{let r=e.map(i=>i.mountpoint).sort();kt(UM,r)||(rT(),UM=r)}),t}catch(t){X("volumes() failed",t);return}},Dt=Xr("volumes",y_),Yne=l(()=>I?z(Ve("SystemDrive")).filter(P).orElse(()=>"C:").map(t=>Ht(t,"\\")).get():"/");async function ao(t){return b(Dt(),e=>Xm(e,t))}function Xm(t,e){let r=t.filter(i=>Ha(e,i.mountpoint));return st(r,i=>nm(i.mountpoint,e))}var Jf=T(require("path"));function Hf(t,e){let r=0,i=new ke(e.maxSize,e.ttlMs),o=n=>(r++,i.getOrSet(O(n),()=>t(n)));return o.clear=n=>n==null?i.clear():i.delete(O(n)),o.size=()=>i.size,o.callCount=()=>r,o}var Gf=T(require("path")),WM=T(require("punycode")),qM=T(require("util"));var ee;(function(t){t[t.Null=0]="Null",t[t.Backspace=8]="Backspace",t[t.Tab=9]="Tab",t[t.LineFeed=10]="LineFeed",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.ExclamationMark=33]="ExclamationMark",t[t.DoubleQuote=34]="DoubleQuote",t[t.Hash=35]="Hash",t[t.DollarSign=36]="DollarSign",t[t.PercentSign=37]="PercentSign",t[t.Ampersand=38]="Ampersand",t[t.SingleQuote=39]="SingleQuote",t[t.OpenParen=40]="OpenParen",t[t.CloseParen=41]="CloseParen",t[t.Asterisk=42]="Asterisk",t[t.Plus=43]="Plus",t[t.Comma=44]="Comma",t[t.Dash=45]="Dash",t[t.Period=46]="Period",t[t.Slash=47]="Slash",t[t.Digit0=48]="Digit0",t[t.Digit1=49]="Digit1",t[t.Digit2=50]="Digit2",t[t.Digit3=51]="Digit3",t[t.Digit4=52]="Digit4",t[t.Digit5=53]="Digit5",t[t.Digit6=54]="Digit6",t[t.Digit7=55]="Digit7",t[t.Digit8=56]="Digit8",t[t.Digit9=57]="Digit9",t[t.Colon=58]="Colon",t[t.Semicolon=59]="Semicolon",t[t.LessThan=60]="LessThan",t[t.Equals=61]="Equals",t[t.GreaterThan=62]="GreaterThan",t[t.QuestionMark=63]="QuestionMark",t[t.AtSign=64]="AtSign",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.OpenSquareBracket=91]="OpenSquareBracket",t[t.Backslash=92]="Backslash",t[t.CloseSquareBracket=93]="CloseSquareBracket",t[t.Caret=94]="Caret",t[t.Underline=95]="Underline",t[t.BackTick=96]="BackTick",t[t.a=97]="a",t[t.b=98]="b",t[t.c=99]="c",t[t.d=100]="d",t[t.e=101]="e",t[t.f=102]="f",t[t.g=103]="g",t[t.h=104]="h",t[t.i=105]="i",t[t.j=106]="j",t[t.k=107]="k",t[t.l=108]="l",t[t.m=109]="m",t[t.n=110]="n",t[t.o=111]="o",t[t.p=112]="p",t[t.q=113]="q",t[t.r=114]="r",t[t.s=115]="s",t[t.t=116]="t",t[t.u=117]="u",t[t.v=118]="v",t[t.w=119]="w",t[t.x=120]="x",t[t.y=121]="y",t[t.z=122]="z",t[t.OpenCurlyBrace=123]="OpenCurlyBrace",t[t.Pipe=124]="Pipe",t[t.CloseCurlyBrace=125]="CloseCurlyBrace",t[t.Tilde=126]="Tilde",t[t.U_Combining_Grave_Accent=768]="U_Combining_Grave_Accent",t[t.U_Combining_Acute_Accent=769]="U_Combining_Acute_Accent",t[t.U_Combining_Circumflex_Accent=770]="U_Combining_Circumflex_Accent",t[t.U_Combining_Tilde=771]="U_Combining_Tilde",t[t.U_Combining_Macron=772]="U_Combining_Macron",t[t.U_Combining_Overline=773]="U_Combining_Overline",t[t.U_Combining_Breve=774]="U_Combining_Breve",t[t.U_Combining_Dot_Above=775]="U_Combining_Dot_Above",t[t.U_Combining_Diaeresis=776]="U_Combining_Diaeresis",t[t.U_Combining_Hook_Above=777]="U_Combining_Hook_Above",t[t.U_Combining_Ring_Above=778]="U_Combining_Ring_Above",t[t.U_Combining_Double_Acute_Accent=779]="U_Combining_Double_Acute_Accent",t[t.U_Combining_Caron=780]="U_Combining_Caron",t[t.U_Combining_Vertical_Line_Above=781]="U_Combining_Vertical_Line_Above",t[t.U_Combining_Double_Vertical_Line_Above=782]="U_Combining_Double_Vertical_Line_Above",t[t.U_Combining_Double_Grave_Accent=783]="U_Combining_Double_Grave_Accent",t[t.U_Combining_Candrabindu=784]="U_Combining_Candrabindu",t[t.U_Combining_Inverted_Breve=785]="U_Combining_Inverted_Breve",t[t.U_Combining_Turned_Comma_Above=786]="U_Combining_Turned_Comma_Above",t[t.U_Combining_Comma_Above=787]="U_Combining_Comma_Above",t[t.U_Combining_Reversed_Comma_Above=788]="U_Combining_Reversed_Comma_Above",t[t.U_Combining_Comma_Above_Right=789]="U_Combining_Comma_Above_Right",t[t.U_Combining_Grave_Accent_Below=790]="U_Combining_Grave_Accent_Below",t[t.U_Combining_Acute_Accent_Below=791]="U_Combining_Acute_Accent_Below",t[t.U_Combining_Left_Tack_Below=792]="U_Combining_Left_Tack_Below",t[t.U_Combining_Right_Tack_Below=793]="U_Combining_Right_Tack_Below",t[t.U_Combining_Left_Angle_Above=794]="U_Combining_Left_Angle_Above",t[t.U_Combining_Horn=795]="U_Combining_Horn",t[t.U_Combining_Left_Half_Ring_Below=796]="U_Combining_Left_Half_Ring_Below",t[t.U_Combining_Up_Tack_Below=797]="U_Combining_Up_Tack_Below",t[t.U_Combining_Down_Tack_Below=798]="U_Combining_Down_Tack_Below",t[t.U_Combining_Plus_Sign_Below=799]="U_Combining_Plus_Sign_Below",t[t.U_Combining_Minus_Sign_Below=800]="U_Combining_Minus_Sign_Below",t[t.U_Combining_Palatalized_Hook_Below=801]="U_Combining_Palatalized_Hook_Below",t[t.U_Combining_Retroflex_Hook_Below=802]="U_Combining_Retroflex_Hook_Below",t[t.U_Combining_Dot_Below=803]="U_Combining_Dot_Below",t[t.U_Combining_Diaeresis_Below=804]="U_Combining_Diaeresis_Below",t[t.U_Combining_Ring_Below=805]="U_Combining_Ring_Below",t[t.U_Combining_Comma_Below=806]="U_Combining_Comma_Below",t[t.U_Combining_Cedilla=807]="U_Combining_Cedilla",t[t.U_Combining_Ogonek=808]="U_Combining_Ogonek",t[t.U_Combining_Vertical_Line_Below=809]="U_Combining_Vertical_Line_Below",t[t.U_Combining_Bridge_Below=810]="U_Combining_Bridge_Below",t[t.U_Combining_Inverted_Double_Arch_Below=811]="U_Combining_Inverted_Double_Arch_Below",t[t.U_Combining_Caron_Below=812]="U_Combining_Caron_Below",t[t.U_Combining_Circumflex_Accent_Below=813]="U_Combining_Circumflex_Accent_Below",t[t.U_Combining_Breve_Below=814]="U_Combining_Breve_Below",t[t.U_Combining_Inverted_Breve_Below=815]="U_Combining_Inverted_Breve_Below",t[t.U_Combining_Tilde_Below=816]="U_Combining_Tilde_Below",t[t.U_Combining_Macron_Below=817]="U_Combining_Macron_Below",t[t.U_Combining_Low_Line=818]="U_Combining_Low_Line",t[t.U_Combining_Double_Low_Line=819]="U_Combining_Double_Low_Line",t[t.U_Combining_Tilde_Overlay=820]="U_Combining_Tilde_Overlay",t[t.U_Combining_Short_Stroke_Overlay=821]="U_Combining_Short_Stroke_Overlay",t[t.U_Combining_Long_Stroke_Overlay=822]="U_Combining_Long_Stroke_Overlay",t[t.U_Combining_Short_Solidus_Overlay=823]="U_Combining_Short_Solidus_Overlay",t[t.U_Combining_Long_Solidus_Overlay=824]="U_Combining_Long_Solidus_Overlay",t[t.U_Combining_Right_Half_Ring_Below=825]="U_Combining_Right_Half_Ring_Below",t[t.U_Combining_Inverted_Bridge_Below=826]="U_Combining_Inverted_Bridge_Below",t[t.U_Combining_Square_Below=827]="U_Combining_Square_Below",t[t.U_Combining_Seagull_Below=828]="U_Combining_Seagull_Below",t[t.U_Combining_X_Above=829]="U_Combining_X_Above",t[t.U_Combining_Vertical_Tilde=830]="U_Combining_Vertical_Tilde",t[t.U_Combining_Double_Overline=831]="U_Combining_Double_Overline",t[t.U_Combining_Grave_Tone_Mark=832]="U_Combining_Grave_Tone_Mark",t[t.U_Combining_Acute_Tone_Mark=833]="U_Combining_Acute_Tone_Mark",t[t.U_Combining_Greek_Perispomeni=834]="U_Combining_Greek_Perispomeni",t[t.U_Combining_Greek_Koronis=835]="U_Combining_Greek_Koronis",t[t.U_Combining_Greek_Dialytika_Tonos=836]="U_Combining_Greek_Dialytika_Tonos",t[t.U_Combining_Greek_Ypogegrammeni=837]="U_Combining_Greek_Ypogegrammeni",t[t.U_Combining_Bridge_Above=838]="U_Combining_Bridge_Above",t[t.U_Combining_Equals_Sign_Below=839]="U_Combining_Equals_Sign_Below",t[t.U_Combining_Double_Vertical_Line_Below=840]="U_Combining_Double_Vertical_Line_Below",t[t.U_Combining_Left_Angle_Below=841]="U_Combining_Left_Angle_Below",t[t.U_Combining_Not_Tilde_Above=842]="U_Combining_Not_Tilde_Above",t[t.U_Combining_Homothetic_Above=843]="U_Combining_Homothetic_Above",t[t.U_Combining_Almost_Equal_To_Above=844]="U_Combining_Almost_Equal_To_Above",t[t.U_Combining_Left_Right_Arrow_Below=845]="U_Combining_Left_Right_Arrow_Below",t[t.U_Combining_Upwards_Arrow_Below=846]="U_Combining_Upwards_Arrow_Below",t[t.U_Combining_Grapheme_Joiner=847]="U_Combining_Grapheme_Joiner",t[t.U_Combining_Right_Arrowhead_Above=848]="U_Combining_Right_Arrowhead_Above",t[t.U_Combining_Left_Half_Ring_Above=849]="U_Combining_Left_Half_Ring_Above",t[t.U_Combining_Fermata=850]="U_Combining_Fermata",t[t.U_Combining_X_Below=851]="U_Combining_X_Below",t[t.U_Combining_Left_Arrowhead_Below=852]="U_Combining_Left_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_Below=853]="U_Combining_Right_Arrowhead_Below",t[t.U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below=854]="U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below",t[t.U_Combining_Right_Half_Ring_Above=855]="U_Combining_Right_Half_Ring_Above",t[t.U_Combining_Dot_Above_Right=856]="U_Combining_Dot_Above_Right",t[t.U_Combining_Asterisk_Below=857]="U_Combining_Asterisk_Below",t[t.U_Combining_Double_Ring_Below=858]="U_Combining_Double_Ring_Below",t[t.U_Combining_Zigzag_Above=859]="U_Combining_Zigzag_Above",t[t.U_Combining_Double_Breve_Below=860]="U_Combining_Double_Breve_Below",t[t.U_Combining_Double_Breve=861]="U_Combining_Double_Breve",t[t.U_Combining_Double_Macron=862]="U_Combining_Double_Macron",t[t.U_Combining_Double_Macron_Below=863]="U_Combining_Double_Macron_Below",t[t.U_Combining_Double_Tilde=864]="U_Combining_Double_Tilde",t[t.U_Combining_Double_Inverted_Breve=865]="U_Combining_Double_Inverted_Breve",t[t.U_Combining_Double_Rightwards_Arrow_Below=866]="U_Combining_Double_Rightwards_Arrow_Below",t[t.U_Combining_Latin_Small_Letter_A=867]="U_Combining_Latin_Small_Letter_A",t[t.U_Combining_Latin_Small_Letter_E=868]="U_Combining_Latin_Small_Letter_E",t[t.U_Combining_Latin_Small_Letter_I=869]="U_Combining_Latin_Small_Letter_I",t[t.U_Combining_Latin_Small_Letter_O=870]="U_Combining_Latin_Small_Letter_O",t[t.U_Combining_Latin_Small_Letter_U=871]="U_Combining_Latin_Small_Letter_U",t[t.U_Combining_Latin_Small_Letter_C=872]="U_Combining_Latin_Small_Letter_C",t[t.U_Combining_Latin_Small_Letter_D=873]="U_Combining_Latin_Small_Letter_D",t[t.U_Combining_Latin_Small_Letter_H=874]="U_Combining_Latin_Small_Letter_H",t[t.U_Combining_Latin_Small_Letter_M=875]="U_Combining_Latin_Small_Letter_M",t[t.U_Combining_Latin_Small_Letter_R=876]="U_Combining_Latin_Small_Letter_R",t[t.U_Combining_Latin_Small_Letter_T=877]="U_Combining_Latin_Small_Letter_T",t[t.U_Combining_Latin_Small_Letter_V=878]="U_Combining_Latin_Small_Letter_V",t[t.U_Combining_Latin_Small_Letter_X=879]="U_Combining_Latin_Small_Letter_X",t[t.LINE_SEPARATOR=8232]="LINE_SEPARATOR",t[t.PARAGRAPH_SEPARATOR=8233]="PARAGRAPH_SEPARATOR",t[t.NEXT_LINE=133]="NEXT_LINE",t[t.U_CIRCUMFLEX=94]="U_CIRCUMFLEX",t[t.U_GRAVE_ACCENT=96]="U_GRAVE_ACCENT",t[t.U_DIAERESIS=168]="U_DIAERESIS",t[t.U_MACRON=175]="U_MACRON",t[t.U_ACUTE_ACCENT=180]="U_ACUTE_ACCENT",t[t.U_CEDILLA=184]="U_CEDILLA",t[t.U_MODIFIER_LETTER_LEFT_ARROWHEAD=706]="U_MODIFIER_LETTER_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_RIGHT_ARROWHEAD=707]="U_MODIFIER_LETTER_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_UP_ARROWHEAD=708]="U_MODIFIER_LETTER_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_DOWN_ARROWHEAD=709]="U_MODIFIER_LETTER_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING=722]="U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING",t[t.U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING=723]="U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING",t[t.U_MODIFIER_LETTER_UP_TACK=724]="U_MODIFIER_LETTER_UP_TACK",t[t.U_MODIFIER_LETTER_DOWN_TACK=725]="U_MODIFIER_LETTER_DOWN_TACK",t[t.U_MODIFIER_LETTER_PLUS_SIGN=726]="U_MODIFIER_LETTER_PLUS_SIGN",t[t.U_MODIFIER_LETTER_MINUS_SIGN=727]="U_MODIFIER_LETTER_MINUS_SIGN",t[t.U_BREVE=728]="U_BREVE",t[t.U_DOT_ABOVE=729]="U_DOT_ABOVE",t[t.U_RING_ABOVE=730]="U_RING_ABOVE",t[t.U_OGONEK=731]="U_OGONEK",t[t.U_SMALL_TILDE=732]="U_SMALL_TILDE",t[t.U_DOUBLE_ACUTE_ACCENT=733]="U_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_RHOTIC_HOOK=734]="U_MODIFIER_LETTER_RHOTIC_HOOK",t[t.U_MODIFIER_LETTER_CROSS_ACCENT=735]="U_MODIFIER_LETTER_CROSS_ACCENT",t[t.U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR=741]="U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_HIGH_TONE_BAR=742]="U_MODIFIER_LETTER_HIGH_TONE_BAR",t[t.U_MODIFIER_LETTER_MID_TONE_BAR=743]="U_MODIFIER_LETTER_MID_TONE_BAR",t[t.U_MODIFIER_LETTER_LOW_TONE_BAR=744]="U_MODIFIER_LETTER_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR=745]="U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR",t[t.U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK=746]="U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK=747]="U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK",t[t.U_MODIFIER_LETTER_UNASPIRATED=749]="U_MODIFIER_LETTER_UNASPIRATED",t[t.U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD=751]="U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_UP_ARROWHEAD=752]="U_MODIFIER_LETTER_LOW_UP_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD=753]="U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD=754]="U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD",t[t.U_MODIFIER_LETTER_LOW_RING=755]="U_MODIFIER_LETTER_LOW_RING",t[t.U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT=756]="U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT=757]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT",t[t.U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT=758]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT",t[t.U_MODIFIER_LETTER_LOW_TILDE=759]="U_MODIFIER_LETTER_LOW_TILDE",t[t.U_MODIFIER_LETTER_RAISED_COLON=760]="U_MODIFIER_LETTER_RAISED_COLON",t[t.U_MODIFIER_LETTER_BEGIN_HIGH_TONE=761]="U_MODIFIER_LETTER_BEGIN_HIGH_TONE",t[t.U_MODIFIER_LETTER_END_HIGH_TONE=762]="U_MODIFIER_LETTER_END_HIGH_TONE",t[t.U_MODIFIER_LETTER_BEGIN_LOW_TONE=763]="U_MODIFIER_LETTER_BEGIN_LOW_TONE",t[t.U_MODIFIER_LETTER_END_LOW_TONE=764]="U_MODIFIER_LETTER_END_LOW_TONE",t[t.U_MODIFIER_LETTER_SHELF=765]="U_MODIFIER_LETTER_SHELF",t[t.U_MODIFIER_LETTER_OPEN_SHELF=766]="U_MODIFIER_LETTER_OPEN_SHELF",t[t.U_MODIFIER_LETTER_LOW_LEFT_ARROW=767]="U_MODIFIER_LETTER_LOW_LEFT_ARROW",t[t.U_GREEK_LOWER_NUMERAL_SIGN=885]="U_GREEK_LOWER_NUMERAL_SIGN",t[t.U_GREEK_TONOS=900]="U_GREEK_TONOS",t[t.U_GREEK_DIALYTIKA_TONOS=901]="U_GREEK_DIALYTIKA_TONOS",t[t.U_GREEK_KORONIS=8125]="U_GREEK_KORONIS",t[t.U_GREEK_PSILI=8127]="U_GREEK_PSILI",t[t.U_GREEK_PERISPOMENI=8128]="U_GREEK_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_PERISPOMENI=8129]="U_GREEK_DIALYTIKA_AND_PERISPOMENI",t[t.U_GREEK_PSILI_AND_VARIA=8141]="U_GREEK_PSILI_AND_VARIA",t[t.U_GREEK_PSILI_AND_OXIA=8142]="U_GREEK_PSILI_AND_OXIA",t[t.U_GREEK_PSILI_AND_PERISPOMENI=8143]="U_GREEK_PSILI_AND_PERISPOMENI",t[t.U_GREEK_DASIA_AND_VARIA=8157]="U_GREEK_DASIA_AND_VARIA",t[t.U_GREEK_DASIA_AND_OXIA=8158]="U_GREEK_DASIA_AND_OXIA",t[t.U_GREEK_DASIA_AND_PERISPOMENI=8159]="U_GREEK_DASIA_AND_PERISPOMENI",t[t.U_GREEK_DIALYTIKA_AND_VARIA=8173]="U_GREEK_DIALYTIKA_AND_VARIA",t[t.U_GREEK_DIALYTIKA_AND_OXIA=8174]="U_GREEK_DIALYTIKA_AND_OXIA",t[t.U_GREEK_VARIA=8175]="U_GREEK_VARIA",t[t.U_GREEK_OXIA=8189]="U_GREEK_OXIA",t[t.U_GREEK_DASIA=8190]="U_GREEK_DASIA",t[t.U_OVERLINE=8254]="U_OVERLINE",t[t.UTF8_BOM=65279]="UTF8_BOM"})(ee||(ee={}));var b_=/^\w[\w\d+.-]*$/,w_=/^\//,x_=/^\/\//;function T_(t,e){if(!t.scheme&&e===!0)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${t.authority}", path: "${t.path}", query: "${t.query}", fragment: "${t.fragment}"}`);if(t.scheme&&!b_.test(t.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(t.path){if(t.authority){if(!w_.test(t.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(x_.test(t.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}}function v_(t,e){return!t&&!e?"file":t}function S_(t,e){switch(t){case"https":case"http":case"file":e?e[0]!==hr&&(e=hr+e):e=hr;break}return e}var We="",hr="/",M_=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,Ne=class{static isUri(e){return e instanceof Ne?!0:e==null?!1:typeof e.authority=="string"&&typeof e.fragment=="string"&&typeof e.path=="string"&&typeof e.query=="string"&&typeof e.scheme=="string"&&typeof e.fsPath=="function"&&typeof e.with=="function"&&typeof e.toString=="function"}constructor(e,r,i,o,n,s=!1){typeof e=="object"?(this.scheme=e.scheme||We,this.authority=e.authority||We,this.path=e.path||We,this.query=e.query||We,this.fragment=e.fragment||We):(this.scheme=v_(e,s),this.authority=x(r,We),this.path=S_(this.scheme,x(i,We)),this.query=x(o,We),this.fragment=x(n,We),T_(this,s))}get fsPath(){return Eg(this,!1)}with(e){if(e==null)return this;let{scheme:r,authority:i,path:o,query:n,fragment:s}=e;return r===void 0?r=this.scheme:r===null&&(r=We),i===void 0?i=this.authority:i===null&&(i=We),o===void 0?o=this.path:o===null&&(o=We),n===void 0?n=this.query:n===null&&(n=We),s===void 0?s=this.fragment:s===null&&(s=We),r===this.scheme&&i===this.authority&&o===this.path&&n===this.query&&s===this.fragment?this:new pl(r,i,o,n,s)}static parse(e,r=!1){let i=M_.exec(e);if(!i)return new pl(We,We,We,We,We);let o=i[2]||We,n=Kf(i[4]||We),s=(i[5]||We).split("/").map(Kf).join("/"),a=o==="psfile"&&s.startsWith("//")?s.slice(1):s,m=Kf(i[7]||We),u=Kf(i[9]||We);return new pl(o,n,a,m,u,r)}static file(e){let r=We;if(I&&(e=e.replace(/\\/g,hr)),e[0]===hr&&e[1]===hr){let i=e.indexOf(hr,2);i===-1?(r=e.substring(2),e=hr):(r=e.substring(2,i),e=e.substring(i)||hr)}return new pl("file",r,e,We,We)}static from(e){return new pl(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...r){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let i;return I&&e.scheme==="file"?i=Ne.file(Gf.win32.join(Eg(e,!0),...r)).path:i=Gf.posix.join(e.path,...r),e.with({path:i})}isRootPath(){return this.path==null||this.path===hr}get pathBase(){return this.isRootPath()?"":f(this.path,e=>sx(e.split(hr),P))}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(hr))})}join(...e){return this.with({path:Ht(this.path,hr)+e.join(hr)})}toString(e=!1){return Dg(this,e)}toJSON(){return this}[qM.inspect.custom](){return this.toString()}},P_=wT?1:void 0,pl=class extends Ne{constructor(){super(...arguments);this._formatted=null;this._fsPath=null}get fsPath(){return this._fsPath==null&&(this._fsPath=Eg(this,!1)),this._fsPath}toString(e=!1){return e?Dg(this,!0):(this._formatted==null&&(this._formatted=Dg(this,!1)),this._formatted)}toJSON(){let e={$mid:1};return this._fsPath!=null&&(e.fsPath=this._fsPath,e._sep=P_),this._formatted!=null&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),this.query&&(e.query=this.query),this.fragment&&(e.fragment=this.fragment),e}},jM={[ee.Colon]:"%3A",[ee.Slash]:"%2F",[ee.QuestionMark]:"%3F",[ee.Hash]:"%23",[ee.OpenSquareBracket]:"%5B",[ee.CloseSquareBracket]:"%5D",[ee.AtSign]:"%40",[ee.ExclamationMark]:"%21",[ee.DollarSign]:"%24",[ee.Ampersand]:"%26",[ee.SingleQuote]:"%27",[ee.OpenParen]:"%28",[ee.CloseParen]:"%29",[ee.Asterisk]:"%2A",[ee.Plus]:"%2B",[ee.Comma]:"%2C",[ee.Semicolon]:"%3B",[ee.Equals]:"%3D",[ee.Space]:"%20"};function HM(t,e){let r,i=-1;for(let o=0;o<t.length;o++){let n=t.charCodeAt(o);if(n>=ee.a&&n<=ee.z||n>=ee.A&&n<=ee.Z||n>=ee.Digit0&&n<=ee.Digit9||n===ee.Dash||n===ee.Period||n===ee.Underline||n===ee.Tilde||e&&n===ee.Slash)i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r!==void 0&&(r+=t.charAt(o));else{r===void 0&&(r=t.substr(0,o));let s=jM[n];s!==void 0?(i!==-1&&(r+=encodeURIComponent(t.substring(i,o)),i=-1),r+=s):i===-1&&(i=o)}}return i!==-1&&(r+=encodeURIComponent(t.substring(i))),r!==void 0?r:t}function E_(t){let e;for(let r=0;r<t.length;r++){let i=t.charCodeAt(r);i===ee.Hash||i===ee.QuestionMark?(e===void 0&&(e=t.substr(0,r)),e+=jM[i]):e!==void 0&&(e+=t[r])}return e!==void 0?e:t}function Eg(t,e){let r;return t.authority&&t.path.length>1&&t.scheme==="file"?r=`//${t.authority}${t.path}`:t.path.charCodeAt(0)===ee.Slash&&(t.path.charCodeAt(1)>=ee.A&&t.path.charCodeAt(1)<=ee.Z||t.path.charCodeAt(1)>=ee.a&&t.path.charCodeAt(1)<=ee.z)&&t.path.charCodeAt(2)===ee.Colon?e?r=t.path.substr(1):r=t.path[1].toLowerCase()+t.path.substr(2):r=t.path,I&&(r=r.replace(/\//g,"\\")),r}function Dg(t,e){let r=e?E_:HM,i="",{scheme:o,query:n,fragment:s}=t,{authority:a,path:m}=t;if(o&&(i+=o,i+=":"),(a||o==="file")&&(i+=hr,i+=hr),a){let u=a.indexOf("@");if(u!==-1){let p=a.substr(0,u);a=a.substr(u+1),u=p.indexOf(":"),u===-1?i+=r(p,!1):(i+=r(p.substr(0,u),!1),i+=":",i+=r(p.substr(u+1),!1)),i+="@"}u=a.indexOf(":"),u===-1?i+=r(a,!1):(i+=r(a.substr(0,u),!1),i+=a.substr(u))}if(m){if(m.length>=3&&m.charCodeAt(0)===ee.Slash&&m.charCodeAt(2)===ee.Colon){let u=m.charCodeAt(1);u>=ee.A&&u<=ee.Z&&(m=`/${String.fromCharCode(u+32)}:${m.substr(3)}`)}else if(m.length>=2&&m.charCodeAt(1)===ee.Colon){let u=m.charCodeAt(0);u>=ee.A&&u<=ee.Z&&(m=`${String.fromCharCode(u+32)}:${m.substr(2)}`)}i+=r(m,!0)}return n&&(i+="?",i+=r(n,!1)),s&&(i+="#",i+=e?s:HM(s,!1)),i}function GM(t){try{return decodeURIComponent(t)}catch{return t.length>3?t.substr(0,3)+GM(t.substr(3)):t}}var KM=/(%[0-9A-Za-z][0-9A-Za-z])+/g;function Kf(t){return t.startsWith("xn--")?(0,WM.toUnicode)(t):t.match(KM)?t.replace(KM,e=>GM(e)):t}function Zm(t){return Ne.isUri(t)?t:Ne.parse(t)}var Us=Hf(t=>U(t,Jr),{maxSize:128,ttlMs:E});C(()=>{q(()=>Ag.unset()),Dt.onChange(()=>Ag.unset())});var Ag=l(async()=>b(Dt(),t=>uf(t.map(e=>[Us(e.uuid),e.mountpoint]))));function JM(t,e){if(S(t)||e==null||S(e.uuid))return;let r=hi(t),i=hi(e.mountpoint);if(!r.normalize().startsWith(i.normalize()))return;let o=ui(r.slice(i.length),"/");return Ne.from({scheme:Uo,authority:Us(e.uuid),path:o})}function Fg(t,e){return(0,Jf.join)(t,...e.split("/").slice(1))}async function $M(t,e){if(t.scheme!==Uo)throw new Error("invalid URI: "+t+" (bad scheme)");if(S(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=e!=null&&e.includes(Jf.sep);if(r){let o=await ao(e);if(o?.uuid!=null&&Us(o.uuid)===t.authority)return Fg(e,t.path)}let i=await b(Ag(),o=>o.get(t.authority));if(P(i))return Fg(i,t.path);if(r)return Fg(e,t.path)}var QM=T(require("path"));var Lse=Ne.from({scheme:so,path:""});function YM(t){let e=c.libraryPath.value;if(S(e)||S(t)||!t.startsWith(e))return;let r="/"+Gc({nativePath:e},{nativePath:t});return Ne.from({scheme:so,path:r})}function XM(t){if(t.scheme!==so)throw new Error("invalid URI: "+t+" (bad scheme)");let e=c.libraryPath.value;if(S(e))throw new Error("invalid URI: "+t+" (no library set)");return(0,QM.join)(e,...t.path.split("/"))}var Ws=T(require("path"));function ZM(t,e){if(!S(t)){if(e!=null&&e.remote===!0&&P(e.remoteHost)&&P(e.remoteShare))return Ne.from({scheme:Ti,authority:e.remoteHost,path:Ws.posix.join("/"+e.remoteShare,Ge(hi(t),hi(e.mountpoint)))});if(t.startsWith("\\\\"))return Ne.file(t).with({scheme:Ti})}}async function eP(t,e){if(t.scheme!==Ti)throw new Error("invalid URI: "+t+" (bad scheme)");if(S(t.authority))throw new Error("invalid URI: "+t+" (missing authority)");let r=t.path.split("/").slice(1),i=r[0];if(S(i))throw new Error("invalid URI: "+t+" (missing share)");if(I)return`\\\\${t.authority}\\${r.join(Ws.sep)}`;let o=r.slice(1),n=await Dt();for(let s of A(n))if(!!s.remote&&at(s.remoteShare,i)&&await uM(t.authority,s.remoteHost))return(0,Ws.join)(s.mountpoint,...o);if(await Ka(e))return(0,Ws.join)(e,...o)}var D_=["http:","https:","file:",Uo,Ti].map(t=>t+"//");function tP(t){let e=h(t).toLowerCase();return D_.some(r=>e.startsWith(r))}var A_=l(()=>d("UriNormalization"));function rP(t){try{return Ne.parse(t).toString()}catch(e){return A_().warn("Failed to normalize invalid URI",{uri:t,err:e}),t}}function F_(t,e){try{if(t==null||e==null)return!1;let r=Ne.parse(t),i=Ne.parse(e);return r.scheme===i.scheme&&r.authority===i.authority&&r.path.normalize()===i.path.normalize()}catch{return!1}}async function iP(t,e){try{if(t==null||e==null)return!1;if(Ai(t,e))return!0;let r=t.toString(),i=e.toString();return F_(r,i)?!0:await za(qs(r),qs(i),(o,n)=>o.normalize()===n.normalize(),()=>!1)}catch{return!1}}var oP=l(()=>d("FileURI"));async function nP(t,e){if(t==null||S(t))return oP().throw("empty nativePath passed to nativePath2uri()",{retriable:!1});let r=l(()=>Ee(e,()=>ao(t)));return er(()=>YM(t),async()=>JM(t,await r()),async()=>ZM(t,await r()),()=>Ne.file(t))}function L_(t){try{return Ne.isUri(t)?t:Ne.parse(t,!0)}catch(e){oP().warn("bad URI",{uri:t,err:e});return}}async function qs(t,e){if(S(t))return;let r=L_(t);if(r!=null)switch(r.scheme){case"file":return r.fsPath;case Uo:return $M(r,e);case Ti:return eP(r,e);case so:return XM(r);default:throw new Error("unsupported URI: "+t)}}async function I_(t){let e=await Te.instance().executeJsonToA(["Get-Item -Force -LiteralPath",Is(t.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return z(e).flatMap(r=>r[0]).flatMap(r=>r.Mode).filter(P).flatMap(r=>r.includes("h")||r.includes("s")).getOrElse(()=>!1)}async function R_(t){try{let e=await se("stat",["-f","%f",t.nativePath],{timeout:10*M}),r=k(e);return r!=null?(r&32768)>0:!1}catch(e){return!1}}function $f(t){return t.base.startsWith(".")?!0:I?I_(t):re?R_(t):!1}function aP(t,e,r){let i={};try{for(let o of t)for(let n of vt(o)){let s=o[n]();if(i[n]=x(s,!1),s===!0)return s}return!1}finally{sP(r,e,i)}}function sP(t,e,r){let i=r==null?"warn":"debug";t.log(i,e,r)}async function lP(t,e,r){let i={};try{for(let o of t)for(let n of vt(o)){let s=await o[n]();if(i[n]=s,s)return s}return!1}finally{sP(r,e,i)}}var Lg=class{constructor(){this.store=new Map}add(e,r){lr(this.store,e,()=>new Set).add(r)}delete(e,r){f(this.store.get(e),i=>{i.delete(r),i.size===0&&this.store.delete(e)})}find(e){return Ro(e.findIndex((r,i)=>this.store.get(r)?.has(e[i+1])),r=>e.slice(r,r+2))}has(e){return this.find(e)!=null}};var O_=l(()=>d("NeverIgnoredPaths")),k_=l(()=>{c.neverIgnored.addListener(()=>{eu.clear(),Or(),O_().info("Settings.neverIgnored changed",c.neverIgnored.value)}),c.scanPaths.addListener(()=>{eu.clear(),Or()}),q(()=>eu.clear())}),eu=l(()=>(k_(),new Set(V([...c.scanPaths.values,...c.neverIgnored.values]))));function dl(t){return eu().has(t)||eu().has(t.toLowerCase())}function mP(t){return dl(t)?{pathIsNeverIgnored:()=>!1}:void 0}var uP=T(require("path"));var __=/^\.?NoMedia$/i,cP="NoMedia";function fP(t){return[t,t.toLowerCase(),t.toUpperCase()]}var N_=Object.freeze([...fP("."+cP),...fP(cP)]);function pP(t){return __.exec(t)!=null}var Qf=new to({maxSize:1024,timeoutMs:Pr,clearEveryMs:E});C(()=>q(()=>Qf.clear()));C(()=>pr(t=>{t==null?Qf.clear():Qf.deleteIf(e=>e.startsWith(t))}));var Yf=l(()=>d("hasNoMedia()"));async function Bn(t){return t==null?!1:dl(t.nativePath)?Yf().tap({msg:t+" is never ignored",result:!1}):t instanceof ie?Bn(await t.directoryEntry()):pP(t.base)?Yf().tap({msg:t+" basename is NoMedia",result:!0}):vn(t.nativePath).some(pP)?Yf().tap({msg:t+" parent path is NoMedia",result:!0}):await t.isDirectory()&&await Qf.getOrSetAsync(t.nativePath,async()=>{for(let r of N_)if(await IT((0,uP.join)(t.nativePath,r)))return Yf().tap({msg:t+" is a directory and has a noMedia child, "+r,result:!0});return!1})===!0?!0:t.isRoot?!1:b(t.parent(),Bn)}function dP(t){let e=c.maxDuplicatePathElements.valueOrDefault;for(let r of new Set(t))if(ci(t,i=>i===r)>e)return!0;return!1}var Ce=class{constructor(e){this.apply=e}static lift(e){return new Ce(e)}static and(...e){return new Ce(async r=>{for(let i of e)if(!await i.apply(r))return!1;return!0})}static or(...e){return new Ce(async r=>{for(let i of e)if(await i.apply(r))return!0;return!1})}static logged(e,...r){return fx(r,i=>Ze(i).map(([o,n])=>n.asAsync().logged(e,o)))}static andLogged(e,...r){return this.and(...this.logged(e,...r))}static orLogged(e,...r){return this.or(...this.logged(e,...r))}static async andExplain(e,r){let i=[],o=[];for(let n of r)for(let[s,a]of Ze(n))(await a.apply(e)?i:o).push(s);return{accepted:i,rejected:o}}asAsync(){return this}and(...e){return Ce.and(this,...e)}not(){return new Ce(e=>Mt(this.apply(e)))}or(e){return new Ce(async r=>await this.apply(r)||await e.apply(r))}async filter(e){return Mm(e,r=>this.apply(r))}logged(e,r){return new Ce(async o=>{let n=await this.apply(o);return e.log(n?"debug":"info",[Ma(r),n?Sa("ACCEPT"):fs("REJECT"),ur(o)].join(" ")),n})}};var B_=d("Snap"),gP=Ce.lift(async t=>{if(!await hP())return!1;let r=vn(t.nativePath).indexOf("snap");return r<0?!1:A(await C_()).includes(vn[r+1])}),hP=l(async()=>{if(!Ue||de())return!1;try{return await se("snap",["--version"],{timeout:10*M,quiet:!0,maxRetries:0}),!0}catch{return!1}}),C_=l(async()=>{if(!await hP())return[];try{return await Bo(["Name","Version"],await se("snap",["list"],{timeout:10*M})).map(t=>t.Name)}catch(t){return B_.warn("snap failed",t),[]}},30*M);var yP=class{constructor(e=fe){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize()));this.ignorableDirectories=new Set(["#snapshot","__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Support","Applications","arangodb","cache","caches","CacheClip","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iMovie Cache","iTunes Cache","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","SteamApps","System Volume Information","System32","temp","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase()));this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/resources\/media\/face/i,/\/facetile[-_]/i,/\/.*?\.photos?library\/(?!(masters?|originals)\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i];this.systemDirs=K(V([Ja(),Ve("APPDATA"),Ve("SYSTEMROOT"),Ve("ProgramFiles"),Ve("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize()));this.ignorableSubdirs=new Lg;Ue&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);let r=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",r),this.addIgnorableSubdirs("cygwin",r),this.addIgnorableSubdirs("cygwin64",r),this.addIgnorableSubdirs("local",r),this.addIgnorableSubdirs("Windows",["Boot","Containers","Cursors","Fonts","Help","Installer","Logs","Microsoft.NET","SoftwareDistribution","System","System32","SysWOW64","Temp"]),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...r]),this.addIgnorableSubdirs("lfs",["objects"]),this.addIgnorableSubdirs("var",["cache","crash","games","lib","local","lock","log","mail","run","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);let i=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",i),this.addIgnorableSubdirs("Perl64",i),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(Ve("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("temp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),I&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,r){if(S(e))return;let i=e.toLowerCase().normalize();V(r).forEach(o=>this.ignorableSubdirs.add(i,o.toLowerCase().normalize()))}ignorablePathPredicates(e){let r=mP(e);if(r!=null)return r;let i=e.toLowerCase().normalize(),o=V(vn(i));return{hiddenPosix:()=>o.some(n=>n.startsWith(".")),systemDir:()=>this.systemDirs.some(n=>i.startsWith(n)),ignorableRoot:()=>this.ignorableRootDirectories.has(o[0]),ignorableDirectory:()=>o.some(n=>this.ignorableDirectories.has(n)),ignorablePath:()=>this.ignorableSubdirs.has(o),ignorablePattern:()=>{let n=hi(e);return this.ignorableDirectoryPatterns.some(s=>s.test(n))}}}ignorablePath(e){return aP([this.ignorablePathPredicates(e)],e,d("ignorablePath()"))}},bP=l(()=>new yP);function V_(t){return y(y({},bP().ignorablePathPredicates(t)),{notExists:()=>oe.for(t).notExists()})}function tu(t){return bP().ignorablePath(t)}function wP(t){return tu(t.nativePath)}function z_(t){let e=t.nativePath.toLowerCase().normalize();return dl(t.nativePath)||dl(e)?{pathIsNeverIgnored:()=>!1}:y(y({},V_(t.nativePath)),{snapDirectory:async()=>Ue&&await gP.apply(t),noMedia:async()=>await Bn(t)===!0,hidden:()=>$f(t),seemsRecursive:()=>dP(t.pathnames),mountpoint:async()=>he(bt(),r=>r.includes(t.nativePath),()=>!1)})}async function xP(t){return lP([z_(t)],t.nativePath,d("ignorableDirectory()"))}var vP=new Fm;var oe=class extends ie{constructor(e,r){super(e,r);this.nativePath=e;this.pflog=l(()=>d("PosixFile("+this.nativePath+")"));this.uriObject=l(()=>nP(this.nativePath));this.uri=l(()=>b(this.uriObject(),h));this.fileuri=l(()=>Ne.file(this.nativePath).toString());this.mountpoint=l(()=>I&&this.nativePath.startsWith("\\\\")?this.for(this.nativePath.split("\\").slice(0,4).join("\\")):b(bt(),e=>this.bestMountpoint(e.map(r=>this.for(r)))));this.etag=l(()=>b(this.stat(),e=>[e.size,e.mtime.getTime()].map(r=>Pn.encode(r)).join("-")));this.isMountpoint=l(async()=>await this.isDirectory()&&await he(bt(),e=>e.includes(this.nativePath),()=>!1));this.sidecars=l(async()=>{if(this.isSidecar())return[];let e=await this.parent().childDirectoryEntries(i=>i.base!==this.base&&Km(i.ext)&&(i.name===this.name||i.name===this.base||(c.matchSidecarsCaseInsensitively.valueOrDefault?at(i.name,this.name)||at(i.name,this.base):!1)||Kr(i.name)===Kr(this.name)||(c.matchSidecarsCaseInsensitively.valueOrDefault?at(Kr(i.name),Kr(this.name)):!1)));if(e==null)return[];let r=e.map(i=>this.parent()._directoryEntryChild(i));return bm(r,i=>i.maxStatMs())});this.shaWithSidecars=l(async()=>{let e=[this,...await this.sidecars()].map(i=>i.nativePath);return(await of(xr(e))).toString("base64")},ie.attrTTL)}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,r){if(S(e))throw new Error("unexpectedly empty path");if(e instanceof oe)return e;if(e instanceof ie)return this.for(e.nativePath,r);if(tP(e))throw new Error("use forUri");let i=vP.get(e);if(i!=null)return i;let o=_r(e);return vP.getOrSet(o,()=>new oe(o,r))}static forPosix(e){return this.for(e.replace(/\//g,TP.sep))}static forUri(e,r){return b(qs(e,r),i=>this.for(i))}for(e,r){return oe.for(e,r)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.sidecars.unset(),this}bestMountpoint(e){return st(e.filter(r=>Ha(this.nativePath,r.toString())).map(r=>oe.for(r)),r=>z(nm(this.pathnames,r.pathnames)).filter(i=>i>=r.pathnames.length).get())}async isDeleted(e){if(e=await Rr(e,()=>this.uri()),this.isUNC)return this.pflog().tap({result:void 0,msg:"isDeleted(): UNC not supported"});if(await this.exists())return this.pflog().tap({result:!1,msg:"isDeleted(): file exists"});if(e==null)return this.pflog().tap({result:void 0,level:"warn",msg:"isDeleted(): missing URI"});if(e=Zm(e),e.isRootPath())return this.pflog().tap({result:void 0,msg:"isDeleted(): uri isRootPath",meta:{uri:e}});if(h(e.pathBase).normalize()!==this.base.normalize())return this.pflog().tap({level:"warn",result:void 0,msg:"isDeleted(): uri isn't correct",meta:{uri:e,expectedBase:this.base,uriBase:e.pathBase}});let r=await this.parent().isDeleted(e.parent());return r==null?this.pflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{uri:e}}):this.pflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted, which means I am deleted.",meta:{parentDeleted:r,uri:e}})}async httpHeaders(){return{ETag:await this.etag(),"Last-Modified":await this.lastModifiedUtc()}}async hide(){let e=await(I?se("attrib",["+h",this.nativePath],{timeout:10*M}).catch(r=>r):re?se("chflags",["hidden",this.nativePath],{timeout:10*M}).catch(r=>r):"");if(P(e)){this.pflog().warn("hide("+this.nativePath+") failed: "+e);return}else return this.clear()}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}async mkNoMedia_(){if(await this.isFile())throw new Error("mkNoMedia(): "+this+" is a file.");await this.mkdirp_();let e=this.join(".NoMedia");await e.isNotDirectory()&&await e.isEmpty()&&(await e.writeTxt_(["This directory's contents are excluded from PhotoStructure libraries.","","See <https://photostructure.com/nomedia/> for details."].join(`
`)),Or(this.nativePath))}async mkNoMedia(){try{return await this.mkNoMedia_(),this}catch(e){this.pflog().warn("Could not add .NoMedia file to "+this,e);return}}hasNoMedia(){return Bn(this)}ignorableCheap(){return tu(this.nativePath)}async ignorable(){return await this.isDirectory()?xP(this):wP(this)}hidden(){return $f(this)}isSidecar(){return Km(this.ext)}async sidecar(){return Pt(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+ui(c.defaultSidecarType.valueOrDefault,".").toLowerCase()))}async jsonSidecars(){let e=await this.siblings(r=>at(r.ext,".json")&&(r.name===this.name||r.name===this.base||Kr(r.name)===Kr(this.name)));return this.pflog().tap({msg:"jsonSidecars()",result:e==null?void 0:await bm(e,r=>r.maxStatMs())})}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",async()=>{let e=await this.mtimeMs(),r=await this.sidecars(),i=await Promise.all(A(r).map(n=>n.mtimeMs())),o=[e,...i].filter(B);return Oe(o,n=>Math.floor(Math.max(...n)))})}thisOrSidecareMaxMtimeSec(){return b(this.thisOrSidecareMaxMtimeMs(),e=>$i(e))}};var U_=l(()=>d("ShowFileInFolder"));async function SP(t){if(await t.isEmpty())return!1;if(c.showFileInFolderUsesThunar.valueOrDefault&&Ue)return j_(t);if(_(c.showFileInFolderCommand.values)){let e=c.showFileInFolderUsesFileUri.valueOrDefault?t.fileuri():t.nativePath,r=[...c.showFileInFolderCommand.values,e],i=r.shift();return U_().info("Running",{cmd:i,args:r}),ru(i,r)}return Ue?q_(t):I?W_(t):re?H_(t):!1}function ru(t,e){return Ba(se(t,e,{timeout:15*M,ignoreStderr:!0,disconnect:!0}))}async function W_(t){return ru("explorer.exe",['/select,"'+t.nativePath+'"'])}async function q_(t){return ru("nautilus",["-s",t.fileuri()])}async function j_(t){return ru("dbus-send",["--type=method_call","--dest=org.xfce.Thunar","/org/xfce/FileManager org.xfce.FileManager.DisplayFolderAndSelect",`string:"${t.dir}"`,`string:"${t.base}"`,'string:""','string:""'])}async function H_(t){return ru("open",["-R",t.nativePath])}var Ig=class{constructor(e,r){this.name=e;this.server=r;this._ended=!1;Ux(this)}get ended(){return this._ended}end(){return this._ended=!0,Hc(this.server)}};var MP=T(require("os"));var Xf=l(()=>K(V(ae(ct((0,MP.networkInterfaces)())).map(t=>t.address))),E),G_=l(()=>d("ip")),K_=[/^(?:::ffff:)?127\.\d{1,3}.\d{1,3}.\d{1,3}$/i,/^::1$/];function hl(t){return G_().tap({msg:"isLocalhost",level:"info",result:S(t)?!1:Xf().includes(t)||Xf().includes(Ge(t,"::ffff:"))||K_.some(e=>e.exec(t)!=null),meta:{address:t}})}var EP=T(require("@iarna/toml"));var PP=`
Hello, and thank you for using PhotoStructure!

The files in this folder support your PhotoStructure Library, including

  * a database with the filepaths to your photos and movies
  * previews and thumbnails of your photos and movies
  * content metadata about these assets, like ratings and sharing information
  * albums that both you and PhotoStructure Curators have assembled

Moving or deleting any files here will cause problems using your library.

If you have any questions, please visit <https://photostructure.com/support/>.

Sincerely,

Your Friendly Neighborhood PhotoStructure, v${Ke}`;function At(t=c.libraryPath.value){return U(t,e=>oe.for(e).join(".photostructure"))}function iu(t=c.libraryPath.value){return U(t,e=>oe.for(e).join(c.originalsDir.valueOrDefault))}async function gl(t){let e=At(t);if(e==null)throw new Error("empty dataDir");if(await e.mkdirp()==null)throw new Error("Could not mkdirp "+e);await e.mkNoMedia();let r=e.join("README.txt");return await r.size()!==PP.length&&await r.writeTxt_(PP),e}var ou=d("SettingsIO"),DP="settings.toml";function nu(){return oe.for(xi()).join(DP)}function yl(t){return tt([t,c.libraryPath.value],e=>U(e,r=>f(At(r),i=>i.join(DP))))}async function J_(){L(c.scanMyPictures.value)&&(c.scanMyPictures.value=!1,c.scanPaths.push(await rl()))}async function bl(t=nu()){let e=await Ee(AP(t),()=>[]);return await J_(),pt.unset(),e}async function LP(){return FP(nu())}async function IP(t){return f(yl(t),e=>FP(e))}var pt=l(()=>Rg(),kr);C(()=>{q(()=>pt.unset()),c.libraryPath.addListener(()=>pt.unset())});function Rg(t){let e=yl(t);return ou.tap({msg:"_libraryHasSettings",result:x(e?.clear().existsSync(),!1),level:"info",meta:{libraryPath:t,settings:c.libraryPath.value,librarySettingsFile:e?.nativePath}})}var $_=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;async function FP(t){return b(t.firstMatchingLine($_),e=>e[1])}var RP={maxLineLen:78,prefix:"# "};async function OP(t,e){let r=await t.clear().isNonEmpty(),i=r?await t.wip():t;await Q_(i,e,t),ou.info("maybeWriteFile(): wrote settings",{dest:i,file:t,nonDefaults:e.filter(o=>o.hasValue()).map(o=>({name:o.name,value:o.value}))}),r&&(await Mt(ds(Zf(i),Zf(t)))&&(ou.info("Archiving prior, different contents",{dest:i,file:t}),await t.renameYMDHMS_("old")),await i.unwip_())}var Y_=l(()=>Ke);async function Q_(t,e,r){let i=x(await Zf(r),{}),o=ae(["","Hello!","",`These are ${e[0].categoryType} settings for PhotoStructure.`,""," - Please shut down PhotoStructure before editing this file.",""," - PhotoStructure has TWO settings files!",""," - Most settings have reasonable defaults, which are provided after the",'   description. Remove the "#" from the beginning of the line to override',"   the default.",""," - See <https://photostructure.com/getting-started/advanced-settings/>","   for more details","","Thanks for using PhotoStructure! Visit <https://photostructure.com/support> or email <support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+Y_()].map(s=>Eo(s,RP)));o.push("","");let n="";e.forEach(s=>{let a=`${Dc(s.categoryType)}.${s.category.toLowerCase()}`;a!==n&&(n=a,o.push("",ys("#",78),"#","# Settings for "+a+":","#","",""));let m="# +"+ys("-",s.name.length+4)+"+",u=Ze(y(y({env:s.key},Oe(s.opts.envAliases,D=>({"env aliases":D}))),s.addToJSON())).map(([D,W])=>`${D}: ${O(W)}`).join(", ");o.push(...Eo([m,"|  "+s.name+"  |",m,"",`${s.opts.description.replace(/\n/g,`

`)}`,`(${u})`,""].join(`
`),RP));let p=i[s.name],g={},v=s.valueToPersist(p);v!=null?(g[s.name]=v,o.push(...kP(g))):(g[s.name]=s.exampleValue,o.push(...kP(g).map(D=>"# "+D))),o.push("","")}),await t.writeTxt_(`
`+o.map(s=>s.trimRight()).join(`
`)+`

`),oT()}function kP(t){return ro(...Ze(t).map(([e,r])=>e+" = "+O(r,void 0,2)))}async function js(t=nu()){return OP(t,vS())}async function ep(t){return f(yl(t),e=>AP(e))}async function Hs(t){await gl(ga(t,c.libraryPath.value));let e=yl(t);return ou.warn("writeLibrarySettings("+e+")"),await f(e,r=>OP(r,SS())),pt.unset(),e}async function Zf(t){return b(t.readFile(),e=>ou.tap({msg:`read(${t})`,result:EP.default.parse(Kd(e.toString()))}))}async function AP(t){let e=d("SettingsIO.importFileSettings("+t.nativePath+")");try{let r=await Zf(t);if(r==null){if(await t.isNonEmpty())throw new Error("Failed to read "+t);return[]}let i=new Map(Ze(c).filter(([,n])=>n instanceof Qr&&!n.transient).map(([n,s])=>[n.toLowerCase(),s])),o=F(Ze(r).map(([n,s])=>{let a=i.get(h(n).toLowerCase());return a==null?e.warn("Failed to import (no setting with this name)",{key:n}):a.importFromFile(s),a}));return e.info("loaded",{tomlMap:r,imported:o.map(n=>et(n,"name","value","persist"))}),o}catch(r){e.error("Cannot read"+Jt(r));return}}var wue=l(()=>new Set([c.logLevel,c.httpPort,c.rpcPort,c.license].map(t=>t.key)));var X_=l(()=>{c.cacheDir.addListener(()=>Wo.unset())}),Wo=l(()=>{try{X_();let t=oe.for(c.cacheDir.valueOrDefault);return t.mkNoMedia_(),t}catch(t){throw X("Failed to set up cacheDir"+pe,t),t}},E);var XA=T(require("file-type")),ZA=T(require("fs-extra")),e0=T(require("path"));var zA=T(require("exiftool-vendored")),UA=T(require("path"));var Og=T(require("os"));async function kg(t){let e=I?"where":"which";try{let r=await Je(e,[t],{timeout:H,ignoreExitCode:!0,ignoreStderr:!0});return r.code===0&&P(r.result)?r.result.trim().split(`
`)[0]?.trim():void 0}catch{return}}async function _g(t){return t!=null&&await t.exists()?t.nativePath:void 0}async function tp(t,e){let r=f(dr.Tools(),o=>ie.for(o));if(Xt&&(r==null||await r.isNotDirectory()))throw new Error("Cannot find project path for tools"+pe);function i(o){return r?.join(xT+"-"+o,x(e,t),t+(I?".exe":""))}return er(()=>_g(i(Og.default.arch())),()=>Og.default.arch()==="x64"?_g(i("ia32")):void 0,()=>Z_(t))}async function Z_(t){return er(()=>kg(t),()=>_g(ie.for(dr.Bin())?.join(t)),()=>{throw new Error("Cannot find path for "+t)})}var _P=l(()=>tp("dcraw_emu","libraw")),NP=l(()=>tp("raw-identify","libraw")),Ng=l(()=>tp("jpegtran")),BP=l(()=>tp("sqlite3"));var rp=new ke(512);q(()=>rp.clear());pr(t=>t==null?rp.clear():rp.delete(t));var CP=l(()=>d("RawInfo"));async function ip(t){return rp.getOrSet(t.nativePath,async()=>{try{let e=await NP(),r=await se(e,["-s",t.nativePath],{timeout:Wa});return U(r,eN)}catch(e){CP().warn("raw-identify failed",{file:t.nativePath,error:ce(e)});return}})}function eN(t){let[e,r,i,o,n]=t.split("	");return CP().tap({msg:"parseRawInfoOutput()",result:ls(k(o),k(n),(s,a)=>({Filename:e,Make:r,Model:i,ImageSize:{width:s,height:a}})),meta:{input:t}})}var JD=T(require("os"));function tN(t,e,r=.5){return(1-r)*t+r*e}function su(t,e,r){let i=e.x-t.x,n=(r-t.x)/i;return tN(t.y,e.y,n)}function ir(t){return P(t)&&(t.startsWith("video/")||t==="application/mp4"||t==="application/ogg")}function wl(t){return f(t,e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(B))}function au(t){return ne(t)&&[0,90,180,270].includes(t)}function qo(t){let e=f(t,r=>Xe(r+Math.ceil(-r/360)*360));return au(e)?e:void 0}function VP(t){let e=qo(t);return e===90||e===270}function lo(t){return f(t,e=>Xi(()=>zP(e.Orientation),()=>zP(e.CameraOrientation),()=>qo(e.Rotation)))}var rN=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function zP(t){return f(t,e=>rN.get(e))}var iN=new Map([[0,1],[90,6],[180,3],[270,8]]);function oN(t){return f(t,e=>iN.get(e))}function UP(t,e){return f(qo(t),r=>ir(e)?{Rotation:r}:f(oN(r),i=>({"Orientation#":i})))}function WP(t){return t!=null&&B(t.width)&&B(t.height)}function Zr(t){return`${t.width} \xD7 ${t.height}`}function qP(t){return Kx(t.width*t.height)}function Bg(t){return{width:t.height,height:t.width}}function jP(t,e){return VP(e)?Bg(t):t}function HP(t){return t.width/t.height<1}function Cr(t){return Oc(t.width*t.height)}var nN=l(()=>d("SizeInfo"));function Cn(t,e,r){let i=tt([r?.ImageSize,{width:t.ImageWidth,height:t.ImageHeight}],s=>WP(s)?s:void 0);if(nN().debug("extractSizeInfo()",{filename:t.FileName,mimetype:t.MIMEType,rawInfo:r,fileDimensions:i}),i==null)return;let o=jP(i,e),n=Fe(o.width/o.height,5);return{ImageHeight:o.height,ImageWidth:o.width,aspectRatio:n,dimensions:o,rotation:e,fileDimensions:i}}var sN=E,aN=15*E,lN=10,mN={p0:{x:.8*qe,y:4*M},p1:{x:20*qe,y:12*M}},Cg={p0:{x:11*qe,y:12*M},p1:{x:26*qe,y:24*M}},GP={p0:{x:7*qe,y:45*M},p1:{x:32*qe,y:90*M}};function KP(t){return Gm(t.ext)?Math.max(x(we(t.durationMs,e=>e*lN),0),su(GP.p0,GP.p1,t.bytes)):0}function JP(t){return b(uN(t),e=>e.result)}function uN(t){return b(cN(t),fN)}function cN(t){return b(t.size(),async e=>({bytes:e,ext:t.ext,durationMs:Gm(t.ext)?await b(ot(t),r=>we(r.Duration,i=>i*M)):void 0}))}function $P(t){return su(Cg.p0,Cg.p1,Y(11*qe,100*qe,x(t,0)))}function fN(t){let e=Y(.5*qe,64*Sr,t.bytes),r=5*M,i=H,o=2*e*jc,n=v=>su(v.p0,v.p1,Y(.5*qe,50*qe,e)),s=n(mN),m=dg(t.ext)?.includes(Et.RawImage)===!0?n(Cg):0,u=KP(t),p=c.validateVideos.valueOrDefault?u:0;return{result:Y(sN,aN,Math.round(r+i+o+s+m+u+p)),dbMs:r,tagMs:i,copyMs:o,thumbMs:s,rawDecodeMs:m,transcodeMs:u,validateMs:p}}var op=new ke(256);C(()=>q(()=>op.clear()));C(()=>Oa((t,e)=>{op.getOrSet(t,()=>[]).push(e),op.getOrSet(e,()=>[]).push(t)}));function pN(t){return[t.toString(),...A(op.get(t.toString()))]}function QP(t,e,r){for(let o of pN(t)){let n=r.get(o);if(n!=null)return n}let i=e(t);return r.set(t.toString(),i),i}var np=Se("plus","lite");var dN=require("https");async function YP(t,e={}){return e.headers==null&&(e.headers={}),S(e.headers["user-agent"])&&(e.headers["user-agent"]=Tr+" v"+Ke),new Promise((r,i)=>{let o=dN.request(t.toString(),e);o.setTimeout(x(e.timeout,H),()=>{i(new me({message:"Timeout fetching <"+t+">",doNotSend:!0,retriable:!0}))}),o.on("response",n=>{let s=[];n.setEncoding("utf8"),n.on("data",a=>s.push(a)),n.on("end",()=>{r({ok:St(200,399,n.statusCode),headers:n.headers,body:s.join(""),statusCode:n.statusCode,statusMessage:n.statusMessage})})}).on("error",n=>{i(n)}),f(e.body,n=>o.write(n)),o.end()})}var XP=T(require("zlib"));var sfe=l(()=>JSON.parse(Zc("H4sIAAAAAAAAA6tWylWyUqrKyUxS0lEqADKTivJLcjJdUpPzcwuKUouLgyvzkoFSeUCptKL8XCCzDKQqsTjVzATISQRySvKDS4oy89KB3Bwgt7QkzUKpFgCQWYV5WQAAAA==")));function mo(t){return JSON.parse((0,XP.brotliDecompressSync)(Buffer.from(t,"base64")).toString("utf8"))}var Ug=T(require("os"));var ZP=T(require("fs/promises"));var hN=l(()=>d("ReadFile"));async function Vg(t){try{return await(0,ZP.readFile)(t)}catch(e){hN().info(".readFileMaybe("+t+")",e);return}}var zg=class{constructor(e,r,i){this.file=e;this.mkObject=r;this.onWrite=i;this.prior=l(()=>this.file.readJson("debug"))}async read(){let e=await this.prior();return d("JsonFileStore").debug("prior "+this.file,e),e??b(this.mkObject(),r=>this.write(r))}async write(e){try{return await this.file.writeJSON_(e,{spaces:2}),await this.prior.set(Promise.resolve(e)),d("JsonFileStore").info("wrote to "+this.file,e),this.onWrite!=null&&await this.onWrite(this.file,e),e}catch(r){throw new me({cause:r,message:"Failed to write to "+this.file})}}};function gN(){return tf.safeRandomUid(16,4)}var eE=class extends zg{constructor(e,r){super(e.join("."+r+"-uid.json"),()=>({uid:gN(),version:Ke,type:this.type,createdAt:Date.now()}),i=>i.hide());this.rootDir=e;this.type=r;this.read_=l(()=>he(this.read(),e=>e.uid,()=>"missing!").catch(e=>{throw new me({cause:e,fatal:!0,message:"Failed to read "+this.rootDir})}))}},sp=l(()=>f(At(),t=>new eE(t,"library")));C(()=>{q(()=>{sp.unset()}),c.libraryPath.addListener(()=>sp.unset())});var tE=T(require("os"));var yN=/^(?:[0:]+|[f:]+)$/i,rE=l(()=>K(ae(ct((0,tE.networkInterfaces)()).map(t=>A(t).map(e=>e.mac))).filter(t=>P(t)&&yN.exec(t)==null)));var bN=l(()=>mo("G7kAIIzUYs0Z7qRuS32pmsUk/UyD8OFBrsHUYemDqh3/zMuNBya1K0GYBazpDR8puUeR5pOPDwrAyLrH9L4GAhPQPWicizajRNayvHKU52siIpE9GddV7bjtHChhuc6wwPIkg/x4NH0P")),vi=Se("cu","lc","lm","mp","wm","li","cm","ma","vl");function iE(t){return te(K(t.filter(wN)),e=>[vi.indexOf(e.split(":")[0]),e])}function oE(t){return bN()[t]}var nE=15;async function uo(t,e){try{let r=h(await e);return S(r)||r.match(/^[\s0:_\/-]*$/)!=null?void 0:t+":"+Jr(r.trim(),nE,Pn)}catch(r){d("toUID").warn("failed",{pfx:t,err:r});return}}var xN=l(()=>new RegExp(`^(${vi.values.join("|")}):[0-9a-zA-Z]{${nE}}$`));function wN(t){return t!=null&&xN().exec(t)!=null}var jo=l(()=>mo("GwkBABwHdoyzjXCwzccdzUv9+g11VQzlNQjNotPVt0S2zHa8CLMs19auq91f4APvhhMIPZZ0m49e3qooFMQq6ej4jJBRUbv5BmSQzUeTCzW5mdaimgkX4ZqrHjPAjQ8XSSsp+cYQ79EXELnYMzlJwyYHVTq/nMkq900q5+mx2ayLgl3s6O7FgGooQh++7vpBI+Qpw3dCNqYDIfr6zPvUur259BmFMDQjV/hviADXURsBk2HJBesB")),ap=l(()=>d(jo().n));async function TN(){return uo(vi.li,await sp()?.read_())}function vN(){return uo(vi.cm,(0,Ug.cpus)()[0].model)}function SN(){return rE().map(t=>uo(vi.ma,t))}async function MN(){return A(await Dt()).map(t=>uo(vi.vl,t.uuid))}async function PN(){let t=await se(jo().c,["-1"],{timeout:5*M});return ap().tap({msg:jo().c,result:t.match(/serial.*=\s*([a-z0-9-]{12,})/i)?.[1]})}async function EN(){try{return U(await PN(),t=>uo(vi.lc,t+":"+(0,Ug.cpus)()[0].model))}catch(t){ap().info(jo().c+" failed",t);return}}async function AN(){try{let t=await DN();return uo(vi.mp,t)}catch(t){ap().info("ioreg failed",t);return}}async function DN(){return(await se(jo().i,jo().ia,{timeout:5*M})).match(/uuid" = "([a-z0-9-]{12,})"/i)?.[1]}async function FN(){return(await Te.instance().executeJson(jo().w))?.MachineGuid}async function LN(){let t=await FN();return uo(vi.wm,t)}var IN=l(async()=>de()?[]:Ue?[uo(vi.lm,Vg(jo().lv)),uo(vi.lm,Vg(jo().le)),EN()]:re?[AN()]:I?[LN()]:[]);async function xl(){let t=await Promise.all([TN,vN,MN,SN,IN].map(async e=>{try{return await xe(e(),5*M)}catch(r){return ap().warn(r)}}));return iE(K(await ym(t)))}var Tl=class{constructor(e,r,i,o){this.s=e;this._l=r;this._sids=i;this.meta={src:o}}get l(){return this._l}get ok(){if(this._l==null)return!1;let e=Wd(this._sids,this._l.uids),r=K(e.map(s=>s.split(":")[0])),i=F(r.map(s=>oE(s))),o=i.length>=this._l.mat,n=St(this._l.iat?.getTime(),this._l.exp?.getTime()+xt,Date.now());return this.meta[De().o]=n,this.meta[De().u]=o,this.meta[De().m]=i,n&&o}cmpVal(){return[this.ok,-np.indexOf(this.l?.[De().T]),this.l?.exp?.getTime()??1,this.meta.matchedSchemes]}cmp(e){return Vt(this.cmpVal(),e.cmpVal())}};var lp=l(()=>d("writeLicense"));async function mp(t){let e=await Wg(t,"candidate");if(e==null)return lp().error("!ok",t);await sE(e,At()?.join(De().d)),await sE(e,ie.for(xi()).join(De().d)),vl.unset()}async function RN(t){return(await le(t.childFiles(),async e=>Wg((await e.readFile())?.toString().trim(),e.nativePath))).filter(e=>e.ok&&e instanceof Tl)}async function sE(t,e){if(e==null)return;if((await RN(e)).some(i=>i.cmp(t)>=0)){lp().info("saveIfBetter(): no-op for "+e);return}else{let i=e.join(Jr(t.s)+".txt");return await i.writeFile_(t.s).then(()=>(lp().info("saveIfBetter(): wrote to "+i),i)).catch(o=>{lp().error("saveIfBetter(): failed to save license to "+e,o)})}}var Ho=l(()=>d(co().l)),co=l(()=>mo("G9YAwIzTFfOihHWPgG6m/h0h65IqCersIGkdlq6+6ra6+PjQ8mHlRTkDg6UJJqPJEIU6WaIUNodfF2xPB7iLWJDlIN8z6xhOKyn4qqHpZlh6qCZUoQghd4BVMkz3A0IIevFn+7UO7uM+VGJb/MeZXfHngpQWZzk=")),aE=l(async()=>{let t=co().s+": ";try{if(!c[co().s].valueOrDefault)return Ho().debug(t+"no-op (settings disabled)");let e=(await vl()).filter(n=>n.l!=null&&P(n.s)),r=new Date,i=e.find(n=>n.ok&&r<n.l.exp);if(i!=null)return Ho().debug(t+"no-op: ",i);let o=await ie.for(xi()).join(co().s).mkdirp_();for(let n of e){if(S(n.s)||n.l==null||r<n.l.exp)continue;let s=n.l.uids.find(a=>a.startsWith("cu:"));if(s==null){Ho().debug(t+"skipping (no cu)",n);continue}await o.join(En(n.s,14)+".txt").applyIfEmpty_(async a=>{await ON(s),await a.writeJSON_({l:n.l,at:Date.now()}),Ho().warn(t+"requested",n)})}}catch(e){Ho().warn(t+"failed",e)}},15*E);async function ON(t){try{let e=await xl();if(R(e))return Ho().warn("no-op: empty sids");let r=O({uids:[...e,t]}),i=y(y({},co().r),{body:r}),o=await YP(co().u,i);Ho().info(co().u,{req:i,response:o}),o.ok?await mp(JSON.parse(o.body)?.[co().a]):Ho().warn(co().u,{req:i,response:o})}catch(e){Ho().warn(co().u,e)}}var dD=T(pD());var Ml=l(()=>mo("G9AAICwK7KZhK2gx/dEjjDHuEVVxShG2PVDGAcBqBqP3binicrOwzdRXMfMKd00dlj6bnSYcBaK1S8KWhAGGv73Zu73eMMKnXGoKt4NsAefjf3tdIWcHCM4FdbL+J+haq7GA2/ps1jHled6Oe+3j+k+BBQbgzzJmnLDvnTnXr11NbkL3X+vvWdyYILH9urnb+EV39HOm4Y5Hcrfqyt5i5iCfpGaVUqOnNfYDdeWC8wV2OWE=")),kde=l(()=>{try{return require(Ml().c)[Ml().m](Ml().o)}catch(t){X(Ml().m+pe,t)}});function hD(t){return dD.V2[Ml().w](t,Ml().o)}var De=l(()=>mo("GwwBABwHdkzj5qg5WDnubFuq7NaxSKjiobwK4iGSLDp98J87fqD679bWgnaVtCVBQAEFBJm7aiN4y7puJw8PPz+CHDoAhk5Fd0AhTjKYPbo8F5freFUJHhQHc2xp4qfyoqKKAmGb7IkFZwkajH7uJCR829lmguhEXw/iusqUQE4nk7LeJyad4wmdptoVln0otnUOO3UHnEyjrxtXUr7B")),gD=l(()=>d(De().l));async function v1(t){let e=await hD(ui(h(t).trim(),De().p)),r=xg(e[De().i]);if(r==null)throw new Error("bad "+De().i+": "+e[De().i]+" ("+t+")");let i=xg(e[De().r]);if(i==null)throw new Error("bad "+De().r+": "+e[De().r]+" ("+t+")");return e[De().a]=e[De().a]>=0?e[De().a]:2,e[De().i]=new Date(r),e[De().r]=new Date(i),e[De().b]=h(e.uids).split(","),e}async function ey(t,e){try{return new Tl(t,await v1(t),await xl(),e)}catch(r){return gD().tap({msg:De().v,result:{s:t,ok:!1,meta:{err:r}}})}}async function Wg(t,e){if(S(t))return;let r=await ey(t,e);return L(r?.ok)&&r instanceof Tl?r:void 0}var vl=l(async()=>{let t=F([At()?.join(De().d),ie.for(xi()).join(De().d)]),e=ae(await Va(t,o=>o.childFiles())),r=ae(await Va(e,async o=>U(A(await o.readLines()).map(n=>n.trim()).join(""),n=>ey(n,o.nativePath))));await U(c[De().L].value,async o=>r.push(await ey(o,"Settings")));let i=S1(r);return C(aE),gD().tap({msg:De().d+"()",result:i})});async function S1(t){return te(t,e=>[!e.ok,np.indexOf(e.l?.[De().T]),-(e.l?.exp?.getTime()??1)])}C(()=>vl[De().n]=()=>null);function fo(){return b(vl(),t=>t[0]?.ok?t[0]:void 0)}async function Js(){return Pt(fo()).flatMap(t=>t.l?.[De().T]).getOrElse(()=>De().f)}async function Pl(){try{return await Js()===De().f}catch{return!0}}var M1=I?"NUL":"/dev/null",P1=l(()=>d("jpegtran"));async function yD(t){let e=await Ng();try{await Je(e,["-outfile",M1,t.nativePath],{timeout:30*M,isIgnorableError:cu})}catch(r){throw new me({cause:r,doNotSend:!0,fatal:!1,retriable:!1})}}async function bD(t,e){let r=t.wip();P1().info("rotateInPlace("+t+")",e),await E1(t,r,e),await r.unwip_(),Or(t.nativePath)}async function E1(t,e,r){let i=await Ng();if(!au(r))throw new Error("refusing to rotate("+t+", "+r+")");await se(i,["-copy","all","-trim","-rotate",r.toFixed(0),"-outfile",e.nativePath,t.nativePath],{timeout:E})}var D1=/^\(?Binary data (\d+).*use -b option to extract\)?$/i,hp=class{constructor(e){this.binaryDataBytes=e}};function wD(t){if(typeof t!="string")return;let e=t.match(D1);return e==null?void 0:new hp(k(e[1],{defaultValue:0}))}function xD(t){return h(t).includes(" Chrome/")}function TD(t){return h(t).includes(" Firefox/")}var A1=["image/gif","image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"];function gp(t){return A1.includes(h(t).toLowerCase())}var F1=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);function Wn(t){return F1.has(h(t).toLowerCase())}var L1=["image/gif","image/jpeg","image/pjpeg","image/png","image/webp"],I1=["image/gif","image/jpeg","image/png"];function vD(t,e){return(xD(e)||TD(e)?L1:I1).includes(h(t))}function yp(t,e){return rm(t.width,e.width)&&rm(t.height,e.height)}function SD(t,e){return as(t.width,e.width)&&as(t.height,e.height)}function zi(t){return b(El(t.nativePath),e=>({width:e.ImageWidth,height:e.ImageHeight}))}var MD=l(()=>d("HeifConvert"));C(()=>q(()=>bp.unset()));var bp=l(async()=>kg(c.heifConvertPath.valueOrDefault));async function R1(){let t=await bp();return MD().tap({msg:"isHeifConvertSupported()",result:P(t),meta:{heifConvertPath:t}})}async function PD(t){if(!!await R1())return b(Vi(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await Je(c.heifConvertPath.valueOrDefault,["-q",String(c.jpegQuality.valueOrDefault),t.nativePath,r.nativePath],{timeout:H})}catch(i){MD().warn("heif2jpeg(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var ED=l(()=>d("sips")),DD=l(async()=>{try{return await se("command",["-v","sips"],{timeout:kr})}catch(t){let e=ie.for("/usr/bin/sips");if(await e.isExecutable())return e.nativePath;ED().info("sips is missing from $PATH",t);return}});async function AD(t){return b(Vi(t,"heif",".jpeg"),e=>e.applyIfEmpty_(async r=>{try{await Je("sips",["-s","format","jpeg","-s","formatOptions",String(c.jpegQuality.valueOrDefault),t.nativePath,"--out",r.nativePath],{timeout:H})}catch(i){ED().warn("sips(): failed to convert "+t+" to "+r.nativePath+": "+i);return}}))}var O1=l(()=>d("Heif")),wp=l(async()=>{try{if(re)try{let e=await DD();if(!S(e))return{ok:!0,msg:e}}catch(e){O1().error("Failed to find the sips tool (either in PATH or /usr/bin).",e)}let t=await bp();return{ok:P(t),msg:Rr(t,c.heifConvertPath.valueOrDefault+": not installed")}}catch(t){return{ok:!1,msg:yi(t)}}});async function xp(){return(await wp()).ok}C(()=>q(()=>wp.unset()));var k1=/^image\/hei[fc]$/i;function $s(t){return k1.exec(h(t))!=null}async function FD(t,e,r,i=1e3){let o=await je(()=>_(t.listeners(e)),{timeoutMs:i});return o&&t.emit(e,r),o}var ID=T(require("util"));function LD(t,e){let r=t.width/t.height,i=e.width/e.height;if(r>=i){let o=Math.min(e.width,t.width);return{width:o,height:Math.ceil(o/r)}}else{let o=Math.min(e.height,t.height);return{width:Math.ceil(e.height*r),height:o}}}var Nt=Se("fit","sq");var _1=Se("cover","contain","fill","inside","outside"),qn;(function(o){let t=l(()=>d("Reducers.Square"));o.name=Nt.sq,o.fit="cover";function i(n,s){let a=SD(n,s)?y(y({},n),{fit:_1.cover}):void 0;return t().tap({msg:"reduce()",result:a,meta:{max:n,input:s}})}o.reduce=i})(qn||(qn={}));var ei;(function(o){let t=l(()=>d("Reducers.Fit"));o.name=Nt.fit,o.fit="inside";function i(n,s){if(yp(s,n)){t().trace(`reduce(): input ${Zr(s)} is too small for ${Zr(n)}`);return}return LD(s,n)}o.reduce=i})(ei||(ei={}));var Wge=require("sharp"),gr=class{constructor(e,r,i,o,n=!0){this.name=e;this.maxWidth=r;this.maxHeight=i;this.reducer=o;this.rotational=n;this.megapixels=l(()=>Oc(this.maxWidth*this.maxHeight));this.max={width:r,height:i},gr._Sizes.push(this)}static sq(){return this._Sizes.filter(e=>e.reducer===qn)}static largestSq(){return st(this.sq(),e=>e.megapixels())}static fit(){let e=c.previewResolutions.valueOrDefault;return this._Sizes.filter(r=>r.reducer===ei&&e.includes(r.name))}static largestFit(){return st(this.fit(),e=>e.megapixels())}[ID.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"\xD7"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&HP(e)?Bg(this.max):this.max,e)}resize(e,r){return r=r.resize(y(y({},e),{fit:this.reducer.fit,withoutEnlargement:!0})),r}toJpeg({path:e,sh:r,outputSize:i}){return(Cr(i)<2||c.sharpen.valueOrDefault)&&(r=r.sharpen()),r.jpeg({quality:c.jpegQuality.valueOrDefault,progressive:c.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}},$e=gr;$e._Sizes=[],$e.UHD8k=new gr("uhd8k",7680,4320,ei,!1),$e.UHD5k=new gr("uhd5k",5120,2880,ei,!1),$e.UHD=new gr("uhd4k",4096,2160,ei),$e.QHD=new gr("qhd",3120,1440,ei),$e.FHD=new gr("fhd",1920,1080,ei),$e.HD=new gr("hd",1280,720,ei),$e.WVGA=new gr("wvga",720,480,ei),$e.QVGA=new gr("qvga",320,240,ei),$e.QQVGA=new gr("qqvga",160,120,ei),$e.S480=new gr("s480",480,480,qn),$e.S240=new gr("s240",240,240,qn),$e.S120=new gr("s120",120,120,qn),$e.S60=new gr("s60",60,60,qn);var Tp=d("libraw");var N1=["-T"],B1=["-Z","-"],C1=["-o","1"],V1=["-t","0","-j"];async function RD(t){let e=Date.now(),r=await zi(t);if(r==null)return Tp.throw("Cannot decode RAW "+t+": no EXIF dimensions."+Gr+$t);let i=$e.largestFit().outputSize(r),o=[];i!=null&&4*Cr(i)<Cr(r)&&(Tp.debug("Large original source: using -h"),o.push("-h"));let n=await _P(),s=[...N1,...B1,...C1,...o,...V1,...c.dcrawEmuArgs.values,t.nativePath],a=5*E,m={encoding:"buffer",timeout:a,maxBuffer:250*qe};Tp.debug("dcraw_emu()",{cmd:n,args:s,opts:m});let u=await In(n,s,a,m),p=async D=>{await FD(u.stdout,"error","Problem from "+t+": "+KT(D,t.nativePath))||Tp.error("No listeners for error when reading "+t,D),u.kill("SIGINT")};u.on("error",p),u.stderr.on("data",p);let g=$P(await t.size())/7,v=new As({path:t.nativePath,op:"Converting raw image"},g,()=>Date.now()-e);return u.on("close",()=>v.end()),u.stdout}var ty=require("sharp"),Qs=d("SharpReadable");async function U1(t,e,r,i){let o=e?.[r];if(!(o instanceof hp))return;let n=i.width*i.height*.1;if(o.binaryDataBytes==null||o.binaryDataBytes<n){Qs.debug("imgFromExif(): rejecting (too small) "+r,{minBytes:n,val:o});return}let s=await z1(t,r),a=await f(s,zi);return Qs.tap({msg:"imgFromExif()",meta:{src:t.baseWithGrandparent,tag:r,dim:a,minDim:i},result:a!=null&&yp(i,a)?s:void 0})}var W1=l(()=>{ty.simd(c.enableSIMD.valueOrDefault),ty.cache(c.enableVipsCache.valueOrDefault),ty.concurrency(dm())});function jn(t,e,r=!1){return rt(`img.sharpReadable${t.ext.toUpperCase()}`,()=>q1(t,e,r))}async function q1(t,e,r=!1){W1();let o=await ot(t,!r),n=o?.MIMEType;if(o==null||S(n))throw new Error(t+" is not supported (missing mimetype)");if($s(n)&&!await xp()){Qs.warn("sharpReadable(): HEIF file, but heif support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}if(ir(n)&&!await du()){Qs.warn("sharpReadable(): video file, but video support is missing",{src:t.nativePath,mimetype:n,minDim:e});return}let s=[],a=lo(o),m=Cn(o,a,Wn(n)?await ip(t):void 0);if(m!=null){let g=x(e,{width:m.dimensions.width*.95,height:m.dimensions.height*.95});if(Cr(g)>15&&(r||a==null||a===0)&&!ir(n)){let D=c.embeddedPreviews.valueOrDefault;e!=null&&Cr(e)<1&&D.unshift(...c.embeddedThumbnails.values),s.push(...D.map(W=>()=>U1(t,o,W,g)))}}$s(n)&&(re&&s.push(()=>AD(t)),s.push(()=>PD(t))),gp(n)&&s.push(async()=>t),m!=null&&Wn(n)&&s.push(()=>(Qs.info("sharpReadable() -> dcraw()",{src:t.nativePath,minDim:e}),kD({src:t,desc:"dcraw",suffix:".tiff",f:()=>RD(t)}))),n.startsWith("video/")&&s.push(()=>gi(()=>pu(t,n),{maxRetries:1}));let u=[],p=await yT(s,g=>{Qs.warn("strategy failed for "+t+": "+g),u.push(g)});if(p==null)throw x(u[0],new Error("Cannot read "+t+" ("+n+")"));return p}function z1(t,e){let r=e.toLowerCase().endsWith("tiff")?".tiff":".jpg";return b(Vi(t,e,r),i=>i.applyIfEmpty_(async o=>{try{return await OD(e,t.nativePath,o.nativePath)}catch(n){Qs.warn("Failed to extract embedded "+e+" from "+t.nativePath+": "+n);return}}))}var j1=require("sharp"),ry=l(()=>d("ValidFile")),vp=l(()=>new ke(1024,E));C(()=>q(()=>vp.prior()?.clear()));C(()=>pr(t=>z(t).forEach(e=>{vp.prior()?.delete(e)}).orElse(()=>{vp.prior()?.clear()})));var H1=l(()=>Av(c.validationErrorBlocklist.values,"i"));function cu(t){return ry().tap({msg:"isIgnorableValidationError",result:H1().exec(ce(t))==null})}async function ND(t){if(await Pl()||!c.validateJpegImages.valueOrDefault&&!c.validateVideos.valueOrDefault){ry().debug("no validation for "+t,{validateJpegImages:c.validateJpegImages.valueOrDefault,validateVideos:c.validateVideos.valueOrDefault});return}return QP(t,G1,vp())}async function G1(t){let e=oe.for(t);try{let r=await Gs(e);if(r==null)throw new Error("Cannot validate, no mimetype");if(ir(r))c.validateVideos.valueOrDefault&&(ry().debug("validating "+e),await _D(e,r));else if(r.startsWith("image/")){if(r==="image/jpeg"){if(c.validateJpegImages.valueOrDefault)return await yD(e)}else if(c.validateRawImages.valueOrDefault){let i=await jn(e);if(i==null)throw new Error("Cannot read");await j1(i.nativePath,{failOnError:!0}).tiff().toBuffer()}}else throw new Error("Unsupported mimetype, "+r)}catch(r){throw new me({cause:r,message:"invalid file "+e,retriable:!1,doNotSend:!0,ignorable:!0})}}var BD=l(()=>d("ffmpeg")),K1=l(()=>Y(1,8,Xe(yt()/2))),J1=/ffmpeg version (\S+)/i,hu=l(async()=>{try{let t=await Je(c.ffmpegPath.valueOrDefault,["-version"],{timeout:H,ignoreStderr:!0,isIgnorableError:()=>!0}),e=J1.exec(t.result)?.[1];return BD().info("ffmpegVersion",{version:e,code:t.code,stdout:t.result.split(`
`,1)[0]}),t.code===0&&P(e)?e:void 0}catch(t){return}}),CD=l(()=>he(hu(),t=>"version "+t,()=>"(not found)"));C(()=>q(()=>hu.unset()));async function VD(){return Ee(hu.prior(),()=>hu.refresh())}async function Sp(){return await hu()!=null}async function zD(t){return await t.dest.exists()&&await t.dest.isEmpty()&&await t.dest.unlink(),Je(c.ffmpegPath.valueOrDefault,F(["-loglevel","error","-i",t.src.nativePath,...Aa(t.startAtSec,e=>["-ss",e.toFixed(1)])??[],"-vframes","1","-f","singlejpeg","-y",t.dest.nativePath]),{timeout:E,isIgnorableError:cu})}async function UD(t){return BD().tap({msg:"ffmpegValidVideo",meta:{src:t.nativePath},result:await Je(c.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",h(K1()),"-i",t.nativePath,"-f","null","-"],{timeout:x(await JP(t),2*E),isIgnorableError:cu,ignoreExitCode:!0,quiet:!1})})}var WD=T(require("path"));var Dl=l(()=>d("vlc"));function qD(){return he(Al().catch(()=>{}),t=>"version "+t.version,()=>"(not found)")}var $1=/VLC (?:version|media player) ([0-9.]+)/i,jD=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"],Al=l(()=>Q1());C(()=>q(()=>Al.unset()));async function HD(){return Ee(Al.prior(),()=>Al.refresh())}async function GD(){return!ph&&await he(Al(),t=>t.version!=null,()=>!1)}function Y1(){return b(Al(),t=>t.version==null?void 0:t.path)}async function X1(t){return b(Je(t,[...jD,"--version"],{timeout:H,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),e=>z(e.result).filter(P).map(r=>r.trim()).flatMap(r=>$1.exec(r)).flatMap(r=>r[1]).get())}function Z1(t){return b(Te.instance().execute(`(Get-Item -path ${Is(t)}).VersionInfo.FileVersion`,e=>e).catch(e=>{Dl().warn("Failed to run vlcInfoWin: "+t+": "+e)}),e=>da(e.trim()))}async function Q1(){let t=[];function e(...r){t.push(oe.for((0,WD.join)(...r)))}if((!I||c.vlcPath.hasValue())&&t.push(c.vlcPath.valueOrDefault),re){let r="/Applications/VLC.app/Contents/MacOS/VLC";U(Ve("HOME"),i=>e(i+r)),e(r)}if(I){let r=["VideoLAN","VLC","vlc.exe"];U(Ve("LOCALAPPDATA"),i=>{e(i,"Apps",...r)}),U(Ve("ProgramFiles"),i=>{e(i,...r)}),U(Ve("ProgramFiles(x86)"),i=>{e(i,...r)})}for(let r of t)try{if(r instanceof oe&&await r.clear().notExists())continue;let i=r.toString(),o=await(I?Z1(i):X1(i));if(S(o)){Dl().info("vlcInfo(): no VLC version found for "+r);continue}else return nt({path:i,version:o},n=>Dl().info("vlcInfo()",n))}catch(i){Dl().warn("vlcInfo(): err:"+i,{path:r})}}async function KD(t){let e=await Y1();if(S(e))return Dl().throw("vlcFrame(): empty vlcPath",y(y({},t),{ignorable:!0}));let r=Ge(t.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(r))return Dl().throw("vlcFrame(): Invalid destination extension"+$t,{format:r,args:t});let i=t.startAtSec??0,o=i+1,n=await Je(e,F([...jD,"--avcodec-hw=none","--video-filter=scene","--scene-format="+r,"--scene-replace","--scene-ratio=500","--scene-path="+t.dest.dir,"--scene-prefix="+t.dest.name,"--start-time="+i.toFixed(1),"--stop-time="+o.toFixed(1),t.src.nativePath,"vlc://quit"]),{timeout:E,ignoreStderr:!0});if(t.dest.clear(),B(n.code))throw new Error("vlc failed: "+O(n));return n}var Iwe=l(async()=>(0,JD.totalmem)()>16*cm&&yt()>5&&await Sp()?2:1);async function gu(t){return await er(()=>L(t?.ignoreffmpeg)&&!Tt?void 0:b(VD(),e=>({ok:!0,msg:"FFmpeg "+e})),()=>L(t?.ignorevlc)?void 0:b(HD(),e=>({ok:!0,msg:"VLC "+e.version})),()=>({ok:!1,msg:"(no video tools were found)"}))}var du=l(async()=>(await gu()).ok);C(()=>q(()=>du.unset()));async function pu(t,e,r){if(!ir(e))return;let i=L(r?.useVlc)?!1:L(await Ee(r?.useFfmpeg,()=>Sp())),o=!i&&L(await Ee(r?.useVlc,()=>GD()));if(!i&&!o)return;let n=d("img/Video.extractVideoFrame("+t+")"),s=await Vi(t,"frame",".jpg");n.debug("extractVideoFrame",{dest:s.nativePath,mimetype:e});let a=await t.mtimeMs();if(a==null)return n.throw("null mtime");let m=await ot(t);if(m==null)return n.throw("no tags");let u=lo(m);n.debug("video orientation:"+u);let p=Cn(m,u)?.dimensions,g=await s.stat(),v=g==null?void 0:await zi(s);if(g!=null&&g.mtimeMs>a&&v!=null&&(p==null||v.height===p.height&&v.width===p.width))return n.debug("prior dest, "+s+" seems reasonable",{srcDim:p,destDim:v}),s;let D=wl(m),W=Math.min(D??0,c.videoFrameAtSec.valueOrDefault);return n.info("extracted metadata",{startAtSec:W,duration:D}),await s.applyWip(async Ae=>{let sr=y({src:t,dest:Ae,startAtSec:W},p);await(i?zD(sr):KD(sr)),await $D(Ae),o&&u!=null&&u!==0&&(n.info("rotating in place..."+Ae,{rot:u}),await bD(Ae,u))}),s}async function _D(t,e){let r=d("img/Video.validVideo("+t+")");if(await pu(t,e)==null&&r.throw("Could not extract a video frame"),await Sp())return UD(t)}var DA=T(require("luxon"));var Ft=T(require("exiftool-vendored")),dt=T(require("luxon"));var QD=T(require("luxon"));var iy=14,eC=l(()=>QD.DateTime.local().offset,Ot);function YD(t){return t==null||Math.abs(t)>iy*60?!1:t===0?eC()===0:!0}var oy=T(require("exiftool-vendored"));var tC=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/,zr=class{constructor(e,r,i,o=0,n=1){this.start=e;this.middle=r;this.end=i;this.index=o;this.splits=n;this.toISOString=this.toString.bind(this);this.year=Jo(this.middle),this.month=Ko(this.middle),this.day=Go(this.middle)}static fromISO(e){e=h(e).trim();let r=tC.exec(e);if(r==null)return;let i=oy.ExifDateTime.fromISO(r[1]),o=oy.ExifDateTime.fromISO(r[2]),n=k(r[3]),s=k(r[4]);return this.for(i,o,n,s)}static for(e,r,i=0,o=1){if(!Dr(e)||!Dr(r))return;let n=po(e),s=po(r);if(n==null||s==null)return;o=Y(1,1e3,k(o,{defaultValue:1})),i=Y(0,o-1,k(i,{defaultValue:0}));let a=f(n.toDateTime().until(s.toDateTime()).divideEqually(o+1)[i],m=>m.end);if(a!=null)return new zr(n,po(a,x(n.zone,s.zone)),s,i,o)}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return x(this.start.zone,this.end.zone)}get hasTimes(){return Vr(this.start)&&Vr(this.end)}toString(e=!0){return`${yu(this.start,e)}/${yu(this.end,e)}`+(this.index===0&&this.splits===1?"":`/${this.index}/${this.splits}`)}includes(e){if(e==null)return!1;let r=po(e);return r!=null?this.interval().contains(r.toDateTime()):this.year===Jo(e)&&this.month===Ko(e)&&this.day===Go(e)}};function Mp(t,e=2){return t==null?"":cr(t,e,"0")}function Dr(t){if(t==null||typeof t=="string"||t===0)return!1;let e=Si(t);return e==null||e===0||!XD(Jo(t),Ko(t),Go(t))?!1:Vr(t)?$(rC(t),r=>r.isValid,()=>!1):!0}function Fl(t,e){return Dr(t)?e(t):void 0}var ZD=l(()=>c.minValidYear.valueOrDefault,Ot),ny=l(()=>new Date(Date.now()+xt).getFullYear(),Ot),eA=l(()=>new Date(Date.now()+xt).getMonth()+1,Ot);C(()=>q(()=>{ZD.unset(),ny.unset(),eA.unset()}));function iC(t){return St(ZD(),ny(),t)}function oC(t,e){return ji(e,ny())&&Zl(t,eA())?!1:St(1,12,t)}function nC(t,e,r){return r!=null&&dt.DateTime.fromObject({year:t,month:e,day:r}).isValid}function XD(t,e,r){return iC(t)&&(e==null||oC(e,t)&&(r==null||nC(t,e,r)))}var Hn=class{constructor(e,r,i){this.year=e;this.month=r;this.day=i}static for(e,r,i){return XD(e,r,i)?new Hn(e,r,i):void 0}static localToday(){return sy(new Date)}toString(){return F([this.year,this.month,this.day]).map(e=>Mp(e)).join("-")}toISOString(){return this.toString()}toDateTime(){return dt.DateTime.fromObject(this)}},tA=class{constructor(e,r,i,o,n){this.monthsToMonth=e;this.re=r;this.yearIndex=i;this.monthIndex=o;this.dayIndex=n}apply(e){let r=this.re.exec(e);if(r!=null){let i=parseInt(r[this.yearIndex],10),o=this.month(r),n=this.dayIndex==null?void 0:parseInt(r[this.dayIndex],10);return Hn.for(i,o,n)}else return}month(e){if(this.monthIndex==null)return;let r=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(r)?this.monthsToMonth.get(r):k(r)}},$o="((?:19|20)[0-9]{2})",rA="(1[0-2]|0[1-9])",sC="(1[0-2]|0?[1-9])",iA="([1-3][0-9]|0[1-9])",Pp="([1-3][0-9]|0?[1-9])",aC="(1[0-9]|2[0-3]|0[0-9])",oA="([0-5][0-9])",lC=oA,mC=oA,Ep="([-\\.\\,:_/ |])",Dp=Ep+"?",uC="(?:(\\.[0-9]+))?",nA="(?:(Z|UTC)|(?:([+-])([01][0-9]):?([0-5][0-9])))",cC=new RegExp("\\d\\d\\s*"+nA,"i");function ay(t){return f(cC.exec(t),e=>sA(e.slice(1)))}function sA(t,e){if(R(t))return e;let[r,i]=t.splice(0,2),[o,n]=t.splice(0,2).map(s=>k(s));return hn(["z","utc"],r)?0:nx([i,o,n])?e:(i==="-"?-1:1)*(o*60+n)}function ly(t){return U(t,e=>Nx([()=>Ft.ExifDateTime.fromEXIF(e),()=>fC(e)],r=>Dr(r)))}var pC=l(()=>d("FuzzyDate"));function aA(t,e=!1){if(!S(t))for(let{desc:r,f:i}of[{desc:"DateInterval.fromISO",f:()=>zr.fromISO(t)},{desc:"parseDateTime",f:()=>ly(t)},{desc:"DateTime.fromFormat(macOS)",f:()=>dt.DateTime.fromFormat(t,"y-M-d 'at' H.m.s")},{desc:"DateTime.fromFormat(gnome)",f:()=>dt.DateTime.fromFormat(t,"y-M-d H-m-s")},{desc:"DateTime.fromFormat(yMMdd_HHmmss)",f:()=>dt.DateTime.fromFormat(t,"yMMdd_HHmmss")},{desc:"ExifDate.fromEXIF",f:()=>Ft.ExifDate.fromEXIF(t)},{desc:"fuzzyDate.parseYMD",f:()=>Ll().parseYMD(t)},{desc:"new Date()",f:()=>e?new Date(t):void 0}]){let o=i();if(Dr(o)){let n=ay(t);return n!=null&&(o.tzoffsetMinutes=n),pC().tap({msg:"parseDated()",result:o,meta:{s:t,desc:r,tzoffsetMinutes:n}})}}}var lA=class{constructor(e){this.locale=e;this.monthsToMonth=new Map;this.ymdPatterns=[];this.ymPatterns=[];this.yPatterns=[];this.setup()}parseYMD(e){return tt(this.ymdPatterns,r=>r.apply(e))}addParser(e,r,i,o){let n=new tA(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),r,i,o);o!=null&&i!=null?this.ymdPatterns.push(n):c.fuzzyYearParsing.valueOrDefault&&o==null&&i!=null?this.ymPatterns.push(n):c.fuzzyYearParsing.valueOrDefault&&o==null&&i==null&&this.yPatterns.push(n)}setup(){let e=["short","long"];for(let i of K([this.locale,"en-US"]))for(let o of e){let n=new Intl.DateTimeFormat(i,{month:o});ye(12,s=>{let a=n.format(new Date(2017,s));this.monthsToMonth.set(a.toLowerCase(),s+1)})}let r="("+xr([...this.monthsToMonth.keys()]).join("|")+")";this.addParser($o+Ep+sC+"\\2"+Pp,1,3,4),this.addParser($o+Dp+rA+"\\2"+iA,1,3,4),this.addParser($o+Dp+r+"\\2"+Pp,1,3,4),this.addParser(r+Dp+Pp+",?\\2"+$o,4,1,3),this.addParser(Pp+Dp+r+",?\\2"+$o,4,3,1),c.fuzzyDateParsing.valueOrDefault&&(this.addParser(r+Ep+$o,3,1),this.addParser($o+Ep+r,1,3)),this.addParser($o,1)}extractDateFromPath(e){if(!c.usePathsToInferDates.valueOrDefault)return;hC.forEach(i=>{mc(e,i)&&e.splice(0,i.length)}),e=e.filter(i=>P(i)&&e[0].match(dC)==null);let r=[...e].reverse();return Xi(()=>tt(r,i=>this.parseYMD(i)),()=>this.parseYMD(r.slice(0,4).join(" ")),()=>this.parseYMD(e.slice(0,4).join(" ")),...c.fuzzyDateParsing.valueOrDefault?[()=>tt(this.ymPatterns,i=>tt(r,o=>i.apply(o))),()=>tt(this.ymPatterns,i=>i.apply(e.join(" "))),()=>tt(this.yPatterns,i=>tt(r.slice(1),o=>i.apply(o)))]:[])}},dC=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P_?)\d+)$/i,gC=l(()=>{c.fuzzyDateParsing.addListener(()=>Ll.unset()),c.fuzzyYearParsing.addListener(()=>Ll.unset()),c.usePathsToInferDates.addListener(()=>Ll.unset())}),Ll=l(()=>(gC(),new lA(void 0))),hC=[];function mA(t){return Ll().extractDateFromPath(t)}function my(t){return Ll().parseYMD(t)}function uA(t){return t!=null&&(t instanceof Hn||t instanceof Ft.ExifDate||t instanceof Ft.ExifDateTime||t instanceof Date||t instanceof zr||t instanceof dt.DateTime||nc([t.year,t.month,t.day]))}function Jo(t){return f(t,e=>e instanceof Date?e.getFullYear():e.year)}function Ko(t){return f(t,e=>e instanceof Date?e.getMonth()+1:e.month)}function Go(t){return f(t,e=>e instanceof Date?e.getDate():e.day)}function yC(t){return Vr(t)?t instanceof Date?t.getHours():t.hour:void 0}function cA(t){return Vr(t)?t instanceof Date?t.getMinutes():t.minute:void 0}function fA(t){return Vr(t)?t instanceof Date?t.getSeconds():t.second:void 0}function pA(t){return Vr(t)?t instanceof Date?t.getMilliseconds():t.millisecond:void 0}function dA(t){return Vr(t)&&(B(cA(t))||B(fA(t))||B(pA(t)))}function bC(t,e=!0){if(t==null)return;if(t===0)return e?"UTC":"";let r=t<0?"-":"+",i=Xe(t/15)*15,o=Math.abs(i),n=Math.floor(o/60),s=Math.floor(Math.abs(o%60));return`${e?"UTC":""}${r}${Mp(n)}:${Mp(s)}`}function Gn(t){return t instanceof Ft.ExifDateTime?t.hasZone&&YD(t.tzoffsetMinutes):t instanceof dt.DateTime?t.zone!=null&&t.zone.type!=="local":!1}function uy(t){return t instanceof dt.DateTime?f(t.zone,e=>e.name):t instanceof Ft.ExifDateTime?t.zone:void 0}function fC(t,e=wC){let r=e.exec(t);if(r==null)return;let i=[...r.slice(1)],[o,n,s,a,m,u]=i.splice(0,6).map(W=>k(W));if(o==null||n==null||s==null||!c.fuzzyDateParsing.valueOrDefault&&(a==null||m==null))return;let p=Y(0,999,mi(i.shift(),{defaultValue:0})*1e3),g=sA(i),v=bC(g),D=dt.DateTime.fromObject({year:o,month:n,day:s,hour:a,minute:m,second:u,millisecond:p,zone:v});return D.isValid?po(D,v):void 0}var xC="[-:_ ]?",wC=new RegExp([$o,rA,iA,aC,lC,mC,uC].join(xC)+nA+"?","i");function rC(t){if(t instanceof dt.DateTime)return t;if(t instanceof Ft.ExifDateTime)return t.toDateTime();if(t instanceof zr)return t.middle.toDateTime();if(t instanceof Date)return dt.DateTime.fromJSDate(t)}function po(t,e){if(t==null||!Vr(t))return;if(t instanceof dt.DateTime)return Ft.ExifDateTime.fromDateTime(t);let r=Si(t);if(r==null)return;let i=S(e)?Gn(t)?uy(t):void 0:e,o=U(i,s=>TC(r,s));if(e!=null&&o==null)return;let n=f(Jo(t),s=>f(Ko(t),a=>f(Go(t),m=>f(yC(t),u=>new Ft.ExifDateTime(s,a,m,u,x(cA(t),0),x(fA(t),0),pA(t),o,t.rawValue)))));return Dr(n)?n:void 0}function hA(t){if(t==null)return;if(typeof t=="number")return new Date(t);if(t instanceof Date)return t;if(t instanceof dt.DateTime)return t.toJSDate();if(t.toDate!=null)return t.toDate();if(B(t.year)&&B(t.month)&&B(t.day))return new Date(t.year,x(t.month,1)-1,t.day,12);let e=h(t);if(P(e))return f(vC(e),hA)}function Si(t){if(!(t==null||Rt(t)))return ne(t)?t:t instanceof Date?t.getTime():t instanceof dt.DateTime?t.toMillis():f(hA(t),e=>e.getTime())}function cy(t){if(!(t==null||Rt(t)))return ne(t)?zf(t):t instanceof Ft.ExifDateTime||t instanceof dt.DateTime?SC(t):t instanceof Date?zf(t.getTime()):f(Si(t),zf)}function SC(t){return parseInt([t.year,t.month,t.day,t.hour,t.minute,t.second].map(e=>Kt(e)).join("")+"00")+Cf(t.millisecond??0)}function gA(t){return f(t,e=>e instanceof Ft.ExifDateTime?e.tzoffsetMinutes:e instanceof dt.DateTime?e.offset:void 0)}function fy(t){return f(t,e=>e instanceof dt.DateTime||e instanceof Ft.ExifDateTime||e instanceof Date?0:e instanceof Ft.ExifDate?xt:e instanceof zr?e.intervalMs:void 0)}function yu(t,e=!0){if(t==null)return;if(t instanceof zr)return t.toString(e);let r=ne(t)?new Date(t):t;return Vr(r)?f(po(r),i=>i.toISOString({includeOffset:e})):MC(r)}function vC(t,e){return typeof t!="string"||S(t)?void 0:z(Ft.ExifDateTime.fromISO(t,e)).orElse(()=>Ft.ExifDate.fromISO(t)).orElse(()=>Ft.ExifTime.fromEXIF(t)).get()}function MC(t,e="-"){return F([Jo(t),Ko(t),Go(t)]).map(r=>Mp(r)).join(e)}function sy(t){return f(t,e=>f(Jo(e),r=>new Hn(r,Ko(e),Go(e))))}function yA(t,e){return as(py(t,e),xt)}function py(t,e){let[r,i]=[t,e].map(Si);return r==null||i==null?void 0:r-i}function Vr(t){return t instanceof Date||t instanceof Ft.ExifDateTime||t instanceof dt.DateTime}function TC(t,e){let r=dt.Info.normalizeZone(e);return r.isValid?r.offset(t):void 0}function bA(t,e){return t instanceof dt.DateTime?t.setZone(e,{keepLocalTime:!0}):po(t,e)}var Qo=class{static lift(e){return new class extends Qo{apply(r){return e(r)}}}and(e){return Qo.lift(r=>this.apply(r)&&e.apply(r))}or(e){return Qo.lift(r=>this.apply(r)||e.apply(r))}filter(e){return e.filter(r=>this.apply(r))}asAsync(){return Ce.lift(e=>Promise.resolve(this.apply(e)))}},pxe=Qo.lift(Gi),dxe=Qo.lift(()=>!0);function bu(t){return Qo.lift(e=>cl(e?.ext,t))}var xxe=bu(Et.SupportedByCurrentBrowser),Txe=bu(Et.Video),Ap=bu(Et.AssetFile);var ho=l(()=>d("TagInference"));async function wA(t,e){if(P(e.Make)&&P(e.Model))return;if(S(e.Make)&&(h(e.HandlerDescription)+h(e.CompressorName)).includes("GoPro")){e.Make="GoPro";return}let r=Ys(t),i=await dy(t);if(i==null)return;let o=F(ae(hs(i.younger,i.older))).slice(0,50).filter(n=>rf(Ys(n),r)>.7).slice(0,10);ho().info("inferMakeAndModel("+t+"): looking at nearby siblings",o.map(n=>n.base));for(let n of o){let s=await ot(n);if(s!=null&&xc(s.Make,s.Model)){ho().info("inferMakeAndModel("+t+")",{sibling:n.base,Make:s.Make,Model:s.Model}),e.Make=s.Make,e.Model=s.Model;return}}}async function xA(t){return b(PC(t),({before:e,after:r,index:i,slots:o})=>{if(!yA(e.date,r.date)){ho().debug("inferCapturedAtFromSiblings(): rejecting, not same day",{file:t.nativePath,before:h(e),after:h(r)});return}return f(zr.for(e.date,r.date,i,o),n=>({date:n,src:`before:${e.src},after:${r.src}`}))})}async function TA(t,e=7){return Tc(A(t).slice(0,e),(r,i)=>b(ot(r),o=>b(Fp(o),n=>y(y({},n),{index:i}))))}async function EC(t,e=7){return Tc(t.slice(0,e),(r,i)=>b(ot(r),o=>b(Fp(o),n=>z(n).filter(s=>Gn(s.date)).flatMap(s=>uy(s.date)).map(s=>({zoneName:s,index:i})).get())))}C(()=>q(()=>vA.prior()?.clear()));var vA=l(()=>new ke(1024));function PC(t){return vA().getOrSet(t.nativePath,async()=>{let e=await dy(t),r=await TA(e?.younger),i=await TA(e?.older);return r==null||i==null?void 0:{before:r,after:i,index:r.index,slots:r.index+i.index+1}})}C(()=>q(()=>SA.prior()?.clear()));var SA=l(()=>new ke(2048,E));function Ys(t){let e=Rt(t)?t:t.name;return SA().getOrSet(e,()=>(f(/(?:burst)(.{8,})$/i.exec(e),r=>e=r[1]),f(/^(?:(?:dsc[0f]?|img|mov|mvi|mvimg|vid|gpfr|gopro?|gp|gf|p)(?:[-_ ])?)(\S.+)$/i.exec(e),r=>e=r[1]),e.replace(/\s*-?\s*copy( \(?\d+\)?)?\s*$/i,"").replace(/\s*\((another |\d+[a-z]{2} )?copy\)\s*$/i,"").replace(/^[-\s_0]+/,"").replace(/[\s-_][\d\s]{0,2}$/,"").replace(/_cover$/i,"").toLowerCase().normalize()))}var DC=bu(Et.AssetFile);async function dy(t,e=7){let r=await t.parent().childDirectoryEntries(p=>p.isFile()&&!p.name.startsWith(".")&&!Km(p.ext)&&DC.apply(p));if(r==null){ho().info("nearestSiblings(): can't readdir parent, "+t.parent());return}let i=await t.statTimes();if(R(i)){ho().info("nearestSiblings(): statTimes() missing from "+t);return}let o=te(r,p=>Ys(p)),n=o.findIndex(p=>p.base===t.base);if(n<0){ho().warn("nearestSiblings(): can't find self in siblings: "+t);return}let[s,a]=[o.slice(n-e*2,n),o.slice(n+1,n+1+e*2)],m=[],u=[];for(;_(s)&&m.length<e;){let p=oe.forDirectoryEntry(s.pop());await MA(t,p)&&m.push(p)}for(;_(a)&&u.length<e;){let p=oe.forDirectoryEntry(a.shift());await MA(t,p)&&u.push(p)}return{younger:m,older:u}}function MA(t,e,r=2*xt){let i=py(my(t.base),my(e.base));return i!=null&&Math.abs(i)>r?!1:t.contemporary(e,r)}async function PA(t){let e=await dy(t),r=dx(A(e?.younger),A(e?.older)).slice(0,10);return ho().tap({msg:"nearestSiblingTzOffset("+t+")",result:await b(EC(r),i=>i.zoneName),meta:{zipped:r}})}async function EA(t){let e=ly(Ys(t)),r=f(e,Si);if(e==null||r==null){ho().debug("extractStatBname() bname isn't dated",{bname:Ys(t),fromName:e,fromNameMs:r});return}let i=await t.stat();if(i==null){ho().debug("extractStatBname() no stat",{fromName:e,fromNameMs:r});return}return ho().tap({msg:"extractStatBname()",result:tt(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],o=>Math.abs(i[o]-r)<iy?{src:o,date:e}:void 0),meta:{fromName:e,fromNameMs:r,stat:i}})}var AC=l(()=>d("CapturedAt"));function FC(t){return h(t).toLowerCase().startsWith("tags")}var Il=class{constructor(e,r,i,o,n){this.nativePath=e;this.date=r;this.src=i;this.mtime=o;this.precisionMs=n;this.toISOString=l(()=>yu(this.date))}spread(e){let r=y(y({},this),e);return new Il(r.nativePath,r.date,r.src,r.mtime)}toLocal(){return cy(this.date)}toOffset(){return gA(this.date)}get isFromTags(){return FC(this.src)}toPrecisionMs(){return x(this.precisionMs,()=>fy(this.date))}toString(){return O({nativePath:this.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return Gn(this.date)}hasTime(){return Vr(this.date)}};async function IC(t,e,r,i){let o=await r;if(!!Dr(o))return Gn(o)?o:e!=null&&e.tz!=null&&DA.Info.isValidIANAZone(e.tz)?bA(o,e.tz):i?o:LC(t,o)}async function LC(t,e){if(!Dr(e))return;if(Gn(e))return e;let r=await PA(t);if(r!=null){let i=po(e,r);if(Dr(i))return i}return e}function RC(t,e){return t==null||e||!c.usePathsToInferDates.valueOrDefault||!c.useLibraryPathsToInferDates.valueOrDefault&&Ha(t.nativePath,c.libraryPath.value)}async function AA(t,e,r){let i=await t.mtime(),o=async(n,s)=>b(s,a=>b(IC(t,e,a.date,r),m=>new Il(t.nativePath,m,V([n,a.src]).join(":"),i,a.precisionMs)));return er(()=>o("tags",Fp(e)),()=>o("bname+stat",EA(t)),()=>r?void 0:o("siblings",xA(t)),()=>r||!c.usePathsToInferDates.valueOrDefault?void 0:o("bname",f(aA(Ys(t)),n=>({date:n,src:"",precisionMs:Pc([fy(n),M])}))),()=>RC(t,r)?void 0:o("path",f(mA(t.pathnamesWithoutDrive),n=>({src:"",date:n}))),()=>c.useStatToInferDates.valueOrDefault?o("stat",b(t.minStatDate(),n=>({src:"",date:n}))):void 0)}var FA=["SubSecDateTimeOriginal","SubSecCreateDate","SubSecTimeDigitized","SubSecMediaCreateDate","DateTimeOriginal","OriginalCreateDateTime","CreateDate","DateTimeCreated","DateCreated","DateTimeDigitized","MediaCreateDate","DateTime","SubSecTime","ModifyDate","photoTakenTime"];function LA(t,e){return Fl(t[e],r=>({src:e,date:r}))}function Fp(t){if(t==null)return;let e=F(FA.map(i=>({date:t[i],src:i,ts:f(Si(t[i]),o=>Math.floor(o/1e3))}))),r=e.filter(i=>Dr(i.date)&&i.ts!=null);return no(qt.debug,()=>{AC().debug("capturedAtFromTags()",{rawArr:e,validArr:r})}),Xi(()=>st(r,i=>f(cy(i.ts),o=>[-Math.floor(o/1e8),Vr(i.date)?1:0,dA(i.date)?1:0,Gn(i.date)?1:0,-FA.indexOf(i.src)])),()=>LA(t,"DateTimeUTC"),()=>LA(t,"GPSDateTime"))}var OC=d("ExposureSettings");function IA(t){let e={focalLength:t.FocalLength,iso:Qd(t.ISO,t.ISOSpeed,t.SonyISO),aperture:Qd(t.FNumber,t.Fnumber,t.ApertureValue,t.SonyFNumber),shutterSpeed:ga(t.ExposureTime,t.ShutterSpeed,t.SonyExposureTime)};return OC.debug("extracted from "+t.FileName,{exposureSettings:e}),ps(e)}function RA(t,e){let r=Math.pow(2,e),i=[];for(;t>0;)i.unshift(t%r),t=Math.floor(t/r);return i}function wu(t){t.dims.forEach(r=>r.value=Y(r.min,r.max,r.value));let e=0;for(let r=0;r<t.bitDepth;r++){e*=2;let i=r%t.dims.length,o=t.dims[i],n=_t([o.min,o.max]);o.value>n?(e+=1,o.min=n):o.max=n}return e}function hy(t,e){if(e.bitDepth>52||e.bitDepth<0)return;let r=kC(t);for(let i=0;i<e.bitDepth;i++){let o=i%e.dims.length,n=e.dims[o],s=_t([n.min,n.max]);r.includes(e.bitDepth-i-1)?n.min=s:n.max=s}return e.dims.map(i=>_t([i.min,i.max]))}function kC(t){return t.toString(2).split("").reverse().map((e,r)=>e==="1"?r:-1).filter(e=>e!==-1)}var _C=30;function NC(t){return Math.floor(t/5)*5}function gy(t){return ne(t)&&t!==0&&St(-90,90,t)}function yy(t){return ne(t)&&t!==0&&St(-180,180,t)}function BC(t,e){return gy(t)&&yy(e)}function OA(t,e){return CC(t,e,30)}function CC(t,e,r=_C){return BC(t,e)?wu({dims:[{min:-180,value:e,max:180},{min:-90,value:t,max:90}],bitDepth:NC(r)}):void 0}function by(t){return ba(t?.timestamp,e=>Fl(new Date(e*1e3),r=>r))}async function wy(t){return b(t.readJson("info"),e=>Li({Title:Od(e.title),Description:Od(e.description),GPSLatitude:tt([e?.geoData?.latitude,e?.geoData?.latitude],r=>gy(r)?r:void 0),GPSLongitude:tt([e?.geoData?.longitude,e?.geoData?.longitude],r=>yy(r)?r:void 0),GPSAltitude:tt([e?.geoData?.altitude,e?.geoData?.altitude],r=>ne(r)?r:void 0),favorited:e.favorited==null?void 0:L(e.favorited),peopleNames:Oe([...A(e.people),...A(e.person)],r=>V(r.map(i=>i.name))),creationTime:by(e.creationTime),modificationTime:by(e.modificationTime),photoTakenTime:by(e.photoTakenTime),imageViews:ba(e.imageViews,r=>r)}))}function xy(t,e,r=""){let i=t.replace(e,r);return i===t?t:xy(i,e,r)}var VC=["BenQ","GoPro","HTC","LG","NEC","OnePlus","Sony","TrueHDR"],zC=new Map(VC.map(t=>[t.toLowerCase(),t]));function UC(t){let e=t.trim(),r=zC.get(e.toLowerCase());return r??(e.length<4?e:e.toLowerCase().replace(/(?:^|\s|-)\S/g,i=>i.toUpperCase()))}var kA=class{constructor(){this.ignorables=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|");this.ignorableSep="[\\s\\.,_-]*";this.IgnorableMakePatterns=new RegExp(`${this.ignorableSep}(?:${this.ignorables})${this.ignorableSep}$`,"i");this.IgnorableModelPatterns=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i];this.samsungPatterns=[[/^PL150 /,"PL150"],[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-G98[01]/,"Galaxy S20"],[/^SM-G98[56]/,"Galaxy S20+"],[/^SM-G988/,"Galaxy S20 Ultra"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]];this.lgPatterns=[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]];this.onePlusPatterns=[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]];this.CommonNamesByMake={Samsung:this.samsungPatterns,LG:this.lgPatterns,OnePlus:this.onePlusPatterns}}},Ty=l(()=>new kA);function xu(t){return U(t,e=>(e=Jd(e),e=xy(e,Ty().IgnorableMakePatterns),e=e.replace(/\s+app on Apple iDevice$/i,""),e=e.replace(/\bLGE\b/,"LG"),e=UC(e),e))}var WC=/<(.+?)[,/].+>/;function _A(t,e){if(S(t)||S(e))return;let r=Jd(e);if(t==="Samsung"){let o=WC.exec(r);o!=null&&(r=o[1])}let i=f(Ty().CommonNamesByMake[t],o=>o.find(([n])=>r.match(n)!=null));if(i!=null)return i[1].trim();t==="Sony"&&(r=r.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"\u03B1").replace(/7CL/i,"7c").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V").replace(/M6$/," VI").replace(/M7$/," VII").replace(/M8$/," VIII").replace(/M9$/," IX").replace(/M10$/," X").replace(/M11$/," XI")),t==="Olympus"&&(r=$(/^(.+?\d)mark(i.+?)$/i.exec(r),o=>`${o[1]} Mark ${o[2]}`,()=>r)),t==="Canon"&&(r=r.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel"));for(let o of Ty().IgnorableModelPatterns)r=xy(r,o).trim();return r=r.replace(new RegExp(`^${_i(t)}\\s+`,"i"),""),t.match(/^HP|Hewlett.Packard$/i)!=null&&r.match(/^hp\b/i)!=null&&(r=r.slice(2).trim()),r}var qC=/\b(n\/a|unknown)\b/i;function jC(t){return t.filter(e=>P(e)&&qC.exec(e)==null)}var NA=l(()=>d("LensMakeModel"));function Lp(t){let e=xu(t.LensMake),r=xu(t.Make),i=jC([e,t.LensMake,r,t.Make]),o=a=>(a=CA(a),i.reduce((m,u)=>Ec(m,u).trim(),a)),n=tt([t.LensInfo,t.LensSpec,t.LensModel,t.LensID],BA),s=F([t.LensID,t.LensModel,t.LensSpec,t.LensInfo]);NA().debug("extractLensMakeModel",{lensMake:e,lensInfo:n,lensModels:s});for(let a of s){let m=BA(a)!=null;if(NA().debug("extractLensMakeModel",{lensModel:a,hasLengthAndAperture:m}),!!m){if(P(e))return{lensMake:e,lensModel:o(a),lensInfo:n};if(a.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:o(a),lensInfo:n};for(let u of V([e,r,...c.lensMakes.values]))if(a.toLowerCase().includes(u.toLowerCase()))return i.unshift(u),{lensMake:u,lensModel:o(a),lensInfo:n}}}}function BA(t){if(S(t)||h(t).toLowerCase().includes("unknown"))return;let e=HC(t.replace(/\b(AF-S|DG|Digital|DI|DX|E|ED|HSM|LM|OIS|Pro|R|XF)\b/gi,"")),r=/[\d.-]+mm/.exec(e)?.[0],i=/f\/[\d.-]+/.exec(e)?.[0];if(!(r==="0mm"||i==="f/0"))return ss(r,i,(o,n)=>`${o} ${n}`)}function CA(t,e=3){return t.replace(/\d+\.\d+/g,r=>$(mi(r),i=>String(Fe(i,e)),r))}function HC(t){return CA(t).replace(/(\d) - (\d)/g,(e,r,i)=>`${r}-${i}`).replace(/(\d)\s+mm\b/,(e,r)=>r+"mm").replace(/\s+f\/?(\d)/i,(e,r)=>" f/"+r)}function VA(t){let e=K(["OLYMPUS DIGITAL CAMERA",t.originalMake,t.originalModel,t.Model,t.Make,t.CameraID]).map(i=>U(i,o=>o.trim().toLowerCase().normalize())),r=(...i)=>{for(let o of i){let n=h(t[o]).trim();if(P(n)&&!e.includes(n.toLowerCase().normalize()))return n}};return Li({title:r("XPTitle","Title","ObjectName"),description:r("XPSubject","Description","ImageDescription","Caption-Abstract")})}var go=l(()=>d("ExifTags")),GC=!1;function KC(){return c.exiftoolProcsPerChild.value??(yt()>4?3:2)}var vy=l(()=>new Nm("ExifTool",new zA.ExifTool({logger:()=>d("ExifTool"),maxProcs:KC(),maxIdleMsPerProcess:5*E,maxTasksPerProcess:c.maxTasksPerProcess.valueOrDefault,cleanupChildProcs:!1}),ue.service,!0).t);function Xs(){let t=vy();return t.ended?vy.refresh():t}function WA(){return xe(Xs().version(),H,()=>{throw new Error("ExifTool timed out")})}function qA(){return f(vy.prior(),t=>t.ended?void 0:xe(t.version(),H,()=>{throw new Error("ExifTool timed out")}))}Oa((t,e)=>b(jA(t),r=>{let i=oe.for(e);return Ip.getOrSetAsync(i.nativePath,()=>Promise.resolve(y(y({},r),{SourceFile:i.nativePath,FileName:i.base,Directory:i.dir})))}));function OD(t,e,r){return Xs().extractBinaryTag(t,e,r)}var Ip=new to({maxSize:128,timeoutMs:E}),Rp=new to({maxSize:128,timeoutMs:E});function HA(){Ip.clear(),Rp.clear()}C(()=>q(HA));pr(t=>{S(t)?HA():(Ip.deleteIf(e=>e.startsWith(t)),Rp.deleteIf(e=>e.startsWith(t)))});var GA=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];async function KA(t,e){let r=i=>b(ot(i,!1),o=>Gt(o,...GA));return await ds(t.clear().sha(),e.clear().sha())||await ds(r(t),r(e))}async function Tu(t){if(t==null)return;let e=oe.for(t);if(!(await e.isEmpty()||await e.isNotReadable()))return rt("tags.readTags",async()=>b(ot(e),r=>JC(e,r)))}async function jA(t){return Ip.get(String(t))}async function Gs(t){if(S(t))return;let e=oe.for(t);return er(()=>b(Rp.get(e.nativePath),r=>r.MIMEType),()=>b(jA(e),r=>r.MIMEType),()=>b(fu(e.nativePath),r=>r.mime==="image/tiff"?void 0:r.mime),()=>nM(e.ext)?b(ot(e,!1),r=>r.MIMEType):void 0)}async function JA(t){return b(ot(t,!0),lo)}async function El(t,e){let r=oe.for(t),i=e==null||S(e.ImageHeight)?await ot(r):e;if(i==null)return;let o=x(lo(e),()=>lo(i)),n=Wn(i.MIMEType)?await ip(r).catch(a=>{go().warn("Failed to read raw info",{file:r.nativePath,err:ce(a)})}):void 0,s=Cn(i,o,n);if(s!=null)return s;if(ir(i.MIMEType))return b(pu(r,i.MIMEType),a=>El(a,i))}async function $C(t,e="_original"){return t.sibling(t.base+e).saveIfNewOrDelete(t.name+e+t.ext)}async function $D(t){await Xs().deleteAllTags(t.nativePath),await t.sibling(t.base+"_original").unlink("trace")}function $A(t,e,r){return rt("tags.writeTags",async()=>{let i=await t.sidecar(),o=ir(r),s=o&&c.writeMetadataToSidecarsIfVideo.valueOrDefault||!o&&c.writeMetadataToSidecarsIfImage.valueOrDefault||await i.exists()?i:t;await Xs().write(s.nativePath,e,c.overwriteOriginal.valueOrDefault?["-overwrite_original"]:void 0);let a=await $C(s);return K([t.nativePath,s.nativePath]).forEach(Or),t.clearThisAndParent(),s.clearThisAndParent(),{original:a,dest:s}})}async function ot(t,e=!0){let r=oe.for(t);if(!!await r.isFile())return rt("tags.readRawTags",async()=>{let i=await QA(r.nativePath);if(i==null||!e)return i;let o=Ca(r.jsonSidecars(),wy),n=Ca(r.sidecars(),a=>QA(a.nativePath)),s=y({},i);for(let[a,m]of[...await o,...await n]){let u=Gt(a,...GA);_(ct(u))?((s.sidecars??(s.sidecars=[])).push(m.base),Fa(s,u),go().debug("readRawTags() sidecar had values",{sidecar:m.base,safeTags:u})):go().debug("readRawTags() sidecar was empty",{sidecar:m.base})}return s})}var Sy=new Wt,My=new Wt;I||(Sy.resolve(),My.resolve());async function QA(t){return Rp.getOrSetAsync(t,async()=>{go().debug("_readRawTags("+t+") not cached, reading now.");let e=Sy.pending;e?Sy.resolve():await My.promise;let r=Gm((0,UA.extname)(t))?[]:void 0,i=await rt("exiftool.read()",()=>xe(Ya(Xs().read(t,r).catch(o=>{go().info("Failed to read "+t,o)})),H));return e&&My.resolve(),f(i,o=>(go().debug("_readRawTags("+t+") in "+o.elapsedMs+"ms"),f(o.result,n=>{for(let a of vt(n)){let m=n[a];if(typeof m=="string"){let u=wD(m);u!=null&&(n[a]=u)}}let s=V([n.Error,...x(n.errors,[]),n.Warning].map(h));return _(s)&&(n.problems=s),n.exiftoolMs=o.elapsedMs,GC&&(n.instance=jf()),n})))})}async function JC(t,e){if(e==null)return;let r=e.MIMEType,i=t.nativePath;if(S(r)){go().debug("No mimetype for "+t);return}let o=t.nativePath.startsWith(c.cacheDir.valueOrDefault)||t.pathnames.includes(".photostructure");o||await wA(t,e);let n=e;n.originalMake=e.Make,n.originalModel=e.Model,e.Make=xu(e.Make),e.Model=_A(e.Make,e.Model);let s=Lp(e),a=await AA(t,e,o);if(a==null){go().info("No capturedAt for "+t);return}let m=IA(e),u=await El(t,e);if(u==null){go().info("No size info for "+i);return}let p=r.startsWith("video/")?wl(e):void 0,g=y(y(y(y({mimetype:r,exposureSettings:m},VA(n)),s),u),{duration:p,capturedAt:a,tz:e.tz});return go().debug("parsedTags",y(y({nativePath:i},g),{capturedAt:f(a,v=>({date:v.date,src:v.src}))})),y(y({},n),g)}var Kn=T(require("fs-extra"));async function YA(t,e=0,r){let i=-1;try{let o=await x(r,()=>b((0,Kn.stat)(t),s=>s.size-e)),n=Buffer.alloc(o);return i=await(0,Kn.open)(t,"r"),await(0,Kn.read)(i,n,0,o,e)}finally{await Ro(i,Kn.close)}}C(()=>{q(()=>Op.prior()?.clear()),pr(t=>t==null?Op.prior()?.clear():Op.prior()?.delete(t))});var Op=l(()=>new ke(512,3*E));async function fu(t){return Op().getOrSet(t,async()=>{let{buffer:e}=await YA(t,0,248);return Pt((0,XA.fromBuffer)(e)).filter(r=>r.mime!=="image/tiff").orElse(()=>Pt(Ba((0,ZA.stat)(t))).filter(r=>r).flatMap(()=>Xs().readRaw(t,["-mimetype"])).flatMap(r=>r.MIMEType).filter(P).map(r=>({ext:QC(t),mime:r})).get()).get()})}function QC(t){return Ge((0,e0.extname)(t),".")}var YC=require("sharp"),kp=l(()=>d("ImgCache")),XC="imgcache";async function Zs(){return Wo().join(XC).mkdirp_().catch(t=>{X("Failed to create imgCache directory"+pe,t)})}async function Vi(t,e,r){let i=await t.stat();if(i==null)throw new Error(`cachedImgFile(${t}): unreadable`);let o=await Zs();if(o==null)throw new Error("imgcache dir is missing");let n=await fu(t.nativePath);if(n==null)throw new Error("Cannot read filetype for "+t);let s=En(O({basename:t.base.toLowerCase(),mimetype:n.mime,size:i.size}));r=ui(r,".");let a=o.join(...Qi(s.slice(0,24),2,3),e+r);if(await a.parent().mkdirp()==null)throw new Error("Cannot make dest dir, "+a.parent());return kp().debug("cachedImgFile("+t.baseWithGrandparent+")",{desc:e,ext:r,result:a}),a}async function kD({src:t,desc:e,suffix:r,f:i}){try{return await b(Vi(t,e,r),o=>o.applyIfEmpty_(async n=>b(i(),s=>n.writeStream_(s))))}catch(o){throw new me({cause:o,message:"readableToFile() failed"})}}async function ZC(t,e,r,i){try{return await b(Vi(t,e,r),o=>o.applyIfEmpty_(i))}catch(o){throw kp().warn("readableToFile("+t+"): "+o),o}}async function t0(t,e){if(await t.notExists())return;let r=await ot(t,!0),i=r?.MIMEType,o=x(lo(r),0),n=f(r,m=>Cn(m,o)),s=x(n?.dimensions,e);if(s==null){kp().warn("prepFileForBrowser(): no file dimensions",{file:t,si:n,info:e});return}let a={width:s.width-32,height:s.height-32};return vD(i,e.userAgent)&&o===0?t:(kp().info("prepFileForBrowser(): non-browser-supported mimetype",{file:t,mt:i,info:e}),ZC(t,"web-"+o,".jpg",async m=>b(jn(t,a),async u=>YC(u.nativePath).rotate(o).toFile(m.nativePath))))}function Yo(t){let e=t;return e==null?void 0:B(e)?e:ya(e.id,-20)?e.id:B(e.assetId)?e.assetId:ac(e.tagId)?e.tagId:void 0}function r0(t,e){return un(Yo(t),Yo(e),(r,i)=>r===i,()=>!1)}var c0=T(require("util"));var Py=l(()=>d("AssetFileSorter")),e2=[Ti,"file",Uo,so];function t2(t){return f(t,e=>ls(e.width,e.height,(r,i)=>i0(r*i)))}function i0(t){return Math.round(Math.pow(t,c.variantSortCriteriaPower.valueOrDefault))}function r2(t){return Math.round(t/(2*E))}function o0(t){for(let i of K(t.map(o=>o.sha))){let o=t.filter(s=>s.sha===i),n=Math.max(...F(o.map(s=>s.mtime)));o.forEach(s=>s.mtime=n)}let e=F(t.map(i=>f(i2(i),o=>f(o2(o),n=>({f:i,crit:n,pojo:o}))))),r=te(e,({crit:i})=>i);return Oe(r,i=>i.map(o=>o.f))}function i2(t){let e=t2(t),r=Ne.parse(t.uri);if(S(r.scheme)||S(r.path)||t.mtime==null){Py().debug("assetFileSortCriteriaPojo(): skipping",{af:t,parsedURI:r});return}let i=e2.indexOf(r.scheme);if(i===-1){Py().debug("assetFileSortCriteriaPojo(): skipping",{af:t,schemeIdx:i,parsedURI:r});return}let o=ET(r.path),n=o.base.toLowerCase().includes("cover"),s=sM(o.ext),a=x(FT(o.name),0),m=r2(t.mtime),u=wr(t.fileSize,i0),p={resolution:e,mtime:m,schemeIdx:i,fileSize:u,isCover:n,count:a,isBrowserSupported:s},g={};for(let v of c.variantSortCriteria.values)f(p[v],D=>g[v]=D);return g.uri=t.uri,g}function o2(t){let e=ct(t);if(e.some(r=>r==null)){Py().debug("pojoToCriteria(): skipping",{pojo:t});return}else return e}function n0(t,e,r){let o=$e.fit().map(a=>[a.outputSize(t),a]).filter(([a])=>a!=null),n=t;function s(a,m){let u=Cr(n)/Cr(a),g=m===0&&(r!=="image/jpeg"||B(e))||u>3||Cr(a)-Cr(n)>2.5;return g&&(n=a),g}return o.filter(([a],m)=>s(a,m))}function s0(t){return t==="qhd"?"wvga":t==="uhd"?"uhd4k":t}function a0(t,e){return uc(V(t).map(s0),V(e).map(s0))}var l0=T(require("sharp"));var n2=l(()=>d("Sharp"));async function m0(t){try{let{data:e,info:r}=await t.raw().toBuffer({resolveWithObject:!0});return s2(e,r)}catch(e){return n2().info("Failed to buffer-clone sharp",e),t.clone()}}function s2(t,e){return(0,l0.default)(t,{raw:e})}var FMe=require("sharp"),a2=l(async()=>{let t=oe.for(dr.ICC()),e={};for(let r of c.iccProfileMappings.valueOrDefault){let[i,o]=r.split(":"),n=t.join(o);await n.isNonEmptyFile()?e[i]=n.nativePath:d("SharpColorspace").warn(" iccProfileMappings has an invalid ICC profile filename: "+o)}return Object.freeze(e)});async function u0(t,e){let o=(await ot(t,!1))?.ProfileDescription;if(!S(o)){let n=await a2();for(let s of vt(n))if(o.includes(s))return e.withMetadata({icc:n[s]})}return e.toColorspace("srgb")}var l2=require("sharp"),Ey=class{constructor(e,r){this.ap=e;this.assetFiles=r;this.badShas=new ks(2*E);this.logger=d("AssetPreviewBuilder("+e.assetId+")")}[c0.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build_(e){return rt("img.AssetPreviewBuilder.build()",async()=>{let r=F(await o0(await this.assetFiles));for(this.logger.info("build_(): asset file candidates:",r.map(i=>i.uri).reverse());_(r);){let i=r.pop(),o=await oe.forUri(i.uri);if(o==null)continue;let n=await o.sha();if(!(n==null||this.badShas.has(n)))try{return await this._build(o,i,e)}catch(s){this.badShas.add(n),this.logger.warn("Failed to set shown file to "+i,ce(s))}}return this.logger.throw("none of the files are valid",{ignorable:!0,retriable:!1})})}async _build(e,r,i){this.logger.info("_build("+e+")",{uri:r.uri}),L(i.validate)&&await ND(e);let o=await e.size(),n=await e.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:o,mtime:n,best:r}),o==null||n==null)return this.logger.throw("build(): missing stat info for best file",{ignorable:!0,best:r});if(r.width==null||r.height==null||r.mimetype==null||r.sha==null)return this.logger.throw("IE build(): missing fields for best file "+e,{ignorable:!0,best:r});let s=n0(r,r.rotation,r.mimetype),a=y(y({assetFileId:r.id},et(r,"assetId","uri","width","height","mimetype","sha","rotation")),{path:e.nativePath,mtime:n,filesize:o,fitSizes:s.map(([,J])=>J.name).join(",")});if(i.force!==!0&&!c.forceSync.valueOrDefault){let J=await this.ap.readInfo.refresh();if(J!=null){if(J.assetId!==a.assetId)throw new Error("IE build(): Mismatched asset IDs for "+r+": "+O({priorInfo:J,info:a}));let Z=J.fitSizes.split(","),ar=a.fitSizes.split(",");if(J.sha!=null&&J.sha===a.sha&&J.rotation===a.rotation&&a0(Z,ar)){let Wr=fc(Z,ar);if(_(Wr)){this.logger.info("build(): removing previews that aren't required anymore.",{leftovers:Wr});for(let Lr of Wr){let qi=s.find(([,ns])=>ns.name===Lr);if(qi==null)this.logger.warn("build(): Failed to clean up: missing fit size",{fitsize:qi,fits:s});else{let ns=this.ap.fileForWidth(qi[1].reducer.name,qi[0].width);this.logger.debug("build(): unlinking unwanted preview "+ns,{fitsize:qi}),await ns.unlink("warn")}}}return this.logger.debug("build(): SHA and rotation match, and previews exist.",{info:a,priorInfo:J}),await this.ap.writeInfo(a),a}}}let m=new Dn({path:e.nativePath,op:"Building previews for"},$e.sq().length+$e.fit().length);if(this.logger.debug("Rebuilding all previews from "+r.uri,{assetId:r.assetId,best:r,info:a}),await this.ap.parent.mkdirp()==null)throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+r);let u=await this.ap.existingFiles(),p=await jn(e,$e.largestFit().max);if(p==null)throw new me({message:"AssetPreviewBuilder.build(): "+r.uri+", "+e.nativePath+", is not readable by sharp.",retriable:!1});let g=await u0(e,l2(p.nativePath));r.mimetype.startsWith("image/")&&!$s(r.mimetype)&&r.rotation!=null&&r.rotation!==0&&(g.rotate(r.rotation),this.logger.debug("build(): rotating "+r.rotation+"\xB0")),p.name.toLowerCase().includes("thumbnail")&&ze(()=>g.trim(1));let v=[],D,W,Ae=$e.largestSq(),sr=Ii(s,([J,Z])=>f(Ae.outputSize(J),()=>Z.megapixels()))?.[1].name,Ye=et(r,"width","height");{let J=g.clone(),Z=Ye;for(let[ar,Wr]of s){let Lr=Date.now(),qi=Z,ns=this.ap.fileForWidth(Wr.reducer.name,ar.width).wip();J=Wr.resize(ar,J),Z=ar,Wr.name===sr&&(W=J.clone(),D=ar),await Wr.toJpeg({path:ns.nativePath,sh:J,outputSize:ar}),m.onProgress(),this.logger.debug("resize("+Wr.name+") "+Zr(qi)+" -> "+Zr(ar)+" in "+(Date.now()-Lr)+" ms"),v.push(ns)}}{W==null?(this.logger.debug("square resize(): resorting to ",{origDim:Ye,bestFitNameForSq:sr}),W=g,D=Ye):this.logger.debug("square resize(): using to ",{sqDim:D,bestFitNameForSq:sr});let J=!1;for(let Z of $e.sq()){let ar=Date.now(),Wr=D,Lr=Z.outputSize(x(D,Ye));if(Lr==null){this.logger.debug("skipping square output for "+Z.max);continue}J||(Lr.position=c.squareThumbStrategy.valueOrDefault,J=!0),this.logger.debug("Applying ",{outputSize:Lr});let qi=this.ap.fileForWidth(Z.reducer.name,Lr.width).wip();Z.resize(Lr,W),Lr.position!=null&&(this.logger.debug("Cloning square crop to make position consistent",{outputSize:Lr}),W=await m0(W)),D=Lr,await Z.toJpeg({path:qi.nativePath,sh:W,outputSize:Lr}),m.onProgress(),v.push(qi),this.logger.debug("resize("+Z.name+") "+Zr(Wr)+" -> "+Zr(Lr)+" in "+(Date.now()-ar)+" ms")}}try{await Promise.all(u.map(J=>J.unlink())),await Promise.all(v.map(J=>J.unwip_())),await this.ap.writeInfo(a),this.logger.debug("Previews unwipped and info written",{info:a})}catch(J){throw await le(v,Z=>Z.unlink()),new me({cause:J,fatal:!1,message:"Failed to create previews from "+e})}return a}};var _p=class{constructor(e,r=""){this.query="";if(this.query=r,this.assetId=Yo(e),this.assetId==null)throw new Error("internal error: null asset id "+O({id:e}))}static onNewPage(){this.pageImageCount=0}get unset(){return this.assetId==null||this.assetId<=0}assetUrl(){return this.unset?"":`/asset/${this.assetId}${this.query}`}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,r){return`/img/${this.assetId}/${e}/${r}${this.query}`}imgActualLink(e){return`/img/${F([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e,r="m"){return y(y({},this.imgAttrs("sq",Gx,e)),{sizes:r==="s"?"80px":r==="m"?"160px":"320px"})}imgAttrs(e,r,i,o){if(this.unset)return{src:"/images/clear-64.png"};let n=Math.min(...r),s={width:h(n)},a=this.imgLink(e,n);_p.pageImageCount++,i=x(i,()=>_p.pageImageCount>72),i?(s.src="/images/clear-64.png",s["data-src"]=a):s.src=a,e===Nt.sq&&(s.height=h(n));let m=r.map(u=>f0(this.imgLink(e,u),u));return f(o,u=>m.push(f0(this.imgActualLink(),u.width))),s[(i?"data-":"")+"srcSet"]=m.join(","),s}},ti=_p;ti.pageImageCount=0;function f0(t,e){return t+" "+e+"w"}var m2=d("extractPreviewInfo");function vu(t,e){let r=e.posixPathFrom(t).replace(/\//g,"").split("-"),i=k(r[0]),o=r[1],n=Nt.validOrElse(o,void 0),s=Ax(r[2]);if(B(i))return{file:e,assetId:i,reducer:n,width:s};m2.warn("Failed to extract preview info",{file:e,previewsRoot:t,arr:r,assetId:i,reducer:n,width:s})}async function p0(t,e){return ss(e.assetId,e.width,(r,i)=>b(zi(e.file),o=>{let n=qP(o),s=zt(t,DT(t));return{size:n,basename:`${s}-${n}${e.file.ext}`,title:Dy(e.file,n,"image",o),description:`Download ${n}`,details:`(${Zr(o)} ${e.file.ext})`,href:new ti(r).imgLink(Nt.fit,i)}}))}function Dy(t,e,r,i){return`Download ${e} ${t.ext} ${r} (${Zr(i)})`}var KPe=new Xa,Ay=class{constructor(e,r,i){this.previewsRoot=e;this.alp=i;this.readInfo=l(()=>this.infoJson().readJson("debug"));this.logger=d("AssetPreviews(assetId:"+Yo(r)+")"),this.assetId=Yo(r),this.urls=new ti(r);let o=cr(this.assetId,8,"0"),n=Qi(o,3);this.basename=n.pop()+"-",this.parent=e.join(...n)}existingFiles(){return Ee(this.parent.childFiles(e=>e.base.startsWith(this.basename)),()=>[])}existingJpgs(){return Ee(this.parent.childFiles(e=>e.base.startsWith(this.basename)&&e.ext===".jpg"),()=>[])}async previews(){let e=await this.existingFiles();return bm(F(e.map(r=>vu(this.previewsRoot,r))),r=>r?.file.size())}async deleteAll(){this.parent.clear();let e=await this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return await Promise.all(e.map(r=>r.unlink())),e}file(e){return this.parent.join(this.basename+e)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(e){return this.readInfo.unset(),this.infoJson().writeJsonMaybe(e,{spaces:2})}fileForWidth(e,r){return this.file(e+"-w"+r+".jpg")}filesForReducer(e){let r=this.basename+e+"-";return this.existingFiles().then(i=>i.filter(o=>o.base.startsWith(r)))}async smallestFileForReducer(e){return Ii(await this.filesForReducer(e),r=>x(f(vu(this.previewsRoot,r),i=>i.width),0))}async largestFileForReducer(e){return st(await this.filesForReducer(e),r=>x(f(vu(this.previewsRoot,r),i=>i.width),0))}async widths(e){let r=await this.filesForReducer(e);return xr(F(r.map(i=>f(vu(this.previewsRoot,i),o=>o.width))))}async posterLink(){let e=await this.widths(Nt.fit);return this.urls.imgLink(Nt.fit,Math.max(...e))}async imgAttrs(e,r=!1,i=!0){if(!r&&e===Nt.sq)return this.urls.sqImgAttrs(i);{let o=e===Nt.fit?await this.readInfo():void 0;return this.urls.imgAttrs(e,await this.widths(e),i,o)}}};var Fy=class{constructor(e,r){this.root=e;this.alp=r;this.id2ap=new ke(512)}async build_(e){return this.apb(e.assetId,e.assetFiles).build_(e)}apb(e,r){return new Ey(this.ap(e),r)}ap(e){let r=h(Yo(e)),i=this.id2ap.get(r);if(i!=null&&r0(e,i.assetId))return i;{let o=new Ay(this.root,e,this.alp);return ne(e)||this.id2ap.set(r,o),o}}clearAssetId(e){this.id2ap.delete(h(e))}};var u2=l(()=>d("Broadcaster")),Ly;(function(e){e.broadcast=async(r,i)=>(u2().warn("broadcast sent to no-op",{event:r,args:i}),!1)})(Ly||(Ly={}));var Iy=Ly;var Np=Iy;function d0(t){Np=t}function h0(t){Np===Iy&&(Np=t)}function yr(t,e){Np.broadcast(t,e)}var x0=T(require("net"));var w0=T(require("process"));var g0=T(require("os")),y0=T(require("process"));var c2=0,f2=l(()=>Jr((0,g0.hostname)()+String.fromCharCode(31)+y0.pid)+"-");function Bp(){return f2()+Ps.encode(++c2)}var b0=T(require("util"));var Ry=class{constructor(e,r,i,o){this.id=e;this.method=r;this.params=i;this.timer=o;this.start=Date.now();this.name="rpc.RequestResponse("+r+")#"+e,this.d=new Mr(this.name)}[b0.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),f(this.d.settledMs,r=>this.timer.push(this.method,r)))}reject(e){return this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}};var p2=(fe?7:30)*M,d2=fe?500:5*M,h2={requestTTL:p2,retriesPerRequest:5,delayBetweenRetries:d2,maxPendingRequests:10},g2=0,Oy=class extends lt{constructor(e,r,i={}){super("rpc.Client("+e+"#"+g2+++")",()=>this.onEnd(),ue.first);this.streamFactory=r;this.mkStreamRate=new Sn(E);this.pending=new Map;this.times=new Xa;this.changeListeners=[()=>this.mkStreamRate.onEvent()];this.stream=l(async()=>{try{if(this.flapping)return this.onError("stream() is restarting too frequently (epm: "+this.mkStreamRate.eventsPerMinute+")");let e=await this.streamFactory();return e==null?this.onError("streamFactory() returned null"):(this.changeListeners.forEach(r=>r()),e.on("end",r=>this.onFinish("on(end)",r)),e.on("close",r=>this.onFinish("on(close)",r)),e.on("error",r=>this.onError("stream error",r)),An(e,`
`,r=>this.onData(r)),e)}catch(e){return this.onError("streamFactory rejection",e)}});this.ping=l(()=>this.request("ping",{serviceName:rr(),pid:w0.pid}),250);this.opts=y(y({},h2),i),this.stream()}onEnd(){return this.logger.info("end()",{ending:G(),timings:this.times.report(),pendingSize:this.pending.size}),this.pending.clear(),this.close()}addChangeListener(e){this.changeListeners.push(e)}get flapping(){return this.logger.tap({level:fe?"debug":"trace",msg:"flapping()",result:this.mkStreamRate.msSinceLastEvent<this.opts.delayBetweenRetries||ya(this.mkStreamRate.eventsPerMinute,3),meta:{msSinceLastStream:this.mkStreamRate.msSinceLastEvent,mkStreamRatePerMin:this.mkStreamRate.eventsPerMinute}})}broadcast(e,r){return this.request("broadcast",{event:e,args:r})}sendRecentLogs(){return this.request("sendRecentLogs")}async ready(){return this.ended?(this.logger.debug("ready(): false (ended)"),!1):await this.stream()!=null}async request(e,r){if(this.ended){if(G())return;throw new Error("client is ending")}if(S(e))throw new Error("method cannot be blank");return this.submit(e,r)}async submit(e,r){let i=await this.stream();if(i==null)return this.onError("submit("+e+"): stream is closed");let o=Bp(),n=new Ry(o,e,r,this.times);return n.setTimeout(this.opts.requestTTL),this.pending.set(o,n),n.d.finally(()=>this.pending.delete(o)),this.logger.log(fe?"debug":"trace","sending request",{id:o,method:e,params:r}),i.write(O({id:o,method:e,params:r})+`
`),n.response}close(){return this.logger.info("close()",{ended:this.ended}),b(this.stream.clear(),di)}onData(e){if(!S(e))try{this.logger.log(fe?"debug":"trace","onData()",{req:e});let r=JSON.parse(e);if(S(r.sid))throw new Error("response is missing server id");if(this.sid!==r.sid&&(this.sid!=null&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:r.sid}),Me.emit("rpcServerChange")),this.sid=r.sid,G()))return;if(r.id==null)if(P(r.event)){this.logger.trace("re-broadcasting event",r),Me.emit(r.event,r.args);return}else throw new Error("missing request id from response");let i=this.pending.get(r.id);this.pending.delete(r.id),i==null?this.logger.warn("unknown or stale request ID",{resp:r,pendingIds:[...this.pending.keys()]}):r.error!=null?(i.reject(r.error),this.logger.warn("Rejected",{resp:r,rr:i})):(i.resolve(r.result),this.logger.debug("Resolved",r.result))}catch(r){this.logger.warn("invalid input: "+e,r)}}async onError(e,r){return this.logger.warn(e+" onError(): "+f(r,i=>x(i.stack,i))),this.restart()}async restart(){if(this.logger.info("restart()",{ended:this.ended,flapping:this.flapping}),await this.close(),this.ended||G()){this.logger.warn("restart(): Ending. Rejecting new connection.");return}if(this.flapping){this.logger.warn("restart(): Too many recent errors, we'll try reconnecting again in a bit",{errPerMin:this.mkStreamRate.eventsPerMinute});return}let e=await this.stream();if(e!=null){let r=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+r.length+" jobs now."),r.forEach(i=>i.reject("restarting"+Na)),e}else{this.logger.warn("restart(): stream() returned null");return}}onFinish(e,r){if(this.ended)return;let i=r==null||r===!1;return this.logger.info("onFinish",{source:e,error:r,restarting:i}),i?this.restart():this.onError(e,r)}};var ky=d("RpcClient");function y2(t){let e=new Wt,r=new x0.default.Socket;return r.on("error",i=>e.reject(i)),r.connect(t,"localhost",()=>{ky.debug("Connected to "+t),e.resolve()}),e.then(()=>r)}var $n=l(()=>{if(_n())return;let t=c.rpcPort.valueOrDefault;ky.debug("Creating new RPC client to "+t);let e=new Oy("db@localhost:"+t,()=>y2(t));return e.addChangeListener(()=>Jn.unset()),e}),Jn=l(async()=>{try{if(_n())return!1;let t=await xe(f($n(),e=>e.ping()),M);return P(t)}catch(t){return ky.warn("rpcClientReady(): ping failed",t),!1}},E);var T0=T(require("process"));var b2=require("net"),ri=d("rpc.Server"),w2=({params:t,conn:e})=>(U(t.serviceName,r=>{S(e.serviceName)&&(e.serviceName=r)}),we(t.pid,r=>{S(e.pid)&&(e.pid=r)}),`pong to ${e.serviceName}@${e.pid} from ${rr()}@${T0.pid} at ${new Date}`),v0=class{constructor(e){this.socket=e}toString(){return S(this.serviceName)?Tn(this.socket):`${this.serviceName}:${this.pid}`}},_y=class{constructor(e,r=!0){this.port=e;this.unref=r;this._ended=!1;this._ready=new Wt;this.connections=[];this.onPause=()=>this.broadcast("pause");this.onResume=()=>this.broadcast("resume");this.handlers=new Map;this.sid=l(()=>Pn.randomChars(12));this.start=Lm(async()=>{if(!this.ended)return ri.debug("start("+this.port+")"),this.server=b2.createServer(this.onConnect.bind(this)),this.server.on("listening",()=>{ri.info("listening on "+this.port),this._ready.resolve()}),this.server.on("error",async e=>{ri.warn("error, rejecting ready"),this._ready.reject(),await this.onError("createServer"+pe,e)}),this.server.listen(this.port,c.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise},5e3);this.end=l(async()=>{this._ended=!0,Me.removeListener("pause",this.onPause),Me.removeListener("resume",this.onResume),await this.closeAllConnections(),await Hc(this.server)});this.name="Server:"+e,this.addHandler("ping",w2),this.addSimpleHandler("broadcast",i=>(Me.emit(i.event,i.args),this.broadcast(i.event,i.args))),Ra(this.onPause),wn(this.onResume),um(this),d0(this)}get connectionCount(){return this.connections.length}async serialize(e){return O(y({sid:this.sid()},e))+`
`}addHandler(e,r){let i=this.handlers.get(e);i!=null&&ri.warn("addHandler(): overwriting",{method:e,prior:i,newHandler:r}),this.handlers.set(e,r)}addSimpleHandler(e,r){this.addHandler(e,({params:i})=>r(i))}addSimpleHandlers(e){Ze(e).forEach(([r,i])=>this.addSimpleHandler(r,i))}get ended(){return this._ended||G()}get ready(){return this._ready.promise}closeAllConnections(){let e=this.connections.map(r=>di(r.socket));return this.connections.length=0,Promise.all(e)}broadcast(e,r){return this.sendAll({event:e,args:r})}async sendAll(e,r="write"){let i=await this.serialize(e),o=[...this.connections],n=o.length;ri.debug("sendAll()",{pojo:e,method:r});for(let s of o)try{s.socket.writableEnded?n--:s.socket[r](i,()=>n--)}catch{n--}return je(()=>n<=0,{timeoutMs:M})}onConnect(e){ri.info("Connection from "+Tn(e)),this.unref&&e.unref();let r=new v0(e);this.connections.push(r),e.on("end",()=>{ri.info("Closing connection from "+Tn(e)),wt(this.connections,i=>i.socket!==e)}),e.on("error",async i=>{ri.warn("on error from "+Tn(e)+": "+i),await this.onError("socket",i),e.end()});try{An(e,`
`,i=>this.onRequest(i,r))}catch(i){ri.warn("Caught error from "+Tn(e)+": "+i),e.end()}}async onRequest(e,r){if(ri.debug("onRequest()",e),S(e))return;let i="missing",o="missing";try{let n=JSON.parse(e);return U(n.id,s=>i=s),U(n.method,s=>o=s),await rt("rpc."+o,()=>this.handle(i,o,n.params,r))}catch(n){ri.warn("invalid request",{line:e,error:n}),r.socket.write(await this.serialize({id:i,error:x(n.message,()=>h(n))}))}}async handle(e,r,i,o){let n=this.handlers.get(r);if(n==null)throw ri.warn("bad handler request",{method:r,params:i,supported:vt(this.handlers)}),new Error("No handler for "+r);let{elapsedMs:s,result:a}=await bi(()=>n({id:e,method:r,params:i,conn:o}));ri.log(tl(s,M),"handle()",{method:r,conn:h(o),elapsedMs:s,id:e,params:i,result:a}),o.socket.write(await this.serialize({id:e,result:a}))}async onError(e,r){this.ended||X(e,r)}};var Su=!1;function Ar(){return Su}function Mu(){Su||(Su=!0,Zx())}function Pu(){Su&&(Su=!1,fm(),eT())}var S0=T(require("fs-extra")),Cp=T(require("os")),Ny=T(require("process"));var x2=l(async()=>{if(c.forceOpen.valueOrDefault){let t=At();t!=null&&await $a(async()=>Promise.all(A(await M0(t)).map(e=>e.unlink())),7*M)}}),P0=Ot;function T2(t){return f(t,e=>e.join("opened-by"))}function M0(t){return T2(t)?.clear().children(r=>r.ext===".json")}async function E0(){return $(At(),async t=>Ud(Vp(t),By(),"hostname","pid"),async()=>!1)}var By=l(async()=>({hostname:(0,Cp.hostname)(),pid:Ny.pid})),Vp=Bi(t=>v2(t),{maxSize:3,timeoutMs:H,clearEveryMs:mr(7*M,H)});async function v2(t){await x2();let e=!Hm(),r=d("currentLibraryLockOwner("+t+")"),i=(0,Cp.hostname)(),o=await M0(t);if(R(o)){r.warn("no opened-by files found.");return}let n=await vs(o.map(async Z=>{let ar=await Z.readJson();if(e&&ar==null&&await Z.modifiedCloseTo(Date.now(),H)!==!0){r.warn("unlinking old empty json file: "+Z),await Z.unlink("debug");return}else return y({file:Z},ar)}));r.debug("read",{jsons:n});let s=Date.now()-P0,[a,m]=Pa(n,Z=>Z.updatedAt>s);e&&_(m)&&(r.debug("Unlinking expired opened-by files:",{minUpdatedAt:s,staleJsons:m}),await Promise.all(m.map(Z=>Z.file?.unlink("debug"))));let[u,p]=Pa(a,Z=>Z.hostname===i),g=u.map(Z=>Z.pid),v=x(await Nv(g),g),[D,W]=Pa(u,Z=>v.includes(Z.pid));e&&_(W)&&(r.debug("Unlinking zombie opened-by files:",W),await Promise.all(W.map(Z=>Z.file?.unlink())));let Ae=[...D,...p];if(R(Ae)){r.debug("No valid opened-by files.");return}let sr=Ii(Ae,Z=>Z.createdAt),Ye=Ae.filter(Z=>Z.systemUID===sr.systemUID),J=Ii(Ye,Z=>[zS(Z.serviceName),x(Z.createdAt,()=>Date.now())]);return r.tap({msg:"currentLibraryLockOwner",level:"info",result:J})}q(()=>Vp.clear());var Cy=class extends lt{constructor(e){super("OpenedByIO()",()=>this.onEnd(),ue.postdb);this.ldd=e;this.createdAt=Date.now();this.watchers=[];this.intervalMs=P0/4;this.file=l(()=>this.dir.join(En((0,Cp.hostname)(),7)+"-"+Ny.pid+".json"));this.json=l(async()=>y({serviceName:rr(),createdAt:this.createdAt,updatedAt:Date.now()},await By()),this.intervalMs/2);this.write_=l(async()=>{let e=await this.json();await this.file().writeJSON_(e),Vp.clear()},this.intervalMs/2);this.setup=l(async()=>{if(await this.write_(),Nr())for(let e of this.file().selfAndParents(4))try{let r=(0,S0.watch)(e.nativePath,{persistent:!1,recursive:!1},()=>this.lockOwner.refresh()).on("error",i=>(this.logger.warn("watch().on(error):",i),this.lockOwner.refresh()));this.watchers.push(r)}catch(r){this.logger.warn("Failed to set up watch",{f:e.nativePath,err:r})}});this.lockOwner=l(async()=>{if(!G())return await this.setup(),Vp(this.ldd)},7*M);this.dir=e.join("opened-by"),this.timer=Hr(()=>this.write_(),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write_.unset()}refresh_(){return this.clear(),this.write_()}async onEnd(){this.watchers.forEach(e=>e.close()),this.watchers.length=0,f(this.timer,clearInterval),this.timer=void 0,await this.file().unlink()}async deleteAllLocks(e=!1){e?await this.dir.rmrf():await this.dir.visitDescendants(r=>r.eql(this.file())?void 0:r.unlink())}async isLockOwner(){return Ud(this.lockOwner(),By(),"hostname","pid")}async throwIfUnavailable(e){this.logger.debug("throwIfAvailable()",{from:e});let r=await this.lockOwner();if(this.logger.debug("throwIfAvailable()",{from:e,lockOwner:r}),r==null)return;let i=await this.json();if(this.logger.debug("throwIfAvailable()",{from:e,json:i}),r!=null&&r.hostname!==i.hostname)throw this.logger.warn("library is unavailable",{lockOwner:r,json:i}),new Error(`Library is already opened by ${r.hostname} (${r.serviceName}:${r.pid}) ${e}`+(ll()?"":pe)+Gr+$t)}};var zp,Rl=l(()=>d("Vacuum"));function Eu(t){return t==null||t.schema==="models"?L(zp):!1}var D0=async t=>{typeof t!="boolean"&&Rl().throw("invalid setVacuuming argument",{value:t}),Rl().debug("setVacuuming()",{value:t}),zp=t};sT(D0);async function A0(){return b($n()?.request("isVacuuming"),t=>(Rl().info("checkRemoteVacuuming() received RPC value",{value:t}),f(t,D0)))}async function Vy(t){if(!await E0()){Rl().info("withVacuumEvent(): no-op, I'm not the lock owner.");return}Rl().info("db vacuum starting...");try{return zp=!0,yr("vacuuming",!0),await t()}finally{zp=!1,yr("vacuuming",!1),Rl().info("db vacuum finished.")}}var Lu=T(require("process"));function F0(t){return t!=null&&_(t.warn)||zy(t)}function zy(t){return t!=null&&_(t.bad)||S2(t)}function S2(t){return t!=null&&_(t.fail)}function Uy(t){return{ok:A(t.ok),warn:A(t.warn),bad:A(t.bad),fail:A(t.fail)}}function Up(...t){t=F(t);function e(r){return K(F(ae(t.map(r))))}return{ok:e(r=>r.ok),warn:e(r=>r.warn),bad:e(r=>r.bad),fail:e(r=>r.fail)}}var Wy=T(require("process"));function qy(){let t=(0,Wy.memoryUsage)();return gn([t.external,t.heapUsed,t.arrayBuffers])}function L0(){return Fe(qy()/qe,2)}function jy(){return(0,Wy.memoryUsage)().rss}function I0(){return Fe(jy()/qe,2)}var M2=l(()=>new lt("memoryCheck on exit",()=>{let t=d("PromiseTimer"),e=R0();t.log(F0(e)?"warn":"info","memory use on exit:",e)},ue.service));function R0(){M2();let t=[],e=[],r=[];function i(o,n,s){if(!B(o))return X("memoryCheck(): invalid bytesUsed. "+O({bytesUsed:o,desc:s})+_a);let a=o/qe,m=`used by ${rr()} (${Ut(o,2)})`;a>=n?r.push(`${s} ${m} is high`):a>=n*.8?e.push(`${s} ${m} is high`):t.push(`${s} ${m} is OK`)}return i(qy(),c.maxMemoryMb.valueOrDefault,"Used memory"),i(jy(),c.maxRssMemoryMb.valueOrDefault,"RSS memory"),{ok:t,warn:e,bad:r}}function O0(){return!fe&&!c.scanAllDrives.valueOrDefault&&R(c.scanPaths.values)?{warn:["Nothing to scan: scanAllDrives is false and scanPaths is empty."]}:{}}async function Zo(){try{return Up(await Xo(),R0())}catch(t){return Uy({fail:[Rr(ce(t),"healthChecks failed")]})}}async function k0(){if(Ar()||G())return!0;let t=await Zo();return t==null||_(t.fail)||_(t.bad)||_(t.warn)}var G0=T(require("util"));var _0=T(require("knex"));var yo=(0,_0.default)({client:"sqlite3",useNullAsDefault:!0});async function Wp(t,e){let r=Date.now(),i=0,o=r+c.maxBusyDbMs.valueOrDefault;for(;Date.now()<o;)try{return await t()}catch(n){if(!gm(n)||Date.now()>=o)throw n;e?.(),await fr(mr(500,1500)*++i)}throw new Error("handleDbRetries(): timeout after "+c.maxBusyDbMs.valueOrDefault+"ms")}function qp(t,e=25){let r;for(let i=0;i<e;i++)try{return t()}catch(o){if(r=o,!gm(o))throw o}throw r}var Du=l(()=>d("Transactions")),P2=E,N0=10,jp=!1;async function Lt(t,e,r=!1,i=!1){if(t.db==null)throw new Error("tx(): null db");try{return r&&(jp=!0),!i&&Eu(t)&&await je(()=>!Eu(t),{timeoutMs:P2})==null&&Du().throw("Timeout while waiting for external vacuum to complete"),await gi(async()=>t.inTransaction?e(t.db):Wp(()=>t.db.transaction(()=>e(t.db)).deferred(),t.onRetry),{maxRetries:N0,errorIsRetriable:async o=>r||jp?!1:(Du().warn("errorIsRetriable()",o),gm(o)||uT(o)?(t.closeDb(),Du().warn("Trying to reopen the db "+t.dbfile),!0):!1),timeoutMs:c.maxBusyDbMs.valueOrDefault/10,onRetryWaitUntil:o=>{let n=mr(10,c.maxBusyDbMs.valueOrDefault/(N0-o));return Du().warn("onRetryWaitUntil()",{retryCount:o,delayMs:n}),fr(n)}})}catch(o){if(r||jp)return;throw Du().warn("tx(): raised",o),o}finally{r&&(jp=!1)}}var E2=".sqlite3";function en(t,e){return t.join(e,"db"+E2)}var B0,Mi=()=>B0;function C0(t){B0=t}function V0(){return f(At(),t=>en(t,"models"))}var Hy=new Map;function Gy(t){Hy.set(t.$ctor,t)}var D2=([t,e])=>t!=null&&e!=null;function z0(t,e){if(e==null)throw new Error("json is null");if(t!=null&&P(t.$ctor)&&!Hy.has(t.$ctor)&&Gy(t),e instanceof t)return e;let r=z(e.$ctor).flatMap(o=>Hy.get(o)).getOrElse(()=>t);if(e instanceof r)return e;let i=new r;return e==null?i:tn(i,e,K([t.tableName+".",r.tableName+"."]))}function tn(t,e,r=[]){let i=t.class();return vt(e).filter(n=>n!=="$ctor").filter(n=>e[n]!=null).map(n=>{let s=e[n];return r.forEach(a=>n=Ge(n,a)),Ao(i.booleanFields,n)?[n,L(s)]:[n,s]}).filter(D2).forEach(([n,s])=>t[n]=s),t}function U0(t){return t===null||Ao(["number","string"],typeof t)}function Ky(t){return t!=null&&Array.isArray(t)?t.every(Ky):Ze(t).every(([,e])=>U0(e))}function W0(t){return dn(t,(e,r)=>{if(!e.startsWith("$")){if(typeof r=="boolean")return[e,r?1:0];if(U0(r))return[e,r];if(uA(r))return[e,Si(r)]}})}function A2(t){return t!=null&&Rt(t.sql)&&(t.bindings==null||Ky(t.bindings))}function Hp(t){if(t==null)throw new Error("null sql");if(A2(t))return t;if(Rt(t))return{sql:t};if(ve(t.toSQL))return Gt(t.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+O(t))}function q0(t){return t.replace(/\s*--.*?\n/g,"").split(";").map(e=>e.replace(/\s+/g," ").trim()).filter(P)}var j0=fe?25:1e3,H0=l(()=>d("DbRequest")),Au=class{constructor(e,r){this.db=e;this.tableName=r;this.cachedStatements=new ke(256)}qb(){return yo(this.tableName)}prep(e,r,i=!1){let o=Hp(r);try{let n=this.cachedStatements.getOrSet((i===!0?"pluck:":"")+o.sql,()=>{let s=e.prepare(o.sql);return i===!0?s.pluck():s});return n.database.open?{sq:o,stmt:n}:(this.cachedStatements.clear(),this.prep(e,r,i))}catch(n){return H0().throw("prep() failed",{error:n,sqlQuery:o,retriable:!1})}}async wrap({q:e,pluck:r,m:i}){try{return await Lt(this.db(),o=>{let{sq:n,stmt:s}=this.prep(o,e,r),a=s[i].bind(s);return n.bindings==null?a():a(n.bindings)})}catch(o){if(String(o.message).includes("AdvisoryLock"))throw o;H0().throw(o,y({method:i},Hp(e)))}}run(e){return this.wrap({q:e,m:"run"})}async runScript(e,r=""){let i=XT("runScript()");for(let o of e){if(S(o)||o.trim().startsWith("--"))continue;await this.run({sql:o});let n=om(ur(o,60),r,"");i.elapsed(n)}}mapRun(e){return Lt(this.db(),r=>e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return $(o.bindings,s=>n.run(s),()=>n.run())}))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}updateOrIgnore(e){let r=Hp(e(this.qb()));return r.sql=r.sql.replace(/update /i,"UPDATE OR IGNORE "),this.wrap({q:r,m:"run"})}first(e){return this.wrap({q:e,m:"get"})}firstf(e){return this.wrap({q:e(this.qb()),m:"get"})}mapAll(e){return Lt(this.db(),r=>ae(e.map(i=>{let{sq:o,stmt:n}=this.prep(r,i);return $(o.bindings,s=>n.all(s),()=>n.all())})))}all(e){return this.wrap({q:e,m:"all"})}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}async batched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(j0),m:"all"}),_(r)&&await e.onResults(r);while(_(r)&&!G())}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}async pluckBatched(e){let r;do r=await this.wrap({q:e.qb(this.qb(),r).limit(j0),pluck:!0,m:"all"}),_(r)&&await e.onResults(r);while(_(r))}};var Jy=class{constructor(e,r){this.model=e;this.db=r;this.columnNames=l(()=>qp(()=>this.db().pragma(`table_info(${this.tableName})`).map(e=>e.name)));this.logger=d(`ModelOps(${e.tableName})`),Gy(e),this.dbl=new Au(this.db,e.tableName)}get dbOpen(){return $(this.db(),e=>e.open,()=>!1)}get tableName(){return this.model.tableName}query(){return this.model.query()}async toDbValued(e){let r=this.model.fromJSON(e),i=W0(r);return et(i,...await this.columnNames())}run(e){return this.dbl.run(e)}fromJSON(e){return b(e,r=>this.model.fromJSON(r))}async fromJSONs(e){return(await vs(e)).map(o=>this.model.fromJSON(o))}first(e){return this.fromJSON(this.dbl.first(e))}firstf(e){return this.first(e(this.query()))}all(e=this.query()){return this.fromJSONs(this.dbl.all(e))}allf(e){return this.all(e(this.query()))}findOne(e){return this.fromJSON(this.dbl.first(e))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e,r){return this.findOneBy(y(y({},r),{id:e}))}async findByIds(e){let r=await Lt(this.db(),async()=>le(Ea(A(e).filter(B),c.dbBatchSelectSize.valueOrDefault),i=>this.dbl.all(this.query().whereIn("id",i))));return te(await this.fromJSONs(ae(r)),i=>e.indexOf(i.id))}findBy(e){return this.all(this.model.queryBy(e))}findWhereIn(e,r){return this.all(this.model.query().whereIn(e,r))}rows(e){return this.count(x(e,()=>this.model.query()))}count(e){return Ee(this.dbl.pluckFirst(e.count()),()=>0)}countf(e){return this.count(e(this.query()))}async insert(e){return Lt(this.model.db(),()=>le(e,r=>this.insertOne(r)))}async upsertOne(e){return this.modelSupportsUpsert?(await this.upsert([e]))[0]:e.id==null?this.insertOne(e):this.updateOne(e)}async insertOne(e){if(e.id!=null)throw new Error("insert called for "+O(e)+$t);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames()),o=await this.dbl.runf(s=>s.insert(i)),n=await ws(k(o.lastInsertRowid),s=>this.findById(s),()=>{this.logger.throw("internal error: lastInsertedRowId was non-numeric",{runInfo:o})});return e instanceof this.model&&tn(e,n),n}async updateOne(e){if(e.id==null)throw new Error("update called for "+O(e)+$t);let r=this.model.fromJSON(e);r.$beforeUpsert();let i=r.$toDbJSON(await this.columnNames());return await this.dbl.runf(o=>o.where({id:e.id}).update(i)),r}get ucn(){return this.model.uniqueColumnName}get ucnFieldNames(){return x(this.ucn,"id").split(",")}get modelSupportsUpsert(){return this.ucn!=null&&this.ucn!=="id"}get ucnConstraint(){return`(${this.ucn})`}onConflictClause(e){let r=[...this.ucn.split(","),"id","createdAt"],i=e.filter(n=>!r.includes(n)).sort().map(n=>`${n}=excluded.${n}`).join(","),o=["ON CONFLICT",this.ucnConstraint];return S(i)?o.push("DO NOTHING"):o.push("DO UPDATE SET",i),o.join(" ")}async upsertDbJson(e){let r=this.query().insert(e).toSQL(),i=new Set;for(let n of e)for(let s of vt(n))i.add(s);let o={sql:`${r.sql} ${this.onConflictClause([...i.values()])}`,bindings:r.bindings};await this.run(o)}pickModelUcn(e){return et(e,...this.ucnFieldNames)}async reload(e){return await le(e,async r=>b(this.findOneBy(this.pickModelUcn(r)),i=>tn(r,i))),e}async upsert(e,r=!1){if(this.modelSupportsUpsert){let i=await this.columnNames(),o=await Lt(this.db(),async()=>pT(A(e),c.dbBatchUpsertSize.valueOrDefault,async n=>{let s=n.map(a=>this.model.fromJSON(a));return s.forEach(a=>a.$beforeUpsert()),await this.upsertDbJson(s.map(a=>a.$toDbJSON(i))),s}));return r?o:this.reload(o)}else return Lt(this.db(),()=>le(e,i=>this.upsertOne(i)))}async delete(e){return Oe(e.filter(B),r=>this.run(this.model.query().delete().whereIn("id",r)))}async batched(e){let r=c.dbBatchSelectSize.valueOrDefault,i,o;do i=await this.allf(n=>(n=e.qb(n),o!=null&&(n=n.andWhere("id",">",o)),n.orderBy("id","asc").limit(r))),_(i)&&(o=Math.max(...i.map(n=>n.id)),await e.onResults(i));while(_(i))}};var rn=class{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return this._logger==null&&(this._logger=d(this.tableName)),this._logger}static query(){return yo(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static ops(){return this._ops==null&&(this._ops=new Jy(this,this.db)),this._ops}static get dbl(){return this.ops().dbl}static async txOp(e){return Lt(this.db(),()=>e(this.ops()))}static async tx(e,r=!1){return Lt(this.db(),()=>e(this.dbl),r)}static rows(){return this.ops().rows()}static truncate(){if(Tt)throw new Error("rejecting attempt to truncate in prod");return this.dbl.run("DELETE FROM "+this.tableName)}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return h(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${x(this.id,this[this.class().uniqueColumnName])})`}logger(){return d(h(this.valueOf()))}[G0.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return z0(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}$toShallowJSON(){return this.$_toJSON(L)}$toDbJSON(e){let r=this.$_toJSON(Gw,!1);return P(e)?et(r,...e):r}toJSON(){return this.$_toJSON(L)}$_toJSON(e,r=!0){let i=this.class();return dn(this,(o,n)=>{if(!(n==null||!si(n)))return Ao(i.booleanFields,o)?[o,e(n)]:[o,n]},r?{$ctor:i.$ctor}:{})}upsert(e){return e!=null&&tn(this,e),this.class().ops().upsertOne(this)}$beforeUpsert(){}async reload(){return b(this.class().ops().findById(this.id),e=>tn(this,e))}delete(){return f(this.id,e=>this.class().ops().delete([e]))}};rn.schema="models",rn.db=Mi;var Fr=class extends rn{static touch(e){return Oe(A(e).filter(B),r=>this.dbl.runf(i=>i.whereIn("id",r).update("updatedAt",Date.now())))}toID(){return"updateCount"in this&&(this.updateCount=ws(this.updateCount,e=>e,1)),Ol(this)}get createdAtDate(){return we(this.createdAt,e=>new Date(e))}get updatedAtDate(){return we(this.updatedAt,e=>new Date(e))}$beforeUpsert(){if(this.createdAt==null&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this){let e=this;e.updateCount=ws(e.updateCount,r=>r+1,1)}}};function Ol(t){return f(t,e=>({id:e.id,v:Cw(e.updateCount,0)}))}var Gp=class extends Fr{static ping(e="ping"){return Gp.ops().upsertOne({name:e})}static async assertPing(e){let r=Date.now();try{if(Gp.db()==null)throw new Error("db is undefined");let i=await this.ping(e);if(this.logger().debug("assertPing()",{heartbeat:i}),Math.abs(r-i.updatedAt)>20*M)throw new Error("Heartbeat.updatedAt wasn't updated")}catch(i){throw new me({cause:i,message:"Failed to write to the library database"})}}},Fu=Gp;Fu.tableName="Heartbeat",Fu.uniqueColumnName="name";var F2=0;function K0(){return Date.now()<=F2}var kl=d("LibraryHealthChecks"),Xo=l(()=>L2(),15*M);function $y(){J0.unset(),Xo.unset()}function $0(){return $y(),Xo.refresh()}C(()=>{c.libraryPath.addListener($y),iT($0),nT($0),Nc($y)});async function L2(){if(K0())return{ok:["Library health checks are paused"]};if(!c.libraryPath.hasValue()&&!pt())return{ok:["Library isn't set up yet"]};let t=ht.instance();if(t==null)return pt()?{fail:["Missing library at "+c.libraryPath.value]}:{};if(t.isPendingSetup){t.ready.then(()=>Xo.unset());let a=Date.now()-t.start;return a<H?{ok:["Library is setting up..."]}:a<3*E?{warn:["Library is taking a long time to set up..."]}:{fail:["Library took too long time to set up."]}}else try{await t.ready}catch(a){return{fail:["Library setup failed: "+yi(a)]}}let e=[],r=[],i=[],o=[],n=[],s=async a=>{try{return await a()}catch(m){n.push(m),kl.warn("trap(): failed to run "+a.name+": "+Jt(m)),o.push(yi(m));return}};if(await s(()=>t.openedBy().throwIfUnavailable("(library health check)")),c.healthCheckExiftool.valueOrDefault&&await s(()=>qA()),c.healthCheckLibraryIsWritable.valueOrDefault&&await s(()=>J0().catch(a=>{throw new me({cause:a,message:"Cannot write to "+iu(),fatal:!0})})),I)try{let a=await Te.instance().version();S(a)&&o.push("PowerShell isn't working (can't get version).")}catch(a){n.push(a),o.push(`PowerShell isn't working (${yi(a)}).`)}if(c.healthCheckFreeSpace.valueOrDefault||c.healthCheckVolumes.valueOrDefault){let a=await s(()=>Dt());if(R(a))o.push("Failed to scan system volumes."+pe);else if(c.healthCheckFreeSpace.valueOrDefault)for(let m of await t.requiredFiles())try{let u=await m.file();if(u==null)continue;if(u.clear(),m.isDir&&!await u.isDirectory())o.push(`${m.desc}, ${u}, is missing`+pe);else if(_(a)){let p=Xm(a,u.nativePath);kl.debug("checkDir()",{dir:u.nativePath,desc:m.desc,bestVolume:p,vols:a.map(g=>g.mountpoint)}),p==null?u.isUNC?r.push(`${m.desc}, ${u}: cannot be monitored for sufficient free space. Consider using a mapped network drive instead.`):o.push(`${m.desc}, ${u}, doesn't seem to have a mountpoint (?!)`):p.available<c.minDiskFreeGb.valueOrDefault*Sr&&r.push(`Only ${Ut(p.available)} are available on ${p.mountpoint}.`)}}catch(u){n.push(u),o.push("Failed to check "+m.desc+": "+yi(u))}}return R(o)&&R(r)&&e.push("Library and support directories are OK"),P(Lu.env.TEST_FAIL)&&o.unshift(...Lu.env.TEST_FAIL.split(",")),P(Lu.env.TEST_WARN)&&r.unshift(...Lu.env.TEST_WARN.split(",")),c.healthCheckDb.valueOrDefault&&await s(()=>Fu.assertPing()),o.map(a=>X(a+_a)),Up({ok:e,warn:r,bad:i,fail:o},O0())}var J0=l(async()=>Qy(iu()),Ot);async function Qy(t){if(t==null)return kl.throw("copyExampleImageToLibraryDir(): undefined rootDir");let e=A(await ie.for(dr.Public()).join("images").children()).find(o=>o.name.startsWith("splash"));if(e==null)return kl.throw("copyExampleImageToLibraryDir(): missing validation image");t=ie.for(t);let r=t.join(".tmp-"+im(6)),i=r.join("write-test"+e.ext);try{await e.copyFile_(i);let o=await e.sha(),n=await i.sha();if(o!==n)return kl.throw("Failed to copy sample file to library. Is "+t+" writable?",{ignorable:!0});kl.debug(`Library root directory, ${t}, is writable`)}finally{await r.rmrf("debug")}}var I2=l(()=>d("RpcServiceHandlers")),Q0=l(()=>({libraryPath:()=>c.libraryPath.value,healthChecks:()=>Xo(),isVacuuming:()=>I2().tap({msg:"isVacuuming",result:Eu()}),mountpoints:()=>bt(),volumes:()=>Dt(),paused:()=>Ar()}));var Y0=l(()=>d("RpcServer")),X0=l(async()=>{if(!await _n())return;Y0().info("Setting up RPC...");let t=c.rpcPort.valueOrDefault,e=!0,r=new _y(t,e);return r.addSimpleHandlers(Q0()),await r.start(),Y0().info("RPC service serving port "+r.port),r});var Z0={broadcast:(t,e)=>he(X0(),r=>r.broadcast(t,e),()=>b($n(),r=>r.broadcast(t,e)))};var eIe=`
SELECT
  al1.name,
  al1.lockId
FROM
  AdvisoryLock AS al1
  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name
  AND al1.createdAt > al2.createdAt
WHERE
  al2.createdAt IS NULL
`.replace(/\s+/," "),Yy=class extends rn{static vacuum(e=30*E){return this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async currentAcquiredLocks(){return this.dbl.pluckAllf(e=>e.select("name").where({acquired:1}))}static async allLocks(){return this.dbl.pluckAllf(e=>e.select("name"))}static async withLocks({lockNames:e,f:r,timeoutMs:i}){let o=Date.now(),n={},s=Bp();this.logger().debug("withLocks()",{lockNames:e,lockId:s});let a=n.locks=e.map(u=>({name:u,lockId:s,acquired:0,createdAt:Date.now()}));await this.tx(u=>u.runf(p=>p.insert(a)));let m=l(()=>this.logger().warn("long wait time for",e));try{let u=await je(async()=>{let p=!0,g=await this.tx(v=>v.runf(D=>D.where({lockId:s}).update({acquired:1})),p);return g==null&&!Bf(o,5*M)&&m(),g!=null},{timeoutMs:i,timeBetweenMs:mr(5,500)});if(this.logger().info("withLocks()",{lockNames:e,acquired:u}),u){n.acquireMs=Date.now()-o;let p=await bi(async()=>r(s));n.result=p.result,n.runMs=p.elapsedMs}}finally{let u=await bi(()=>Yy.tx(p=>p.runf(g=>g.where({lockId:s}).delete())));n.releaseMs=u.elapsedMs,n.released=!0}return n}},_l=Yy;_l.tableName="AdvisoryLock",_l.uniqueColumnName="name,lockId";var Xy=(t,e)=>_l.withLocks({lockNames:t,f:e,timeoutMs:E}).then(r=>r.result),eF={withAdvisoryLocks:Xy};var Iu=T(require("luxon"));function tF(t,e,r=Iu.DateTime.DATETIME_MED){return Fl(t,i=>(U(e,o=>i=i.setLocale(o)),i.toLocaleString(r)))}var R2=/(\.\d\d\d)\d+/;function O2(t){if(!S(t))return z(Iu.DateTime.fromISO(t.replace(R2,(e,r)=>r),{setZone:!0})).filter(e=>e.isValid).orElse(()=>f(zr.fromISO(t),e=>e.middle.toDateTime())).get()}var k2=new Map;function rF(t,e="en-US"){return lr(k2,e,()=>new Intl.DateTimeFormat(e,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(Si(t))}function iF(t){return f(O2(t),gM)}var _2=/^\d{1,4}-\d{2}-\d{2}$/;function oF(t){return U(t,e=>Xi(()=>f(zr.fromISO(e),r=>r.intervalMs),()=>z(e.match(_2)).flatMap(()=>Iu.DateTime.fromISO(e)).filter(Dr).map(()=>xt).get(),()=>z(Iu.DateTime.fromISO(e)).filter(Dr).map(()=>0).get()))}function nF(t,e){return t.map((r,i)=>r*e[i])}function Zy(t,e){return t.map((r,i)=>{if(r.length!==e.length)throw new Error("misshaped matrix on row "+i);return gn(r.map((o,n)=>o*e[n]))})}var N2=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],B2=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];function C2(t){return f(h(t).match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),e=>[e[1],e[2],e[3]].map(r=>parseInt(r,16)))}function sF(t){return f(C2(t),Ru)}function aF(t){return`#${V2(t).map(e=>cr(e.toString(16),2,"0")).join("")}`}function Ru(t){return U2(z2(t))}function V2(t){return lF(q2(W2(t)))}function lF(t){return[t[0],t[1],t[2]].map(e=>Y(0,255,e))}function j2(t){return[Y(0,100,t[0]),Y(-100,100,t[1]),Y(-108,100,t[2])]}function z2(t){let e=lF(t).map(r=>r/255).map(r=>r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92);return Zy(N2,e)}var Nl={X:.95047,Y:1,Z:1.08883},eb=216/24389,Kp=24389/27;function U2(t){let[e,r,i]=nF(t,[1/Nl.X,1/Nl.Y,1/Nl.Z]).map(o=>o>eb?Math.pow(o,1/3):(Kp*o+16)/116);return[116*r-16,500*(e-r),200*(r-i)]}function W2(t){let[e,r,i]=j2(t),o=(e+16)/116,n=r/500+o,s=o-i/200,a=n*n*n,m=s*s*s,u=a>eb?a:(116*n-16)/Kp,p=e>8?Math.pow(o,3):e/Kp,g=m>eb?m:(116*s-16)/Kp;return[u*Nl.X,p*Nl.Y,g*Nl.Z]}function q2(t){return Zy(B2,t).map(e=>{let r=e<0?-1:1,i=e*r;return Xe(255*r*(i<=.0031308?12.92*i:1.055*Math.pow(i,1/2.4)-.055))})}function Qn(t,e){return wu({dims:[{value:t[0],min:0,max:100},{value:t[1],min:-80,max:80},{value:t[2],min:-80,max:80}],bitDepth:e})}function Bl(t,e){return hy(t,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:e})}function Jp(t,e){return H2({L:t[0],a:t[1],b:t[2]},{L:e[0],a:e[1],b:e[2]})}function H2(t,e){let r=1,i=.045,o=.015,n=t.L-e.L,s=t.a-e.a,a=t.b-e.b,m=Math.sqrt(t.a*t.a+t.b*t.b),u=Math.sqrt(e.a*e.a+e.b*e.b),p=m-u,g=s*s+a*a-p*p;return g=g<0?0:Math.sqrt(g),Math.sqrt((n/r)**2+(p/(1+i*m))**2+(g/(1+o*m))**2)}function mF(t,e){return Ii(t,r=>Jp(r,e))}var $p=require("sharp"),on=12,Yn=7;var G2=d("ImageHash"),K2=250,Cl=new ke(K2);q(()=>Cl.clear());pr(t=>P(t)?Cl.delete(t):Cl.clear());Oa((t,e)=>f(Cl.get(t),r=>Cl.getOrSet(e,()=>r)));var ea=8,uF={width:96,height:96};function J2(t){return Mh(BigInt("0b0"+t.map(e=>e===1?1:0).join("")))}function $2(t){let e=[[],[],[]];for(let r=0;r<t.length;r+=3){let i=Ru([t[r],t[r+1],t[r+2]]);e[0].push(i[0]),e[1].push(i[1]),e[2].push(i[2])}return e}function Q2(t){let e=c.greyscaleColorThreshold.valueOrDefault;for(let r of t)if(Math.abs(r[1])>e||Math.abs(r[2])>e)return!1;return!0}function cF(t){return 1<2?_t(t):_t([_t(t),Zd(t)])}async function Y2(t){let e=d("ImageHash("+t+")");try{let i=await jn(t,uF,!0);if(i==null){e.warn("Cannot build readable stream");return}if(await zi(t)==null){e.warn("Can't extract dimensions");return}let n=$p(i.nativePath).removeAlpha();i.isDescendantOf(await Zs())&&Di(await i.size(),2*qe)&&(n=n.trim(4)),n=n.resize(y(y({},uF),{fit:$p.fit.fill,kernel:$p.kernel.lanczos3,fastShrinkOnLoad:!0,withoutEnlargement:!0}));let{data:s,info:a}=await n.raw().toBuffer({resolveWithObject:!0}),m=ms(0,s.length,3,J=>Ru([s[J],s[J+1],s[J+2]])),u=Q2(m),p=Xd(m.map(J=>Qn(J,on)),Yn);if(!u&&c.includeSharpDominantColor.valueOrDefault){let J=await rt(`img.imageHash.stats ${t.ext.toUpperCase()}`,()=>n.stats()),Z=Qn(Ru([J.dominant.r,J.dominant.g,J.dominant.b]),on);p=K([Z,...p]).slice(0,Yn)}let g=$p(s,{raw:y(y({},a),{channels:3})}).resize({width:ea,height:ea}),{data:v}=await g.raw().toBuffer({resolveWithObject:!0}),D=$2(v),W=u?[cF(D[0]),0,0]:ye(3,J=>cF(D[J])),sr=(u?[D[0]]:D).map((J,Z)=>{let ar=W[Z];return J.map(Wr=>Wr>=ar?1:0)});if(u){let J=ye(ea*ea,()=>0);sr.push(J,J)}return{meanHash:J2(ae(sr)),isGreyscale:u,modes:p}}catch(r){e.warn("Failed to imageHash("+t.nativePath+")",r);return}}async function Vl(t){return Cl.getOrSet(t.nativePath,()=>bi(()=>rt(`img.imageHash${t.ext.toUpperCase()}`,()=>Y2(t))).then(({elapsedMs:e,result:r})=>G2.tap({level:tl(e,4*M),msg:"imageHash()",result:r,meta:{file:t.nativePath,elapsedMs:e}})))}var Ou=128,Qp=8;function fF(t,e){let r={};return wr(e.capturedAtLt,i=>r.capturedAtLt=i.toString()),wr(e.capturedAtGt,i=>r.capturedAtGt=i.toString()),wr(e.limit,i=>r.limit=i.toString()),Jm(`/api/t/${t}/assets`,r)}function pF(t,e){let r={};return wr(e.seed,i=>r.seed=i.toString()),wr(e.limit,i=>r.limit=i.toString()),wr(e.offset,i=>r.offset=i.toString()),Jm(`/api/t/${t}/child-tags`,r)}var He=Object.freeze({When:"When",Who:"Who",Where:"Where",What:"What",Camera:"Camera",Lens:"Lens",Albums:"Albums",Keywords:"Keywords",Type:"Type",FS:"fs"}),iRe=[He.When,He.Camera,He.Lens,He.Type,He.FS];var wRe=l(()=>d("Names"));var VRe=d("WhoTagger");var nn=String.fromCharCode(31),Yp="Library",hF=[{name:He.When,ordinal:1},{name:He.Albums,ordinal:2},{name:He.FS,ordinal:3},{name:He.Who,ordinal:4},{name:He.Camera,ordinal:5},{name:He.Lens,ordinal:6},{name:He.Keywords,ordinal:7},{name:He.Type,ordinal:8}];function dF(t){return f(t,e=>x(e.name,h(e)))}function X2(t){return t.map(dF)}function ii(t,e=nn){return X2(t).join(e)+(e===nn?e:"")}function gF(t){return pc(Xn(t))}function Xn(t,e=nn){return h(t).split(e).filter(P)}function yF(t){return ii(Xn(t))}var bo=l(()=>d("Migrations")),Z2=new RegExp(`^(${_i(Ti)}://.*?/)(.*)$`),eV=t=>z(t).filter(Rt).flatMap(e=>Z2.exec(e)).map(e=>e[1].toLowerCase()+e[2]).getOrElse(()=>t);function tV(t,e=on){return RA(t,e).map(r=>Bl(r,e))}function rV(t,e){return we(t,()=>f(tV(t,6)[e],r=>Qn(r,on)))}function iV(t){return t.endsWith(nn)?t:t+nn}function bF(t,e){R(e)&&bo().warn("mergeTags(): empty tagIds",{tagIds:e});function r(g){return t.prepare(g).run()}let i=new Map(t.prepare("SELECT id, _path FROM Tag WHERE id IN ("+e.join(",")+")").all().map(({id:g,_path:v})=>[g,v])),o=te(e.map(g=>{let v=i.get(g);return{id:g,path:v,base:gF(v)}}),g=>[g.base,g.path]);o.reverse(),bo().info("mergeTags()",{arr:o});let n=o[0],s=n.id;if(R(o)||!B(s)){bo().warn("mergeTags(): empty array, or missing winner",{arr:o,winner:n,winnerId:s});return}let a=o.slice(1);if(_(a)){let g=a.map(v=>v.id).join(",");r(`UPDATE OR IGNORE AssetTag SET tagId = ${s} WHERE tagId in (${g})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${g})`),r(`UPDATE OR IGNORE Tag SET parentId = ${s} WHERE parentId in (${g})`),r(`DELETE FROM AssetTag WHERE tagId in (${g})`),r(`DELETE FROM Tag WHERE id in (${g})`)}let m=t.prepare("select _path from Tag where id = :id").get({id:s})._path,u=Xn(m),p=t.prepare("SELECT id, _path FROM Tag WHERE id = :winnerId OR _path LIKE :like COLLATE NOCASE").all({winnerId:s,like:Ht(m,nn)+"%",winnerPath:m});for(let g of p){let v=ii([...u,...Xn(Ec(g._path,m))]);g._path!==v&&(bo().info("mergeTags(): repairing tag path",{ea:g,newPath:v}),t.prepare("UPDATE OR IGNORE Tag SET _path = :path, updatedAt = :updatedAt WHERE id = :id").run({id:g.id,updatedAt:Date.now(),path:v}))}return bo().tap({msg:"mergeTags()",level:"info",result:{winner:n,losers:a},meta:{tagIds:e,winnerPath:m}})}function wF(t){let e=t.prepare(["SELECT","rtrim(_path, char(31)) as path,","count(*) AS cnt,","group_concat(id) AS ids","FROM Tag","GROUP BY path","COLLATE NOCASE","HAVING cnt > 1"].join(" ")).all();for(let r of e)r.ids=F(h(r.ids).split(",").map(i=>k(i)));return Do(e,r=>r.path).reverse(),bo().tap({msg:"dedupeTags()",result:e.map(r=>bF(t,r.ids)),meta:{rows:e}})}var tb={lowercase_psnet_hostname:t=>{t.function("lowercase_psnet_hostname",{deterministic:!0},eV),t.transaction(()=>{t.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),t.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),t.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")})()},force_stable_channel:async()=>{try{await bl();let t=c.updateChannel.value;t!=="stable"&&(c.updateChannel.value="stable",await js(),bo().info("force_stable_channel(): reset updateChannel",{priorValue:t}))}catch(t){bo().error("force_stable_channel(): failed: "+t)}},numeric_captured_at:t=>{t.function("isoToLocal",{deterministic:!0},iF),t.function("isoToOffsetMinutes",{deterministic:!0},ay),t.function("isoToPrecisionMs",{deterministic:!0},oF),t.transaction(()=>{t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),t.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),t.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),t.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),t.exec("DROP INDEX asset_captured_at_geohash_idx"),t.exec("DROP INDEX assetfile_exifuid_idx"),t.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")})()},spread_modes:t=>{t.function("plucklabmodeb6",{deterministic:!0},rV),t.transaction(()=>{ye(Yn,e=>t.exec(`ALTER TABLE AssetFile ADD COLUMN mode${e} integer`)),t.exec("UPDATE AssetFile SET "+ye(Yn,e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`).join(", "))})()},normalize_asset_file_uris:t=>{t.function("normalizeURI",{deterministic:!0},rP),t.transaction(()=>{let e=t.prepare("SELECT normalizeURI(uri) AS nuri, count(*) AS cnt, GROUP_CONCAT(id) AS ids FROM AssetFile GROUP BY nuri HAVING cnt > 1").all(),r=[];for(let i of e){let o=h(i.ids).split(","),n=t.prepare("SELECT id, shown, version, updatedAt FROM AssetFile WHERE id in ("+o.join(",")+")").all(),s=st(n,m=>[m.shown,m.version,m.updatedAt]),a=n.filter(m=>m.id!==s.id);r.push(...a.map(m=>m.id))}for(let i of Ea(r,256))t.exec("DELETE FROM AssetFile WHERE id in ("+i.join(",")+")");t.exec("UPDATE AssetFile SET uri = normalizeURI(uri)")})()},dedupe_tag_paths:t=>{t.transaction(()=>wF(t))()},suffix_tag_paths:t=>(t.function("tag_path_suffix",{deterministic:!0},iV),t.transaction(()=>{wF(t),t.exec("UPDATE Tag SET _path = tag_path_suffix(_path)")})()),normalize_tag_paths:t=>{let e=t.prepare("SELECT id, _path FROM Tag WHERE _path LIKE '%' || char(31) || char(31) || '%'").all();bo().info("normalize_tag_paths():",{badTags:e});for(let r of e){let i=yF(r._path);bF(t,F([r.id,...t.prepare("SELECT id FROM Tag WHERE _path = ?").pluck().all(i)]))}},drop_tc_tables:t=>{let e=/^(ct|taf|tag_counts)_[a-z0-9]{6}$/i,r=t.prepare("SELECT name FROM sqlite_master WHERE type='table'").pluck().all(),i=r.filter(o=>e.exec(o)!=null);bo().info("drop_tc_tables()",{tables:r,victims:i});for(let o of i)t.exec("DROP TABLE "+o)}};var oV=`
CREATE TABLE IF NOT EXISTS migrations (
  id integer NOT NULL PRIMARY KEY, 
  name varchar(255) NOT NULL, 
  migration_time integer NOT NULL 
)
`;function nV(t){return t.name.includes("_nofk")}var rb=class{constructor(e,r,i){this.migrationsDir=e;this.db=r;this.fsMigrations=l(()=>this.migrationsDir.children(e=>e.ext===".sql"));this.migrationsInDatabase=l(()=>this.db.prepare("SELECT name from migrations").pluck().all());this.assertKnownMigrations=l(()=>{if(!No)return;let e=this.migrationsInDatabase().filter(r=>{let[i,o,n]=[r.slice(0,4),r.slice(4,6),r.slice(6,8)].map(a=>k(a)),s=new Date(i,o-1,n);return this.logger.debug("migration filter",{migrationName:r,migrationDate:s,gitDate:wh}),wh.getTime()<s.getTime()});if(_(e))throw new me({fatal:!0,doNotSend:!0,message:"PhotoStructure is not forward-compatible with newer libraries. Please upgrade to open this library",cause:new Error("Unknown migrations: "+e.join(","))})});this.logger=d("Migration("+O({schema:e.base,db:i.nativePath})+")"),r.exec(oV),this.addMigrationStmt=r.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}async apply(e){this.assertKnownMigrations();let r=await this.fsMigrations();if(r==null)throw new Error("no migration files found for "+this.migrationsDir);let i=[],o=this.migrationsInDatabase();for(let n of r)o.includes(n.name)?this.logger.debug("latest(): already applied "+n.base):(await f(e,s=>s(n)),await xe(this.applyMigration(n),5*E,()=>{throw new me({fatal:!0,ignorable:!1,message:"Migration "+n.name+" timed out."})}),i.push(n.base));return this.logger.info("up to latest!",{appliedMigrations:i}),i}async applyMigration(e){Xx(e.name);try{let r=Date.now(),i=(await e.readLines()).filter(s=>S(s)||s.trim().startsWith("--")),o=tb[e.name.replace(/^[\d_-]+/,"")],n=ve(o);if(R(i)&&n)throw new me({message:"empty migration "+e.name,fatal:!0});return n?await o.bind(tb)(this.db):await this.applySqlMigration(e),this.logger.debug("applyMigration() completed",{elapsedMs:Date.now()-r,codeMigration:n,migration:e.baseWithParent}),this.db.transaction(()=>{this.addMigrationStmt.run(e.name,Date.now())})()}catch(r){return this.logger.throw("Failed to apply migration "+e.baseWithParent,Jt(r))}}async applySqlMigration(e){let r=nV(e);try{let i=h(await e.readFile());if(S(i)){this.logger.error("Empty migration: "+e);return}r&&this.db.pragma("foreign_keys = OFF");for(let o of V(i.split(";")))try{this.db.exec(o)}catch(n){throw new me({cause:n,fatal:!0,message:`Failed to apply: ${o}`})}if(r){let o=this.db.pragma("foreign_key_check");if(_(o))throw this.logger.error("foreign_key_check failed",o),new Error("Foreign key checks failed during migration "+e.name)}}finally{r&&this.db.pragma("foreign_keys = ON")}}};var ob=T(require("path"));var ib=T(require("fs-extra"));function Xp(t){try{return z(t).filter(P).flatMap(ib.statSync).flatMap(e=>Number(e.size)).get()}catch{return}}var sV=require("better-sqlite3");function ku(t,e=c.dbTimeoutMs.valueOrDefault){let r;if(c.logSql.valueOrDefault){let i=d("SQLite("+t.split(ob.sep).slice(-2).join(ob.sep)+")"),o=ES();r=n=>i.log(o,n.replace(/\s{2,}/g," "))}return f(Xp(t),i=>{c.dbCacheSizeMb.tmpValue=Math.max(c.dbCacheSizeMb.valueOrDefault,Math.ceil(1.1*i/Zi)),d("mkdb("+t+")").info("Dynamically setting dbCacheSize to "+c.dbCacheSizeMb.value,{dbFileSize:i})}),aV(new sV(t,{fileMustExist:!1,readonly:!1,timeout:e,verbose:r}))}function aV(t){let e=['encoding = "UTF-8"',"threads = "+Y(1,4,yt()),"foreign_keys = ON","page_size = "+16*nh,"trusted_schema = 0","cache_size = -"+c.dbCacheSizeMb.valueOrDefault*Zi/1024,"locking_mode = NORMAL","journal_mode = WAL","busy_timeout = "+c.dbTimeoutMs.valueOrDefault,"synchronous = NORMAL","auto_vacuum = NONE"];return qp(()=>{for(let r of e)t.pragma(r)}),t}var xF=["-wal","-journal"];var ske=l(()=>d("SQLiteFiles"));function zl(t){return[t,...xF.map(e=>t.sibling(t.base+e))].filter(e=>e.clear().existsSync())}function TF(t,e,r=c.dbTimeoutMs.valueOrDefault){let i=ku(h(t),r);try{return e(i)}finally{i.close()}}async function vF(t,e,r=c.dbTimeoutMs.valueOrDefault){let i=ku(h(t),r);try{return await e(i)}finally{i.close()}}var Rke=require("better-sqlite3"),Zn=d("SQLite");async function SF(t,e){try{await e.parent().mkdirp_();let r=new Dn({path:h(t),op:"Backing up"},100);await vF(t,i=>i.backup(h(e),{progress({totalPages:o,remainingPages:n}){return r.onProgress((o-n)/o*100),100}}),H)}catch(r){throw new me({cause:r,fatal:!0,message:`Could not back up db ${t} -> ${e}`})}}var lV=[{integrity_check:"ok"}];function MF(t){try{let e=t.pragma("integrity_check");if(Ai(e,lV))return Zn.info("verifyDb("+t.name+"): OK"),!0;throw new Error(O(e))}catch(e){throw new me({cause:e,fatal:!0,retriable:!1,message:"verifyDb("+t.name+") failed"})}}function PF(t){try{return MF(t)}catch{return!1}}function nb(t){return TF(t,MF,H)}var EF=["wal_checkpoint(RESTART)","optimize"];function DF(t){Zn.warn("optimizeDb() starting...",t.name);for(let e of EF)t.pragma(e);Zn.warn("optimizeDb() finished.")}async function AF(t,e="recover",r=!0){let o=(await t.parent().join(e).mkdirpSync_()).join(t.base);Zn.info(`repairDbFile_(${t} -> ${o})`);try{let n=await BP(),s=3*qe+await t.size()*1.25,a=10*s,m=new Dn({path:h(t),op:"Repairing db"},s),u=new Wt,p=In(n,[t.nativePath,"."+e],5*E,{encoding:"buffer",maxBuffer:a});p.stdout.on("error",D=>X("sqlite "+e+" failed for "+t,new me({cause:D,fatal:r})));let g=In(n,[o.nativePath],5*E,{encoding:"buffer",maxBuffer:a});g.on("exit",()=>u.resolve()),p.stdout.on("end",()=>{g.stdin.end(EF.map(D=>"PRAGMA "+D+";").join(`
`))}),p.stdout.on("data",D=>{let W=D.length;m.incrProgress(W),g.stdin.write(D)}),await u,await nb(o),Zn.info(`repairDbFile_(): ${o} is valid, finishing repair.`);let v=await le(zl(t),D=>D.renameYMDHMS_("needed-repair"));return await le(zl(o),D=>D.mv_(t.parent())),v.find(D=>D.ext===".db"||D.ext.startsWith(".sqlite"))}catch(n){return Zn.throw("failed to recover DB via dump and restore. Please see <https://photostructure.com/faq/restore-db-from-backup/> "+pe,n)}}async function FF(t){if(await t.notExists())return;let e=await t.parent().join("version-backup").mkdirp(),r=await e?.childWithSameContents(t);if(e==null||r!=null)return r;let i=e.join(dM()+"-"+t.base);return await sb(t,i),i}async function sb(t,e){Zn.info("coldDbBackup(): copying "+t+" to "+e);let r=zl(t).filter(i=>!i.eql(t));await t.copyFile_(e),await le(r,i=>i.copyFile_(e)).catch(i=>Zn.warn("Failed to copy aux db files",i))}var _u=class extends lt{constructor(e,r,i=()=>{}){super("Db("+e+")",()=>this.closeDb(),ue.db);this.schema=e;this._dataDir=r;this._onMigration=i;this.endTimeoutMs=E;this.migrate=l(async()=>{let e=this.dbfile;if(this.db==null||e==null)throw new Error("Cannot migrate database: missing db");await this.maybeRepair();let r=l(async()=>(this._onMigration(),FF(e))),i=new rb(ie.for(dr.Migrations()).join(this.schema),this.db,e);return{appliedMigrations:await i.apply(r),migration:i}});this.onRetry=l(()=>this.closeDb(),c.maxBusyDbMs.valueOrDefault/4)}get datadir(){return x(this._dataDir,At())}get dbfile(){return en(this.datadir,this.schema)}get open(){return this._db!=null&&this._db.open}get inTransaction(){return this.open&&this._db?.inTransaction===!0}prepare(e){return this.db.prepare(e)}pragma(e,r){return this.db.pragma(e,r)}get db(){let e=this._db==null;if(!this.open){this.logger.info("setting up new db connection to "+this.dbfile,{priorWasNull:e});try{this.dbfile.parent().mkdirpSync_(),this._db=ku(this.dbfile.nativePath);let r=this._db.pragma("quick_check",{simple:!0});if(r!=="ok")throw new Error("Quick integrity check failed: "+r+pe)}catch(r){throw new me({cause:r,fatal:!0,message:"Failed to set up "+this.dbfile})}}return this._db}closeDb(){try{this._db?.open===!0&&(this.logger.info("closing db",this._db),this._db?.close())}catch(e){this.logger.warn("closeDb(): .close() failed",e)}this._db=void 0}async maybeRepair(){let e=!0;try{e=PF(this.db)}catch{e=!1}e||(this.logger.warn("maybeRepair(): database failed validation. Trying to restore with dump/load."),await this.repair_())}async vacuum(){await Vy(()=>this._vacuum())}async _vacuum(){try{await Wp(()=>{DF(this.db),this.db.exec("VACUUM")},this.onRetry)}catch(e){this.logger.warn("vacuum(): vacuum failed, trying to recover by dump-load",e),await this.repair_()}}async repair_(){this.logger.warn("repair_(): Attemping restore of "+this.dbfile),this.closeDb(),await Vy(()=>AF(this.dbfile)),this.logger.info("repair_(): Database restoration was successful!")}};var ta=class extends lt{constructor(e){super(e.name,()=>{f(this.timer,clearInterval),this.timer=void 0},x(e.rank,ue.first),()=>$(e._isEnded,r=>r(),()=>!1),e.endTimeoutMs);this.setup(e)}async setup(e){B(e.initialDelayMs)&&await gt(e.initialDelayMs),!this.ended&&(this.timer=Hr(e.callback,Math.round(e.intervalMs),...A(e.args)))}};var ab=class{constructor(e,r,i,o=bg()){this.seq=e;this.set=r;this.name=i;this.stamp=o}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return this.fromBasename(e.base)}static fromBasename(e){return f(this.parseRe.exec(e),r=>new ab(parseInt(r[2],10),parseInt(r[3],10),r[4],r[1]))}},Nu=ab;Nu.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;var Ul=class{constructor(e,r,i){this.dir=e;this.sets=r;this.seq=i;this.mods=l(()=>ye(this.sets,e=>Math.pow(2,e)).reverse())}static async for(e,r){return new Ul(e,r,x(await Ul.maxSeq(e),-1))}static async maxSeq(e){return _x([...A(await b(e.childNames(),r=>r.map(i=>Nu.fromBasename(i)?.seq)))])}set(e){return this.sets-this.mods().findIndex(r=>e%r==0)}next(e){let r=++this.seq;return new Nu(r,this.set(r),e)}async hanoiFiles(){let e=await this.dir.clear().childNames();return F(e?.map(r=>Nu.fromBasename(r)))}async validHanoiFiles(e){let r=await Ee(e,()=>this.hanoiFiles()),i=th(r,n=>n.set),o=[];for(let n of i.keys())f(st(i.get(n),s=>s.seq),s=>o.push(s));return o}async staleHanoiFiles(e){let r=await Ee(e,()=>this.hanoiFiles()),o=(await this.validHanoiFiles(e)).map(n=>n.seq);return r.filter(n=>!o.includes(n.seq))}async staleFiles(){return this.staleHanoiFiles().then(e=>e.map(r=>r.toFile(this.dir)))}};var Zp=T(require("process"));function Bu(){return Zp.stdout==null||Zp.stdout.destroyed||Zp.stdout.writableEnded}function lb(t,...e){Bu()||console.log(t,...e)}var R_e=1*Ot;var mb=class extends ta{constructor(e,r,i,o,n,s=()=>{},a=()=>{}){super({name:"DbBackup("+i+")",callback:()=>this.backup(),intervalMs:c.dbBackupIntervalMinutes.valueOrDefault*E,rank:ue.predb});this.db=e;this.isLockOwner=r;this.srcDbFile=i;this.backupsDir=o;this.replaceDir=n;this.beforeBackup=s;this.onBackupFinished=a;this.endTimeoutMs=E;this.mutex=new Yt;this.hanoi=l(()=>Ul.for(this.backupsDir,c.dbBackupsCount.valueOrDefault));cs()||this.onEnds.push(async()=>{await this.mutex.serial("DbBackup.end()",async()=>{Nr()&&lb("Verifying & backing up "+e.dbfile+"..."),await this._backup(!0),Nr()&&lb("PhotoStructure library db has been backed up to "+o+".")})})}backup(){return this.mutex.maybeRun("DbBackup.backup()",()=>this._backup())}async _backup(e=this.ended){if(!await this.isLockOwner()){this.logger.info("backup(): not lock owner, no-op.");return}if(!e&&!this.db.open){this.logger.warn("backup(): db is already closed.",this.db.name);return}if(await this.srcDbFile.clear().isEmpty()){this.logger.warn("backup(): db is missing.",this.srcDbFile.nativePath);return}try{this.logger.info("backup(): beforeBackup...",{srcDb:this.srcDbFile.nativePath,backupsDir:this.backupsDir.nativePath}),await this.beforeBackup(),e&&this.db.open&&(this.logger.info("backup(): closing db before backup..."),await this.db.closeDb());let r=this.srcDbFile.parent().join("backup",this.srcDbFile.base);this.logger.info("backup(): starting backup to "+r),await SF(this.srcDbFile,r),this.logger.info("backup(): backup taken. Verifying "+r),await nb(r),this.replaceDir!=null&&(this.logger.info("backup(): Copying to "+this.replaceDir),await sb(r,this.replaceDir));let i=await zl(r),o=await this.hanoi(),s=o.next("").toFilename();this.logger.info("backup(): Rotating files to "+this.backupsDir.join(s));for(let a of i)await a.mv_(this.backupsDir.join(s+a.base),{overwrite:!0});for(let a of await o.staleFiles())this.logger.info("backup(): removing stale backup "+a),await a.unlink();this.logger.info("backup(): finished successfully"),await this.onBackupFinished()}catch(r){this.logger.throw(r,{from:"DbBackup._backup() failed",fatal:!0,srcDb:this.srcDbFile.nativePath})}}};var LF=l(async()=>{let t=Wo().join("local-db");return await t.join("README.txt").writeTxt_(`
This folder is only used when your library is on a remote filesystem.

You will corrupt your library if you remove this directory while PhotoStructure is
running.

If you have any questions, please visit <https://photostructure.com/support/>.`),t});var IF=T(require("fs-extra"));var sn=11,es=3;var RF=l(()=>d("StatsDbDir"));var mV="sync-state-";async function ed(t=!0){let e=[];e.push(["Asset version",es]),e.push(["Asset file version",sn]),e.push(["Library path",c.libraryPath.value]);let r=Jr(O(e),10,tf),i=Wo().join(mV+r);return t&&(await(0,IF.mkdirp)(i.nativePath),await i.join("README.txt").applyIfEmpty_(o=>o.writeTxt_(`This folder holds state for library synchronization of

${c.libraryPath.value}

If you delete or modify the contents of this directory, you will need to
restart PhotoStructure. The next sync will rescan all your drives.

If you have any questions, please visit <https://photostructure.com/support/>.

`+e.map(([n,s])=>`${n}: ${s}`).join(`
`)).catch(n=>{RF().warn("Failed to write README to "+i,n)})),RF().info("Set up statsDbDir dir "+i)),i}var OF=l(async()=>new Intl.DateTimeFormat(await gf(),{month:"short"})),kF=l(async()=>{let t=await OF();return Mo(0,12,e=>t.format(new Date(2016,e,1))).map(e=>zt(e,"."))});q(()=>{OF.unset(),kF.unset()});function uV(t){return 1e4-t}function cV(t){return 13-t}function _F(t){return 13-t}function fV(t){return 33-t}function pV(t){return we(t,e=>({name:h(e),ordinal:uV(e)}))}async function ub(t){if(!!St(1,12,t))return f((await kF())[t-1],e=>({name:String(t),displayName:e,ordinal:cV(t)}))}function dV(t){return we(t,e=>({name:h(e),ordinal:fV(e)}))}async function NF(t){let e=h(c.tagYMD.valueOrDefault).toLowerCase();if(t==null||e===""||e==="off"||e.startsWith("disable"))return;let r=[He.When];if(e.startsWith("y")){let i=f(Jo(t),pV);if(i==null)return;r.push(i)}if(e.startsWith("ym")){let i=await f(Ko(t),ub);if(i==null)return r;r.push(i)}if(e.startsWith("ymd")){let i=f(Go(t),dV);if(i==null)return r;r.push(i)}return r}function BF(t,e,r){let[i,o,n,s,a]=hV(t),m=e,u=`(${i}*${m}*${m}+${o}*${m})%${r}`,p=`(${n}*${m}+${s})%${r}`;return`((${u})*(${p})+${a})%${r}`}var gV=[[353868013,472882027,479001599,517294153],[1012573,1230587,1355297,1572751],[756065159,812182027,899809343,989450477],[3959297,4514113,4823201,5133127],[573259391,666101999,694847533,746151647],[2275327,2770513,3073703,3511973],[173313197,182557181,203457869,222230231],[6054613,6189107,7752103,9852103]],CF=[1012573,1101689,1183811,1196089,1230587,1355297,1419641,1483733,1572751,2275327,2770513,3010349,3073703,3118691,3174823,3511973,3959297,4514113,4690451,4823201,5133127,5375327,6019889,6054613,6189107,7752103,7752103,9852103];function yV(t){return Ph(mg,t,ug).map((r,i)=>gV[i][r])}var hV=Hf(t=>{let[e,r,i,o,n,s,a,m]=yV(t%cg),u=[e/r,i/o,n/s,a/m].map(p=>Fe(p,7));return u.push(CF[t%CF.length]),u},{maxSize:128,ttlMs:E});var cb=class{constructor(e){this.id=e}nextAssetBatch(e){let r={};return f(e,i=>r.capturedAtLt=i.getTime()),Jm(`/tag-gallery/${this.id}`,r)}};var ra=T(require("path"));var QNe=Ce.lift(t=>t.isFile()),YNe=Ce.lift(t=>t.isReadable());function Cu(t){return Ce.lift(async e=>he(ot(e,!1),t,()=>!1))}function VF(t){return Cu(e=>xc(...t.map(r=>e[r])))}var bV=Ce.lift(async t=>{let e=await Gs(t);if(e==null||!e.startsWith("image/")&&!e.startsWith("video/"))return!1;let r=e.startsWith("video/")?c.minVideoDimension.valueOrDefault:c.minImageDimension.valueOrDefault;return he(El(t),i=>Fi(i.ImageWidth,r)&&Fi(i.ImageHeight,r),()=>!1)}),wV=Ce.lift(async t=>{let e=await Gs(t);if(e==null)return!1;if(!e.startsWith("video/"))return!0;let r=await ot(t,!1);return r==null?!1:Fi(wl(r),c.minVideoDurationSec.valueOrDefault)}),xV=VF(["MIMEType"]),TV=VF(["Make","Model"]),vV=Cu(t=>k(t.Rating,{defaultValue:0})>=0),XNe=Cu(t=>Ao(["image/jpeg","image/png"],h(t.MIMEType))),SV=Cu(t=>h(t.MIMEType).startsWith("image/")),MV=Cu(t=>h(t.MIMEType).startsWith("video/")),PV=SV.and(TV).or(MV);async function EV(t){return!S(t)&&(gp(t)||Wn(t)||ir(t)&&await du()||$s(t)&&await xp())}var DV=Ce.lift(async t=>he(Gs(t.nativePath),EV,()=>!1)),fb=Ce.lift(async t=>!tu(t.nativePath)),zF=Ce.lift(async t=>Mt(Bn(t))),UF=Ce.lift(async t=>he(t.size(),e=>St(c.minAssetFileSizeBytes.valueOrDefault,c.maxAssetFileSizeBytes.valueOrDefault,e),()=>!1)),ZNe=Ce.andLogged(d("fileFilterNoStat"),{exifExtFilter:Ap},{notHiddenCheap:fb}),eBe=Ce.andLogged(d("fileFilterCheap"),{exifExtFilter:Ap},{notHiddenCheap:fb},{noMediaFilter:zF},{fileSizeFilter:UF}),AV=l(()=>F([{exifExtFilter:Ap},{fileSizeFilter:UF},{notHiddenCheap:fb},{noMediaFilter:zF},{hasMimeType:xV},{supportedMimeTypeFilter:DV},c.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:PV}:void 0,{notRejected:vV},{minDimensionsFilter:bV},c.minVideoDurationSec.valueOrDefault>0?{minVideoDurationFilter:wV}:void 0])),WF=l(()=>Ce.andLogged(d("fileFilterExpensive"),...AV())),tBe=Ce.lift(async t=>S(t.ext)),rBe=Ce.lift(async t=>t.isDirectory());function pb(t,e){for(let r of e){let i=t[r];if(P(i))return r+":"+h(i).trim()}}function qF(t){return pb(t,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"])}function jF(t){{let e=pb(t,["LensSerialNumber","LensID"]);if(e!=null)return e}return f(Lp(t),({lensMake:e,lensModel:r})=>`${e.toLowerCase()}/${r.toLowerCase()}`)}function HF(t){return pb(t,["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"])}var GF=[{ms:qw,s:"year",p:"years"},{ms:30.4*xt,s:"month",p:"months"},{ms:Ww,s:"week",p:"weeks"},{ms:xt,s:"day",p:"days"},{ms:Ot,s:"hour",p:"hours"},{ms:E,s:"minute",p:"minutes"},{ms:M,s:"second",p:"seconds"}];function an(t,e=2,r){if(!ac(t))return ne(t)?"-"+an(Math.abs(t),e):"";let i=GF.findIndex(s=>s.ms<=t);if(i===-1)return"";let o=t,n=F(GF.slice(i,i+e).map(s=>{if(!(s.ms>o)){let a=Math.floor(o/s.ms);return o-=a*s.ms,{i:a,s:kc(a,s.s,s.p)}}}));return R(n)?"":n.map(s=>s.s).join(", ")+$(r,s=>" "+(n[n.length-1].i!==1?s.singular:s.plural),"")}var BBe=l(()=>d("FilePathTagger"));function KF(t){let e=Zm(t),r=e.scheme===so?Yp:e.authority,i=e.path.split("/").slice(0,-1);return V([He.FS,r,...i])}var db=class extends Fr{constructor(){super(...arguments);this.posixFile=l(()=>oe.forUri(this.uri,this.mountpoint))}static async recentAssetIdsByUriRoot(e,r,i=64){let o=Date.now()-r,n=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",o).andWhere("Asset.shown",1).andWhere("Asset.hidden",0);return P(e)&&(n=n.andWhere("AssetFile.uri","like",e+"%")),n=n.orderBy("AssetFile.updatedAt","desc").limit(i),this.logger().debug("recentAssetIdsByUriRoot",n.toSQL()),this.dbl.pluckAll(n)}static assetCountByMimetype(e){let r=this.query().select(yo.raw("mimetype, count(*) as count")).join("Asset","Asset.id","AssetFile.assetId").where("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0);return P(e)&&(r=r.andWhere("uri","like",e+"%")),r=r.groupBy("mimetype").orderBy("mimetype"),this.dbl.all(r)}static async assetCountByMimetypeRoot(e){let r=await this.assetCountByMimetype(e);return xr(K(r.map(o=>o.mimetype.split("/")[0]))).map(o=>({mimetypeRoot:o,count:wa(r,n=>n.mimetype.startsWith(o+"/")?n.count:0)}))}static children(e,r){let i=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${_i(e)}/[^/]+$}`);return this.ops().all($(r,o=>o(i),()=>i))}get capturedAtDateTime(){return Vf(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return tF(this.capturedAtDateTime,e)}static outdatedQuery(e){let r=this.query().where("version","<",sn).orderBy("id");return R(e)?r:r.andWhere(i=>i.whereIn("mountpoint",e).orWhereNull("mountpoint"))}static async nextOutdated(e=jr){return this.ops().findOne(e(this.outdatedQuery(await bt())))}static async outdatedCount(e=jr){let r=this.outdatedQuery(await bt());return this.dbl.pluckFirst(e(r.count("id")))}static async setShown(e,r){if(this.logger().info("setShown()",{assetId:e,assetFileId:r}),!B(e)||!B(r))throw new Error("setShown(): invalid IDs: "+O({assetId:e,assetFileId:r}));await this.dbl.runf(n=>n.update("shown",0).where("assetId",e));let i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),o={assetId:e,assetFileId:r,updatedAt:Date.now()};return this.dbl.run({sql:i,bindings:o})}static async findByAsset(e,r){let i=this.query().select("AssetFile.*");return f(Li(e),o=>i.join("Asset","Asset.id","AssetFile.assetId").where(dn(o,(n,s)=>["Asset."+n,s]))),f(Li(r),o=>i.where(dn(o,(n,s)=>["AssetFile."+n,s]))),this.ops().all(i)}get modes(){return F(ye(Yn,e=>this["mode"+e]))}set modes(e){ye(Yn,r=>this["mode"+r]=e[r])}async matchesFile(e){if(this.version==null||this.version<sn||c.forceSync.valueOrDefault)return!1;let r=await this.fileFields(e);return Bx(r,this)}fileFields(e){return Pt(e).orElse(()=>this.posixFile()).filter(r=>r.exists()).flatMap(async r=>({uri:await r.uri(),fileSize:await r.size(),mtime:await r.thisOrSidecareMaxMtimeMs()})).filter(bc).get()}isVersionUpToDate(){return ji(this.version,sn)}async siblingCount(){return db.dbl.pluckFirstf(e=>e.count().where({assetId:this.assetId}).andWhereNot({id:this.id}))}async upsertIfNeeded(){let e=c.forceSync.valueOrDefault;if(await this.matchesFile()&&B(this.id)&&!e)return this.upsert();if(await this.isFileDeleted()){this.deleted=!0,await this.delete();return}if(!await this.notExists())return b(this.updateFromFile(),()=>this.upsert())}async maybeUpdateStats(e){return b(this.fileFields(e),r=>Fa(this,r))}async updateFromFile(e){let r=Date.now(),i=this.logger().addContext(".updateFromFile()");if(i.debug("before",this),this.id!=null&&await this.matchesFile(e)){i.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");return}if(e!=null&&await this.setFile(e),e==null&&(e=await this.posixFile()),e==null||await e.notExists()){i.info("no-op, "+e+" is missing");return}if(this.mountpoint==null&&await b(e.mountpoint(),g=>this.mountpoint=g.nativePath),await this.maybeUpdateStats(e)==null){i.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});return}let o=e.sha(),n={},s=await Tu(e);if(s==null){i.error("missing tags for "+e);return}if(S(s.MIMEType)){i.error("missing MIMEType for "+e);return}n.mimetype=s.MIMEType;let a=s.capturedAt,m=a.toLocal();if(m==null)return i.throw("bad CapturedAt",a);n.capturedAtLocal=m,n.capturedAtOffset=a.toOffset(),n.capturedAtPrecisionMs=a.toPrecisionMs(),n.capturedAtSrc=a.src,f(s.exposureSettings,g=>{n.focalLength=g.focalLength,n.aperture=g.aperture,n.shutterSpeed=g.shutterSpeed,n.iso=g.iso});let u=s.dimensions;if(n.width=u.width,n.height=u.height,n.rotation=s.rotation,n.make=s.Make,n.model=s.Model,n.cameraId=qF(s),n.imageId=f(HF(s),h),n.lensId=jF(s),n.geohash=OA(s.GPSLatitude,s.GPSLongitude),n.durationMs=f(s.duration,g=>Math.round(g*1e3)),n.fps=f(mi(s.VideoFrameRate),Xe),n.sha=await o,n.sha==null){i.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri});return}(c.useImageHashes.valueOrDefault||c.strictDeduping.valueOrDefault)&&await b(Vl(e),g=>{n.meanHash=g.meanHash,n.modes=g.modes}),Fa(this,n),this.version=sn;let p=Date.now()-r;return i.log(p>M?"info":"debug","after ("+p+"ms)",this),this}async updateFromShaSibling(e){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:e.sha==null||!e.isVersionUpToDate()||this.sha!=null&&e.sha!==this.sha?this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e}):(Fa(this,Gt(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt")),this)}async getAsset(){return this.assetId==null||this.asset!=null?this.asset:this.asset=await Ie.ops().findById(this.assetId)}async exists(){return he(this.posixFile(),e=>e.exists(),()=>!1)}async notExists(){return Mt(this.exists())}async isFileDeleted(){return he(this.posixFile(),e=>e.isDeleted(this.uri),()=>!1)}async isFiltered(){return Pt(this.posixFile()).filter(e=>e.exists()).flatMap(e=>WF().apply(e)).map(e=>!e).getOrElse(()=>!1)}async hasNoMedia(){return he(this.posixFile(),e=>e.hasNoMedia(),()=>!1)}async setFile(e){let r=await e.uri();if(r==null)return this.logger().throw("setFile(): no URI for "+e);let i=await e.mountpoint();if(i==null)return this.logger().throw("setFile(): no mountpoint for "+e);if(this.uri!=null&&!await iP(r,this.uri))return this.logger().throw("setFile(): cannot reassign non-equivalent URI",{prior:this.uri,new:r,file:e.nativePath});if(await e.uriObject()==null)throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);return this.uri=r,this.mountpoint=i.nativePath,this.posixFile.set(Promise.resolve(e)),r}nativePath(){return b(this.posixFile(),e=>e.nativePath)}toCapturedAt(){return f(Vf(this.capturedAtLocal,this.capturedAtOffset),e=>b(this.posixFile(),r=>new Il(r.nativePath,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}async downloadables(e,r){try{let i=await this.posixFile();if(i==null)return[];let o=e.ap(this.assetId),n=[];if(await i.isNonEmpty()&&n.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:Dy(i,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:i.base,description:"Download original",details:`(${Zr(this)} ${i.ext})`}),this.isVideo||!(L(this.shown)||this.sha===r))return n;let a=F(await Promise.all([...await o.previews()].reverse().filter(m=>m.reducer===Nt.fit).map(m=>p0(i.base,m))));return n.push(...Ji(a,m=>m.size)),n}catch(i){return X("AssetFile.downloadables failed",i,{context:this}),[]}}async pathInfo(){try{let e=Ne.parse(this.uri),r=await qs(e,this.mountpoint);if(r==null){this.logger().warn("pathInfo(): failed to build nativePath",{uri:this.uri});return}let i=e.fsPath,o=zt(r,i).split(ra.sep),n=o.pop(),s=i.split(ra.sep),a=KF(e),m=await ge.findByPath(a);if(m==null){this.logger().warn("pathInfo(): failed to find existing Tag",{tagPath:a});return}let u=await m.toApiPathElements();this.logger().info("pathInfo()",{uri:this.uri,fsPath:i,nativePath:r,mountpointParent:o,pathAfterMountpointParent:s,mountpointName:n,tag_path:m.path,pathElements:u}),u.shift(),S(n)?u.shift():u[0].displayName=n,s.splice(0,u.length);let p={nativePath:r,nativePathPrefixWbr:Da(o.join(ra.sep)+ra.sep),pathElements:u,nativePathSuffix:s.join(ra.sep),pathSep:ra.sep,exists:await this.exists()};return this.logger().info("pathInfo()",{result:p}),p}catch(e){this.logger().warn("pathInfo(): failed",e);return}}async toApi(e,r){return b(this.pathInfo(),async i=>ps(y(y({assetId:this.assetId,assetFileId:this.id},i),{mimetype:this.mimetype,shown:L(this.shown),width:this.width,height:this.height,rotation:x(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:await this.downloadables(e,r),createdAtLocale:JF(this.createdAt),updatedAtLocale:JF(this.updatedAt)})))}get isVideo(){return ir(this.mimetype)}},Re=db;Re.tableName="AssetFile",Re.uniqueColumnName="uri",Re.booleanFields=["shown"];function JF(t){return f(t,e=>an(Date.now()-e,1)+" ago")}var Ur=class extends rn{$pk(){return[x(this.assetId,()=>f(this.asset,e=>e.id)),x(this.tagId,()=>f(this.tag,e=>e.id))].join(":")}static addTagsToAsset(e,r){let i=Nd(e);if(i==null){this.logger().warn("addTagsToAsset(): got null assetId");return}let o=F(r.map(Nd));if(R(o)){this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:r});return}let n="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+o.map(s=>`(${i},${s})`).join(",");return this.dbl.run(n)}static removeTagsFromAsset(e,r){r=F(r);let i=this.query().whereIn("tagId",r).andWhere({assetId:e}).delete();return this.dbl.run(i)}};Ur.tableName="AssetTag",Ur.uniqueColumnName="assetId,tagId";function td(t){return{id:t.id,at:t.capturedAtLocal}}var hb=class{constructor(e,r,i,o){this.tags=e;this.before=r;this.after=i;this.limit=o;this.logger=()=>d("TaggedAssetStream("+this.toString()+")");this.logger().info("new",this.toJSON())}vacuum(){Do(this.before,e=>[-e.capturedAtLocal,-e.id]),px(this.before,this.limit),Do(this.after,e=>[-e.capturedAtLocal,-e.id]),Sc(this.after,this.limit)}toString(){return this.tags.map(e=>e.path.join("/")).join(",")}valueOf(){return this.toString()}get length(){return A(this.before).length+A(this.after).length}leftPad(e){return[...ye(this.limit-e.length,r=>({id:-(r+1),v:0})),...e]}rightPad(e){return[...e,...ye(this.limit-e.length,r=>({id:-(r+this.limit+1),v:0}))]}toJSON(){return{tags:this.tags.map(e=>e.toString()),assetIdsAfter:this.after.map(td),assetIdsBefore:this.before.map(td)}}mergeWith(e){cc(this.tags,e.tags,r=>r.path),cc(this.before,e.before,r=>r.id),cc(this.after,e.after,r=>r.id),this.logger().debug("mergeWith() complete",{tas:e.toJSON(),tags:this.tags.map(r=>r.path),beforeIds:this.before.map(td),afterIds:this.after.map(td)})}async toApi(){return this.vacuum(),this.logger().tap({msg:"toApi()",result:{tags:await le(this.tags,e=>e.toApiTag()),assetIdsAfter:this.leftPad(this.after.map(e=>e.toID())),assetIdsBefore:this.rightPad(this.before.map(e=>e.toID()))}})}streamCoeff(e){return this.logger().tap({msg:"streamCoeff",meta:{this:this.tags.map(r=>r.path),tas:e.tags.map(r=>r.path)},result:lx([...this.before,...this.after],[...e.before,...e.after],r=>r.id)})}};function $F(t){let e=c.minStreamCorrPct.valueOrDefault/100,r=[],i=t.filter(o=>o.length>5);for(let o of i){let n=st(r,s=>Bw(s.streamCoeff(o),e));n==null?r.push(o):n.mergeWith(o)}return r}var Bt=class extends Fr{constructor(){super(...arguments);this.attrs={};this.urls=l(()=>new ti(this.toID()))}static shownUnhidden(e){return x(e,()=>Bt.query()).andWhere({shown:1,hidden:0,excluded:0})}static shownCount(){return this.ops().countf(e=>e.where({shown:1,excluded:0}))}static outdatedQuery(){return this.query().where("version","<",es).andWhere({shown:1,excluded:0})}static deletePreviews(e){return ht.instance().previews().ap(e).deleteAll()}static async delete(e){this.logger().warn("Deleting asset "+e),await Ur.dbl.runf(r=>r.delete().where({assetId:e})),await Re.dbl.runf(r=>r.delete().where({assetId:e})),await Bt.dbl.runf(r=>r.delete().where({id:e})),await Bt.deletePreviews(e)}static async exclude(e){return this.logger().info("Excluding asset "+e),{dbResult:await Bt.dbl.runf(r=>r.update({excluded:1}).where({id:e})),deletedPreviews:await Bt.deletePreviews(e)}}static nextOutdated(e=jr){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=jr){return this.dbl.pluckFirst(e(this.outdatedQuery()).count())}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static async addTags(e,r){let i=Ji(r.filter(_),o=>ii(o));return this.logger().debug("addTags()",{assetId:e,tagPaths:r,uniqTagPaths:i}),R(i)?void 0:Bt.tx(async()=>{let n=(await le(i,s=>ge.findOrCreate(s))).map(s=>s.id);return Ur.addTagsToAsset(e,n)})}static async removeTags(e,r){if(R(r))return;let i=await le(r,o=>ge.findByPath(o));return this.logger().info("removeTags()",{assetId:e,tags:i.map(o=>et(o,"id","path")),tagPaths:r}),Ur.removeTagsFromAsset(e,F(i.map(o=>o.id)))}static unshownAssetIds(){return this.dbl.pluckAll(`
        SELECT DISTINCT af1.assetId
        FROM AssetFile af1
          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 
            ON af1.assetId = af2.assetId
        WHERE af2.assetId IS NULL`)}static archive(e){return this.tx(async()=>{await Bt.ops().findById(e)!=null&&(await Ur.dbl.runf(i=>i.where({assetId:e}).delete()),await Re.dbl.runf(i=>i.where({assetId:e}).delete()),await Bt.dbl.runf(i=>i.where({id:e}).delete()))})}get capturedAt(){return Tg(this.capturedAtLocal)}get capturedAtMs(){return yM(this.capturedAtLocal)}markUnshownAndUpsert(){return this.shown=!1,this.version=es,this.upsert()}markShownAndUpsert(){return this.shown=!0,this.excluded==null&&(this.excluded=!1),this.version=es,this.upsert()}toAssetId(){return{assetId:this.id,capturedAtLocal:this.capturedAtLocal}}renderCaption(e){return f(this.capturedAtMs,r=>"Taken "+rF(r,e))}async whenApiTag(){return Pt(this.capturedAt).flatMap(e=>NF(e)).flatMap(e=>ge.findOrCreate(e)).flatMap(e=>e.toApiTag()).get()}addTagPaths(e){return Bt.addTags(this.id,e)}async findAssetFileByUri(e){return await this.getFiles(),this.files.find(r=>r.uri===e)}async addAssetFile(e){return await this.findAssetFileByUri(e.uri)==null&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}static getTags(e){return ge.ops().all(ge.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}async getTags(){return this.tags==null&&(this.tags=await Bt.getTags(this.id)),this.tags}static getTagPaths(e){let r=ge.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return ge.dbl.pluckAll(r)}async tagPaths(){return(await this.getTags()).map(r=>r.path.join("/")).sort()}async getStreams(e){if(this.streams==null){let r=await this.getTags();this.logger().info("getStreams(): fetched tags "+r,{limit:e});let i=await le(r,o=>o.getAssetStream(this,e));this.streams=$F(F(i));for(let o of this.streams)for(let n of o.tags)await n.getAncestors()}return this.streams}async getBeforeAfterId(){let e=await Bt.dbl.all(Bt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id"));this.afterId=f(e.find(r=>r.id>this.id),Ol),this.beforeId=f(e.reverse().find(r=>r.id<this.id),Ol),await Ee(this.beforeId,()=>this.getBeforeId()),await Ee(this.afterId,()=>this.getAfterId())}async getBeforeId(){return b(Bt.dbl.first(Bt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}])),e=>this.beforeId=Ol(e))}async getAfterId(){return b(Bt.dbl.first(Bt.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}])),e=>this.afterId=Ol(e))}async getTagPaths(){return(await this.getTags()).map(r=>r.path)}async getFiles(){if(this.files!=null)return this.files;if(this.id==null)return this.files=[];let e=await Re.ops().findBy({assetId:this.id});return this.files=te(e,r=>[!L(r.shown),-r.mtime])}async setShown(e){return Re.setShown(this.id,e)}async getShown(){if(this.files!=null){let e=this.files.find(r=>L(r.shown));if(e!=null)return e}return b(Re.ops().findOneBy({assetId:this.id,shown:1}),e=>nt(e,r=>r.asset=this))}async getCapturedAts(){return le(this.getFiles(),e=>e.toCapturedAt())}link(){return"/asset/"+this.id}sqAttrs(e=!0){return y(y(y({},this.urls().sqImgAttrs(e)),{title:this.renderCaption()}),this.attrs)}async getImgAttrs(e,r,i=!1){if(this.imgAttrs==null&&(this.imgAttrs=new Map),this.imgAttrs.get(r)==null){let o=e.ap(this.toID());await b(o.readInfo(),async s=>{s.mimetype.startsWith("video/")&&(this.poster=await o.posterLink())});let n=!0;this.imgAttrs.set(r,await o.imgAttrs(r,n,i))}return this.imgAttrs.get(r)}async fitAttrs(e){return y(y({},await this.getImgAttrs(e,Nt.fit)),this.attrs)}isVideo(){if(this.files==null)throw new Error(".video called before getFiles()");return this.files.some(e=>e.isVideo)}videoAttrs(){return y({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(this.existingFiles==null)throw new Error(".videoSources called before getExistingFiles()");let e=this.existingFiles.filter(i=>i.isVideo).map(i=>({src:this.urls().videoLink(i.id),type:i.mimetype})),r=Ji(e,i=>i.type);if(r.every(i=>i.type!=="video/mp4")){let i=this.existingFiles[0];r.unshift({src:this.urls().videoLink(i.id)+".mp4",type:"video/mp4"})}return r}async getPosixFiles(){let e=await this.getFiles();return F(await Promise.all(e.map(r=>r.posixFile())))}async getExistingAssetFiles(){return this.existingFiles==null&&(this.existingFiles=await xn(await this.getFiles(),e=>he(e.posixFile(),r=>r.exists(),()=>!1))),this.existingFiles}async findOrCreateByFile(e){let r=await e.uri();if(r==null)return;let i=A(await Re.findByAsset({id:this.id},{uri:r}))[0];return x(i,async()=>{let o=new Re;return o.asset=this,o.assetId=this.id,await o.setFile(e),o})}clear(){return this.existingFiles=void 0,this.files=void 0,this.imgAttrs=void 0,this.streams=void 0,this.tags=void 0,this}async setHidden(e){return this.hidden=e,this.upsert()}},Ie=Bt;Ie.tableName="Asset",Ie.uniqueColumnName="id",Ie.booleanFields=["shown","hidden","excluded"],Ie.shownAssetCounts=l(()=>Bt.dbl.pluckFirst({sql:Ki("SELECT","  COUNT(DISTINCT Asset.id)","FROM Asset","WHERE","  Asset.shown = 1","  AND Asset.excluded = 0","  AND hidden = 0")}),7*M);function QF(t){return t.orderByRaw("COALESCE(ordinal, _path) COLLATE NOCASE")}q(()=>ge.clear());async function YF(t){let e=await t;return e!=null&&ge.cacheTag(e),e}var be=class extends Fr{constructor(){super(...arguments);this.urls=l(()=>new cb(this.id));this.displayPath=l(async()=>{let e=await this.getParent();return[...e==null?[]:await e?.displayPath(),this.displayName]});this.descendantIds=l(async()=>be.dbl.pluckAll({sql:Ki("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT id ","FROM descendants","WHERE id <> :tagId"),bindings:{tagId:this.id}}),7*M);this.ancestorIds=l(async()=>this.parentId===0||this.parentId==null?[]:be.dbl.pluckAll({sql:Ki(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT id","FROM Tag","WHERE Tag.id in ancestors","  AND Tag.id <> :tagId","ORDER BY _path DESC"].join(" ")),bindings:{tagId:this.id}}))}static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this.recentTagsByPath.clear(),this.tagById.clear()}static cacheTags(e){return e.map(r=>this.cacheTag(r))}static cacheTag(e){return e!=null&&this.recentTagsByPath.set(e._path,Promise.resolve(e)),e?.id!=null&&this.tagById.set(e.id,Promise.resolve(e)),e}static newTag(e){let r=new be;r._path=ii(e);let i=e[e.length-1];return i!=null&&oc(i)&&(f(i.displayName,o=>r._displayName=o),f(i.ordinal,o=>r.ordinal=o),f(i.description,o=>r.description=o),f(i.releasedAt,o=>r.releasedAt=o)),r}static findByIdOrPath(e,r){return e===0?be.root():B(e)?this.findById(e):this.findByPath(r)}static findById(e){return e===0?be.root():be.tagById.getOrSet(e,()=>YF(this.ops().findById(e)))}static async findByPath(e){let r=ii(e);return S(r)?be.root():be.recentTagsByPath.getOrSet(r,()=>b(this.ops().firstf(i=>i.where("_path","like",r)),i=>be.cacheTag(i)))}static getPagedAssets(e,r){let i=new be;return i.id=e,i.getPagedAssetIds(r)}static async findOrCreate(e){if(R(e))throw new Error("empty tagPath");let r=ii(e,"/"),i=await this.findByPath(e);if(this.logger().debug("_findOrCreate("+r+")",{prior:i}),i!=null)return i;let o=this.newTag(e),n=o.depth<=1?void 0:await this.findOrCreate(e.slice(0,-1));f(n,a=>o.parentId=a.id);let s=await YF(this.ops().upsertOne(o));return this.logger().debug("_findOrCreate("+r+") upserted",{newTag:o,result:s,parent:n}),s}clear(){return this.parent=void 0,this.root=void 0,this.children=void 0,this.ancestors=void 0,this.assets=void 0,this.relatedAssets=void 0,this.ancestorIds.unset(),this.descendantIds.unset(),this}siblingPath(e){return ii([...this.parentPath,e])}async changeName(e){return this.changePath(this.siblingPath(e))}maybeUpsertDisplayName(e){return S(e)||e===this._displayName?void 0:this.upsert({_displayName:e})}async changePath(e,r=!0){let i=this._path,o=await be.findByPath(Xn(e));this.logger().info("changePath(): ",{priorPath:i,newPath:e,existingSibling:o});try{o==null?(await be.tx(async()=>{await be.dbl.runf(n=>n.where("_path","LIKE",i+"%").update({updatedAt:Date.now(),_path:yo.raw("REPLACE(_path, ?, ?)",[i,e])}))}),this._path=e):(e=o._path,this.logger().info("changePath(): replacing with sibling",e),await Ur.dbl.updateOrIgnore(n=>n.where({tagId:this.id}).update({tagId:o.id})),await Ur.dbl.runf(n=>n.where({tagId:this.id}).delete()),await le(this.getChildren(),n=>n.changePath(ii([...o.path,n.name]),!1)),await be.dbl.runf(n=>n.where({parentId:this.id}).update({parentId:o.id})),await this.delete())}finally{r&&be.clear()}}get name(){let e=this.path;return e[e.length-1]}get path(){return Xn(this._path)}get displayName(){return P(this._displayName)?this._displayName:this.name}get isRoot(){return this.id===0}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}get sortBy(){return[this.ordinal==null?2**51:this.ordinal,this.path.map(e=>e.toLowerCase())]}$childrenQuery(){return QF(be.query().where({parentId:this.id}))}$assetsQuery(){return Ie.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0).andWhere("Asset.excluded",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],f(this.parent,r=>r.setAncestors(e.slice(0,-1)))}async toApiPathElements(){return le(this.getAncestorsAndSelf(),e=>({tagPath:e.path,displayName:e.displayName}))}async toApiTag(){return{tagId:this.id,tagPath:this.path,displayPath:await this.displayPath(),description:this.description,assetCount:this.assetCount,assetFileCount:this.assetFileCount}}toStringId(){return"Tag("+this.path.join("/")+")"}async getParent(){if(!this.isRoot)return this.parentId!=null&&this.parent==null?this.parent=await be.findById(this.parentId):this.parent}async getPagedChildren(e){if(this.id===0){let o=x(e.offset,0),n=o+x(e.limit,this.children.length);return[...this.children].slice(o,n)}let r=this.$childrenQuery();we(e.offset,o=>{r.offset(o)}),we(e.limit,o=>void r.limit(o));let i=await be.ops().all(r);for(let o of i)be.cacheTag(o);return i}async getDescendants(){return be.ops().all({sql:Ki("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN descendants","  AND Tag.id <> :tagId"),bindings:{tagId:this.id}})}async getChildrenCount(){return this.children!=null?this.children.length:be.dbl.pluckFirstf(e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count())}async getChildren(){return this.children=await be.ops().all(this.$childrenQuery()),this.children.forEach(e=>{e.parent=this}),this.children}link(){return"/tag/"+this.path.map(encodeURIComponent).join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}async getAncestors(){if(this.ancestors==null){let e=hx(this.parentPath).map(o=>ii(o)),r=await Promise.all(e.map(o=>be.recentTagsByPath.get(o)));if(r.every(o=>o!=null))return this.ancestors=r;let i=be.query().whereIn("_path",e).orderBy("_path");this.ancestors=await be.ops().all(i),be.cacheTags(this.ancestors),this.parent=x(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}async getAncestorsAndSelf(){return[...await this.getAncestors(),this]}async _getAncestors(){return this.parentId===0||this.parentId==null?[]:be.ops().all({sql:Ki(["WITH RECURSIVE ancestors(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.parentId","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT Tag.*","FROM Tag","WHERE Tag.id IN ancestors","  AND Tag.id <> :tagId","ORDER BY Tag._path DESC"].join(" ")),bindings:{tagId:this.id}})}getPagedAssetIds(e){let r=this.$assetsQuery().select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal"),i="desc";return Ro(e.capturedAtLt,o=>{r=r.where("capturedAtLocal","<",o)}),Ro(e.capturedAtGt,o=>{r=r.where("capturedAtLocal",">",o),i="asc"}),Ro(e.limit,o=>{r=r.limit(o)}),r=r.orderBy("capturedAtLocal",i),Ie.dbl.all(r)}getAssets(){let e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return Ie.ops().all(e)}async assetCountDesc(e){let r=this.assetCount;return(r==null||e==null||e.length===r||e.length===0?"":Rc(e.length)+" of ")+kc(r,"asset")}$assetStreamQuery(e,r,i){let o=this.path[0]===He.When?Ie.shownUnhidden():this.$assetsQuery();return o=o.distinct().where("capturedAtLocal",i,e.capturedAtLocal).andWhereNot("Asset.id",e.id).limit(i==="="?r*2:r),i==="="?o.orderByRaw(`ABS(Asset.id-${e.id})`):o.orderBy([{column:"capturedAtLocal",order:i===">"?"asc":"desc"},"Asset.id"])}async getAssetStream(e,r){r=B(r)?r:Qp;let[i,o,n]=await le(["<","=",">"],s=>Ie.ops().all(this.$assetStreamQuery(e,r,s)));for(let s of o)s.id<e.id?i.push(s):n.push(s);return new hb([this],i,n.reverse(),r)}async getRelatedAssetIds(e,r=Ou){let i=Math.max(256,await FV()),o=await Ur.dbl.allf(n=>n.select("Asset.id as assetId","Asset.capturedAtLocal as capturedAtLocal").distinct().join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).andWhere("Asset.excluded",0).andWhere("Asset.hidden",0).orderByRaw(BF(e+x(this.id,0),"Asset.id",i)).limit(r));return this.logger().debug(this.path+": Found "+o.length+" related assets",o),o}get attrs(){return{href:this.link(),title:this.name}}},ge=be;ge.tableName="Tag",ge.uniqueColumnName="_path",ge.recentTagsByPath=new ke(256),ge.tagById=new ke(256,E),ge.cmp=(e,r)=>Vt([x(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[x(r.ordinal,Number.MAX_SAFE_INTEGER),...r.path]),ge.root=l(async()=>{let e=new be;return e.id=0,e._path=nn,e.parentId=void 0,e.children=(await be.roots()).filter(r=>!hn(c.hiddenHomeTags.valueOrDefault,r.name)),e.ancestors=[],e.assetCount=await Ie.shownAssetCounts(),e.upsert=()=>{throw new Error("upsert not supported on root")},e},7*M),ge._upsertDefaultRoots=l(()=>be.ops().upsert(hF.map(e=>({_path:ii([e.name]),ordinal:e.ordinal})))),ge.roots=l(async()=>{await be._upsertDefaultRoots();let e=await be.ops().all(QF(be.query().whereNull("parentId")));return e.forEach(r=>{r.parentId=void 0,r.ancestors=[],be.cacheTag(r)}),e});var FV=l(()=>Ie.dbl.pluckFirstf(t=>t.count()),E);var LV=`'${He.When}' || char(31)`,IV=LV+" || '%' || char(31)",XF=IV+" || '%' || char(31)",RV=XF+" || '%' || char(31)",ZF=l(()=>d("DateTagNormalizer"));async function OV(){return ge.ops().allf(t=>t.whereNotNull("ordinal").andWhereRaw("_path LIKE "+XF+" AND _path NOT LIKE "+RV).limit(200*12))}async function eL(){await ge.tx(async()=>le(OV(),kV))}async function kV(t){let e=await we(t.ordinal,r=>ub(_F(r)));e==null?ZF().warn("failed to fix tag (no monthTagRef)",{t}):e.name!==t.name&&(ZF().info("Fixing month name",{tagRef:e,tag:t}),await t.changeName(e.name)),await t.maybeUpsertDisplayName(e?.displayName)}var tL=T(require("os")),rL=T(require("process"));var Vu=Se("rebuildLibrary","forceRestartSync","enqueueAssetFileUpdates","enqueueAssetUpdates","applyNewTagger"),gb=class extends Fr{static incomplete(){return this.ops().allf(e=>e.whereIn("id",r=>r.table(gb.tableName).min("id").whereNull("completedAt")))}static async getFirstPendingOp(e){return this.logger().tap({msg:"getFirstPendingOp",level:"info",result:await this.ops().firstf(r=>{let i=r.whereNull("completedAt").orderBy("createdAt","asc");return e!=null?i.andWhere(e):i}),meta:{pojo:e}})}static markOpCompleted(e){return S(e?.name)?this.logger().throw("markOpCompleted(): bad query",{query:e}):this.dbl.runf(r=>r.whereNull("completedAt").andWhere(e).update({completedAt:Date.now()}))}static async applyOnce(e,r,i=jr){let o=await this.ops().firstf(a=>i(a.whereNotNull("completedAt").andWhere(e)));if(o!=null){this.logger().info("applyOnce(): already done",{prior:o});return}let n=await this.ops().insertOne(e),s=await r(n);return G()||await n.upsert({completedAt:Date.now()}),s}},ln=gb;ln.tableName="Operation",ln.uniqueColumnName="id";var b2e=Se("lastScannedDirectory","scannedDirectoryCount","completedDirectoryScan","enqueuedStaleFiles","processedImageCount","processedVideoCount"),ts=class extends Fr{};ts.tableName="ProgressMeta",ts.uniqueColumnName="progressId,name";var zu=l(()=>M*(yt()<=3?3:1.5)),_V=Ki(`
SELECT
  p1.uri as uri,
  p1.lastUpdatedAt as lastUpdatedAt,
  p1.lastCompletedAt as lastCompletedAt,
  min(p2.createdAt) AS lastStartedAt
FROM
  (
    SELECT
      uri,
      max(updatedAt) AS lastUpdatedAt,
      max(completedAt) AS lastCompletedAt
    FROM
      Progress
    WHERE
      createdAt > :minCreatedAt
    GROUP BY
      uri
  ) AS p1
  JOIN Progress AS p2
    ON 
      p2.uri = p1.uri AND 
      p2.createdAt > :minCreatedAt AND
      (p2.createdAt > ifnull(p1.lastCompletedAt, 0) OR p2.completedAt = lastCompletedAt)
GROUP BY
  1,2,3
`),NV=Ki(`
SELECT
  *
FROM
  ProgressMeta
WHERE
  id IN (
    SELECT
      max(pm.id)
    FROM
      ProgressMeta pm
      JOIN Progress p ON pm.progressId = p.id
      AND p.createdAt > :minCreatedAt
    WHERE
      p.uri = :uri
      AND p.hostname = :hostname
    GROUP BY
      p.uri,
      pm.name
  )
`),rd=class extends Fr{static async vacuum(e=90*xt){await ts.dbl.runf(r=>r.whereIn("progressId",i=>i.table("Progress").select("id").where("createdAt","<=",Date.now()-e)).delete()),await this.dbl.runf(r=>r.where("createdAt","<=",Date.now()-e).delete())}static async minCreatedAt(){let e=await ln.getFirstPendingOp({name:Vu.forceRestartSync});return rd.logger().tap({msg:"minCreatedAt",level:"info",result:x(e?.createdAt,0),meta:{op:e}})}static async times(){let e=await this.minCreatedAt();return this.dbl.all({sql:_V,bindings:{minCreatedAt:e}})}static async saveSyncState(e){return le(A(await e.progress()),r=>(r.state==="done"&&r.completedAt==null&&(this.logger().warn("caller saved done sync state without setting completedAt",Xc()),r.completedAt=Date.now()),r.id==null?this.logger().throw(e.name+" returned an unsaved Progress",r):r.upsert()))}static async insertNew(e,r){return this.ops().insertOne({uri:e,volume:r,pid:rL.pid,hostname:(0,tL.hostname)()})}toSyncState(){return{id:this.id,uri:this.uri,volume:this.volume,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return x(U(this.dekJSON,()=>V(JSON.parse(this.dekJSON))),()=>[])}set dek(e){this.dekJSON=O(V(e))}assignFromPojo(e){return tn(this,e)}getThisMeta(){return ts.ops().allf(e=>e.where({progressId:this.id}).orderBy("createdAt"))}async getMeta(){return ts.ops().all({sql:NV,bindings:{minCreatedAt:await rd.minCreatedAt(),uri:this.uri,hostname:this.hostname}})}setMeta(e,r){return ts.ops().upsertOne({progressId:this.id,name:e,value:r})}async getMetaAsRecord(){return ft((await this.getMeta()).map(e=>[e.name,e.value]))}},ia=rd;ia.tableName="Progress";var oa=l(()=>d("TagSql")),yb,bb=l(()=>new Au(Mi,"Tag")),id=l(async()=>{if(Tt&&Date.now()-fi<20*M)return;await CV();let t=await bb().pluckFirst({sql:"SELECT MAX(rowid) FROM AssetTag"});oa().info("updateTagCounts()",{newMax:t,lastMax:yb}),t!==yb&&(yb=t,await rt("db.updateTagCounts",()=>BV()))},7*M);function VV(t=im(6)){let e=`temp.ct_${t}`,r=`temp.taf_${t}`,i=`temp.tag_counts_${t}`;return q0(`
CREATE TABLE ${e} AS
SELECT
  DISTINCT t.id AS parentId,
  kid.id AS childId
FROM
  Tag t
  JOIN Tag kid ON kid._path LIKE (t._path || '%');

CREATE INDEX ${e}_idx ON ${e.replace(/^temp\./,"")}(parentId, childId);

CREATE TABLE ${r} AS
SELECT
  DISTINCT AssetTag.tagId as tagId,
  Asset.id AS assetId,
  AssetFile.id AS assetFileId
FROM
  AssetTag
  JOIN Asset ON AssetTag.assetId = Asset.id
  JOIN AssetFile ON AssetFile.assetId = Asset.id
WHERE
  Asset.hidden = 0
  AND Asset.excluded = 0
  AND Asset.shown = 1;

CREATE INDEX ${r}_idx ON ${r.replace(/^temp\./,"")}(tagId, assetId, assetFileId);

CREATE TABLE ${i} AS
SELECT
  parentId AS tagId,
  count(DISTINCT assetId) AS ac,
  count(DISTINCT assetFileId) AS afc
FROM
  ${e}
  JOIN ${r} ON childId = tagId
GROUP BY
  1;

CREATE INDEX ${i}_idx ON ${i.replace(/^temp\./,"")}(tagId, ac, afc);

-- Update used tags:

UPDATE Tag SET 
  assetCount = NULL,
  assetFileCount = NULL;

UPDATE Tag
SET
  assetCount = ac,
  assetFileCount = afc
FROM ${i}
WHERE tagId = id;

-- Clean up:

DROP INDEX IF EXISTS ${e}_idx;
DROP INDEX IF EXISTS ${r}_idx;
DROP INDEX IF EXISTS ${i}_idx;
DROP TABLE ${e};
DROP TABLE ${r};
DROP TABLE ${i};
`)}async function BV(){bb().db()==null&&oa().throw("updateTagCounts(): modelDb is unset",{retriable:!1});try{let t=im(6),e="_"+t,r=await Ya(bb().runScript(VV(t),e)),i=Y(7*M,5*E,r.elapsedMs*20);oa().info("Updated tag counts",{elapsedMs:r.elapsedMs,newTTL:i}),id.setTTL(i),await zV()}catch(t){oa().warn("Failed to update tag counts",t)}}async function zV(t=Date.now()-10*E){let e=[-1];for(let r of Mo(0,5)){let i=await UV(t);if(R(i)||Ai(e,i))return;e=i}}async function UV(t){let e=await ge.dbl.pluckAllf(r=>r.select("Tag.id").leftOuterJoin("AssetTag","AssetTag.tagId","Tag.id").leftOuterJoin(yo.raw("Tag AS child ON child.parentId = Tag.id")).whereNull("AssetTag.assetId").andWhere(i=>i.whereNull("child.id")).andWhere(i=>i.whereNull("Tag.assetCount")).andWhere("Tag.createdAt","<",t).orderBy("Tag._path","asc"));oa().debug("vacuumLeafTags()",{candidates:e});for(let r of e)try{await ge.dbl.runf(i=>i.where({id:r}).delete())}catch(i){oa().info("vacuumLeafTags(): failed to delete",{tagId:r,err:i})}return oa().info("vacuumLeafTags() complete.",{candidates:e}),e}async function CV(){let t=d("updateTagMountpoints()"),e=await ge.findByPath([He.FS]);if(e==null){t.info("No root filesystem tag");return}await e.maybeUpsertDisplayName(c.tagDisplayNameFS.valueOrDefault);let r=await Dt();if(r==null){t.warn("no-op: volumes() returned null");return}for(let i of await e.getChildren()){if(i.name===Yp){i.ordinal!==1&&await i.upsert({ordinal:1});continue}let o,n=r.find(s=>P(s.uuid)&&Us(s.uuid)===i.name);n!=null?o=Rr(n.label,n.mountpoint):o=await Re.dbl.pluckFirstf(s=>s.select("mountpoint").where("uri","LIKE","psfile://"+i.name+"/%").limit(1)),o!=null?(await i.maybeUpsertDisplayName(o),t.info("updated tag",{id:i.id,path:i.path,displayName:o}),ge.clear()):t.debug("cannot update tag: no current volume.",{id:i.id,path:i.path})}}var Uu=class{constructor(e,r,i){this.dataDir=e;this.isLockOwner=r;this.localDbDir=i;this.endTimeoutMs=E;this.end=l(()=>f(this.backup.value,e=>e.end()));this.setup=l(async()=>{try{await this._setup(),this.logger.info("ModelDb reading from "+this.db.value?.dbfile)}catch(e){this.db.reject(e),this.backup.reject(e),this.logger.throw(e,{fatal:!0,from:"ModelDbJanitor.setup"})}});this.beforeBackup=async()=>{G()||!fe&&Nr()&&await Lt(Mi(),async()=>{await _l.vacuum(),await ia.vacuum(),await id()})};this.onBackupFinished=async()=>{!G()};this.onMigration=l(async()=>{this.logger.info("onMigration: removing prior stats db to clear prior work queues"),await b(ed(!1),r=>r.rmrf("info"))});this.backupAndMigrate=async()=>Nr()||await this.isLockOwner();this.name="ModelDbJanitor("+e+")",this.logger=d(this.name),this.db=new Mr(this.name+".db"),this.backup=new Mr(this.name+".backup"),this.srcDbFile=en(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),Wx(this),this.setup()}static async for(e,r,i=LF){let o=new Uu(e,r,i);return await o.setup(),o}get ended(){return this.end.prior()!=null}async _setup(){if(c.forceLocalDbReplica.valueOrDefault||await b(ao(this.srcDbFile.nativePath),r=>r.remote)===!0){let r=await this.localDbDir();return this.localDbReplica=en(r,"models"),this.logger.info("Library on remote drive. Using local db replica.",{src:this.srcDbFile.nativePath,local:this.localDbReplica}),await this.backupAndMigrate()&&(this.logger.info("Setting up local model db replica...."),await this.localDbReplica.parent().rmrf("info"),await this.srcDbFile.clear().exists()&&(await this.srcDbFile.copyFile_(this.localDbReplica),await this.localDbReplica.chmod(420)),this.logger.info("Local model db replica set up at "+this.localDbReplica)),this._finishSetup(r,this.srcDbFile.parent())}else return this._finishSetup(this.dataDir)}async _finishSetup(e,r){let i=await this.backupDir.mkdirp();if(i==null)throw new Error("Failed to create models DB backup dir "+this.backupDir);let o=new _u("models",e,this.onMigration),n=await this.backupAndMigrate();n?(await o.migrate(),this.backup.resolve(new mb(o,this.backupAndMigrate,o.dbfile,i,r,this.beforeBackup,this.onBackupFinished))):this.backup.resolve(void 0),C0(o),this.db.resolve(o),n&&(await eL(),await id()),this.logger.info("Finished setup",{primaryDbDir:e,replaceDbDir:r,backupDir:i})}};var iL=l(()=>{TM(jm()?WV:void 0),zM(jm()?qV:void 0)}),WV=async()=>await Jn()?f($n(),t=>t.request("mountpoints")):void 0,qV=async()=>await Jn()?f($n(),t=>t.request("volumes")):void 0;var jV;function oL(t){jV=t}async function nL(t){let e=new _u("stats",t);return WS()&&(await e.migrate(),new ta({name:"statsDbJanitor vacuum",callback:()=>e.vacuum(),intervalMs:fe?20*M:5*E,rank:ue.service})),oL(e),e}function wb(t){return t.toDateTime().toFormat(c.assetSubdirectoryDatestampFormat.valueOrDefault).split("/")}var xb=class{constructor(e,r){this.root=e;this.copyAssets=r;this.logger=d("AssetFileRepository")}directoryForDate(e){return this.root.join(...wb(e))}async importFile(e){let r=this.copyAssets();if(this.logger.debug("importFile()",{file:e,copyAssets:r}),!r||await Pl())return e;if(await e.isDescendantOf(this.root))return this.logger.debug("no-op: "+e+" already contained by "+this.root),e;this.logger.debug("importing "+e);let i=await Tu(e);if(i==null)throw new Error(e.nativePath+" has no tags (so, no createdAt)");let o=f(i.capturedAt,g=>sy(g.date));if(o==null)throw new Error(e.nativePath+" has no capturedAt");if(o.year==null||o.month==null||o.day==null)return this.logger.warn("Insufficient capturedAt precision to copy "+e+" into library.",{capturedAt:i.capturedAt}),e;let n=this.directoryForDate(o);if(await n.mkdirp()==null)throw new Error("Cannot create destination directory, "+n.nativePath+" for "+e.nativePath);let s=await n.children(),a=await e.size(),m=await Mm(s,g=>g.size().then(v=>v===a)),u=await e.sha();if(m.length>0){let g=await Mm(m,v=>v.sha().then(D=>D===u));if(g.length>0){let v=g[0];return this.logger.info(e+" matches "+v),this.handleSidecars(e,v)}}let p=await n.join(e.base).ensureNew_();return this.logger.info("Copying...",{src:e.nativePath,dest:p.nativePath}),await e.copyFile_(p),this.handleSidecars(e,p)}async handleSidecars(e,r){let i=x(await e.sidecars(),[]);for(let o of i)await this.handleSidecar(o,r);return _(i)&&Or(r.nativePath),r}async handleSidecar(e,r){for(let o of x(await r.sidecars(),[]))if(await KA(e,o)){this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:o,dest:r});return}let i=await r.parent().join(r.name+e.ext).ensureNew_({emptyIsNew:!0});return e.copyFile_(i)}};var ht=class extends lt{constructor(e){super(`Library(${e})`,()=>this.onEnd(),ue.predb);this.start=Date.now();this._ready=new Wt;this.setup=l(async()=>{let e=()=>{if(this.ended||G())throw new Error};try{if(this.logger.debug("setup() started"),!pt()){if(!Lf())throw new Error("Cannot run "+rr()+" without a library"+pe+Gr);this.logger.warn("Library settings don't exist yet. Skipping setup.");return}await this.openedBy().throwIfUnavailable("(library setup)"),e(),await gl(this.rootDir),await ep(this.rootDir.nativePath);let r=this.originalsDir();if(r==null||await r.mkdirp()==null||!await r.isReadWritable())throw new Error(`Invalid value for ${c.originalsDir.key}: ${r} must be readable and writable.`);await this.statsDbDir(),await Zs(),e(),h0(Z0),jm()&&await Jn()&&(await A0(),iL()),e(),await this.modelDb(),e(),US()&&await this.statsDb()}catch(r){!this.ended&&!G()&&(X("Library.setup() failed"+(ll()?"":pe),r),this._ready.reject(r))}finally{this._ready.pending&&(this.logger.info("Library.setup() finished."),this._ready.resolve())}});this.openedBy=l(()=>new Cy(this.dataDir));this.statsDbDir=l(()=>ed());this.previews=l(()=>new Fy(this.rootDir.join(c.previewsDir.valueOrDefault),eF));this.originalsDir=l(()=>iu(this.rootDir));this.assetFileRepository=l(()=>new xb(this.originalsDir(),()=>c.copyAssetsToLibrary.valueOrDefault));this.modelDbJanitor=l(async()=>Uu.for(this.dataDir,()=>this.openedBy().isLockOwner()));this.modelDb=l(async()=>(await this.modelDbJanitor()).db.promise);this.statsDb=l(async()=>nL(await this.statsDbDir()));this.statsDbFile=l(()=>this.statsDb().then(e=>e.dbfile));this.onEnd=l(async()=>{for(let{ea:e,t:r}of[{ea:this.statsDb,t:H},{ea:this.modelDbJanitor,t:E},{ea:this.openedBy,t:H}])await f(await e.clear(),i=>Ri(i,r));this.logger.info("onEnd(): finished.")});this.rootDir=oe.for(e),this.dataDir=At(this.rootDir),this.logger.info("new()")}static libraryPathChanged(){let e=f(c.libraryPath.value,_r),r=f(this.priorInstance,i=>i.rootDir.nativePath);return e!==r}static instance(){let e=this.libraryPathChanged(),r=L(this.priorInstance?.ended),i;return(e||r)&&(i=Ri(this.priorInstance,E),this.priorInstance=void 0),this.priorInstance==null&&pt()&&(this.priorInstance=U(c.libraryPath.value,o=>nt(new ht(o),async n=>(await i,n.setup())))),this.priorInstance}static instanceRequired(){let e=ht.instance();if(e==null)throw new Error("Library is undefined"+pe);return e}get isPendingSetup(){return this._ready.pending}get ready(){return this._ready.promise}async requiredFiles(){let e=[];return await Ka(c.cacheDir.valueOrDefault)&&e.push({desc:"Cache directory",isDir:!0,file:()=>Wo()}),this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library model DB",isDir:!1,file:()=>b(this.modelDbJanitor(),r=>r.srcDbFile)},{desc:"Library model DB (local replica)",isDir:!1,file:()=>b(this.modelDbJanitor(),r=>r.localDbReplica)}),e}};var Tb=T(require("process"));function Ct(t,e=Hm()){Bu()||(d("stdoutWrite").debug("()",{obj:t,ready:e}),Tb.stdout.write(O(t)+`
`),e&&Tb.stdout.write(HV+`
`))}var HV=O({ready:!0});function od(...t){let e={};for(let r of t)r.addToEnv(e);Ct(e)}var Pi={pauseHealthChecks:()=>Ct({pauseHealthChecks:!0}),resumeHealthChecks:()=>Ct({pauseHealthChecks:!1}),shutdownSync:()=>Ct({shutdownSync:!0}),restartSync:()=>Ct(c.libraryPath.addToEnv({restartSync:!0,pause:!1})),forceRestartSync:()=>Ct({forceRestartSync:!0,pause:!1}),rebuildLibrary:()=>Ct({rebuildLibrary:!0,pause:!1}),pause:()=>Ct({pause:!0}),resume:()=>Ct({pause:!1}),shutdown:()=>Ct({shutdown:!0}),sendRecentLogs:()=>Ct({sendRecentLogs:!0})};var wo=d("LibrarySettings");function na(t={}){return wo.tap({msg:"librarySettings",level:"info",result:y({scanAllDrives:c.scanAllDrives.valueOrDefault,scanPath:c.scanPaths.values,copyAssets:c.copyAssetsToLibrary.valueOrDefault,reportErrors:c.reportErrors.valueOrDefault},t)})}function sL(t){c.scanAllDrives.maybeSetValue(t.scanAllDrives),c.scanPaths.maybeSetValue(t.scanPath),c.copyAssetsToLibrary.maybeSetValue(t.copyAssets),c.reportErrors.maybeSetValue(t.reportErrors)}async function aL(t,e,r=GV){let i=U(h(t).trim(),m=>ie.for(m)),o=na(),n=c.libraryPath.value,s=i==null&&P(n)?ie.for(n.trim()):i;if(s==null)return[{error:"Please choose a directory for your library."}];let a=async()=>{try{sL(o),c.libraryPath.value=n,await js(),await U(n,m=>Hs(m)),await b(ht.instance(),m=>m.ready),Pi.restartSync()}catch(m){wo.warn("Failed to roll back to prior settings",{priorSettings:o,priorLibraryPathValue:n,err:m})}};try{let m=!Rg(s.nativePath),u=s.nativePath!==n;if(u)try{await gl(s.nativePath),await Qy(s)}catch(g){return wo.warn("Failed to set up library at "+s,g),await a(),[{error:"Cannot write to "+s.nativePath+". Please choose a different directory for your library."}]}sL(e);let p=!kt(o,na());if(await Hs(s.nativePath)==null)return await a(),[{error:"Cannot write to "+s.nativePath+". Please choose a different directory for your library."}];c.libraryPath.value=s.nativePath;try{await js()}catch(g){return await a(),wo.warn("Failed to write system settings",g),[{error:"Couldn't write your system settings to "+nu()+": "+yi(g)}]}try{let g=ht.instanceRequired();await g.ready,await(await g.modelDb()).migrate()}catch(g){return await a(),wo.warn("Failed to open library at "+s,g),[{error:"Failed to open library at "+s+": "+yi(g)}]}if(wo.info("saveLibrarySettings()",{librarySettingsDidNotExist:m,libraryPathChanged:u,librarySettingsChanged:p,settings:e,priorSettings:o,currentSettings:na()}),u)try{await r()}catch(g){return await a(),[{error:"Cannot open "+s.nativePath+". Please choose a different directory for your library."}]}else(p||m)&&(await od(c.libraryPath),await Pi.restartSync());return[{info:"Saved"}]}catch(m){return await a(),wo.error("Failed to save settings",m),[{error:"Failed to save settings: "+m}]}}async function GV(){if(!pt.refresh()){wo.info("onLibraryPathChange(): no library settings",{libraryPath:c.libraryPath.value});return}Pi.pauseHealthChecks(),Pi.shutdownSync(),await f(ht.priorInstance,e=>e.end()),wo.info("onLibraryPathChange(): setting up new library."),await ht.instanceRequired().ready,wo.info("onLibraryPathChange(): Telling sync to restart..."),Pi.restartSync()}var xo=l(()=>Io("ENABLE_SENTRY")||Tt&&No&&c.reportErrors.valueOrDefault);c.reportErrors.addListener(()=>xo.clear());var ut=T(require("process"));var lL=T(require("process")),KV=T(require("timers"));var vb="--exit",KUe=l(()=>d("ChildService"));var mL=T(require("fs")),Sb=T(require("fs-extra")),Wu=T(require("path")),qu=T(require("process")),Wl=T(require("timers"));var Mb=class extends lt{constructor(){super("LogTail",()=>this.onEnd(),ue.logger);this.watchers=new Map;this.file2pos=new Map;this.lastReadFiles=new ks(5*M);this.mutex=new Yt;this.setup=l(async()=>{await bl();let e=c.logDir.valueOrDefault;fe&&console.log("tailing "+e+"..."),await(0,Sb.mkdirp)(e),this.root=await $r.for(e),await this.scan(!0)});this.ignorableFilename=Wu.sep+rr()+"-"+qu.pid+"-",!qu.stdout.writableFinished&&(rg(!0),this.flushTimeout=(0,Wl.setInterval)(()=>this.flush(),kn/2),this.scanTimeout=(0,Wl.setInterval)(()=>this.scan(),E),qu.stdout.on("end",()=>this.end()),this.setup())}async flush(){this.write(ig())}readable(e){return e.endsWith(".log")&&!e.includes(this.ignorableFilename)}watchDir(e){G()||this.ended||lr(this.watchers,e,()=>{no(qt.debug,()=>console.log("LogTail(): watching "+e));try{return(0,mL.watch)(e,(r,i)=>this.watchListener(r,(0,Wu.join)(e,i)))}catch(r){no(qt.warn,()=>console.error("LogTail(): failed to read "+e,r));return}})}async scan(e=!1){if(!(G()||this.ended)&&(await this.root.visitDescendantFiles(async r=>{!this.readable(r.nativePath)||(e&&await b(r.size(),i=>this.file2pos.set(r.nativePath,i)),Bf(await r.mtimeMs())&&this.watchDir(r.dir))}),!(G()||this.ended))){try{let r=(0,Wu.join)(this.root.nativePath,fn(new Date));await(0,Sb.mkdirp)(r),this.watchDir(r)}catch(r){no(qt.warn,()=>console.error("LogTail(): Failed to create the current log dir",r))}G()||this.ended||e&&console.log("LogTail(): Tailing "+this.root+"/**/*.log...")}}async onEnd(){rg(!1),f(this.flushTimeout,Wl.clearInterval),this.flushTimeout=void 0,f(this.scanTimeout,Wl.clearInterval),this.scanTimeout=void 0;for(let e of this.watchers.values())e.close();this.watchers.clear();for(let e of this.lastReadFiles)await this.watchListener("onEnd",e);try{this.write(ig(-1))}catch{}}write(e){for(let r of e)console.log(Wm().formatLogEntry(r))}async watchListener(e,r){!this.readable(r)||await this.mutex.serialByName(r,async()=>{try{let i=await $r.for(r);if(i==null){no(qt.warn,()=>console.error("watchListener: missing file",{event:e,filename:r}));return}let o=await i.size();if(o==null||o<=0)return;let n=x(this.file2pos.get(i.nativePath),()=>0);if(ji(n,o))return;await b(CS(i,{start:n,end:o}),s=>Ef(...s)),this.lastReadFiles.add(i.nativePath),this.file2pos.set(i.nativePath,o)}catch(i){no(qt.warn,()=>console.error("Failed to read "+r+": "+Jt(i)))}})}},nd=Mb;nd.instance=l(()=>Bu()?void 0:new Mb);var Pb=class{constructor(){this.arr=[];this.iterIdx=0}get size(){return this.arr.length}count(e){return ci(this.arr,e)}unshift(...e){this.arr.splice(this.iterIdx,0,...e)}push(...e){this.unshift(...e),this.incrIdx(e.length)}remove(e){return this.filterInPlace(r=>r!==e)}filterInPlace(e){let r=!1;return wt(this.arr,(i,o,n)=>{let s=e(i,o,n);return s||(r=!0,o<this.iterIdx&&this.iterIdx--),s}),this.incrIdx(0),r}next(e=()=>!0){if(this.size===0)return{value:void 0,done:!0};for(let r=0;r<this.size;r++){let i=this.arr[this.iterIdx];if(this.incrIdx(),i!=null&&e(i))return{value:i,done:!1}}return{value:void 0,done:!0}}toA(e=()=>!0){if(R(this.arr))return[];let r=[];for(let i=0;i<this.size;i++){let o=this.arr[(this.iterIdx+i)%this.arr.length];e(o)&&r.push(o)}return r}incrIdx(e=1){this.iterIdx=this.arr.length===0?0:(this.iterIdx+e)%this.arr.length}};wn(()=>ju());Yx(()=>C(ju));var JV=new Yt,uL=new Yt,Eb=new Pb,RWe=new ta({name:"Idle",callback:ju,intervalMs:7*M,initialDelayMs:20*M}),cL=async()=>!1;function fL(t){cL=t}async function pL(){return Ar()||G()||Eb.size===0||uL.pendingCount>=yt()||await cL()}var $V=yt()>4?250:750;async function ju(){return await pL()?void 0:JV.maybeRun("runOnIdle",async()=>{if(await pL())return;let{value:t}=Eb.next(e=>e.runnable);t!=null&&uL.push(t.name,async()=>t.onIdle()).finally(()=>ju),Eb.size>0&&C(ju,$V)})}var OL=T(require("@sentry/node"));var Hu=l(()=>d("EventStore")),dL=7;function sd(t){return Gt(t,"breadcrumbs")}var Db=class{constructor(){this.root=ie.for(xi()).join("events")}datedRoot(e=new Date){return this.root.joinYMD(e)}rmrf(){return this.root.rmrf()}msg2file(e){return this.datedRoot(new Date(e.timestamp*M)).join(Jr(e.message,8,Ps)+".json")}async eventsFrom(e=new Date){return A(await this.datedRoot(e).childFiles(r=>r.ext===".json"&&!r.isHiddenPosix()))}async eventQuotaExceeded(e){let r=h(e).includes(ko)||h(e.message).includes(ko),i=await this.eventCount(),o=c.maxErrorsPerDay.valueOrDefault+(r?dL:0);return i>=o}async eventCount(e=new Date){return(await this.eventsFrom(e)).length}async maybeSendEvent(e){if(G())return Hu().error("maybeSendEvent(): REJECT: we're ending.",{event:sd(e)}),null;try{let r=Uc(e.message),i=await this.eventCount(),o=c.maxErrorsPerDay.valueOrDefault+(r?dL:0);return i>=o?(Hu().error("maybeSendEvent(): REJECT: too many events sent in the last day.",{recentEventCount:i,pleaseSend:r,maxErrorsPerDay:o,event:sd(e)}),null):await this.writeEvent(e)==null?(Hu().error("maybeSendEvent(): REJECT: event was already sent in the last day.",{event:sd(e)}),null):(Hu().error("maybeSendEvent(): ACCEPT",{event:sd(e),pleaseSend:r,recentEventCount:i,maxErrorsPerDay:o}),e)}catch(r){return Hu().error("maybeSendEvent(): Failed to determine if we should squelch the event. Failing closed.",r),null}}async writeEvent(e){let r=this.msg2file(e);return b(r.ensureNew_({maxVersions:c.maxErrorsPerDay.valueOrDefault,emptyIsNew:!1}).catch(()=>{}),i=>i.writeJsonMaybe(e))}},ql=Db;ql.instance=l(()=>new Db);var Ku=T(require("@sentry/node")),Ju=T(vL()),pd=T(require("os")),dd=T(require("process"));var Ab=class{constructor(e,r){this.maxLength=e;this.toValue=r;this.sortedArray=new Bs(r)}toArray(){return this.sortedArray.store}vacuum(){return this.sortedArray.length>this.maxLength&&Sc(this.sortedArray.store,this.maxLength),this.toArray()}get min(){return this.sortedArray.length>=this.maxLength?this.toValue(this.sortedArray[0]):void 0}add(...e){let r=this.min;for(let i of e)if(i!=null){let o=this.toValue(i);o!=null&&(Fw(o,r)||this.sortedArray.add(i))}this.sortedArray.length>=2*this.maxLength&&this.vacuum()}};var SL=T(require("fs")),ud=T(require("zlib"));var ML=2048,oz=ML/4,Fb=class{constructor(e,r){this.f=e;this.lines=new Bs(nl);this._hasFirstLine=!1;this._ended=!1;this._paused=!1;this._errors=!1;this.from=Kr(e.name),this.fileStream=(0,SL.createReadStream)(e.nativePath,{autoClose:!0}),this.stream=(e.ext.toLowerCase().endsWith(".gz")?this.fileStream.pipe((0,ud.createGunzip)()):e.ext.toLowerCase().endsWith(".br")?this.fileStream.pipe((0,ud.createBrotliDecompress)()):this.fileStream).pipe(new Ds).on("error",i=>{r(i),this._errors=!0}),this.stream.on("data",this.onData.bind(this)),this.stream.on("end",()=>{this._ended=!0})}onData(e){let r=kS(e);r!=null&&(this.lines.add(y(y({},r),{from:this.from})),this._hasFirstLine=!0),this.lines.length>ML&&!this._paused&&(this.fileStream.pause(),this._paused=!0)}toString(){return"LogReader("+this.f.nativePath+")"}hasFirstLine(){return this._hasFirstLine}hasErrors(){return this._errors}ended(){return this._ended&&this.lines.length===0}peek(){return this.lines.store[0]}shift(){let e=this.lines.store.shift();return e!=null&&this.lines.length<oz&&this._paused&&(this.fileStream.resume(),this._paused=!1),e}};function nz(t=10*E){let e=Date.now()-t;return b($r.for(c.logDir.valueOrDefault),r=>r.filterDescendantFiles(async i=>[".log",".log.gz"].includes(i.ext)&&ji(await i.mtimeMs(),e)))}async function PL(t=50){await Df();let e=ft(qt.values.map(n=>[n,new Ab(t,nl)])),r=Date.now()-Ot,i=d("allRecentLogEntries()");return await b(nz(),n=>pi({name:"allRecentLogEntries()",laters:n.map(s=>async()=>{try{let a=[],m=new Fb(s,u=>a.push(u));for(await je(()=>m.hasFirstLine(),{timeoutMs:10*M});!m.ended()&&!m.hasErrors();){let u=m.shift();u==null?await fr(5):u.ts>r&&e[u.l]?.add(u)}_(a)&&(i.warn("Read error(s) for "+s,a),a.some(u=>u.code==="Z_BUF_ERROR"||ce(u).includes("unexpected end of file"))&&Di(await s.mtimeMs(),Date.now()-E)&&(i.warn("Unlinking corrupt logfile "+s),await s.unlink_()))}catch(a){i.warn("Failed to read entries from "+s,a)}})})),ae(ct(e).map(n=>n.vacuum())).sort((n,s)=>Vt(n.ts,s.ts))}var EL=T(require("child_process")),DL=T(require("fs")),To=T(require("os"));var Lb=l(()=>d("os")),cd=l(()=>[sz(),"on",(0,To.arch)()].join(" "));function sz(){switch((0,To.platform)()){case"linux":return az();case"darwin":return lz();case"win32":return mz();default:return Gu()}}function Gu(){return(0,To.platform)()+" "+(0,To.release)()}function az(){try{let t=(0,DL.readFileSync)("/etc/os-release").toString(),e=qf({input:t,lowerCaseKeys:!0});if(P(e.pretty_name))return e.pretty_name;let r=x(e.version,e.version_id);return un(e.name,r,(i,o)=>i+" "+o,Gu)}catch(t){return Lb().warn("Failed to fetch /etc/os-release",t),Gu()}}function AL(t){return t.split(".").slice(0,2).join(".")}var uz={"10.6":"Snow Leopard","10.7":"Lion","10.8":"Mountain Lion","10.9":"Mavericks","10.10":"Yosemite","10.11":"El Capitan","10.12":"Sierra","10.13":"High Sierra","10.14":"Mojave","10.15":"Catalina","11.1":"Big Sur"},FL=l(()=>(0,EL.execSync)("sw_vers -productVersion").toString().trim());function cz(t=FL()){return uz[AL(t)]}function lz(t=FL()){try{return li(cz(t),e=>`macOS ${e} (${t})`,Gu)}catch(e){return Lb().warn("osNameMac(): unknown release",e),Gu()}}var fz={"10.0":"10","6.3":"8.1","6.2":"8","6.1":"7","6.0":"Vista","5.2":"Server 2003","5.1":"XP","5.0":"2000","4.9":"ME","4.1":"98","4.0":"95"};function mz(t=(0,To.release)()){let e=fz[AL(t)];return e!=null?`Windows ${e} (${t})`:(Lb().warn("osNameWin(): unknown release: "+t),`Windows (${t})`)}var fd=l(()=>cx((0,To.cpus)().map(t=>t.model)).map(t=>`${t.count} \xD7 ${t.t}`).join(", "),E);var hd=d("Sentry"),pz=100;async function LL(t){try{return xo()?(Ku.default.init({dsn:Xt?"https://0652cdd351054fe9853ff944b1f54e2c@sentry.io/289071":"https://408e2f8d62c3494d8ed663d9e488d67a@sentry.io/1828379",shutdownTimeout:Af(t.name),release:UT,environment:Fo,maxBreadcrumbs:pz,integrations:()=>[],beforeSend:dz().beforeSend,onFatalError:e=>X("sentry.onFatalError",e)}),!0):!1}catch(e){return hd.warn("Failed to set up sentry: "+e),!1}}function IL(t,e){xo()&&(e!=null&&!Wc(e)?Ku.default.captureException(JT(e,t)):Wc(t)||Ku.default.captureMessage(t))}var dz=l(()=>new RL),RL=class{constructor(){this.eventStore=ql.instance();this.beforeSend=async(e,r)=>{if(!xo())return hd.warn("Sentry.beforeSend(): not sending event",e),null;if(await this.eventStore.eventQuotaExceeded(e))return hd.warn("Sentry.beforeSend(): event quota exceeded",e),null;let i=hz(e,r);if(Wc(i))return hd.info("Sentry.beforeSend(): event not sendable. vetoing",{event:e,hint:r,msg:i}),null;S(e.message)&&(e.message=ur(i,256));let o=await Ib(e);return this.eventStore.maybeSendEvent(o)};Nc(IL),tT(IL),new lt("EventFilter",()=>this.end(),ue.first)}end(){return f(Ku.default.getCurrentHub().getClient(),e=>e.close(5*M))}};function hz(t,e){return K(cn([t.message,...A(gz(t.exception?.values)),ce(e?.originalException)])).join(": ")}function gz(t){return Oe(t,e=>V(e.map(yz)))}function yz(t){return Oe(V([t?.type,t?.value].filter(e=>h(e).toLowerCase()!=="error")),e=>e.join(": "))}async function Ib(t){let e=c.email.value;P(e)&&(t.user==null&&(t.user={}),t.user.email=e),R(t.breadcrumbs)&&(t.breadcrumbs=await Rb());let r=x(t.extra,{});return r.pid=dd.default.pid,r.serviceName=rr(),r.serviceEnding=G(),r.runtimeMs=Date.now()-fi,r.version=Ke,r.os=cd(),r.isDocker=de(),r.nodeVersion=dd.default.versions.node,r.locale=await gf(),r.cpus=fd(),r.memoryUsageMb=L0(),r.memoryUsageRssMb=I0(),r.systemMemory=Ut((0,pd.freemem)())+" / "+Ut((0,pd.totalmem)()),r.ffmpeg=await CD(),r.vlc=await qD(),r.argv=O(dd.default.argv),t.extra=r,y({timestamp:Date.now()/M},t)}async function Rb(){await yr("writeRecentLogEntries"),await fr(kn*3);let t=await PL();return F(t.map(bz))}function bz(t){return f(wz(t.l),e=>({timestamp:t.ts/M,level:e,category:x(t.from,Yr()),message:Yi(t.ctx+": "+t.msg),data:typeof t.meta=="object"?t.meta:{value:Rt(t.meta)?Yi(t.meta):t.meta}}))}function wz(t){switch(t){case"error":return Ju.Severity.Error;case"warn":return Ju.Severity.Warning;case"info":return Ju.Severity.Info;case"debug":return Ju.Severity.Debug;default:return}}function xz(){return"User requested recent logs at "+new Date().toISOString()+ko}async function gd(){let t=xz(),e=await Ib({message:t,breadcrumbs:await Rb()});return xo()?OL.default.captureEvent(e):await ql.instance().writeEvent(e),e}var Tz=l(()=>{aT(()=>Df()),wn(()=>Pu()),Ra(()=>Mu())}),Ob=class{constructor(e){this.opts=e;this._exitted=!1;this._ready=new Wt;this.jobs=new Yt;this.onFatalHandlers=[];this.inputHandlers=new Map;this.setup=l(async()=>{this.logger.info("setup()");let e=()=>!this._exitted&&!G();try{U(Ve("PS_FATAL_"+this.name),i=>{throw new me({fatal:!0,message:i})}),U(Ve("PS_CRASH_"+this.name),i=>{C(()=>{throw new me({message:i})},5*M)});{let i=Tr()+(this.name===al.main?"":` ${this.name}`),o=ut.default;try{o.title=i}catch{}}if(await bl(),pt()&&await ep(),await this.setupErrorHandling(),this.logStartup(),Nr()&&(await this.maybeUpgradeSystemSettings(),await this.maybeUpgradeLibrarySettings()),Tz(),fL(k0),await this.stdinReadline(),e()){let i=ht.instance();if(i==null&&!Lf())throw new Error("Cannot start, library path is unset"+pe);i!=null&&await i.ready}Jn();let r=!e();this.logger.debug("setup done.",{reject:r}),r?this._ready.reject():this._ready.resolve()}catch(r){console.error(Jt(r)),this._ready.reject(r),this.exit({reason:Vc(this.name+" setup failed: "+ce(r),pe),status:14,waitForJobs:!1})}});this.stdinReadline=l(()=>{let e=ut.default.stdin.pipe(new Ds);return e.on("data",r=>this.onLine(h(r))),e});Ff(this.name=this.opts.name),qm(),c.logDir.addListener(()=>qm()),c.tailLogs.valueOrDefault&&nd.instance(),this.logger=d("Service("+this.name+")"),this.addDefaultInputHandlers(),this.jobs.push("Service.setupOrTimeout",()=>this.setupOrTimeout())}async setupOrTimeout(){{let r=await xe(this.setup().then(()=>!0),c.setupTimeoutMs.valueOrDefault);if(L(r))return}let e=Xp(V0()?.nativePath);if(e!=null){let r=e/10,i=r-(Date.now()-fi);i>0&&this.logger.warn("Startup is taking a while, but the database looks like it's large, so we're going to wait for another "+wg(i),{dbFileSize:e,timeoutMs:r,setupTimeoutMs:c.setupTimeoutMs.valueOrDefault});let o=await xe(this.setup().then(()=>!0),i);if(L(o))return}return this.exit({reason:"Setup timed out after "+wg(Date.now()-fi)+`.
Please visit https://photostructure.com/troubleshooting for help.`,status:13,waitForJobs:!1})}get ready(){return this._ready.promise}get isReady(){return this._ready.resolved}get exitted(){return this._exitted}onFatal(e){this.onFatalHandlers.push(e)}logStartup(){this.logger.info("setup()",y({version:Ke,start:fi,argv:ut.default.argv,arch:ut.default.arch,platform:ut.default.platform,isDocker:de(),isPacked:No,isElectron:Xt,versions:ut.default.versions,settings:{logLevel:c.logLevel.valueOrDefault,httpPort:c.httpPort.valueOrDefault,rpcPort:c.rpcPort.valueOrDefault,libraryPath:c.libraryPath.valueOrDefault}},Zv()))}async maybeUpgradeSystemSettings(){Ke!==await LP()&&await js()}async maybeUpgradeLibrarySettings(){pt()&&Ke!==await IP()&&await Hs()}async setupErrorHandling(){if(Me.on("fatal",({message:e,error:r})=>this.exit({reason:e+f(r,i=>": "+ce(i)),status:12,waitForJobs:!1})),this.setInputHandler("--send-recent-logs",()=>gd()),ut.default.on("unhandledRejection",e=>f(e,r=>X("unhandledRejection",r))),ut.default.on("uncaughtException",e=>f(e,r=>X("uncaughtException",r))),ut.default.on("SIGINT",()=>this.exit({reason:"SIGINT",status:0,waitForJobs:!1})),ut.default.on("SIGTERM",()=>this.exit({reason:"SIGTERM",status:0,waitForJobs:!1})),ut.default.on("SIGCHLD",(...e)=>this.logger.debug("Received SIGCHLD",e)),ut.default.on("disconnect",()=>this.exit({reason:"disconnect",status:0,waitForJobs:!1})),ml()||Nr()&&de())this.logger.info("setupErrorHandling(): not adding stdin/stdout/stderr close handlers: we're daemonized or in docker.");else{let e=!0;ut.default.stdin.on("close",()=>this.exit({reason:"stdin.close",status:0,waitForJobs:e})),ut.default.stdin.on("error",r=>this.logger.warn("stdin.error: "+r)),ut.default.stdin.on("disconnect",()=>this.exit({reason:"stdin.disconnect",status:0,waitForJobs:e})),ut.default.stdout.on("disconnect",()=>this.exit({reason:"stdout.disconnect",status:0,waitForJobs:e})),ut.default.stdout.on("error",r=>this.logger.warn("stdout.error: "+r)),ut.default.stderr.on("disconnect",()=>this.exit({reason:"stderr.disconnect",status:0,waitForJobs:e})),ut.default.stderr.on("error",r=>this.logger.warn("stderr.error: "+r))}await LL(this)}async exit({reason:e,status:r,waitForJobs:i}){if(this._exitted=!0,this.logger.info("exit()",{status:r,reason:e,waitForJobs:i,ending:G()}),i&&(await fr(250),await je(()=>(this.logger.info("exit(): waiting for enqueued jobs to complete...",{pendingNames:this.jobs.pendingNames()}),this.jobs.settled),{timeoutMs:void 0,timeBetweenMs:M}),this.logger.info("exit(): enqueued jobs finished.")),r!==0){await Promise.all(this.onFatalHandlers.map(n=>n(e)));let o={fatal:!0,exit:!0,status:r,pid:ut.default.pid,ppid:ut.default.ppid};o.error=e,ze(()=>Ct(o,!1))}return await Hx(),ut.default.exit(r)}setInputHandler(e,r){this.inputHandlers.set(e.trim().toLowerCase(),r)}addDefaultInputHandlers(){this.setInputHandler("--version",async()=>{Ct({version:Ke})}),this.setInputHandler("--status",async()=>{let e=await Zo();return this.logger.debug("--status",e),Ct({healthChecks:e})}),this.setInputHandler("--quit",()=>C(()=>this.exit({reason:"--quit from stdin",status:0,waitForJobs:!0}))),this.setInputHandler(vb,()=>C(()=>this.exit({reason:vb+" from stdin",status:0,waitForJobs:!0}))),this.setInputHandler("--pause",()=>(Mu(),Ct({paused:Ar()},!1))),this.setInputHandler("--resume",()=>(Pu(),Ct({paused:Ar()},!1)))}onLine(e){return this.logger.debug("onLine()",{line:e,ending:this._exitted||G()}),this.jobs.serial("Service.onLine("+e+")",async()=>{if(await this.setup(),e.trim().startsWith("--")){let r=e.split(" ",1)[0],i=this.inputHandlers.get(r);i==null?(this.logger.error("onLine(): unknown command",{line:e}),console.warn("unknown command "+e)):await i(e.substr(r.length).trim())}else try{await f(this.opts.stdinReceiver,r=>r(e))}catch(r){this.logger.error("onLine(): failed to process",{line:e,error:r})}})}};var _L=T(require("path")),NL=T(require("process"));function kL(t){let e=oe.for(t);if(!e.isDirectorySync())return!1;let r=At(e);if(r==null||!en(r,"models").isFileSync())return!1;let o=yl(e.nativePath);return!(o==null||!o.isFileSync())}var aa=class{constructor(e,r,i,o){this.path=e;this.availableBytes=r;this.mountpoint=i;this.label=o}get isCurrentLibrary(){return c.libraryPath.value===this.path}get isLibrary(){return kL(this.path)}get free(){return Ut(this.availableBytes,2)}get wbrPath(){return Da(this.path)}},la=d("SuggestedLibraryPath");async function BL(t=c.minDiskFreeGb.valueOrDefault*Sr,e=6,r){let i=[],o=NL.env[TS];if(fe&&o!=null)return nt(o.split(_L.delimiter).map(u=>_r(u)).map((u,p)=>new aa(u,(p+1)*1e12,u)),u=>la.info("Using ENV",u));if(await f(c.libraryPath.value,u=>b(ao(u),p=>i.push(new aa(u,p.available,p.mountpoint,p.label)))),de())return i;let n=await Ee(r,()=>b(Dt(),u=>[...u]));if(n==null||R(n))return la.warn("volumes() is empty: they don't get any suggestions."),[];let s=await rl(),a=await Xm(n,s);a==null?la.warn("Cannot find volume for Pictures directory, "+s):a.available<t?la.info("Pictures directory, "+s+" only has "+Ut(a.available)+" free"):c.libraryPath.value===s?la.info("Pictures directory is already the current library path"):i.push(new aa(s,a.available,a.mountpoint,cn([a.label,"Your Pictures directory"]).join(" ")));let m=V(i.map(u=>u.mountpoint));for(wt(n,u=>!(m.includes(u.mountpoint)||u.mountpoint==="/")),n.sort((u,p)=>p.available-u.available);i.length<e&&n.length>0&&n[0].available>t;){let u=n.shift(),p=ie.for(u.mountpoint).join(Tr()),g=i.find(v=>v.mountpoint===u.mountpoint||v.path===p.nativePath);if(g!=null){la.info("Skipping suggestion for "+p+": already a suggestion",{prior:g});continue}if(await p.isDirectory()&&await p.isNotReadWritable()){la.info("Skipping suggestion for "+p+": existing directory is not read/writeable",{drive:u});continue}i.push(new aa(p.nativePath,u.available,u.mountpoint,u.label))}return i}var zL=T(require("express"));var yd=T(require("os")),kb=T(require("process"));async function CL(t,e="(missing)"){try{let r=await t();return S(r)?e:r}catch(r){let i=yi(r);return S(i)?e:i}}async function vz(){if(ht.instance()==null)return;let t=[];t.push(_c(await Ie.shownAssetCounts(),"asset"));let e=await Re.assetCountByMimetypeRoot();for(let r of e)t.push(_c(r.count,r.mimetypeRoot+" file"));return t.push(_c(await ge.rows(),"tag")),t}async function VL(t){let e=await gu(t),r=await wp(),i=await fo(),o=i?.l?.tier??"lite";return F([{term:"Version",defn:Ke},{term:"Edition",defn:Lo+(Xt?` for Desktops (${c.updateChannel.valueOrDefault} channel)`:de()?" for Docker":" for Servers")},{term:"Plan",defnClass:o,defn:o},L(i?.ok)?{term:"Licensed to",defn:i?.l?.sub}:void 0,{term:"OS",defn:cd()+(de()?" (docker)":"")},I?{term:"PowerShell",defn:await CL(()=>Te.instance().version())}:void 0,Xt?void 0:{term:"Node.js",defn:kb.default.versions.node},U(kb.default.versions.electron,n=>({term:"Electron",defn:n})),de()?{term:"ExifTool",defn:await CL(()=>WA())}:void 0,{term:"Video support",termURL:"https://photostructure.com/getting-started/video-support/",defn:e.msg,defnClass:e.ok?"ok":"warn"},{term:"HEIF support",termURL:"https://photostructure.com/getting-started/heif-support/",defn:r.msg,defnClass:r.ok?"ok":"warn"},we(yd.default.freemem(),n=>({term:"Free memory",defn:Ut(n,2)+" / "+Ut(yd.default.totalmem(),2),defnClass:yd.default.totalmem()<2*cm?"warn":"ok",defnTitle:"PhotoStructure requires at least 2 GB of RAM"})),{term:"CPUs",defn:fd()},{term:"Concurrency",defn:`Target system use: ${Fe(c.cpuLoadPercent.valueOrDefault,2)}% (${pm()} syncs, ${dm()} threads/sync)`},ll()?{term:"Web uptime",defn:an(Date.now()-fi)}:void 0,U(dh(),n=>({term:"Device",defn:n})),await b(vz(),n=>({term:"Library metrics",termURL:"https://photostructure.com/faq/metrics/",defn:n})),{term:"Library path",defn:x(c.libraryPath.value,"(unset)"),defnClass:c.libraryPath.isUnset()?"warn":"tt"}]).filter(({term:n,defn:s})=>P(n)&&P(s))}async function Sz(){return{rootTags:ge.db()==null?void 0:await ge.roots(),title:Tr()}}var Mz=l(()=>d("PugHelpers"));async function rs(t,e,r,i={}){let o=t.headers["user-agent"],n=[],s=o?.toLowerCase().includes("electron")===!0&&hl(t.ip)||L(t.query.electron);s&&n.push("electron"),re&&n.push("mac"),Ue&&n.push("linux"),I&&n.push("win");let a=y(y(y({},await Sz()),{bodyClass:n.join(" "),isDocker:de(),isElectron:s,isDev:Kw,nonce:e.locals.cspNonce,hasEmail:c.email.hasValue()}),i);Mz().debug("render()",{template:r,options:a}),e.render(r,a)}var _b=class{router(){return zL.default.Router().get("/about",Le("AboutRouter",this.about.bind(this)))}async about(e,r,i){let o=await Zo(),n=await xe(()=>VL(e.query),7*M,()=>{o.bad.push("Fetching system information took too long.")});Tt||(o.fail.push(...A(e.query.fail).map(h)),o.bad.push(...A(e.query.bad).map(h)),o.warn.push(...A(e.query.warn).map(h)),o.ok.push(...A(e.query.ok).map(h)));let s=await xe(b(Dt(),m=>m.map(u=>({mountpoint:u.mountpoint,uuid:u.uuid,volsha:f(u.uuid,Us),size:Ut(u.size,2),free:Ut(u.available,2),full:u.available<c.minDiskFreeGb.valueOrDefault*Sr,label:u.label,remote:u.remote?{remote:u.remote,host:u.remoteHost,share:u.remoteShare}:void 0}))),7*M,()=>{o.bad.push("Fetching volume information took too long.")}),a=await fo();return rs(e,r,"about",{systemInfo:n,health:o,volumes:s?.map(m=>y(y({},m),{mountpoint:Da(m.mountpoint)})),title:"About PhotoStructure",subTier:await Js(),subTrial:L(a?.l?.trial),subEmail:a?.l?.sub,subExpiresInDuration:f(a?.l?.exp,m=>an(m.getTime()-Date.now(),1)),subExpiresAt:f(a?.l?.exp,fn)})}};var tI=T(require("express"));function WL(t,e){return qo(e)===0?t:new UL([...t]).rotate(e).m}var UL=class{constructor(e,r=1){this.m=e;this.ary=r;if(this.rows=Math.sqrt(e.length/r),this.rows!==Math.floor(this.rows))throw new Error(`Only square tuple matrices are supported: ${this.ary===1?"":this.ary}(${this.rows}\xD7${this.rows}) != ${e.length}`)}index(e,r){return this.ary*(r+e*this.rows)}swap(e,r){for(let i=0;i<this.ary;i++){let o=this.m[e+i];this.m[e+i]=this.m[r+i],this.m[r+i]=o}}transpose(){for(let e=0;e<this.rows;e++)for(let r=e+1;r<this.rows;r++)this.swap(this.index(e,r),this.index(r,e));return this}reverseRows(){for(let e=0;e<this.rows;e++)for(let r=0;r<this.rows/2;r++)this.swap(this.index(r,e),this.index(this.rows-1-r,e));return this}reverseCols(){for(let e=0;e<this.rows;e++)for(let r=0;r<this.rows/2;r++)this.swap(this.index(e,r),this.index(e,this.rows-1-r));return this}reverse(){let e=this.rows**2;for(let r=0;r<e/2;r++)this.swap(r,e-1-r);return this}rotate(e){switch(qo(e)){case 0:break;case 90:this.transpose(),this.reverseCols();break;case 180:this.reverse();break;case 270:this.transpose(),this.reverseRows();break;default:throw new Error("unsupported rotate("+e+")")}return this}};var Pz=l(()=>[{name:"Acid green",rgb:"#B0BF1A"},{name:"Amaranth",rgb:"#E52B50"},{name:"Amethyst",rgb:"#9966CC"},{name:"Antique brass",rgb:"#CD9575"},{name:"Antique bronze",rgb:"#665D1E"},{name:"Antique fuchsia",rgb:"#915C83"},{name:"Apple green",rgb:"#8DB600"},{name:"Apricot",rgb:"#FBCEB1"},{name:"Aqua",rgb:"#00FFFF"},{name:"Aquamarine",rgb:"#7FFFD4"},{name:"Artichoke",rgb:"#8F9779"},{name:"Ash grey",rgb:"#B2BEB5"},{name:"Asparagus",rgb:"#87A96B"},{name:"Avocado",rgb:"#568203"},{name:"Azure",rgb:"#4988F5"},{name:"Beaver",rgb:"#9F8170"},{name:"Beige",rgb:"#F6F1DE"},{name:"Bistre",rgb:"#3D2B1F"},{name:"Black coffee",rgb:"#3B2F2F"},{name:"Black olive",rgb:"#3B3C36"},{name:"Black pearl",rgb:"#041322"},{name:"Black",rgb:"#000000"},{name:"Blond",rgb:"#FAF0BE"},{name:"Blood red",rgb:"#660000"},{name:"Blue bell",rgb:"#A2A2D0"},{name:"Blue sapphire",rgb:"#126180"},{name:"Blue-green",rgb:"#0D98BA"},{name:"Blue-violet",rgb:"#7366BD"},{name:"Blue",rgb:"#1F75FE"},{name:"Brandy",rgb:"#87413F"},{name:"Brick red",rgb:"#CB4154"},{name:"Bright green",rgb:"#66FF00"},{name:"Bright lilac",rgb:"#D891EF"},{name:"Brink pink",rgb:"#FB607F"},{name:"Bronze",rgb:"#CD7F32"},{name:"Brown",rgb:"#88540B"},{name:"Bud green",rgb:"#7BB661"},{name:"Burgundy",rgb:"#800020"},{name:"Burnished brown",rgb:"#A17A74"},{name:"Burnt orange",rgb:"#CC5500"},{name:"Burnt sienna",rgb:"#E97451"},{name:"Burnt umber",rgb:"#8A3324"},{name:"Byzantium",rgb:"#702963"},{name:"Cadet blue",rgb:"#5F9EA0"},{name:"Cadet",rgb:"#536872"},{name:"Cadmium green",rgb:"#006B3C"},{name:"Cadmium red",rgb:"#E30022"},{name:"Candy pink",rgb:"#E4717A"},{name:"Cardinal",rgb:"#C41E3A"},{name:"Caribbean green",rgb:"#00CC99"},{name:"Carmine",rgb:"#960018"},{name:"Carnelian",rgb:"#B31B1B"},{name:"Cerise",rgb:"#DE3163"},{name:"Cerulean blue",rgb:"#2A52BE"},{name:"Cerulean",rgb:"#007BA7"},{name:"Champagne",rgb:"#F3E5AB"},{name:"Charcoal",rgb:"#36454F"},{name:"Chartreuse",rgb:"#DFFF00"},{name:"Chestnut",rgb:"#954535"},{name:"Chocolate",rgb:"#7B3F00"},{name:"Citrine",rgb:"#E4D00A"},{name:"Citron",rgb:"#9FA91F"},{name:"Claret",rgb:"#7F1734"},{name:"Cobalt blue",rgb:"#0047AB"},{name:"Cocoa brown",rgb:"#D2691E"},{name:"Coffee",rgb:"#6F4E37"},{name:"Cool grey",rgb:"#8C92AC"},{name:"Copper red",rgb:"#CB6D51"},{name:"Copper rose",rgb:"#996666"},{name:"Copper",rgb:"#B87333"},{name:"Coral",rgb:"#F88379"},{name:"Cornflower blue",rgb:"#6495ED"},{name:"Cosmic cobalt",rgb:"#2E2D88"},{name:"Cotton candy",rgb:"#FFBCD9"},{name:"Crimson",rgb:"#DC143C"},{name:"Cyan",rgb:"#00B7EB"},{name:"Cyclamen",rgb:"#F56FA1"},{name:"Cyprus",rgb:"#003E40"},{name:"Dark brown",rgb:"#654321"},{name:"Dark byzantium",rgb:"#5D3954"},{name:"Dark cornflower blue",rgb:"#26428B"},{name:"Dark cyan",rgb:"#008B8B"},{name:"Dark goldenrod",rgb:"#B8860B"},{name:"Dark green",rgb:"#006400"},{name:"Dark liver",rgb:"#534B4F"},{name:"Dark magenta",rgb:"#8B008B"},{name:"Dark moss green",rgb:"#4A5D23"},{name:"Dark olive green",rgb:"#556B2F"},{name:"Dark orange",rgb:"#FF8C00"},{name:"Dark orchid",rgb:"#9932CC"},{name:"Dark pastel green",rgb:"#03C03C"},{name:"Dark powder blue",rgb:"#003399"},{name:"Dark purple",rgb:"#301934"},{name:"Dark red",rgb:"#8B0000"},{name:"Dark salmon",rgb:"#E9967A"},{name:"Dark sea green",rgb:"#8FBC8F"},{name:"Dark sienna",rgb:"#3C1414"},{name:"Dark slate blue",rgb:"#483D8B"},{name:"Dark slate grey",rgb:"#2F4F4F"},{name:"Dark spring green",rgb:"#177245"},{name:"Dark turquoise",rgb:"#00CED1"},{name:"Dark violet",rgb:"#9400D3"},{name:"Deep blue",rgb:"#0066FF"},{name:"Deep chestnut",rgb:"#B94E48"},{name:"Deep saffron",rgb:"#FF9933"},{name:"Deep sky blue",rgb:"#00BFFF"},{name:"Deep space",rgb:"#000040"},{name:"Deep taupe",rgb:"#7E5E60"},{name:"Denim",rgb:"#1560BD"},{name:"Desert",rgb:"#C19A6B"},{name:"Dim grey",rgb:"#696969"},{name:"Drab",rgb:"#967117"},{name:"Earth yellow",rgb:"#E1A95F"},{name:"Ebony",rgb:"#555D50"},{name:"Ecru",rgb:"#C2B281"},{name:"Eggplant",rgb:"#614051"},{name:"Eggshell",rgb:"#F0EAD6"},{name:"Elderberry",rgb:"#171828"},{name:"Electric blue",rgb:"#7DF9FF"},{name:"Electric purple",rgb:"#BF00FF"},{name:"Emerald",rgb:"#50C878"},{name:"English green",rgb:"#1B4D3E"},{name:"English lavender",rgb:"#B48395"},{name:"English red",rgb:"#AB4B52"},{name:"Fern green",rgb:"#4F7942"},{name:"Fire opal",rgb:"#E95C4B"},{name:"Firefly",rgb:"#0E2A30"},{name:"Flame",rgb:"#E25822"},{name:"Flax",rgb:"#EEDC82"},{name:"Forest green",rgb:"#014421"},{name:"French beige",rgb:"#A67B5B"},{name:"French blue",rgb:"#0072BB"},{name:"French lilac",rgb:"#86608E"},{name:"French sky blue",rgb:"#77B5FE"},{name:"Fuchsia purple",rgb:"#CC397B"},{name:"Fuchsia",rgb:"#FF00FF"},{name:"Gold",rgb:"#E6BE8A"},{name:"Golden brown",rgb:"#996515"},{name:"Golden yellow",rgb:"#FFDF00"},{name:"Goldenrod",rgb:"#DAA520"},{name:"Glacier blue",rgb:"#C8DDE8"},{name:"grey",rgb:"#808080"},{name:"Green-blue",rgb:"#2887C8"},{name:"Green-yellow",rgb:"#ADFF2F"},{name:"Green",rgb:"#00A000"},{name:"Harvest gold",rgb:"#DA9100"},{name:"Heliotrope grey",rgb:"#AA98A9"},{name:"Heliotrope",rgb:"#DF73FF"},{name:"Hot magenta",rgb:"#FF1DCE"},{name:"Hot pink",rgb:"#FF69B4"},{name:"Imperial red",rgb:"#ED2939"},{name:"Indigo dye",rgb:"#00416A"},{name:"Indigo",rgb:"#4B0082"},{name:"Iris",rgb:"#5A4FCF"},{name:"Jade",rgb:"#00A86B"},{name:"Jasper",rgb:"#113126"},{name:"Jet",rgb:"#343434"},{name:"Jungle green",rgb:"#29AB87"},{name:"Kelly green",rgb:"#4CBB17"},{name:"Key lime",rgb:"#E8F48C"},{name:"Khaki",rgb:"#C3B091"},{name:"Lapis lazuli",rgb:"#26619C"},{name:"Laurel green",rgb:"#A9BA9D"},{name:"Lavender grey",rgb:"#C4C3D0"},{name:"Lavender",rgb:"#B57EDC"},{name:"Licorice",rgb:"#1A1110"},{name:"Light blue",rgb:"#ADD8E6"},{name:"Light coral",rgb:"#F08080"},{name:"Light grey",rgb:"#D3D3D3"},{name:"Light green",rgb:"#90EE90"},{name:"Light periwinkle",rgb:"#C5CBE1"},{name:"Light pink",rgb:"#FFB6C1"},{name:"Light salmon",rgb:"#FFA07A"},{name:"Light sea green",rgb:"#20B2AA"},{name:"Light steel blue",rgb:"#B0C4DE"},{name:"Light yellow",rgb:"#FFFFE0"},{name:"Lilac",rgb:"#C8A2C8"},{name:"Lime",rgb:"#BFFF00"},{name:"Linen",rgb:"#FAF0E6"},{name:"Magenta",rgb:"#FF0090"},{name:"Mahogany",rgb:"#C04000"},{name:"Malachite",rgb:"#0BDA51"},{name:"Mango",rgb:"#FDBE02"},{name:"Marigold",rgb:"#EAA221"},{name:"Maroon",rgb:"#800000"},{name:"Mauve taupe",rgb:"#915F6D"},{name:"Mauve",rgb:"#B783A9"},{name:"Medium aquamarine",rgb:"#66DDAA"},{name:"Medium blue",rgb:"#0000CD"},{name:"Medium orchid",rgb:"#BA55D3"},{name:"Medium purple",rgb:"#9370DB"},{name:"Medium sea green",rgb:"#3CB371"},{name:"Medium slate blue",rgb:"#7B68EE"},{name:"Medium spring green",rgb:"#00FA9A"},{name:"Medium turquoise",rgb:"#48D1CC"},{name:"Middle blue green",rgb:"#8DD9CC"},{name:"Middle blue purple",rgb:"#8B72BE"},{name:"Middle blue",rgb:"#7ED4E6"},{name:"Middle green yellow",rgb:"#ACBF60"},{name:"Middle green",rgb:"#4D8C57"},{name:"Middle purple",rgb:"#D982B5"},{name:"Middle red purple",rgb:"#A55353"},{name:"Middle red",rgb:"#E58E73"},{name:"Midnight blue",rgb:"#003366"},{name:"Midnight green",rgb:"#004953"},{name:"Moss green",rgb:"#8A9A5B"},{name:"Mossy oak",rgb:"#887848"},{name:"Mulberry",rgb:"#C54B8C"},{name:"Mustard",rgb:"#FFDB58"},{name:"Myrtle green",rgb:"#317873"},{name:"Neon blue",rgb:"#4666FF"},{name:"Nickel",rgb:"#727472"},{name:"Ocean green",rgb:"#48BF91"},{name:"Ochre",rgb:"#CC7722"},{name:"Olive green",rgb:"#B5B35C"},{name:"Olive",rgb:"#808000"},{name:"Olivine",rgb:"#9AB973"},{name:"Orange-red",rgb:"#FF5349"},{name:"Orange",rgb:"#FF7F00"},{name:"Orange",rgb:"#FFAA1D"},{name:"Orchid pink",rgb:"#F2BDCD"},{name:"Orchid",rgb:"#DA70D6"},{name:"Pale cerulean",rgb:"#9BC4E2"},{name:"Pale pink",rgb:"#FADADD"},{name:"Pale purple",rgb:"#FAE6FA"},{name:"Pale silver",rgb:"#C9C0BB"},{name:"Pansy purple",rgb:"#78184A"},{name:"Pastel pink",rgb:"#DEA5A4"},{name:"Pastel yellow",rgb:"#FFFF99"},{name:"Peach",rgb:"#FFDAB9"},{name:"Pear",rgb:"#D1E231"},{name:"Periwinkle",rgb:"#CCCCFF"},{name:"Persimmon",rgb:"#EC5800"},{name:"Pesto",rgb:"#7C7631"},{name:"Pewter blue",rgb:"#8BA8B7"},{name:"Phthalo green",rgb:"#123524"},{name:"Pink",rgb:"#D74896"},{name:"Pistachio",rgb:"#93C572"},{name:"Powder Blue",rgb:"#BEEEEF"},{name:"Plum",rgb:"#8E4585"},{name:"Prune",rgb:"#701C1C"},{name:"Prussian Blue",rgb:"#04146D"},{name:"Puce",rgb:"#CC8899"},{name:"Pumpkin",rgb:"#FF7518"},{name:"Purple navy",rgb:"#4E5180"},{name:"Purple",rgb:"#A020F0"},{name:"Raisin black",rgb:"#242124"},{name:"Raw sienna",rgb:"#D68A59"},{name:"Raw umber",rgb:"#826644"},{name:"Rebecca purple",rgb:"#663399"},{name:"Red-purple",rgb:"#E40078"},{name:"Red-violet",rgb:"#C71585"},{name:"Red",rgb:"#ED1C24"},{name:"Rosy brown",rgb:"#BC8F8F"},{name:"Royal blue dark",rgb:"#002366"},{name:"Royal purple",rgb:"#7851A9"},{name:"Rufous",rgb:"#A81C07"},{name:"Saffron",rgb:"#F4C430"},{name:"Salmon pink",rgb:"#FF91A4"},{name:"Salmon",rgb:"#FA916D"},{name:"Sandy brown",rgb:"#F4A460"},{name:"Sap green",rgb:"#507D2A"},{name:"Scarlet",rgb:"#FF2400"},{name:"Sea green",rgb:"#2E8B57"},{name:"Sepia",rgb:"#985E2B"},{name:"Sepia black",rgb:"#2B0202"},{name:"Sienna",rgb:"#882D17"},{name:"Silver",rgb:"#A8A8A8"},{name:"Sky blue",rgb:"#87CEEB"},{name:"Sky magenta",rgb:"#CF71AF"},{name:"Slate blue",rgb:"#6A5ACD"},{name:"Slate grey",rgb:"#708090"},{name:"Steel pink",rgb:"#CC33CC"},{name:"Straw",rgb:"#E4D96F"},{name:"Tan",rgb:"#D2B48C"},{name:"Tangerine",rgb:"#F28500"},{name:"Taupe grey",rgb:"#8B8589"},{name:"Taupe",rgb:"#483C32"},{name:"Tea green",rgb:"#D0F0C0"},{name:"Tea rose",rgb:"#F4C2C2"},{name:"Teal blue",rgb:"#367588"},{name:"Teal",rgb:"#008080"},{name:"Terra cotta",rgb:"#E2725B"},{name:"Thistle",rgb:"#D8BFD8"},{name:"Turquoise blue",rgb:"#00FFEF"},{name:"Turquoise green",rgb:"#A0D6B4"},{name:"Turquoise",rgb:"#40E0D0"},{name:"Turtle green",rgb:"#2A380B"},{name:"Ultra pink",rgb:"#FF6FFF"},{name:"Ultra red",rgb:"#FC6C85"},{name:"Ultramarine",rgb:"#3F00FF"},{name:"Umber",rgb:"#635147"},{name:"Umbra",rgb:"#202000"},{name:"Vermilion",rgb:"#E34234"},{name:"Violet-blue",rgb:"#324AB2"},{name:"Violet-red",rgb:"#F75394"},{name:"Violet",rgb:"#8F00FF"},{name:"Viridian",rgb:"#40826D"},{name:"Vivid burgundy",rgb:"#9F1D35"},{name:"Vivid sky blue",rgb:"#00CCFF"},{name:"Vivid blue",rgb:"#0084FF"},{name:"Vivid indigo",rgb:"#3A00E7"},{name:"Wheat",rgb:"#F5DEB3"},{name:"White",rgb:"#FFFFFF"},{name:"Wisteria",rgb:"#C9A0DC"},{name:"Yellow-green",rgb:"#9ACD32"},{name:"Yellow-orange",rgb:"#FFAE42"},{name:"Yellow",rgb:"#FFEF00"}].map(qL)),jL=18;function qL(t){let e=sF(t.rgb);return y(y({},t),{name:Dc(t.name),lab:e,labhash:Qn(e,jL)})}var Ez=Qn([100,100,100],jL),a5e=Ez*(1/4);var l5e=l(()=>[{index:0,name:"yellows",rgb:"#FFDF00"},{index:1,name:"greens",rgb:"#0BDA51"},{index:2,name:"blues",rgb:"#0000ff"},{index:3,name:"reds",rgb:"#ff0000"}].map(qL));var bd=d("ImageHashComparison");function wd(t){return f(t,e=>Fe(e,2))}var Dz=2.3,Az=20;function HL(t,e){return bd.tap({msg:"weightedAvgCorr",result:kt(t,e)?1:eh(t.map((r,i)=>{let o=mF(e,r);if(o==null)return 0;let n=e.indexOf(o),s=Math.abs(i-n)*c.modeCorrIndexDiffWeight.valueOrDefault,a=Math.round(Jp(r,o))*c.modeCorrCieDiffWeight.valueOrDefault,m=1-(a+s-Dz)/Az;return Y(0,1,m)}),[5,4,3,2,1]),meta:{a:t,b:e}})}function Fz(t,e){return _t([HL(t,e),HL(e,t)])}function GL(t,e){let r=t.map(o=>o[0]),i=e.map(o=>o[0]);return kt(r,i)?1:eh(r.map((o,n)=>{let s=Mc(i,u=>Math.abs(u-o));if(s==null)return 0;let a=Math.abs(n-s),m=Math.abs(o-i[s])*.66+a*2;return Y(0,1,1-(m-3)/20)}),[4,3,2,1])}function Lz(t,e){return _t([GL(t,e),GL(e,t)])}function KL(t){return F(F(t?.modes).map(e=>Bl(e,on)))}var Iz=/A{20}=?$/;function JL(t){return t?.match(Iz)!=null}var Rz=[0,90,180,270];function $L(t,e,r=ea){let i=e?1:3,o=r*r*i,s=cr(tv(t).toString(2).slice(0,o),o,"0").split("").map(g=>parseInt(g,2));if(e)return s;let[a,m,u]=ye(3,g=>s.slice(g*r*r,(g+1)*r*r));return a.map((g,v)=>g*4+m[v]*2+u[v])}function Oz(t,e,r,i=ea){if(S(t)||S(e))return{hammRatio:0,aRotation:0};if(t===e)return{hammRatio:1,aRotation:0};let o=$L(t,r,i),n=$L(e,r,i).map(m=>cr(m.toString(2),r?1:3,"0")).join(""),s=Rz.map(m=>({aRotation:m,hammRatio:Fx(WL(o,m).map(u=>cr(u.toString(2),r?1:3,"0")).join(""),n)})),a=st(s,m=>m.hammRatio);return{aRotation:a.aRotation,hammRatio:wd(a.hammRatio)}}function QL(t,e){if(t==null||e==null)return;let r=JL(t.meanHash)||JL(e.meanHash);r&&bd.debug("imageHashCompare(): greyscale comparison mode.");let i=KL(t),o=KL(e),n=Oz(t.meanHash,e.meanHash,r),s=r?Lz(i,o):Fz(i,o),a=_t([n.hammRatio,n.hammRatio,s]),m={imageCorr:wd(n.hammRatio),aRotation:n.aRotation,colorCorr:wd(s),meanCorr:wd(a),greyscale:r,a:t,b:e};return bd.debug("imageHashCompare()",m),ps(m)}function Nb(t){return Fe(Y(0,1,t),3)}function YL(t,e=1){if(t==null)return!1;let r=Nb(e*(t.greyscale?c.minImageGreyscaleCoeffPct.valueOrDefault:c.minImageCoeffPct.valueOrDefault)/100),i=Nb(e*c.minColorCoeffPct.valueOrDefault/100),o=Nb(e*c.minMeanCoeffPct.valueOrDefault/100),n=Fi(t.imageCorr,r),s=Fi(t.colorCorr,i),a=!t.greyscale&&Fi(t.meanCorr,o);return bd.tap({msg:"isSimilarComparison",result:n&&s||a,meta:y({goodImageCorr:n,minImageCorr:r,goodColorCorr:s,minColorCorr:i},t)})}var XL=l(()=>d("matchRotation()"));async function ZL(t,e,r){return rt("img.matchRotation",async()=>{let i=QL(await Vl(t),await Vl(e));if(i==null)return XL().info("failed to compute image hashes",{a:t,b:e});if(!YL(i))return XL().info("low image correlation",{a:t,b:e});let o=await Ee(r,()=>JA(t));return{rotation:qo((o??0)-i.aRotation)}})}async function eI(t,e,r){let i=d("setAssetRotation("+t+", "+e+")");if(!au(e)){i.warn("setRotation("+e+"): invalid rotation");return}if(t==null){i.warn("invalid asset (null id)");return}return Xy(["asset:"+t],async()=>{let o=await r.ap(t).smallestFileForReducer("fit");if(o==null){i.error("no fit preview files for "+t),yr("repairAsset",{assetId:t});return}let n=await Re.findByAsset({id:t});if(n.find(u=>u.shown)==null){i.error("no shown AssetFile found for "+t),yr("repairAsset",{assetId:t});return}let a=async u=>b(u.posixFile(),async p=>{if(await p.notExists())return;let g=await ZL(o,p,e);if(g==null)i.warn("Can't compute match rotation",{assetId:t,rotation:e,file:p.nativePath});else{i.info("setRotation(): Writing "+g.rotation+" to "+p);let v=UP(g.rotation,u.mimetype);if(v==null)i.error("rotationToWriteTag returned null",{assetId:t,rotation:e,mimetype:u.mimetype,file:p.nativePath}),L(u.shown)&&yr("repairAsset",{assetId:t});else return await $A(p,v,u.mimetype),u.updateFromFile(p)}}),m=F(await pi({name:"setRotation",laters:n.map(u=>()=>a(u))}));return await Re.ops().upsert(m),await r.apb(t,m).build_({force:!0}),i.info("setRotation("+e+"): completed.",{updatedAssetFiles:m}),m})}var vo=d("ApiAssetRouter"),Bb=class{constructor(e){this.previews=e}wrapApi(e,r){return async(i,o,n)=>{try{ti.onNewPage();let s=k(i.params.assetId);if(s==null)return o.sendStatus(400);let a=await Lt(Mi(),async()=>he(Ie.ops().findById(s,{shown:1,excluded:0,hidden:0}),m=>r(i,s,m),()=>this.onMissingAsset(i,s)));return vo.debug(e,{result:a}),o.json(x(a,{redirect:"/tag"}))}catch(s){return vo.warn(e,{err:s,stack:s.stack}),o.sendStatus(x(s.httpStatus,500))}}}router(){return tI.default.Router().get("/api/asset/:assetId/info",this.wrapApi("ApiAssetRouter.assetInfo",this.assetInfo.bind(this))).get("/api/asset/:assetId/streams",this.wrapApi("ApiAssetRouter.assetInfo",this.assetStreams.bind(this))).get("/api/asset/:assetId",this.wrapApi("ApiAssetRouter.asset",this.asset.bind(this))).put("/api/asset/:assetId",this.wrapApi("ApiAssetRouter.save",this.save.bind(this))).put("/api/asset/:assetId/resync",this.wrapApi("ApiAssetRouter.resync",this.resync.bind(this)))}async assetInfo(e,r,i){let o=await i.getFiles(),n=await i.getShown(),s=f(n,g=>g.nativePath()),a=hl(e.ip);if(c.resyncAssetOnVisit.valueOrDefault&&yr("repairAsset",{assetId:r}),n==null||s==null){vo.error("no shown AssetFile found for "+r,{asset:i,shown:n,shownPathP:s});return}vo.debug("assetInfo()",{assetId:r,shown:n,shownPathP:s,ip:e.ip,showOpenFile:a});let m=await i.getTags(),u=await le(m,g=>g.toApiTag()),p=await le(o,g=>g.toApi(this.previews,n.sha));return Do(p,g=>[!g.shown,!g.exists,g.nativePath]),y(y({assetId:r,capturedAtLocale:n.capturedAtLocale(pg(e))},et(n,"mimetype","focalLength","iso","aperture","shutterSpeed")),{durationHMS:f(n.durationMs,hM),fps:n.fps,files:p,tags:u,showOpenFile:a})}async onMissingAsset(e,r,i){let o=e.query.from==="next",n=k(String(e.query.priorAssetId)),s=$(i,p=>p.id,()=>n);if(s==null){vo.warn("onMissingAsset(): no context asset available");return}let a=await he(i,p=>p.capturedAtLocal,()=>Ie.dbl.pluckFirstf(p=>p.select("capturedAtLocal").where({id:s}))),m=Ie.shownUnhidden(Ie.query().select("id").limit(1).whereNotIn("id",F([r,n])));o?m=m.andWhere("capturedAtLocal","<",a).orderBy("capturedAtLocal","desc"):m=m.andWhere("capturedAtLocal",">",a).orderBy("capturedAtLocal","asc");let u=await Ie.dbl.pluckFirst(m);return vo.warn("Asset redirect",{fromAssetId:s,priorAssetId:n,fromTime:a,toAsset:u}),we(u,p=>({redirect:new ti(p).assetUrl()}))}async asset(e,r,i){let o=await i.getShown();return o==null?(vo.error("no shown AssetFile found for "+r+", disabling (for now)."),await i.upsert({shown:!1}),vo.error("Asset un-shown."),C(()=>yr("repairAsset",{assetId:r})),this.onMissingAsset(e,r,i)):(await i.getBeforeAfterId(),(async()=>{let n={assetId:r,width:o.width,height:o.height,rotation:x(o.rotation,0),hidden:L(i.hidden),contextTag:await i.whenApiTag(),capturedAtLocale:o.capturedAtLocale(pg(e)),aspectRatio:Fe(o.width/o.height,3),beforeAssetId:i.beforeId,afterAssetId:i.afterId};return o.isVideo?(await i.getExistingAssetFiles(),R(i.existingFiles)?(vo.warn("no existing files for "+r+", trying to repair, but redirecting user now."),C(()=>yr("repairAsset",{assetId:r})),this.onMissingAsset(e,r,i)):y(y({},n),{videoAttrs:i.videoAttrs(),videoSources:i.videoSources()})):y(y({},n),{imgAttrs:await i.fitAttrs(this.previews)})})())}async assetStreams(e,r,i){let o=k(h(e.query.limit),{defaultValue:Qp}),n=await i.getStreams(o);return le(n,s=>s.toApi())}async save(e,r,i){let o=dc(e.body.hidden),n=k(e.body.rotation);return vo.info("save()",{assetId:r,hidden:o,rotation:n}),o!=null&&await i.setHidden(o),n!=null&&await eI(r,n,this.previews),i}async resync(e,r){let i=()=>Ie.dbl.pluckFirstf(n=>n.where({id:r}).select("updateCount")),o=i();return yr("repairAsset",{assetId:r}),await je(()=>i()!==o,{timeoutMs:15*M,timeBetweenMs:M}),{v:i()}}};var iI=T(require("express"));function xd(t){return kz(t)!=null}var _z=/(^|\.)(example|test)\.com$/i,Nz=/[^\s]+\.[^\s]+/;function kz(t){t=h(t);let e=t.indexOf("@");if(e===-1)return;let r=t.slice(0,e),i=t.slice(e+1);return S(r)||S(i)||Nz.exec(i)==null||_z.exec(i)!=null?void 0:{local:r,domain:i}}function rI(){return Lt(Mi(),async()=>{await Ie.dbl.runf(t=>t.update({version:0})),await Re.dbl.runf(t=>t.update({version:0})),await ln.dbl.runf(t=>t.where({name:Vu.enqueueAssetFileUpdates,version:sn}).orWhere({name:Vu.enqueueAssetUpdates,version:es}).delete())})}var Cb=l(()=>d("ApiSystemRouter")),Vb=class{constructor(e){this.exitable=e;this.getState=async(e,r)=>r.json({paused:Ar(),tier:await Js()});this.hasEmail=(e,r)=>{r.json({hasEmail:xd(c.email.value)})};this.sendRecentLogs=async(e,r)=>{try{let i=h(e.query.email);!xd(c.email.value)&&xd(i)&&(c.email.value=i,await Hs()),await gd(),r.sendStatus(204)}catch(i){Cb().warn("Failed to send recent logs",i),r.sendStatus(500)}};this.post=async(e,r)=>{let i=e.body;Cb().info("post()",{body:e.body}),Ta(i.pause,()=>{Bz()}),Ta(i.resume,()=>{Pu(),Pi.resume()}),await Ta(i.forceRestartSync,async()=>{await ln.ops().insertOne({name:"forceRestartSync"}),Pi.forceRestartSync()}),await Ta(i.rebuildLibrary,async()=>{await rI(),Pi.restartSync()}),Ta(i.shutdown,()=>{let o="Shutdown requested by "+e.ip;Cb().info(o),Pi.shutdown(),C(()=>G()?void 0:this.exitable.exit({reason:o,status:0,waitForJobs:!1}),3e3)}),r.sendStatus(200)}}router(){return iI.default.Router().get("/api/system/state",this.getState).get("/api/system/hasEmail",this.hasEmail).post("/api/system/send-recent-logs",this.sendRecentLogs).post("/api/system",this.post)}};function Bz(){Mu(),Pi.pause()}var oI=T(require("express"));var $u=d("ApiTagRouter"),nI=4;function zb(t,e){return async(r,i)=>{try{ti.onNewPage();let o=k(r.params.tagId),n=eM(r.path.slice(1)),s=Rf(r),a=await Lt(Mi(),async()=>b(zw(n,m=>ge.findByIdOrPath(o,m),()=>ge.root()),m=>e(r,m,{tagId:m.id,tagPath:m.path,seed:s})));return $u.debug(t,{result:a,tagPath:n,seed:s,url:r.url}),a==null?i.sendStatus(404):i.json(a)}catch(o){throw i.sendStatus(x(o.httpStatus,500)),o}}}var Ub=class{router(){return oI.default.Router().get(/^\/api\/tag(?:\/(.+))?$/,zb("ApiTagRouter.tagGallery",this.tagGallery.bind(this))).get(fF(":tagId",{}),zb("ApiTagRouter.tagAssets",this.tagAssets.bind(this))).get(pF(":tagId",{}),zb("ApiTagRouter.childTags",this.childTags.bind(this)))}async tagGallery(e,r,i){$u.debug("tagGallery()",{tag:r});let o=y(y(y({},await r.toApiTag()),await this.childTags(e,r,i)),await this.tagAssets(e,r));return r.id===0&&await Ie.shownCount()===0&&($m(ht.instance()?.start,H)?o.startingUp=!0:o.emptyLibrary=!0),o}async childTags(e,r,i){let o=x(k(h(e.query.offset)),0),n=x(k(h(e.query.limit)),nI);$u.debug("childTags() got ",{thisOffset:o,limit:n,query:e.query});let s={tagId:r.id,offset:o,limit:n,seed:i.seed};s.limit=bs(s.limit,nI);let a=await r.getChildrenCount(),m=a===0?[]:await r.getPagedChildren(s);$u.debug("childTags()",{crit:s,childTagCount:a,children:m});let u=m.length+o,p=u<a?{tagId:r.id,seed:i.seed,limit:n,offset:u}:void 0,g=await le(m,async v=>{let D=await v.getRelatedAssetIds(i.seed+v.id,Ou);return _(D)?y(y({},await v.toApiTag()),{assetIds:D}):void 0});return $u.tap({msg:"childTags result",result:{tagId:r.id,childTags:g,childTagCount:a,nextChildTags:p},meta:{nextOffset:u}})}async tagAssets(e,r){let i=y({tagId:r.id},et(e.query,"capturedAtLt","capturedAtGt","limit"));i.limit=bs(i.limit,Ou);let o=await r.getPagedAssetIds(i),n=o.length<i.limit?void 0:{tagId:r.id,limit:i.limit,capturedAtLt:Fc(o.map(s=>s.capturedAtLocal))};return{tagId:r.id,assetIds:o,nextAssets:n}}};function Td(t){return"/tag?seed="+Rf(t)}var sI=T(require("express"));var Ui=d("ImgActualRouter"),Wb=class{constructor(e){this.previews=e}router(){return sI.default.Router().get("/img/:assetId/:assetFileId/actual",Le("ImgActualRouter.assetImg",this.assetFileImg.bind(this))).get("/img/:assetId/actual",Le("ImgActualRouter.assetImg",this.assetImg.bind(this))).get("/dl/:assetId/:assetFileId",Le("ImgActualRouter.assetFileImg",this.assetFileImg.bind(this)))}async assetImg(e,r){let i=k(e.params.assetId);if(!B(i))return Ui.info("Missing assetId",e.originalUrl),r.sendStatus(400);let o=await Re.ops().findOneBy({assetId:i,shown:1});return o==null?(Ui.info("Unknown assetId",e.originalUrl),this.repairAssetLaterAndSendPreview(i,e,r)):this.sendAssetFile(e,r,o)}async assetFileImg(e,r){let i=k(e.params.assetId);if(!B(i))return Ui.info("Missing assetId",e.originalUrl),r.sendStatus(400);let o=k(e.params.assetFileId);if(!B(i))return Ui.info("Missing assetFileId",e.originalUrl),r.sendStatus(400);let n=await Re.ops().findOneBy({id:o,assetId:i});return n==null?(Ui.info("Unknown assetFileId",e.originalUrl),r.sendStatus(400)):this.sendAssetFile(e,r,n)}async sendAssetFile(e,r,i){let o=i.assetId,n=await i.posixFile(),s=e.path.split("/").includes("dl")||tM(e,"dl");if(n==null||await n.isEmpty())return Ui.info("Shown AssetFile failed to resolve PosixFile. Trying to repair.",{url:e.originalUrl,assetId:o,shown:i}),s?r.sendStatus(400):this.repairAssetLaterAndSendPreview(o,e,r);if(s)return Ui.info("Sending download",{assetId:o,af:i,nativePath:n.nativePath}),r.download(n.nativePath,n.base);let a=e.headers["user-agent"],m=await t0(n,y({userAgent:a},et(i,"width","height","sha","mimetype")));return m==null?(Ui.warn("cannot send file",{assetId:o,af:i}),r.sendStatus(400)):(Ui.info("sendAssetFile(): sending supported file: "+m.nativePath),r.sendFile(m.nativePath,u=>f(u,p=>Ui.warn("failed to send file",{error:p,assetId:o,af:i}))))}async repairAssetLaterAndSendPreview(e,r,i){yr("repairAsset",{assetId:e});let o=await this.previews.ap(e).largestFileForReducer("fit");o!=null?i.sendFile(o.nativePath):(Ui.info("repairAssetLaterAndSendPreview("+e+"): un-showing asset until it's repaired"),await Ie.txOp(n=>n.upsertOne({id:e,shown:!1})),i.headersSent||i.sendStatus(404))}};var aI=T(require("express")),lI=T(require("path"));var Cz=require("sharp"),qb=d("ImgRouter"),jb=class{constructor(e){this.previews=e}router(){let e=Le("ImgRouter",this.streamImage.bind(this));return aI.default.Router().get("/img/:assetId/:reducer/:width",e)}async streamImage(e,r,i){return b(this.getFileFromRequest(e,r),o=>r.sendFile(o.nativePath))}async getFileFromRequest(e,r){let i=e.params,o=k(i.assetId),n=U(i.reducer,u=>Nt[u]),s=k(i.width);if(o==null||n==null&&s==null){qb.warn("getFileFromRequest(): bad request",{assetId:o,reducer:n,width:s}),r.sendStatus(400);return}let a=this.previews.ap(o),m=await a.fileForWidth(n,s);if(await m.notExists()){if(c.placeholderThumbs.valueOrDefault){let g=aF(Bl(o%(3937-219)+219,on));return b(Zs(),v=>v.join(Qi(g,3).join(lI.sep)+"-64w.png").applyIfEmpty_(D=>Cz({create:{width:64,height:64,channels:3,background:g}}).png().toFile(D.nativePath)))}let u=await a.widths(n),p=Ii(u,g=>Math.abs(s-g));if(p==null){qb.warn("Missing file, and no other widths found",{path:m.nativePath,assetId:o,reducer:n,width:s});return}else return qb.info("replacing requested width",{assetId:o,reducer:n,width:s,f:m,existingWidth:p}),a.fileForWidth(n,p)}else return m}};var mI=T(require("express"));var Gl=d("OpenAssetFileRouter"),Hb=class{constructor(e){this.openFileService=e}router(){return mI.default.Router().get("/openAssetFile/:assetFileId",Le("OpenAssetFileRouter.assetFile",this.assetFile.bind(this)))}async assetFile(e,r){if(Gl.info("assetFile(): got request",{url:e.originalUrl,ip:e.ip}),!hl(e.ip))return Gl.info("Non-localhost request",{url:e.originalUrl,ip:e.ip}),r.sendStatus(400);let i=k(e.params.assetFileId);if(!B(i))return Gl.info("Missing assetFileId",e.originalUrl),r.sendStatus(400);let o=await Re.ops().findOneBy({id:i});if(o==null)return Gl.info("Invalid assetFileId",e.originalUrl),r.sendStatus(400);let n=await o.posixFile();return n==null||await n.clear().notExists()?(Gl.info("File not found",{url:e.originalUrl,af:o,file:n}),r.sendStatus(400)):(Gl.info("Requesting openFileService("+n.nativePath+")...",{url:e.originalUrl,ip:e.ip}),this.openFileService(n.nativePath),r.sendStatus(204))}};var uI=T(require("express"));var vd=d("PingRouter"),Gb=class{router(){return uI.default.Router().get("/ping",Le("PingRouter",this.ping.bind(this)))}async status(){if(!pt())return vd.info("ping(): no library path, so no health checks."),200;let e=await Zo();return e==null||_(e.fail)?(vd.warn("ping(): FAILED HEALTH CHECK",e),503):_(e.warn)?(vd.debug("ping(): warnings",e),202):(vd.debug("ping(): everything looks OK",e),200)}async ping(e,r,i){let o=L(e.query.fail)?503:L(e.query.warn)?202:await this.status();return r.sendStatus(o)}};var cI=T(require("express"));var Qu=l(()=>d("PlansRouter")),Kb=class{router(){return cI.default.Router().get("/plans/pick",Le("GET /plans/pick",Jb)).get("/plans/activate",Le("GET /plans/activate",Vz)).get("/plans/billing",Le("GET /plans/billing",zz)).get("/plans/license",Le("GET /plans/license",Uz))}};async function Jb(t,e){return await $b({req:t,res:e,remotePath:"/plans/pick"})}async function Vz(t,e){return await $b({req:t,res:e,remotePath:"/",params:{skipIndex:!0}})}async function zz(t,e){return await $b({req:t,res:e,remotePath:"/"})}async function $b({req:t,res:e,remotePath:r,params:i={}}){let o=ul(t),n=await xl(),s=new URL("https://account.photostructure.com"+r);return s.searchParams.append("uids",n.join(",")),o.pathname="/plans/license",s.searchParams.append("redirectToLibraryUrl",o.toString()),La(i,(a,m)=>s.searchParams.append(a,m)),Qu().info("GET /plans/pick",{redirectToLibraryUrl:o.toString()}),e.redirect(s.toString())}async function Uz(t,e){try{await li(t.query.license,async i=>{await mp(i),Qu().info("getPlansLicense(): Saved new license",i)},()=>{Qu().info("getPlansLicense(): no license in request",t.originalUrl)})}catch(i){Qu().error("getPlansLicense(): Failed to save license",{err:i,url:t.originalUrl})}let r=Rr(A(t.query.then)[0],"/settings");Qu().info("getPlansLicense(): redirecting to "+r),e.redirect(r)}var pI=T(require("process"));var v6e=Se("processing","paused","done");var fI="rebuilding://";var dI=l(()=>d("ProgressWithAssets")),Qb=class{constructor(e=Zo,r=10){this.hc=e;this.maxLen=r;this.priorRecentAssetsByRoot=new ke(15,15*M);this.priorHadBad=!1;this.testProgressStatesByVolume=new Map}async updates(){return b(this.states(),e=>({states:e}))}async states(){if(Ar())return[{volume:"\u23F8",state:"paused",hed:"Paused",dek:["Processing is paused. Resume via the navigation menu"+(Xt?" or the system tray menu":"")+"."],recentAssetIds:[]}];let e=await this.hc(),r=zy(e),i=this.priorHadBad&&r;if(this.priorHadBad=r,i)return dI().warn("health check is failing",{hc:e,badness:r}),[{volume:"\u26A0\uFE0F",state:"paused",hed:"Health checks failed. Click for details.",dek:vc(e.bad,e.fail),recentAssetIds:[]}];let o=await this.recentProgress();return dI().debug("recentProgressWithAssets()",o),R(o)&&L(pI.env.TEST_PROGRESS)?this.testProgress():o}recentProgress(){return ia.tx(async()=>{let e=await ia.ops().allf(o=>o.where("updatedAt",">",Date.now()-7*M).whereNotNull("state").orderBy("volume")),r=[],i=new Set;for(let o of e){let n=o.toSyncState(),a=(await Re.recentAssetIdsByUriRoot(n.uri===fI?void 0:n.uri,20*M,this.maxLen+i.size)).filter(u=>!i.has(u)).slice(0,this.maxLen),m=this.priorRecentAssetsByRoot.get(n.uri)??[];_(m)&&m.every(u=>!a.includes(u))&&(a.unshift(),a.push(m[0])),this.priorRecentAssetsByRoot.set(n.uri,a);for(let u of a)i.add(u);r.push(y(y({},n),{recentAssetIds:a}))}return r})}async testAssetIds(e){let r=lr(this.testProgressStatesByVolume,e,()=>new gs(this.maxLen)),i=await Ur.dbl.pluckFirstf(o=>o.select("assetId").andWhere("shown",1).andWhere("hidden",0).orderByRaw("random()").first());return i!=null&&r.push(i),r.toA()}async testProgress(){let e=Math.round(Date.now()/(30*M))%3,r=(I?["C:","D:","E:"]:["/","/home/bob/pictures","/mnt/nas"])[e];return[{volume:r,state:"processing",hed:"Processing, about 32 minutes remaining",dek:["Processing C:\\Users\\mrm\\Pictures\\20161214-pixel\\DCIM\\Camera\\IMG_20160903_090736.jpg","Processed 445 images and videos.  1,386 remain to be processed."],completePct:40,incompletePct:25,scanningPct:35,recentAssetIds:await this.testAssetIds(r)}]}};var hI=T(require("express")),gI=T(require("timers"));var Sd=d("UpdatesRouter"),Yb=class{constructor(e){this.updatesProvider=e;this.name="ProgressRouter";this._ended=!1;this.streams=[];this.updateData=l(()=>this.updatesProvider.updates(),zu());this.timer=(0,gI.setInterval)(()=>this.sendUpdates(),zu()),um(this),Ra(()=>this.updateData.unset()),wn(()=>this.updateData.unset())}get ended(){return this._ended||G()}async end(){this._ended=!0,clearInterval(this.timer),this.streams.map(di),this.streams.length=0}router(){return hI.default.Router().get("/updates",Le(this.name,this.updates.bind(this)))}async updates(e,r){if(this.ended){r.sendStatus(503);return}let i=Tn(e.connection);return r.writeHead(200,{"Content-Type":"text/event-stream; charset=utf-8","Cache-Control":"no-cache",Connection:"keep-alive","X-Accel-Buffering":"no"}),this.streams.push(r),r.on("error",o=>{sm(this.streams,r),Sd.warn("onError("+i+"): "+o)}),r.once("close",()=>{sm(this.streams,r),Sd.debug("stream to "+i+" closed. ("+this.streams.length+" remain)")}),this.updateData.unset(),this.sendUpdates()}async sendUpdates(){if(!(this.ended||R(this.streams)||Ar()&&this.updateData.prior()!=null))try{let e=await this.updateData.prior(),r=await this.updateData.refresh();if(r==null){Sd.warn("Failed to fetch updates");return}if(Ai(e,r)){this.updateData.setTTL(Math.min(7*M,x(this.updateData.ttl(),zu())+500));return}if(this.ended)return;this.updateData.setTTL(zu());let i="data: "+O(r)+`

`;this.streams.forEach(o=>o.write(i))}catch(e){Sd.warn("Failed to send updates",e)}}};var yI=T(require("express")),Yu=T(require("path"));var ma=d("SettingsRouter");function Wz(){return wb(Hn.localToday()).join(Yu.sep)}var Xb=class{constructor(e,r,i){this.libraryPath=e;this.settings=r;this.libraryPathSuggester=i}router(){return yI.default.Router().get("/setting",(e,r)=>r.redirect("/settings")).get("/settings",Le("GET /settings",this.get.bind(this))).post("/settings",Le("POST /settings",this.post.bind(this)))}async get(e,r){let{err:i,libraryPath:o}=e.body,n=await this.requestSettings(e);return this.renderSettings(e,r,n,o,i)}async renderSettings(e,r,i,o,n){fm();let s=await this.libraryPathSuggester();h(n).match(/choose a different directory/i)==null&&await U(o,v=>b(ao(v),D=>s.unshift(new aa(v,D.available,D.mountpoint,D.label))));let a=this.libraryPath();S(n)&&de()&&(a==null||await a.isNotDirectory())&&(n=`PS_LIBRARY_PATH, ${x(a?.nativePath,"/ps/library")}, doesn't exist: please add it as a bind mount.`);let m=await gu(Tt?void 0:e.query),u=await rl(),p=await fo(),g=y(y({err:n},i),{welcome:$(Tt?void 0:e.query.welcome,L,()=>!pt()),title:a==null?"Welcome!":"Settings",isVideoTranscodingSupported:m.ok,videoToolDetails:m.msg,picturesPath:u,jsonScanPaths:f(c.scanPaths.value,O),delimiter:Yu.delimiter,exampleScanPath:[u,I?"D:\\PHOTOS":re?"/Volumes/External HD/Pictures":"/mnt/nas/homes/photos"].join(Yu.delimiter),currentLibraryPath:f(a,v=>v.nativePath),minFreeAvailable:Ut(c.minDiskFreeGb.valueOrDefault*Sr),suggestedLibraryPaths:s,samplePath:Wz(),reportErrors:c.reportErrors.valueOrDefault,subTier:await Js(),subTrial:L(p?.l?.trial),subEmail:p?.l?.sub,subExpiresInDuration:f(p?.l?.exp,v=>an(v.getTime()-Date.now(),1)),subExpiresAt:f(p?.l?.exp,fn)});ma.info("rendering settings",g),rM(r),await rs(e,r,"settings",g)}async post(e,r){let i=e.body,o=i.libraryPathRadio==="libraryPathCustom"?i.libraryPath:i.libraryPathRadio,n=await this.requestSettings(e);ma.info("POST",{libraryPath:o,settings:n,body:i}),fe&&Ct({post:i,settings:n,method:e.method,libraryPath:o});let s=a=>(ma.warn("fail(): "+a),this.renderSettings(e,r,n,o,a));try{let a=await aL(o,n),[m,u]=Pa(a,p=>p.error);if(_(m))return ma.info("error saving library settings",m),s(m.map(p=>p.error).join(", "));ma.info("saved library settings",u)}catch(a){return s(a)}return ma.info("POST redirecting to /"),r.redirect(Td(e))}async requestSettings(e){let{scan:r,scanPath:i,copyAssets:o,reportErrors:n}=e.body,s=this.settings();return P(r)&&(s.scanAllDrives=r==="scanAllDrives",s.scanPath=V(i)),P(o)&&(s.copyAssets=o==="copyEnabled"),s.reportErrors=L(n),ma.info("requestSettings",s),na(s)}};var bI=T(require("express"));var qz=d("SpaRouter"),Zb=class{router(){let e=Le("SpaRouter",this.get.bind(this));return bI.default.Router().get("/tag*",e).get("/asset*",e)}get(e,r,i){if(!(e.path.startsWith("/tag")&&ZS(e,r)==null))return qz.info("request",{params:e.params,query:e.query}),rs(e,r,"app",{})}};var wI=T(require("express"));var Md=d("VideoRouter"),ew=class{constructor(e){this.previews=e}router(){return wI.default.Router().get("/video/:assetId",Le("VideoRouter",this.videoImage.bind(this)))}async videoImage(e,r,i){let o=e.params,n=k(o.assetId);if(!B(n))return Md.warn("Malformed request (missing assetId)",{params:e.params}),r.sendStatus(400);let a=this.previews.ap(n).mp4();if(await a.exists())return Md.info("streaming transcoded video",a),r.sendFile(a.nativePath);let m=await Re.findByAsset({id:n},{shown:1});if(R(m))return Md.warn("Malformed request (bad assetId)",{params:e.params}),r.sendStatus(400);let u=m[0],p=await f(u,g=>g.posixFile());return p!=null&&u.isVideo&&await p.exists()?r.sendFile(p.nativePath):(Md.warn("Shown assetFile isn't a video",u),r.sendStatus(400))}};var xI=T(require("express"));var tw=class{router(){return xI.default.Router().get("/welcome",Le("GET /welcome",this.get.bind(this))).post("/welcome",Le("POST /welcome",this.post.bind(this)))}async get(e,r){return Dt(),fo(),rs(e,r,"welcome",{})}async post(e,r){return!c.pickPlanOnWelcome.valueOrDefault||(await fo())?.ok===!0?r.redirect("/settings"):Jb(e,r)}};var vI=require("body-parser"),Pd=require("express"),SI=require("helmet");function jz(t,e){e.endsWith(".js")&&t.setHeader("Content-Type","application/javascript")}var Hz=d("respErrHandler"),Gz=(t,e,r)=>{let i=o=>{let s=h(o).toUpperCase().includes("EPIPE")?"debug":"info";Hz.log(s,"Error serving "+t.url+": "+o)};e.setHeader("X-Version",Ke),t.on("error",i),e.on("error",i),r()},iw=class{constructor(){this.logger=d("WebService");this.setup=l(async()=>{if(rw.default.on("SIGPIPE",u=>{this.logger.info("Caught SIGPIPE",u)}),this.logger.debug("setup(): started"),c.libraryPath.addListener(()=>this.libraryRouter.clear()),q(()=>this.libraryRouter.clear()),await hT(this.service.ready)){this.logger.error("setup(): failed, servicexpress.ready was rejected");return}pt()&&await ht.instance().modelDb();let e=this.app;if(c.trustProxy.hasValue()){let u=c.trustProxy.value,p=u==="true"?!0:u==="false"?!1:Dx(u,g=>g,u);e.set("trust proxy",p),this.logger.info("trust proxy set",{value:p})}e.use(Gz),xo()&&ze(()=>e.use(require("@sentry/node").Handlers.requestHandler())),e.use((u,p,g)=>{p.locals.cspNonce=(0,TI.randomBytes)(16).toString("hex");let v=V(["'self'","'strict-dynamic'","'unsafe-inline'",`'nonce-${p.locals.cspNonce}'`,c.cspDirective.valueOrDefault]);SI.contentSecurityPolicy({directives:{defaultSrc:["'self'"],scriptSrc:v,styleSrc:v,baseUri:["'self'"],objectSrc:["'none'"]},reportOnly:c.cspReportOnly.valueOrDefault})(u,p,g)}),e.use(SI({contentSecurityPolicy:!1})),e.use(new lg().router),e.use(vI.json()),e.use(vI.urlencoded({extended:!1}));let r=dr.Public(),i=dr.Views();e.set("views",i),e.set("view engine","pug"),e.use(new Gb().router()),e.use(await oM(r)),e.use(Pd.static(r,{setHeaders:jz})),e.use(new _b().router()),e.use(new tw().router()),e.use(new Kb().router()),e.use(this.settingsRouter()),No||e.use("/die",(u,p)=>{this.logger.info("/die was requested",{url:u.originalUrl}),rw.default.env.TEST_FAIL="Test error",Xo.unset(),p.sendStatus(202)}),e.use(this.router.bind(this)),xo()&&ze(()=>e.use(require("@sentry/node").Handlers.errorHandler()));let o=c.httpPort.valueOrDefault,n=c.exposeNetworkWithoutAuth.valueOrDefault,s=n?Xf():[c.localhost.valueOrDefault],a=async()=>{this.logger.info("online",{httpPort:o,ips:s}),od(c.httpPort,c.libraryPath)},m=n?e.listen(o,a):e.listen(o,c.localhost.valueOrDefault,a);return m.on("error",u=>{this.logger.warn("http.server.onError()",u),u.code==="EADDRINUSE"&&X("Port "+o+" is already in use (is PhotoStructure already running?)"+pe+Gr)}),new Ig("http.WebService",m)});this.settingsRouter=l(()=>(this.logger.info("Setting up settings router..."),new Xb(()=>U(c.libraryPath.value,e=>ie.for(e)),()=>na(),BL).router()));this.welcomeRouter=l(()=>{this.logger.info("Setting up welcome router...");let e=Pd.Router();return e.use((r,i)=>i.redirect("/welcome")),e});this.libraryRouter=l(()=>{let e=ht.instance();if(this.logger.info("Setting up library router for "+f(e,n=>n.rootDir)),e==null)return;let r=e.previews(),i=new Qb,o=Pd.Router();return o.use(new Vb(this.service).router()),o.use(new Ub().router()),o.use(new Bb(r).router()),o.use(new Zb().router()),o.use(new Hb(n=>SP(oe.for(n))).router()),o.use(new Wb(r).router()),o.use(new jb(r).router()),o.use(new ew(r).router()),o.use(new Yb(i).router()),o.use("/",async(n,s)=>{s.redirect(302,Td(n))}),o});this.app=Pd(),this.service=new Ob({name:"web"}),this.setup().catch(e=>(console.error(Jt(e)),this.service.exit({reason:"setup() failed: "+e,status:13,waitForJobs:!1})))}router(e,r,i){return G()?r.sendStatus(500):(pt()?this.libraryRouter():this.welcomeRouter())(e,r,i)}};try{iR().install()}catch{}async function AU(){await new sg("web").add($S,QS).parse(),new iw}AU();
//# sourceMappingURL=web.js.map
